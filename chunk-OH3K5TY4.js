import{a as Z}from"./chunk-PGPYOVG4.js";import{a as q,b as A,c as M,d as z,e as U,h as G,i as L,m as j,p as B,q as H,r as Q,s as W,w as J,x as X,y as Y}from"./chunk-I5RQKTUS.js";import{a as V,b as N}from"./chunk-76ZPEF4E.js";import{b as $}from"./chunk-PJAEBTL6.js";import"./chunk-WICVJICE.js";import{j as D,k as T,s as F}from"./chunk-TSXPCGVK.js";import{Ab as b,Db as o,Ea as l,Eb as h,Fb as y,Gb as O,Ua as k,Za as p,a as P,ba as E,fb as c,ga as g,gb as r,ha as v,hb as n,ib as C,ob as S,rb as x,tb as d}from"./chunk-HZF257L5.js";import{a as I,b as R,j as u}from"./chunk-4ZZIO3ZI.js";function ee(a,t){a&1&&(r(0,"span"),o(1,"L'email \xE8 obbligatoria"),n())}function te(a,t){a&1&&(r(0,"span"),o(1,"Inserisci un'email valida"),n())}function ie(a,t){if(a&1&&(r(0,"div",36),p(1,ee,2,0,"span",30)(2,te,2,0,"span",30),n()),a&2){let e,i,s=d(2);l(),c("ngIf",(e=s.staffForm.get("email"))==null||e.errors==null?null:e.errors.required),l(),c("ngIf",(i=s.staffForm.get("email"))==null||i.errors==null?null:i.errors.email)}}function ne(a,t){if(a&1&&(r(0,"option",37),o(1),n()),a&2){let e=t.$implicit;c("value",e.value),l(),y(" ",e.label," ")}}function ae(a,t){a&1&&(r(0,"span"),o(1,"Il ruolo \xE8 obbligatorio"),n())}function re(a,t){if(a&1&&(r(0,"div",36),p(1,ae,2,0,"span",30),n()),a&2){let e,i=d(2);l(),c("ngIf",(e=i.staffForm.get("role"))==null||e.errors==null?null:e.errors.required)}}function se(a,t){if(a&1&&(r(0,"div",38)(1,"strong"),o(2),n(),r(3,"p"),o(4),n()()),a&2){let e,i,s=d(2);l(2),h(s.getRoleDisplayName((e=s.staffForm.get("role"))==null?null:e.value)),l(2),h(s.getRoleDescription((i=s.staffForm.get("role"))==null?null:i.value))}}function oe(a,t){a&1&&(r(0,"span",39),o(1,"sync"),n())}function le(a,t){a&1&&(r(0,"span",17),o(1,"person_add"),n())}function ce(a,t){a&1&&(r(0,"span"),o(1,"Aggiunta in corso..."),n())}function de(a,t){a&1&&(r(0,"span"),o(1,"Aggiungi Membro"),n())}function me(a,t){a&1&&(r(0,"div",40)(1,"div",41)(2,"span",42),o(3,"group_off"),n(),r(4,"h3",43),o(5,"Nessun membro dello staff"),n()(),r(6,"p",44),o(7,"Aggiungi il primo membro del team utilizzando il form sopra."),n()())}function fe(a,t){if(a&1&&(r(0,"div",53)(1,"div",54)(2,"span",17),o(3,"email"),n()(),r(4,"div",55)(5,"div",56),o(6),n(),r(7,"div",57)(8,"span",58)(9,"span",17),o(10,"schedule"),n(),o(11," Invito in attesa "),n()()()()),a&2){let e=d().$implicit;l(6),h(e.email)}}function pe(a,t){if(a&1&&(r(0,"div",53)(1,"div",59)(2,"div",60)(3,"span",17),o(4,"person"),n()(),r(5,"div",55)(6,"div",61),o(7),n()()(),r(8,"div",56),o(9),n()()),a&2){let e=d().$implicit;l(7),O("",e.user.first_name," ",e.user.last_name),l(2),h(e.user.email)}}function _e(a,t){if(a&1){let e=S();r(0,"div",62)(1,"button",63),x("click",function(){g(e);let s=d().$implicit,m=d(3);return v(m.resendInvitation(s))}),r(2,"span",17),o(3,"send"),n(),o(4," Reinvia "),n(),r(5,"button",64),x("click",function(){g(e);let s=d().$implicit,m=d(3);return v(m.cancelInvitation(s))}),r(6,"span",17),o(7,"cancel"),n(),o(8," Annulla "),n()()}}function ue(a,t){if(a&1&&(r(0,"option",37),o(1),n()),a&2){let e=t.$implicit;c("value",e.value),l(),y(" ",e.label," ")}}function ge(a,t){a&1&&(r(0,"span",70)(1,"span",17),o(2,"sync"),n()())}function ve(a,t){if(a&1){let e=S();r(0,"div",67)(1,"select",68),x("change",function(s){g(e);let m=d(2).$implicit,f=d(3);return v(f.onRoleChangeAttempt(m,s))}),p(2,ue,2,2,"option",22),n(),p(3,ge,3,0,"span",69),n()}if(a&2){let e=d(2).$implicit,i=d(3);l(),c("ngModel",e.role)("disabled",i.updatingRoles[e.id]),l(),c("ngForOf",i.roleOptions),l(),c("ngIf",i.updatingRoles[e.id])}}function xe(a,t){if(a&1&&(r(0,"div",65),p(1,ve,4,4,"div",66),n()),a&2){let e=d().$implicit,i=d(3);l(),c("ngIf",i.canEditStaff(e))}}function he(a,t){a&1&&(r(0,"span",17),o(1,"delete"),n())}function Se(a,t){a&1&&(r(0,"span",17),o(1,"sync"),n())}function be(a,t){a&1&&(r(0,"span"),o(1,"Rimozione..."),n())}function ye(a,t){a&1&&(r(0,"span"),o(1,"Rimuovi"),n())}function we(a,t){if(a&1){let e=S();r(0,"button",74),x("click",function(){g(e);let s=d(2).$implicit,m=d(3);return v(m.removeStaff(s))}),p(1,he,2,0,"span",29)(2,Se,2,0,"span",29)(3,be,2,0,"span",30)(4,ye,2,0,"span",30),n()}if(a&2){let e=d(2).$implicit,i=d(3);c("disabled",i.deletingMembers[e.id]),l(),c("ngIf",!i.deletingMembers[e.id]),l(),c("ngIf",i.deletingMembers[e.id]),l(),c("ngIf",i.deletingMembers[e.id]),l(),c("ngIf",!i.deletingMembers[e.id])}}function Ee(a,t){if(a&1){let e=S();r(0,"div",71),p(1,we,5,5,"button",72),r(2,"button",73),x("click",function(){g(e);let s=d().$implicit,m=d(3);return v(m.showMemberDetails(s))}),r(3,"span",17),o(4,"info"),n(),o(5," Dettagli "),n()()}if(a&2){let e=d().$implicit,i=d(3);l(),c("ngIf",i.canRemoveStaff(e))}}function Me(a,t){if(a&1&&(r(0,"div",47),p(1,fe,12,1,"div",48)(2,pe,10,3,"div",48),r(3,"div",49),p(4,_e,9,0,"div",50)(5,xe,2,1,"div",51)(6,Ee,6,1,"div",52),n()()),a&2){let e=t.$implicit,i=d(3);b("pending-invitation",i.isPendingInvitation(e)),l(),c("ngIf",e.invitation_status==="pending"),l(),c("ngIf",e.invitation_status==="accepted"&&e.user),l(2),c("ngIf",i.isPendingInvitation(e)),l(),c("ngIf",i.isActiveMember(e)),l(),c("ngIf",i.isActiveMember(e))}}function Ie(a,t){if(a&1&&(r(0,"div",45),p(1,Me,7,7,"div",46),n()),a&2){let e=d(2);l(),c("ngForOf",e.staffMembers)}}function Re(a,t){if(a&1){let e=S();r(0,"label",88)(1,"input",89),x("change",function(s){let m=g(e).$implicit,f=d(4);return v(f.togglePermission("manager",m.key,s))}),n(),r(2,"div")(3,"strong"),o(4),n(),r(5,"div",90),o(6),n()()()}if(a&2){let e=t.$implicit,i=d(4);l(),c("checked",i.isPermissionEnabled("manager",e.key)),l(3),h(e.label),l(2),h(e.description)}}function Ce(a,t){if(a&1&&(r(0,"div",85)(1,"div",86),p(2,Re,7,3,"label",87),n()()),a&2){let e=d(3);b("collapsed",e.collapsedRoles.manager),l(2),c("ngForOf",e.permissionService.allPermissions)}}function Pe(a,t){if(a&1){let e=S();r(0,"label",93)(1,"input",89),x("change",function(s){let m=g(e).$implicit,f=d(4);return v(f.togglePermission("chef",m.key,s))}),n(),r(2,"div")(3,"strong"),o(4),n(),r(5,"div",90),o(6),n()()()}if(a&2){let e=t.$implicit,i=d(4);l(),c("checked",i.isPermissionEnabled("chef",e.key)),l(3),h(e.label),l(2),h(e.description)}}function ke(a,t){if(a&1&&(r(0,"div",91)(1,"div",86),p(2,Pe,7,3,"label",92),n()()),a&2){let e=d(3);b("collapsed",e.collapsedRoles.chef),l(2),c("ngForOf",e.permissionService.allPermissions)}}function Oe(a,t){if(a&1){let e=S();r(0,"label",93)(1,"input",89),x("change",function(s){let m=g(e).$implicit,f=d(4);return v(f.togglePermission("waiter",m.key,s))}),n(),r(2,"div")(3,"strong"),o(4),n(),r(5,"div",90),o(6),n()()()}if(a&2){let e=t.$implicit,i=d(4);l(),c("checked",i.isPermissionEnabled("waiter",e.key)),l(3),h(e.label),l(2),h(e.description)}}function De(a,t){if(a&1&&(r(0,"div",85)(1,"div",86),p(2,Oe,7,3,"label",92),n()()),a&2){let e=d(3);c("@collapse",e.collapsedRoles.waiter?"collapsed":"expanded"),l(2),c("ngForOf",e.permissionService.allPermissions)}}function Te(a,t){if(a&1){let e=S();r(0,"label",93)(1,"input",89),x("change",function(s){let m=g(e).$implicit,f=d(4);return v(f.togglePermission("kitchen_staff",m.key,s))}),n(),r(2,"div")(3,"strong"),o(4),n(),r(5,"div",90),o(6),n()()()}if(a&2){let e=t.$implicit,i=d(4);l(),c("checked",i.isPermissionEnabled("kitchen_staff",e.key)),l(3),h(e.label),l(2),h(e.description)}}function Fe(a,t){if(a&1&&(r(0,"div",85)(1,"div",86),p(2,Te,7,3,"label",92),n()()),a&2){let e=d(3);c("@collapse",e.collapsedRoles.kitchen_staff?"collapsed":"expanded"),l(2),c("ngForOf",e.permissionService.allPermissions)}}function $e(a,t){if(a&1){let e=S();r(0,"div",9)(1,"div",10)(2,"span",11),o(3,"admin_panel_settings"),n(),r(4,"h2",12),o(5,"Gestione Permessi Ruoli"),n()(),r(6,"p",5),o(7,"Configura cosa pu\xF2 fare ogni ruolo nel tuo ristorante"),n(),r(8,"div",75)(9,"div",76)(10,"button",77),x("click",function(){g(e);let s=d(2);return v(s.toggleRoleCollapse("manager"))}),r(11,"h3",78)(12,"span",11),o(13,"supervisor_account"),n(),o(14),n(),r(15,"span",79),o(16," keyboard_arrow_down "),n()(),p(17,Ce,3,3,"div",80),n(),r(18,"div",76)(19,"button",77),x("click",function(){g(e);let s=d(2);return v(s.toggleRoleCollapse("chef"))}),r(20,"h3",78)(21,"span",11),o(22,"restaurant"),n(),o(23),n(),r(24,"span",79),o(25," keyboard_arrow_down "),n()(),p(26,ke,3,3,"div",81),n(),r(27,"div",76)(28,"button",77),x("click",function(){g(e);let s=d(2);return v(s.toggleRoleCollapse("waiter"))}),r(29,"h3",78)(30,"span",11),o(31,"person"),n(),o(32),n(),r(33,"span",79),o(34," keyboard_arrow_down "),n()(),p(35,De,3,2,"div",82),n(),r(36,"div",76)(37,"button",77),x("click",function(){g(e);let s=d(2);return v(s.toggleRoleCollapse("kitchen_staff"))}),r(38,"h3",78)(39,"span",11),o(40,"kitchen"),n(),o(41),n(),r(42,"span",79),o(43," keyboard_arrow_down "),n()(),p(44,Fe,3,2,"div",82),n()(),r(45,"div",83)(46,"p",84)(47,"span",17),o(48,"info"),n(),o(49," I permessi verranno applicati automaticamente ai nuovi membri dello staff "),n()()()}if(a&2){let e=d(2);l(14),y(" ",e.getRoleDisplayName("manager")," "),l(),b("rotate-180",!e.collapsedRoles.manager),l(2),c("ngIf",!e.collapsedRoles.manager),l(6),y(" ",e.getRoleDisplayName("chef")," "),l(),b("rotate-180",!e.collapsedRoles.chef),l(2),c("ngIf",!e.collapsedRoles.chef),l(6),y(" ",e.getRoleDisplayName("waiter")," "),l(),b("rotate-180",!e.collapsedRoles.waiter),l(2),c("ngIf",!e.collapsedRoles.waiter),l(6),y(" ",e.getRoleDisplayName("kitchen_staff")," "),l(),b("rotate-180",!e.collapsedRoles.kitchen_staff),l(2),c("ngIf",!e.collapsedRoles.kitchen_staff)}}function Ve(a,t){if(a&1){let e=S();r(0,"div",8)(1,"div",9)(2,"div",10)(3,"span",11),o(4,"person_add"),n(),r(5,"h2",12),o(6,"Aggiungi Nuovo Membro"),n()(),r(7,"form",13),x("ngSubmit",function(){g(e);let s=d();return v(s.onAddStaff())}),r(8,"div",14)(9,"div",15)(10,"label",16)(11,"span",17),o(12,"email"),n(),o(13," Email * "),n(),C(14,"input",18),p(15,ie,3,2,"div",19),n(),r(16,"div",15)(17,"label",16)(18,"span",17),o(19,"badge"),n(),o(20," Ruolo * "),n(),r(21,"select",20)(22,"option",21),o(23,"Seleziona un ruolo"),n(),p(24,ne,2,2,"option",22),n(),p(25,re,2,1,"div",19)(26,se,5,2,"div",23),n()(),r(27,"div",15)(28,"label",24),C(29,"input",25),r(30,"div")(31,"strong"),o(32,"Invia invito via email"),n(),r(33,"div",5),o(34,"Invia un'email di invito con le credenziali di accesso"),n()()()(),r(35,"div",26)(36,"button",27),p(37,oe,2,0,"span",28)(38,le,2,0,"span",29)(39,ce,2,0,"span",30)(40,de,2,0,"span",30),n(),r(41,"button",31),x("click",function(){g(e);let s=d();return v(s.staffForm.reset({send_invitation:!0}))}),r(42,"span",17),o(43,"clear"),n(),o(44," Pulisci "),n()()()(),r(45,"div",9)(46,"div",10)(47,"span",11),o(48,"list"),n(),r(49,"h2",12),o(50,"Team del Ristorante"),n(),r(51,"span",32),o(52),n()(),p(53,me,8,0,"div",33)(54,Ie,2,1,"div",34),n(),p(55,$e,50,16,"div",35),n()}if(a&2){let e,i=d();l(7),c("formGroup",i.staffForm),l(7),b("border-red-500",i.isFieldInvalid("email")),l(),c("ngIf",i.isFieldInvalid("email")),l(6),b("border-red-500",i.isFieldInvalid("role")),l(3),c("ngForOf",i.roleOptions),l(),c("ngIf",i.isFieldInvalid("role")),l(),c("ngIf",(e=i.staffForm.get("role"))==null?null:e.value),l(10),c("disabled",i.staffForm.invalid||i.addingStaff),l(),c("ngIf",i.addingStaff),l(),c("ngIf",!i.addingStaff),l(),c("ngIf",i.addingStaff),l(),c("ngIf",!i.addingStaff),l(),c("disabled",i.addingStaff),l(11),y("",i.staffMembers.length," membri"),l(),c("ngIf",i.staffMembers.length===0&&!i.loadingService.isLoadingSync()),l(),c("ngIf",i.staffMembers.length>0),l(),c("ngIf",i.isOwner)}}function Ne(a,t){a&1&&(r(0,"div",94)(1,"div",95)(2,"span",96),o(3,"block"),n(),r(4,"h3",97),o(5,"Accesso Negato"),n(),r(6,"p",5),o(7,"Non hai i permessi per gestire il personale del ristorante."),n(),r(8,"p",5),o(9,"Solo il titolare e i responsabili possono accedere a questa sezione."),n()()())}var K=class a{supabase=E($).getSupabaseClient();fb=E(J);authService=E(N);permissionService=E(V);loadingService=E(Z);isOwner=!1;isManager=!1;currentUserRole=null;authSubscription=new P;staffForm;staffMembers=[];addingStaff=!1;updatingRoles={};deletingMembers={};showPermissionsSection=!1;savingPermissions={};rolePermissions=[];roleOptions=[{value:"manager",label:"Responsabile",description:"Gestione completa eccetto eliminazioni"},{value:"chef",label:"Chef",description:"Cucina e ingredienti"},{value:"waiter",label:"Cameriere",description:"Prenotazioni e gestione tavoli"},{value:"kitchen_staff",label:"Dipendente di Cucina",description:"Supporto in cucina e preparazione"}];constructor(){this.staffForm=this.fb.group({email:["",[M.required,M.email]],role:["",M.required],send_invitation:[!0]})}ngOnInit(){return u(this,null,function*(){console.log("StaffManagement OnInit - DEBUG:"),this.loadingService.start(),this.authSubscription=this.authService.currentUser$.subscribe(()=>{this.updateAuthState()}),this.updateAuthState();try{yield Promise.all([this.loadStaffMembers(),this.loadRolePermissions()])}catch(t){console.error("Errore nel caricamento iniziale:",t)}finally{this.loadingService.stop()}})}ngOnDestroy(){this.authSubscription&&this.authSubscription.unsubscribe()}updateAuthState(){this.isOwner=this.authService.isOwner(),this.isManager=this.authService.isManager(),this.currentUserRole=this.authService.getStaffRole(),console.log("\u{1F504} StaffManagement Auth State Updated:",{isOwner:this.isOwner,isManager:this.isManager,currentUserRole:this.currentUserRole})}loadStaffMembers(){return u(this,null,function*(){this.loadingService.start();try{let t=this.authService.getCurrentRestaurantId();if(!t){console.error("Nessun ristorante associato");return}console.log("\u{1F50D} Loading staff for restaurant:",t);let{data:e,error:i}=yield this.supabase.from("restaurant_staff").select("*").eq("restaurant_id",t).in("invitation_status",["pending","accepted"]).order("created_at",{ascending:!1});if(i)throw console.error("\u274C Error loading staff:",i),i;let s=yield Promise.all((e||[]).map(m=>u(this,null,function*(){let f=null,_=null;if(m.user_id){let{data:w}=yield this.supabase.from("users").select("id, first_name, last_name, email, phone").eq("id",m.user_id).single();f=w}if(m.invited_by){let{data:w}=yield this.supabase.from("users").select("first_name, last_name").eq("id",m.invited_by).single();_=w}return R(I({},m),{user:f,inviter:_})})));console.log("\u2705 Staff loaded with users:",s.length),this.staffMembers=s}catch(t){console.error("Error loading staff members:",t),alert("Errore nel caricamento del personale: "+t.message)}finally{this.loadingService.stop()}})}getRolePermissions(t){return u(this,null,function*(){let e=this.authService.getCurrentRestaurantId();if(!e)return this.permissionService.getDefaultPermissionsForRole(t);try{let{data:i,error:s}=yield this.supabase.from("restaurant_role_permissions").select("permissions").eq("restaurant_id",e).eq("role",t).single();if(s){if(s.code==="PGRST116")return this.permissionService.getDefaultPermissionsForRole(t);throw s}return i?.permissions||this.permissionService.getDefaultPermissionsForRole(t)}catch(i){return console.error("Error getting role permissions:",i),this.permissionService.getDefaultPermissionsForRole(t)}})}getPermissionsStatus(){console.log("\u{1F50D} DEBUG Permissions Status:"),console.log(" - Restaurant ID:",this.authService.getCurrentRestaurantId()),console.log(" - Role Permissions loaded:",this.rolePermissions.length),this.rolePermissions.forEach(t=>{console.log(`   - ${t.role}:`,t.permissions)})}updateExistingStaffPermissions(t){return u(this,null,function*(){if(!confirm(`Vuoi applicare i nuovi permessi a tutti i membri esistenti con ruolo "${this.getRoleDisplayName(t)}"?`))return;let e=this.authService.getCurrentRestaurantId();if(e)try{let i=this.rolePermissions.find(m=>m.role===t);if(!i)return;let{error:s}=yield this.supabase.from("restaurant_staff").update({permissions:i.permissions,updated_at:new Date().toISOString()}).eq("restaurant_id",e).eq("role",t).eq("invitation_status","accepted");if(s)throw s;yield this.authService.loadPermissions(),alert(`Permessi aggiornati per tutti i membri con ruolo ${this.getRoleDisplayName(t)}`)}catch(i){console.error("Error updating staff permissions:",i),alert("Errore nell'aggiornamento dei permessi: "+i.message)}})}generateToken(){return Math.random().toString(36).substring(2)+Date.now().toString(36)}getRoleDisplayName(t){return{manager:"Responsabile",chef:"Chef",waiter:"Cameriere",kitchen_staff:"Staff Cucina"}[t]||t}getRoleDescription(t){return{owner:"Accesso completo a tutte le funzionalit\xE0",manager:"Gestione completa eccetto eliminazioni definitive",chef:"Gestione cucina, ingredienti e inventario",waiter:"Gestione prenotazioni, tavoli e ordini",kitchen_staff:"Visualizzazione ordini in cucina"}[t]||"Ruolo del personale"}markFormGroupTouched(){Object.keys(this.staffForm.controls).forEach(t=>{this.staffForm.get(t)?.markAsTouched()})}isFieldInvalid(t){let e=this.staffForm.get(t);return!!(e&&e.invalid&&(e.dirty||e.touched))}ngAfterViewInit(){console.log("\u{1F50D} DEBUG Staff Management:"),console.log(" - Utente autenticato:",this.authService.isAuthenticated()),console.log(" - Utente ristorante:",this.authService.isRestaurantUser()),console.log(" - Ruolo staff:",this.authService.getStaffRole()),console.log(" - isOwner():",this.authService.isOwner()),console.log(" - isManager():",this.authService.isManager()),console.log(" - Staff record:",this.authService.getCurrentStaff()),console.log(" - Restaurant ID:",this.authService.getCurrentRestaurantId())}canEditStaff(t){let e=this.authService.isOwner(),i=this.authService.getStaffRole(),s=this.authService.currentUserValue?.id;return t.user_id===s?!1:e?!0:i==="manager"?t.role!=="manager":!1}canRemoveStaff(t){let e=this.authService.isOwner(),i=this.authService.getStaffRole(),s=this.authService.currentUserValue?.id;return t.user_id===s?!1:e?!0:i==="manager"?["chef","waiter","kitchen_staff"].includes(t.role):!1}handleError(t,e){console.error("Staff Management Error:",t),t?.code==="23503"?alert("Impossibile completare l'operazione: esistono dati collegati a questo membro dello staff."):t?.message?alert("Errore: "+t.message):alert(e)}isPendingInvitation(t){return t.invitation_status==="pending"}isActiveMember(t){return t.invitation_status==="accepted"}getInvitationStatusDisplay(t){return{pending:"In attesa",accepted:"Accettato",active:"Attivo",expired:"Scaduto"}[t]||t}resendInvitation(t){return u(this,null,function*(){try{console.log(`Reinvio invito a ${t.email}`),alert("Invito reinviato (funzionalit\xE0 email da implementare)")}catch(e){console.error("Error resending invitation:",e),alert("Errore: "+e.message)}})}cancelInvitation(t){return u(this,null,function*(){if(confirm(`Sei sicuro di voler annullare l'invito per ${t.email}?`))try{let{error:e}=yield this.supabase.from("restaurant_staff").delete().eq("id",t.id);if(e)throw e;yield this.loadStaffMembers(),alert("Invito annullato con successo!")}catch(e){console.error("Error canceling invitation:",e),alert("Errore: "+e.message)}})}togglePermission(t,e,i){return u(this,null,function*(){let s=i.target.checked,m=this.rolePermissions.find(_=>_.role===t);if(!m)return;this.savingPermissions[t]=!0;let f=[...m.permissions];s?f.includes(e)||f.push(e):f=f.filter(_=>_!==e);try{yield this.updateRolePermissions(t,f)}catch(_){i.target.checked=!s,console.error("Errore nel salvataggio del permesso:",_)}finally{this.savingPermissions[t]=!1}})}updateRolePermissions(t,e){return u(this,null,function*(){let i=this.authService.getCurrentRestaurantId();if(!i)return console.error("Nessun restaurantId trovato"),!1;try{let{data:s,error:m}=yield this.supabase.from("restaurant_role_permissions").select("id").eq("restaurant_id",i).eq("role",t).single(),f;if(m&&m.code!=="PGRST116")throw m;if(s?f=yield this.supabase.from("restaurant_role_permissions").update({permissions:e,updated_at:new Date().toISOString()}).eq("id",s.id):f=yield this.supabase.from("restaurant_role_permissions").insert({restaurant_id:i,role:t,permissions:e,created_at:new Date().toISOString(),updated_at:new Date().toISOString()}),f.error)throw f.error;let{error:_}=yield this.supabase.from("restaurant_staff").update({permissions:e,updated_at:new Date().toISOString()}).eq("restaurant_id",i).eq("role",t).eq("invitation_status","accepted");return _&&console.warn(`\u26A0\uFE0F Non tutti i permessi sono stati aggiornati: ${_.message}`),this.authService.getStaffRole()===t?yield this.authService.reloadCurrentUserPermissions():yield this.loadRolePermissions(),console.log(`\u2705 Permessi aggiornati per ${t}:`,e),!0}catch(s){return console.error("\u274C Errore aggiornamento permessi:",s),alert("Errore nel salvataggio dei permessi: "+s.message),!1}})}isPermissionEnabled(t,e){return this.rolePermissions.find(s=>s.role===t)?.permissions.includes(e)||!1}loadRolePermissions(){return u(this,null,function*(){let t=this.authService.getCurrentRestaurantId();if(t)try{let{data:e,error:i}=yield this.supabase.from("restaurant_role_permissions").select("*").eq("restaurant_id",t);if(i)throw i;this.rolePermissions=e||[],this.rolePermissions.length===0&&(yield this.createDefaultPermissions())}catch(e){console.error("Errore caricamento permessi:",e)}})}createDefaultPermissions(){return u(this,null,function*(){let t=this.authService.getCurrentRestaurantId();if(!t)return;let e=[{role:"manager",permissions:this.permissionService.getDefaultPermissionsForRole("manager")},{role:"chef",permissions:this.permissionService.getDefaultPermissionsForRole("chef")},{role:"waiter",permissions:this.permissionService.getDefaultPermissionsForRole("waiter")},{role:"kitchen_staff",permissions:this.permissionService.getDefaultPermissionsForRole("kitchen_staff")}];try{for(let i of e){let{error:s}=yield this.supabase.from("restaurant_role_permissions").insert({restaurant_id:t,role:i.role,permissions:i.permissions});if(s)throw s}yield this.loadRolePermissions()}catch(i){console.error("Errore creazione permessi predefiniti:",i)}})}collapsedRoles={manager:!0,chef:!0,waiter:!0,kitchen_staff:!0};toggleRoleCollapse(t){this.collapsedRoles[t]=!this.collapsedRoles[t]}onAddStaff(){return u(this,null,function*(){if(!this.staffForm.invalid){this.loadingService.start(),this.addingStaff=!0;try{let t=this.staffForm.value,e=this.authService.getCurrentRestaurantId(),i=this.authService.currentUserValue;if(!e||!i)throw new Error("Ristorante o utente non trovato");let{data:s}=yield this.supabase.from("restaurant_staff").select("id").eq("restaurant_id",e).eq("email",t.email.toLowerCase().trim()).eq("invitation_status","pending").single();if(s)throw new Error("Esiste gi\xE0 un invito pendente per questa email");let{error:m}=yield this.supabase.from("restaurant_staff").insert({restaurant_id:e,email:t.email.toLowerCase().trim(),role:t.role,invitation_status:"pending",invitation_token:this.generateToken(),invitation_expires_at:new Date(Date.now()+720*60*60*1e3).toISOString(),invited_by:i.id,permissions:yield this.getRolePermissions(t.role)});if(m)throw m;alert("Invito creato con successo!"),this.staffForm.reset(),yield this.loadStaffMembers()}catch(t){alert("Errore: "+t.message),console.error("Error in onAddStaff:",t)}finally{this.addingStaff=!1,this.loadingService.stop()}}})}onRoleChangeAttempt(t,e){let i=e.target,s=i.value;if(console.log("\u{1F50D} DEBUG onRoleChangeAttempt:",{memberId:t.id,currentRole:t.role,newRole:s,user:t.user}),t.role===s)return;let m=t.role,f=t.user?`${t.user.first_name} ${t.user.last_name}`:t.email,_=this.getRoleDisplayName(m),w=this.getRoleDisplayName(s);console.log("\u{1F50D} Ruoli per conferma:",{oldRole:m,oldRoleDisplay:_,newRole:s,newRoleDisplay:w}),confirm(`Sei sicuro di voler cambiare il ruolo di ${f} da "${_}" a "${w}"?`)?this.updateStaffRole(t,s,m):i.value=m}updateStaffRole(t,e,i){return u(this,null,function*(){if(console.log("\u{1F50D} DEBUG updateStaffRole:",{memberId:t.id,oldRole:i,newRole:e,currentMemberRole:t.role}),!this.canEditStaff(t)){alert("Non hai i permessi per modificare questo membro dello staff");return}this.updatingRoles[t.id]=!0;try{let{error:s}=yield this.supabase.from("restaurant_staff").update({role:e,permissions:yield this.getRolePermissions(e),updated_at:new Date().toISOString()}).eq("id",t.id);if(s)throw s;let m=this.staffMembers.findIndex(_=>_.id===t.id);m!==-1&&(this.staffMembers[m]=R(I({},this.staffMembers[m]),{role:e}),this.staffMembers=[...this.staffMembers]),yield this.authService.refreshPermissions();let f=t.user?`${t.user.first_name} ${t.user.last_name}`:t.email;console.log(`\u2705 Ruolo aggiornato: ${f} -> ${e}`),alert(`Ruolo di ${f} aggiornato con successo da "${this.getRoleDisplayName(i)}" a "${this.getRoleDisplayName(e)}"!`)}catch(s){console.error("\u274C Error updating staff role:",s),yield this.loadStaffMembers(),alert("Errore nell'aggiornamento del ruolo: "+s.message)}finally{this.updatingRoles[t.id]=!1}})}removeStaff(t){return u(this,null,function*(){if(!this.canRemoveStaff(t)){alert("Non hai i permessi per rimuovere questo membro dello staff");return}let e=t.user?`${t.user.first_name} ${t.user.last_name}`:t.email;if(confirm(`Sei sicuro di voler rimuovere ${e} dallo staff?

Questa azione non pu\xF2 essere annullata.`)){this.deletingMembers[t.id]=!0;try{let{error:i}=yield this.supabase.from("restaurant_staff").delete().eq("id",t.id);if(i)throw i;this.staffMembers=this.staffMembers.filter(s=>s.id!==t.id),alert("Membro rimosso con successo dallo staff!")}catch(i){console.error("Error removing staff:",i),alert("Errore: "+i.message)}finally{this.deletingMembers[t.id]=!1}}})}showMemberDetails(t){let i=`
  Nome: ${t.user?`${t.user.first_name} ${t.user.last_name}`:t.email}
  Email: ${t.user?.email||t.email}
  Ruolo: ${this.getRoleDisplayName(t.role)}
  Stato: ${this.getInvitationStatusDisplay(t.invitation_status)}
  Data aggiunta: ${new Date(t.created_at).toLocaleDateString("it-IT")}
  ${t.inviter?`Invitato da: ${t.inviter.first_name} ${t.inviter.last_name}`:""}
    `.trim();alert(i)}isEditingSelf(t){return t.user_id===this.authService.currentUserValue?.id}applyPermissionsToExisting(){return u(this,null,function*(){if(confirm("Applicare i permessi modificati a tutti i membri dello staff?"))try{for(let t of this.rolePermissions){let{error:e}=yield this.supabase.from("restaurant_staff").update({permissions:t.permissions,updated_at:new Date().toISOString()}).eq("restaurant_id",this.authService.getCurrentRestaurantId()).eq("role",t.role).eq("invitation_status","accepted");e&&console.warn(`\u26A0\uFE0F Errore per ${t.role}:`,e.message)}alert("Permessi applicati a tutto lo staff!"),yield this.authService.refreshPermissions()}catch(t){console.error("Errore applicazione permessi:",t)}})}static \u0275fac=function(e){return new(e||a)};static \u0275cmp=k({type:a,selectors:[["app-staff-management"]],decls:11,vars:2,consts:[[1,"page-container"],[1,"section-header"],[1,"flex","gap-sm"],[1,"material-icons","fs-lg"],[1,"section-title"],[1,"text-muted"],["class","flex flex-col gap-md",4,"ngIf"],["class","card",4,"ngIf"],[1,"flex","flex-col","gap-md"],[1,"form-card"],[1,"flex","items-center","gap-sm","mb-md"],[1,"material-icons","text-md"],[1,"text-md","font-semibold","m-0"],[1,"flex","flex-col",3,"ngSubmit","formGroup"],[1,"form-row"],[1,"form-group","mb-md"],[1,"standard-label"],[1,"material-icons"],["type","email","formControlName","email","placeholder","mario.rossi@example.com"],["class","text-red-500 text-sm",4,"ngIf"],["formControlName","role"],["value",""],[3,"value",4,"ngFor","ngForOf"],["class","p-md mt-sm bg-smoke rounded border",4,"ngIf"],[1,"flex","items-center","gap-sm","cursor-pointer","p-sm","rounded","transition","hover:bg-[var(--smoke-1)]"],["type","checkbox","formControlName","send_invitation"],[1,"flex","justify-between","items-center","pt-md",2,"grid-column","1 / -1"],["type","submit",1,"promethea-button",3,"disabled"],["class","material-icons text-md mt-sm",4,"ngIf"],["class","material-icons",4,"ngIf"],[4,"ngIf"],["type","button",1,"promethea-button","ghost",3,"click","disabled"],[1,"chip"],["class","empty-state",4,"ngIf"],["class","grid-form",4,"ngIf"],["class","form-card",4,"ngIf"],[1,"text-red-500","text-sm"],[3,"value"],[1,"p-md","mt-sm","bg-smoke","rounded","border"],[1,"material-icons","text-md","mt-sm"],[1,"empty-state"],[1,"flex","gap-md","justify-center","mt-lg"],[1,"material-icons","text-6xl","text-muted","mb-4"],[1,"font-semibold","mb-md"],[1,"text-muted","flex","justify-center"],[1,"grid-form"],["class","staff-item",3,"pending-invitation",4,"ngFor","ngForOf"],[1,"staff-item"],["class","staff-info",4,"ngIf"],[1,"staff-member"],["class","action-group",4,"ngIf"],["class","role-selector",4,"ngIf"],["class","modal-footer p-md0",4,"ngIf"],[1,"staff-info"],[1,"avatartondo","pending"],[1,"staff-details"],[1,"staff-email"],[1,"staff-meta"],[1,"staff-status","pending"],[1,"flex","gap-sm","items-center"],[1,"avatartondo"],[1,"font-semibold"],[1,"action-group"],["title","Reinvia invito",1,"promethea-button",3,"click"],["title","Annulla invito",1,"promethea-button","ghost",3,"click"],[1,"role-selector"],["style","width: 100%;",4,"ngIf"],[2,"width","100%"],[1,"form-select",3,"change","ngModel","disabled"],["class","loading-spinner",4,"ngIf"],[1,"loading-spinner"],[1,"modal-footer","p-md0"],["class","promethea-button","title","Rimuovi membro",3,"disabled","click",4,"ngIf"],["title","Dettagli membro",1,"promethea-button","ghost",3,"click"],["title","Rimuovi membro",1,"promethea-button",3,"click","disabled"],[1,"flex","flex-col","gap-lg","mt-lg"],[1,"role-permissions-accordion","rounded-lg","overflow-hidden"],[1,"icon-button","bottone-ruolo",3,"click"],[1,"flex","items-center","gap-sm","font-bold","m-0","text-md"],[1,"material-icons","transition-transform","duration-200"],["class","mt-sm",3,"collapsed",4,"ngIf"],["class","mt-sm collapse-section",3,"collapsed",4,"ngIf"],["class","mt-sm",4,"ngIf"],[1,"mt-lg","pt-md","border-t"],[1,"text-muted","text-center"],[1,"mt-sm"],[1,"grid-cards","p-md","bg-smoke","rounded"],["class","flex items-center gap-sm cursor-pointer p-sm rounded transition",4,"ngFor","ngForOf"],[1,"flex","items-center","gap-sm","cursor-pointer","p-sm","rounded","transition"],["type","checkbox",3,"change","checked"],[1,"text-muted","text-mini"],[1,"mt-sm","collapse-section"],["class","flex items-center gap-sm cursor-pointer p-sm rounded transition hover:bg-[var(--smoke-2)]",4,"ngFor","ngForOf"],[1,"flex","items-center","gap-sm","cursor-pointer","p-sm","rounded","transition","hover:bg-[var(--smoke-2)]"],[1,"card"],[1,"text-center","p-xl","opacity-70"],[1,"material-icons","text-6xl"],[1,"text-md","font-semibold","mt-4"]],template:function(e,i){e&1&&(r(0,"div",0)(1,"div",1)(2,"div",2)(3,"span",3),o(4,"groups"),n(),r(5,"h1",4),o(6,"Gestione Personale"),n()(),r(7,"p",5),o(8,"Gestisci il team del tuo ristorante"),n()(),p(9,Ve,56,19,"div",6)(10,Ne,10,0,"div",7),n()),e&2&&(l(9),c("ngIf",i.isOwner||i.isManager),l(),c("ngIf",!(i.isOwner||i.isManager)))},dependencies:[F,D,T,Y,L,Q,W,A,q,H,z,U,j,B,X,G],styles:[".staff-item[_ngcontent-%COMP%]{display:flex;align-items:center;flex-wrap:wrap;justify-content:space-between;padding:var(--gap-md);border:1px solid var(--smoke-1);border-radius:12px;background:var(--vetro);transition:all .3s cubic-bezier(.2,.9,.2,1);overflow:hidden}.staff-item[_ngcontent-%COMP%]:hover{border-color:var(--secondary);box-shadow:0 4px 12px var(--smoke-2)}.staff-item.pending-invitation[_ngcontent-%COMP%]{background:color-mix(in srgb,var(--secondary) 5%,transparent)}.staff-info[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:var(--gap-sm);width:100%}.avatartondo.pending[_ngcontent-%COMP%]{background:var(--smoke-3);color:var(--tertiary)}.staff-details[_ngcontent-%COMP%]{display:flex;flex-direction:column;text-wrap:wrap}.staff-name[_ngcontent-%COMP%]{font-weight:600;font-size:var(--fs-md)}.staff-email[_ngcontent-%COMP%]{color:var(--text-muted);font-size:var(--fs-sm)}.staff-meta[_ngcontent-%COMP%]{display:flex;align-items:center;gap:var(--gap-sm);margin-top:var(--gap-sm)}.staff-status[_ngcontent-%COMP%]{display:inline-flex;align-items:center;gap:4px;padding:4px 8px;border-radius:999px;font-size:.75rem;font-weight:600}.staff-member[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:var(--gap-sm);padding:0;width:100%;margin-top:var(--gap-md)}.staff-status.pending[_ngcontent-%COMP%]{background:color-mix(in srgb,var(--secondary) 20%,transparent);color:var(--secondary)}.form-select[_ngcontent-%COMP%]{width:100%}.action-group[_ngcontent-%COMP%]{display:flex;gap:var(--gap-sm)}.bottone-ruolo[_ngcontent-%COMP%]{display:flex;width:100%;justify-content:space-between;padding:var(--gap-sm) var(--gap-md)}@media (max-width: 768px){.staff-item[_ngcontent-%COMP%]{flex-direction:column;align-items:flex-start;gap:var(--gap-md)}.staff-actions[_ngcontent-%COMP%]{align-self:flex-end}}.permission-section[_ngcontent-%COMP%]{transition:all .3s ease;overflow:hidden;max-height:500px;opacity:1}.permission-section.collapsed[_ngcontent-%COMP%]{max-height:0;opacity:0;padding:0;margin:0;overflow:hidden}"]})};export{K as StaffManagement};
