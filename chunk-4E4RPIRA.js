import{a as h}from"./chunk-CXV4BLDF.js";import{w as f}from"./chunk-L5SOXNIK.js";import{F as p,L as b,_ as m,a as u,b as d,da as l,f as a,m as g}from"./chunk-KZSY5CHT.js";var _=class o{supabaseService=l(f);authService=l(h);ingredientsSubject=new g([]);ingredients$=this.ingredientsSubject.asObservable();constructor(){this.authService.currentUser$.pipe(p(e=>!!e),b(1)).subscribe(()=>{this.loadIngredients()})}loadIngredients(){return a(this,null,function*(){try{let e=this.authService.currentUserValue;if(!e){console.log("No user found");return}let{data:r,error:n}=yield this.supabaseService.getSupabaseClient().from("restaurants").select("id").eq("owner_id",e.id).limit(1);if(n||!r||r.length===0){console.error("\u274C No restaurant found for user:",e.id);return}let t=r[0].id,{data:i,error:s}=yield this.supabaseService.getSupabaseClient().from("ingredients").select(`
          *,
          units (*),
          suppliers (company_name, contact_name)
        `).eq("restaurant_id",t).eq("is_active",!0).order("name");if(s){console.error("Error loading ingredients:",s);return}console.log("Ingredients loaded with units and suppliers:",i?.length),this.ingredientsSubject.next(i||[])}catch(e){console.error("Error in loadIngredients:",e)}})}createIngredient(e){return a(this,null,function*(){try{let r=this.authService.currentUserValue;if(!r)return console.error("No user authenticated"),null;let{data:n,error:t}=yield this.supabaseService.getSupabaseClient().from("restaurants").select("id").eq("owner_id",r.id).limit(1);if(t||!n||n.length===0)return console.error("\u274C No restaurant found for user:",r.id),null;let i=n[0].id;console.log("\u{1F3EA} Using restaurant:",i);let s=d(u({},e),{expiry_date:e.expiry_date===""?null:e.expiry_date,restaurant_id:i});console.log("\u{1F4DD} Creating ingredient:",s);let{data:I,error:c}=yield this.supabaseService.getSupabaseClient().from("ingredients").insert(s).select().single();if(c)throw console.error("\u274C Error creating ingredient:",c),c;return console.log("\u2705 Ingredient created successfully"),yield this.loadIngredients(),I}catch(r){return console.error("\u{1F4A5} Error in createIngredient:",r),null}})}updateIngredient(e,r){return a(this,null,function*(){try{let n=d(u({},r),{expiry_date:r.expiry_date===""?null:r.expiry_date}),{error:t}=yield this.supabaseService.getSupabaseClient().from("ingredients").update(n).eq("id",e);if(t)throw t;return yield this.loadIngredients(),!0}catch(n){return console.error("Error updating ingredient:",n),!1}})}deleteIngredient(e){return a(this,null,function*(){try{let{error:r}=yield this.supabaseService.getSupabaseClient().from("ingredients").update({is_active:!1}).eq("id",e);if(r)throw r;return yield this.loadIngredients(),!0}catch(r){return console.error("Error deleting ingredient:",r),!1}})}getIngredients(){return this.ingredientsSubject.value}getIngredientById(e){return this.ingredientsSubject.value.find(r=>r.id===e)}getLowStockIngredients(){return this.ingredientsSubject.value.filter(e=>e.alert_enabled&&e.current_stock<=e.minimum_stock)}searchIngredients(e){return e?this.ingredientsSubject.value.filter(r=>r.name.toLowerCase().includes(e.toLowerCase())||r.description?.toLowerCase().includes(e.toLowerCase())):this.ingredientsSubject.value}calculateIngredientCost(e,r){if(!e.unit_id||!e.units)return e.cost_per_unit*r;let n=e.units,t=r;switch(n.symbol){case"kg":t=r/1e3;break;case"L":t=r/1e3;break;case"g":case"mL":case"pz":t=r;break;default:t=r}return e.cost_per_unit*t}static \u0275fac=function(r){return new(r||o)};static \u0275prov=m({token:o,factory:o.\u0275fac,providedIn:"root"})};export{_ as a};
