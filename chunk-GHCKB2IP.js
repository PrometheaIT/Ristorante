import{a as f}from"./chunk-3SRQJDPW.js";import{C as l,V as g,c as u,n as c,na as m}from"./chunk-UNLQURJ5.js";import{j as i}from"./chunk-4ZZIO3ZI.js";var h=class s extends f{getTableName(){return"categories"}getRestaurantId(){return i(this,null,function*(){return yield this.getCurrentRestaurantId()})}getCategoriesForOrderEditor(){return this.data$.pipe(l(e=>(console.warn("\u26A0\uFE0F Errore categorie, usando default:",e),c(this.getDefaultCategories()))))}getDefaultCategories(){return[{id:"antipasti",name:"Antipasti",order_index:1,is_default:!1,restaurant_id:""},{id:"primi",name:"Primi",order_index:2,is_default:!1,restaurant_id:""},{id:"secondi",name:"Secondi",order_index:3,is_default:!1,restaurant_id:""},{id:"dessert",name:"Dessert",order_index:4,is_default:!1,restaurant_id:""},{id:"bevande",name:"Bevande",order_index:5,is_default:!1,restaurant_id:""}]}loadData(){return i(this,null,function*(){try{let e=yield this.getCurrentRestaurantId();if(!e){console.warn("\u26A0\uFE0F Nessun restaurantId trovato per CategoryService"),this.dataSubject.next([]);return}console.log("\u{1F4CB} Caricamento categorie per restaurant:",e),this.loadingService.start();let{data:r,error:t}=yield this.supabaseService.getSupabaseClient().from(this.getTableName()).select("*").eq("restaurant_id",e).order("order_index",{ascending:!0});if(t)if(t.code==="42501"||t.message.includes("403"))console.error("\u274C Errore autorizzazione (403) per categorie:",t.message),this.errorSubject.next("Non hai i permessi per visualizzare le categorie"),this.dataSubject.next(this.getDefaultCategories());else throw t;else console.log(`\u2705 Categorie caricate: ${r?.length||0}`),this.dataSubject.next(r||[])}catch(e){console.error("\u274C Errore caricamento categorie:",e),this.errorSubject.next(e.message||"Errore caricamento categorie"),this.dataSubject.next(this.getDefaultCategories())}finally{this.loadingService.stop()}})}getCategories(){return this.dataSubject.value}getCategoriesForEditor(){return this.data$.pipe(l(e=>(console.warn("\u26A0\uFE0F Errore categorie, usando fallback:",e),c(this.getDefaultCategories()))))}createCategory(e){return i(this,null,function*(){try{if(console.log("\u{1F4DD} Creazione categoria:",e),!e.name||e.name.trim()==="")return this.errorSubject.next("Il nome della categoria \xE8 obbligatorio"),null;let r=yield this.getCurrentRestaurantId();if(!r)return console.error("\u274C Nessun restaurantId trovato"),this.errorSubject.next("Nessun ristorante selezionato"),null;let t=0;try{let{data:o,error:p}=yield this.supabaseService.getSupabaseClient().from("categories").select("order_index").eq("restaurant_id",r).order("order_index",{ascending:!1}).limit(1);!p&&o&&o.length>0&&(t=o[0].order_index+1)}catch(o){console.warn("\u26A0\uFE0F Errore calcolo order_index, usando 0:",o)}let n={name:e.name.trim(),description:e.description?.trim()||null,is_default:e.is_default||!1,order_index:t,restaurant_id:r,created_at:new Date().toISOString(),updated_at:new Date().toISOString()};console.log("\u{1F4E4} Inserimento categoria:",n);let{data:d,error:a}=yield this.supabaseService.getSupabaseClient().from("categories").insert(n).select().single();return a?(console.error("\u{1F4A5} [ERROR] Errore Supabase DETTAGLIATO:",{message:a.message,code:a.code,details:a.details,hint:a.hint,stack:a.stack}),console.error("\u{1F4E4} [ERROR] Dati inviati a Supabase:",JSON.stringify(n,null,2)),this.errorSubject.next(a.message||"Errore creazione categoria"),null):(console.log("\u2705 Categoria creata:",d),yield this.loadData(),d)}catch(r){return console.error("\u{1F4A5} Errore inatteso creazione categoria:",r),this.errorSubject.next(r.message||"Errore inatteso"),null}})}createCategoryForCurrentUser(e){return i(this,null,function*(){return this.createCategory(e)})}getRestaurantId$(){return new u(e=>{this.getRestaurantId().then(r=>{e.next(r),e.complete()}).catch(r=>e.error(r))})}static \u0275fac=(()=>{let e;return function(t){return(e||(e=m(s)))(t||s)}})();static \u0275prov=g({token:s,factory:s.\u0275fac,providedIn:"root"})};export{h as a};
