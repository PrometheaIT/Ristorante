import{a as h}from"./chunk-3F4CDTNS.js";import{a as b,b as _,ba as l,h as n,va as p}from"./chunk-2FS7XGGJ.js";var f=class i extends h{getTableName(){return"comande"}hasRestaurantId(){return!0}createForOrdine(t,e){return n(this,null,function*(){try{let r=yield this.getCurrentRestaurantId();if(!r)return console.error("\u274C Nessun restaurantId"),null;let{data:a,error:s}=yield this.supabaseService.getSupabaseClient().from("ordini").select(`
        *,
        order_header:order_header_id (
          id,
          table_id,
          tavolata_id,
          order_number,
          customer_name,
          customer_phone,
          restaurant_id
        )
      `).eq("id",t).single();if(s)throw s;let o=a.order_header;if(!o)throw new Error("Order header non trovato");let d=e||(yield this.getNextComandaNumber(t)),u={order_number:`CMD-${o.order_number}-${a.ordine_number}-${d}`,restaurant_id:r,ordine_id:t,tavolata_id:o.id,comanda_number:d,table_id:o.table_id,customer_name:o.customer_name||"Cliente",customer_phone:o.customer_phone||"",status:"ordered",subtotal:0,tax_amount:0,discount_amount:0,total_amount:0,customer_notes:"",order_type:"dine_in"},{data:c,error:m}=yield this.supabaseService.getSupabaseClient().from(this.getTableName()).insert(u).select().single();if(m)throw m;return c}catch(r){return console.error("\u{1F4A5} ERRORE createForOrdine:",r),null}})}getNextComandaNumber(t){return n(this,null,function*(){try{let{data:e,error:r}=yield this.supabaseService.getSupabaseClient().from(this.getTableName()).select("comanda_number").eq("ordine_id",t).order("comanda_number",{ascending:!1}).limit(1);if(r)throw r;return e&&e.length>0?e[0].comanda_number+1:1}catch(e){return console.error("Errore calcolo prossima comanda:",e),1}})}loadByOrdineId(t){return n(this,null,function*(){try{let{data:e,error:r}=yield this.supabaseService.getSupabaseClient().from(this.getTableName()).select("*").eq("ordine_id",t).order("comanda_number",{ascending:!0});if(r)throw r;return e||[]}catch(e){return console.error("Errore caricamento comande:",e),[]}})}updateStatus(t,e){return n(this,null,function*(){return yield this.update(t,{status:e,updated_at:new Date().toISOString()})})}updateTotalAmount(t,e){return n(this,null,function*(){return yield this.update(t,{total_amount:e,subtotal:e,updated_at:new Date().toISOString()})})}recalculateTotal(t){return n(this,null,function*(){try{let{data:e,error:r}=yield this.supabaseService.getSupabaseClient().from("order_items").select("total_price").eq("order_id",t);if(r)throw r;let a=(e||[]).reduce((s,o)=>s+(o.total_price||0),0);return yield this.updateTotalAmount(t,a),a}catch(e){return console.error("Errore ricalcolo totale:",e),0}})}loadByOrderHeaderId(t){return n(this,null,function*(){try{let{data:e,error:r}=yield this.supabaseService.getSupabaseClient().from(this.getTableName()).select("*").eq("order_header_id",t).order("comanda_number",{ascending:!0});if(r)throw r;return e||[]}catch(e){return console.error("Errore caricamento comande per order header:",e),[]}})}static \u0275fac=(()=>{let t;return function(r){return(t||(t=p(i)))(r||i)}})();static \u0275prov=l({token:i,factory:i.\u0275fac,providedIn:"root"})};var S=class i extends h{getTableName(){return"order_items"}hasRestaurantId(){return!0}addItemToComanda(t,e,r=1,a,s=""){return n(this,null,function*(){try{console.log("\u{1F504} OrderItemService.addItemToComanda chiamato",{comandaId:t,dishId:e,quantity:r,unitPrice:a});let o=yield this.getCurrentRestaurantId();if(!o)return console.error("\u274C Nessun restaurantId"),null;let d=a*r,g={order_id:t,dish_id:e,quantity:r,unit_price:a,total_price:d,item_notes:s||"",status:"ordered",restaurant_id:o};console.log("\u{1F4E4} Insert order item con dati:",g);let{data:u,error:c}=yield this.supabaseService.getSupabaseClient().from(this.getTableName()).insert(g).select().single();if(c)return console.error("\u274C ERRORE INSERT:",{message:c.message,details:c.details,hint:c.hint,code:c.code}),null;console.log("\u2705 Order item inserito:",u);let m=yield this.getDishName(e);return _(b({},u),{dish_name:m,comanda_id:u.order_id})}catch(o){return console.error("\u{1F4A5} Errore critico:",o),null}})}getDishName(t){return n(this,null,function*(){try{let{data:e,error:r}=yield this.supabaseService.getSupabaseClient().from("dishes").select("name").eq("id",t).single();return r||!e?(console.warn("\u26A0\uFE0F Impossibile recuperare nome piatto:",r),"Piatto"):e.name}catch(e){return console.error("Errore recupero nome piatto:",e),"Piatto"}})}loadByComandaId(t){return n(this,null,function*(){try{let{data:e,error:r}=yield this.supabaseService.getSupabaseClient().from("order_items").select(`
        *,
        dish:dish_id(name)
      `).eq("order_id",t).order("created_at",{ascending:!0});if(r)throw r;return(e||[]).map(a=>_(b({},a),{dish_name:a.dish?.name||"Piatto",comanda_id:a.order_id}))}catch(e){return console.error("Errore caricamento order_items:",e),[]}})}updateQuantity(t,e){return n(this,null,function*(){try{let{data:r,error:a}=yield this.supabaseService.getSupabaseClient().from(this.getTableName()).select("unit_price").eq("id",t).single();if(a)throw a;let s=r.unit_price*e,{error:o}=yield this.supabaseService.getSupabaseClient().from(this.getTableName()).update({quantity:e,total_price:s,updated_at:new Date().toISOString()}).eq("id",t);if(o)throw o;return!0}catch(r){return console.error("Errore aggiornamento quantit\xE0:",r),!1}})}delete(t){return n(this,null,function*(){try{let{error:e}=yield this.supabaseService.getSupabaseClient().from(this.getTableName()).delete().eq("id",t);if(e)throw e;let a=this.dataSubject.value.filter(s=>s.id!==t);return this.dataSubject.next(a),!0}catch(e){return console.error("Errore eliminazione order item:",e),this.errorSubject.next(e.message),!1}})}updateComandaTotal(t){return n(this,null,function*(){try{let{data:e,error:r}=yield this.supabaseService.getSupabaseClient().from(this.getTableName()).select("total_price").eq("order_id",t);if(r)throw r;let a=(e||[]).reduce((o,d)=>o+(d.total_price||0),0),{error:s}=yield this.supabaseService.getSupabaseClient().from("comande").update({total_amount:a,updated_at:new Date().toISOString()}).eq("id",t);if(s)throw s;return a}catch(e){return console.error("Errore aggiornamento totale comanda:",e),0}})}updateItemStatus(t,e){return n(this,null,function*(){try{let{error:r}=yield this.supabaseService.getSupabaseClient().from(this.getTableName()).update({status:e,updated_at:new Date().toISOString()}).eq("id",t);if(r)throw r;return!0}catch(r){return console.error("Errore aggiornamento stato item:",r),!1}})}updateAllItemsStatus(t,e){return n(this,null,function*(){try{let r=yield this.loadByComandaId(t),a=!0;for(let s of r)(yield this.updateItemStatus(s.id,e))||(a=!1);return a}catch(r){return console.error("Errore aggiornamento stati piatti:",r),!1}})}static \u0275fac=(()=>{let t;return function(r){return(t||(t=p(i)))(r||i)}})();static \u0275prov=l({token:i,factory:i.\u0275fac,providedIn:"root"})};export{f as a,S as b};
