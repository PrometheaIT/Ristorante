import{a as b}from"./chunk-3SRQJDPW.js";import{b as m}from"./chunk-NPOGW2A3.js";import{V as c,_ as h,na as g,t as d}from"./chunk-UNLQURJ5.js";import{a as l,b as u,j as n}from"./chunk-4ZZIO3ZI.js";var f=class s extends b{supabase=h(m);getTableName(){return"menu_dishes"}loadData(t){return n(this,null,function*(){try{this.loadingSubject.next(!0),this.errorSubject.next(null);let e=this.supabase.getSupabaseClient().from(this.getTableName()).select("*");t&&Object.keys(t).forEach(o=>{let i=t[o];i!=null&&(e=e.eq(o,i))});let{data:r,error:a}=yield e;if(a)throw a;this.dataSubject.next(r??[])}catch(e){console.error(`Error loading ${this.getTableName()}:`,e),this.errorSubject.next(e.message??"Errore sconosciuto"),this.dataSubject.next([])}finally{this.loadingSubject.next(!1)}})}create(t){return n(this,null,function*(){this.loadingSubject.next(!0),this.errorSubject.next(null);try{let e=yield this.getCurrentRestaurantId();if(!e)throw new Error("Impossibile ottenere restaurant_id. Utente non autenticato o senza ristorante associato.");let r=new Date().toISOString(),a=u(l({},t),{restaurant_id:e,created_at:r,updated_at:r});console.log("\u{1F4E4} PAYLOAD PER INSERT menu_dishes:"),console.log("- restaurant_id:",a.restaurant_id),console.log("- menu_id:",a.menu_id),console.log("- dish_id:",a.dish_id),console.log("- category_id:",a.category_id),console.log("- display_order:",a.display_order),console.log("- is_active:",a.is_active),console.log("\u{1F4CB} Payload completo:",JSON.stringify(a,null,2));let{data:o,error:i}=yield this.supabase.getSupabaseClient().from(this.getTableName()).insert(a).select().single();if(i)throw console.error("\u274C ERRORE SUPABASE DETTAGLIATO:",i),console.error("\u274C Codice:",i.code),console.error("\u274C Messaggio:",i.message),console.error("\u274C Dettagli:",i.details),console.error("\u274C Hint:",i.hint),i.code==="23505"?(console.error("\u274C VIOLAZIONE VINCOLO UNIQUE: il piatto \xE8 gi\xE0 in questo menu"),new Error("Il piatto \xE8 gi\xE0 presente in questo menu")):i.code==="23503"?(console.error("\u274C VIOLAZIONE FOREIGN KEY: menu_id o dish_id non esistono"),new Error("Menu o piatto non trovato")):i;return console.log("\u2705 INSERT RIUSCITO:",o),yield this.loadData(),o}catch(e){return console.error("\u274C ERRORE COMPLETO durante create:",e),this.errorSubject.next(e.message??"Errore creazione"),null}finally{this.loadingSubject.next(!1)}})}update(t,e){return n(this,null,function*(){this.loadingSubject.next(!0),this.errorSubject.next(null);try{let{error:r}=yield this.supabase.getSupabaseClient().from(this.getTableName()).update(u(l({},e),{updated_at:new Date().toISOString()})).eq("id",t);if(r)throw r;return yield this.loadData(),!0}catch(r){return this.errorSubject.next(r.message??"Errore aggiornamento"),!1}finally{this.loadingSubject.next(!1)}})}delete(t){return n(this,null,function*(){this.loadingSubject.next(!0),this.errorSubject.next(null);try{let{error:e}=yield this.supabase.getSupabaseClient().from(this.getTableName()).delete().eq("id",t);if(e)throw e;return yield this.loadData(),!0}catch(e){return this.errorSubject.next(e.message??"Errore eliminazione"),!1}finally{this.loadingSubject.next(!1)}})}getDishesByMenu$(t){return this.data$.pipe(d(e=>e.filter(r=>r.menu_id===t)))}addDishToMenu(t,e,r,a=0){return n(this,null,function*(){let o;r==null||r.trim()===""?o=void 0:o=r;let i={menu_id:t,dish_id:e,display_order:a,is_active:!0};return o!==void 0&&(i.category_id=o),console.log("\u2795 Aggiungo piatto al menu:",i),this.create(i)})}removeDishFromMenu(t){return n(this,null,function*(){return this.delete(t)})}updateDishOrder(t,e){return n(this,null,function*(){return this.update(t,{display_order:e})})}loadDishesForMenu(t){return n(this,null,function*(){return this.loadData({menu_id:t})})}getDishesWithDetailsByMenu(t){return n(this,null,function*(){try{let{data:e,error:r}=yield this.supabase.getSupabaseClient().from("menu_dishes").select(`
        *,
        dish:dishes!dish_id (*)
      `).eq("menu_id",t).eq("is_active",!0).order("display_order");if(r)throw r;return(e||[]).filter(a=>a.dish&&!a.dish.deleted_at)}catch(e){return console.error("Error fetching dishes for menu:",e),[]}})}removeAllDishesFromMenu(t){return n(this,null,function*(){this.loadingSubject.next(!0),this.errorSubject.next(null);try{let{error:e}=yield this.supabase.getSupabaseClient().from(this.getTableName()).delete().eq("menu_id",t);if(e)throw e;return yield this.loadData(),!0}catch(e){return console.error("\u274C Errore eliminazione piatti dal menu:",e),this.errorSubject.next(e.message??"Errore eliminazione piatti dal menu"),!1}finally{this.loadingSubject.next(!1)}})}static \u0275fac=(()=>{let t;return function(r){return(t||(t=g(s)))(r||s)}})();static \u0275prov=c({token:s,factory:s.\u0275fac,providedIn:"root"})};export{f as a};
