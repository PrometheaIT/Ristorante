import{a as ae}from"./chunk-G6UDCSSI.js";import"./chunk-SY2ZWW6D.js";import{Ab as ne,zb as ie}from"./chunk-N3VPFYDE.js";import{A as te,b as Y,d as Z,i as ee}from"./chunk-45CSFDAZ.js";import{d as X}from"./chunk-TB7INTC7.js";import"./chunk-Q3EITIAW.js";import"./chunk-RC3HHTXM.js";import{p as G,r as H,v as J}from"./chunk-MPTEMNWF.js";import{Eb as B,Fb as A,Gb as q,Ia as k,Ib as s,Jb as I,Kb as b,La as l,Lb as S,Ob as L,Pb as R,Qb as K,Va as U,Vb as C,Wb as h,Xb as Q,_a as m,ca as $,g as z,gb as x,ib as E,la as v,ma as u,mb as _,ob as W,pb as T,qb as n,rb as a,s as P,sb as w,t as j,vb as f,yb as p,zb as c}from"./chunk-5BU4UD4M.js";import{a as N,b as D,g as O}from"./chunk-RA2WU32H.js";var re=["scrollContainer"],V=(t,i)=>i.id;function se(t,i){t&1&&(n(0,"span",6),s(1,"group"),a())}function ce(t,i){if(t&1&&w(0,"img",23),t&2){let e=c(2).$implicit;x("src",e.other_participant.avatar_url,k)}}function le(t,i){t&1&&(n(0,"span",6),s(1,"person"),a())}function de(t,i){if(t&1&&m(0,ce,1,1,"img",23)(1,le,2,0,"span",6),t&2){let e=c().$implicit;_(e.other_participant!=null&&e.other_participant.avatar_url?0:1)}}function me(t,i){if(t&1&&s(0),t&2){let e=c().$implicit;b(" ",e.name||"Gruppo"," ")}}function _e(t,i){if(t&1&&s(0),t&2){let e=c().$implicit;S(" ",e.other_participant==null?null:e.other_participant.first_name," ",e.other_participant==null?null:e.other_participant.last_name," ")}}function pe(t,i){if(t&1&&(n(0,"span",21),s(1),a()),t&2){let e=c().$implicit;l(),I(e.unread)}}function ve(t,i){if(t&1){let e=f();n(0,"div",16),C(1,"async"),p("click",function(){let r=v(e).$implicit,d=c();return u(d.selectConversation(r))}),n(2,"div",17),m(3,se,2,0,"span",6)(4,de,2,1),a(),n(5,"div",18)(6,"div",19)(7,"div",20),m(8,me,1,1)(9,_e,1,2),a(),m(10,pe,2,1,"span",21),a(),n(11,"div",22),s(12),a()()()}if(t&2){let e,o=i.$implicit,r=c();E("active",((e=h(1,6,r.activeConversation$))==null?null:e.id)===o.id),l(3),_(o.type==="group"?3:4),l(5),_(o.type==="group"?8:9),l(2),_(o.unread>0?10:-1),l(2),b(" ",(o.last_message==null?null:o.last_message.content)||"Nessun messaggio"," ")}}function ue(t,i){t&1&&(n(0,"div",9),s(1," Nessuna conversazione "),a())}function Ce(t,i){t&1&&(n(0,"span",6),s(1,"group"),a())}function he(t,i){if(t&1&&w(0,"img",23),t&2){let e=c(2);x("src",e.other_participant.avatar_url,k)}}function fe(t,i){t&1&&(n(0,"span",6),s(1,"person"),a())}function ge(t,i){if(t&1&&m(0,he,1,1,"img",23)(1,fe,2,0,"span",6),t&2){let e=c();_(e.other_participant!=null&&e.other_participant.avatar_url?0:1)}}function xe(t,i){if(t&1&&s(0),t&2){let e=c();b(" ",e.name||"Gruppo"," ")}}function we(t,i){if(t&1&&s(0),t&2){let e=c(2);S(" ",e.other_participant.first_name," ",e.other_participant.last_name," ")}}function be(t,i){t&1&&(n(0,"span",32),s(1,"Caricamento..."),a())}function Se(t,i){if(t&1&&m(0,we,1,2)(1,be,2,0,"span",32),t&2){let e=c();_(e.other_participant?0:1)}}function Me(t,i){if(t&1){let e=f();n(0,"div",37)(1,"button",38),p("click",function(){v(e);let r=c().$implicit,d=c(2);return u(d.editMessage(r))}),n(2,"span",6),s(3,"edit"),a()(),n(4,"button",39),p("click",function(){v(e);let r=c().$implicit,d=c(2);return u(d.deleteMessage(r.id))}),n(5,"span",6),s(6,"delete"),a()()()}}function ye(t,i){if(t&1&&(n(0,"div",33)(1,"div",34),s(2),a(),n(3,"div",35),s(4),a(),n(5,"div",36),s(6),C(7,"date"),a(),m(8,Me,7,0,"div",37),a()),t&2){let e=i.$implicit,o=c(2);E("own-message",e.sender_id===o.currentUserId),l(2),S(" ",e.sender==null?null:e.sender.first_name," ",e.sender==null?null:e.sender.last_name," "),l(2),I(e.content),l(2),b(" ",Q(7,7,e.created_at,"short")," "),l(2),_(e.sender_id===o.currentUserId&&o.canEditOrDelete(e)?8:-1)}}function ke(t,i){t&1&&(n(0,"div",28),s(1," Nessun messaggio. Inizia a scrivere! "),a())}function Ee(t,i){if(t&1){let e=f();n(0,"div",13)(1,"div",24)(2,"div",17),m(3,Ce,2,0,"span",6)(4,ge,2,1),a(),n(5,"span",25),m(6,xe,1,1)(7,Se,2,1),a()(),n(8,"div",26,0),W(10,ye,9,10,"div",27,V,!1,ke,2,0,"div",28),C(13,"async"),a(),n(14,"div",29)(15,"textarea",30),K("ngModelChange",function(r){v(e);let d=c();return R(d.newMessage,r)||(d.newMessage=r),u(r)}),p("keydown.enter",function(r){v(e);let d=c();return u(d.onKeydown(r))}),a(),n(16,"button",31),p("click",function(){v(e);let r=c();return u(r.sendMessage())}),n(17,"span",6),s(18,"send"),a()()()()}if(t&2){let e=i,o=c();l(3),_(e.type==="group"?3:4),l(3),_(e.type==="group"?6:7),l(4),T(h(13,5,o.messages$)),l(5),L("ngModel",o.newMessage),l(),x("disabled",!o.newMessage.trim())}}function We(t,i){t&1&&(n(0,"div",14)(1,"div",40)(2,"span",41),s(3,"chat"),a(),n(4,"p"),s(5,"Seleziona una conversazione per iniziare"),a()()())}function Te(t,i){if(t&1&&w(0,"img",23),t&2){let e=c().$implicit;x("src",e.avatar_url,k)}}function Oe(t,i){t&1&&(n(0,"span",6),s(1,"person"),a())}function Pe(t,i){if(t&1){let e=f();n(0,"div",51),p("click",function(){let r=v(e).$implicit,d=c(2);return u(d.startDirectChat(r.id))}),n(1,"div",52),m(2,Te,1,1,"img",23)(3,Oe,2,0,"span",6),a(),n(4,"span"),s(5),a()()}if(t&2){let e=i.$implicit;l(2),_(e.avatar_url?2:3),l(3),S("",e.first_name," ",e.last_name,"")}}function $e(t,i){t&1&&(n(0,"p",32),s(1,"Nessun altro membro disponibile"),a())}function Ie(t,i){if(t&1){let e=f();n(0,"div",42),p("click",function(){v(e);let r=c();return u(r.closeNewChatModal())}),n(1,"div",43),p("click",function(r){return v(e),u(r.stopPropagation())}),n(2,"div",44)(3,"h3",45),s(4,"Nuova chat"),a(),n(5,"button",46),p("click",function(){v(e);let r=c();return u(r.closeNewChatModal())}),n(6,"span",6),s(7,"close"),a()()(),n(8,"div",47)(9,"p",48),s(10,"Scegli un membro del team:"),a(),n(11,"div",49),W(12,Pe,6,3,"div",50,V,!1,$e,2,0,"p",32),C(15,"async"),a()()()()}if(t&2){let e=c();l(12),T(h(15,1,e.staffContacts$))}}var oe=class t{chatService=$(ae);authService=$(X);staffContactsSubject=new z([]);isCreating=!1;staffContacts$=this.staffContactsSubject.asObservable();conversations$=this.chatService.conversations$;activeConversation$=this.chatService.activeConversation$;messages$=this.chatService.messages$;loading$=this.chatService.loading$;conversationsWithUnread$=j([this.conversations$,this.chatService.unreadCount$]).pipe(P(([i,e])=>i.map(o=>D(N({},o),{unread:e.get(o.id)||0}))));currentUserId=this.authService.currentUserValue?.id;newMessage="";scrollContainer;showNewChatModal=!1;staffList=[];ngOnInit(){this.chatService.loadConversations(),this.loadStaffContacts(),this.authService.activeRestaurantId$.subscribe(()=>{this.loadStaffContacts()}),this.messages$.subscribe(()=>{setTimeout(()=>this.scrollToBottom(),100)})}loadStaffContacts(){return O(this,null,function*(){let i=this.authService.getCurrentRestaurantId(),e=this.authService.currentUserValue?.id;if(console.log("\u{1F50D} loadStaffContacts - chiamato con:",{restaurantId:i,currentUserId:e}),!i||!e)return;let{data:o}=yield this.chatService.supabase.getSupabaseClient().from("restaurants").select("owner_id").eq("id",i).single(),r=o?.owner_id,{data:d,error:F}=yield this.chatService.supabase.getSupabaseClient().from("restaurant_staff").select(`
      user_id,
      users:user_id (
        id,
        first_name,
        last_name,
        avatar_url
      )
    `).eq("restaurant_id",i).eq("invitation_status","accepted").neq("user_id",e);F&&console.error("\u274C Errore nel recuperare lo staff:",F);let M=(d||[]).map(g=>g.users).filter(g=>g&&g.id);if(r&&r!==e&&!M.some(y=>y.id===r)){let{data:y}=yield this.chatService.supabase.getSupabaseClient().from("users").select("id, first_name, last_name, avatar_url").eq("id",r).single();y&&M.push(y)}console.log("\u2705 Contatti finali:",M),this.staffContactsSubject.next(M)})}onSelectItem(i){return O(this,null,function*(){if(!this.isCreating)if(i.type==="conversation")this.chatService.setActiveConversation(i.data);else{this.isCreating=!0;try{let e=yield this.chatService.createDirectConversation(i.data.id);e&&this.chatService.setActiveConversation(e)}finally{this.isCreating=!1}}})}ngOnDestroy(){this.chatService.setActiveConversation(null)}selectConversation(i){this.chatService.setActiveConversation(i)}sendMessage(){let i=this.chatService.activeConversationSubject.value;!i||!this.newMessage.trim()||(this.chatService.sendMessage(i.id,this.newMessage),this.newMessage="")}doSendMessage(){let i=this.chatService.activeConversationSubject.value;!i||!this.newMessage.trim()||(this.chatService.sendMessage(i.id,this.newMessage),this.newMessage="")}editMessage(i){let e=prompt("Modifica messaggio",i.content);e&&e!==i.content&&this.chatService.updateMessage(i.id,e)}deleteMessage(i){confirm("Eliminare questo messaggio?")&&this.chatService.deleteMessage(i)}canEditOrDelete(i){let e=new Date(Date.now()-144e5);return new Date(i.created_at)>e}scrollToBottom(){try{this.scrollContainer.nativeElement.scrollTop=this.scrollContainer.nativeElement.scrollHeight}catch{}}openNewChatModal(){this.showNewChatModal=!0}closeNewChatModal(){this.showNewChatModal=!1}startDirectChat(i){this.chatService.createDirectConversation(i).then(()=>{this.closeNewChatModal()})}onKeydown(i){let e=i;e.key==="Enter"&&!e.shiftKey&&(e.preventDefault(),this.sendMessage())}conversationItems$=this.conversations$.pipe(P(i=>i.map(e=>({type:"conversation",data:e}))));static \u0275fac=function(e){return new(e||t)};static \u0275cmp=U({type:t,selectors:[["app-chat-window"]],viewQuery:function(e,o){if(e&1&&B(re,5),e&2){let r;A(r=q())&&(o.scrollContainer=r.first)}},decls:22,vars:11,consts:[["scrollContainer",""],[1,"chat-container"],[1,"conversations-sidebar","card","p-sm"],[1,"sidebar-header","flex","justify-between","items-center","p-sm"],[1,"text-md","font-bold","m-0"],["title","Nuova chat",1,"icon-button",3,"click"],[1,"material-icons"],[1,"conversations-list"],[1,"conversation-item","flex","items-center","gap-sm","p-sm","rounded",3,"active"],[1,"no-convs","text-center","text-muted","p-lg"],[1,"new-chat-button","p-sm"],[1,"promethea-button","full-width",3,"click"],["name","plus","size","24"],[1,"chat-main","card","flex-col"],[1,"chat-placeholder","flex","items-center","justify-center"],[1,"modal-overlay"],[1,"conversation-item","flex","items-center","gap-sm","p-sm","rounded",3,"click"],[1,"conv-avatar","avatartondo","flex","items-center","justify-center"],[1,"conv-info","flex-1","min-w-0"],[1,"flex","items-center","gap-sm"],[1,"conv-name","font-semibold","text-interrupt"],[1,"chip","warning"],[1,"conv-last-msg","text-mini","text-muted","text-interrupt"],["alt","avatar",1,"avatar-img",3,"src"],[1,"chat-header","flex","items-center","gap-sm","p-sm","border-bottom"],[1,"chat-title","font-bold"],[1,"messages-container"],[1,"message",3,"own-message"],[1,"no-messages","text-center","text-muted","p-lg"],[1,"message-input","flex","gap-sm","p-sm"],["placeholder","Scrivi un messaggio...","rows","1",1,"flex-1",3,"ngModelChange","keydown.enter","ngModel"],[1,"promethea-button",3,"click","disabled"],[1,"text-muted"],[1,"message"],[1,"message-sender","text-mini","font-semibold"],[1,"message-content"],[1,"message-time","text-mini","text-muted"],[1,"message-actions","flex","gap-sm"],["title","Modifica",1,"icon-button","x-small",3,"click"],["title","Elimina",1,"icon-button","x-small",3,"click"],[1,"text-center","text-muted"],[1,"material-icons",2,"font-size","48px"],[1,"modal-overlay",3,"click"],[1,"modal-container","modal-sm",3,"click"],[1,"modal-header"],[1,"text-md","font-bold"],[1,"icon-button",3,"click"],[1,"modal-content","p-md"],[1,"text-muted","mb-sm"],[1,"staff-list"],[1,"staff-item","flex","items-center","gap-sm","p-sm","rounded","hover-bg"],[1,"staff-item","flex","items-center","gap-sm","p-sm","rounded","hover-bg",3,"click"],[1,"avatartondo","small"]],template:function(e,o){if(e&1&&(n(0,"div",1)(1,"div",2),C(2,"async"),n(3,"div",3)(4,"h3",4),s(5,"Chat"),a(),n(6,"button",5),p("click",function(){return o.openNewChatModal()}),n(7,"span",6),s(8,"add"),a()()(),n(9,"div",7),W(10,ve,13,8,"div",8,V,!1,ue,2,0,"div",9),C(13,"async"),a(),n(14,"div",10)(15,"button",11),p("click",function(){return o.openNewChatModal()}),w(16,"lucide-angular",12),s(17," Nuova chat "),a()()(),m(18,Ee,19,7,"div",13),C(19,"async"),m(20,We,6,0,"div",14),a(),m(21,Ie,16,3,"div",15)),e&2){let r;l(),E("loading",h(2,5,o.loading$)),l(9),T(h(13,7,o.conversationsWithUnread$)),l(8),_((r=h(19,9,o.activeConversation$))?18:20,r),l(3),_(o.showNewChatModal?21:-1)}},dependencies:[J,G,H,te,Y,Z,ee,ne,ie],styles:[".chat-container[_ngcontent-%COMP%]{display:flex;height:calc(100vh - var(--sidebar--collapsed-width) - 2px);gap:var(--gap-md);padding:var(--gap-md);background:var(--background)}.conversations-sidebar[_ngcontent-%COMP%]{width:300px;display:flex;flex-direction:column;overflow:hidden;padding:0!important;height:100%}.conversations-sidebar.loading[_ngcontent-%COMP%]{opacity:.7;pointer-events:none}.sidebar-header[_ngcontent-%COMP%]{border-bottom:1px solid var(--smoke-1)}.conversations-list[_ngcontent-%COMP%]{flex:1;overflow-y:auto;padding:var(--gap-sm)}.conversation-item[_ngcontent-%COMP%]{cursor:pointer;transition:background .2s;border-radius:8px}.conversation-item[_ngcontent-%COMP%]:hover{background:var(--smoke-1)}.conversation-item.active[_ngcontent-%COMP%]{background:var(--smoke-2);border-left:4px solid var(--primary)}.conv-avatar[_ngcontent-%COMP%]{width:40px;height:40px;flex-shrink:0;font-size:20px}.avatar-img[_ngcontent-%COMP%]{width:100%;height:100%;border-radius:50%;object-fit:cover}.conv-info[_ngcontent-%COMP%]{min-width:0}.chat-main[_ngcontent-%COMP%]{flex:1;display:flex;flex-direction:column;overflow:hidden;padding:0!important}.chat-header[_ngcontent-%COMP%]{padding:var(--gap-sm);border-bottom:1px solid var(--smoke-1)}.messages-container[_ngcontent-%COMP%]{flex:1;overflow-y:auto;padding:var(--gap-md);display:flex;flex-direction:column;gap:var(--gap-sm)}.message[_ngcontent-%COMP%]{max-width:70%;padding:var(--gap-sm);border-radius:18px;background:var(--smoke-1);align-self:flex-start;position:relative;word-break:break-word}.message.own-message[_ngcontent-%COMP%]{background:var(--primary);color:#fff;align-self:flex-end}.message.own-message[_ngcontent-%COMP%]   .message-time[_ngcontent-%COMP%]{color:#fffc}.message-sender[_ngcontent-%COMP%]{margin-bottom:4px}.message-content[_ngcontent-%COMP%]{margin-bottom:4px;line-height:1.4}.message-time[_ngcontent-%COMP%]{font-size:.7rem;text-align:right}.message-actions[_ngcontent-%COMP%]{position:absolute;top:4px;right:4px;opacity:0;transition:opacity .2s}.message[_ngcontent-%COMP%]:hover   .message-actions[_ngcontent-%COMP%]{opacity:1}.message-input[_ngcontent-%COMP%]{border-top:1px solid var(--smoke-1);background:var(--background)}.message-input[_ngcontent-%COMP%]   textarea[_ngcontent-%COMP%]{resize:none;min-height:40px;max-height:120px;border-radius:20px;padding:var(--gap-sm) var(--gap-md)}.chat-placeholder[_ngcontent-%COMP%]{flex:1;display:flex;align-items:center;justify-content:center;background:var(--background);border-radius:12px}.staff-item[_ngcontent-%COMP%]{cursor:pointer;border-radius:8px;transition:background .2s}.staff-item[_ngcontent-%COMP%]:hover{background:var(--smoke-1)}@media (max-width: 768px){.chat-container[_ngcontent-%COMP%]{flex-direction:column;height:auto;min-height:calc(100vh - var(--sidebar--collapsed-width))}.conversations-sidebar[_ngcontent-%COMP%]{width:100%;max-height:300px}.message[_ngcontent-%COMP%]{max-width:85%}}"]})};export{oe as ChatWindow};
