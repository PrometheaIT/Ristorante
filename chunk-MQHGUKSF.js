import{a as b}from"./chunk-VOCUDH6H.js";import{_ as c,a as l,g as s,sa as u}from"./chunk-3SWAHN2Y.js";var d=class n extends b{getTableName(){return"tables"}loadData(){return s(this,null,function*(){try{let e=yield this.getCurrentRestaurantId();if(!e)return;let{data:a,error:r}=yield this.supabaseService.getSupabaseClient().from(this.getTableName()).select("*").eq("restaurant_id",e).eq("is_active",!0).order("created_at",{ascending:!1});if(r)throw r;this.dataSubject.next(a||[])}catch(e){console.error(`Error loading ${this.getTableName()}:`,e),this.errorSubject.next(e.message),this.dataSubject.next([])}})}getTables(){return this.dataSubject.value}getTablesByFloorPlan(e){return this.dataSubject.value.filter(a=>a.floor_plan_id===e)}createTable(e){return s(this,null,function*(){try{console.log("\u{1F4DD} Creating table with shape:",e.shape);let{data:a,error:r}=yield this.supabaseService.getSupabaseClient().from("tables").insert(e).select().single();if(r)throw console.error("\u274C Error creating table:",r),console.error("\u274C Error details:",r.details),r;return console.log("\u2705 Table created successfully"),yield this.loadData(),a}catch(a){return console.error("\u{1F4A5} Error in createTable:",a),null}})}updateTable(e,a){return s(this,null,function*(){try{console.log(`\u{1F4BE} updateTable for table ${e}:`,a);let r=this.dataSubject.value,t=r.map(i=>i.id===e?l(l({},i),a):i);this.dataSubject.next(t);let{error:o}=yield this.supabaseService.getSupabaseClient().from("tables").update(a).eq("id",e);if(o)throw console.error("\u274C Database error updating table:",o),this.dataSubject.next(r),o;return console.log(`\u2705 Table ${e} updated successfully`),!0}catch(r){return console.error("\u274C Error updating table:",r),yield this.loadData(),!1}})}deleteTable(e){return s(this,null,function*(){try{let{error:a}=yield this.supabaseService.getSupabaseClient().from("tables").update({is_active:!1}).eq("id",e);if(a)throw a;return yield this.loadData(),!0}catch(a){return console.error("\u274C Error deleting table:",a),!1}})}checkTableOverlap(e,a){let r=this.getTablesByFloorPlan(e.floor_plan_id),t=Array.isArray(a)?a:a?[a]:[];for(let o of r){if(t.includes(o.id))continue;if(this.doTablesOverlap(e,o))return!0}return!1}doTablesOverlap(e,a){return!(e.position_x+e.width<=a.position_x||e.position_x>=a.position_x+a.width||e.position_y+e.height<=a.position_y||e.position_y>=a.position_y+a.height)}updateTableOnlineBookable(e,a){return s(this,null,function*(){try{let{error:r}=yield this.supabaseService.getSupabaseClient().from("tables").update({is_online_bookable:a}).eq("id",e);if(r)throw r;return yield this.loadData(),!0}catch(r){return console.error("\u274C Error updating table online bookable status:",r),!1}})}getTablesAvailableForOnlineBooking(e){return this.getTablesByFloorPlan(e).filter(a=>a.is_online_bookable&&!a.is_merged&&a.is_active)}getVisibleTablesByFloorPlan(e){let a=this.getTablesByFloorPlan(e),r=a.filter(t=>!t.is_merged||t.parent_table_id===null);return console.log("\u{1F50D} DEBUG getVisibleTablesByFloorPlan:",{floorPlanId:e,allTablesCount:a.length,visibleTablesCount:r.length,allTables:a,visibleTables:r}),r}getTableStyle(e){let a;e.border_radius!==void 0&&e.border_radius!==null?a=e.border_radius===50?"50%":`${e.border_radius}px`:a=e.shape==="circle"?"50%":"8px";let r=e.rotation||0,t={left:e.position_x+"px",top:e.position_y+"px",width:e.width+"px",height:e.height+"px","border-radius":a,transform:`rotate(${r}deg)`};return r!==0&&console.log(`\u{1F3A8} Tavolo ${e.table_number}: applicata rotazione di ${r}\xB0`),e.is_merged&&(t.border="3px dashed #ff6b35",t.background="rgba(255, 107, 53, 0.1)"),e.is_online_bookable||(t.background="repeating-linear-gradient(45deg, var(--shadow-1), var(--shadow-2) 10px, var(--shadow-3) 10px, var(--shadow-1) 20px)"),t}getTableClass(e,a,r,t){let o=["table-element",`shape-${e.shape}`];return a?.id===e.id&&o.push("selected"),r.some(i=>i.id===e.id)&&o.push("merge-selected"),e.is_merged&&e.parent_table_id?o.push("merged-child","hidden-table"):e.merged_tables_ids&&e.merged_tables_ids.length>0&&o.push("merged-parent"),e.is_online_bookable||o.push("not-online-bookable"),o.join(" ")}generateNextTableNumber(e){let a=e.map(r=>parseInt(r.table_number)).filter(r=>!isNaN(r));return a.length>0?Math.max(...a)+1:1}rotateTable(e,a){return s(this,null,function*(){try{let r=(a%360+360)%360;console.log(`\u{1F504} Rotating table ${e} to ${r}\xB0`);let{error:t}=yield this.supabaseService.getSupabaseClient().from("tables").update({rotation:r,updated_at:new Date().toISOString()}).eq("id",e);return t?(console.error("\u274C Database error rotating table:",t),!1):(console.log(`\u2705 Table ${e} rotated successfully to ${r}\xB0`),!0)}catch(r){return console.error("\u274C Error rotating table:",r),!1}})}getAllTablesByFloorPlan(e){return this.dataSubject.value.filter(a=>a.floor_plan_id===e)}calculateMaxCapacity(e){return!e||e.length===0?0:e.reduce((a,r)=>a+(r.capacity||0),0)}getCapacityByTableType(e){let a={};return e.forEach(r=>{let t=r.capacity||0;a[t]=(a[t]||0)+1}),a}getTableStats(e){let a=e.length,r=this.calculateMaxCapacity(e),t=e.filter(i=>i.is_online_bookable).length,o=a>0?Math.round(r/a):0;return{totalTables:a,maxCapacity:r,availableForOnline:t,averageCapacity:o}}static \u0275fac=(()=>{let e;return function(r){return(e||(e=u(n)))(r||n)}})();static \u0275prov=c({token:n,factory:n.\u0275fac,providedIn:"root"})};export{d as a};
