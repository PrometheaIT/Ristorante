import{a as b}from"./chunk-CXV4BLDF.js";import{w as f}from"./chunk-L5SOXNIK.js";import{F as u,L as d,_ as p,a as h,b as S,da as l,f as o,m as c}from"./chunk-KZSY5CHT.js";var m=class i{supabaseService=l(f);authService=l(b);floorPlansSubject=new c([]);floorPlans$=this.floorPlansSubject.asObservable();tableShapes=[{id:"rect",name:"Rettangolare",type:"rectangle",default_width:120,default_height:80,icon:"rectangle"},{id:"circle",name:"Rotondo",type:"circle",default_width:100,default_height:100,icon:"circle"},{id:"square",name:"Quadrato",type:"square",default_width:100,default_height:100,icon:"square"}];constructor(){this.authService.currentUser$.pipe(u(r=>!!r),d(1)).subscribe(()=>{this.loadFloorPlans()})}loadFloorPlans(){return o(this,null,function*(){try{let r=this.authService.currentUserValue;if(!r)return;let{data:e,error:t}=yield this.supabaseService.getSupabaseClient().from("restaurants").select("id").eq("owner_id",r.id).limit(1);if(t||!e?.length){console.error("\u274C No restaurant found for user:",r.id);return}let a=e[0].id,{data:n,error:s}=yield this.supabaseService.getSupabaseClient().from("restaurant_floor_plans").select("*").eq("restaurant_id",a).order("created_at",{ascending:!1});if(s){console.error("\u274C Error loading floor plans:",s),s.code==="42P01"&&(yield this.createDefaultFloorPlanForRestaurant(a));return}this.floorPlansSubject.next(n||[])}catch(r){console.error("\u{1F4A5} Error in loadFloorPlans:",r)}})}createDefaultFloorPlanForRestaurant(r){return o(this,null,function*(){try{let e={restaurant_id:r,name:"Mappa Principale",width:1e3,height:800,is_active:!0,created_at:new Date().toISOString(),updated_at:new Date().toISOString()},{data:t,error:a}=yield this.supabaseService.getSupabaseClient().from("restaurant_floor_plans").insert(e).select().single();if(a)throw a;this.floorPlansSubject.next([t])}catch(e){console.error("\u{1F4A5} Error creating default floor plan:",e)}})}getTableShapes(){return this.tableShapes}getTableShapeById(r){return this.tableShapes.find(e=>e.id===r)}createFloorPlan(r){return o(this,null,function*(){try{let e=this.authService.currentUserValue;if(!e)return null;let{data:t,error:a}=yield this.supabaseService.getSupabaseClient().from("restaurants").select("id").eq("owner_id",e.id).limit(1);if(a||!t?.length)return null;let n=t[0].id,s=S(h({},r),{restaurant_id:n,created_at:new Date().toISOString(),updated_at:new Date().toISOString()}),{data:_,error:g}=yield this.supabaseService.getSupabaseClient().from("restaurant_floor_plans").insert(s).select().single();if(g)throw g;return yield this.loadFloorPlans(),_}catch(e){return console.error("\u{1F4A5} Error in createFloorPlan:",e),null}})}updateFloorPlan(r,e){return o(this,null,function*(){try{let t=S(h({},e),{updated_at:new Date().toISOString()}),{error:a}=yield this.supabaseService.getSupabaseClient().from("restaurant_floor_plans").update(t).eq("id",r);if(a)throw a;return yield this.loadFloorPlans(),!0}catch(t){return console.error("\u274C Error updating floor plan:",t),!1}})}deleteFloorPlan(r){return o(this,null,function*(){try{yield this.supabaseService.getSupabaseClient().from("tables").update({floor_plan_id:null}).eq("floor_plan_id",r);let{error:e}=yield this.supabaseService.getSupabaseClient().from("restaurant_floor_plans").delete().eq("id",r);if(e)throw e;return yield this.loadFloorPlans(),!0}catch(e){return console.error("\u274C Error deleting floor plan:",e),!1}})}getFloorPlans(){return this.floorPlansSubject.value}static \u0275fac=function(e){return new(e||i)};static \u0275prov=p({token:i,factory:i.\u0275fac,providedIn:"root"})};var v=class i{supabaseService=l(f);authService=l(b);tablesSubject=new c([]);tables$=this.tablesSubject.asObservable();constructor(){this.authService.currentUser$.pipe(u(r=>!!r),d(1)).subscribe(()=>{this.loadTables()})}loadTables(){return o(this,null,function*(){try{let r=this.authService.currentUserValue;if(!r)return;let{data:e,error:t}=yield this.supabaseService.getSupabaseClient().from("restaurants").select("id").eq("owner_id",r.id).limit(1);if(t||!e?.length){console.error("\u274C No restaurant found for user:",r.id);return}let a=e[0].id,{data:n,error:s}=yield this.supabaseService.getSupabaseClient().from("tables").select("*").eq("restaurant_id",a).eq("is_active",!0).order("created_at",{ascending:!1});if(s){console.error("\u274C Error loading tables:",s);return}this.tablesSubject.next(n||[])}catch(r){console.error("\u{1F4A5} Error in loadTables:",r)}})}createTable(r){return o(this,null,function*(){try{console.log("\u{1F4DD} Creating table with shape:",r.shape);let{data:e,error:t}=yield this.supabaseService.getSupabaseClient().from("tables").insert(r).select().single();if(t)throw console.error("\u274C Error creating table:",t),console.error("\u274C Error details:",t.details),t;return console.log("\u2705 Table created successfully"),yield this.loadTables(),e}catch(e){return console.error("\u{1F4A5} Error in createTable:",e),null}})}updateTable(r,e){return o(this,null,function*(){try{let{error:t}=yield this.supabaseService.getSupabaseClient().from("tables").update(e).eq("id",r);if(t)throw t;return yield this.loadTables(),!0}catch(t){return console.error("\u274C Error updating table:",t),!1}})}deleteTable(r){return o(this,null,function*(){try{let{error:e}=yield this.supabaseService.getSupabaseClient().from("tables").update({is_active:!1}).eq("id",r);if(e)throw e;return yield this.loadTables(),!0}catch(e){return console.error("\u274C Error deleting table:",e),!1}})}getTables(){return this.tablesSubject.value}getTablesByFloorPlan(r){return this.tablesSubject.value.filter(e=>e.floor_plan_id===r)}checkTableOverlap(r,e){let t=this.getTablesByFloorPlan(r.floor_plan_id).filter(a=>a.id!==e);for(let a of t)if(this.doTablesOverlap(r,a))return!0;return!1}doTablesOverlap(r,e){return!(r.position_x+r.width<=e.position_x||r.position_x>=e.position_x+e.width||r.position_y+r.height<=e.position_y||r.position_y>=e.position_y+e.height)}static \u0275fac=function(e){return new(e||i)};static \u0275prov=p({token:i,factory:i.\u0275fac,providedIn:"root"})};export{m as a,v as b};
