import{a as g}from"./chunk-MVDMN4LR.js";import{V as m,na as l}from"./chunk-QECS2EDN.js";import{a as p,b,j as o}from"./chunk-4ZZIO3ZI.js";var f=class n extends g{getTableName(){return"comande"}hasRestaurantId(){return!0}createForOrderHeader(t,r){return o(this,null,function*(){try{if(t.startsWith("draft-"))return console.error("\u274C Tentativo di creare comanda per order header draft:",t),console.log("\u26A0\uFE0F Questa operazione dovrebbe essere gestita in locale fino al salvataggio"),null;let e=yield this.getCurrentRestaurantId();if(!e)return console.error("\u274C Nessun restaurantId"),null;let{data:a,error:s}=yield this.supabaseService.getSupabaseClient().from("order_headers").select("*").eq("id",t).single();if(s)return console.error("\u274C Errore recupero order header:",s),null;if(!a)return console.error("\u274C Order header non trovato"),null;let i=r||(yield this.getNextComandaNumber(t)),d={order_number:`CMD-${a.order_number}-${i}`,restaurant_id:e,order_header_id:t,tavolata_id:t,comanda_number:i,table_id:a.table_id,customer_name:a.customer_name||"Cliente",customer_phone:a.customer_phone||"",status:"ordered",subtotal:0,tax_amount:0,discount_amount:0,total_amount:0,customer_notes:"",order_type:"dine_in"};console.log("\u{1F4E4} Creazione comanda nel database:",d);let{data:c,error:u}=yield this.supabaseService.getSupabaseClient().from(this.getTableName()).insert(d).select().single();return u?(console.error("\u274C Errore creazione comanda:",u),null):(console.log("\u2705 Comanda creata con successo:",c.id),c)}catch(e){return console.error("\u{1F4A5} ERRORE createForOrderHeader:",e),null}})}getNextComandaNumber(t){return o(this,null,function*(){try{if(t.startsWith("draft-"))return 1;let{data:r,error:e}=yield this.supabaseService.getSupabaseClient().from(this.getTableName()).select("comanda_number").eq("order_header_id",t).order("comanda_number",{ascending:!1}).limit(1);if(e)throw e;return r&&r.length>0?r[0].comanda_number+1:1}catch(r){return console.error("Errore calcolo prossima comanda:",r),1}})}loadByOrderHeaderId(t){return o(this,null,function*(){try{if(t.startsWith("draft-"))return console.log("\u26A0\uFE0F Tentativo di caricare comande per draft order header"),[];let{data:r,error:e}=yield this.supabaseService.getSupabaseClient().from(this.getTableName()).select("*").eq("order_header_id",t).order("comanda_number",{ascending:!0});if(e)throw e;return r||[]}catch(r){return console.error("Errore caricamento comande:",r),[]}})}updateStatus(t,r){return o(this,null,function*(){try{let{error:e}=yield this.supabaseService.getSupabaseClient().from(this.getTableName()).update({status:r,updated_at:new Date().toISOString()}).eq("id",t);return!e}catch(e){return console.error("Errore aggiornamento stato comanda:",e),!1}})}static \u0275fac=(()=>{let t;return function(e){return(t||(t=l(n)))(e||n)}})();static \u0275prov=m({token:n,factory:n.\u0275fac,providedIn:"root"})};var _=class n extends g{getTableName(){return"order_items"}hasRestaurantId(){return!0}addItemToComanda(t,r,e=1,a,s=""){return o(this,null,function*(){try{console.log("\u{1F504} OrderItemService.addItemToComanda chiamato",{comandaId:t,dishId:r,quantity:e,unitPrice:a});let i=yield this.getCurrentRestaurantId();if(!i)return console.error("\u274C Nessun restaurantId"),null;let h={order_id:t,dish_id:r,quantity:e,unit_price:a,item_notes:s||"",status:"ordered",restaurant_id:i};console.log("\u{1F4E4} Insert order item con dati (senza total_price):",h);let{data:d,error:c}=yield this.supabaseService.getSupabaseClient().from(this.getTableName()).insert(h).select().single();if(c)return console.error("\u274C ERRORE INSERT:",{message:c.message,details:c.details,hint:c.hint,code:c.code}),null;console.log("\u2705 Order item inserito:",d);let u=yield this.getDishName(r);return b(p({},d),{dish_name:u,comanda_id:d.order_id,total_price:a*e})}catch(i){return console.error("\u{1F4A5} Errore critico:",i),null}})}getDishName(t){return o(this,null,function*(){try{let{data:r,error:e}=yield this.supabaseService.getSupabaseClient().from("dishes").select("name").eq("id",t).single();return e||!r?(console.warn("\u26A0\uFE0F Impossibile recuperare nome piatto:",e),"Piatto"):r.name}catch(r){return console.error("Errore recupero nome piatto:",r),"Piatto"}})}loadByComandaId(t){return o(this,null,function*(){try{let{data:r,error:e}=yield this.supabaseService.getSupabaseClient().from("order_items").select(`
          *,
          dish:dish_id(name)
        `).eq("order_id",t).order("created_at",{ascending:!0});if(e)throw e;return(r||[]).map(a=>b(p({},a),{dish_name:a.dish?.name||"Piatto",comanda_id:a.order_id}))}catch(r){return console.error("Errore caricamento order_items:",r),[]}})}updateQuantity(t,r){return o(this,null,function*(){try{let{error:e}=yield this.supabaseService.getSupabaseClient().from(this.getTableName()).update({quantity:r,updated_at:new Date().toISOString()}).eq("id",t);if(e)throw e;return!0}catch(e){return console.error("Errore aggiornamento quantit\xE0:",e),!1}})}delete(t){return o(this,null,function*(){try{let{error:r}=yield this.supabaseService.getSupabaseClient().from(this.getTableName()).delete().eq("id",t);if(r)throw r;let a=this.dataSubject.value.filter(s=>s.id!==t);return this.dataSubject.next(a),!0}catch(r){return console.error("Errore eliminazione order item:",r),this.errorSubject.next(r.message),!1}})}updateItemStatus(t,r){return o(this,null,function*(){try{let{error:e}=yield this.supabaseService.getSupabaseClient().from(this.getTableName()).update({status:r,updated_at:new Date().toISOString()}).eq("id",t);if(e)throw e;return!0}catch(e){return console.error("Errore aggiornamento stato item:",e),!1}})}updateAllItemsStatus(t,r){return o(this,null,function*(){try{let e=yield this.loadByComandaId(t),a=!0;for(let s of e)(yield this.updateItemStatus(s.id,r))||(a=!1);return a}catch(e){return console.error("Errore aggiornamento stati piatti:",e),!1}})}static \u0275fac=(()=>{let t;return function(e){return(t||(t=l(n)))(e||n)}})();static \u0275prov=m({token:n,factory:n.\u0275fac,providedIn:"root"})};export{f as a,_ as b};
