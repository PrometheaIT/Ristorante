import{Za as M,_a as G}from"./chunk-4YFJNMVW.js";import{a as A}from"./chunk-HN62V3DP.js";import{b as C,d as U,e as I,i as w,m as N,p as z,q as R,r as T,s as O,w as D,y as V}from"./chunk-QAJQXQTD.js";import{b as F,d as x}from"./chunk-Z644G36S.js";import"./chunk-XYJRESY4.js";import{j as y,k as b,u as E}from"./chunk-6ELNIGGB.js";import{Ha as a,Mb as r,Ob as g,U as S,Xa as _,ab as f,ca as c,f as h,lc as P,mb as l,nb as o,ob as n,pb as d,yb as v}from"./chunk-DE3VKQQR.js";import{j as u}from"./chunk-4ZZIO3ZI.js";function B(s,e){if(s&1&&(o(0,"option",28),r(1),n()),s&2){let t=e.$implicit;l("value",t),a(),g(" ",t," ")}}function L(s,e){if(s&1&&(o(0,"option",28),r(1),n()),s&2){let t=e.$implicit;l("value",t.code),a(),g(" ",t.name," ")}}function k(s,e){s&1&&(o(0,"div",29),d(1,"lucide-angular",30),r(2," Nessuna provincia disponibile per questa regione "),n()),s&2&&(a(),l("size",16))}function q(s,e){s&1&&(o(0,"div",8),d(1,"lucide-angular",30),r(2," Seleziona prima una regione "),n()),s&2&&(a(),l("size",16))}function j(s,e){s&1&&(o(0,"span"),r(1,"Salvataggio..."),n())}function H(s,e){s&1&&(o(0,"span"),r(1,"Salva modifiche"),n())}var $=class s{fb=c(D);authService=c(x);supabaseService=c(F);geographyService=c(A);cdRef=c(P);destroy$=new h;supabaseClient=this.supabaseService.getSupabaseClient();profileForm;loading=!1;userProfile;provinces=[];regions=[];filteredProvinces=[];selectedProvinceName="";ngOnInit(){this.initForm(),this.loadProvinces(),this.loadUserProfile()}ngOnDestroy(){this.destroy$.next(),this.destroy$.complete()}initForm(){this.profileForm=this.fb.group({phone:[""],address:[""],region:[""],province:[""]})}loadProvinces(){return u(this,null,function*(){this.geographyService.getFilteredProvinces().pipe(S(this.destroy$)).subscribe({next:e=>{this.provinces=e,this.regions=[...new Set(e.map(i=>i.region))].filter(i=>i!=="Tutte").sort();let t=this.profileForm.get("region")?.value;t&&this.filterProvincesByRegion(t),this.cdRef.detectChanges()},error:e=>console.error("Errore caricamento province:",e)})})}filterProvincesByRegion(e){this.filteredProvinces=e?this.provinces.filter(t=>t.region===e):[],e||this.profileForm.patchValue({province:""})}onRegionChange(e){let i=e.target.value;this.filterProvincesByRegion(i)}onProvinceChange(e){let i=e.target.value,m=this.provinces.find(p=>p.code===i);this.selectedProvinceName=m?m.name:""}loadUserProfile(){return u(this,null,function*(){this.loading=!0;try{let e=this.authService.currentUserValue;if(!e)throw new Error("Utente non autenticato");let{data:t,error:i}=yield this.supabaseClient.from("users").select("*").eq("id",e.id).single();if(i){if(i.code==="PGRST116"){yield this.createUserProfile(e.id);return}throw i}t&&(this.userProfile=t,this.patchForm(t))}catch(e){console.error("Errore caricamento profilo:",e)}finally{this.loading=!1,this.cdRef.detectChanges()}})}createUserProfile(e){return u(this,null,function*(){let t=this.authService.currentUserValue;if(!t)return;let i={id:e,email:t.email,first_name:t.first_name||"",last_name:t.last_name||"",phone:null,address:null,avatar_url:null,preferences:{email_notifications:!0,sms_notifications:!0,newsletter:!0},is_active:!0,role:"customer",created_at:new Date().toISOString(),updated_at:new Date().toISOString()},{data:m,error:p}=yield this.supabaseClient.from("users").insert(i).select().single();if(p){console.error("Errore creazione profilo:",p);return}m&&(this.userProfile=m,this.patchForm(m))})}patchForm(e){let t="";if(e.province){let i=this.provinces.find(m=>m.code===e.province);i&&(t=i.region,this.filterProvincesByRegion(t))}this.profileForm.patchValue({phone:e.phone||"",address:e.address||"",region:t,province:e.province||""})}onSubmit(){return u(this,null,function*(){if(!this.profileForm.invalid){this.loading=!0;try{let e=this.authService.currentUserValue;if(!e)throw new Error("Utente non autenticato");let t=this.profileForm.value,i={phone:t.phone||null,address:t.address||null,province:t.province||null,updated_at:new Date().toISOString()},{error:m}=yield this.supabaseClient.from("users").update(i).eq("id",e.id);if(m)throw m;alert("Profilo aggiornato con successo!")}catch(e){console.error("Errore salvataggio:",e),alert("Errore durante il salvataggio: "+(e.message||"Errore sconosciuto"))}finally{this.loading=!1,this.cdRef.detectChanges()}}})}resetForm(){this.userProfile&&this.patchForm(this.userProfile)}static \u0275fac=function(t){return new(t||s)};static \u0275cmp=_({type:s,selectors:[["app-profile-user"]],decls:75,vars:15,consts:[[1,"page-container"],[1,"profile-form",3,"ngSubmit","formGroup"],[1,"form-card"],[1,"form-row"],[1,"form-group"],[1,"standard-label"],["name","user",1,"nav-icon",3,"size"],["type","text","disabled","",1,"disabled-input",3,"value"],[1,"text-muted","text-mini","mt-sm"],[1,"material-icons"],["name","mail",1,"nav-icon",3,"size"],["type","email","disabled","",1,"disabled-input",3,"value"],[1,"flex","items-center","gap-sm","mb-md","mt-lg"],[1,"material-icons","text-md"],[1,"text-md","font-semibold","m-0"],[1,"form-row","mt-sm"],["formControlName","region",1,"standard-select",3,"change"],["value",""],[3,"value",4,"ngFor","ngForOf"],["formControlName","province",1,"standard-select",3,"change","disabled"],["class","text-warning text-mini mt-sm",4,"ngIf"],["class","text-muted text-mini mt-sm",4,"ngIf"],["type","tel","formControlName","phone","placeholder","+39 123 456 7890"],["type","text","formControlName","address","placeholder","Via Roma 123, Milano"],[1,"modal-footer","p-sm"],["type","submit",1,"promethea-button",3,"disabled"],[4,"ngIf"],["type","button",1,"promethea-button","outline",3,"click","disabled"],[3,"value"],[1,"text-warning","text-mini","mt-sm"],["name","info",3,"size"]],template:function(t,i){if(t&1&&(o(0,"div",0)(1,"form",1),v("ngSubmit",function(){return i.onSubmit()}),o(2,"div",2)(3,"div",3)(4,"div",4)(5,"label",5),d(6,"lucide-angular",6),r(7," Nome "),n(),d(8,"input",7),o(9,"div",8),r(10,"Il nome non pu\xF2 essere modificato"),n()(),o(11,"div",4)(12,"label",5)(13,"span",9),r(14,"person"),n(),r(15," Cognome "),n(),d(16,"input",7),o(17,"div",8),r(18,"Il cognome non pu\xF2 essere modificato"),n()()(),o(19,"div",4)(20,"label",5),d(21,"lucide-angular",10),r(22," Email "),n(),d(23,"input",11),o(24,"div",8),r(25,"L'email non pu\xF2 essere modificata"),n()(),o(26,"div",12)(27,"span",13),r(28,"contact_phone"),n(),o(29,"h2",14),r(30,"Informazioni di Contatto"),n()(),o(31,"div",15)(32,"div",4)(33,"label",5)(34,"span",9),r(35,"public"),n(),r(36," Regione "),n(),o(37,"select",16),v("change",function(p){return i.onRegionChange(p)}),o(38,"option",17),r(39,"Seleziona Regione"),n(),f(40,B,2,2,"option",18),n()(),o(41,"div",4)(42,"label",5)(43,"span",9),r(44,"map"),n(),r(45," Provincia "),n(),o(46,"select",19),v("change",function(p){return i.onProvinceChange(p)}),o(47,"option",17),r(48,"Seleziona Provincia"),n(),f(49,L,2,2,"option",18),n(),f(50,k,3,1,"div",20)(51,q,3,1,"div",21),n()(),o(52,"div",3)(53,"div",4)(54,"label",5)(55,"span",9),r(56,"phone"),n(),r(57," Telefono "),n(),d(58,"input",22),o(59,"div",8),r(60,"Numero per le notifiche e prenotazioni"),n()(),o(61,"div",4)(62,"label",5)(63,"span",9),r(64,"location_on"),n(),r(65," Indirizzo "),n(),d(66,"input",23),o(67,"div",8),r(68,"Indirizzo per consegne a domicilio"),n()()()(),o(69,"div",24)(70,"button",25),f(71,j,2,0,"span",26)(72,H,2,0,"span",26),n(),o(73,"button",27),v("click",function(){return i.resetForm()}),r(74," Annulla "),n()()()()),t&2){let m,p;a(),l("formGroup",i.profileForm),a(5),l("size",20),a(2),l("value",i.userProfile==null?null:i.userProfile.first_name),a(8),l("value",i.userProfile==null?null:i.userProfile.last_name),a(5),l("size",20),a(2),l("value",i.userProfile==null?null:i.userProfile.email),a(17),l("ngForOf",i.regions),a(6),l("disabled",!i.filteredProvinces.length),a(3),l("ngForOf",i.filteredProvinces),a(),l("ngIf",!i.filteredProvinces.length&&((m=i.profileForm.get("region"))==null?null:m.value)),a(),l("ngIf",!((p=i.profileForm.get("region"))!=null&&p.value)),a(19),l("disabled",i.loading||i.profileForm.invalid),a(),l("ngIf",i.loading),a(),l("ngIf",!i.loading),a(),l("disabled",i.loading)}},dependencies:[E,y,b,V,w,T,O,C,R,U,I,N,z,G,M],encapsulation:2})};export{$ as ProfileUser};
