import{a as ne}from"./chunk-7NUE56NK.js";import{a as ae}from"./chunk-USJ37MFE.js";import{a as re}from"./chunk-ER7CQLQI.js";import{a as oe}from"./chunk-4EJPRP2F.js";import{a as ie}from"./chunk-VKCOH4KM.js";import{a as U,b as G,c as C,d as B,e as L,f as Q,i as R,j as $,m as W,n as Y,o as H,p as j,q as J,r as K,s as X,u as Z,w as ee,y as te}from"./chunk-T5BKZD3Y.js";import{c as M,d as V,i as A,l as z,o as q,q as O}from"./chunk-VGLLKVAA.js";import{Ab as a,Ba as s,Bb as S,Cb as g,Db as N,Ob as y,Qb as x,Ra as D,Wa as p,_ as I,cb as c,da as f,db as r,ea as h,eb as o,fb as b,lb as E,ob as _,qb as m,s as P,vb as T,xb as k}from"./chunk-QECS2EDN.js";import{j as F}from"./chunk-4ZZIO3ZI.js";function de(l,t){l&1&&(r(0,"span"),a(1,"(Predefinita)"),o())}function ce(l,t){if(l&1&&(r(0,"option",44),a(1),p(2,de,2,0,"span",45),o()),l&2){let e=t.$implicit;c("value",e.id),s(),g(" ",e.name," "),s(),c("ngIf",e.is_default)}}function me(l,t){if(l&1){let e=E();r(0,"div",11)(1,"label",39)(2,"span",4),a(3,"category"),o(),a(4," Categoria "),o(),r(5,"div",19)(6,"select",40)(7,"option",41),a(8,"Seleziona una categoria"),o(),p(9,ce,3,3,"option",42),o(),r(10,"button",43),_("click",function(){f(e);let n=m();return h(n.toggleNewCategoryForm())}),r(11,"span",4),a(12,"add"),o()()()()}if(l&2){let e=m();s(9),c("ngForOf",e.categories)}}function ue(l,t){if(l&1&&(r(0,"option",44),a(1),o()),l&2){let e=t.$implicit;c("value",e.id),s(),N(" ",e.name," (",e.symbol,") ")}}function ge(l,t){l&1&&(r(0,"div",49),a(1," L'unit\xE0 di misura \xE8 obbligatoria "),o())}function pe(l,t){if(l&1){let e=E();r(0,"div",11)(1,"label",46)(2,"span",4),a(3,"straighten"),o(),a(4," Unit\xE0 di Misura * "),o(),r(5,"select",47),_("change",function(){f(e);let n=m();return h(n.manualCalculateCost())}),r(6,"option",41),a(7,"Seleziona unit\xE0"),o(),p(8,ue,2,3,"option",42),o(),p(9,ge,2,0,"div",48),o()}if(l&2){let e,i=m();s(8),c("ngForOf",i.filteredUnits),s(),c("ngIf",((e=i.foodCostForm.get("unit_id"))==null?null:e.invalid)&&((e=i.foodCostForm.get("unit_id"))==null?null:e.touched))}}function _e(l,t){if(l&1){let e=E();r(0,"div",10)(1,"div",11)(2,"label",50)(3,"span",4),a(4,"timer"),o(),a(5," Tempo di Preparazione (minuti) "),o(),b(6,"input",51),o(),r(7,"div",11)(8,"label",52)(9,"span",4),a(10,"euro"),o(),a(11," Prezzo di Vendita * "),o(),r(12,"input",53),_("change",function(){f(e);let n=m();return h(n.manualCalculateCost())}),o()()()}}function fe(l,t){if(l&1&&(r(0,"small",6),a(1),o()),l&2){let e,i=m(2);s(),g(" in ",i.getUnitSymbol((e=i.foodCostForm.get("unit_id"))==null?null:e.value)," ")}}function he(l,t){if(l&1&&(r(0,"span"),a(1),y(2,"number"),o()),l&2){let e=m(3);s(),g(" (\u2248 ",x(2,1,e.totalWeightGrams/1e3,"1.3-3")," kg) ")}}function ve(l,t){if(l&1&&(r(0,"div",60),a(1),y(2,"number"),p(3,he,3,4,"span",45),o()),l&2){let e,i=m(2);s(),g(" Peso totale ingredienti: ",x(2,2,i.totalWeightGrams,"1.0-0")," g "),s(2),c("ngIf",i.getUnitSymbol((e=i.foodCostForm.get("unit_id"))==null?null:e.value)==="kg")}}function Ce(l,t){l&1&&(r(0,"div",49),a(1," La quantit\xE0 prodotta deve essere maggiore di 0 "),o())}function ye(l,t){if(l&1){let e=E();r(0,"div",10)(1,"div",11)(2,"label",54)(3,"span",4),a(4,"numbers"),o(),a(5," Quantit\xE0 Prodotta * "),o(),r(6,"input",55),_("change",function(){f(e);let n=m();return h(n.manualCalculateCost())}),o(),p(7,fe,2,1,"small",56)(8,ve,4,5,"div",57)(9,Ce,2,0,"div",48),o(),r(10,"div",11)(11,"label",58)(12,"span",4),a(13,"euro"),o(),a(14),o(),b(15,"input",59),o()()}if(l&2){let e,i,n,d,u=m();s(7),c("ngIf",(e=u.foodCostForm.get("unit_id"))==null?null:e.value),s(),c("ngIf",u.totalWeightGrams>0&&((i=u.foodCostForm.get("unit_id"))==null?null:i.value)),s(),c("ngIf",((n=u.foodCostForm.get("yield_quantity"))==null?null:n.invalid)&&((n=u.foodCostForm.get("yield_quantity"))==null?null:n.touched)),s(5),g(" Costo per ",u.getUnitSymbol((d=u.foodCostForm.get("unit_id"))==null?null:d.value)||"unit\xE0"," ")}}function xe(l,t){if(l&1&&(r(0,"span"),a(1),y(2,"number"),o()),l&2){let e=m().$implicit;s(),N(" (\u20AC",x(2,2,e.cost_per_unit,"1.2-2"),"/",e.units.symbol,") ")}}function be(l,t){if(l&1&&(r(0,"option",44),a(1),p(2,xe,3,5,"span",45),o()),l&2){let e=t.$implicit;c("value",e.name),s(),g(" ",e.name," "),s(),c("ngIf",e.unit_id&&e.units)}}function Fe(l,t){if(l&1&&(r(0,"span",68),a(1),o()),l&2){let e,i=m().$implicit,n=m();s(),g(" ",n.getQuantityUnitLabel((e=i.get("ingredient_id"))==null?null:e.value)," ")}}function Ie(l,t){if(l&1){let e=E();r(0,"div",61)(1,"div",24)(2,"input",62,0),_("input",function(n){let d=f(e).index,u=T(3),v=m();return h(v.onIngredientInputSimple(n,d,u))})("focus",function(){f(e);let n=T(3),d=m();return h(d.showDatalist(n))}),o(),r(4,"datalist",63),p(5,be,3,3,"option",42),o()(),r(6,"div",25)(7,"div",64)(8,"input",65),_("change",function(){f(e);let n=m();return h(n.manualCalculateCost())}),o(),p(9,Fe,2,1,"span",66),o()(),r(10,"div",26),a(11),y(12,"number"),o(),r(13,"div",27)(14,"button",67),_("click",function(){let n=f(e).index,d=m();return h(d.removeIngredient(n))}),r(15,"span",4),a(16,"delete"),o()()()()}if(l&2){let e,i,n,d=t.$implicit,u=t.index,v=m();c("formGroupName",u),s(2),c("value",v.getIngredientName((e=d.get("ingredient_id"))==null?null:e.value)),s(3),c("ngForOf",v.ingredients),s(4),c("ngIf",(i=d.get("ingredient_id"))==null?null:i.value),s(2),g(" \u20AC",x(12,5,(n=d.get("cost"))==null?null:n.value,"1.2-2")," ")}}function Ee(l,t){if(l&1&&(r(0,"div",33)(1,"div",34),a(2),y(3,"number"),o(),r(4,"div",69),a(5," Food Cost "),o()()),l&2){let e=m();s(2),g("",x(3,5,e.getFoodCostPercentage(),"1.1-1"),"%"),s(2),k("text-red-500",e.getFoodCostPercentage()>35)("text-green-500",e.getFoodCostPercentage()<=35)}}function Se(l,t){if(l&1&&(r(0,"div",33)(1,"div",34),a(2),y(3,"number"),o(),r(4,"div",35),a(5,"Prezzo Suggerito"),o()()),l&2){let e=m();s(2),g("\u20AC",x(3,1,e.suggestedPrice,"1.2-2"))}}function we(l,t){if(l&1&&(r(0,"div",33)(1,"div",34),a(2),y(3,"number"),o(),r(4,"div",35),a(5,"Margine"),o()()),l&2){let e,i=m();s(2),g("\u20AC",x(3,1,((e=i.foodCostForm.get("sellingPrice"))==null?null:e.value)-i.totalCost,"1.2-2"))}}function Pe(l,t){if(l&1&&(r(0,"div",33)(1,"div",34),a(2),y(3,"number"),o(),r(4,"div",35),a(5),o()()),l&2){let e,i,n=m();s(2),g("\u20AC",x(3,2,n.totalCost/(((e=n.foodCostForm.get("yield_quantity"))==null?null:e.value)||1),"1.3-3")),s(3),g("Costo per ",n.getUnitSymbol((i=n.foodCostForm.get("unit_id"))==null?null:i.value)||"unit\xE0")}}function Te(l,t){if(l&1&&(r(0,"div",33)(1,"div",34),a(2),y(3,"number"),o(),r(4,"div",35),a(5),o()()),l&2){let e,i,n=m();s(2),S(x(3,2,(e=n.foodCostForm.get("yield_quantity"))==null?null:e.value,"1.0-3")),s(3),g("",n.getUnitSymbol((i=n.foodCostForm.get("unit_id"))==null?null:i.value)||"unit\xE0"," prodotte")}}function Ne(l,t){l&1&&(r(0,"div",73)(1,"label",74),a(2,"Quantit\xE0 da acquistare"),o(),b(3,"input",75),o())}function De(l,t){if(l&1&&(r(0,"div",10)(1,"div",64),b(2,"input",70),r(3,"label",71)(4,"strong"),a(5,"Da acquistare"),o(),r(6,"div",6),a(7,"Segna questo ingrediente come da acquistare"),o()()(),p(8,Ne,4,0,"div",72),o()),l&2){let e,i=m();s(8),c("ngIf",(e=i.foodCostForm.get("to_buy"))==null?null:e.value)}}function ke(l,t){l&1&&(r(0,"div",49),a(1," Il nome \xE8 obbligatoria "),o())}function Me(l,t){l&1&&(r(0,"span",4),a(1,"hourglass_empty"),o())}function Ve(l,t){l&1&&(r(0,"span",4),a(1,"check"),o())}function Ae(l,t){if(l&1){let e=E();r(0,"div",76),_("click",function(){f(e);let n=m();return h(n.toggleNewCategoryForm())}),r(1,"div",77),_("click",function(n){return f(e),h(n.stopPropagation())}),r(2,"div",78)(3,"div",79)(4,"div",80)(5,"span",4),a(6,"add_circle"),o()(),r(7,"div")(8,"h1",5),a(9,"Nuova Categoria"),o()()(),r(10,"button",81),_("click",function(){f(e);let n=m();return h(n.toggleNewCategoryForm())}),r(11,"span",4),a(12,"close"),o()()(),r(13,"div",82)(14,"div",83)(15,"div",84)(16,"label",85),a(17,"Nome Categoria *"),o(),b(18,"input",86),p(19,ke,2,0,"div",48),o(),r(20,"div",84)(21,"label",87),a(22,"Descrizione"),o(),b(23,"textarea",88),o(),r(24,"div",89)(25,"label",90),b(26,"input",91),r(27,"div",92)(28,"strong"),a(29,"Imposta come categoria predefinita"),o(),r(30,"div",6),a(31,"Questa categoria sar\xE0 selezionata automaticamente per i nuovi piatti"),o()()()()()(),r(32,"div",93)(33,"button",94),_("click",function(){f(e);let n=m();return h(n.toggleNewCategoryForm())}),r(34,"span",4),a(35,"close"),o(),a(36," Annulla "),o(),r(37,"button",95),_("click",function(){f(e);let n=m();return h(n.onCreateCategory())}),p(38,Me,2,0,"span",96)(39,Ve,2,0,"span",96),a(40),o()()()()}if(l&2){let e,i=m();s(14),c("formGroup",i.newCategoryForm),s(5),c("ngIf",((e=i.newCategoryForm.get("name"))==null?null:e.invalid)&&((e=i.newCategoryForm.get("name"))==null?null:e.touched)),s(14),c("disabled",i.isCreatingCategory),s(4),c("disabled",i.isCreatingCategory||i.newCategoryForm.invalid),s(),c("ngIf",i.isCreatingCategory),s(),c("ngIf",!i.isCreatingCategory),s(),g(" ",i.isCreatingCategory?"Creazione...":"Crea Categoria"," ")}}var le=class l{ingredientService=I(ie);unitService=I(ne);dishService=I(oe);categoryService=I(re);route=I(q);router=I(O);fb=I(ee);menuDishService=I(ae);returnToMenuBuilder=!1;sourceMenuId=null;dishId;foodCostForm;ingredients=[];units=[];totalCost=0;suggestedPrice=0;isEditing=!1;currentDish=null;categories=[];showNewCategoryForm=!1;newCategoryForm;isCreatingCategory=!1;mode="dish";fromInventory=!1;selectedUnit=null;totalWeightGrams=0;calculatedYield=0;yieldManual=!1;constructor(){this.foodCostForm=this.fb.group({name:["",C.required],description:[""],sellingPrice:[0,[C.min(0)]],category_id:[""],preparation_time:[0,[C.min(0)]],unit_id:[""],yield_quantity:[0,[C.required,C.min(.001)]],to_buy:[!1],to_buy_quantity:[null],ingredients:this.fb.array([])}),this.newCategoryForm=this.fb.group({name:["",C.required],description:[""],is_default:[!1]})}ngOnInit(){console.log("\u{1F680} FoodCostCalculator ngOnInit - Caricamento iniziale"),this.loadEssentialData(),this.route.queryParams.subscribe(t=>{console.log("Query params ricevuti:",t),this.returnToMenuBuilder=t.returnToMenuBuilder==="true",this.sourceMenuId=t.menuId||null,console.log("\u{1F4CB} Contesto ricevuto:",{returnToMenuBuilder:this.returnToMenuBuilder,sourceMenuId:this.sourceMenuId}),t.mode==="ingredient"?(this.mode="ingredient",this.fromInventory=t.fromInventory==="true",console.log("Modalit\xE0: INGREDIENTE",{fromInventory:this.fromInventory}),this.initializeForIngredient()):(this.mode="dish",console.log("Modalit\xE0: PIATTO"),this.loadDataForDish())})}loadEssentialData(){return F(this,null,function*(){console.log("\u{1F4E5} Caricamento dati essenziali (ingredienti e unit\xE0)..."),this.ingredientService.data$.subscribe(t=>{this.ingredients=t,console.log("\u2705 Ingredienti caricati:",t.length)}),this.unitService.units$.subscribe(t=>{if(this.units=t,console.log("\u2705 Unit\xE0 caricate:",t.length),this.mode==="ingredient"&&!this.foodCostForm.get("unit_id")?.value){let e=t.find(i=>i.symbol==="kg")||t[0];e&&(this.foodCostForm.patchValue({unit_id:e.id}),this.selectedUnit=e)}})})}loadDataForDish(){return F(this,null,function*(){console.log("\u{1F4E5} Caricamento dati specifici per piatto...");try{this.categoryService.data$.subscribe(t=>{this.categories=t,console.log("\u2705 Categorie caricate:",t.length),this.setDefaultCategory()}),this.categories.length===0&&(console.log("\u26A0\uFE0F Nessuna categoria trovata, provo a caricare manualmente..."),yield this.categoryService.loadData()),console.log("\u{1F4CB} Categorie disponibili:",this.categories),this.route.paramMap.subscribe(t=>F(this,null,function*(){let e=t.get("id");console.log("Route paramMap - dishId:",e),e?yield this.loadDishForEditing(e):(console.log("Nuovo piatto - aggiungo ingrediente vuoto"),this.ingredientsArray.length===0&&this.addIngredient())}))}catch(t){console.error("\u274C Errore caricamento dati piatto:",t)}})}setDefaultCategory(){if(this.categories.length>0&&!this.foodCostForm.get("category_id")?.value){let e=this.categories.find(i=>i.is_default)||this.categories[0];e&&(console.log(`\u{1F3AF} Imposto categoria predefinita: ${e.name} (${e.id})`),this.foodCostForm.patchValue({category_id:e.id}))}}loadDishForEditing(t){return F(this,null,function*(){try{let e=yield P(this.dishService.getDishById$(t));if(e)this.currentDish=e,this.isEditing=!0,this.populateFormWithDish(e);else{console.error("Piatto non trovato:",t),yield this.dishService.loadData();let i=yield P(this.dishService.getDishById$(t));i?(this.currentDish=i,this.isEditing=!0,this.populateFormWithDish(i)):(alert("Piatto non trovato"),this.router.navigate(["/food-cost"]))}}catch(e){console.error("Errore nel caricamento del piatto:",e),alert("Errore nel caricamento del piatto"),this.router.navigate(["/food-cost"])}})}populateFormWithDish(t){for(this.foodCostForm.patchValue({name:t.name,sellingPrice:t.base_price,category_id:t.category_id,description:t.description||"",preparation_time:t.preparation_time||0});this.ingredientsArray.length;)this.ingredientsArray.removeAt(0);t.ingredients_composition&&Array.isArray(t.ingredients_composition)?t.ingredients_composition.forEach(e=>{let i=this.fb.group({ingredient_id:[e.ingredient_id,C.required],quantity:[e.quantity,[C.required,C.min(0)]],cost:[e.cost||0]});this.ingredientsArray.push(i)}):this.addIngredient(),setTimeout(()=>{this.calculateCost()},100)}initializeForIngredient(){for(this.foodCostForm.reset(),this.foodCostForm.patchValue({unit_id:this.getDefaultUnitId(),yield_quantity:1,to_buy:!1,to_buy_quantity:null});this.ingredientsArray.length;)this.ingredientsArray.removeAt(0);this.addIngredient(),this.calculateCost()}getDefaultUnitId(){let t=this.units.find(i=>i.symbol==="kg"),e=this.units.find(i=>i.symbol==="pz");return t?.id||e?.id||""}updateYieldQuantity(){if(!(!this.selectedUnit||this.yieldManual)){if(this.selectedUnit.symbol==="kg")this.calculatedYield=this.totalWeightGrams/1e3;else if(this.selectedUnit.symbol==="g")this.calculatedYield=this.totalWeightGrams;else if(this.selectedUnit.symbol==="pz"){let t=this.foodCostForm.get("yield_quantity")?.value;this.calculatedYield=t>0?t:1}this.foodCostForm.patchValue({yield_quantity:this.calculatedYield},{emitEvent:!1})}}get ingredientsArray(){return this.foodCostForm.get("ingredients")}addIngredient(){let t=this.fb.group({ingredient_id:["",C.required],quantity:[0,[C.required,C.min(0)]],cost:[0]});this.ingredientsArray.push(t)}removeIngredient(t){this.ingredientsArray.removeAt(t),this.manualCalculateCost()}getIngredientUnitSymbol(t){let e=this.ingredients.find(n=>n.id===t);if(!e||!e.unit_id)return"";let i=this.unitService.getUnitById(e.unit_id);return i?i.symbol:""}calculateIngredientCost(t,e){if(!t||!t.unit_id||!t.units)return t.cost_per_unit*e;let i=t.units,n=e;switch(i.symbol){case"kg":n=e/1e3;break;case"L":n=e/1e3;break;case"g":case"mL":case"pz":n=e;break;default:n=e}return t.cost_per_unit*n}manualCalculateCost(){this.calculateCost()}calculateCost(){this.totalCost=0,this.totalWeightGrams=0,this.ingredientsArray.controls.forEach(e=>{let i=e.get("ingredient_id")?.value,n=e.get("quantity")?.value||0;if(i&&n>0){let d=this.ingredients.find(u=>u.id===i);if(d){let u=this.calculateIngredientCost(d,n);if(this.totalCost+=u,d.unit_id&&d.units){let v=d.units;v.type==="weight"&&(v.symbol==="kg"?this.totalWeightGrams+=n*1e3:v.symbol==="g"&&(this.totalWeightGrams+=n))}e.patchValue({cost:u},{emitEvent:!1})}}else e.patchValue({cost:0},{emitEvent:!1})}),this.mode==="ingredient"&&!this.yieldManual&&this.updateYieldQuantity();let t=this.calculateCostPerUnit();this.mode==="dish"&&this.calculateSuggestedPrice()}calculateCostPerUnit(){if(this.mode==="ingredient"){let t=this.foodCostForm.get("yield_quantity")?.value||1;return t>0?this.totalCost/t:0}return 0}calculateSuggestedPrice(){this.suggestedPrice=this.totalCost/.25}getFoodCostPercentage(){let t=this.foodCostForm.get("sellingPrice")?.value||0;return t>0?this.totalCost/t*100:0}getIngredientCost(t,e){let i=this.ingredients.find(n=>n.id===t);return i?this.calculateIngredientCost(i,e):0}onSubmit(){return F(this,null,function*(){if(console.log("\u{1F504} onSubmit() chiamato - Modo:",this.mode),this.canSave()){console.log("\u2705 canSave() TRUE, procedo con salvataggio");try{this.mode==="dish"?yield this.saveDish():yield this.saveIngredient()}catch(t){console.error("\u274C Errore durante il salvataggio:",t),alert("Errore durante il salvataggio: "+t.message)}}else console.log("\u274C canSave() FALSE, non posso salvare"),this.showSpecificErrors(),this.markFormGroupTouched(this.foodCostForm)})}showSpecificErrors(){let t=[],e=this.foodCostForm.get("name")?.value;if((!e||e.trim()==="")&&t.push("\u2022 Nome del piatto/ingrediente"),this.ingredientsArray.controls.some(n=>{let d=n.get("ingredient_id")?.value,u=Number(n.get("quantity")?.value??0);return!!d&&u>0})||t.push("\u2022 Almeno un ingrediente con quantit\xE0 > 0"),this.mode==="dish"){let n=this.foodCostForm.get("sellingPrice")?.value;n!=null&&!isNaN(n)&&Number(n)>0||t.push("\u2022 Prezzo di vendita (deve essere > 0)")}else{let n=this.foodCostForm.get("unit_id")?.value,d=this.foodCostForm.get("yield_quantity")?.value;n||t.push("\u2022 Unit\xE0 di misura"),d!=null&&!isNaN(d)&&Number(d)>0||t.push("\u2022 Quantit\xE0 prodotta (deve essere > 0)")}t.length>0?alert(`Compila i seguenti campi obbligatori:
`+t.join(`
`)):alert("Compila tutti i campi obbligatori")}saveDish(){return F(this,null,function*(){console.log("\u{1F4BE} saveDish chiamato - Contesto:",{returnToMenuBuilder:this.returnToMenuBuilder,sourceMenuId:this.sourceMenuId});let t=this.foodCostForm.value,e=[];this.ingredientsArray.controls.forEach(n=>{let d=n.get("ingredient_id")?.value,u=n.get("quantity")?.value||0;if(d&&u>0){let v=this.ingredients.find(w=>w.id===d);if(v){let w=this.calculateIngredientCost(v,u),se=this.getQuantityUnitLabel(d);e.push({ingredient_id:d,quantity:u,cost:w,unit_symbol:se})}}});let i={name:t.name,base_price:t.sellingPrice,food_cost:this.totalCost,ingredients_composition:e,delivery_price:t.sellingPrice,takeaway_price:t.sellingPrice,status:"available",description:t.description||"",preparation_time:t.preparation_time||0,category_id:t.category_id};try{if(this.isEditing&&this.currentDish){let n={name:t.name,base_price:t.sellingPrice,food_cost:this.totalCost,ingredients_composition:e,delivery_price:t.sellingPrice,takeaway_price:t.sellingPrice,status:"available",description:t.description||"",preparation_time:t.preparation_time||0,category_id:t.category_id};yield this.dishService.updateDish(this.currentDish.id,n),alert("Piatto aggiornato con successo!"),this.returnToMenuBuilder&&(console.log("\u21A9\uFE0F Torno a menu-builder dopo modifica"),this.router.navigate(["/restaurant/menu"]))}else{console.log("\u2795 Creazione nuovo piatto...");let n=yield this.dishService.createDish(i);if(n){if(console.log("\u2705 Piatto creato:",n.id,n.name),this.sourceMenuId&&this.returnToMenuBuilder){console.log("\u{1F3AF} Aggiungo piatto al menu:",this.sourceMenuId);try{let d=yield this.menuDishService.addDishToMenu(this.sourceMenuId,n.id,i.category_id||null,0);d?console.log("\u2705 Piatto aggiunto al menu con successo:",d):console.error("\u274C menuDishResult \xE8 null - il piatto non \xE8 stato aggiunto al menu")}catch(d){console.error("\u274C Errore nell'aggiunta al menu:",d),alert("Il piatto \xE8 stato creato ma c'\xE8 stato un problema nell'aggiunta al menu: "+d.message)}}else console.log("\u2139\uFE0F Piatto creato senza menu (contesto normale)");alert("Piatto creato con successo!"),this.returnToMenuBuilder?(console.log("\u21A9\uFE0F Torno a menu-builder dopo creazione"),this.router.navigate(["/restaurant/menu"])):(console.log("\u{1F504} Resto nel componente e resetto il form"),this.resetForm())}else alert("Errore nella creazione del piatto")}}catch(n){console.error("\u274C Errore nel salvataggio:",n),alert("Errore nel salvataggio del piatto")}})}saveIngredient(){return F(this,null,function*(){let t=this.foodCostForm.value;try{let e=t.yield_quantity||1,i=this.totalCost/e,n={name:t.name,description:t.description||"",unit_id:t.unit_id,current_stock:0,minimum_stock:0,cost_per_unit:i,alert_enabled:!1,to_buy:t.to_buy||!1,to_buy_quantity:t.to_buy_quantity||null,is_active:!0,expiry_date:void 0,supplier_id:void 0,type_id:void 0,group_id:void 0};(yield this.ingredientService.createIngredient(n))?(alert("Ingrediente composto creato con successo!"),this.fromInventory?this.router.navigate(["/restaurant/inventory"]):this.resetForm()):alert("Errore nella creazione dell'ingrediente")}catch(e){console.error("Errore nella creazione dell'ingrediente:",e),alert("Errore nella creazione dell'ingrediente")}})}resetForm(){for(this.foodCostForm.reset();this.ingredientsArray.length;)this.ingredientsArray.removeAt(0);if(this.addIngredient(),this.totalCost=0,this.suggestedPrice=0,this.totalWeightGrams=0,this.yieldManual=!1,this.mode==="dish"){let t=this.categories.find(e=>e.is_default)||this.categories[0];t&&this.foodCostForm.patchValue({category_id:t.id})}else this.foodCostForm.patchValue({unit_id:this.getDefaultUnitId(),yield_quantity:1,to_buy:!1,to_buy_quantity:null})}markFormGroupTouched(t){Object.keys(t.controls).forEach(e=>{let i=t.get(e);i instanceof Q?this.markFormGroupTouched(i):i?.markAsTouched()})}getQuantityUnitLabel(t){let e=this.ingredients.find(n=>n.id===t);if(!e||!e.unit_id||!e.units)return"pz";let i=e.units;switch(i.symbol){case"kg":return"g";case"L":return"mL";case"g":case"mL":case"pz":default:return i.symbol}}canSave(){console.log("=== VERIFICA canSave() ===");let t=this.foodCostForm.get("name")?.value,e=t&&t.trim()!=="";if(console.log("Nome:",t,"Valido:",e),!e)return console.log("\u274C Nome mancante"),!1;let i=this.ingredientsArray.controls.some(n=>{let d=n.get("ingredient_id")?.value,u=Number(n.get("quantity")?.value??0);return!!d&&u>0});if(console.log("Has valid ingredient:",i),!i)return console.log("\u274C Nessun ingrediente valido"),!1;if(this.mode==="dish"){let n=this.foodCostForm.get("sellingPrice")?.value;console.log("Prezzo vendita:",n);let d=n!=null&&!isNaN(n)&&Number(n)>0;return console.log("Prezzo valido:",d),d?(console.log("\u2705 Tutti i controlli DISH passati"),!0):(console.log("\u274C Prezzo vendita non valido"),!1)}else{let n=this.foodCostForm.get("unit_id")?.value,d=this.foodCostForm.get("yield_quantity")?.value;console.log("Unit\xE0:",n,"Quantit\xE0 prodotta:",d);let u=!!n,v=d!=null&&!isNaN(d)&&Number(d)>0;return u?v?(console.log("\u2705 Tutti i controlli INGREDIENT passati"),!0):(console.log("\u274C Quantit\xE0 prodotta non valida"),!1):(console.log("\u274C Unit\xE0 non selezionata"),!1)}}onIngredientSearch(t,e){let i=t.target.value.toLowerCase();if(i){let n=this.ingredients.filter(d=>d.name.toLowerCase().includes(i)||d.description?.toLowerCase().includes(i))}}onIngredientSelected(t,e){let i=t.target.value,n=this.ingredients.find(d=>d.name===i);n?(this.ingredientsArray.at(e).patchValue({ingredient_id:n.id},{emitEvent:!1}),this.manualCalculateCost()):(this.ingredientsArray.at(e).patchValue({ingredient_id:""},{emitEvent:!1}),this.manualCalculateCost())}getIngredientName(t){if(!t)return"";let e=this.ingredients.find(i=>i.id===t);return e?e.name:""}toggleNewCategoryForm(){this.showNewCategoryForm=!this.showNewCategoryForm,this.showNewCategoryForm||this.newCategoryForm.reset()}onCreateCategory(){return F(this,null,function*(){if(this.newCategoryForm.valid){this.isCreatingCategory=!0;try{let t={name:this.newCategoryForm.get("name")?.value?.trim(),description:this.newCategoryForm.get("description")?.value?.trim()||void 0,is_default:this.newCategoryForm.get("is_default")?.value||!1},e=yield this.categoryService.createCategory(t);e?(this.foodCostForm.patchValue({category_id:e.id}),this.showNewCategoryForm=!1,this.newCategoryForm.reset(),alert("Categoria creata con successo!")):alert("Impossibile creare la categoria. Controlla i permessi o riprova.")}catch(t){console.error("Errore durante creazione categoria:",t),alert(`Errore: ${t.message||"Errore sconosciuto"}`)}finally{this.isCreatingCategory=!1}}else this.markFormGroupTouched(this.newCategoryForm),alert("Compila tutti i campi obbligatori (almeno il nome)")})}get filteredUnits(){return this.units.filter(t=>t.symbol==="kg"||t.symbol==="g"||t.symbol==="L"||t.symbol==="mL"||t.symbol==="pz")}getUnitSymbol(t){let e=this.units.find(i=>i.id===t);return e?e.symbol:""}showDatalist(t){setTimeout(()=>{t.click()},100)}onIngredientInputSimple(t,e,i){let n=t.target.value,d=this.ingredients.find(u=>u.name===n);d&&(this.ingredientsArray.at(e).patchValue({ingredient_id:d.id},{emitEvent:!1}),this.manualCalculateCost()),i.focus()}static \u0275fac=function(e){return new(e||l)};static \u0275cmp=D({type:l,selectors:[["app-food-cost-calculator"]],inputs:{dishId:"dishId"},decls:80,vars:27,consts:[["ingredientInput",""],[1,"page-container"],[1,"section-header"],[1,"flex","gap-sm"],[1,"material-icons"],[1,"section-title"],[1,"text-muted"],[1,"flex","flex-col","gap-lg"],[1,"form-card"],[1,"flex","flex-col",3,"ngSubmit","formGroup"],[1,"form-row","mb-md"],[1,"form-group"],["for","name",1,"standard-label"],["id","name","formControlName","name","type","text",3,"placeholder"],["class","form-group",4,"ngIf"],["class","form-row mb-md",4,"ngIf"],["for","description",1,"standard-label"],["id","description","formControlName","description","rows","3",3,"placeholder"],[1,"section-header","piccolaheader"],[1,"flex","gap-sm","items-center"],[1,"section-title","m-0"],[1,"chip"],[1,"ingredients-container"],[1,"ingredients-header"],[1,"ingredient-col"],[1,"quantity-col"],[1,"cost-col"],[1,"action-col"],["formArrayName","ingredients",1,"ingredients-list"],["class","ingredient-row",3,"formGroupName",4,"ngFor","ngForOf"],[1,"modal-footer","p-md0"],["type","button",1,"promethea-button",3,"click"],[1,"costs-grid"],[1,"cost-item"],[1,"cost-value"],[1,"cost-label","text-muted"],["class","cost-item",4,"ngIf"],["type","submit",1,"promethea-button",3,"disabled"],["class","modal-overlay",3,"click",4,"ngIf"],["for","category_id",1,"standard-label"],["id","category_id","formControlName","category_id",1,"flex-1"],["value",""],[3,"value",4,"ngFor","ngForOf"],["type","button","title","Aggiungi nuova categoria",1,"icon-button",3,"click"],[3,"value"],[4,"ngIf"],["for","unit_id",1,"standard-label"],["id","unit_id","formControlName","unit_id",1,"flex-1",3,"change"],["class","text-red-500 text-sm",4,"ngIf"],[1,"text-red-500","text-sm"],["for","preparation_time",1,"standard-label"],["id","preparation_time","formControlName","preparation_time","type","number","min","0","placeholder","0"],["for","sellingPrice",1,"standard-label"],["id","sellingPrice","formControlName","sellingPrice","type","number","step","0.01","min","0","placeholder","0.00",3,"change"],["for","yield_quantity",1,"standard-label"],["id","yield_quantity","formControlName","yield_quantity","type","number","step","0.001","min","0.001","placeholder","0",3,"change"],["class","text-muted",4,"ngIf"],["class","text-xs text-blue-600 mt-1",4,"ngIf"],["for","cost_per_unit",1,"standard-label"],["id","cost_per_unit","formControlName","cost_per_unit","type","number","step","0.001","min","0","readonly","",1,"bg-gray-100"],[1,"text-xs","text-blue-600","mt-1"],[1,"ingredient-row",3,"formGroupName"],["list","ingredientsList","placeholder","Cerca ingrediente...",1,"searchable-select",3,"input","focus","value"],["id","ingredientsList"],[1,"flex","items-center","gap-sm"],["formControlName","quantity","type","number","step","0.001","min","0","placeholder","0",3,"change"],["class","text-muted text-sm whitespace-nowrap",4,"ngIf"],["type","button","title","Rimuovi ingrediente",1,"icon-button",3,"click"],[1,"text-muted","text-sm","whitespace-nowrap"],[1,"cost-label"],["type","checkbox","id","to_buy","formControlName","to_buy"],["for","to_buy",1,"checkbox-label"],["class","mt-3",4,"ngIf"],[1,"mt-3"],["for","to_buy_quantity",1,"standard-label"],["id","to_buy_quantity","formControlName","to_buy_quantity","type","number","min","0","step","0.001","placeholder","0"],[1,"modal-overlay",3,"click"],[1,"modal-container","modal-md",3,"click"],[1,"modal-header"],[1,"flex"],[1,"header-icon"],["type","button",1,"icon-button",3,"click"],[1,"modal-content"],[1,"form-card",3,"formGroup"],[1,"form-row","mb-lg"],["for","newCategoryName",1,"standard-label"],["id","newCategoryName","formControlName","name","type","text","placeholder","Inserisci il nome della categoria","autofocus",""],["for","newCategoryDescription",1,"standard-label"],["id","newCategoryDescription","formControlName","description","rows","3","placeholder","Descrizione della categoria (opzionale)"],[1,"flex","flex-col","gap-sm"],[1,"checkbox-label"],["type","checkbox","formControlName","is_default"],[1,"checkbox-content"],[1,"modal-footer"],["type","button",1,"promethea-button","ghost",3,"click","disabled"],["type","button",1,"promethea-button",3,"click","disabled"],["class","material-icons",4,"ngIf"]],template:function(e,i){e&1&&(r(0,"div",1)(1,"div",2)(2,"div",3)(3,"span",4),a(4),o(),r(5,"h1",5),a(6),o()(),r(7,"p",6),a(8),o()(),r(9,"div",7)(10,"div",8)(11,"form",9),_("ngSubmit",function(){return i.onSubmit()}),r(12,"div",10)(13,"div",11)(14,"label",12)(15,"span",4),a(16,"restaurant"),o(),a(17),o(),b(18,"input",13),o(),p(19,me,13,1,"div",14)(20,pe,10,2,"div",14),o(),p(21,_e,13,0,"div",15)(22,ye,16,4,"div",15),r(23,"div",10)(24,"label",16)(25,"span",4),a(26,"description"),o(),a(27," Descrizione "),o(),b(28,"textarea",17),o(),r(29,"div",18)(30,"div",19)(31,"span",4),a(32,"list"),o(),r(33,"h2",20),a(34,"Ingredienti"),o(),r(35,"span",21),a(36),o()()(),r(37,"div",22)(38,"div",23)(39,"div",24),a(40,"Ingrediente"),o(),r(41,"div",25),a(42,"Quantit\xE0"),o(),r(43,"div",26),a(44,"Costo"),o(),r(45,"div",27),a(46,"Azioni"),o()(),r(47,"div",28),p(48,Ie,17,8,"div",29),o()(),r(49,"div",30)(50,"button",31),_("click",function(){return i.addIngredient()}),r(51,"span",4),a(52,"add"),o(),a(53," Aggiungi Ingrediente "),o()(),r(54,"div",8)(55,"div",18)(56,"div",19)(57,"span",4),a(58,"analytics"),o(),r(59,"h2",20),a(60,"Riepilogo"),o()()(),r(61,"div",32)(62,"div",33)(63,"div",34),a(64),y(65,"number"),o(),r(66,"div",35),a(67,"Costo Totale"),o()(),p(68,Ee,6,8,"div",36)(69,Se,6,4,"div",36)(70,we,6,4,"div",36)(71,Pe,6,5,"div",36)(72,Te,6,5,"div",36),o()(),p(73,De,9,1,"div",15),r(74,"div",30)(75,"button",37)(76,"span",4),a(77),o(),a(78),o()()()()()(),p(79,Ae,41,7,"div",38)),e&2&&(s(4),S(i.isEditing?"edit":"calculate"),s(2),g(" ",i.mode==="ingredient"?"Crea Ingrediente Composto":i.isEditing?"Modifica Piatto":"Calcolo Food Cost"," "),s(2),g(" ",i.mode==="ingredient"?"Calcola il costo di produzione di un ingrediente":i.isEditing?"Modifica il piatto esistente":"Calcola il costo degli ingredienti e il prezzo di vendita ottimale"," "),s(3),c("formGroup",i.foodCostForm),s(6),g(" ",i.mode==="ingredient"?"Nome Ingrediente *":"Nome Piatto *"," "),s(),c("placeholder",i.mode==="ingredient"?"Inserisci il nome dell'ingrediente":"Inserisci il nome del piatto"),s(),c("ngIf",i.mode==="dish"),s(),c("ngIf",i.mode==="ingredient"),s(),c("ngIf",i.mode==="dish"),s(),c("ngIf",i.mode==="ingredient"),s(6),c("placeholder",i.mode==="ingredient"?"Descrizione dell'ingrediente (opzionale)":"Descrizione del piatto (opzionale)"),s(8),g("",i.ingredientsArray.length," ingredienti"),s(12),c("ngForOf",i.ingredientsArray.controls),s(16),g("\u20AC",x(65,24,i.totalCost,"1.2-2")),s(4),c("ngIf",i.mode==="dish"),s(),c("ngIf",i.mode==="dish"),s(),c("ngIf",i.mode==="dish"),s(),c("ngIf",i.mode==="ingredient"),s(),c("ngIf",i.mode==="ingredient"),s(),c("ngIf",i.mode==="ingredient"),s(2),c("disabled",!i.canSave()),s(2),S(i.isEditing?"update":"save"),s(),g(" ",i.mode==="ingredient"?"Crea Ingrediente":i.isEditing?"Aggiorna Piatto":"Salva Piatto"," "),s(),c("ngIf",i.showNewCategoryForm))},dependencies:[z,M,V,te,R,K,X,G,$,U,J,B,L,Z,W,j,Y,H,A],styles:[".piccolaheader[_ngcontent-%COMP%]{background:var(--smoke-1);min-height:auto}.piccolaheader[_ngcontent-%COMP%]   .section-title[_ngcontent-%COMP%], .piccolaheader[_ngcontent-%COMP%]   .material-icons[_ngcontent-%COMP%]{font-size:var(--fs-md)}.ingredients-container[_ngcontent-%COMP%]{border:1px solid var(--smoke-1);border-radius:12px;overflow:hidden;margin-bottom:var(--gap-md)}.ingredients-header[_ngcontent-%COMP%]{display:grid;grid-template-columns:2fr 1fr 1fr auto;gap:var(--gap-md);padding:var(--gap-md);background:var(--smoke-1);font-weight:600;font-size:var(--fs-sm)}.ingredients-list[_ngcontent-%COMP%]{display:flex;flex-direction:column}.ingredient-row[_ngcontent-%COMP%]{display:grid;grid-template-columns:2fr 1fr 1fr auto;gap:var(--gap-md);padding:var(--gap-md);align-items:center;border-bottom:1px solid var(--smoke-1);transition:all .2s ease}.ingredient-row[_ngcontent-%COMP%]:hover{background:var(--smoke-1)}.ingredient-row[_ngcontent-%COMP%]:last-child{border-bottom:none}.ingredient-col[_ngcontent-%COMP%]{min-width:0}.quantity-col[_ngcontent-%COMP%]{min-width:120px}.cost-col[_ngcontent-%COMP%]{min-width:80px;font-weight:600;text-align:center}.costs-grid[_ngcontent-%COMP%]{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:var(--gap-md);margin-top:var(--gap-md)}.cost-item[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center;text-align:center;padding:var(--gap-md);background:var(--background);border:1px solid var(--smoke-1);border-radius:12px;transition:all .2s ease}.cost-item[_ngcontent-%COMP%]:hover{border-color:var(--secondary);transform:translateY(-2px)}.cost-value[_ngcontent-%COMP%]{font-size:var(--fs-md);font-weight:700;margin-bottom:var(--gap-sm)}.cost-label[_ngcontent-%COMP%]{font-size:var(--fs-sm)}.searchable-select[_ngcontent-%COMP%]{width:100%}.hidden[_ngcontent-%COMP%]{display:none!important}@media (max-width: 768px){.ingredients-header[_ngcontent-%COMP%], .ingredient-row[_ngcontent-%COMP%]{grid-template-columns:1fr;gap:var(--gap-sm)}.ingredients-header[_ngcontent-%COMP%]{display:none}.ingredient-row[_ngcontent-%COMP%]{padding:var(--gap-md);border:1px solid var(--smoke-1);border-radius:8px;margin-bottom:var(--gap-sm)}.costs-grid[_ngcontent-%COMP%]{grid-template-columns:repeat(2,1fr)}}@media (max-width: 480px){.costs-grid[_ngcontent-%COMP%]{grid-template-columns:1fr}}.checkbox-label[_ngcontent-%COMP%]{align-items:center}"]})};export{le as a};
