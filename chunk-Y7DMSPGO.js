import{a as S}from"./chunk-LDYAGGWT.js";import{Y as p,g}from"./chunk-DU5L5MFQ.js";import{a as h,b as m,i as f,j as u}from"./chunk-4ZZIO3ZI.js";var b=class c extends S{closuresSubject=new g([]);closures$=this.closuresSubject.asObservable();authSubscription;constructor(){super(),this.authSubscription=this.authService.activeRestaurantId$.subscribe(()=>{this.loadClosures()})}getTableName(){return"shifts"}loadData(t){return u(this,null,function*(){if(yield f(c.prototype,this,"loadData").call(this,t),this.data.length===0){let r=yield this.getCurrentRestaurantId();r&&(yield this.createDefaultShifts(r),yield f(c.prototype,this,"loadData").call(this,t))}})}createDefaultShifts(t){return u(this,null,function*(){let r=[{name:"Pranzo",start_time:"12:00:00",end_time:"15:00:00",days_of_week:[1,2,3,4,5,6,7],is_active:!0},{name:"Cena",start_time:"19:00:00",end_time:"23:00:00",days_of_week:[1,2,3,4,5,6,7],is_active:!0}];try{let{error:s}=yield this.supabaseService.getSupabaseClient().from(this.getTableName()).insert(r.map(n=>m(h({},n),{restaurant_id:t})));if(s)throw s;console.log("\u2705 Default shifts created")}catch(s){console.error("\u274C Error creating default shifts:",s)}})}getCurrentShift(){let t=new Date,r=t.toTimeString().split(" ")[0],s=t.getDay(),n=s===0?7:s,o=this.data.filter(e=>e.is_active);for(let e of o)if(e.days_of_week.includes(n)&&r>=e.start_time&&r<=e.end_time)return e;return null}getOrderingStatus(){return u(this,null,function*(){let t=new Date,r=t.toTimeString().split(" ")[0],s=t.getDay(),n=s===0?7:s;if(yield this.isRestaurantClosedToday())return{allowed:!1,reason:"Ristorante chiuso oggi",currentShift:null};let e=this.data.filter(i=>i.is_active&&i.days_of_week.includes(n));if(e.length===0)return{allowed:!1,reason:"Nessun turno attivo oggi",currentShift:null};for(let i of e){let l=this.subtractHour(i.start_time,1),d=this.addHour(i.end_time,1);if(this.isTimeInRangeWithOvernight(r,l,d,i.end_time))return{allowed:!0,reason:`Turno: ${i.name}`,currentShift:i}}let a=this.getCurrentShift();return a?{allowed:!0,reason:`Turno attivo: ${a.name}`,currentShift:a}:{allowed:!1,reason:"Fuori orario dei turni",currentShift:null}})}loadClosures(){return u(this,null,function*(){try{let t=yield this.getCurrentRestaurantId();if(!t){this.closuresSubject.next([]);return}let{data:r,error:s}=yield this.run(this.supabaseService.getSupabaseClient().from("restaurant_closures").select("*").eq("restaurant_id",t));if(s)throw s;this.closuresSubject.next(r||[])}catch(t){console.error("Error loading closures:",t),this.closuresSubject.next([])}})}isRestaurantClosedToday(){return u(this,null,function*(){let t=this.closuresSubject.value;if(!t.length)return!1;let r=new Date().toISOString().split("T")[0];return t.some(s=>!1)})}subtractHour(t,r){let[s,n,o]=t.split(":").map(Number),e=new Date;return e.setHours(s,n,o),e.setHours(e.getHours()-r),e.toTimeString().split(" ")[0]}addHour(t,r){let[s,n,o]=t.split(":").map(Number),e=new Date;return e.setHours(s,n,o),e.setHours(e.getHours()+r),e.toTimeString().split(" ")[0]}isTimeInRangeWithOvernight(t,r,s,n){let o=l=>{let[d,v,w]=l.split(":").map(Number);return d*60+v+w/60},e=o(t),a=o(r),i=o(s);return i>=a?e>=a&&e<=i:e>=a||e<=i}debugShiftStatus(){return u(this,null,function*(){console.log("\u{1F50D} ===== DEBUG TURNI ====="),console.log("Turni caricati:",this.data);let t=yield this.getOrderingStatus();console.log("Stodo ordinamento:",t),console.log("===== FINE DEBUG ===== \u{1F50D}")})}ngOnDestroy(){super.ngOnDestroy(),this.authSubscription.unsubscribe(),this.closuresSubject.complete()}static \u0275fac=function(r){return new(r||c)};static \u0275prov=p({token:c,factory:c.\u0275fac,providedIn:"root"})};export{b as a};
