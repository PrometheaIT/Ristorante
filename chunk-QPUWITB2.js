import{B as S,D as m}from"./chunk-KBL2L3GY.js";import{H as h,N as l,a as o,b as u,ba as d,f as a,ga as c,m as f}from"./chunk-UE7YVF6I.js";var p=class n{supabaseService=c(S);authService=c(m);shiftsSubject=new f([]);shifts$=this.shiftsSubject.asObservable();constructor(){this.authService.currentUser$.pipe(h(t=>!!t),l(1)).subscribe(()=>{this.loadShifts()})}loadShifts(){return a(this,null,function*(){try{let t=yield this.getCurrentRestaurantId();if(!t){console.error("\u274C No restaurant found");return}let{data:e,error:r}=yield this.supabaseService.getSupabaseClient().from("shifts").select("*").eq("restaurant_id",t).order("start_time");if(r){console.error("Error loading shifts:",r);return}if(!e||e.length===0){yield this.createDefaultShifts(t),yield this.loadShifts();return}this.shiftsSubject.next(e)}catch(t){console.error("Error in loadShifts:",t)}})}createDefaultShifts(t){return a(this,null,function*(){let e=[{restaurant_id:t,name:"Pranzo",start_time:"12:00:00",end_time:"15:00:00",days_of_week:[1,2,3,4,5,6,7],is_active:!0},{restaurant_id:t,name:"Cena",start_time:"19:00:00",end_time:"23:00:00",days_of_week:[1,2,3,4,5,6,7],is_active:!0}];try{let{error:r}=yield this.supabaseService.getSupabaseClient().from("shifts").insert(e);if(r)throw r;console.log("\u2705 Default shifts created")}catch(r){console.error("\u274C Error creating default shifts:",r)}})}getShifts(){return this.shiftsSubject.value}getCurrentShift(){let t=new Date,e=t.toTimeString().split(" ")[0],r=t.getDay(),s=r===0?7:r,g=this.getShifts().filter(i=>i.is_active);for(let i of g)if(i.days_of_week.includes(s)&&e>=i.start_time&&e<=i.end_time)return i;return null}createShift(t){return a(this,null,function*(){try{let e=yield this.getCurrentRestaurantId();if(!e)return console.error("\u274C No restaurant found"),null;let{data:r,error:s}=yield this.supabaseService.getSupabaseClient().from("shifts").insert(u(o({},t),{restaurant_id:e})).select().single();if(s)throw s;return yield this.loadShifts(),r}catch(e){return console.error("Error creating shift:",e),null}})}updateShift(t,e){return a(this,null,function*(){try{let{error:r}=yield this.supabaseService.getSupabaseClient().from("shifts").update(u(o({},e),{updated_at:new Date().toISOString()})).eq("id",t);if(r)throw r;return yield this.loadShifts(),!0}catch(r){return console.error("Error updating shift:",r),!1}})}getCurrentRestaurantId(){return a(this,null,function*(){let t=this.authService.getCurrentStaffRestaurantId();if(t)return t;let e=this.authService.currentUserValue;if(!e)return null;let{data:r}=yield this.supabaseService.getSupabaseClient().from("restaurants").select("id").eq("owner_id",e.id).limit(1).single();return r?.id||null})}static \u0275fac=function(e){return new(e||n)};static \u0275prov=d({token:n,factory:n.\u0275fac,providedIn:"root"})};export{p as a};
