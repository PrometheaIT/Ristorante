import{a as p}from"./chunk-RQ32JMND.js";import{F as g,Y as f,c as m,o as u,ra as h}from"./chunk-HZF257L5.js";import{a as c,b as l,j as o}from"./chunk-4ZZIO3ZI.js";var C=class n extends p{getTableName(){return"categories"}getRestaurantId(){return o(this,null,function*(){return yield this.getCurrentRestaurantId()})}getCategoriesForOrderEditor(){return this.data$.pipe(g(e=>(console.warn("\u26A0\uFE0F Errore categorie, usando default:",e),u(this.getDefaultCategories()))))}getDefaultCategories(){return[{id:"antipasti",name:"Antipasti",order_index:1,is_default:!1,restaurant_id:""},{id:"primi",name:"Primi",order_index:2,is_default:!1,restaurant_id:""},{id:"secondi",name:"Secondi",order_index:3,is_default:!1,restaurant_id:""},{id:"dessert",name:"Dessert",order_index:4,is_default:!1,restaurant_id:""},{id:"bevande",name:"Bevande",order_index:5,is_default:!1,restaurant_id:""}]}loadData(){return o(this,null,function*(){try{let e=yield this.getCurrentRestaurantId();if(!e){console.warn("\u26A0\uFE0F Nessun restaurantId trovato per CategoryService"),this.dataSubject.next([]);return}console.log("\u{1F4CB} Caricamento categorie per restaurant:",e),this.loadingService.start();let{data:r,error:t}=yield this.supabaseService.getSupabaseClient().from(this.getTableName()).select("*").eq("restaurant_id",e).order("order_index",{ascending:!0});if(t)if(t.code==="42501"||t.message.includes("403"))console.error("\u274C Errore autorizzazione (403) per categorie:",t.message),this.errorSubject.next("Non hai i permessi per visualizzare le categorie"),this.dataSubject.next(this.getDefaultCategories());else throw t;else console.log(`\u2705 Categorie caricate: ${r?.length||0}`),this.dataSubject.next(r||[])}catch(e){console.error("\u274C Errore caricamento categorie:",e),this.errorSubject.next(e.message||"Errore caricamento categorie"),this.dataSubject.next(this.getDefaultCategories())}finally{this.loadingService.stop()}})}getCategories(){return this.dataSubject.value}getCategoriesForEditor(){return this.data$.pipe(g(e=>(console.warn("\u26A0\uFE0F Errore categorie, usando fallback:",e),u(this.getDefaultCategories()))))}createCategory(e){return o(this,null,function*(){try{if(console.log("\u{1F4DD} Creazione categoria:",e),!e.name||e.name.trim()==="")return this.errorSubject.next("Il nome della categoria \xE8 obbligatorio"),null;let r=yield this.getCurrentRestaurantId();if(!r)return console.error("\u274C Nessun restaurantId trovato"),this.errorSubject.next("Nessun ristorante selezionato"),null;let t=e.order_index;if(t==null)try{let{data:a,error:b}=yield this.supabaseService.getSupabaseClient().from("categories").select("order_index").eq("restaurant_id",r).order("order_index",{ascending:!1}).limit(1);!b&&a&&a.length>0?t=a[0].order_index+1:t=1}catch(a){console.warn("\u26A0\uFE0F Errore calcolo order_index, usando 1:",a),t=1}let i={name:e.name.trim(),description:e.description?.trim()||null,is_default:e.is_default||!1,order_index:t,restaurant_id:r,created_at:new Date().toISOString(),updated_at:new Date().toISOString()};console.log("\u{1F4E4} Inserimento categoria:",i);let{data:d,error:s}=yield this.supabaseService.getSupabaseClient().from("categories").insert(i).select().single();return s?(console.error("\u{1F4A5} [ERROR] Errore Supabase:",s),this.errorSubject.next(s.message||"Errore creazione categoria"),null):(console.log("\u2705 Categoria creata:",d),yield this.loadData(),d)}catch(r){return console.error("\u{1F4A5} Errore inatteso creazione categoria:",r),this.errorSubject.next(r.message||"Errore inatteso"),null}})}createCategoryForCurrentUser(e){return o(this,null,function*(){return this.createCategory(e)})}getRestaurantId$(){return new m(e=>{this.getRestaurantId().then(r=>{e.next(r),e.complete()}).catch(r=>e.error(r))})}getNextAvailableOrderIndex(){return o(this,null,function*(){try{let e=yield this.getCurrentRestaurantId();if(!e)return 0;let{data:r,error:t}=yield this.supabaseService.getSupabaseClient().from("categories").select("order_index").eq("restaurant_id",e).order("order_index",{ascending:!1}).limit(1);return t?(console.warn("\u26A0\uFE0F Errore recupero ultimo order_index:",t),0):r&&r.length>0?(r[0].order_index||0)+1:0}catch(e){return console.error("\u274C Errore in getNextAvailableOrderIndex:",e),0}})}getCategoryOrderList(){return o(this,null,function*(){try{let e=yield this.getCurrentRestaurantId();if(!e)return[];let{data:r,error:t}=yield this.supabaseService.getSupabaseClient().from("categories").select("id, name, order_index").eq("restaurant_id",e).order("order_index",{ascending:!0});if(t)throw t;return r||[]}catch(e){return console.error("\u274C Errore recupero ordine categorie:",e),[]}})}updateCategoriesOrder(e){return o(this,null,function*(){try{let r=yield this.getCurrentRestaurantId();if(!r)return!1;let t=e.map(a=>l(c({},a),{order_index:Math.max(1,a.order_index)}));console.log("\u{1F4E4} Aggiornamento ordine categorie:",t);let i=t.map(a=>this.supabaseService.getSupabaseClient().from("categories").update({order_index:a.order_index,updated_at:new Date().toISOString()}).eq("id",a.id).eq("restaurant_id",r));return(yield Promise.all(i)).some(a=>a.error)?(console.error("\u274C Errore durante l'aggiornamento dell'ordine"),!1):(yield this.loadData(),console.log("\u2705 Ordine categorie aggiornato con successo"),!0)}catch(r){return console.error("\u{1F4A5} Errore in updateCategoriesOrder:",r),!1}})}updateCategory(e,r){return o(this,null,function*(){try{let{data:t,error:i}=yield this.supabaseService.getSupabaseClient().from("categories").update(l(c({},r),{updated_at:new Date().toISOString()})).eq("id",e).select().single();if(i)throw i;return yield this.loadData(),t}catch(t){return console.error("\u274C Errore aggiornamento categoria:",t),null}})}static \u0275fac=(()=>{let e;return function(t){return(e||(e=h(n)))(t||n)}})();static \u0275prov=f({token:n,factory:n.\u0275fac,providedIn:"root"})};export{C as a};
