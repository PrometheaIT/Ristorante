import{a as v,b as f}from"./chunk-NDYEGTI3.js";import{a as y}from"./chunk-MVDMN4LR.js";import{V as m,_ as c,na as h}from"./chunk-QECS2EDN.js";import{j as a}from"./chunk-4ZZIO3ZI.js";var u=class s{orderHeaderService=c(g);comandaService=c(v);orderItemService=c(f);occupyTable(r,e){return a(this,null,function*(){try{let t=yield this.orderHeaderService.createForTable(r,e);if(!t)return{orderHeader:null,comanda:null};let o=yield this.comandaService.createForOrderHeader(t.id,1);return{orderHeader:t,comanda:o}}catch(t){return console.error("\u274C Errore occupazione tavolo:",t),{orderHeader:null,comanda:null}}})}loadFullOrder(r){return a(this,null,function*(){try{let e=yield this.orderHeaderService.getByIdAsync(r);if(!e)return null;let t=yield this.comandaService.loadByOrderHeaderId(r);for(let o of t){let n=yield this.orderItemService.loadByComandaId(o.id);o.order_items=n}return e.comande=t,e}catch(e){return console.error("\u274C Errore caricamento ordine completo:",e),null}})}addDishToTable(r,e,t,o,n=1,l=""){return a(this,null,function*(){try{let i=yield this.orderHeaderService.getActiveByTable(r);if(!i){let d=yield this.occupyTable(r,"Cliente");if(!d.orderHeader||!d.comanda)return!1;i=d.orderHeader}let p=(yield this.comandaService.loadByOrderHeaderId(i.id)).find(d=>d.status!=="cancelled");if(!p){let d=yield this.comandaService.createForOrderHeader(i.id);if(!d)return!1;p=d}return!!(yield this.orderItemService.addItemToComanda(p.id,e,n,o,l))}catch(i){return console.error("\u274C Errore aggiunta piatto:",i),!1}})}createComandaForOrderHeader(r){return a(this,null,function*(){try{return yield this.comandaService.createForOrderHeader(r)}catch(e){return console.error("\u274C Errore creazione comanda:",e),null}})}updateItemQuantity(r,e){return a(this,null,function*(){try{return yield this.orderItemService.updateQuantity(r,e)}catch(t){return console.error("\u274C Errore aggiornamento quantit\xE0:",t),!1}})}removeItem(r){return a(this,null,function*(){try{return yield this.orderItemService.delete(r)}catch(e){return console.error("\u274C Errore rimozione piatto:",e),!1}})}closeTavolata(r){return a(this,null,function*(){try{return yield this.orderHeaderService.closeHeader(r)}catch(e){return console.error("\u274C Errore chiusura tavolata:",e),!1}})}updateComandaStatus(r,e){return a(this,null,function*(){try{return["ordered","waiting","preparing","ready","served","cancelled"].includes(e)?yield this.comandaService.update(r,{status:e,updated_at:new Date().toISOString()}):(console.error("\u274C Stato non valido:",e),!1)}catch(t){return console.error("\u274C Errore aggiornamento stato comanda:",t),!1}})}static \u0275fac=function(e){return new(e||s)};static \u0275prov=m({token:s,factory:s.\u0275fac,providedIn:"root"})};var g=class s extends y{getTableName(){return"order_headers"}hasRestaurantId(){return!0}createForTable(r,e){return a(this,null,function*(){try{let t=yield this.getCurrentRestaurantId();if(!t)return console.error("\u274C Restaurant ID non trovato"),null;let o=yield this.generateOrderNumber(),n={restaurant_id:t,table_id:r,order_number:o,status:"active",customer_name:e||"Cliente",total_amount:0};console.log("\u{1F4E4} Creazione OrderHeader (tavolata):",n);let{data:l,error:i}=yield this.supabaseService.getSupabaseClient().from(this.getTableName()).insert(n).select().single();return i?(console.error("\u274C Errore creazione order header:",i),null):l}catch(t){return console.error("\u274C Errore creazione order header:",t),null}})}generateOrderNumber(){return a(this,null,function*(){let r=new Date,e=r.getFullYear().toString().slice(-2),t=(r.getMonth()+1).toString().padStart(2,"0"),o=r.getDate().toString().padStart(2,"0"),n=Math.floor(Math.random()*1e3).toString().padStart(3,"0");return`TAV-${e}${t}${o}-${n}`})}getActiveByTable(r){return a(this,null,function*(){try{let e=yield this.getCurrentRestaurantId();if(!e)return null;let{data:t,error:o}=yield this.supabaseService.getSupabaseClient().from("order_headers").select("*").eq("restaurant_id",e).eq("table_id",r).in("status",["active","open","pending"]).order("created_at",{ascending:!1}).limit(1);return o?(console.error("\u274C Errore query order_headers:",o),null):t&&t.length>0?t[0]:null}catch(e){return console.error("\u274C Errore getActiveByTable:",e),null}})}closeTavolata(r){return a(this,null,function*(){return yield this.update(r,{status:"completed",updated_at:new Date().toISOString()})})}getByIdAsync(r){return a(this,null,function*(){try{let{data:e,error:t}=yield this.supabaseService.getSupabaseClient().from(this.getTableName()).select("*").eq("id",r).single();if(t)throw t;return e}catch(e){return console.error("Errore getById:",e),null}})}closeAllActiveHeadersForTable(r){return a(this,null,function*(){try{let e=yield this.getCurrentRestaurantId();if(!e)return!1;let{error:t}=yield this.supabaseService.getSupabaseClient().from(this.getTableName()).update({status:"completed",updated_at:new Date().toISOString()}).eq("restaurant_id",e).eq("table_id",r).eq("status","active");return!t}catch(e){return console.error("Errore chiusura order headers:",e),!1}})}closeHeader(r){return a(this,null,function*(){return yield this.update(r,{status:"completed",updated_at:new Date().toISOString()})})}getActiveOrderHeaderByTable(r){return a(this,null,function*(){return this.getActiveByTable(r)})}loadWithDetails(r){return a(this,null,function*(){try{return yield c(u).loadFullOrder(r)}catch(e){return console.error("Errore loadWithDetails:",e),null}})}getTableOrderItemsCount(r){return a(this,null,function*(){try{let e=yield this.getActiveByTable(r);if(!e)return 0;let o=yield c(u).loadFullOrder(e.id);if(!o||!o.comande)return 0;let n=0;for(let l of o.comande)l.order_items&&(n+=l.order_items.length);return n}catch(e){return console.error("Errore getTableOrderItemsCount:",e),0}})}static \u0275fac=(()=>{let r;return function(t){return(r||(r=h(s)))(t||s)}})();static \u0275prov=m({token:s,factory:s.\u0275fac,providedIn:"root"})};export{u as a,g as b};
