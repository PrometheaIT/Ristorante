import{a as h}from"./chunk-PYCM5Q4Y.js";import{b}from"./chunk-CXUZBBYL.js";import{b as D}from"./chunk-QGVET3VN.js";import{Y as f,ba as d,u}from"./chunk-25TB2OJR.js";import{a as M,b as p,j as r}from"./chunk-4ZZIO3ZI.js";var m=class extends h{getTableName(){return"menus"}},g=class extends h{getTableName(){return"menu_dishes"}},_=class o{supabase=d(D);authService=d(b);menuService;menuDishService;constructor(){this.menuService=new m,this.menuDishService=new g}loadData(){return r(this,null,function*(){yield this.menuService.loadData()})}loadMenus(){return r(this,null,function*(){yield this.menuService.loadData()})}get data$(){return this.menuService.data$}get menus$(){return this.menuService.data$}get menusLoading$(){return this.menuService.loading$}get menusError$(){return this.menuService.error$}createMenu(e,t,i=!1,s="global"){return r(this,null,function*(){let n={name:e,description:t,is_default:i,is_active:!0,display_order:0,type:s,is_favorite:!1};console.log("\u{1F50D} Creazione menu con:",n);let a=yield this.menuService.create(n);return a&&i&&(yield this.setAsDefault(a.id)),a})}createDedicatedMenu(e,t){return r(this,null,function*(){return this.createMenu(e,t,!1,"dedicated")})}setAsDefault(e){return r(this,null,function*(){try{let s=this.getCurrentMenus().filter(a=>a.is_default).filter(a=>a.id!==e).map(a=>this.menuService.update(a.id,{is_default:!1}));yield Promise.all(s);let n=yield this.menuService.update(e,{is_default:!0,is_active:!0,type:"global"});return n&&(yield this.loadMenus()),n}catch(t){return console.error("Errore impostazione default:",t),!1}})}toggleMenuActive(e){return r(this,null,function*(){let i=this.getCurrentMenus().find(n=>n.id===e);if(!i||i.is_default)return!1;let s=yield this.menuService.update(e,{is_active:!i.is_active});return s&&(yield this.loadMenus()),s})}getDefaultActiveMenu$(){return this.menus$.pipe(u(e=>e.find(i=>i.is_default&&i.is_active)||(e.length>0?e[0]:null)))}getActiveMenus$(){return this.menus$.pipe(u(e=>e.filter(t=>t.is_active)))}getGlobalMenus$(){return this.menus$.pipe(u(e=>e.filter(t=>t.is_active&&t.type==="global")))}getDedicatedMenus$(){return this.menus$.pipe(u(e=>e.filter(t=>t.is_active&&t.type==="dedicated")))}getMenuById(e){return r(this,null,function*(){try{let{data:t,error:i}=yield this.supabase.getSupabaseClient().from("menus").select("*").eq("id",e).single();if(i)throw i;return t}catch(t){return console.error("Errore recupero menu:",t),null}})}updateMenu(e,t){return r(this,null,function*(){let i=yield this.menuService.update(e,t);return i&&(yield this.loadMenus()),i})}delete(e){return r(this,null,function*(){return this.deleteMenu(e)})}deleteMenu(e){return r(this,null,function*(){return(yield this.getMenuById(e))?.is_default?!1:this.menuService.delete(e)})}loadMenuDishes(e){return r(this,null,function*(){let t=e?{menu_id:e}:void 0;yield this.menuDishService.loadData(t)})}get menuDishes$(){return this.menuDishService.data$}get menuDishesData$(){return this.menuDishService.data$}get menuDishesLoading$(){return this.menuDishService.loading$}get menuDishesError$(){return this.menuDishService.error$}addDishToMenu(e,t,i,s=0){return r(this,null,function*(){if(this.getCurrentMenuDishes().find(l=>l.menu_id===e&&l.dish_id===t&&l.is_active))throw new Error("Il piatto \xE8 gi\xE0 presente in questo menu");let c={menu_id:e,dish_id:t,display_order:s,is_active:!0};i&&i.trim()!==""&&(c.category_id=i),console.log("\u{1F50D} Creazione menu_dish con:",c);let v=yield this.menuDishService.create(c);return v&&(yield this.menuDishService.loadData({menu_id:e})),v})}removeDishFromMenu(e){return r(this,null,function*(){return this.updateMenuDish(e,{is_active:!1})})}updateMenuDish(e,t){return r(this,null,function*(){let i=yield this.menuDishService.update(e,p(M({},t),{updated_at:new Date().toISOString()}));if(i){let n=this.getCurrentMenuDishes().find(a=>a.id===e);n?.menu_id&&(yield this.loadMenuDishes(n.menu_id))}return i})}updateDishOrder(e,t){return r(this,null,function*(){return this.updateMenuDish(e,{display_order:t})})}getDishesByMenu$(e){return this.menuDishes$.pipe(u(t=>t.filter(i=>i.menu_id===e&&i.is_active)))}getDishesWithDetailsByMenu(e){return r(this,null,function*(){try{let{data:t,error:i}=yield this.supabase.getSupabaseClient().from("menu_dishes").select(`
          *,
          dish:dishes!dish_id (
            id,
            name,
            description,
            base_price,
            image_url,
            status,
            category_id,
            preparation_time,
            deleted_at
          ),
          category:categories!category_id (
            id,
            name
          )
        `).eq("menu_id",e).eq("is_active",!0).order("display_order");if(i)throw i;return(t||[]).filter(s=>s.dish&&!s.dish.deleted_at)}catch(t){return console.error("Errore recupero piatti dettagliati:",t),[]}})}removeAllDishesFromMenu(e){return r(this,null,function*(){try{let{error:t}=yield this.supabase.getSupabaseClient().from("menu_dishes").update({is_active:!1,updated_at:new Date().toISOString()}).eq("menu_id",e).eq("is_active",!0);if(t)throw t;return yield this.loadMenuDishes(e),!0}catch(t){return console.error("\u274C Errore rimozione piatti dal menu:",t),!1}})}getCurrentMenus(){return this.menuService.data||[]}getCurrentMenuDishes(){return this.menuDishService.data||[]}isDishInMenu(e,t){return this.getCurrentMenuDishes().some(s=>s.menu_id===e&&s.dish_id===t&&s.is_active)}getNextDisplayOrder(e){let i=this.getCurrentMenuDishes().filter(n=>n.menu_id===e);return i.length===0?0:Math.max(...i.map(n=>n.display_order))+1}refreshAll(){return r(this,null,function*(){yield Promise.all([this.loadMenus(),this.loadMenuDishes()])})}static \u0275fac=function(t){return new(t||o)};static \u0275prov=f({token:o,factory:o.\u0275fac,providedIn:"root"})};export{_ as a};
