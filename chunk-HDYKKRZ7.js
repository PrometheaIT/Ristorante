import{a as y}from"./chunk-3F4CDTNS.js";import{B as l,O as D,a as b,b as f,ba as v,c as m,h as a}from"./chunk-2FS7XGGJ.js";var S=class d extends y{getTableName(){return"dishes"}constructor(){super(),this.authService.currentUser$.pipe(D(1)).subscribe(e=>{e&&this.loadData()})}getAvailableDishes(){return this.data$.pipe(l(e=>e.filter(t=>t.status==="available")))}getDishesByCategory(e){return this.data$.pipe(l(t=>t.filter(r=>r.category_id===e)))}getDishById$(e){return this.getById(e)}createDish(e){return a(this,null,function*(){console.log("\u{1F4DD} [DishService.createDish] Inizio creazione piatto");try{if(!e.name||e.name.trim()==="")return console.error("\u274C Nome mancante"),this.errorSubject.next("Il nome del piatto \xE8 obbligatorio"),null;if(e.base_price<=0)return console.error("\u274C Prezzo non valido:",e.base_price),this.errorSubject.next("Il prezzo base deve essere maggiore di 0"),null;let t=yield this.getCurrentRestaurantId();if(console.log("\u{1F3EA} Restaurant ID ottenuto:",t),!t)return console.error("\u274C Restaurant ID NON TROVATO!"),this.errorSubject.next("Impossibile determinare il ristorante corrente"),null;let r={name:e.name.trim(),description:e.description||null,base_price:Number(e.base_price),food_cost:e.food_cost?Number(e.food_cost):0,status:e.status||"available",preparation_time:e.preparation_time||null,restaurant_id:t,category_id:e.category_id||null,delivery_price:e.delivery_price||null,takeaway_price:e.takeaway_price||null,image_url:e.image_url||null,recipe_instructions:e.recipe_instructions||null,ingredients_composition:e.ingredients_composition||null,created_at:new Date().toISOString()};Object.keys(r).forEach(o=>{r[o]===void 0&&(r[o]=null)}),console.log("\u{1F4E4} [DishService.createDish] Payload finale:",JSON.stringify(r,null,2));let{data:i,error:s}=yield this.supabaseService.getSupabaseClient().from("dishes").insert(r).select().single();if(s)return console.error("\u274C [DishService.createDish] Errore Supabase:",{code:s.code,message:s.message,details:s.details,hint:s.hint}),this.errorSubject.next(s.message),null;console.log("\u2705 [DishService.createDish] Piatto creato con successo:",i);let c=this.dataSubject.value;return this.dataSubject.next([...c,i]),i}catch(t){return console.error("\u274C [DishService.createDish] Errore imprevisto:",t),this.errorSubject.next("Errore durante la creazione del piatto"),null}})}updateDish(e,t){return a(this,null,function*(){return console.log("\u{1F504} Updating dish:",e,t),t.name!==void 0&&t.name.trim()===""?(this.errorSubject.next("Il nome del piatto non pu\xF2 essere vuoto"),!1):t.base_price!==void 0&&t.base_price<=0?(this.errorSubject.next("Il prezzo base deve essere maggiore di 0"),!1):this.update(e,t)})}deleteDish(e){return a(this,null,function*(){console.log("\u{1F5D1}\uFE0F Eseguendo SOFT DELETE del piatto:",e);try{return yield this.update(e,{deleted_at:new Date().toISOString()})}catch(t){return console.error("\u274C Errore durante il soft delete:",t),!1}})}changeDishStatus(e,t){return a(this,null,function*(){return this.update(e,{status:t})})}updateFoodCost(e,t){return a(this,null,function*(){return t<0?(this.errorSubject.next("Il food cost non pu\xF2 essere negativo"),!1):this.update(e,{food_cost:t})})}searchDishes(e){return this.data$.pipe(l(t=>{if(!e.trim())return t;let r=e.toLowerCase();return t.filter(i=>i.name.toLowerCase().includes(r)||i.description?.toLowerCase().includes(r))}))}getDefaultCategoryId(){return a(this,null,function*(){try{let e=yield this.getCurrentRestaurantId();if(!e)return null;let{data:t,error:r}=yield this.supabaseService.getSupabaseClient().from("categories").select("id").eq("restaurant_id",e).eq("is_default",!0).limit(1).single();if(r||!t){console.warn("No default category found, using first category");let{data:i}=yield this.supabaseService.getSupabaseClient().from("categories").select("id").eq("restaurant_id",e).limit(1).single();return i?.id||null}return t.id}catch(e){return console.error("Error getting default category:",e),null}})}loadData(e){return a(this,null,function*(){try{this.loadingSubject.next(!0),this.errorSubject.next(null);let t=yield this.getCurrentRestaurantId();if(!t){this.dataSubject.next([]);return}let r=this.supabaseService.getSupabaseClient().from(this.getTableName()).select("*").eq("restaurant_id",t).is("deleted_at",null);e&&Object.keys(e).forEach(c=>{let o=e[c];o!=null&&(r=r.eq(c,o))}),this.loadingService.start();let{data:i,error:s}=yield r;if(this.loadingService.stop(),s)throw s;this.dataSubject.next(i??[])}catch(t){console.error("Error loading dishes:",t),this.errorSubject.next(t.message??"Errore sconosciuto"),this.dataSubject.next([])}finally{this.loadingSubject.next(!1)}})}loadDishes(){return a(this,null,function*(){return this.loadData()})}reloadDishes(){return a(this,null,function*(){return this.loadData()})}getDishes(){return this.dataSubject.value}getDishById(e){return this.dataSubject.value.find(t=>t.id===e)}getDishesByMenu$(e){return this.data$}isDishInMenu$(e,t){return this.data$.pipe(l(r=>!!r.find(s=>s.id===e)))}getActiveDishes$(){return this.data$.pipe(l(e=>e.filter(t=>!t.deleted_at)))}getActiveDishes(){return this.dataSubject.value.filter(e=>!e.deleted_at)}getAllDishesIncludingDeleted(){return a(this,null,function*(){let e=yield this.getCurrentRestaurantId();if(!e)return[];let{data:t,error:r}=yield this.supabaseService.getSupabaseClient().from(this.getTableName()).select("*").eq("restaurant_id",e);return r?(console.error("Error loading all dishes:",r),[]):t||[]})}cloneDish(e,t){return a(this,null,function*(){console.log("\u{1F300} Clonando piatto:",e,"per menu:",t);try{let i=this.dataSubject.value.find(n=>n.id===e&&!n.deleted_at);if(!i)return console.error("\u274C Piatto originale non trovato o cancellato"),null;let r=i,{id:s,created_at:c,deleted_at:o}=r,g=m(r,["id","created_at","deleted_at"]),u=g.name.replace(/ \(Copia.*\)$/,"").replace(/ - .*$/,""),h=t?`${u} - ${t}`:`${u} (Copia)`,p=this.dataSubject.value.filter(n=>n.name.startsWith(u)&&n.id!==e&&!n.deleted_at);if(p.length>0){let n=p.length+1;h=t?`${u} - ${t} (${n})`:`${u} (Copia ${n})`}let _=f(b({},g),{name:h,status:"available"});return console.log("\u{1F4DD} Creando piatto clonato:",h),yield this.createDish(_)}catch(i){return console.error("\u274C Errore durante la clonazione del piatto:",i),null}})}restoreDish(e){return a(this,null,function*(){console.log("\u267B\uFE0F Ripristino piatto:",e);try{return yield this.update(e,{deleted_at:null,status:"available"})}catch(t){return console.error("\u274C Errore durante il ripristino del piatto:",t),!1}})}static \u0275fac=function(t){return new(t||d)};static \u0275prov=v({token:d,factory:d.\u0275fac,providedIn:"root"})};export{S as a};
