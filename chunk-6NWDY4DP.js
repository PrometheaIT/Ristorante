import{b as p}from"./chunk-PJAEBTL6.js";import{r as h}from"./chunk-JA3GOP6I.js";import{Y as f,ba as c,g as u}from"./chunk-HZF257L5.js";import{j as n}from"./chunk-4ZZIO3ZI.js";var d=class l{supabaseService=c(p);userPermissionsSubject=new u([]);userPermissions$=this.userPermissionsSubject.asObservable();allPermissions=[{key:"view_dashboard",label:"Visualizza Dashboard",description:"Accesso alla dashboard principale"},{key:"manage_menu",label:"Gestione Men\xF9",description:"Aggiungere, modificare e eliminare piatti e categorie"},{key:"manage_orders",label:"Gestione Ordini",description:"Visualizzare e gestire gli ordini dei clienti"},{key:"manage_reservations",label:"Gestione Prenotazioni",description:"Gestire le prenotazioni dei tavoli"},{key:"view_reports",label:"Visualizza Report",description:"Accesso ai report finanziari e statistiche"},{key:"view_kitchen_display",label:"Pannello Cucina",description:"Visualizzare gli ordini in cucina"},{key:"manage_inventory",label:"Gestione Inventario",description:"Gestire ingredienti e scorte"},{key:"view_expenses",label:"Visualizza Spese",description:"Visualizzare e gestire le spese"},{key:"view_table_map",label:"Mappa Tavoli",description:"Visualizzare la mappa dei tavoli"},{key:"take_orders",label:"Prendere Ordini",description:"Registrare nuovi ordini"},{key:"manage_restaurant_settings",label:"Impostazioni Ristorante",description:"Modificare le impostazioni del ristorante"},{key:"manage_staff",label:"Gestione Staff",description:"Aggiungere e gestire il personale"},{key:"view_ingredients",label:"Visualizza Ingredienti",description:"Accesso alla gestione ingredienti e ricette"}];loadUserPermissions(e,t,r,i,s){return n(this,null,function*(){if(console.log("\u{1F504} PermissionService - Caricamento permessi:",{userId:e,restaurantId:t,isOwner:r,staffRole:i,isSupplier:s}),s){let a=["view_supplier_dashboard","manage_supplier_products","view_supplier_restaurants","manage_supplier_orders","manage_supplier_profile"];this.userPermissionsSubject.next(a),console.log("\u2705 Permessi fornitore caricati");return}if(r){let a=this.allPermissions.filter(o=>!o.key.includes("supplier")).map(o=>o.key);this.userPermissionsSubject.next(a),console.log("\u2705 Permessi proprietario caricati:",a);return}if(i&&t){let a=yield this.getPermissionsForRole(t,i);this.userPermissionsSubject.next(a),console.log("\u2705 Permessi staff caricati:",a);return}this.userPermissionsSubject.next([]),console.log("\u26A0\uFE0F Nessun permesso caricato")})}getPermissionsForRole(e,t){return n(this,null,function*(){try{console.log("\u{1F50D} Loading permissions for role:",{restaurantId:e,role:t});let{data:r,error:i}=yield this.supabaseService.getSupabaseClient().from("restaurant_staff").select("permissions").eq("restaurant_id",e).eq("role",t).eq("invitation_status","accepted").maybeSingle();if(!i&&r?.permissions&&r.permissions.length>0)return console.log("\u2705 Permissions loaded from staff table:",r.permissions),r.permissions;let{data:s,error:a}=yield this.supabaseService.getSupabaseClient().from("restaurant_role_permissions").select("permissions").eq("restaurant_id",e).eq("role",t).maybeSingle();return!a&&s?.permissions&&s.permissions.length>0?(console.log("\u2705 Permissions loaded from role_permissions table:",s.permissions),s.permissions):(console.log("\u{1F4ED} No custom permissions found, using defaults for role:",t),this.getDefaultPermissionsForRole(t))}catch(r){return console.error("\u274C Error in getPermissionsForRole:",r),this.getDefaultPermissionsForRole(t)}})}getDefaultPermissionsForRole(e){return{manager:["view_dashboard","manage_menu","manage_orders","manage_reservations","view_reports","view_kitchen_display","manage_inventory","view_expenses","view_table_map","take_orders","manage_restaurant_settings","manage_staff"],chef:["view_dashboard","view_kitchen_display","manage_inventory","view_expenses"],waiter:["view_dashboard","manage_reservations","take_orders"],kitchen_staff:["view_kitchen_display"]}[e]||[]}hasPermission(e){return this.userPermissionsSubject.getValue().includes(e)}hasAnyPermission(e){let t=this.userPermissionsSubject.getValue();return e.some(r=>t.includes(r))}hasAllPermissions(e){let t=this.userPermissionsSubject.getValue();return e.every(r=>t.includes(r))}getCurrentPermissions(){return this.userPermissionsSubject.getValue()}setPermissions(e){this.userPermissionsSubject.next(e)}canAccessRoute(e){return!e||e.length===0?!0:this.hasAnyPermission(e)}reloadPermissions(e,t,r,i,s){return n(this,null,function*(){yield this.loadUserPermissions(e,t,r,i,s)})}isOwner(){return!1}static \u0275fac=function(t){return new(t||l)};static \u0275prov=f({token:l,factory:l.\u0275fac,providedIn:"root"})};var g=class l{supabaseService=c(p);router=c(h);permissionService=c(d);currentUserSubject=new u(null);currentStaffSubject=new u(null);currentRestaurantSubject=new u(null);currentContextSubject=new u("customer");allStaffRecordsSubject=new u([]);authInitialized=!1;currentUser$=this.currentUserSubject.asObservable();currentStaff$=this.currentStaffSubject.asObservable();currentRestaurant$=this.currentRestaurantSubject.asObservable();currentContext$=this.currentContextSubject.asObservable();allStaffRecords$=this.allStaffRecordsSubject.asObservable();constructor(){this.initializeAuth()}initializeAuth(){return n(this,null,function*(){try{let{data:{session:e}}=yield this.supabaseService.getSession();e?.user?(this.currentUserSubject.next(e.user),yield this.loadUserData(e.user.id)):this.currentUserSubject.next(null)}catch(e){console.warn("\u26A0\uFE0F Auth init had issues:",e),this.currentUserSubject.next(null)}finally{this.authInitialized=!0}})}loadUserData(e){return n(this,null,function*(){try{let t=yield this.findOwnedRestaurant(e);if(t){this.currentRestaurantSubject.next(t);let s={id:`owner-${e}`,restaurant_id:t.id,user_id:e,role:"owner",permissions:{},invitation_status:"accepted"};this.currentStaffSubject.next(s),this.setContext("staff"),yield this.loadPermissions();return}let r=yield this.findStaffMembership(e);if(r){this.currentStaffSubject.next(r.staffRecord),this.currentRestaurantSubject.next(r.restaurant),this.setContext("staff"),yield this.loadPermissions();return}if(yield this.findSupplierMembership(e)){this.setContext("supplier"),yield this.loadPermissions();return}this.setContext("customer"),yield this.loadPermissions()}catch(t){console.error("\u274C Error loading user data:",t),this.setContext("customer"),yield this.loadPermissions()}})}canBeSupplier(){return this.currentUserValue?this.isSupplierUser():!1}findOwnedRestaurant(e){return n(this,null,function*(){try{console.log("\u{1F50D} [FIX] findOwnedRestaurant - userId:",e);let{data:t,error:r}=yield this.supabaseService.getSupabaseClient().from("restaurants").select("id, name, owner_id, is_active").eq("owner_id",e).limit(1).maybeSingle();return console.log("\u{1F50D} [FIX] Result:",{data:t,error:r,hasData:!!t,isOwnerMatch:t?.owner_id===e}),r?r.code==="PGRST116"?(console.log("\u{1F4ED} No restaurant found for owner"),null):(console.error("\u274C [FIX] Error:",r),null):t}catch(t){return console.error("\u274C [FIX] Exception:",t),null}})}findStaffMembership(e){return n(this,null,function*(){try{let t=this.currentUserValue;if(!t?.email)return null;let{data:r,error:i}=yield this.supabaseService.getSupabaseClient().from("restaurant_staff").select("*").or(`user_id.eq.${e},email.eq.${t.email.toLowerCase()}`).in("invitation_status",["accepted","pending"]);if(i)return console.error("\u274C Error fetching staff records:",i),null;if(!r||r.length===0)return null;let s=r[0];if(s.invitation_status==="pending"&&!s.user_id){let{error:m}=yield this.supabaseService.getSupabaseClient().from("restaurant_staff").update({user_id:e,invitation_status:"accepted"}).eq("id",s.id);if(m)return console.error("\u274C Error updating staff record:",m),null;s.user_id=e,s.invitation_status="accepted"}this.allStaffRecordsSubject.next(r);let{data:a,error:o}=yield this.supabaseService.getSupabaseClient().from("restaurants").select("*").eq("id",s.restaurant_id).single();return o?(console.error("\u274C Error loading restaurant:",o),null):a?(console.log("\u2705 User is staff member:",s.role,"at",a.name),{staffRecord:s,restaurant:a}):null}catch(t){return console.error("\u274C Error in findStaffMembership:",t),null}})}login(e,t,r=!1){return n(this,null,function*(){try{let{data:i,error:s}=yield this.supabaseService.signIn(e,t);if(s)return console.error("\u274C Login error:",s),{data:null,error:s};if(i.user){this.currentUserSubject.next(i.user),yield this.loadUserData(i.user.id),yield this.loadPermissions(),r&&localStorage.setItem("rememberMe","true");let a=this.getCurrentContext(),o=a==="staff"?"/restaurant/dashboard":a==="supplier"?"/supplier/dashboard":"/customer";this.router.navigate([o])}return{data:i,error:s}}catch(i){return console.error("\u274C Login exception:",i),{data:null,error:i}}})}register(e){return n(this,null,function*(){try{let t=yield this.supabaseService.signUp(e);if(t.user&&!t.error){this.currentUserSubject.next(t.user),yield this.loadUserData(t.user.id),yield this.loadPermissions();let i=this.getCurrentContext()==="staff"?"/restaurant/dashboard":"/customer";this.router.navigate([i])}return t}catch(t){return console.error("\u274C Register exception:",t),{user:null,error:t,restaurant:null,supplier:null}}})}canBeStaff(){if(!this.currentUserValue)return!1;if(this.isOwner())return!0;let t=this.getCurrentStaff();return!!t&&t.invitation_status==="accepted"}loadStaffRecord(){return n(this,null,function*(){let e=this.currentUserValue;if(!e)return null;try{let{data:t,error:r}=yield this.supabaseService.getSupabaseClient().from("restaurant_staff").select("*").eq("email",e.email).eq("invitation_status","accepted").single();return r?(console.error("Error loading staff record:",r),null):t}catch(t){return console.error("Error in loadStaffRecord:",t),null}})}isOwner(){let e=this.currentUserValue,t=this.getCurrentRestaurant();return!!(e&&t&&t.owner_id===e.id)}getCurrentRestaurantId(){return this.getCurrentRestaurant()?.id||null}getStaffRole(){return this.getCurrentStaff()?.role||null}get currentUserValue(){return this.currentUserSubject.getValue()}getCurrentStaff(){return this.currentStaffSubject.getValue()}getCurrentRestaurant(){return this.currentRestaurantSubject.getValue()}getCurrentContext(){return this.currentContextSubject.value}setContext(e){this.currentContextSubject.next(e)}isAuthenticated(){return this.authInitialized&&!!this.currentUserValue}waitForAuthInit(){return n(this,null,function*(){return this.authInitialized?!0:new Promise(e=>{let t=()=>{this.authInitialized?e(!0):setTimeout(t,100)};t()})})}logout(){return n(this,null,function*(){try{yield this.supabaseService.signOut()}catch(e){console.warn("Logout error",e)}this.currentUserSubject.next(null),this.currentStaffSubject.next(null),this.currentRestaurantSubject.next(null),this.setContext("customer"),this.router.navigate(["/login"])})}refreshUserData(){return n(this,null,function*(){let e=this.currentUserValue;e&&(yield this.loadUserData(e.id))})}isRestaurantUser(){return this.getCurrentContext()==="staff"}isManager(){return this.getStaffRole()==="manager"}isChef(){return this.getStaffRole()==="chef"}isWaiter(){return this.getStaffRole()==="waiter"}getAvailableContexts(){let e=["customer"];return this.canBeStaff()&&e.push("staff"),this.isSupplierUser()&&e.push("supplier"),e}switchContext(e){return n(this,null,function*(){try{return this.getAvailableContexts().includes(e)?(this.setContext(e),yield this.loadPermissions(),!0):(console.error("\u274C Context not available:",e),!1)}catch(t){return console.error("\u274C Error switching context:",t),!1}})}initializeStaffStatus(){return n(this,null,function*(){if(this.isAuthenticated()){let e=yield this.loadStaffRecord();this.currentStaffSubject.next(e)}})}onUserLoggedIn(){return n(this,null,function*(){yield this.initializeStaffStatus(),yield this.loadPermissions()})}isSupplierUser(){return this.getCurrentContext()==="supplier"}isCustomerUser(){return this.getCurrentContext()==="customer"}getUserRole(){let e=this.getCurrentContext();if(!this.currentUserValue)return null;switch(e){case"staff":return this.isOwner()?"restaurant_owner":this.getStaffRole();case"supplier":return"supplier";case"customer":default:return"customer"}}refreshStaffData(){return n(this,null,function*(){let e=this.currentUserValue;if(!e)return;let t=yield this.findStaffMembership(e.id);t?(this.currentStaffSubject.next(t.staffRecord),this.currentRestaurantSubject.next(t.restaurant),this.setContext("staff")):console.log("\u{1F4ED} No staff data found after refresh")})}hasPermission(e){return this.permissionService.hasPermission(e)}hasAnyPermission(e){return this.permissionService.hasAnyPermission(e)}hasAnyPermissions(){let e=this.permissionService.getCurrentPermissions();return e&&e.length>0}loadPermissions(){return n(this,null,function*(){try{let e=this.currentUserValue,t=this.getCurrentRestaurantId(),r=this.isOwner(),i=this.getStaffRole(),s=this.isSupplierUser();console.log("\u{1F50D} DEBUG loadPermissions - Parametri:",{userId:e?.id,restaurantId:t,isOwner:r,staffRole:i,isSupplier:s}),yield this.permissionService.loadUserPermissions(e?.id||null,t,r,i,s);let a=this.permissionService.getCurrentPermissions()}catch{}})}refreshPermissions(){return n(this,null,function*(){let e=this.currentUserValue;e&&(yield this.loadUserData(e.id))})}reloadCurrentUserPermissions(){return n(this,null,function*(){if(console.log("\u{1F504} AuthService: Ricaricamento permessi utente corrente"),!this.currentUserValue)return;let t=yield this.loadStaffRecord();t&&(this.currentStaffSubject.next(t),console.log("\u2705 Record staff ricaricato:",t.permissions)),yield this.loadPermissions()})}isStaff(){return!!this.getCurrentStaff()&&this.getCurrentStaff()?.invitation_status==="accepted"}getCurrentStaffRestaurantId(){if(this.isOwner())return this.getCurrentRestaurantId();let e=this.getCurrentStaff();return e&&e.invitation_status==="accepted"?e.restaurant_id:null}getCurrentPermissions(){return this.permissionService.getCurrentPermissions()}printStaffDebugInfo(){console.log("\u{1F50D} AuthService Staff Debug:",{currentUser:this.currentUserValue?.id,currentStaff:this.getCurrentStaff(),isOwner:this.isOwner(),isStaff:this.isStaff(),staffRestaurantId:this.getCurrentStaffRestaurantId(),currentRestaurantId:this.getCurrentRestaurantId(),context:this.getCurrentContext(),permissions:this.getCurrentPermissions()})}findSupplierMembership(e){return n(this,null,function*(){try{console.log("\u{1F50D} Searching supplier membership for:",e);let{data:t,error:r}=yield this.supabaseService.getSupabaseClient().from("suppliers").select("*").eq("user_id",e).single();return r?r.code==="PGRST116"?(console.log("\u{1F4ED} No supplier record found"),null):(console.error("\u274C Error fetching supplier record:",r),null):(console.log("\u2705 Supplier record found:",t),t)}catch(t){return console.error("\u274C Error in findSupplierMembership:",t),null}})}static \u0275fac=function(t){return new(t||l)};static \u0275prov=f({token:l,factory:l.\u0275fac,providedIn:"root"})};export{d as a,g as b};
