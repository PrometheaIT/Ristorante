import{a as p}from"./chunk-3SRQJDPW.js";import{V as u,_ as g,na as h}from"./chunk-UNLQURJ5.js";import{a as w,b as I,j as o}from"./chunk-4ZZIO3ZI.js";var y=class s extends p{getTableName(){return"comande"}hasRestaurantId(){return!0}createForOrderHeader(r,e){return o(this,null,function*(){try{if(r.startsWith("draft-"))return console.error("\u274C Tentativo di creare comanda per order header draft:",r),console.log("\u26A0\uFE0F Questa operazione dovrebbe essere gestita in locale fino al salvataggio"),null;let t=yield this.getCurrentRestaurantId();if(!t)return console.error("\u274C Nessun restaurantId"),null;let{data:a,error:n}=yield this.supabaseService.getSupabaseClient().from("order_headers").select("*").eq("id",r).single();if(n)return console.error("\u274C Errore recupero order header:",n),null;if(!a)return console.error("\u274C Order header non trovato"),null;let i=e||(yield this.getNextComandaNumber(r)),m={order_number:`CMD-${a.order_number}-${i}`,restaurant_id:t,order_header_id:r,tavolata_id:r,comanda_number:i,table_id:a.table_id,customer_name:a.customer_name||"Cliente",customer_phone:a.customer_phone||"",status:"ordered",subtotal:0,tax_amount:0,discount_amount:0,total_amount:0,customer_notes:"",order_type:"dine_in"};console.log("\u{1F4E4} Creazione comanda nel database:",m);let{data:c,error:f}=yield this.supabaseService.getSupabaseClient().from(this.getTableName()).insert(m).select().single();return f?(console.error("\u274C Errore creazione comanda:",f),null):(console.log("\u2705 Comanda creata con successo:",c.id),c)}catch(t){return console.error("\u{1F4A5} ERRORE createForOrderHeader:",t),null}})}getNextComandaNumber(r){return o(this,null,function*(){try{if(r.startsWith("draft-"))return 1;let{data:e,error:t}=yield this.supabaseService.getSupabaseClient().from(this.getTableName()).select("comanda_number").eq("order_header_id",r).order("comanda_number",{ascending:!1}).limit(1);if(t)throw t;return e&&e.length>0?e[0].comanda_number+1:1}catch(e){return console.error("Errore calcolo prossima comanda:",e),1}})}loadByOrderHeaderId(r){return o(this,null,function*(){try{if(r.startsWith("draft-"))return console.log("\u26A0\uFE0F Tentativo di caricare comande per draft order header"),[];let{data:e,error:t}=yield this.supabaseService.getSupabaseClient().from(this.getTableName()).select("*").eq("order_header_id",r).order("comanda_number",{ascending:!0});if(t)throw t;return e||[]}catch(e){return console.error("Errore caricamento comande:",e),[]}})}updateStatus(r,e){return o(this,null,function*(){try{let{error:t}=yield this.supabaseService.getSupabaseClient().from(this.getTableName()).update({status:e,updated_at:new Date().toISOString()}).eq("id",r);return!t}catch(t){return console.error("Errore aggiornamento stato comanda:",t),!1}})}static \u0275fac=(()=>{let r;return function(t){return(r||(r=h(s)))(t||s)}})();static \u0275prov=u({token:s,factory:s.\u0275fac,providedIn:"root"})};var S=class s extends p{getTableName(){return"order_items"}hasRestaurantId(){return!0}addItemToComanda(r,e,t=1,a,n=""){return o(this,null,function*(){try{console.log("\u{1F504} OrderItemService.addItemToComanda chiamato",{comandaId:r,dishId:e,quantity:t,unitPrice:a});let i=yield this.getCurrentRestaurantId();if(!i)return console.error("\u274C Nessun restaurantId"),null;let d={order_id:r,dish_id:e,quantity:t,unit_price:a,item_notes:n||"",status:"ordered",restaurant_id:i};console.log("\u{1F4E4} Insert order item con dati (senza total_price):",d);let{data:m,error:c}=yield this.supabaseService.getSupabaseClient().from(this.getTableName()).insert(d).select().single();if(c)return console.error("\u274C ERRORE INSERT:",{message:c.message,details:c.details,hint:c.hint,code:c.code}),null;console.log("\u2705 Order item inserito:",m);let f=yield this.getDishName(e);return I(w({},m),{dish_name:f,comanda_id:m.order_id,total_price:a*t})}catch(i){return console.error("\u{1F4A5} Errore critico:",i),null}})}getDishName(r){return o(this,null,function*(){try{let{data:e,error:t}=yield this.supabaseService.getSupabaseClient().from("dishes").select("name").eq("id",r).single();return t||!e?(console.warn("\u26A0\uFE0F Impossibile recuperare nome piatto:",t),"Piatto"):e.name}catch(e){return console.error("Errore recupero nome piatto:",e),"Piatto"}})}loadByComandaId(r){return o(this,null,function*(){try{let{data:e,error:t}=yield this.supabaseService.getSupabaseClient().from("order_items").select(`
          *,
          dish:dish_id(name)
        `).eq("order_id",r).order("created_at",{ascending:!0});if(t)throw t;return(e||[]).map(a=>I(w({},a),{dish_name:a.dish?.name||"Piatto",comanda_id:a.order_id}))}catch(e){return console.error("Errore caricamento order_items:",e),[]}})}updateQuantity(r,e){return o(this,null,function*(){try{let{error:t}=yield this.supabaseService.getSupabaseClient().from(this.getTableName()).update({quantity:e,updated_at:new Date().toISOString()}).eq("id",r);if(t)throw t;return!0}catch(t){return console.error("Errore aggiornamento quantit\xE0:",t),!1}})}delete(r){return o(this,null,function*(){try{let{error:e}=yield this.supabaseService.getSupabaseClient().from(this.getTableName()).delete().eq("id",r);if(e)throw e;let a=this.dataSubject.value.filter(n=>n.id!==r);return this.dataSubject.next(a),!0}catch(e){return console.error("Errore eliminazione order item:",e),this.errorSubject.next(e.message),!1}})}updateItemStatus(r,e){return o(this,null,function*(){try{let{error:t}=yield this.supabaseService.getSupabaseClient().from(this.getTableName()).update({status:e,updated_at:new Date().toISOString()}).eq("id",r);if(t)throw t;return!0}catch(t){return console.error("Errore aggiornamento stato item:",t),!1}})}updateAllItemsStatus(r,e){return o(this,null,function*(){try{let t=yield this.loadByComandaId(r),a=!0;for(let n of t)(yield this.updateItemStatus(n.id,e))||(a=!1);return a}catch(t){return console.error("Errore aggiornamento stati piatti:",t),!1}})}static \u0275fac=(()=>{let r;return function(t){return(r||(r=h(s)))(t||s)}})();static \u0275prov=u({token:s,factory:s.\u0275fac,providedIn:"root"})};var b=class s{orderHeaderService=g(v);comandaService=g(y);orderItemService=g(S);occupyTable(r,e){return o(this,null,function*(){try{let t=yield this.orderHeaderService.createForTable(r,e);if(!t)return{orderHeader:null,comanda:null};let a=yield this.comandaService.createForOrderHeader(t.id,1);return{orderHeader:t,comanda:a}}catch(t){return console.error("\u274C Errore occupazione tavolo:",t),{orderHeader:null,comanda:null}}})}loadFullOrder(r){return o(this,null,function*(){try{let e=yield this.orderHeaderService.getByIdAsync(r);if(!e)return null;let t=yield this.comandaService.loadByOrderHeaderId(r);for(let a of t){let n=yield this.orderItemService.loadByComandaId(a.id);a.order_items=n}return e.comande=t,e}catch(e){return console.error("\u274C Errore caricamento ordine completo:",e),null}})}addDishToTable(r,e,t,a,n=1,i=""){return o(this,null,function*(){try{let d=yield this.orderHeaderService.getActiveByTable(r);if(!d){let l=yield this.occupyTable(r,"Cliente");if(!l.orderHeader||!l.comanda)return!1;d=l.orderHeader}let c=(yield this.comandaService.loadByOrderHeaderId(d.id)).find(l=>l.status!=="cancelled");if(!c){let l=yield this.comandaService.createForOrderHeader(d.id);if(!l)return!1;c=l}return!!(yield this.orderItemService.addItemToComanda(c.id,e,n,a,i))}catch(d){return console.error("\u274C Errore aggiunta piatto:",d),!1}})}createComandaForOrderHeader(r){return o(this,null,function*(){try{return yield this.comandaService.createForOrderHeader(r)}catch(e){return console.error("\u274C Errore creazione comanda:",e),null}})}updateItemQuantity(r,e){return o(this,null,function*(){try{return yield this.orderItemService.updateQuantity(r,e)}catch(t){return console.error("\u274C Errore aggiornamento quantit\xE0:",t),!1}})}removeItem(r){return o(this,null,function*(){try{return yield this.orderItemService.delete(r)}catch(e){return console.error("\u274C Errore rimozione piatto:",e),!1}})}closeTavolata(r){return o(this,null,function*(){try{return yield this.orderHeaderService.closeHeader(r)}catch(e){return console.error("\u274C Errore chiusura tavolata:",e),!1}})}updateComandaStatus(r,e){return o(this,null,function*(){try{return["ordered","waiting","preparing","ready","served","cancelled"].includes(e)?yield this.comandaService.update(r,{status:e,updated_at:new Date().toISOString()}):(console.error("\u274C Stato non valido:",e),!1)}catch(t){return console.error("\u274C Errore aggiornamento stato comanda:",t),!1}})}static \u0275fac=function(e){return new(e||s)};static \u0275prov=u({token:s,factory:s.\u0275fac,providedIn:"root"})};var v=class s extends p{getTableName(){return"order_headers"}hasRestaurantId(){return!0}createForTable(r,e){return o(this,null,function*(){try{let t=yield this.getCurrentRestaurantId();if(!t)return console.error("\u274C Restaurant ID non trovato"),null;let a=yield this.generateOrderNumber(),n={restaurant_id:t,table_id:r,order_number:a,status:"active",customer_name:e||"Cliente",total_amount:0};console.log("\u{1F4E4} Creazione OrderHeader (tavolata):",n);let{data:i,error:d}=yield this.supabaseService.getSupabaseClient().from(this.getTableName()).insert(n).select().single();return d?(console.error("\u274C Errore creazione order header:",d),null):i}catch(t){return console.error("\u274C Errore creazione order header:",t),null}})}generateOrderNumber(){return o(this,null,function*(){let r=new Date,e=r.getFullYear().toString().slice(-2),t=(r.getMonth()+1).toString().padStart(2,"0"),a=r.getDate().toString().padStart(2,"0"),n=Math.floor(Math.random()*1e3).toString().padStart(3,"0");return`TAV-${e}${t}${a}-${n}`})}getActiveByTable(r){return o(this,null,function*(){try{let e=yield this.getCurrentRestaurantId();if(!e)return null;let{data:t,error:a}=yield this.supabaseService.getSupabaseClient().from("order_headers").select("*").eq("restaurant_id",e).eq("table_id",r).in("status",["active","open","pending"]).order("created_at",{ascending:!1}).limit(1);return a?(console.error("\u274C Errore query order_headers:",a),null):t&&t.length>0?t[0]:null}catch(e){return console.error("\u274C Errore getActiveByTable:",e),null}})}closeTavolata(r){return o(this,null,function*(){return yield this.update(r,{status:"completed",updated_at:new Date().toISOString()})})}getByIdAsync(r){return o(this,null,function*(){try{let{data:e,error:t}=yield this.supabaseService.getSupabaseClient().from(this.getTableName()).select("*").eq("id",r).single();if(t)throw t;return e}catch(e){return console.error("Errore getById:",e),null}})}closeAllActiveHeadersForTable(r){return o(this,null,function*(){try{let e=yield this.getCurrentRestaurantId();if(!e)return!1;let{error:t}=yield this.supabaseService.getSupabaseClient().from(this.getTableName()).update({status:"completed",updated_at:new Date().toISOString()}).eq("restaurant_id",e).eq("table_id",r).eq("status","active");return!t}catch(e){return console.error("Errore chiusura order headers:",e),!1}})}closeHeader(r){return o(this,null,function*(){return yield this.update(r,{status:"completed",updated_at:new Date().toISOString()})})}getActiveOrderHeaderByTable(r){return o(this,null,function*(){return this.getActiveByTable(r)})}loadWithDetails(r){return o(this,null,function*(){try{return yield g(b).loadFullOrder(r)}catch(e){return console.error("Errore loadWithDetails:",e),null}})}getTableOrderItemsCount(r){return o(this,null,function*(){try{let e=yield this.getActiveByTable(r);if(!e)return 0;let a=yield g(b).loadFullOrder(e.id);if(!a||!a.comande)return 0;let n=0;for(let i of a.comande)i.order_items&&(n+=i.order_items.length);return n}catch(e){return console.error("Errore getTableOrderItemsCount:",e),0}})}static \u0275fac=(()=>{let r;return function(t){return(r||(r=h(s)))(t||s)}})();static \u0275prov=u({token:s,factory:s.\u0275fac,providedIn:"root"})};export{y as a,S as b,b as c,v as d};
