import{a as u,b as m}from"./chunk-HVLDBW5V.js";import{a as l}from"./chunk-3F4CDTNS.js";import{ba as d,ga as i,h as n,va as c}from"./chunk-2FS7XGGJ.js";var g=class s extends l{comandaService=i(u);orderItemService=i(m);getTableName(){return"order_headers"}hasRestaurantId(){return!0}createForTable(t,e){return n(this,null,function*(){try{let r=yield this.getCurrentRestaurantId();if(!r)return null;let a=yield this.generateOrderNumber(r),o={restaurant_id:r,table_id:t,order_number:a,status:"active",customer_name:e||"Cliente",total_amount:0};return console.log("\u{1F4E4} Creazione OrderHeader:",o),yield this.create(o)}catch(r){return console.error("Errore creazione order header:",r),null}})}generateOrderNumber(t){return n(this,null,function*(){let e=new Date,r=e.getFullYear().toString().slice(-2),a=(e.getMonth()+1).toString().padStart(2,"0"),o=e.getDate().toString().padStart(2,"0");return`ORD-${r}${a}${o}-${Date.now().toString().slice(-4)}`})}loadWithDetails(t){return n(this,null,function*(){try{let e=yield this.getByIdAsync(t);if(!e)return null;let r=yield this.comandaService.loadByOrderHeaderId(t);for(let a of r){let o=yield this.orderItemService.loadByComandaId(a.id);a.order_items=o}return e.comande=r,e}catch(e){return console.error("Errore caricamento dettagli:",e),null}})}getByIdAsync(t){return n(this,null,function*(){try{let{data:e,error:r}=yield this.supabaseService.getSupabaseClient().from(this.getTableName()).select("*").eq("id",t).single();if(r)throw r;return e}catch(e){return console.error("Errore getById:",e),null}})}closeHeader(t){return n(this,null,function*(){return yield this.update(t,{status:"completed",updated_at:new Date().toISOString()})})}getActiveOrderHeaderByTable(t){return n(this,null,function*(){try{let e=yield this.getCurrentRestaurantId();if(!e)return null;let{data:r,error:a}=yield this.supabaseService.getSupabaseClient().from("order_headers").select(`
          id,
          restaurant_id,
          table_id,
          order_number,
          status,
          customer_name,
          customer_phone,
          total_amount,
          created_at,
          updated_at
        `).eq("restaurant_id",e).eq("table_id",t).eq("status","active").order("created_at",{ascending:!1}).limit(1).single();return a?(a.code==="PGRST116"||console.error("\u274C Errore query order_headers:",a),null):r}catch(e){return console.error("\u274C Errore getActiveOrderHeaderByTable:",e),null}})}closeAllActiveHeadersForTable(t){return n(this,null,function*(){try{let e=yield this.getCurrentRestaurantId();if(!e)return console.error("\u274C Restaurant ID non trovato"),!1;console.log(`\u{1F504} Chiusura order headers per tavolo ${t}`);let{data:r,error:a}=yield this.supabaseService.getSupabaseClient().from("order_headers").select("id, order_number").eq("restaurant_id",e).eq("table_id",t).eq("status","active");if(a)return console.error("\u274C Errore recupero order headers:",a),!1;if(!r||r.length===0)return console.log("\u2705 Nessun order header attivo da chiudere"),!0;console.log(`\u{1F4CB} Trovati ${r.length} order headers attivi da chiudere`);let{error:o}=yield this.supabaseService.getSupabaseClient().from("order_headers").update({status:"completed",updated_at:new Date().toISOString()}).eq("restaurant_id",e).eq("table_id",t).eq("status","active");return o?(console.error("\u274C Errore chiusura order headers:",o),!1):(console.log(`\u2705 ${r.length} order headers chiusi con successo`),!0)}catch(e){return console.error("\u274C Errore generale nella chiusura:",e),!1}})}getTableOrderItemsCount(t){return n(this,null,function*(){try{let e=yield this.getActiveOrderHeaderByTable(t);if(!e)return console.log(`\u{1F4CA} Nessun order header attivo per il tavolo ${t}`),0;console.log(`\u{1F4CA} Order header trovato: ${e.id} per tavolo ${t}`);let r=yield this.loadWithDetails(e.id);if(!r||!r.comande)return console.log(`\u{1F4CA} Nessuna comanda trovata per l'order header ${e.id}`),0;let a=0;for(let o of r.comande)o.order_items&&o.order_items.length>0&&(a+=o.order_items.length);return console.log(`\u{1F4CA} Totale piatti per tavolo ${t}: ${a}`),a}catch(e){return console.error("\u274C Errore nel conteggio dei piatti:",e),0}})}static \u0275fac=(()=>{let t;return function(r){return(t||(t=c(s)))(r||s)}})();static \u0275prov=d({token:s,factory:s.\u0275fac,providedIn:"root"})};export{g as a};
