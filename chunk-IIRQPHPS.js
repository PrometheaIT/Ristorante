import{a as h}from"./chunk-4RQOBPFF.js";import{b as D}from"./chunk-L3BVOY7C.js";import{B as u,a as l,b as d,ba as v,ga as p,h as n}from"./chunk-G3XPJWB3.js";var m=class extends h{getTableName(){return"menus"}},g=class extends h{getTableName(){return"menu_dishes"}loadData(e){return n(this,null,function*(){try{this.loadingSubject.next(!0),this.errorSubject.next(null);let t=this.supabaseService.getSupabaseClient().from(this.getTableName()).select("*");e&&Object.keys(e).forEach(i=>{let a=e[i];a!=null&&(t=t.eq(i,a))});let{data:r,error:s}=yield t;if(s)throw s;this.dataSubject.next(r??[])}catch(t){console.error(`Error loading ${this.getTableName()}:`,t),this.errorSubject.next(t.message??"Errore sconosciuto"),this.dataSubject.next([])}finally{this.loadingSubject.next(!1)}})}create(e){return n(this,null,function*(){this.loadingSubject.next(!0),this.errorSubject.next(null);try{let t=new Date().toISOString(),r=d(l({},e),{created_at:t,updated_at:t}),{data:s,error:i}=yield this.supabaseService.getSupabaseClient().from(this.getTableName()).insert(r).select().single();if(i)throw i.code==="23505"?new Error("Il piatto \xE8 gi\xE0 presente in questo menu"):i.code==="23503"?new Error("Menu o piatto non trovato"):i;return yield this.loadData(e.menu_id?{menu_id:e.menu_id}:void 0),s}catch(t){return console.error("\u274C ERRORE durante create:",t),this.errorSubject.next(t.message??"Errore creazione"),null}finally{this.loadingSubject.next(!1)}})}},M=class o{supabase=p(D);menuService;menuDishService;constructor(){this.menuService=new m,this.menuDishService=new g}loadData(){return n(this,null,function*(){yield this.menuService.loadData()})}loadMenus(){return n(this,null,function*(){yield this.menuService.loadData()})}get data$(){return this.menuService.data$}get menus$(){return this.menuService.data$}get menusLoading$(){return this.menuService.loading$}get menusError$(){return this.menuService.error$}createMenu(e,t,r=!1,s="global"){return n(this,null,function*(){let i={name:e,description:t,is_default:r,is_active:!0,display_order:0,type:s,is_favorite:!1},a=yield this.menuService.create(i);return a&&r&&(yield this.setAsDefault(a.id)),a})}createDedicatedMenu(e,t){return n(this,null,function*(){return this.createMenu(e,t,!1,"dedicated")})}setAsDefault(e){return n(this,null,function*(){try{let r=(this.getCurrentMenus()||[]).filter(i=>i.is_default&&i.id!==e).map(i=>this.menuService.update(i.id,{is_default:!1}));yield Promise.all(r);let s=yield this.menuService.update(e,{is_default:!0,is_active:!0});return s&&(yield this.loadMenus()),s}catch(t){return console.error("Errore impostazione default:",t),!1}})}toggleMenuActive(e){return n(this,null,function*(){let r=this.getCurrentMenus().find(i=>i.id===e);if(!r||r.is_default)return!1;let s=yield this.menuService.update(e,{is_active:!r.is_active});return s&&(yield this.loadMenus()),s})}getDefaultActiveMenu$(){return this.menus$.pipe(u(e=>e.find(r=>r.is_default&&r.is_active)||(e.length>0?e[0]:null)))}getActiveMenus$(){return this.menus$.pipe(u(e=>e.filter(t=>t.is_active)))}getGlobalMenus$(){return this.menus$.pipe(u(e=>e.filter(t=>t.is_active&&t.type==="global")))}getDedicatedMenus$(){return this.menus$.pipe(u(e=>e.filter(t=>t.is_active&&t.type==="dedicated")))}getMenuById(e){return n(this,null,function*(){try{let{data:t,error:r}=yield this.supabase.getSupabaseClient().from("menus").select("*").eq("id",e).single();if(r)throw r;return t}catch(t){return console.error("Errore recupero menu:",t),null}})}updateMenu(e,t){return n(this,null,function*(){let r=yield this.menuService.update(e,t);return r&&(yield this.loadMenus()),r})}delete(e){return n(this,null,function*(){return this.deleteMenu(e)})}deleteMenu(e){return n(this,null,function*(){return(yield this.getMenuById(e))?.is_default?!1:this.menuService.delete(e)})}loadMenuDishes(e){return n(this,null,function*(){let t=e?{menu_id:e}:void 0;yield this.menuDishService.loadData(t)})}get menuDishes$(){return this.menuDishService.data$}get menuDishesData$(){return this.menuDishService.data$}get menuDishesLoading$(){return this.menuDishService.loading$}get menuDishesError$(){return this.menuDishService.error$}addDishToMenu(e,t,r,s=0){return n(this,null,function*(){if(this.getCurrentMenuDishes().find(c=>c.menu_id===e&&c.dish_id===t&&c.is_active))throw new Error("Il piatto \xE8 gi\xE0 presente in questo menu");let f={menu_id:e,dish_id:t,display_order:s,is_active:!0};r&&r.trim()!==""&&(f.category_id=r);let b=yield this.menuDishService.create(f);return b&&(yield this.loadMenuDishes(e)),b})}removeDishFromMenu(e){return n(this,null,function*(){return this.updateMenuDish(e,{is_active:!1})})}updateMenuDish(e,t){return n(this,null,function*(){let r=yield this.menuDishService.update(e,d(l({},t),{updated_at:new Date().toISOString()}));if(r){let i=this.getCurrentMenuDishes().find(a=>a.id===e);i?.menu_id&&(yield this.loadMenuDishes(i.menu_id))}return r})}updateDishOrder(e,t){return n(this,null,function*(){return this.updateMenuDish(e,{display_order:t})})}getDishesByMenu$(e){return this.menuDishes$.pipe(u(t=>t.filter(r=>r.menu_id===e&&r.is_active)))}getDishesWithDetailsByMenu(e){return n(this,null,function*(){try{let{data:t,error:r}=yield this.supabase.getSupabaseClient().from("menu_dishes").select(`
          *,
          dish:dishes!dish_id (
            id,
            name,
            description,
            base_price,
            image_url,
            status,
            category_id,
            preparation_time
          ),
          category:categories!category_id (
            id,
            name
          )
        `).eq("menu_id",e).eq("is_active",!0).order("display_order");if(r)throw r;return(t||[]).filter(s=>s.dish&&!s.dish.deleted_at)}catch(t){return console.error("Errore recupero piatti dettagliati:",t),[]}})}removeAllDishesFromMenu(e){return n(this,null,function*(){try{let{error:t}=yield this.supabase.getSupabaseClient().from("menu_dishes").update({is_active:!1,updated_at:new Date().toISOString()}).eq("menu_id",e).eq("is_active",!0);if(t)throw t;return yield this.loadMenuDishes(e),!0}catch(t){return console.error("\u274C Errore rimozione piatti dal menu:",t),!1}})}getCurrentMenus(){return this.menuService.data||[]}getCurrentMenuDishes(){return this.menuDishService.data||[]}isDishInMenu(e,t){return this.getCurrentMenuDishes().some(s=>s.menu_id===e&&s.dish_id===t&&s.is_active)}getNextDisplayOrder(e){let r=this.getCurrentMenuDishes().filter(i=>i.menu_id===e);return r.length===0?0:Math.max(...r.map(i=>i.display_order))+1}refreshAll(){return n(this,null,function*(){yield Promise.all([this.loadMenus(),this.loadMenuDishes()])})}static \u0275fac=function(t){return new(t||o)};static \u0275prov=v({token:o,factory:o.\u0275fac,providedIn:"root"})};export{M as a};
