import{a as _}from"./chunk-KNL3CWA3.js";import{A as p}from"./chunk-DCWKKS33.js";import{$ as m,G as d,M as S,a as u,b as c,ea as f,f as n,m as l}from"./chunk-K5RDB55Y.js";var g=class o{supabaseService=f(p);authService=f(_);shiftsSubject=new l([]);shifts$=this.shiftsSubject.asObservable();constructor(){this.authService.currentUser$.pipe(d(t=>!!t),S(1)).subscribe(()=>{this.loadShifts()})}loadShifts(){return n(this,null,function*(){try{let t=this.authService.currentUserValue;if(!t)return;let{data:e,error:r}=yield this.supabaseService.getSupabaseClient().from("restaurants").select("id").eq("owner_id",t.id).limit(1);if(r||!e||e.length===0){console.error("\u274C No restaurant found for user:",t.id);return}let a=e[0].id,{data:s,error:i}=yield this.supabaseService.getSupabaseClient().from("shifts").select("*").eq("restaurant_id",a).order("start_time");if(i){console.error("Error loading shifts:",i);return}if(!s||s.length===0){yield this.createDefaultShifts(a),yield this.loadShifts();return}this.shiftsSubject.next(s)}catch(t){console.error("Error in loadShifts:",t)}})}createDefaultShifts(t){return n(this,null,function*(){let e=[{restaurant_id:t,name:"Pranzo",start_time:"12:00:00",end_time:"15:00:00",days_of_week:[1,2,3,4,5,6,7],is_active:!0},{restaurant_id:t,name:"Cena",start_time:"19:00:00",end_time:"23:00:00",days_of_week:[1,2,3,4,5,6,7],is_active:!0}];try{let{error:r}=yield this.supabaseService.getSupabaseClient().from("shifts").insert(e);if(r)throw r;console.log("\u2705 Default shifts created")}catch(r){console.error("\u274C Error creating default shifts:",r)}})}getShifts(){return this.shiftsSubject.value}getCurrentShift(){let t=new Date,e=t.toTimeString().split(" ")[0],r=t.getDay(),a=r===0?7:r,s=this.getShifts().filter(i=>i.is_active);for(let i of s)if(i.days_of_week.includes(a)&&e>=i.start_time&&e<=i.end_time)return i;return null}createShift(t){return n(this,null,function*(){try{let e=this.authService.currentUserValue;if(!e)return null;let{data:r,error:a}=yield this.supabaseService.getSupabaseClient().from("restaurants").select("id").eq("owner_id",e.id).limit(1);if(a||!r||r.length===0)return console.error("\u274C No restaurant found for user:",e.id),null;let s=r[0].id,{data:i,error:h}=yield this.supabaseService.getSupabaseClient().from("shifts").insert(c(u({},t),{restaurant_id:s})).select().single();if(h)throw h;return yield this.loadShifts(),i}catch(e){return console.error("Error creating shift:",e),null}})}updateShift(t,e){return n(this,null,function*(){try{let{error:r}=yield this.supabaseService.getSupabaseClient().from("shifts").update(c(u({},e),{updated_at:new Date().toISOString()})).eq("id",t);if(r)throw r;return yield this.loadShifts(),!0}catch(r){return console.error("Error updating shift:",r),!1}})}static \u0275fac=function(e){return new(e||o)};static \u0275prov=m({token:o,factory:o.\u0275fac,providedIn:"root"})};export{g as a};
