import{b}from"./chunk-OPNETFGM.js";import{b as w}from"./chunk-L3BVOY7C.js";import{J as S,O as p,a as d,b as h,ba as v,ga as g,h as c,o as m}from"./chunk-G3XPJWB3.js";var _=class f{supabaseService=g(w);authService=g(b);shiftsSubject=new m([]);shifts$=this.shiftsSubject.asObservable();constructor(){this.authService.currentUser$.pipe(S(e=>!!e),p(1)).subscribe(()=>{this.loadShifts()})}loadShifts(){return c(this,null,function*(){try{let e=yield this.getCurrentRestaurantId();if(!e){console.error("\u274C No restaurant found");return}let{data:t,error:r}=yield this.supabaseService.getSupabaseClient().from("shifts").select("*").eq("restaurant_id",e).order("start_time");if(r){console.error("Error loading shifts:",r);return}if(!t||t.length===0){yield this.createDefaultShifts(e),yield this.loadShifts();return}this.shiftsSubject.next(t)}catch(e){console.error("Error in loadShifts:",e)}})}createDefaultShifts(e){return c(this,null,function*(){let t=[{restaurant_id:e,name:"Pranzo",start_time:"12:00:00",end_time:"15:00:00",days_of_week:[1,2,3,4,5,6,7],is_active:!0},{restaurant_id:e,name:"Cena",start_time:"19:00:00",end_time:"23:00:00",days_of_week:[1,2,3,4,5,6,7],is_active:!0}];try{let{error:r}=yield this.supabaseService.getSupabaseClient().from("shifts").insert(t);if(r)throw r;console.log("\u2705 Default shifts created")}catch(r){console.error("\u274C Error creating default shifts:",r)}})}getShifts(){return this.shiftsSubject.value}getCurrentShift(){let e=new Date,t=e.toTimeString().split(" ")[0],r=e.getDay(),n=r===0?7:r,a=this.getShifts().filter(s=>s.is_active);for(let s of a)if(s.days_of_week.includes(n)&&t>=s.start_time&&t<=s.end_time)return s;return null}createShift(e){return c(this,null,function*(){try{let t=yield this.getCurrentRestaurantId();if(!t)return console.error("\u274C No restaurant found"),null;let{data:r,error:n}=yield this.supabaseService.getSupabaseClient().from("shifts").insert(h(d({},e),{restaurant_id:t})).select().single();if(n)throw n;return yield this.loadShifts(),r}catch(t){return console.error("Error creating shift:",t),null}})}updateShift(e,t){return c(this,null,function*(){try{let{error:r}=yield this.supabaseService.getSupabaseClient().from("shifts").update(h(d({},t),{updated_at:new Date().toISOString()})).eq("id",e);if(r)throw r;return yield this.loadShifts(),!0}catch(r){return console.error("Error updating shift:",r),!1}})}getCurrentRestaurantId(){return c(this,null,function*(){let e=this.authService.getCurrentStaffRestaurantId();if(e)return e;let t=this.authService.currentUserValue;if(!t)return null;let{data:r}=yield this.supabaseService.getSupabaseClient().from("restaurants").select("id").eq("owner_id",t.id).limit(1).single();return r?.id||null})}deleteShift(e){return c(this,null,function*(){try{let{error:t}=yield this.supabaseService.getSupabaseClient().from("shifts").delete().eq("id",e);if(t)throw t;return yield this.loadShifts(),!0}catch(t){return console.error("Error deleting shift:",t),!1}})}isWithinShiftWithBuffer(){let e=new Date,t=e.toTimeString().split(" ")[0],r=e.getDay(),n=r===0?7:r,a=e.toISOString().split("T")[0],s=this.getShifts().filter(o=>o.is_active);if(!s.some(o=>o.days_of_week.includes(n)))return{allowed:!1,reason:"Nessun turno attivo oggi"};for(let o of s)if(o.days_of_week.includes(n)){let u=this.subtractHour(o.start_time,1),l=this.addHour(o.end_time,1);if(t>=u&&t<=l)return{allowed:!0,reason:`Turno: ${o.name}`}}return{allowed:!1,reason:"Fuori orario dei turni"}}getOrderingStatus(){let e=new Date,t=e.toTimeString().split(" ")[0],r=e.getDay(),n=r===0?7:r;console.log("\u{1F50D} DEBUG getOrderingStatus:"),console.log("- Ora attuale:",t),console.log("- Giorno della settimana (1-7):",n);let a=this.getShifts().filter(i=>i.is_active&&i.days_of_week.includes(n));if(console.log("- Turni attivi oggi:",a.map(i=>i.name)),a.length===0)return console.log("\u274C Nessun turno attivo oggi"),Promise.resolve({allowed:!1,reason:"Nessun turno attivo oggi",currentShift:null});let s=this.getCurrentShift();console.log("- Turno corrente (senza buffer):",s?.name||"null");for(let i of a){let o=this.subtractHour(i.start_time,1),u=this.addHour(i.end_time,1);console.log(`- Turno ${i.name}: ${i.start_time} - ${i.end_time}`),console.log(`  Buffer: ${o} - ${u}`);let l=this.isTimeInRangeWithOvernight(t,o,u,i.end_time);if(console.log(`  Ora ${t} nel buffer?`,l),l)return console.log(`\u2705 Siamo nel buffer del turno ${i.name}`),Promise.resolve({allowed:!0,reason:`Buffer turno: ${i.name}`,currentShift:i})}return s?(console.log(`\u2705 Siamo nel turno ${s.name}`),Promise.resolve({allowed:!0,reason:`Turno attivo: ${s.name}`,currentShift:s})):(console.log("\u274C Fuori orario dei turni"),Promise.resolve({allowed:!1,reason:"Fuori orario dei turni",currentShift:null}))}isTimeInRangeWithOvernight(e,t,r,n){let a=y=>{let[T,D,$]=y.split(":").map(Number);return T*60+D+$/60},s=a(e),i=a(t),o=a(r),u=a(n),l=a(t);return console.log(`  Controllo intervallo: ${e} tra ${t} e ${r}`),console.log(`  Minuti: ${s} tra ${i} e ${o}`),console.log(`  Turno originale: ${l} - ${u}`),o>=i?s>=i&&s<=o:s>=i||s<=o}subtractHour(e,t){let[r,n,a]=e.split(":").map(Number),s=new Date;return s.setHours(r,n,a),s.setHours(s.getHours()-t),s.toTimeString().split(" ")[0]}addHour(e,t){let[r,n,a]=e.split(":").map(Number),s=new Date;return s.setHours(r,n,a),s.setHours(s.getHours()+t),s.toTimeString().split(" ")[0]}loadClosures(){return c(this,null,function*(){try{let e=yield this.getCurrentRestaurantId();if(!e)return console.error("\u274C No restaurant found"),[];let{data:t,error:r}=yield this.supabaseService.getSupabaseClient().from("restaurant_closures").select("*").eq("restaurant_id",e);return r?(console.error("Error loading closures:",r),[]):t||[]}catch(e){return console.error("Error in loadClosures:",e),[]}})}isRestaurantClosedToday(){let t=new Date().toISOString().split("T")[0];return!1}debugShiftStatus(){return c(this,null,function*(){let e=new Date,t=e.toTimeString().split(" ")[0],r=e.getDay(),n=r===0?7:r;console.log("\u{1F50D} ===== DEBUG TURNI ====="),console.log("Ora attuale:",t),console.log("Giorno (0=domenica, 1=luned\xEC...):",r),console.log("Giorno (1=luned\xEC, 7=domenica):",n);let a=this.getShifts();console.log("Tutti i turni:",a);let s=a.filter(o=>o.is_active&&o.days_of_week.includes(n));console.log("Turni attivi oggi:",s);for(let o of s){let u=this.subtractHour(o.start_time,1),l=this.addHour(o.end_time,1);console.log(`Turno ${o.name}:`,{start:o.start_time,end:o.end_time,startWithBuffer:u,endWithBuffer:l,siamoDentro:t>=u&&t<=l})}let i=yield this.getOrderingStatus();console.log("Risultato getOrderingStatus():",i),console.log("===== FINE DEBUG ===== \u{1F50D}")})}static \u0275fac=function(t){return new(t||f)};static \u0275prov=v({token:f,factory:f.\u0275fac,providedIn:"root"})};export{_ as a};
