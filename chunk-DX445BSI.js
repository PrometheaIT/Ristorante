import{a as g}from"./chunk-JVDFXZVZ.js";import{b as w}from"./chunk-F35UPSG6.js";import{b as y}from"./chunk-4GBXVLF4.js";import{Y as M,ba as m,u as d}from"./chunk-DU5L5MFQ.js";import{a as b,b as D,j as n}from"./chunk-4ZZIO3ZI.js";var p=class extends g{getTableName(){return"menus"}},f=class extends g{getTableName(){return"menu_dishes"}},S=class c{supabase=m(y);authService=m(w);menuService;menuDishService;constructor(){this.menuService=new p,this.menuDishService=new f}loadData(){return n(this,null,function*(){yield this.menuService.loadData()})}loadMenus(){return n(this,null,function*(){yield this.menuService.loadData()})}get data$(){return this.menuService.data$}get menus$(){return this.menuService.data$}get menusLoading$(){return this.menuService.loading$}get menusError$(){return this.menuService.error$}createMenu(e,r,t=!1,i="global"){return n(this,null,function*(){let s={name:e,description:r,is_default:t,is_active:!0,display_order:0,type:i,is_favorite:!1};console.log("\u{1F50D} Creazione menu con:",s);let a=yield this.menuService.create(s);return a&&t&&(yield this.setAsDefault(a.id)),a})}createDedicatedMenu(e,r){return n(this,null,function*(){return this.createMenu(e,r,!1,"dedicated")})}setAsDefault(e){return n(this,null,function*(){try{let i=this.getCurrentMenus().filter(a=>a.is_default).filter(a=>a.id!==e).map(a=>this.menuService.update(a.id,{is_default:!1}));yield Promise.all(i);let s=yield this.menuService.update(e,{is_default:!0,is_active:!0,type:"global"});return s&&(yield this.loadMenus()),s}catch(r){return console.error("Errore impostazione default:",r),!1}})}toggleMenuActive(e){return n(this,null,function*(){let t=this.getCurrentMenus().find(s=>s.id===e);if(!t||t.is_default)return!1;let i=yield this.menuService.update(e,{is_active:!t.is_active});return i&&(yield this.loadMenus()),i})}getDefaultActiveMenu$(){return this.menus$.pipe(d(e=>e.find(t=>t.is_default&&t.is_active)||(e.length>0?e[0]:null)))}getActiveMenus$(){return this.menus$.pipe(d(e=>e.filter(r=>r.is_active)))}getGlobalMenus$(){return this.menus$.pipe(d(e=>e.filter(r=>r.is_active&&r.type==="global")))}getDedicatedMenus$(){return this.menus$.pipe(d(e=>e.filter(r=>r.is_active&&r.type==="dedicated")))}getMenuById(e){return n(this,null,function*(){try{let{data:r,error:t}=yield this.supabase.getSupabaseClient().from("menus").select("*").eq("id",e).single();if(t)throw t;return r}catch(r){return console.error("Errore recupero menu:",r),null}})}updateMenu(e,r){return n(this,null,function*(){let t=yield this.menuService.update(e,r);return t&&(yield this.loadMenus()),t})}delete(e){return n(this,null,function*(){return this.deleteMenu(e)})}deleteMenu(e){return n(this,null,function*(){return(yield this.getMenuById(e))?.is_default?!1:this.menuService.delete(e)})}loadMenuDishes(e){return n(this,null,function*(){let r=e?{menu_id:e}:void 0;yield this.menuDishService.loadData(r)})}get menuDishes$(){return this.menuDishService.data$}get menuDishesData$(){return this.menuDishService.data$}get menuDishesLoading$(){return this.menuDishService.loading$}get menuDishesError$(){return this.menuDishService.error$}removeDishFromMenu(e){return n(this,null,function*(){return this.updateMenuDish(e,{is_active:!1})})}updateMenuDish(e,r){return n(this,null,function*(){let t=yield this.menuDishService.update(e,D(b({},r),{updated_at:new Date().toISOString()}));if(t){let s=this.getCurrentMenuDishes().find(a=>a.id===e);s?.menu_id&&(yield this.loadMenuDishes(s.menu_id))}return t})}updateDishOrder(e,r){return n(this,null,function*(){return this.updateMenuDish(e,{display_order:r})})}getDishesByMenu$(e){return this.menuDishes$.pipe(d(r=>r.filter(t=>t.menu_id===e&&t.is_active)))}getDishesWithDetailsByMenu(e){return n(this,null,function*(){try{let{data:r,error:t}=yield this.supabase.getSupabaseClient().from("menu_dishes").select(`
          *,
          dish:dishes!dish_id (
            id,
            name,
            description,
            base_price,
            image_url,
            status,
            category_id,
            preparation_time,
            deleted_at
          ),
          category:categories!category_id (
            id,
            name
          )
        `).eq("menu_id",e).eq("is_active",!0).order("display_order");if(t)throw t;return(r||[]).filter(i=>i.dish&&!i.dish.deleted_at)}catch(r){return console.error("Errore recupero piatti dettagliati:",r),[]}})}removeAllDishesFromMenu(e){return n(this,null,function*(){try{let{error:r}=yield this.supabase.getSupabaseClient().from("menu_dishes").update({is_active:!1,updated_at:new Date().toISOString()}).eq("menu_id",e).eq("is_active",!0);if(r)throw r;return yield this.loadMenuDishes(e),!0}catch(r){return console.error("\u274C Errore rimozione piatti dal menu:",r),!1}})}getCurrentMenus(){return this.menuService.data||[]}getCurrentMenuDishes(){return this.menuDishService.data||[]}isDishInMenu(e,r){return this.getCurrentMenuDishes().some(i=>i.menu_id===e&&i.dish_id===r&&i.is_active)}getNextDisplayOrder(e){let t=this.getCurrentMenuDishes().filter(s=>s.menu_id===e);return t.length===0?0:Math.max(...t.map(s=>s.display_order))+1}refreshAll(){return n(this,null,function*(){yield Promise.all([this.loadMenus(),this.loadMenuDishes()])})}initializeOrderIndexes(e){return n(this,null,function*(){try{let{data:r,error:t}=yield this.supabase.getSupabaseClient().from("menu_dishes").select("*").eq("menu_id",e).eq("is_active",!0).order("created_at",{ascending:!0});if(t)throw t;let i=r.map((s,a)=>this.supabase.getSupabaseClient().from("menu_dishes").update({order_index:a}).eq("id",s.id));return yield Promise.all(i),yield this.loadMenuDishes(e),!0}catch(r){return console.error("Error initializing order indexes:",r),!1}})}moveDishInMenu(e,r,t){return n(this,null,function*(){try{let{data:i,error:s}=yield this.supabase.getSupabaseClient().from("menu_dishes").select("*").eq("menu_id",e).eq("is_active",!0).order("order_index",{ascending:!0});if(s)throw s;let a=i.findIndex(l=>l.dish_id===r);if(a===-1)return!1;let u=t==="up"?a-1:a+1;if(u<0||u>=i.length)return!1;let _=i[a].order_index||0,h=i[u].order_index||0;return yield this.supabase.getSupabaseClient().from("menu_dishes").update({order_index:h}).eq("id",i[a].id),yield this.supabase.getSupabaseClient().from("menu_dishes").update({order_index:_}).eq("id",i[u].id),yield this.loadMenuDishes(e),!0}catch(i){return console.error("Error moving dish:",i),!1}})}reorderDishes(e,r){return n(this,null,function*(){try{let t=r.map((i,s)=>this.supabase.getSupabaseClient().from("menu_dishes").update({order_index:s}).eq("menu_id",e).eq("dish_id",i));return yield Promise.all(t),yield this.loadMenuDishes(e),!0}catch(t){return console.error("Error reordering dishes:",t),!1}})}getDishesByMenuOrdered$(e){return this.menuDishes$.pipe(d(r=>r.filter(t=>t.menu_id===e&&t.is_active).sort((t,i)=>(t.order_index||0)-(i.order_index||0))))}addDishToMenu(e,r,t,i=0){return n(this,null,function*(){let s=this.getCurrentMenuDishes();if(s.find(o=>o.menu_id===e&&o.dish_id===r&&o.is_active))throw new Error("Il piatto \xE8 gi\xE0 presente in questo menu");let u=s.filter(o=>o.menu_id===e),h=(u.length>0?Math.max(...u.map(o=>o.order_index||0)):-1)+1,l={menu_id:e,dish_id:r,display_order:i,order_index:h,is_active:!0};t&&t.trim()!==""&&(l.category_id=t),console.log("\u{1F50D} Creazione menu_dish con:",l);let v=yield this.menuDishService.create(l);return v&&(yield this.menuDishService.loadData({menu_id:e})),v})}static \u0275fac=function(r){return new(r||c)};static \u0275prov=M({token:c,factory:c.\u0275fac,providedIn:"root"})};export{S as a};
