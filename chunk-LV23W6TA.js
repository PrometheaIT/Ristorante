import{B as h,D as S}from"./chunk-KBL2L3GY.js";import{H as d,N as f,a as l,b as s,ba as p,f as o,ga as i,m as c}from"./chunk-UE7YVF6I.js";var g=class n{supabaseService=i(h);authService=i(S);floorPlansSubject=new c([]);floorPlans$=this.floorPlansSubject.asObservable();tableShapes=[{id:"rect",name:"Rettangolare",type:"rectangle",default_width:120,default_height:80,icon:"rectangle"},{id:"circle",name:"Rotondo",type:"circle",default_width:100,default_height:100,icon:"circle"},{id:"square",name:"Quadrato",type:"square",default_width:100,default_height:100,icon:"square"}];constructor(){this.authService.currentUser$.pipe(d(r=>!!r),f(1)).subscribe(()=>{this.loadFloorPlans()})}getCurrentRestaurantId(){return o(this,null,function*(){let r=this.authService.getCurrentStaffRestaurantId();if(r)return r;let e=this.authService.currentUserValue;if(!e)return null;let{data:t,error:a}=yield this.supabaseService.getSupabaseClient().from("restaurants").select("id").eq("owner_id",e.id).limit(1);return a||!t||t.length===0?(console.error("\u274C No restaurant found for user:",e.id),null):t[0].id})}loadFloorPlans(){return o(this,null,function*(){try{let r=yield this.getCurrentRestaurantId();if(!r){console.error("\u274C No restaurant found for user");return}console.log("\u{1F3E2} Loading floor plans for restaurant:",r);let{data:e,error:t}=yield this.supabaseService.getSupabaseClient().from("restaurant_floor_plans").select("*").eq("restaurant_id",r).order("created_at",{ascending:!1});if(t){console.error("\u274C Error loading floor plans:",t),t.code==="42P01"&&(yield this.createDefaultFloorPlanForRestaurant(r));return}console.log("\u2705 Floor plans loaded:",e?.length),this.floorPlansSubject.next(e||[])}catch(r){console.error("\u{1F4A5} Error in loadFloorPlans:",r)}})}createDefaultFloorPlanForRestaurant(r){return o(this,null,function*(){try{let e={restaurant_id:r,name:"Mappa Principale",width:1e3,height:800,is_active:!0,created_at:new Date().toISOString(),updated_at:new Date().toISOString()},{data:t,error:a}=yield this.supabaseService.getSupabaseClient().from("restaurant_floor_plans").insert(e).select().single();if(a)throw a;this.floorPlansSubject.next([t])}catch(e){console.error("\u{1F4A5} Error creating default floor plan:",e)}})}getTableShapes(){return this.tableShapes}getTableShapeById(r){return this.tableShapes.find(e=>e.id===r)}createFloorPlan(r){return o(this,null,function*(){try{let e=yield this.getCurrentRestaurantId();if(!e)return null;let t=s(l({},r),{restaurant_id:e,created_at:new Date().toISOString(),updated_at:new Date().toISOString()}),{data:a,error:u}=yield this.supabaseService.getSupabaseClient().from("restaurant_floor_plans").insert(t).select().single();if(u)throw u;return yield this.loadFloorPlans(),a}catch(e){return console.error("\u{1F4A5} Error in createFloorPlan:",e),null}})}updateFloorPlan(r,e){return o(this,null,function*(){try{let t=s(l({},e),{updated_at:new Date().toISOString()}),{error:a}=yield this.supabaseService.getSupabaseClient().from("restaurant_floor_plans").update(t).eq("id",r);if(a)throw a;return yield this.loadFloorPlans(),!0}catch(t){return console.error("\u274C Error updating floor plan:",t),!1}})}deleteFloorPlan(r){return o(this,null,function*(){try{yield this.supabaseService.getSupabaseClient().from("tables").update({floor_plan_id:null}).eq("floor_plan_id",r);let{error:e}=yield this.supabaseService.getSupabaseClient().from("restaurant_floor_plans").delete().eq("id",r);if(e)throw e;return yield this.loadFloorPlans(),!0}catch(e){return console.error("\u274C Error deleting floor plan:",e),!1}})}getFloorPlans(){return this.floorPlansSubject.value}static \u0275fac=function(e){return new(e||n)};static \u0275prov=p({token:n,factory:n.\u0275fac,providedIn:"root"})};export{g as a};
