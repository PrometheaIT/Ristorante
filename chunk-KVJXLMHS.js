import{a as W}from"./chunk-BHA4RY6H.js";import{ya as H,za as Q}from"./chunk-KZMQ65O4.js";import{a as U}from"./chunk-MS6ENCNJ.js";import{b as z,c as d,d as M,e as D,i as k,m as O,p as G,q as B,r as $,s as A,w as j,y as q}from"./chunk-PZ6IGEMS.js";import"./chunk-HOOEJZZY.js";import"./chunk-37GYPR4T.js";import{j as T,k as N,s as L}from"./chunk-PWZZTUE6.js";import{$a as g,Ab as R,Bb as V,Da as I,Ga as s,Hb as r,Ib as b,Jb as x,T as w,Wa as C,ba as _,f as E,ha as u,hb as m,ia as f,ib as o,jb as n,kb as p,qb as P,tb as v,vb as S,zb as F}from"./chunk-DU5L5MFQ.js";import{j as h}from"./chunk-4ZZIO3ZI.js";var K=["logoInput"];function X(a,e){if(a&1&&(o(0,"option",40),r(1),n()),a&2){let t=e.$implicit;m("value",t),s(),b(t)}}function Y(a,e){if(a&1&&(o(0,"option",40),r(1),n()),a&2){let t=e.$implicit;m("value",t),s(),b(t)}}function Z(a,e){if(a&1&&(o(0,"option",40),r(1),n()),a&2){let t=e.$implicit;m("value",t.code),s(),b(t.name)}}function ee(a,e){if(a&1&&p(0,"img",41),a&2){let t=S();m("src",t.logoPreview,I)}}function te(a,e){a&1&&(o(0,"span",42),r(1,"add_a_photo"),n())}function ie(a,e){if(a&1){let t=P();o(0,"button",43),v("click",function(){u(t);let l=S();return f(l.removeLogo())}),o(1,"span",34),r(2,"delete"),n(),r(3," Rimuovi Logo "),n()}if(a&2){let t=S();m("disabled",t.loading)}}function ne(a,e){a&1&&(o(0,"span",34),r(1,"sync"),n())}function oe(a,e){a&1&&(o(0,"span",34),r(1,"save"),n())}var J=class a{fb=_(j);restaurantService=_(U);geographyService=_(W);destroy$=new E;profileForm;loading=!1;logoPreview;restaurant=null;provinces=[];regions=[];filteredProvinces=[];cuisineTypes=["Italiana","Giapponese","Cinese","Indiana","Messicana","Francese","Spagnola","Thailandese","Greca","Americana","Vegetariana","Vegana"];logoInput;ngOnInit(){this.initForm(),this.loadProvinces(),this.loadRestaurantData()}ngOnDestroy(){this.destroy$.next(),this.destroy$.complete()}initForm(){this.profileForm=this.fb.group({name:["",[d.required,d.minLength(2)]],description:[""],address:["",d.required],phone:["",[d.required,d.pattern(/^[\+\d\s\-\(\)]{8,20}$/)]],email:["",[d.required,d.email]],cuisine_type:[""],region:[""],province:[""]})}loadProvinces(){return h(this,null,function*(){this.geographyService.getFilteredProvinces().pipe(w(this.destroy$)).subscribe(e=>{this.provinces=e,this.regions=[...new Set(e.map(t=>t.region))].filter(t=>t!=="Tutte").sort()})})}loadRestaurantData(){return h(this,null,function*(){this.loading=!0;try{this.restaurant=yield this.restaurantService.loadCurrentRestaurant(),this.restaurant&&(this.patchForm(this.restaurant),this.logoPreview=this.restaurant.logo_url||void 0)}catch(e){console.error("Errore caricamento profilo:",e)}finally{this.loading=!1}})}patchForm(e){let t=e.province,i="";if(t&&this.provinces.length){let l=this.provinces.find(c=>c.code===t);l&&(i=l.region,this.filterProvincesByRegion(i))}this.profileForm.patchValue({name:e.name,description:e.description||"",address:e.address,phone:e.phone,email:e.email,cuisine_type:e.cuisine_type||"",region:i,province:t||""})}filterProvincesByRegion(e){this.filteredProvinces=e?this.provinces.filter(t=>t.region===e):[],e||this.profileForm.patchValue({province:""})}onRegionChange(e){let t=e.target.value;this.filterProvincesByRegion(t)}onProvinceChange(e){let t=e.target.value;if(t){let i=this.provinces.find(l=>l.code===t);i&&(this.profileForm.patchValue({region:i.region}),this.filterProvincesByRegion(i.region))}else this.profileForm.patchValue({region:""}),this.filteredProvinces=[]}triggerLogoInput(){this.logoInput.nativeElement.click()}onLogoSelected(e){return h(this,null,function*(){let t=e.target;if(!t.files?.length)return;let i=t.files[0];if(i.size>5*1024*1024){alert("Il file non pu\xF2 superare i 5MB");return}if(!i.type.startsWith("image/")){alert("Seleziona un file immagine");return}this.loading=!0;try{let l=yield this.restaurantService.uploadLogo(i);l&&(this.logoPreview=l,alert("Logo caricato con successo!"))}catch(l){alert("Errore caricamento logo: "+l.message)}finally{this.loading=!1,t.value=""}})}removeLogo(){return h(this,null,function*(){if(this.logoPreview&&confirm("Rimuovere il logo?")){this.loading=!0;try{(yield this.restaurantService.removeLogo())&&(this.logoPreview=void 0,alert("Logo rimosso"))}catch(e){alert("Errore: "+e.message)}finally{this.loading=!1}}})}onSubmit(){return h(this,null,function*(){if(!this.profileForm.invalid){this.loading=!0;try{let e=this.profileForm.value,t=yield this.restaurantService.getCurrentRestaurantId();if(!t)throw new Error("Ristorante non trovato");let i={name:e.name,description:e.description||null,address:e.address,phone:this.cleanPhoneNumber(e.phone),email:e.email,cuisine_type:e.cuisine_type||null,province:e.province||null};if(e.address&&e.province){let c=yield this.restaurantService.geocodeAddress(e.address,e.province);c?(i.latitude=c.lat,i.longitude=c.lng,console.log("\u2705 Coordinate ottenute:",c)):(console.warn("\u26A0\uFE0F Geocoding fallito, procedo senza coordinate"),alert("Indirizzo non geolocalizzato automaticamente. Puoi inserire le coordinate manualmente in seguito."))}(yield this.restaurantService.updateRestaurant(t,i))&&(alert("Profilo aggiornato!"),yield this.loadRestaurantData())}catch(e){alert("Errore salvataggio: "+e.message)}finally{this.loading=!1}}})}cleanPhoneNumber(e){return e?e.startsWith("+")?"+"+e.substring(1).replace(/\D/g,""):e.replace(/\D/g,""):""}static \u0275fac=function(t){return new(t||a)};static \u0275cmp=C({type:a,selectors:[["app-profile"]],viewQuery:function(t,i){if(t&1&&F(K,5),t&2){let l;R(l=V())&&(i.logoInput=l.first)}},decls:84,vars:14,consts:[["logoInput",""],[1,"page-container"],[1,"section-header"],[1,"flex","gap-sm"],["name","user"],[1,"section-title"],[1,"flex","flex-col","gap-sm",3,"ngSubmit","formGroup"],[1,"form-card"],[1,"form-row","mb-md"],[1,"material-icons","text-md"],[1,"text-md","font-semibold","m-0"],[1,"form-row","mb-sm"],[1,"form-group"],[1,"standard-label"],["type","text","formControlName","name","placeholder","Es: Trattoria da Mario"],["type","email","formControlName","email","placeholder","info@ristorante.it"],["type","tel","formControlName","phone","placeholder","+39 123 456 7890"],[1,"form-group","mb-sm"],["formControlName","cuisine_type"],["value",""],[3,"value",4,"ngFor","ngForOf"],["formControlName","region",3,"change"],["formControlName","province",3,"change","disabled"],["type","text","formControlName","address","placeholder","Via Roma 123, Milano"],["formControlName","description","rows","3","placeholder","Racconta la storia del tuo ristorante..."],[1,"flex","items-center","gap-sm","mb-md"],[1,"form-row"],["type","file","accept","image/*",2,"display","none",3,"change"],[1,"flex","items-center","gap-md","flex-wrap"],[1,"logo-preview-container",2,"width","120px","height","120px","border","2px dashed var(--smoke-2)","border-radius","12px","display","flex","align-items","center","justify-content","center","overflow","hidden","background","var(--smoke-1)"],["alt","Logo","style","max-width: 100%; max-height: 100%; object-fit: contain;",3,"src",4,"ngIf"],["class","material-icons","style","font-size: 48px; color: var(--smoke-3);",4,"ngIf"],[1,"flex","flex-col","gap-sm"],["type","button",1,"promethea-button","ghost",3,"click","disabled"],[1,"material-icons"],["type","button","class","promethea-button ghost","style","color: var(--danger);",3,"disabled","click",4,"ngIf"],[1,"text-mini","text-muted"],[1,"modal-footer"],["type","submit",1,"promethea-button",3,"disabled"],["class","material-icons",4,"ngIf"],[3,"value"],["alt","Logo",2,"max-width","100%","max-height","100%","object-fit","contain",3,"src"],[1,"material-icons",2,"font-size","48px","color","var(--smoke-3)"],["type","button",1,"promethea-button","ghost",2,"color","var(--danger)",3,"click","disabled"]],template:function(t,i){if(t&1){let l=P();o(0,"div",1)(1,"div",2)(2,"div",3),p(3,"lucide-angular",4),o(4,"h1",5),r(5,"Profilo"),n()()(),o(6,"form",6),v("ngSubmit",function(){return u(l),f(i.onSubmit())}),o(7,"div",7)(8,"div",8)(9,"span",9),r(10,"info"),n(),o(11,"h2",10),r(12,"Informazioni Base"),n()(),o(13,"div",11)(14,"div",12)(15,"label",13),r(16,"Nome Ristorante *"),n(),p(17,"input",14),n()(),o(18,"div",11)(19,"div",12)(20,"label",13),r(21,"Email *"),n(),p(22,"input",15),n(),o(23,"div",12)(24,"label",13),r(25,"Telefono *"),n(),p(26,"input",16),n()(),o(27,"div",17)(28,"label",13),r(29,"Tipo di Cucina"),n(),o(30,"select",18)(31,"option",19),r(32,"Seleziona..."),n(),g(33,X,2,2,"option",20),n()(),o(34,"div",11)(35,"div",12)(36,"label",13),r(37,"Regione"),n(),o(38,"select",21),v("change",function(y){return u(l),f(i.onRegionChange(y))}),o(39,"option",19),r(40,"Seleziona Regione"),n(),g(41,Y,2,2,"option",20),n()(),o(42,"div",12)(43,"label",13),r(44,"Provincia"),n(),o(45,"select",22),v("change",function(y){return u(l),f(i.onProvinceChange(y))}),o(46,"option",19),r(47,"Seleziona Provincia"),n(),g(48,Z,2,2,"option",20),n()()(),o(49,"div",12)(50,"label",13),r(51,"Indirizzo *"),n(),p(52,"input",23),n(),o(53,"div",12)(54,"label",13),r(55,"Descrizione"),n(),p(56,"textarea",24),n()(),o(57,"div",7)(58,"div",25)(59,"span",9),r(60,"image"),n(),o(61,"h2",10),r(62,"Logo Ristorante"),n()(),o(63,"div",26)(64,"div",12)(65,"input",27,0),v("change",function(y){return u(l),f(i.onLogoSelected(y))}),n(),o(67,"div",28)(68,"div",29),g(69,ee,1,1,"img",30)(70,te,2,0,"span",31),n(),o(71,"div",32)(72,"button",33),v("click",function(){return u(l),f(i.triggerLogoInput())}),o(73,"span",34),r(74,"cloud_upload"),n(),r(75),n(),g(76,ie,4,1,"button",35),o(77,"span",36),r(78,"Formati: JPG, PNG, WEBP. Max 5MB."),n()()()()()(),o(79,"div",37)(80,"button",38),g(81,ne,2,0,"span",39)(82,oe,2,0,"span",39),r(83),n()()()()}t&2&&(s(6),m("formGroup",i.profileForm),s(27),m("ngForOf",i.cuisineTypes),s(8),m("ngForOf",i.regions),s(4),m("disabled",!i.filteredProvinces.length),s(3),m("ngForOf",i.filteredProvinces),s(21),m("ngIf",i.logoPreview),s(),m("ngIf",!i.logoPreview),s(2),m("disabled",i.loading),s(3),x(" ",i.logoPreview?"Sostituisci":"Carica"," Logo "),s(),m("ngIf",i.logoPreview),s(4),m("disabled",i.loading||i.profileForm.invalid),s(),m("ngIf",i.loading),s(),m("ngIf",!i.loading),s(),x(" ",i.loading?"Salvataggio...":"Salva Profilo"," "))},dependencies:[L,T,N,q,k,$,A,z,B,M,D,O,G,Q,H],encapsulation:2})};export{J as Profile};
