import{Ea as H}from"./chunk-OFUIVTUT.js";import{a as D,d as U,e as A,i as G,m as q,p as B,w as L,y as Y}from"./chunk-22BNR7AL.js";import{b as V,d as $}from"./chunk-NPMWXJE4.js";import{f as j}from"./chunk-6GCWWUP3.js";import{j as F,k as T,n as z,s as N}from"./chunk-N5RTTLWI.js";import{Ea as P,Fb as S,Ha as s,Ib as r,Jb as k,Kb as u,Sa as M,U as O,Wb as I,Xa as E,Xb as R,ab as d,ca as _,f as w,ia as b,ib as l,ja as C,jb as e,kb as n,lb as g,rb as y,ub as f,wb as m}from"./chunk-R56C6QW6.js";import{a as v,b as h,j as p}from"./chunk-4ZZIO3ZI.js";function Q(a,i){if(a&1){let t=y();e(0,"img",39),f("error",function(){b(t);let c=m().$implicit;return C(c.logo_url=null)}),n()}if(a&2){let t=m().$implicit;l("src",t.logo_url,P)("alt",t.name)}}function W(a,i){a&1&&(e(0,"div",40)(1,"span",18),r(2,"restaurant"),n()())}function X(a,i){if(a&1&&(e(0,"p",41)(1,"span",33),r(2,"location_on"),n(),r(3),n()),a&2){let t=m().$implicit;s(3),u(" ",t.address," ")}}function Z(a,i){if(a&1&&(e(0,"p",42)(1,"span",33),r(2,"restaurant_menu"),n(),r(3),n()),a&2){let t=m().$implicit;s(3),u(" ",t.cuisine_type," ")}}function tt(a,i){if(a&1){let t=y();e(0,"button",43),f("click",function(){b(t);let c=m().$implicit,x=m(2);return C(x.switchToRestaurant(c))}),e(1,"span",18),r(2,"swap_horiz"),n(),r(3),n()}if(a&2){let t=m().$implicit,o=m(2);l("disabled",o.loading),s(3),u(" ",t.is_owner?"Gestisci":"Lavora qui"," ")}}function et(a,i){a&1&&(e(0,"div",44)(1,"span",18),r(2,"check_circle"),n(),r(3," Attuale "),n())}function nt(a,i){if(a&1&&(e(0,"div",24)(1,"div",25)(2,"div",26),d(3,Q,1,2,"img",27)(4,W,3,0,"div",28),n(),e(5,"div",29)(6,"h3",30),r(7),n(),e(8,"div",31)(9,"span",32)(10,"span",33),r(11),n(),r(12),I(13,"titlecase"),n(),e(14,"span",32),r(15),n()(),d(16,X,4,1,"p",34)(17,Z,4,1,"p",35),n(),e(18,"div",36),d(19,tt,4,2,"button",37)(20,et,4,0,"div",38),n()()()),a&2){let t=i.$implicit,o=m(2);s(3),l("ngIf",t.logo_url),s(),l("ngIf",!t.logo_url),s(3),k(t.name),s(2),S("chip-owner",t.is_owner),s(2),u(" ",t.is_owner?"star":"badge"," "),s(),u(" ",t.is_owner?"Proprietario":R(13,14,t.staff_role)," "),s(2),S("active",t.is_active),s(),u(" ",t.is_active?"Attivo":"Inattivo"," "),s(),l("ngIf",t.address),s(),l("ngIf",t.cuisine_type),s(2),l("ngIf",!o.isCurrentRestaurant(t.id)),s(),l("ngIf",o.isCurrentRestaurant(t.id))}}function it(a,i){if(a&1&&(e(0,"div",2)(1,"div",3)(2,"span",4),r(3,"business"),n(),e(4,"h2",5),r(5,"I Tuoi Ristoranti"),n()(),e(6,"div",22),d(7,nt,21,16,"div",23),n()()),a&2){let t=m();s(7),l("ngForOf",t.allRestaurants)}}function rt(a,i){a&1&&(e(0,"div",45)(1,"span",46),r(2,"business_center"),n(),e(3,"h3",47),r(4,"Nessun ristorante associato"),n(),e(5,"p",10),r(6," Non sei proprietario di nessun ristorante e non fai parte di nessuno staff. "),n()())}function at(a,i){a&1&&(e(0,"span",18),r(1,"sync"),n())}function ot(a,i){a&1&&(e(0,"span",18),r(1,"save"),n())}function st(a,i){a&1&&(e(0,"span"),r(1,"Salvataggio..."),n())}function lt(a,i){a&1&&(e(0,"span"),r(1,"Salva Impostazioni"),n())}var J=class a{constructor(i){this.fb=i}settingsForm;loading=!1;staffRestaurants=[];ownedRestaurants=[];destroy$=new w;supabaseClient=_(V).getSupabaseClient();authService=_($);router=_(j);ngOnInit(){this.initForm(),this.setupStaffRestaurantsSubscription(),this.loadUserProfile(),this.loadOwnedRestaurants()}ngOnDestroy(){this.destroy$.next(),this.destroy$.complete()}initForm(){this.settingsForm=this.fb.group({email_notifications:[!0],sms_notifications:[!0],newsletter:[!0],is_active:[!0]})}loadUserProfile(){return p(this,null,function*(){this.loading=!0;try{let i=this.authService.currentUserValue;if(!i)return;let{data:t,error:o}=yield this.supabaseClient.from("users").select("preferences, is_active").eq("id",i.id).single();if(o){if(o.code==="PGRST116"){yield this.createMinimalProfile(i.id);return}throw o}t&&this.settingsForm.patchValue({email_notifications:t.preferences?.email_notifications??!0,sms_notifications:t.preferences?.sms_notifications??!0,newsletter:t.preferences?.newsletter??!0,is_active:t.is_active??!0})}catch(i){console.error("Errore caricamento profilo:",i)}finally{this.loading=!1}})}createMinimalProfile(i){return p(this,null,function*(){let t=this.authService.currentUserValue;if(!t)return;let o={id:i,email:t.email,preferences:{email_notifications:!0,sms_notifications:!0,newsletter:!0},is_active:!0,role:"customer",created_at:new Date().toISOString(),updated_at:new Date().toISOString()},{error:c}=yield this.supabaseClient.from("users").insert(o);c||this.settingsForm.patchValue({email_notifications:!0,sms_notifications:!0,newsletter:!0,is_active:!0})})}setupStaffRestaurantsSubscription(){this.authService.allStaffRecords$.pipe(O(this.destroy$)).subscribe(i=>p(this,null,function*(){i?.length?yield this.loadStaffRestaurants(i):this.staffRestaurants=[]}))}loadStaffRestaurants(i){return p(this,null,function*(){this.loading=!0;try{let t=i.map(c=>p(this,null,function*(){let{data:x,error:K}=yield this.supabaseClient.from("restaurants").select("*").eq("id",c.restaurant_id).single();return K?null:h(v({},x),{staff_role:c.role,staff_permissions:c.permissions,staff_invitation_status:c.invitation_status})})),o=yield Promise.all(t);this.staffRestaurants=o.filter(Boolean)}catch(t){console.error("Errore staff restaurants:",t),this.staffRestaurants=[]}finally{this.loading=!1}})}loadOwnedRestaurants(){return p(this,null,function*(){let i=this.authService.currentUserValue;if(i)try{let{data:t,error:o}=yield this.supabaseClient.from("restaurants").select("*").eq("owner_id",i.id);if(o)throw o;this.ownedRestaurants=(t||[]).map(c=>h(v({},c),{staff_role:"owner",is_owner:!0}))}catch(t){console.error("Errore owned restaurants:",t),this.ownedRestaurants=[]}})}get allRestaurants(){return[...this.ownedRestaurants,...this.staffRestaurants]}isCurrentRestaurant(i){return this.authService.getCurrentRestaurantId()===i}switchToRestaurant(i){return p(this,null,function*(){this.loading=!0;try{if(!(yield this.authService.switchRestaurant(i.id)))throw new Error("Switch fallito");setTimeout(()=>{this.router.navigate(["/restaurant/dashboard"])},400)}catch(t){console.error(t),alert("Errore cambio ristorante: "+(t.message||"Errore sconosciuto"))}finally{this.loading=!1}})}onSubmit(){return p(this,null,function*(){if(!this.settingsForm.invalid){this.loading=!0;try{let i=this.authService.currentUserValue;if(!i)throw new Error("Utente non loggato");let t=this.settingsForm.value,o={preferences:{email_notifications:t.email_notifications,sms_notifications:t.sms_notifications,newsletter:t.newsletter},is_active:t.is_active,updated_at:new Date().toISOString()},{error:c}=yield this.supabaseClient.from("users").update(o).eq("id",i.id);if(c)throw c;alert("Impostazioni salvate!")}catch(i){console.error(i),alert("Errore salvataggio: "+(i.message||"Errore sconosciuto"))}finally{this.loading=!1}}})}resetForm(){this.loadUserProfile()}static \u0275fac=function(t){return new(t||a)(M(L))};static \u0275cmp=E({type:a,selectors:[["app-settings-customer"]],decls:55,vars:9,consts:[[1,"page-container"],[1,"flex","flex-col","gap-lg",3,"ngSubmit","formGroup"],[1,"form-card"],[1,"flex","items-center","gap-sm","mb-md"],[1,"material-icons","text-md"],[1,"text-md","font-semibold","m-0"],[1,"flex","flex-col","gap-md"],[1,"checkbox-label"],["type","checkbox","formControlName","email_notifications"],[1,"checkbox-content"],[1,"text-muted"],["type","checkbox","formControlName","sms_notifications"],["type","checkbox","formControlName","newsletter"],["type","checkbox","formControlName","is_active"],["class","form-card",4,"ngIf"],["class","empty-state",4,"ngIf"],[1,"flex","justify-between","items-center","gap-md","mt-lg","pt-md","border-t"],["type","button",1,"promethea-button","ghost",3,"click","disabled"],[1,"material-icons"],["type","submit",1,"promethea-button",3,"disabled"],["class","material-icons",4,"ngIf"],[4,"ngIf"],[1,"grid-cards"],["class","card p-md hover-lift transition",4,"ngFor","ngForOf"],[1,"card","p-md","hover-lift","transition"],[1,"flex","gap-md","items-start"],[1,"flex-shrink-0"],["class","rounded-full","style","width: 56px; height: 56px; object-fit: cover;",3,"src","alt","error",4,"ngIf"],["class","rounded-full bg-smoke flex items-center justify-center","style","width: 56px; height: 56px;",4,"ngIf"],[1,"flex-1"],[1,"card-title"],[1,"flex","gap-sm","flex-wrap","mt-sm"],[1,"chip"],[1,"material-icons","text-mini"],["class","text-muted text-mini mt-sm",4,"ngIf"],["class","text-muted text-mini",4,"ngIf"],[1,"flex","flex-col","gap-sm","justify-center"],["type","button","class","promethea-button ghost x-small",3,"disabled","click",4,"ngIf"],["class","chip active",4,"ngIf"],[1,"rounded-full",2,"width","56px","height","56px","object-fit","cover",3,"error","src","alt"],[1,"rounded-full","bg-smoke","flex","items-center","justify-center",2,"width","56px","height","56px"],[1,"text-muted","text-mini","mt-sm"],[1,"text-muted","text-mini"],["type","button",1,"promethea-button","ghost","x-small",3,"click","disabled"],[1,"chip","active"],[1,"empty-state"],[1,"material-icons","fs-lg"],[1,"text-md","font-semibold","mt-sm"]],template:function(t,o){t&1&&(e(0,"div",0)(1,"form",1),f("ngSubmit",function(){return o.onSubmit()}),e(2,"div",2)(3,"div",3)(4,"span",4),r(5,"settings"),n(),e(6,"h2",5),r(7,"Preferenze"),n()(),e(8,"div",6)(9,"label",7),g(10,"input",8),e(11,"div",9)(12,"strong"),r(13,"Notifiche Email"),n(),e(14,"div",10),r(15,"Ricevi aggiornamenti e promozioni via email"),n()()(),e(16,"label",7),g(17,"input",11),e(18,"div",9)(19,"strong"),r(20,"Notifiche SMS"),n(),e(21,"div",10),r(22,"Ricevi notifiche importanti via SMS"),n()()(),e(23,"label",7),g(24,"input",12),e(25,"div",9)(26,"strong"),r(27,"Newsletter"),n(),e(28,"div",10),r(29,"Ricevi le ultime novit\xE0 e offerte speciali"),n()()()()(),e(30,"div",2)(31,"div",3)(32,"span",4),r(33,"visibility"),n(),e(34,"h2",5),r(35,"Stato Account"),n()(),e(36,"label",7),g(37,"input",13),e(38,"div",9)(39,"strong"),r(40,"Account attivo"),n(),e(41,"div",10),r(42,"Ricevi notifiche e puoi effettuare prenotazioni"),n()()()(),d(43,it,8,1,"div",14)(44,rt,7,0,"div",15),e(45,"div",16)(46,"button",17),f("click",function(){return o.resetForm()}),e(47,"span",18),r(48,"refresh"),n(),r(49," Annulla Modifiche "),n(),e(50,"button",19),d(51,at,2,0,"span",20)(52,ot,2,0,"span",20)(53,st,2,0,"span",21)(54,lt,2,0,"span",21),n()()()()),t&2&&(s(),l("formGroup",o.settingsForm),s(42),l("ngIf",o.allRestaurants.length>0),s(),l("ngIf",o.allRestaurants.length===0),s(2),l("disabled",o.loading),s(4),l("disabled",o.loading||o.settingsForm.invalid),s(),l("ngIf",o.loading),s(),l("ngIf",!o.loading),s(),l("ngIf",o.loading),s(),l("ngIf",!o.loading))},dependencies:[N,F,T,Y,G,D,U,A,q,B,H,z],styles:[".disabled-input[_ngcontent-%COMP%]{background-color:color-mix(in srgb,var(--background) 80%,transparent);border-color:color-mix(in srgb,var(--text-color) 20%,transparent);color:color-mix(in srgb,var(--text-color) 60%,transparent);cursor:not-allowed;opacity:.7}.field-note[_ngcontent-%COMP%]{font-size:.75rem;color:color-mix(in srgb,var(--text-color) 60%,transparent);margin-top:4px;font-style:italic}.avatar-upload-container[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center;gap:var(--gap-md);padding:var(--gap-md);border:2px dashed var(--smoke-1);border-radius:16px;background:color-mix(in srgb,var(--background) 95%,transparent);transition:all .3s ease}.avatar-upload-container[_ngcontent-%COMP%]:hover{border-color:var(--primary);background:color-mix(in srgb,var(--primary) 5%,transparent)}.avatar-preview[_ngcontent-%COMP%]{width:120px;height:120px;border-radius:50%;overflow:hidden;border:3px solid var(--primary);box-shadow:0 4px 12px color-mix(in srgb,var(--primary) 20%,transparent)}.avatar-image[_ngcontent-%COMP%]{width:100%;height:100%;object-fit:cover}.avatar-placeholder[_ngcontent-%COMP%]{width:120px;height:120px;border-radius:50%;background:var(--gradiente);display:flex;align-items:center;justify-content:center;border:3px solid var(--smoke-1)}.avatar-placeholder[_ngcontent-%COMP%]   .material-icons[_ngcontent-%COMP%]{font-size:48px;color:#fff}.file-input[_ngcontent-%COMP%]{display:none}.upload-button[_ngcontent-%COMP%]{display:inline-flex;align-items:center;gap:var(--gap-sm);padding:var(--gap-sm) var(--gap-md);background:var(--primary);color:#fff;border-radius:8px;cursor:pointer;transition:all .3s ease;font-weight:600;text-decoration:none}.upload-button[_ngcontent-%COMP%]:hover{background:color-mix(in srgb,var(--primary) 80%,transparent);transform:translateY(-2px);box-shadow:0 4px 12px color-mix(in srgb,var(--primary) 30%,transparent)}.upload-note[_ngcontent-%COMP%]{font-size:.8rem;color:color-mix(in srgb,var(--text-color) 60%,transparent);text-align:center}@media (max-width: 768px){.avatar-preview[_ngcontent-%COMP%], .avatar-placeholder[_ngcontent-%COMP%]{width:100px;height:100px}.avatar-placeholder[_ngcontent-%COMP%]   .material-icons[_ngcontent-%COMP%]{font-size:36px}.form-actions[_ngcontent-%COMP%]{flex-direction:column}.form-actions[_ngcontent-%COMP%]   .promethea-button[_ngcontent-%COMP%]{width:100%}}.staff-restaurants-list[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:var(--gap-md)}.staff-restaurant-item[_ngcontent-%COMP%]{display:flex;align-items:center;gap:var(--gap-md);padding:var(--gap-md);border:1px solid var(--smoke-1);border-radius:16px;background:var(--background);transition:all .3s ease;position:relative}.staff-restaurant-item[_ngcontent-%COMP%]:hover{border-color:var(--primary);transform:translateY(-2px);box-shadow:0 4px 20px color-mix(in srgb,var(--primary) 15%,transparent)}.staff-restaurant-item.current-restaurant[_ngcontent-%COMP%]{border-color:var(--primary);background:color-mix(in srgb,var(--primary) 8%,transparent)}.restaurant-avatar[_ngcontent-%COMP%]{flex-shrink:0;width:60px;height:60px;border-radius:12px;overflow:hidden;border:2px solid var(--smoke-1)}.restaurant-logo[_ngcontent-%COMP%]{width:100%;height:100%;object-fit:cover}.restaurant-avatar-fallback[_ngcontent-%COMP%]{width:100%;height:100%;background:var(--gradiente);display:flex;align-items:center;justify-content:center;color:#fff}.restaurant-avatar-fallback[_ngcontent-%COMP%]   .material-icons[_ngcontent-%COMP%]{font-size:24px}.restaurant-details[_ngcontent-%COMP%]{flex:1;min-width:0}.restaurant-name[_ngcontent-%COMP%]{margin:0 0 8px;font-weight:700;color:var(--text-color);font-size:var(--fs-sm);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.restaurant-info[_ngcontent-%COMP%]{display:flex;align-items:center;gap:var(--gap-sm);margin-bottom:8px;flex-wrap:wrap}.restaurant-role[_ngcontent-%COMP%]{padding:4px 10px;border-radius:12px;font-size:.75rem;font-weight:600;text-transform:capitalize}.role-manager[_ngcontent-%COMP%]{background:color-mix(in srgb,var(--primary) 20%,transparent);color:var(--primary)}.role-chef[_ngcontent-%COMP%]{background:color-mix(in srgb,#f59e0b 20%,transparent);color:#f59e0b}.role-waiter[_ngcontent-%COMP%]{background:color-mix(in srgb,#10b981 20%,transparent);color:#10b981}.role-kitchen-staff[_ngcontent-%COMP%]{background:color-mix(in srgb,#8b5cf6 20%,transparent);color:#8b5cf6}.role-default[_ngcontent-%COMP%]{background:var(--smoke-1);color:var(--text-color)}.restaurant-status[_ngcontent-%COMP%]{padding:4px 8px;border-radius:8px;font-size:.7rem;font-weight:600}.restaurant-status.active[_ngcontent-%COMP%]{background:color-mix(in srgb,#10b981 20%,transparent);color:#10b981}.restaurant-status.inactive[_ngcontent-%COMP%]{background:color-mix(in srgb,#6b7280 20%,transparent);color:#6b7280}.restaurant-address[_ngcontent-%COMP%], .restaurant-cuisine[_ngcontent-%COMP%]{margin:4px 0 0;font-size:.8rem;color:var(--text-muted);display:flex;align-items:center;gap:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.restaurant-address[_ngcontent-%COMP%]   .material-icons[_ngcontent-%COMP%], .restaurant-cuisine[_ngcontent-%COMP%]   .material-icons[_ngcontent-%COMP%]{font-size:14px;opacity:.7}.restaurant-actions[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:flex-end;gap:var(--gap-sm);flex-shrink:0}.promethea-button.small[_ngcontent-%COMP%]{padding:6px 12px;font-size:.8rem;min-height:32px}.promethea-button.small[_ngcontent-%COMP%]   .material-icons[_ngcontent-%COMP%]{font-size:16px}.current-badge[_ngcontent-%COMP%]{display:flex;align-items:center;gap:4px;padding:6px 12px;background:color-mix(in srgb,var(--primary) 15%,transparent);color:var(--primary);border-radius:8px;font-size:.8rem;font-weight:600}.current-badge[_ngcontent-%COMP%]   .material-icons[_ngcontent-%COMP%]{font-size:16px}.empty-state[_ngcontent-%COMP%]{text-align:center;padding:var(--gutter-xl);color:var(--text-muted)}.empty-state[_ngcontent-%COMP%]   .material-icons[_ngcontent-%COMP%]{font-size:48px;margin-bottom:var(--gap-md);opacity:.5}.empty-state[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{margin:0 0 var(--gap-sm) 0;font-weight:600}.empty-state[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{margin:0;line-height:1.5}@media (max-width: 768px){.staff-restaurant-item[_ngcontent-%COMP%]{flex-direction:column;align-items:flex-start;text-align:left}.restaurant-avatar[_ngcontent-%COMP%]{align-self:flex-start}.restaurant-actions[_ngcontent-%COMP%]{align-self:stretch;align-items:stretch}.restaurant-actions[_ngcontent-%COMP%]   .promethea-button[_ngcontent-%COMP%]{width:100%;justify-content:center}.restaurant-info[_ngcontent-%COMP%]{flex-direction:column;align-items:flex-start;gap:4px}}.staff-restaurant-item.loading[_ngcontent-%COMP%]{opacity:.6;pointer-events:none}"]})};export{J as SettingsCustomer};
