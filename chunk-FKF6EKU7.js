import{a as A}from"./chunk-BHA4RY6H.js";import{ya as M,za as G}from"./chunk-KZMQ65O4.js";import{b as C,d as U,e as I,i as w,m as N,p as z,q as R,r as T,s as O,w as D,y as V}from"./chunk-PZ6IGEMS.js";import{b as x,d as F}from"./chunk-HOOEJZZY.js";import"./chunk-37GYPR4T.js";import{j as y,k as b,s as E}from"./chunk-PWZZTUE6.js";import{$a as f,Ga as a,Hb as o,Jb as g,T as S,Wa as _,ba as c,f as h,fc as P,hb as l,ib as r,jb as t,kb as d,tb as v}from"./chunk-DU5L5MFQ.js";import{j as u}from"./chunk-4ZZIO3ZI.js";function B(s,e){if(s&1&&(r(0,"option",33),o(1),t()),s&2){let n=e.$implicit;l("value",n),a(),g(" ",n," ")}}function L(s,e){if(s&1&&(r(0,"option",33),o(1),t()),s&2){let n=e.$implicit;l("value",n.code),a(),g(" ",n.name," ")}}function k(s,e){s&1&&(r(0,"div",34),d(1,"lucide-angular",35),o(2," Nessuna provincia disponibile per questa regione "),t()),s&2&&(a(),l("size",16))}function q(s,e){s&1&&(r(0,"div",36),d(1,"lucide-angular",35),o(2," Seleziona prima una regione "),t()),s&2&&(a(),l("size",16))}function j(s,e){s&1&&(r(0,"span"),o(1,"Salvataggio..."),t())}function H(s,e){s&1&&(r(0,"span"),o(1,"Salva modifiche"),t())}var $=class s{fb=c(D);authService=c(F);supabaseService=c(x);geographyService=c(A);cdRef=c(P);destroy$=new h;supabaseClient=this.supabaseService.getSupabaseClient();profileForm;loading=!1;userProfile;provinces=[];regions=[];filteredProvinces=[];selectedProvinceName="";ngOnInit(){this.initForm(),this.loadProvinces(),this.loadUserProfile()}ngOnDestroy(){this.destroy$.next(),this.destroy$.complete()}initForm(){this.profileForm=this.fb.group({phone:[""],address:[""],region:[""],province:[""]})}loadProvinces(){return u(this,null,function*(){this.geographyService.getFilteredProvinces().pipe(S(this.destroy$)).subscribe({next:e=>{this.provinces=e,this.regions=[...new Set(e.map(i=>i.region))].filter(i=>i!=="Tutte").sort();let n=this.profileForm.get("region")?.value;n&&this.filterProvincesByRegion(n),this.cdRef.detectChanges()},error:e=>console.error("Errore caricamento province:",e)})})}filterProvincesByRegion(e){this.filteredProvinces=e?this.provinces.filter(n=>n.region===e):[],e||this.profileForm.patchValue({province:""})}onRegionChange(e){let i=e.target.value;this.filterProvincesByRegion(i)}onProvinceChange(e){let i=e.target.value,m=this.provinces.find(p=>p.code===i);this.selectedProvinceName=m?m.name:""}loadUserProfile(){return u(this,null,function*(){this.loading=!0;try{let e=this.authService.currentUserValue;if(!e)throw new Error("Utente non autenticato");let{data:n,error:i}=yield this.supabaseClient.from("users").select("*").eq("id",e.id).single();if(i){if(i.code==="PGRST116"){yield this.createUserProfile(e.id);return}throw i}n&&(this.userProfile=n,this.patchForm(n))}catch(e){console.error("Errore caricamento profilo:",e)}finally{this.loading=!1,this.cdRef.detectChanges()}})}createUserProfile(e){return u(this,null,function*(){let n=this.authService.currentUserValue;if(!n)return;let i={id:e,email:n.email,first_name:n.first_name||"",last_name:n.last_name||"",phone:null,address:null,avatar_url:null,preferences:{email_notifications:!0,sms_notifications:!0,newsletter:!0},is_active:!0,role:"customer",created_at:new Date().toISOString(),updated_at:new Date().toISOString()},{data:m,error:p}=yield this.supabaseClient.from("users").insert(i).select().single();if(p){console.error("Errore creazione profilo:",p);return}m&&(this.userProfile=m,this.patchForm(m))})}patchForm(e){let n="";if(e.province){let i=this.provinces.find(m=>m.code===e.province);i&&(n=i.region,this.filterProvincesByRegion(n))}this.profileForm.patchValue({phone:e.phone||"",address:e.address||"",region:n,province:e.province||""})}onSubmit(){return u(this,null,function*(){if(!this.profileForm.invalid){this.loading=!0;try{let e=this.authService.currentUserValue;if(!e)throw new Error("Utente non autenticato");let n=this.profileForm.value,i={phone:n.phone||null,address:n.address||null,province:n.province||null,updated_at:new Date().toISOString()},{error:m}=yield this.supabaseClient.from("users").update(i).eq("id",e.id);if(m)throw m;alert("Profilo aggiornato con successo!")}catch(e){console.error("Errore salvataggio:",e),alert("Errore durante il salvataggio: "+(e.message||"Errore sconosciuto"))}finally{this.loading=!1,this.cdRef.detectChanges()}}})}resetForm(){this.userProfile&&this.patchForm(this.userProfile)}static \u0275fac=function(n){return new(n||s)};static \u0275cmp=_({type:s,selectors:[["app-profile-user"]],decls:85,vars:15,consts:[[1,"profile-container"],[1,"section-header"],[1,"flex","gap-sm"],["name","user"],[1,"section-title"],[1,"profile-form",3,"ngSubmit","formGroup"],[1,"form-card"],[1,"flex","items-center","gap-sm","mb-md"],[1,"material-icons","text-md"],[1,"text-md","font-semibold","m-0"],[1,"form-row"],[1,"form-group"],[1,"standard-label"],["name","user",1,"nav-icon",3,"size"],["type","text","disabled","",1,"disabled-input",3,"value"],[1,"text-muted","text-mini"],[1,"material-icons"],["name","mail",1,"nav-icon",3,"size"],["type","email","disabled","",1,"disabled-input",3,"value"],[1,"flex","items-center","gap-sm","mt-md","mt-lg"],[1,"form-row","mt-sm"],["formControlName","region",1,"standard-select",3,"change"],["value",""],[3,"value",4,"ngFor","ngForOf"],["formControlName","province",1,"standard-select",3,"change","disabled"],["class","text-warning text-mini mt-sm",4,"ngIf"],["class","text-muted text-mini mt-sm",4,"ngIf"],["type","tel","formControlName","phone","placeholder","+39 123 456 7890"],["type","text","formControlName","address","placeholder","Via Roma 123, Milano"],[1,"modal-footer"],["type","submit",1,"promethea-button",3,"disabled"],[4,"ngIf"],["type","button",1,"promethea-button","outline",3,"click","disabled"],[3,"value"],[1,"text-warning","text-mini","mt-sm"],["name","info",3,"size"],[1,"text-muted","text-mini","mt-sm"]],template:function(n,i){if(n&1&&(r(0,"div",0)(1,"div",1)(2,"div",2),d(3,"lucide-angular",3),r(4,"h1",4),o(5,"Profilo"),t()()(),r(6,"form",5),v("ngSubmit",function(){return i.onSubmit()}),r(7,"div",6)(8,"div",7)(9,"span",8),o(10,"badge"),t(),r(11,"h2",9),o(12,"Account"),t()(),r(13,"div",10)(14,"div",11)(15,"label",12),d(16,"lucide-angular",13),o(17," Nome "),t(),d(18,"input",14),r(19,"div",15),o(20,"Il nome non pu\xF2 essere modificato"),t()(),r(21,"div",11)(22,"label",12)(23,"span",16),o(24,"person"),t(),o(25," Cognome "),t(),d(26,"input",14),r(27,"div",15),o(28,"Il cognome non pu\xF2 essere modificato"),t()()(),r(29,"div",11)(30,"label",12),d(31,"lucide-angular",17),o(32," Email "),t(),d(33,"input",18),r(34,"div",15),o(35,"L'email non pu\xF2 essere modificata"),t()(),r(36,"div",19)(37,"span",8),o(38,"contact_phone"),t(),r(39,"h2",9),o(40,"Informazioni di Contatto"),t()(),r(41,"div",20)(42,"div",11)(43,"label",12)(44,"span",16),o(45,"public"),t(),o(46," Regione "),t(),r(47,"select",21),v("change",function(p){return i.onRegionChange(p)}),r(48,"option",22),o(49,"Seleziona Regione"),t(),f(50,B,2,2,"option",23),t()(),r(51,"div",11)(52,"label",12)(53,"span",16),o(54,"map"),t(),o(55," Provincia "),t(),r(56,"select",24),v("change",function(p){return i.onProvinceChange(p)}),r(57,"option",22),o(58,"Seleziona Provincia"),t(),f(59,L,2,2,"option",23),t(),f(60,k,3,1,"div",25)(61,q,3,1,"div",26),t()(),r(62,"div",10)(63,"div",11)(64,"label",12)(65,"span",16),o(66,"phone"),t(),o(67," Telefono "),t(),d(68,"input",27),r(69,"div",15),o(70,"Numero per le notifiche e prenotazioni"),t()(),r(71,"div",11)(72,"label",12)(73,"span",16),o(74,"location_on"),t(),o(75," Indirizzo "),t(),d(76,"input",28),r(77,"div",15),o(78,"Indirizzo per consegne a domicilio"),t()()()(),r(79,"div",29)(80,"button",30),f(81,j,2,0,"span",31)(82,H,2,0,"span",31),t(),r(83,"button",32),v("click",function(){return i.resetForm()}),o(84," Annulla "),t()()()()),n&2){let m,p;a(6),l("formGroup",i.profileForm),a(10),l("size",20),a(2),l("value",i.userProfile==null?null:i.userProfile.first_name),a(8),l("value",i.userProfile==null?null:i.userProfile.last_name),a(5),l("size",20),a(2),l("value",i.userProfile==null?null:i.userProfile.email),a(17),l("ngForOf",i.regions),a(6),l("disabled",!i.filteredProvinces.length),a(3),l("ngForOf",i.filteredProvinces),a(),l("ngIf",!i.filteredProvinces.length&&((m=i.profileForm.get("region"))==null?null:m.value)),a(),l("ngIf",!((p=i.profileForm.get("region"))!=null&&p.value)),a(19),l("disabled",i.loading||i.profileForm.invalid),a(),l("ngIf",i.loading),a(),l("ngIf",!i.loading),a(),l("disabled",i.loading)}},dependencies:[E,y,b,V,w,T,O,C,R,U,I,N,z,G,M],encapsulation:2})};export{$ as ProfileUser};
