import{a as y}from"./chunk-AMYEPXIV.js";import{I as D,Y as v,s as d}from"./chunk-5BU4UD4M.js";import{a as b,b as m,c as f,g as s}from"./chunk-RA2WU32H.js";var S=class g extends y{getTableName(){return"dishes"}constructor(){super(),this.authService.currentUser$.pipe(D(1)).subscribe(e=>{e&&this.loadData()})}getAvailableDishes(){return this.data$.pipe(d(e=>e.filter(t=>t.status==="available")))}getDishesByCategory(e){return this.data$.pipe(d(t=>t.filter(r=>r.category_id===e)))}getDishById$(e){return this.getById(e)}createDish(e){return s(this,null,function*(){console.log("\u{1F4DD} [DishService.createDish] Inizio creazione piatto");try{if(!e.name||e.name.trim()==="")return console.error("\u274C Nome mancante"),this.errorSubject.next("Il nome del piatto \xE8 obbligatorio"),null;if(e.base_price<=0)return console.error("\u274C Prezzo non valido:",e.base_price),this.errorSubject.next("Il prezzo base deve essere maggiore di 0"),null;let t=yield this.getCurrentRestaurantId();if(console.log("\u{1F3EA} Restaurant ID ottenuto:",t),!t)return console.error("\u274C Restaurant ID NON TROVATO!"),this.errorSubject.next("Impossibile determinare il ristorante corrente"),null;let r={name:e.name.trim(),description:e.description||null,base_price:Number(e.base_price),food_cost:e.food_cost?Number(e.food_cost):0,status:e.status||"available",preparation_time:e.preparation_time||null,restaurant_id:t,category_id:e.category_id||null,delivery_price:e.delivery_price||null,takeaway_price:e.takeaway_price||null,image_url:e.image_url||null,recipe_instructions:e.recipe_instructions||null,ingredients_composition:e.ingredients_composition||null,allergens:e.allergens||[],created_at:new Date().toISOString()};Object.keys(r).forEach(i=>{r[i]===void 0&&(r[i]=null)}),console.log("\u{1F4E4} [DishService.createDish] Payload finale:",JSON.stringify(r,null,2));let{data:a,error:o}=yield this.supabaseService.getSupabaseClient().from("dishes").insert(r).select().single();if(o)return console.error("\u274C [DishService.createDish] Errore Supabase:",{code:o.code,message:o.message,details:o.details,hint:o.hint}),this.errorSubject.next(o.message),null;console.log("\u2705 [DishService.createDish] Piatto creato con successo:",a);let n=this.dataSubject.value;return this.dataSubject.next([...n,a]),a}catch(t){return console.error("\u274C [DishService.createDish] Errore imprevisto:",t),this.errorSubject.next("Errore durante la creazione del piatto"),null}})}updateDish(e,t){return s(this,null,function*(){return console.log("\u{1F504} Updating dish:",e,t),t.name!==void 0&&t.name.trim()===""?(this.errorSubject.next("Il nome del piatto non pu\xF2 essere vuoto"),!1):t.base_price!==void 0&&t.base_price<=0?(this.errorSubject.next("Il prezzo base deve essere maggiore di 0"),!1):this.update(e,t)})}deleteDish(e){return s(this,null,function*(){console.log("\u{1F5D1}\uFE0F Eseguendo SOFT DELETE del piatto:",e);try{return yield this.update(e,{deleted_at:new Date().toISOString()})}catch(t){return console.error("\u274C Errore durante il soft delete:",t),!1}})}changeDishStatus(e,t){return s(this,null,function*(){return this.update(e,{status:t})})}updateFoodCost(e,t){return s(this,null,function*(){return t<0?(this.errorSubject.next("Il food cost non pu\xF2 essere negativo"),!1):this.update(e,{food_cost:t})})}searchDishes(e){return this.data$.pipe(d(t=>{if(!e.trim())return t;let r=e.toLowerCase();return t.filter(a=>a.name.toLowerCase().includes(r)||a.description?.toLowerCase().includes(r))}))}getDefaultCategoryId(){return s(this,null,function*(){try{let e=yield this.getCurrentRestaurantId();if(!e)return null;let{data:t,error:r}=yield this.supabaseService.getSupabaseClient().from("categories").select("id").eq("restaurant_id",e).eq("is_default",!0).limit(1).single();if(r||!t){console.warn("No default category found, using first category");let{data:a}=yield this.supabaseService.getSupabaseClient().from("categories").select("id").eq("restaurant_id",e).limit(1).single();return a?.id||null}return t.id}catch(e){return console.error("Error getting default category:",e),null}})}loadData(e){return s(this,null,function*(){try{this.loadingSubject.next(!0),this.errorSubject.next(null);let t=yield this.getCurrentRestaurantId();if(!t){this.dataSubject.next([]);return}let r=this.supabaseService.getSupabaseClient().from(this.getTableName()).select("*").eq("restaurant_id",t).is("deleted_at",null);e&&Object.keys(e).forEach(n=>{let i=e[n];i!=null&&(r=r.eq(n,i))}),this.loadingService.start();let{data:a,error:o}=yield r;if(this.loadingService.stop(),o)throw o;this.dataSubject.next(a??[])}catch(t){console.error("Error loading dishes:",t),this.errorSubject.next(t.message??"Errore sconosciuto"),this.dataSubject.next([])}finally{this.loadingSubject.next(!1)}})}loadDishes(){return s(this,null,function*(){return this.loadData()})}reloadDishes(){return s(this,null,function*(){return this.loadData()})}getDishes(){return this.dataSubject.value}getDishById(e){return this.dataSubject.value.find(t=>t.id===e)}getDishesByMenu$(e){return this.data$}isDishInMenu$(e,t){return this.data$.pipe(d(r=>r.some(a=>a.id===e)))}getActiveDishes$(){return this.data$.pipe(d(e=>e.filter(t=>!t.deleted_at)))}getActiveDishes(){return this.dataSubject.value.filter(e=>!e.deleted_at)}getAllDishesIncludingDeleted(){return s(this,null,function*(){let e=yield this.getCurrentRestaurantId();if(!e)return[];let{data:t,error:r}=yield this.supabaseService.getSupabaseClient().from(this.getTableName()).select("*").eq("restaurant_id",e);return r?(console.error("Error loading all dishes:",r),[]):t||[]})}cloneDish(e,t){return s(this,null,function*(){console.log("\u{1F300} Clonando piatto:",e,"per menu:",t);try{let a=this.dataSubject.value.find(l=>l.id===e&&!l.deleted_at);if(!a)return console.error("\u274C Piatto originale non trovato o cancellato"),null;let r=a,{id:o,created_at:n,deleted_at:i}=r,c=f(r,["id","created_at","deleted_at"]),u=c.name.replace(/ \(Copia.*\)$/,"").replace(/ - .*$/,""),h=t?`${u} - ${t}`:`${u} (Copia)`,p=this.dataSubject.value.filter(l=>l.name.startsWith(u)&&l.id!==e&&!l.deleted_at);if(p.length>0){let l=p.length+1;h=t?`${u} - ${t} (${l})`:`${u} (Copia ${l})`}let _=m(b({},c),{name:h,status:"available"});return console.log("\u{1F4DD} Creando piatto clonato:",h),yield this.createDish(_)}catch(a){return console.error("\u274C Errore durante la clonazione del piatto:",a),null}})}restoreDish(e){return s(this,null,function*(){console.log("\u267B\uFE0F Ripristino piatto:",e);try{return yield this.update(e,{deleted_at:null,status:"available"})}catch(t){return console.error("\u274C Errore durante il ripristino del piatto:",t),!1}})}uploadDishImage(e,t){return s(this,null,function*(){let r=yield this.getCurrentRestaurantId();if(console.log("\u{1F4F8} uploadDishImage - restaurantId:",r,"| dishId:",e,"| file:",t?.name),!r)return console.error("\u274C uploadDishImage - restaurantId null, esco"),null;let a=this.supabaseService.getSupabaseClient(),o=t.name.normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-zA-Z0-9.\-_]/g,"_").replace(/_+/g,"_").toLowerCase(),n=`restaurants/${r}/dishes/${e}_${Date.now()}_${o}`;console.log("\u{1F4C2} Path upload:",n);try{let{error:i}=yield a.storage.from("restaurant-images").upload(n,t,{upsert:!0});if(i)throw console.error("\u274C Errore storage upload:",i),i;let{data:{publicUrl:c}}=a.storage.from("restaurant-images").getPublicUrl(n);console.log("\u2705 Upload OK - publicUrl:",c);let u=yield this.updateDish(e,{image_url:c});return console.log("\u2705 updateDish image_url result:",u),u?c:null}catch(i){return console.error("\u274C Error uploading dish image:",i),null}})}static \u0275fac=function(t){return new(t||g)};static \u0275prov=v({token:g,factory:g.\u0275fac,providedIn:"root"})};export{S as a};
