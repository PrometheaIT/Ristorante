import{a as Ne}from"./chunk-HZ2ZCP6D.js";import{a as B}from"./chunk-MD3ZW5UF.js";import"./chunk-MVDMN4LR.js";import"./chunk-ZLVV5NVO.js";import{b as fe}from"./chunk-DHGR3C5D.js";import{a as _e,b as Se,d as xe,e as Te,g as we,h as Me,i as Ee,j as Pe,l as Fe,q as ye,r as Ce,s as Ie,t as De,u as ke,x as Ve}from"./chunk-T5BKZD3Y.js";import{b as Y}from"./chunk-KCQE4MF2.js";import{c as pe,d as ge,e as be,l as ve}from"./chunk-VGLLKVAA.js";import{Ab as l,Ba as c,Bb as H,Cb as w,Db as j,Eb as oe,Fb as he,Gb as V,Hb as N,Ib as R,La as se,Nb as ue,Ra as de,V as W,Wa as E,Xb as M,_ as F,a as le,bb as ce,cb as g,da as u,db as a,ea as p,eb as o,fb as te,ka as I,lb as P,ob as b,qb as h,sb as ie,tb as ne,ub as ae,wb as L,xb as O,zb as me}from"./chunk-QECS2EDN.js";import{a as f,b as S,j as T}from"./chunk-4ZZIO3ZI.js";var X=class d{supabaseService=F(Y);mergeTables(t,e,i,n){return T(this,null,function*(){try{let r=t.map(_=>_.id),s={restaurant_id:n,floor_plan_id:i,table_name:e.table_name,table_number:e.table_number,capacity:e.capacity,shape:"rectangle",position_x:e.position_x,position_y:e.position_y,width:e.width,height:e.height,rotation:0,is_active:!0,is_online_bookable:!0,is_merged:!1,parent_table_id:null,merged_tables_ids:r},{data:m,error:v}=yield this.supabaseService.getSupabaseClient().from("tables").insert(s).select().single();if(v)throw v;for(let _ of t){let y={is_online_bookable:!1,is_merged:!0,parent_table_id:m.id},{error:D}=yield this.supabaseService.getSupabaseClient().from("tables").update(y).eq("id",_.id);if(D)throw D}return m}catch(r){return console.error("\u274C Error merging tables:",r),null}})}splitMergedTable(t){return T(this,null,function*(){try{console.log("\u{1F50D} Cerco tavoli figli per:",t.id);let{data:e,error:i}=yield this.supabaseService.getSupabaseClient().from("tables").select("*").eq("parent_table_id",t.id);if(i)throw console.error("\u274C Errore nel fetch dei tavoli figli:",i),i;console.log("\u{1F4CB} Tavoli figli trovati:",e?.length);for(let r of e||[]){let s={is_online_bookable:!0,is_merged:!1,parent_table_id:null};console.log("\u{1F504} Ripristino tavolo:",r.table_number);let{error:m}=yield this.supabaseService.getSupabaseClient().from("tables").update(s).eq("id",r.id);if(m)throw console.error("\u274C Errore nell'aggiornamento del tavolo:",m),m}console.log("\u{1F5D1}\uFE0F Elimino tavolo unito principale:",t.id);let{error:n}=yield this.supabaseService.getSupabaseClient().from("tables").delete().eq("id",t.id);if(n)throw console.error("\u274C Errore nell'eliminazione del tavolo unito:",n),n;return console.log("\u2705 Separazione completata con successo"),!0}catch(e){return console.error("\u274C Error splitting merged table:",e),!1}})}getMergedTableChildren(t){return T(this,null,function*(){try{let{data:e,error:i}=yield this.supabaseService.getSupabaseClient().from("tables").select("*").eq("parent_table_id",t);if(i)throw i;return e||[]}catch(e){return console.error("\u274C Error fetching merged table children:",e),[]}})}static \u0275fac=function(e){return new(e||d)};static \u0275prov=W({token:d,factory:d.\u0275fac,providedIn:"root"})};var A=class d{state=I({floorPlans:[],currentFloorPlan:null,tables:[],selectedTable:null,selectedTables:[],isDrawing:!1,isMergeMode:!1,showTableModal:!1,showEditTableModal:!1,showMergeModal:!1,showDimensionsModal:!1,tableForm:this.getDefaultTableForm()});floorPlans=M(()=>this.state().floorPlans);currentFloorPlan=M(()=>this.state().currentFloorPlan);tables=M(()=>this.state().tables);selectedTable=M(()=>this.state().selectedTable);selectedTables=M(()=>this.state().selectedTables);isDrawing=M(()=>this.state().isDrawing);isMergeMode=M(()=>this.state().isMergeMode);showTableModal=M(()=>this.state().showTableModal);showEditTableModal=M(()=>this.state().showEditTableModal);showMergeModal=M(()=>this.state().showMergeModal);showDimensionsModal=M(()=>this.state().showDimensionsModal);tableForm=M(()=>this.state().tableForm);setFloorPlans(t){this.state.update(e=>S(f({},e),{floorPlans:t}))}setCurrentFloorPlan(t){this.state.update(e=>S(f({},e),{currentFloorPlan:t}))}setTables(t){this.state.update(e=>S(f({},e),{tables:t}))}setSelectedTable(t){this.state.update(e=>S(f({},e),{selectedTable:t}))}setSelectedTables(t){this.state.update(e=>S(f({},e),{selectedTables:t}))}setIsDrawing(t){this.state.update(e=>S(f({},e),{isDrawing:t}))}setIsMergeMode(t){this.state.update(e=>S(f({},e),{isMergeMode:t}))}setShowTableModal(t){this.state.update(e=>S(f({},e),{showTableModal:t}))}setShowEditTableModal(t){this.state.update(e=>S(f({},e),{showEditTableModal:t}))}setShowMergeModal(t){this.state.update(e=>S(f({},e),{showMergeModal:t}))}setShowDimensionsModal(t){this.state.update(e=>S(f({},e),{showDimensionsModal:t}))}updateTableForm(t){this.state.update(e=>S(f({},e),{tableForm:f(f({},e.tableForm),t)}))}resetTableForm(){this.state.update(t=>S(f({},t),{tableForm:this.getDefaultTableForm()}))}addToSelectedTables(t){this.state.update(e=>S(f({},e),{selectedTables:[...e.selectedTables,t]}))}removeFromSelectedTables(t){this.state.update(e=>S(f({},e),{selectedTables:e.selectedTables.filter(i=>i.id!==t)}))}clearSelectedTables(){this.state.update(t=>S(f({},t),{selectedTables:[]}))}initializeTableFormForShape(t){let e=this.state().tableForm;switch(t){case"circle":e.borderRadius=50,e.gridHeight=e.gridWidth,e.height=e.width;break;case"square":e.borderRadius=12,e.gridHeight=e.gridWidth,e.height=e.width;break;case"rectangle":e.borderRadius=8;break}e.shape=t,this.state.update(i=>S(f({},i),{tableForm:f({},e)}))}updateAutoTableNumber(t){this.state.update(e=>S(f({},e),{tableForm:S(f({},e.tableForm),{tableNumber:t.toString()})}))}resetState(){this.state.set({floorPlans:[],currentFloorPlan:null,tables:[],selectedTable:null,selectedTables:[],isDrawing:!1,isMergeMode:!1,showTableModal:!1,showEditTableModal:!1,showMergeModal:!1,showDimensionsModal:!1,tableForm:this.getDefaultTableForm()})}getDefaultTableForm(){return{shape:"rectangle",gridWidth:6,gridHeight:4,width:120,height:80,capacity:2,borderRadius:8,tableName:"",tableNumber:"",isOnlineBookable:!0,isMerged:!1}}resetForNewFloorPlan(){this.state.update(t=>S(f({},t),{tables:[],selectedTable:null,selectedTables:[],isDrawing:!1,isMergeMode:!1,showTableModal:!1,showEditTableModal:!1,showMergeModal:!1,showDimensionsModal:!1}))}static \u0275fac=function(e){return new(e||d)};static \u0275prov=W({token:d,factory:d.\u0275fac,providedIn:"root"})};var Z=class d{stateService=F(A);tableService=F(B);dragState=null;rafId=null;startTableDrag(t,e,i,n=1){let r=this.tableService.getTables(),s=r.find(C=>C.id===t);if(!s){console.error("\u274C Tavolo non trovato:",t);return}let m=i.getBoundingClientRect(),v=(e.clientX-m.left)/n,_=(e.clientY-m.top)/n;console.log("\u{1F7E2} START DRAG per tavolo:",s.table_number,"scale:",n);let y=this.getTablesInMergeGroup(s,r),D=new Map(y.map(C=>[C.id,{x:C.position_x,y:C.position_y}])),x=C=>{this.dragState?.isDragging&&(this.rafId&&cancelAnimationFrame(this.rafId),this.rafId=requestAnimationFrame(()=>{this.handlePointerMove(i,C,r,n)}))},k=()=>this.handlePointerUp();this.dragState={isDragging:!0,startX:v,startY:_,initialPositions:D,moveHandler:x,upHandler:k},document.addEventListener("pointermove",x),document.addEventListener("pointerup",k,{once:!0});let z=e.target;if(z)try{z.setPointerCapture(e.pointerId),z.style.touchAction="none"}catch{console.warn("Pointer capture not supported")}}handlePointerMove(t,e,i,n){if(!this.dragState?.isDragging)return;let r=t.getBoundingClientRect(),s=(e.clientX-r.left)/n,m=(e.clientY-r.top)/n,v=s-this.dragState.startX,_=m-this.dragState.startY,y=this.stateService.currentFloorPlan();if(!y)return;let D=this.stateService.tables().map(x=>{let k=this.dragState.initialPositions.get(x.id);if(!k)return x;let z=k.x+v,C=k.y+_;z=Math.round(z/20)*20,C=Math.round(C/20)*20;let Q=y.width-x.width,K=y.height-x.height,G=Math.max(0,Math.min(z,Q)),q=Math.max(0,Math.min(C,K)),J=S(f({},x),{position_x:G,position_y:q}),ee=Array.from(this.dragState.initialPositions.keys());return this.tableService.checkTableOverlap(J,ee)?x:S(f({},x),{position_x:G,position_y:q})});this.stateService.setTables(D)}handlePointerUp(){return T(this,null,function*(){if(!this.dragState?.isDragging)return;console.log("\u{1F7E2} HANDLE POINTER UP - Saving final positions");let t=[];for(let[e,i]of this.dragState.initialPositions){let n=this.stateService.tables().find(r=>r.id===e);n&&(n.position_x!==i.x||n.position_y!==i.y)&&(console.log(`\u{1F4BE} Saving table ${n.table_number}: (${i.x}, ${i.y}) \u2192 (${n.position_x}, ${n.position_y})`),t.push(this.tableService.updateTable(e,{position_x:n.position_x,position_y:n.position_y})))}try{yield Promise.all(t),console.log("\u2705 All table positions saved successfully")}catch(e){console.error("\u274C Error saving table positions:",e)}this.cleanupDrag()})}cleanupDrag(){this.dragState?.moveHandler&&document.removeEventListener("pointermove",this.dragState.moveHandler),this.rafId&&(cancelAnimationFrame(this.rafId),this.rafId=null),this.dragState=null}getTablesInMergeGroup(t,e){let i=[t];if(t.merged_tables_ids&&t.merged_tables_ids.length>0&&!t.parent_table_id)t.merged_tables_ids.forEach(n=>{let r=e.find(s=>s.id===n);r&&i.push(r)});else if(t.parent_table_id){let n=e.find(r=>r.id===t.parent_table_id);n&&(i.find(r=>r.id===n.id)||i.push(n),n.merged_tables_ids&&n.merged_tables_ids.forEach(r=>{if(r!==t.id){let s=e.find(m=>m.id===r);s&&!i.find(m=>m.id===s.id)&&i.push(s)}}))}return i}handleCanvasClick(t,e){if(!this.stateService.isDrawing())return null;let i=e.getBoundingClientRect(),n=t.clientX-i.left,r=t.clientY-i.top,s=n,m=r;return s=Math.round(n/20)*20,m=Math.round(r/20)*20,{x:s,y:m}}areTablesAdjacent(t,e,i=0){let n=t.position_x,r=t.position_x+t.width,s=t.position_y,m=t.position_y+t.height,v=e.position_x,_=e.position_x+e.width,y=e.position_y,D=e.position_y+e.height,x=2,k=n-i-x,z=r+i+x,C=s-i-x,Q=m+i+x,K=v-x,G=_+x,q=y-x,J=D+x,ee=k<=G&&z>=K,re=C<=J&&Q>=q;return ee&&re}areSelectedTablesAdjacent(t,e){if(t.length<2)return!0;let i=new Map;t.forEach(s=>{i.set(s.id,[])});for(let s=0;s<t.length;s++)for(let m=s+1;m<t.length;m++)this.areTablesAdjacent(t[s],t[m])&&(i.get(t[s].id).push(t[m].id),i.get(t[m].id).push(t[s].id));let n=new Set,r=[t[0].id];for(;r.length>0;){let s=r.shift();n.has(s)||(n.add(s),(i.get(s)||[]).forEach(v=>{n.has(v)||r.push(v)}))}return n.size===t.length}getAdjacentTablesToSelection(t,e){if(t.length===0)return[];let i=[],n=t.map(r=>r.id);return e.forEach(r=>{if(!(n.includes(r.id)||r.is_merged)){for(let s of t)if(this.areTablesAdjacent(r,s)){i.push(r);break}}}),i}showAdjacencyWarning(t,e){let i=`Il Tavolo ${t.table_number} non \xE8 vicino ai tavoli selezionati. 
  Seleziona solo tavoli che si toccano tra loro.`;alert(i)}findTableAtPosition(t,e,i){for(let r of t){let s=r.position_x,m=r.position_x+r.width,v=r.position_y,_=r.position_y+r.height;if(e>=s-15&&e<=m+15&&i>=v-15&&i<=_+15)return r}return null}findAdjacentGroups(t){let e=[],i=new Set;for(let n of t)if(!i.has(n.id)){let r=this.findConnectedTables(n,t,i);r.length>1&&e.push(r)}return e}findConnectedTables(t,e,i){let n=[],r=[t];for(;r.length>0;){let s=r.shift();if(!i.has(s.id)){i.add(s.id),n.push(s);for(let m of e)!i.has(m.id)&&m.id!==s.id&&this.areTablesAdjacent(s,m,0)&&r.push(m)}}return n}static \u0275fac=function(e){return new(e||d)};static \u0275prov=W({token:d,factory:d.\u0275fac,providedIn:"root"})};var $=class d{tableService=F(B);stateService=F(A);rotateTable(t,e){return T(this,null,function*(){try{let i=this.getMainTableForRotation(t);if(!i)return console.error("\u274C Tavolo non valido per la rotazione"),!1;console.log(`\u{1F504} Rotazione tavolo ${i.table_number} di ${e}\xB0`);let n=(i.rotation+e)%360;return this.updateTablesRotationLocal([i],e),(yield this.tableService.rotateTable(i.id,n))?(console.log("\u2705 Tavolo ruotato con successo"),!0):(console.error("\u274C Errore nel salvataggio della rotazione"),yield this.tableService.loadData(),!1)}catch(i){return console.error("\u274C Errore nella rotazione:",i),!1}})}rotateToAngle(t,e){let i=t.rotation||0;return(e-i+180)%360-180}getMainTableForRotation(t){let e=this.stateService.currentFloorPlan();if(!e)return null;let i=this.tableService.getAllTablesByFloorPlan(e.id);if(console.log("\u{1F50D} Cerca tavolo principale per rotazione:",{tableId:t.id,isMerged:t.is_merged,parentId:t.parent_table_id}),t.parent_table_id){console.log("\u{1F476} Tavolo figlio, cerco il parent");let n=i.find(r=>r.id===t.parent_table_id);if(n)return console.log("\u2705 Trovato parent:",n.id),n}return console.log("\u2705 Usa il tavolo stesso come principale"),t}updateTablesRotationLocal(t,e){let n=this.stateService.tables().map(s=>{if(t.find(v=>v.id===s.id)){let v=(s.rotation+e)%360;return S(f({},s),{rotation:v})}return s});this.stateService.setTables(n);let r=this.stateService.selectedTable();if(r&&t.some(s=>s.id===r.id)){let s=n.find(m=>m.id===r.id);s&&this.stateService.setSelectedTable(s)}}getTablesInRotationGroup(t){let e=this.stateService.currentFloorPlan();if(!e)return[t];let i=this.tableService.getAllTablesByFloorPlan(e.id),n=[t];if(t.merged_tables_ids&&t.merged_tables_ids.length>0&&!t.parent_table_id)t.merged_tables_ids.forEach(s=>{let m=i.find(v=>v.id===s);m&&n.push(m)});else if(t.parent_table_id){let s=i.find(m=>m.id===t.parent_table_id);s&&(n.push(s),s.merged_tables_ids&&s.merged_tables_ids.forEach(m=>{if(m!==t.id){let v=i.find(_=>_.id===m);v&&n.push(v)}}))}return n.filter((s,m,v)=>m===v.findIndex(_=>_.id===s.id))}static \u0275fac=function(e){return new(e||d)};static \u0275prov=W({token:d,factory:d.\u0275fac,providedIn:"root"})};var ze=["floorPlanCanvas"],We=["canvasContainer"],He=(d,t,e)=>({"width.px":d,"height.px":t,"border-radius":e});function Ae(d,t){if(d&1&&(a(0,"option",45),l(1),o()),d&2){let e=t.$implicit;g("ngValue",e.id),c(),oe(" ",e.name," (",e.width,"\xD7",e.height,") ")}}function Oe(d,t){if(d&1){let e=P();a(0,"div",46)(1,"div",12)(2,"input",47),R("ngModelChange",function(n){u(e);let r=h();return N(r.editedFloorPlanName,n)||(r.editedFloorPlanName=n),p(n)}),b("keyup.enter",function(){u(e);let n=h();return p(n.saveFloorPlanName())})("keyup.escape",function(){u(e);let n=h();return p(n.cancelEditFloorPlanName())}),o(),a(3,"div",4)(4,"button",48),b("click",function(){u(e);let n=h();return p(n.saveFloorPlanName())}),a(5,"span",17),l(6,"check"),o()(),a(7,"button",49),b("click",function(){u(e);let n=h();return p(n.cancelEditFloorPlanName())}),a(8,"span",17),l(9,"close"),o()()()(),a(10,"div",50),l(11," Premi Invio per salvare, Esc per annullare "),o()()}if(d&2){let e=h();c(2),V("ngModel",e.editedFloorPlanName)}}function Be(d,t){if(d&1){let e=P();a(0,"div",4)(1,"button",64),b("click",function(){u(e);let n=h(2);return p(n.rotateToAngle(0))}),a(2,"span",17),l(3,"north"),o()(),a(4,"button",65),b("click",function(){u(e);let n=h(2);return p(n.rotateToAngle(90))}),a(5,"span",17),l(6,"east"),o()(),a(7,"button",66),b("click",function(){u(e);let n=h(2);return p(n.rotateToAngle(180))}),a(8,"span",17),l(9,"south"),o()(),a(10,"button",67),b("click",function(){u(e);let n=h(2);return p(n.rotateToAngle(270))}),a(11,"span",17),l(12,"west"),o()()()}}function Le(d,t){d&1&&(a(0,"div",68)(1,"span",69),l(2,"info"),o(),l(3," Premi Ctrl + rotellina del mouse per ruotare di \xB15\xB0 "),o())}function je(d,t){if(d&1){let e=P();a(0,"div",51)(1,"div",52)(2,"div",53)(3,"div",54)(4,"span",17),l(5,"rotate_right"),o(),a(6,"div")(7,"strong"),l(8,"Rotazione Tavolo"),o(),a(9,"div",7),l(10,"Ruota il tavolo selezionato"),o()()(),a(11,"div",12),E(12,Be,13,0,"div",55),a(13,"div",56)(14,"button",57),b("click",function(){u(e);let n=h();return p(n.rotateSelectedTable(-30))}),a(15,"span",17),l(16,"rotate_left"),o()(),a(17,"div",58)(18,"span",59),l(19),o(),a(20,"span",60),l(21,"Rotazione"),o()(),a(22,"button",61),b("click",function(){u(e);let n=h();return p(n.rotateSelectedTable(30))}),a(23,"span",17),l(24,"rotate_right"),o()()(),a(25,"button",62),b("click",function(){u(e);let n=h();return p(n.rotateToAngle(0))}),a(26,"span",17),l(27,"restart_alt"),o()()()(),E(28,Le,4,0,"div",63),o()()}if(d&2){let e=h();c(12),g("ngIf",!e.isMobileView()),c(2),g("disabled",e.isRotating),c(5),w("",e.selectedTable().rotation||0,"\xB0"),c(3),g("disabled",e.isRotating),c(3),g("disabled",e.isRotating),c(3),g("ngIf",e.selectedTable()&&!e.isDrawing()&&!e.isMobileView())}}function Ge(d,t){d&1&&(a(0,"span",76),l(1," Unito "),o())}function qe(d,t){if(d&1){let e=P();a(0,"button",77),b("click",function(){u(e);let n=h(2);return p(n.onSplitTable(n.selectedTable()))}),a(1,"span",17),l(2,"call_split"),o(),l(3," Separa "),o()}}function Ye(d,t){if(d&1){let e=P();a(0,"div",70)(1,"div",53)(2,"div",71)(3,"strong"),l(4,"Tavolo Selezionato"),o(),a(5,"span",7),l(6),E(7,Ge,2,0,"span",72),o()(),a(8,"div",4)(9,"button",73),b("click",function(){u(e);let n=h();return p(n.openEditTableModal())}),a(10,"span",17),l(11,"edit"),o(),l(12," Modifica "),o(),E(13,qe,4,0,"button",74),a(14,"button",75),b("click",function(){u(e);let n=h();return p(n.deselectAll())}),a(15,"span",17),l(16,"close"),o(),l(17," Deseleziona "),o()()()()}if(d&2){let e=h();c(6),j(" Tavolo ",e.selectedTable().table_number," - ",e.selectedTable().capacity," persone "),c(),g("ngIf",e.selectedTable().merged_tables_ids&&e.selectedTable().merged_tables_ids.length>0),c(6),g("ngIf",e.selectedTable().merged_tables_ids&&e.selectedTable().merged_tables_ids.length>0)}}function Xe(d,t){d&1&&(a(0,"div",7),l(1," Seleziona 2-4 tavoli confinanti da unire "),o())}function Ue(d,t){if(d&1&&(a(0,"span",88),l(1),o()),d&2){let e=h(3);c(),w(" (",e.getSelectedTableNumbers(),") ")}}function Ze(d,t){if(d&1&&(a(0,"div",7),l(1),E(2,Ue,2,1,"span",87),o()),d&2){let e=h(2);c(),w(" Tavoli selezionati: ",e.selectedTables().length," "),c(),g("ngIf",e.selectedTables().length>0)}}function $e(d,t){if(d&1&&(a(0,"span"),l(1),o()),d&2){let e=h(2);c(),w("(",e.selectedTables().length,")")}}function Qe(d,t){if(d&1){let e=P();a(0,"div",89)(1,"div",54)(2,"span",90),l(3,"info"),o(),a(4,"div",91)(5,"p",21),l(6),o()(),a(7,"button",92),b("click",function(){u(e);let n=h(2);return p(n.highlightMessage.set(null))}),a(8,"span",17),l(9,"close"),o()()()()}if(d&2){let e=h(2);c(5),O("text-warning",!0),c(),w(" ",e.highlightMessage()," ")}}function Ke(d,t){d&1&&(a(0,"div",93)(1,"span",17),l(2,"info"),o(),l(3," Seleziona un altro tavolo adiacente per unire "),o())}function Je(d,t){d&1&&(a(0,"div",94)(1,"span",17),l(2,"warning"),o(),l(3," I tavoli selezionati non sono tutti adiacenti tra loro "),o())}function et(d,t){if(d&1&&(a(0,"div",95)(1,"span",17),l(2,"check_circle"),o(),l(3),o()),d&2){let e=h(2);c(3),w(" Tavoli pronti per l'unione! Capacit\xE0 totale: ",e.getTotalCapacity()," persone ")}}function tt(d,t){if(d&1){let e=P();a(0,"div",78)(1,"div",53)(2,"div")(3,"strong"),l(4,"Modalit\xE0 Unione Tavoli"),o(),E(5,Xe,2,0,"div",79)(6,Ze,3,2,"div",79),o(),a(7,"div",4)(8,"button",75),b("click",function(){u(e);let n=h();return p(n.highlightAdjacentTables())}),a(9,"span",17),l(10,"highlight"),o(),l(11,` Mostra vicini
`),o(),a(12,"button",80),b("click",function(){u(e);let n=h();return p(n.openMergeModal())}),a(13,"span",17),l(14,"merge"),o(),l(15," Crea tavolo unito "),E(16,$e,2,1,"span",81),o(),a(17,"button",82),b("click",function(){u(e);let n=h();return p(n.stateService.clearSelectedTables())}),a(18,"span",17),l(19,"clear"),o(),l(20," Deseleziona "),o()()(),E(21,Qe,10,3,"div",83),a(22,"div",46),E(23,Ke,4,0,"div",84)(24,Je,4,0,"div",85)(25,et,4,1,"div",86),o()()}if(d&2){let e=h();c(5),g("ngIf",e.selectedTables().length===0),c(),g("ngIf",e.selectedTables().length>0),c(6),O("active",e.canMergeTables()),g("disabled",!e.canMergeTables()),c(4),g("ngIf",e.selectedTables().length>0),c(),g("disabled",e.selectedTables().length===0),c(4),g("ngIf",e.highlightMessage()),c(2),g("ngIf",e.selectedTables().length===1),c(),g("ngIf",e.selectedTables().length>1&&!e.canMergeTables()),c(),g("ngIf",e.canMergeTables())}}function it(d,t){if(d&1&&te(0,"div",102),d&2){let e=h(2);L("background-size",e.gridSize,"px")}}function nt(d,t){if(d&1){let e=P();a(0,"div",103),b("pointerdown",function(n){let r=u(e).$implicit,s=h(2);return p(s.onTablePointerDown(n,r))}),a(1,"div",104)(2,"div",105),l(3),o(),a(4,"div",106),l(5),o()()()}if(d&2){let e=t.$implicit,i=h(2);me(i.getTableClass(e)),g("ngStyle",i.getTableStyle(e)),ce("data-table-id",e.id),c(3),H(e.table_number),c(2),w("",e.capacity," p")}}function at(d,t){d&1&&(a(0,"div",107)(1,"span",17),l(2,"table_restaurant"),o(),a(3,"h3"),l(4,"Nessun tavolo configurato"),o(),a(5,"p"),l(6,'Clicca su "Aggiungi" per creare il primo tavolo'),o()())}function ot(d,t){if(d&1&&(a(0,"div",96)(1,"div",97,1),te(3,"div",98),E(4,it,1,2,"div",99)(5,nt,6,6,"div",100)(6,at,7,0,"div",101),o()()),d&2){let e=h();L("width",e.floorPlanWidth()*e.canvasScale(),"px")("height",e.floorPlanHeight()*e.canvasScale(),"px"),c(),L("width",e.floorPlanWidth(),"px")("height",e.floorPlanHeight(),"px")("transform","scale("+e.canvasScale()+")")("transform-origin","0 0"),c(3),g("ngIf",e.snapToGrid),c(),g("ngForOf",e.tables())("ngForTrackBy",e.trackByTableId),c(),g("ngIf",e.tables().length===0)}}function rt(d,t){if(d&1){let e=P();a(0,"div",108)(1,"span",17),l(2,"map"),o(),a(3,"h3"),l(4,"Nessuna mappa selezionata"),o(),a(5,"p"),l(6,"Crea una nuova mappa o seleziona una esistente"),o(),a(7,"button",109),b("click",function(){u(e);let n=h();return p(n.createNewFloorPlan())}),a(8,"span",17),l(9,"add"),o(),l(10," Crea Nuova Mappa "),o()()}}function lt(d,t){if(d&1){let e=P();a(0,"div",135),b("click",function(){let n=u(e).$implicit,r=h(2);return p(r.onShapeSelect(n))}),a(1,"div",136)(2,"span",17),l(3),o(),a(4,"strong"),l(5),o()()()}if(d&2){let e=t.$implicit,i=h(2);O("active",i.stateService.tableForm().shape===e.type),c(3),H(e.icon),c(2),H(e.name)}}function st(d,t){if(d&1){let e=P();a(0,"div",10)(1,"label",11),l(2,"Larghezza (quadrati)"),o(),a(3,"input",137),b("ngModelChange",function(n){u(e);let r=h(2);return p(r.onGridWidthChange(n))}),o(),a(4,"span",7),l(5),o()()}if(d&2){let e=h(2);c(3),g("ngModel",e.stateService.tableForm().gridWidth)("disabled",e.stateService.tableForm().shape==="circle"||e.stateService.tableForm().shape==="square"),c(2),w("1 quadrato = ",e.gridSize,"px")}}function dt(d,t){if(d&1){let e=P();a(0,"div",10)(1,"label",11),l(2,"Altezza (quadrati)"),o(),a(3,"input",138),b("ngModelChange",function(n){u(e);let r=h(2);return p(r.onGridHeightChange(n))}),o(),a(4,"span",7),l(5),o()()}if(d&2){let e=h(2);c(3),g("ngModel",e.stateService.tableForm().gridHeight)("disabled",e.stateService.tableForm().shape==="circle"||e.tableForm().isMerged!==void 0&&e.tableForm().isMerged),c(2),w("1 quadrato = ",e.gridSize,"px")}}function ct(d,t){if(d&1){let e=P();a(0,"div",10)(1,"label",11),l(2,"Larghezza (px)"),o(),a(3,"input",139),b("ngModelChange",function(n){u(e);let r=h(2);return p(r.onWidthChange(n))}),o(),a(4,"span",7),l(5,"Min: 20px, Max: 1000px"),o()()}if(d&2){let e=h(2);c(3),g("ngModel",e.stateService.tableForm().width)("disabled",e.stateService.tableForm().shape==="circle")}}function mt(d,t){if(d&1){let e=P();a(0,"div",10)(1,"label",11),l(2,"Altezza (px)"),o(),a(3,"input",140),b("ngModelChange",function(n){u(e);let r=h(2);return p(r.onHeightChange(n))}),o(),a(4,"span",7),l(5,"Min: 20px, Max: 1000px"),o()()}if(d&2){let e=h(2);c(3),g("ngModel",e.stateService.tableForm().height)("disabled",e.stateService.tableForm().shape==="circle"||e.stateService.tableForm().shape==="square")}}function ht(d,t){if(d&1){let e=P();a(0,"div",10)(1,"label",11),l(2,"Border Radius (px)"),o(),a(3,"input",141),b("ngModelChange",function(n){u(e);let r=h(2);return p(r.onBorderRadiusChange(n))}),o(),a(4,"div",142)(5,"span"),l(6,"0px (spigoli vivi)"),o(),a(7,"span")(8,"strong"),l(9),o()(),a(10,"span"),l(11,"50px (molto arrotondato)"),o()()()}if(d&2){let e=h(2);c(3),g("ngModel",e.stateService.tableForm().borderRadius),c(6),w("",e.stateService.tableForm().borderRadius,"px")}}function ut(d,t){d&1&&(a(0,"div",10)(1,"div",143)(2,"span",17),l(3,"info"),o(),a(4,"span"),l(5,"Per i tavoli circolari il border radius \xE8 automaticamente impostato al 50%"),o()()())}function pt(d,t){if(d&1&&(a(0,"div",144),l(1),o()),d&2){let e=h(2);c(),he(" DEBUG: width=",e.previewWidth(),", height=",e.previewHeight(),", shape=",e.stateService.tableForm().shape,", borderRadius=",e.stateService.tableForm().borderRadius," ")}}function gt(d,t){if(d&1){let e=P();a(0,"button",145),b("click",function(){u(e);let n=h(2);return p(n.onDeleteTable())}),a(1,"span",17),l(2,"delete"),o(),l(3," Elimina "),o()}}function bt(d,t){if(d&1){let e=P();a(0,"div",110)(1,"div",111)(2,"div",112)(3,"div",54)(4,"div",113)(5,"span",17),l(6),o()(),a(7,"div")(8,"h1",6),l(9),o()()(),a(10,"button",114),b("click",function(){u(e);let n=h();return p(n.stateService.setShowTableModal(!1))}),a(11,"span",17),l(12,"close"),o()()(),a(13,"div",71)(14,"form")(15,"div",8)(16,"div",115)(17,"label",11),l(18,"Forma del Tavolo"),o(),a(19,"div",116),E(20,lt,6,4,"div",117),o()(),a(21,"div",118)(22,"div",10)(23,"label",11),l(24,"Numero Tavolo"),o(),a(25,"input",119),R("ngModelChange",function(n){u(e);let r=h();return N(r.stateService.tableForm().tableNumber,n)||(r.stateService.tableForm().tableNumber=n),p(n)}),o()(),a(26,"div",10)(27,"label",11),l(28,"Capacit\xE0"),o(),a(29,"input",120),R("ngModelChange",function(n){u(e);let r=h();return N(r.stateService.tableForm().capacity,n)||(r.stateService.tableForm().capacity=n),p(n)}),o()()(),a(30,"div",118)(31,"div",10)(32,"label",11),l(33,"Nome Tavolo (opzionale)"),o(),a(34,"input",121),R("ngModelChange",function(n){u(e);let r=h();return N(r.stateService.tableForm().tableName,n)||(r.stateService.tableForm().tableName=n),p(n)}),o()(),a(35,"div",10)(36,"label",122)(37,"input",123),R("ngModelChange",function(n){u(e);let r=h();return N(r.stateService.tableForm().isOnlineBookable,n)||(r.stateService.tableForm().isOnlineBookable=n),p(n)}),o(),a(38,"div",26)(39,"strong"),l(40,"Prenotabile online"),o(),a(41,"span",7),l(42,"Se deselezionato, prenotabile solo dal personale"),o()()()()(),a(43,"div",118),E(44,st,6,3,"div",124)(45,dt,6,3,"div",124)(46,ct,6,2,"div",124)(47,mt,6,2,"div",124),o(),a(48,"div",118),E(49,ht,12,2,"div",124)(50,ut,6,0,"div",124),o(),a(51,"div",125)(52,"strong"),l(53,"Anteprima"),o(),a(54,"div",126)(55,"div",127)(56,"div",128)(57,"span",105),l(58),o(),a(59,"span",106),l(60),o()()()(),a(61,"div",129),l(62),o(),E(63,pt,2,4,"div",130),o()(),a(64,"div",131)(65,"button",132),b("click",function(){u(e);let n=h();return p(n.stateService.setShowTableModal(!1))}),l(66," Annulla "),o(),a(67,"button",133),b("click",function(){u(e);let n=h();return p(n.onSaveTable())}),a(68,"span",17),l(69),o(),l(70),o(),E(71,gt,4,0,"button",134),o()()()()()}if(d&2){let e=h();c(6),H(e.modalMode()==="create"?"add_circle":"edit"),c(3),w(" ",e.modalMode()==="create"?"Crea Nuovo Tavolo":"Modifica Tavolo"," "),c(11),g("ngForOf",e.tableShapes),c(5),V("ngModel",e.stateService.tableForm().tableNumber),c(4),V("ngModel",e.stateService.tableForm().capacity),c(5),V("ngModel",e.stateService.tableForm().tableName),c(3),V("ngModel",e.stateService.tableForm().isOnlineBookable),c(7),g("ngIf",e.modalMode()==="create"),c(),g("ngIf",e.modalMode()==="create"),c(),g("ngIf",e.modalMode()==="edit"),c(),g("ngIf",e.modalMode()==="edit"),c(2),g("ngIf",e.stateService.tableForm().shape!=="circle"),c(),g("ngIf",e.stateService.tableForm().shape==="circle"),c(5),O("shape-circle",e.stateService.tableForm().shape==="circle"),g("ngStyle",ue(25,He,e.previewWidth(),e.previewHeight(),e.previewBorderRadius())),c(3),H(e.stateService.tableForm().tableNumber||"1"),c(2),w("",e.stateService.tableForm().capacity," p"),c(2),oe(" ",e.previewWidth()," \xD7 ",e.previewHeight()," px | Border Radius: ",e.stateService.tableForm().shape==="circle"?"50% (automatico)":e.stateService.tableForm().borderRadius+"px"," "),c(),g("ngIf",!1),c(6),H(e.modalMode()==="create"?"add":"save"),c(),w(" ",e.modalMode()==="create"?"Crea Tavolo":"Aggiorna Tavolo"," "),c(),g("ngIf",e.modalMode()==="edit")}}function vt(d,t){if(d&1){let e=P();a(0,"div",110)(1,"div",111)(2,"div",112)(3,"div",146)(4,"div",113)(5,"span",147),l(6,"aspect_ratio"),o()(),a(7,"h1",148),l(8,"Dimensioni Sala"),o()(),a(9,"button",114),b("click",function(){u(e);let n=h();return p(n.onCancelDimensionsModal())}),a(10,"span",17),l(11,"close"),o()()(),a(12,"div",149)(13,"form",150)(14,"div",118)(15,"div",10)(16,"label",11),l(17,"Larghezza (px)"),o(),a(18,"input",151),R("ngModelChange",function(n){u(e);let r=h();return N(r.dimensionsForm.width,n)||(r.dimensionsForm.width=n),p(n)}),o(),a(19,"span",7),l(20,"Min: 500px, Max: 5000px"),o()(),a(21,"div",10)(22,"label",11),l(23,"Altezza (px)"),o(),a(24,"input",152),R("ngModelChange",function(n){u(e);let r=h();return N(r.dimensionsForm.height,n)||(r.dimensionsForm.height=n),p(n)}),o(),a(25,"span",7),l(26,"Min: 500px, Max: 5000px"),o()()(),a(27,"div",115)(28,"label",153),l(29,"Dimensioni Predefinite"),o(),a(30,"div",4)(31,"button",154),b("click",function(){u(e);let n=h();return p(n.setDimensions(1e3,800))}),l(32," Piccola (1000\xD7800) "),o(),a(33,"button",154),b("click",function(){u(e);let n=h();return p(n.setDimensions(1500,1200))}),l(34," Media (1500\xD71200) "),o(),a(35,"button",154),b("click",function(){u(e);let n=h();return p(n.setDimensions(2e3,1600))}),l(36," Grande (2000\xD71600) "),o()()(),a(37,"div",125)(38,"strong",155),l(39,"Anteprima Dimensioni"),o(),a(40,"div",156)(41,"div",157)(42,"div",158),l(43),o()()()(),a(44,"div",131)(45,"button",132),b("click",function(){u(e);let n=h();return p(n.onCancelDimensionsModal())}),l(46," Annulla "),o(),a(47,"button",133),b("click",function(){u(e);let n=h();return p(n.onSaveDimensions())}),a(48,"span",17),l(49,"save"),o(),l(50," Salva Dimensioni "),o()()()()()()}if(d&2){let e=h();c(18),V("ngModel",e.dimensionsForm.width),c(6),V("ngModel",e.dimensionsForm.height),c(17),L("width",e.dimensionsForm.width*.1,"px")("height",e.dimensionsForm.height*.1,"px"),c(2),j(" ",e.dimensionsForm.width," \xD7 ",e.dimensionsForm.height," px ")}}function ft(d,t){if(d&1&&(a(0,"div",165)(1,"span",17),l(2,"table_restaurant"),o(),a(3,"div",91)(4,"strong"),l(5),o(),a(6,"div",7),l(7),o()()()),d&2){let e=t.$implicit;c(5),w("Tavolo ",e.table_number),c(2),w("",e.capacity," persone")}}function _t(d,t){if(d&1){let e=P();a(0,"div",110)(1,"div",111)(2,"div",112)(3,"div",54)(4,"div",113)(5,"span",17),l(6,"merge"),o()(),a(7,"div")(8,"h1",6),l(9,"Unisci Tavoli"),o()()(),a(10,"button",114),b("click",function(){u(e);let n=h();return p(n.closeMergeModal())}),a(11,"span",17),l(12,"close"),o()()(),a(13,"div")(14,"form",150)(15,"div",8)(16,"div",115)(17,"label",11),l(18,"Tavoli da unire"),o(),a(19,"div",159),E(20,ft,8,2,"div",160),o()(),a(21,"div",118)(22,"div",10)(23,"label",11),l(24,"Numero Nuovo Tavolo"),o(),a(25,"input",161),R("ngModelChange",function(n){u(e);let r=h();return N(r.mergeForm.tableNumber,n)||(r.mergeForm.tableNumber=n),p(n)}),o()(),a(26,"div",10)(27,"label",11),l(28,"Capacit\xE0 Totale"),o(),a(29,"input",162),R("ngModelChange",function(n){u(e);let r=h();return N(r.mergeForm.capacity,n)||(r.mergeForm.capacity=n),p(n)}),o()()(),a(30,"div",115)(31,"label",11),l(32,"Nome Tavolo Unito"),o(),a(33,"input",163),R("ngModelChange",function(n){u(e);let r=h();return N(r.mergeForm.tableName,n)||(r.mergeForm.tableName=n),p(n)}),o()(),a(34,"div",164)(35,"div",10)(36,"span"),l(37),o()(),a(38,"div",10)(39,"span"),l(40),o()()()(),a(41,"div",131)(42,"button",132),b("click",function(){u(e);let n=h();return p(n.closeMergeModal())}),l(43," Annulla "),o(),a(44,"button",133),b("click",function(){u(e);let n=h();return p(n.onMergeTables())}),a(45,"span",17),l(46,"merge"),o(),l(47," Crea Tavolo Unito "),o()()()()()()}if(d&2){let e=h();c(20),g("ngForOf",e.selectedTables()),c(5),V("ngModel",e.mergeForm.tableNumber),c(4),V("ngModel",e.mergeForm.capacity),c(4),V("ngModel",e.mergeForm.tableName),c(4),w("Capacit\xE0 originale: ",e.getTotalCapacity()," "),c(3),w("Nuova capacit\xE0: ",e.mergeForm.capacity)}}var Re=class d{floorPlanService=F(Ne);tableService=F(B);floorPlanInteractionService=F(Z);stateService=F(A);tableMergeService=F(X);authService=F(fe);supabaseService=F(Y);tableRotationService=F($);renderer=F(se);canvasRef;containerRef;isDragging=!1;isRotating=!1;resizeObserver;destroyed=!1;subscriptions=new le;currentRestaurantId=null;highlightMessage=I(null);canvasScale=I(1);containerWidth=I(0);containerHeight=I(0);isMobileView=I(!1);userZoomed=I(!1);floorPlanWidth=M(()=>this.currentFloorPlan()?.width||1e3);floorPlanHeight=M(()=>this.currentFloorPlan()?.height||800);visualWidth=M(()=>this.floorPlanWidth()*this.canvasScale());visualHeight=M(()=>this.floorPlanHeight()*this.canvasScale());floorPlans=this.stateService.floorPlans;currentFloorPlan=this.stateService.currentFloorPlan;tables=this.stateService.tables;selectedTable=this.stateService.selectedTable;selectedTables=this.stateService.selectedTables;isDrawing=this.stateService.isDrawing;isMergeMode=this.stateService.isMergeMode;showTableModal=this.stateService.showTableModal;showEditTableModal=this.stateService.showEditTableModal;showMergeModal=this.stateService.showMergeModal;showDimensionsModal=this.stateService.showDimensionsModal;tableForm=this.stateService.tableForm;currentFloorPlanId=M(()=>this.currentFloorPlan()?.id||null);gridSize=20;snapToGrid=!0;isLargeText=!1;isEditingFloorPlanName=!1;modalMode=I("create");currentTableId=I(null);modalPosition={x:0,y:0};dimensionsForm={width:1e3,height:800};mergeForm={tableName:"",tableNumber:"",capacity:4};editingFloorPlan=null;editedFloorPlanName="";tableShapes=[];visualGridSize=M(()=>20/this.canvasScale());ngOnInit(){return T(this,null,function*(){console.log("\u{1F3C1} FloorPlanEditor ngOnInit"),this.tableShapes=this.floorPlanService.getTableShapes(),yield this.loadInitialData(),this.subscriptions.add(this.floorPlanService.data$.subscribe(e=>{if(this.stateService.setFloorPlans(e),e.length>0){let i=this.currentFloorPlan();if(!i||!e.find(n=>n.id===i.id)){let n=e[0];this.stateService.setCurrentFloorPlan(n),this.loadTablesForFloorPlan()}}else e.length===0&&this.createDefaultFloorPlan()})),this.subscriptions.add(this.tableService.data$.subscribe(()=>{!this.isRotating&&!this.isDragging&&this.loadTablesForFloorPlan()}));let t=this.generateNextTableNumber();this.stateService.updateAutoTableNumber(t)})}loadInitialData(){return T(this,null,function*(){try{let t=this.authService.currentUserValue;if(t){let{data:e,error:i}=yield this.supabaseService.getSupabaseClient().from("restaurants").select("id").eq("owner_id",t.id).limit(1);if(i){console.error("\u274C Error loading restaurants:",i);return}e&&e.length>0&&(this.currentRestaurantId=e[0].id)}yield this.floorPlanService.loadData(),yield this.tableService.loadData()}catch(t){console.error("\u{1F4A5} Error in loadInitialData:",t)}})}ngAfterViewInit(){setTimeout(()=>{if(!this.canvasRef||!this.containerRef){console.warn("Elementi non disponibili, riprovo..."),setTimeout(()=>this.ngAfterViewInit(),100);return}this.setupCanvasInteractions(),this.setupResponsiveCanvas(),this.setupPinchToZoom(),this.updateCanvasDimensions()},300)}ngOnDestroy(){this.subscriptions.unsubscribe(),this.resizeObserver&&this.resizeObserver.disconnect(),this.destroyed=!0}setupResponsiveCanvas(){let t=this.containerRef?.nativeElement;t&&(this.resizeObserver=new ResizeObserver(e=>{for(let i of e)this.containerWidth.set(i.contentRect.width),this.containerHeight.set(i.contentRect.height),this.isMobileView.set(i.contentRect.width<768),this.updateCanvasDimensions()}),this.resizeObserver.observe(t))}canvasWidth=I(1e3);canvasHeight=I(800);updateCanvasDimensions(){let t=this.containerWidth(),e=this.containerHeight();if(t===0||e===0)return;let i=this.currentFloorPlan();if(i){if(!this.userZoomed()){let n=this.isMobileView()?20:40,r=t-n,s=e-n,m=r/i.width,v=s/i.height,_=Math.min(m,v);_=Math.max(.1,Math.min(_,2)),this.canvasScale.set(_)}this.canvasWidth.set(i.width),this.canvasHeight.set(i.height),console.log("\u{1F4D0} Canvas updated:",{userZoomed:this.userZoomed(),container:`${t}x${e}`,floorPlan:`${i.width}x${i.height}`,scale:this.canvasScale(),visual:`${this.visualWidth()}x${this.visualHeight()}`})}}refreshCanvasSize(){this.updateCanvasDimensions()}zoomIn(){let t=this.canvasScale(),e=Math.min(t*1.2,3);this.canvasScale.set(e),this.userZoomed.set(!0),setTimeout(()=>{this.adjustScrollAfterZoom(t,e)},10)}zoomOut(){let t=this.canvasScale(),e=Math.max(t*.8,.1);this.canvasScale.set(e),this.userZoomed.set(!0),setTimeout(()=>{this.adjustScrollAfterZoom(t,e)},10)}adjustScrollAfterZoom(t,e){let i=this.containerRef?.nativeElement;if(!i)return;let n=i.scrollLeft+i.clientWidth/2,r=i.scrollTop+i.clientHeight/2,s=n*e/t-i.clientWidth/2,m=r*e/t-i.clientHeight/2;i.scrollLeft=Math.max(0,s),i.scrollTop=Math.max(0,m)}resetCanvasZoom(){this.userZoomed.set(!1),this.updateCanvasDimensions()}loadTablesForFloorPlan(){let t=this.currentFloorPlan();if(!t){this.stateService.setTables([]);return}let e=this.tableService.getVisibleTablesByFloorPlan(t.id);console.log("\u{1F4CA} Loading tables for floor plan:",{floorPlanId:t.id,floorPlanName:t.name,tablesCount:e.length,tables:e.map(i=>({id:i.id,number:i.table_number}))}),this.stateService.setTables(e)}onFloorPlanSelect(t){this.isEditingFloorPlanName&&this.cancelEditFloorPlanName(),this.userZoomed.set(!1),this.stateService.setCurrentFloorPlan(t),this.loadTablesForFloorPlan(),this.deselectAll(),this.cancelEditFloorPlan(),setTimeout(()=>this.updateCanvasDimensions(),50)}onFloorPlanSelectById(t){let e=this.floorPlans().find(i=>i.id===t);e&&this.onFloorPlanSelect(e)}selectTable(t){if(this.isMergeMode()){this.toggleTableSelection(t);return}this.deselectAll(),this.stateService.setSelectedTable(t)}deselectAll(){this.stateService.setSelectedTable(null),this.stateService.setShowEditTableModal(!1)}onCreateTable(){return T(this,null,function*(){let t=this.currentFloorPlan();if(!t||!this.currentRestaurantId){console.error("\u274C Missing required data");return}try{let e=this.tableForm(),i={shape:e.shape,width:e.gridWidth*this.gridSize,height:e.gridHeight*this.gridSize,border_radius:e.borderRadius},n=this.tableService.validateTableDimensions(i),r={restaurant_id:this.currentRestaurantId,floor_plan_id:t.id,table_name:e.tableName||`Tavolo ${e.tableNumber}`,table_number:e.tableNumber,capacity:e.capacity,shape:e.shape,position_x:this.modalPosition.x,position_y:this.modalPosition.y,width:n.width,height:n.height,rotation:0,is_active:!0,is_online_bookable:e.isOnlineBookable,is_merged:!1,parent_table_id:null,merged_tables_ids:[],border_radius:e.borderRadius};if(this.tableService.checkTableOverlap(r)){alert("Il tavolo si sovrappone a un altro tavolo. Scegli una posizione diversa.");return}console.log("\u{1F4DD} Creating table:",r),(yield this.tableService.createTable(r))?(console.log("\u2705 Table created successfully"),this.stateService.setShowTableModal(!1),this.stateService.setIsDrawing(!1)):console.error("\u274C Table creation failed")}catch(e){console.error("\u{1F4A5} Error creating table:",e)}})}onUpdateTable(){return T(this,null,function*(){let t=this.currentTableId();if(!(!t||!this.currentFloorPlan()))try{let e=this.tableForm(),i=this.currentFloorPlan(),n={id:t,shape:e.shape,width:e.width,height:e.height,border_radius:e.borderRadius,position_x:0,position_y:0},r=this.tableService.validateTableDimensions(n),m=this.tableService.getTables().find(k=>k.id===t);if(!m)return;if(m.position_x<0||m.position_y<0||m.position_x+r.width>i.width||m.position_y+r.height>i.height){alert("Il tavolo esce dai confini della mappa. Riduci le dimensioni o sposta il tavolo.");return}let _={shape:e.shape,width:r.width,height:r.height,border_radius:e.borderRadius,table_name:e.tableName,table_number:e.tableNumber,capacity:e.capacity,is_online_bookable:e.isOnlineBookable},y=f(f({},m),_);if(this.tableService.checkTableOverlap(y,t)){alert("Il tavolo si sovrappone a un altro tavolo. Modifica le dimensioni o la posizione.");return}(yield this.tableService.updateTable(t,_))?(console.log("\u2705 Tavolo aggiornato con successo"),this.stateService.setShowTableModal(!1),this.deselectAll()):console.error("\u274C Errore nell'aggiornamento del tavolo")}catch(e){console.error("\u274C Error updating table:",e)}})}onDeleteTable(){return T(this,null,function*(){let t=this.selectedTable();if(t&&confirm("Sei sicuro di voler eliminare questo tavolo?"))try{(yield this.tableService.deleteTable(t.id))&&this.deselectAll()}catch(e){console.error("\u274C Error deleting table:",e)}})}onCancelCreateTable(){this.stateService.setShowTableModal(!1),this.stateService.setIsDrawing(!1)}createNewFloorPlan(){return T(this,null,function*(){if(this.currentRestaurantId)try{let t=this.floorPlanService.getDefaultDimensions(),e={restaurant_id:this.currentRestaurantId,name:`Mappa ${this.floorPlans().length+1}`,width:t.width,height:t.height,is_active:!0},i=yield this.floorPlanService.createFloorPlan(e);i&&(this.stateService.resetForNewFloorPlan(),this.stateService.setCurrentFloorPlan(i),this.stateService.setTables([]),this.userZoomed.set(!1),setTimeout(()=>{this.openDimensionsModal(),setTimeout(()=>this.updateCanvasDimensions(),50)},100))}catch(t){console.error("\u{1F4A5} Error creating floor plan:",t)}})}onDeleteFloorPlan(t,e){return T(this,null,function*(){if(e.stopPropagation(),!!confirm(`Sei sicuro di voler eliminare la mappa "${t.name}"?`))try{if((yield this.floorPlanService.deleteFloorPlan(t.id))&&this.currentFloorPlan()?.id===t.id){let n=this.floorPlans().find(r=>r.id!==t.id)||null;this.stateService.setCurrentFloorPlan(n),this.loadTablesForFloorPlan()}}catch(i){console.error("\u{1F4A5} Error deleting floor plan:",i)}})}rotateSelectedTable(t=30){return T(this,null,function*(){let e=this.selectedTable();if(!(!e||this.isRotating)){this.isRotating=!0;try{if(!(yield this.tableRotationService.rotateTable(e,t)))throw new Error("Errore nel salvataggio della rotazione");console.log("\u2705 Tavolo ruotato con successo")}catch(i){console.error("\u274C Errore nella rotazione del gruppo:",i);try{yield this.tableService.loadData(),this.loadTablesForFloorPlan()}catch(n){console.error("\u274C Errore nel ricaricare i dati:",n)}alert("Errore durante la rotazione: "+(i.message||"Errore sconosciuto"))}finally{this.isRotating=!1}}})}rotateToAngle(t){let e=this.selectedTable();if(!e||this.isRotating)return;let i=this.tableRotationService.rotateToAngle(e,t);this.rotateSelectedTable(i)}onMouseWheel(t){if(!(!this.selectedTable()||this.isDrawing())&&t.ctrlKey){t.preventDefault();let e=t.deltaY>0?-5:5;this.rotateSelectedTable(e)}}updateTablesRotation(t,e){let n=this.stateService.tables().map(s=>{if(t.find(v=>v.id===s.id)){let v=(s.rotation+e)%360;return S(f({},s),{rotation:v})}return s});this.stateService.setTables(n);let r=this.selectedTable();if(r&&t.some(s=>s.id===r.id)){let s=n.find(m=>m.id===r.id);s&&this.stateService.setSelectedTable(s)}}toggleDrawingMode(){this.stateService.setIsDrawing(!this.isDrawing()),this.isDrawing()||this.deselectAll()}toggleMergeMode(){let t=this.isMergeMode();this.stateService.setIsMergeMode(!t),t?this.stateService.clearSelectedTables():this.stateService.setSelectedTables([]),this.deselectAll()}setDrawingMode(t){this.stateService.setIsDrawing(t)}closeMergeModal(){this.stateService.setShowMergeModal(!1)}toggleTableSelection(t){if(!this.isMergeMode()||t.is_merged)return;let e=this.selectedTables();e.findIndex(n=>n.id===t.id)>-1?this.stateService.removeFromSelectedTables(t.id):e.length===0||e.some(n=>this.floorPlanInteractionService.areTablesAdjacent(n,t))?e.length<4&&this.stateService.addToSelectedTables(t):this.floorPlanInteractionService.showAdjacencyWarning(t,e)}canMergeTables(){let t=this.selectedTables();return t.length>=2&&t.length<=4&&t.every(i=>!i.is_merged)&&this.floorPlanInteractionService.areSelectedTablesAdjacent(t,this.tables())}openMergeModal(){this.canMergeTables()&&(this.mergeForm={tableName:this.floorPlanService.getMergedTableName(this.selectedTables()),tableNumber:this.floorPlanService.getMergedTableNumber(this.selectedTables()),capacity:this.floorPlanService.getTotalCapacity(this.selectedTables())},this.stateService.setShowMergeModal(!0))}onMergeTables(){return T(this,null,function*(){let t=this.currentFloorPlan();if(!(!t||!this.currentRestaurantId||!this.canMergeTables()))try{let e=this.selectedTables(),i=Math.min(...e.map(_=>_.position_x)),n=Math.min(...e.map(_=>_.position_y)),r=Math.max(...e.map(_=>_.position_x+_.width)),s=Math.max(...e.map(_=>_.position_y+_.height)),m={table_name:this.mergeForm.tableName,table_number:this.mergeForm.tableNumber,capacity:this.mergeForm.capacity,position_x:i,position_y:n,width:r-i,height:s-n};(yield this.tableMergeService.mergeTables(e,m,t.id,this.currentRestaurantId))&&(this.stateService.setShowMergeModal(!1),this.stateService.setIsMergeMode(!1),this.stateService.clearSelectedTables(),yield this.tableService.loadData(),this.loadTablesForFloorPlan())}catch(e){console.error("\u274C Error merging tables:",e)}})}onSplitTable(t){return T(this,null,function*(){if(!t.merged_tables_ids||t.merged_tables_ids.length===0){console.log("\u274C Questo tavolo non \xE8 un tavolo unito");return}if(confirm("Sei sicuro di voler separare questo tavolo?"))try{console.log("\u{1F527} Separando tavolo unito:",t.table_number),(yield this.tableMergeService.splitMergedTable(t))?(console.log("\u2705 Tavolo separato con successo"),yield this.tableService.loadData(),this.loadTablesForFloorPlan(),this.deselectAll()):(console.error("\u274C Errore durante la separazione del tavolo"),alert("Errore durante la separazione del tavolo. Riprova."))}catch(e){console.error("\u274C Error splitting table:",e),alert("Errore durante la separazione del tavolo: "+e.message)}})}openDimensionsModal(){let t=this.currentFloorPlan();t&&(this.dimensionsForm={width:t.width,height:t.height},console.log("\u{1F4CF} Opening dimensions modal for:",{floorPlanId:t.id,name:t.name,currentTables:this.tables().length,dimensions:this.dimensionsForm}),this.stateService.setShowDimensionsModal(!0))}onCancelDimensionsModal(){this.stateService.setShowDimensionsModal(!1)}onSaveDimensions(){return T(this,null,function*(){let t=this.currentFloorPlan();if(t)try{let e=this.tables().filter(n=>n.floor_plan_id===t.id);if(e.length>0){let n=e.filter(r=>r.position_x+r.width>this.dimensionsForm.width||r.position_y+r.height>this.dimensionsForm.height);if(n.length>0){if(!confirm(`${n.length} tavolo(i) escono dai nuovi bordi della mappa. Vuoi continuare? I tavoli verranno spostati automaticamente.`))return;for(let s of n)s.position_x=Math.min(s.position_x,this.dimensionsForm.width-s.width),s.position_y=Math.min(s.position_y,this.dimensionsForm.height-s.height),yield this.tableService.updateTable(s.id,{position_x:s.position_x,position_y:s.position_y})}}if(yield this.floorPlanService.updateFloorPlan(t.id,{width:this.dimensionsForm.width,height:this.dimensionsForm.height})){let n=f(f({},t),this.dimensionsForm);this.stateService.setCurrentFloorPlan(n),this.stateService.setShowDimensionsModal(!1),this.updateCanvasDimensions(),console.log("\u2705 Dimensioni mappa aggiornate con successo")}}catch(e){console.error("\u274C Error updating floor plan dimensions:",e)}})}setDimensions(t,e){this.dimensionsForm.width=t,this.dimensionsForm.height=e}startEditFloorPlan(t,e){e.stopPropagation(),t&&(this.editingFloorPlan=t,this.editedFloorPlanName=t.name)}cancelEditFloorPlan(){this.editingFloorPlan=null}createDefaultFloorPlan(){return T(this,null,function*(){if(this.currentRestaurantId)try{let t=this.floorPlanService.getDefaultDimensions(),e={restaurant_id:this.currentRestaurantId,name:"Mappa Principale",width:t.width,height:t.height,is_active:!0},i=yield this.floorPlanService.createFloorPlan(e);i&&this.stateService.setCurrentFloorPlan(i)}catch(t){console.error("\u{1F4A5} Error creating default floor plan:",t)}})}generateNextTableNumber(){return this.tableService.generateNextTableNumber(this.tables())}highlightAdjacentTables(){console.log("\u{1F3AF} Mostra vicini - Inizio"),this.highlightMessage.set(null);let t=this.tables();if(t.length<2){this.highlightMessage.set("Ci sono meno di 2 tavoli nella mappa. Aggiungi altri tavoli per vedere quelli vicini."),console.warn("\u26A0\uFE0F Meno di 2 tavoli nella mappa");return}console.log("\u{1F4CA} Tavoli totali:",t.length);let i=this.findAdjacentTableGroups(t).filter(r=>r.length>1);if(i.length===0){this.highlightMessage.set("Non ci sono tavoli vicini tra loro in questa mappa. Sposta i tavoli pi\xF9 vicini per poterli unire."),console.warn("\u26A0\uFE0F Nessun gruppo di tavoli adiacenti trovato");return}console.log(`\u{1F50D} Trovati ${i.length} gruppi di tavoli adiacenti`);let n=0;i.forEach(r=>{n+=r.length}),this.highlightMessage.set(`Trovati ${i.length} gruppi di tavoli adiacenti (${n} tavoli totali). L'evidenziazione verr\xE0 rimossa tra 5 secondi.`),i.forEach(r=>{r.forEach(s=>{this.highlightTable(s)})}),setTimeout(()=>{this.clearAllHighlights(),setTimeout(()=>{this.highlightMessage.set(null)},500)},5e3)}findAdjacentTableGroups(t){let e=[],i=new Set;for(let n of t)if(!i.has(n.id)){let r=this.findConnectedTables(n,t,i);e.push(r)}return e.filter(n=>n.length>0)}findConnectedTables(t,e,i){let n=[],r=[t];for(;r.length>0;){let s=r.shift();if(!i.has(s.id)){i.add(s.id),n.push(s);for(let m of e)!i.has(m.id)&&m.id!==s.id&&this.floorPlanInteractionService.areTablesAdjacent(s,m,0)&&r.push(m)}}return n}highlightTable(t){let e=document.querySelector(`[data-table-id="${t.id}"]`);e?(e.classList.add("adjacent-highlight"),console.log(`\u2705 Evidenziato tavolo ${t.table_number}`)):console.warn(`\u26A0\uFE0F Tavolo ${t.table_number} non trovato nel DOM`)}clearAllHighlights(){document.querySelectorAll(".adjacent-highlight").forEach(e=>{e.classList.remove("adjacent-highlight")}),console.log("\u{1F9F9} Evidenziazioni rimosse")}getPreviewBorderRadius(){let t=this.tableForm();return this.floorPlanService.getPreviewBorderRadius(t.shape,t.borderRadius)}getPreviewBorderRadiusValue(){let t=this.tableForm();return this.floorPlanService.getPreviewBorderRadiusValue(t.shape,t.borderRadius)}getEditPreviewBorderRadius(){let t=this.selectedTable();return t?this.floorPlanService.getPreviewBorderRadius(t.shape,t.border_radius??8):"8px"}getEditPreviewBorderRadiusValue(){let t=this.selectedTable();return t?this.floorPlanService.getPreviewBorderRadiusValue(t.shape,t.border_radius??8):"8px"}getSelectedTableNumbers(){return this.floorPlanService.getSelectedTableNumbers(this.selectedTables())}getTableElement(t){if(!this.canvasRef?.nativeElement)return null;let e=this.canvasRef.nativeElement.querySelector(`[data-table-id="${t.id}"]`);return e||null}setupCanvasInteractions(){if(!this.canvasRef?.nativeElement){console.warn("Canvas ref non disponibile, rimando l'inizializzazione"),setTimeout(()=>this.setupCanvasInteractions(),100);return}let t=this.canvasRef.nativeElement;this.renderer.listen(t,"click",e=>this.onCanvasClick(e)),this.renderer.listen(t,"pointerdown",e=>this.onCanvasPointerDown(e)),this.renderer.listen(t,"touchstart",e=>{this.onCanvasTouchStart(e)},{passive:!1}),this.renderer.listen(document,"pointermove",()=>{this.isDragging&&t.classList.add("dragging-active")}),this.renderer.listen(document,"pointerup",()=>{this.isDragging=!1,t.classList.remove("dragging-active")})}onCanvasPointerDown(t){if(this.isDrawing())return;let i=t.target.closest(".table-element");if(i){this.isDragging=!0;let n=i.getAttribute("data-table-id"),r=this.tables().find(s=>s.id===n);r&&(console.log("\u{1F7E2} START DRAG for table:",r.table_number),i.classList.add("dragging"),i.style.transition="none",this.selectTable(r),this.floorPlanInteractionService.startTableDrag(r.id,t,this.canvasRef.nativeElement,this.canvasScale()))}else this.deselectAll();t.preventDefault(),t.stopPropagation()}onCanvasTouchStart(t){if(this.isDrawing())return;let i=t.target.closest(".table-element");if(i){t.preventDefault();let n=i.getAttribute("data-table-id"),r=this.tables().find(s=>s.id===n);if(r){this.isDragging=!0;let s=t.touches[0],m=new PointerEvent("pointerdown",{clientX:s.clientX,clientY:s.clientY,pointerId:1});i.classList.add("dragging"),i.style.transition="none",this.selectTable(r),this.floorPlanInteractionService.startTableDrag(r.id,m,this.canvasRef.nativeElement)}}else this.deselectAll()}setupPinchToZoom(){if(!this.canvasRef?.nativeElement){console.warn("Canvas ref non disponibile per pinch-to-zoom, rimando l'inizializzazione"),setTimeout(()=>this.setupPinchToZoom(),100);return}let t=this.canvasRef.nativeElement,e=0,i=0;this.renderer.listen(t,"touchstart",n=>{if(n.touches.length===2){n.preventDefault();let r=n.touches[0],s=n.touches[1];e=Math.hypot(s.clientX-r.clientX,s.clientY-r.clientY),i=this.canvasScale()}},{passive:!1}),this.renderer.listen(t,"touchmove",n=>{if(n.touches.length===2){n.preventDefault();let r=n.touches[0],s=n.touches[1],m=Math.hypot(s.clientX-r.clientX,s.clientY-r.clientY);if(e>0){let v=m/e,_=i*v,y=Math.max(.3,Math.min(_,3));this.canvasScale.set(y),this.updateCanvasDimensions()}}},{passive:!1}),this.renderer.listen(t,"touchend",()=>{e=0,i=0})}toggleSize(){this.isLargeText=!this.isLargeText}trackByTableId(t,e){return e.id}trackByFloorPlanId(t,e){return e.id}logCanvasInfo(){console.log("\u{1F4D0} Canvas Info:",{floorPlanWidth:this.floorPlanWidth(),floorPlanHeight:this.floorPlanHeight(),canvasScale:this.canvasScale(),visualWidth:this.visualWidth(),visualHeight:this.visualHeight(),isMobile:this.isMobileView()})}onTablePointerDown(t,e){if(t.stopPropagation(),t.preventDefault(),!this.isDrawing()){if(this.isMergeMode()){this.toggleTableSelection(e);return}if(this.selectTable(e),t.pointerType==="mouse"&&t.button===0){this.isDragging=!0;let i=t.target;i&&(i.classList.add("dragging"),i.style.transition="none"),this.floorPlanInteractionService.startTableDrag(e.id,t,this.canvasRef.nativeElement,this.canvasScale())}}}onDimensionChange(){if(this.modalMode()==="edit"){let t=this.stateService.tableForm();(t.shape==="circle"||t.shape==="square")&&this.stateService.updateTableForm({height:t.width,gridHeight:Math.round(t.width/this.gridSize)})}}onGridDimensionChange(){if(this.modalMode()==="create"){let t=this.stateService.tableForm(),e=t.gridWidth*this.gridSize,i=t.gridHeight*this.gridSize;if(t.shape==="circle"||t.shape==="square"){let n=t.gridWidth*this.gridSize;this.stateService.updateTableForm({width:e,height:n,gridHeight:t.gridWidth})}else this.stateService.updateTableForm({width:e,height:i})}}startEditFloorPlanName(){let t=this.currentFloorPlan();t&&(this.isEditingFloorPlanName=!0,this.editedFloorPlanName=t.name)}saveFloorPlanName(){return T(this,null,function*(){let t=this.currentFloorPlan();if(!(!t||!this.editedFloorPlanName.trim()))try{if(yield this.floorPlanService.updateFloorPlan(t.id,{name:this.editedFloorPlanName})){let i=S(f({},t),{name:this.editedFloorPlanName});this.stateService.setCurrentFloorPlan(i),yield this.floorPlanService.loadData(),this.isEditingFloorPlanName=!1,this.editedFloorPlanName=""}}catch(e){console.error("\u274C Error saving floor plan name:",e)}})}cancelEditFloorPlanName(){this.isEditingFloorPlanName=!1,this.editedFloorPlanName=""}getScrollDimensions(){let t=this.containerRef?.nativeElement,e=this.canvasRef?.nativeElement;if(!t||!e)return{scrollWidth:0,scrollHeight:0};let i=this.floorPlanWidth()*this.canvasScale(),n=this.floorPlanHeight()*this.canvasScale(),r=t.clientWidth,s=t.clientHeight,m=Math.max(0,i-r),v=Math.max(0,n-s);return{scrollWidth:m,scrollHeight:v,canScroll:m>0||v>0}}getTotalCapacity(){return this.floorPlanService.getTotalCapacity(this.selectedTables())}getTableStyle(t){return this.tableService.getTableStyle(t)}getTableClass(t){let i=[this.tableService.getTableClass(t,this.selectedTable(),this.selectedTables(),this.isMergeMode())];return this.isMergeMode()&&this.selectedTables().some(n=>n.id===t.id)&&i.push("merge-selected"),i.join(" ")}getMergedTableName(){return this.floorPlanService.getMergedTableName(this.selectedTables())}getMergedTableNumber(){return this.floorPlanService.getMergedTableNumber(this.selectedTables())}areTablesAdjacent(t,e){return this.floorPlanInteractionService.areTablesAdjacent(t,e)}areSelectedTablesAdjacent(){return this.floorPlanInteractionService.areSelectedTablesAdjacent(this.selectedTables(),this.tables())}showAdjacencyWarning(t){this.floorPlanInteractionService.showAdjacencyWarning(t,this.selectedTables())}testHighlight(){if(console.log("\u{1F526} TEST HIGHLIGHT - Verifica tavoli nel DOM:"),!this.canvasRef?.nativeElement){console.error("\u274C Canvas non trovato");return}let t=this.canvasRef.nativeElement.querySelectorAll(".table-element");if(console.log(`Tavoli nel DOM: ${t.length}`),t.length>0){let i=t[0];i.style.border="5px solid red !important",i.style.boxShadow="0 0 20px red !important",console.log("\u2705 Primo tavolo evidenziato (stile diretto)"),i.classList.add("test-highlight"),console.log("\u2705 Aggiunta classe test-highlight")}let e=this.floorPlanInteractionService.getAdjacentTablesToSelection(this.selectedTables(),this.tables());console.log("Tavoli adiacenti dal servizio:",e.map(i=>i.table_number))}previewWidth=M(()=>{let t=this.stateService.tableForm(),e=this.modalMode(),i=e==="create"?t.gridWidth*this.gridSize:t.width;return console.log("\u{1F4CF} previewWidth calcolato:",{mode:e,gridWidth:t.gridWidth,width:t.width,gridSize:this.gridSize,result:i}),i});previewHeight=M(()=>{let t=this.stateService.tableForm(),e=this.modalMode(),i;return e==="create"?i=t.gridHeight*this.gridSize:i=t.height,console.log("\u{1F4CF} previewHeight calcolato:",{mode:e,gridHeight:t.gridHeight,height:t.height,result:i}),i});previewBorderRadius=M(()=>{let t=this.stateService.tableForm(),e;return t.shape==="circle"?e="50%":e=`${t.borderRadius}px`,console.log("\u{1F504} previewBorderRadius calcolato:",{shape:t.shape,borderRadius:t.borderRadius,result:e}),e});updatePreview(){console.log("\u{1F504} Aggiorno anteprima...");let t=this.stateService.tableForm();this.stateService.updateTableForm(f({},t))}openCreateTableModal(t){this.modalMode.set("create"),this.modalPosition=t,this.currentTableId.set(null),this.stateService.resetTableForm(),this.stateService.setShowTableModal(!0)}openEditTableModal(t){let e=t||this.selectedTable();if(!e)return;this.modalMode.set("edit"),this.currentTableId.set(e.id);let i=e.is_merged||e.merged_tables_ids&&e.merged_tables_ids.length>0,n=Math.round(e.width/this.gridSize),r=Math.round(e.height/this.gridSize);this.stateService.updateTableForm({shape:e.shape,gridWidth:n,gridHeight:r,width:e.width,height:e.height,borderRadius:e.border_radius||8,tableNumber:e.table_number,capacity:e.capacity,tableName:e.table_name||"",isOnlineBookable:e.is_online_bookable,isMerged:i}),this.stateService.setShowTableModal(!0),i&&setTimeout(()=>{alert("\u26A0\uFE0F Questo tavolo \xE8 unito. Per modificare le dimensioni, separalo prima.")},100)}onSaveTable(){return T(this,null,function*(){if(this.modalMode()==="edit"&&this.tableForm().isMerged){let t=this.tableForm(),i=this.tableService.getTables().find(n=>n.id===this.currentTableId());if(i&&(t.width!==i.width||t.height!==i.height)){alert("\u274C Non puoi modificare le dimensioni di un tavolo unito. Separalo prima.");return}}this.modalMode()==="create"?yield this.onCreateTable():yield this.onUpdateTable()})}onCanvasClick(t){if(!this.isDrawing()||!this.currentFloorPlan())return;let i=this.canvasRef.nativeElement.getBoundingClientRect(),n=this.canvasScale(),r=this.floorPlanWidth(),s=this.floorPlanHeight(),m=i.left+i.width/2,v=i.top+i.height/2,_=t.clientX-m,y=t.clientY-v,D=_/n+r/2,x=y/n+s/2,k=this.snapToGrid?Math.round(D/this.gridSize)*this.gridSize:D,z=this.snapToGrid?Math.round(x/this.gridSize)*this.gridSize:x;this.openCreateTableModal({x:k,y:z}),t.stopPropagation()}onGridWidthChange(t){let e=this.stateService.tableForm();this.stateService.updateTableForm({gridWidth:t});let i=t*this.gridSize;e.shape==="circle"||e.shape==="square"?this.stateService.updateTableForm({width:i,height:i,gridHeight:t}):this.stateService.updateTableForm({width:i})}onGridHeightChange(t){let e=this.stateService.tableForm();if(this.stateService.updateTableForm({gridHeight:t}),e.shape!=="circle"&&e.shape!=="square"){let i=t*this.gridSize;this.stateService.updateTableForm({height:i})}}onWidthChange(t){let e=this.stateService.tableForm();this.stateService.updateTableForm({width:t}),e.shape==="circle"||e.shape==="square"?this.stateService.updateTableForm({height:t,gridWidth:Math.round(t/this.gridSize),gridHeight:Math.round(t/this.gridSize)}):this.stateService.updateTableForm({gridWidth:Math.round(t/this.gridSize)})}onHeightChange(t){let e=this.stateService.tableForm();e.shape!=="circle"&&e.shape!=="square"&&this.stateService.updateTableForm({height:t,gridHeight:Math.round(t/this.gridSize)})}onBorderRadiusChange(t){this.stateService.updateTableForm({borderRadius:t})}onShapeSelect(t){console.log("\u{1F3AF} Cambio forma a:",t.type),this.stateService.initializeTableFormForShape(t.type),setTimeout(()=>{let e=this.stateService.tableForm();if(this.modalMode()==="create"){let i=e.gridWidth*this.gridSize,n=e.gridHeight*this.gridSize;e.shape==="circle"||e.shape==="square"?this.stateService.updateTableForm({width:i,height:i,gridHeight:e.gridWidth}):this.stateService.updateTableForm({width:i,height:n})}else(e.shape==="circle"||e.shape==="square")&&this.stateService.updateTableForm({height:e.width,gridHeight:Math.round(e.width/this.gridSize)})},0)}static \u0275fac=function(e){return new(e||d)};static \u0275cmp=de({type:d,selectors:[["app-floor-plan"]],viewQuery:function(e,i){if(e&1&&(ie(ze,5),ie(We,5)),e&2){let n;ne(n=ae())&&(i.canvasRef=n.first),ne(n=ae())&&(i.containerRef=n.first)}},hostBindings:function(e,i){e&1&&b("wheel",function(r){return i.onMouseWheel(r)})},decls:105,vars:30,consts:[["canvasContainer",""],["floorPlanCanvas",""],[1,"page-container"],[1,"section-header"],[1,"flex","gap-sm"],[1,"material-icons","fs-lg"],[1,"section-title"],[1,"text-muted"],[1,"form-card"],[1,"form-row","mb-md"],[1,"form-group"],[1,"standard-label"],[1,"flex","gap-sm","items-center"],[1,"form-select",3,"ngModelChange","ngModel","disabled"],["value",""],[3,"ngValue",4,"ngFor","ngForOf"],["title","Modifica nome mappa",1,"icon-button",3,"click","disabled"],[1,"material-icons"],["title","Elimina mappa",1,"icon-button",3,"click","disabled"],["class","mt-sm",4,"ngIf"],["title","Zoom -",1,"icon-button",3,"click"],[1,"text-sm"],["title","Zoom +",1,"icon-button",3,"click"],["title","Reset zoom",1,"icon-button",3,"click"],[1,"checkbox-label","ml-sm"],["type","checkbox",3,"ngModelChange","change","ngModel"],[1,"checkbox-content"],[1,"form-row"],[1,"promethea-button",3,"click"],[1,"promethea-button","ghost",3,"click","disabled"],[1,"flex","gap-sm","flex-wrap"],[1,"promethea-button","ghost",3,"click"],["class","form-row","style","padding: var(--gap-sm) 0;",4,"ngIf"],["class","rounded m-sm02 p-md","style","background-color: var(--smoke-1); border: 1px solid var(--smoke-2);",4,"ngIf"],["class","form-card mt-md",4,"ngIf"],[1,"form-card","mt-lg"],[1,"canvas-container"],["class","canvas-wrapper",3,"width","height",4,"ngIf"],["class","empty-floorplan",4,"ngIf"],[1,"dimensions-info"],[1,"grid-cards"],[1,"dimension-item"],[1,"dimension-label"],[1,"dimension-value"],["class","modal-overlay",4,"ngIf"],[3,"ngValue"],[1,"mt-sm"],["type","text","placeholder","Nuovo nome mappa","autofocus","",1,"form-input",3,"ngModelChange","keyup.enter","keyup.escape","ngModel"],["title","Salva",1,"icon-button","success",3,"click"],["title","Annulla",1,"icon-button",3,"click"],[1,"text-sm","text-muted","mt-sm"],[1,"form-row",2,"padding","var(--gap-sm) 0"],[1,"form-group","mt-md"],[1,"flex","justify-between","items-center","flex-wrap","gap-md"],[1,"flex","items-center","gap-sm"],["class","flex gap-sm",4,"ngIf"],[1,"flex","items-center","gap-sm","border-l","pl-sm"],["title","Ruota di -30\xB0",1,"icon-button",3,"click","disabled"],[1,"flex","flex-col","items-center"],[1,"text-sm","font-bold"],[1,"text-mini","text-muted"],["title","Ruota di +30\xB0",1,"icon-button",3,"click","disabled"],["title","Reset rotazione a 0\xB0",1,"icon-button",3,"click","disabled"],["class","text-mini text-muted mt-sm text-center",4,"ngIf"],["title","0\xB0",1,"icon-button",3,"click"],["title","90\xB0",1,"icon-button",3,"click"],["title","180\xB0",1,"icon-button",3,"click"],["title","270\xB0",1,"icon-button",3,"click"],[1,"text-mini","text-muted","mt-sm","text-center"],[1,"material-icons","text-mini"],[1,"rounded","m-sm02","p-md",2,"background-color","var(--smoke-1)","border","1px solid var(--smoke-2)"],[1,"flex","flex-col"],["class","chip active small ml-sm",4,"ngIf"],[1,"promethea-button","primary","small",3,"click"],["class","promethea-button warning small",3,"click",4,"ngIf"],[1,"promethea-button","ghost","small",3,"click"],[1,"chip","active","small","ml-sm"],[1,"promethea-button","warning","small",3,"click"],[1,"form-card","mt-md"],["class","text-muted",4,"ngIf"],[1,"promethea-button","small",3,"click","disabled"],[4,"ngIf"],[1,"promethea-button","ghost","small",3,"click","disabled"],["class","mt-lg",4,"ngIf"],["class","alert alert-info",4,"ngIf"],["class","alert alert-warning",4,"ngIf"],["class","alert alert-success",4,"ngIf"],["class","ml-sm",4,"ngIf"],[1,"ml-sm"],[1,"mt-lg"],[1,"material-icons","text-warning"],[1,"flex-1"],[1,"icon-button","small",3,"click"],[1,"alert","alert-info"],[1,"alert","alert-warning"],[1,"alert","alert-success"],[1,"canvas-wrapper"],[1,"floor-plan-canvas"],[1,"canvas-background"],["class","grid-overlay",3,"background-size",4,"ngIf"],["class","table-element",3,"class","ngStyle","pointerdown",4,"ngFor","ngForOf","ngForTrackBy"],["class","empty-state",4,"ngIf"],[1,"grid-overlay"],[1,"table-element",3,"pointerdown","ngStyle"],[1,"table-content"],[1,"table-number"],[1,"table-capacity"],[1,"empty-state"],[1,"empty-floorplan"],[1,"promethea-button","primary","mt-md",3,"click"],[1,"modal-overlay"],[1,"modal-container","modal-md"],[1,"modal-header"],[1,"header-icon"],[1,"icon-button",3,"click"],[1,"form-group","mb-lg"],[1,"grid-cards","mb-md"],["class","card text-center hover-lift",3,"active","click",4,"ngFor","ngForOf"],[1,"form-row","mb-lg"],["type","text","name","tableNumber","placeholder","Es: 1",1,"form-input",3,"ngModelChange","ngModel"],["type","number","name","capacity","min","1","max","100",1,"form-input",3,"ngModelChange","ngModel"],["type","text","name","tableName","placeholder","Es: Tavolo finestra",1,"form-input",3,"ngModelChange","ngModel"],[1,"checkbox-label"],["type","checkbox","name","isOnlineBookable",3,"ngModelChange","ngModel"],["class","form-group",4,"ngIf"],[1,"form-card","text-center"],[1,"flex","justify-center","mt-md"],[1,"table-preview",3,"ngStyle"],[1,"preview-content"],[1,"text-muted","mt-sm","mt-lg","justify-center","flex"],["class","text-xs text-muted mt-2",4,"ngIf"],[1,"modal-footer"],["type","button",1,"promethea-button","ghost",3,"click"],["type","button",1,"promethea-button",3,"click"],["type","button","class","promethea-button danger",3,"click",4,"ngIf"],[1,"card","text-center","hover-lift",3,"click"],[1,"flex","flex-col","items-center","gap-sm"],["type","number","name","gridWidth","min","2","max","20",1,"form-input",3,"ngModelChange","ngModel","disabled"],["type","number","name","gridHeight","min","2","max","20",1,"form-input",3,"ngModelChange","ngModel","disabled"],["type","number","name","width","min","20","max","1000","step","10",1,"form-input",3,"ngModelChange","ngModel","disabled"],["type","number","name","height","min","20","max","1000","step","10",1,"form-input",3,"ngModelChange","ngModel","disabled"],["type","range","name","borderRadius","min","0","max","50","step","1",1,"form-input",3,"ngModelChange","ngModel"],[1,"flex","justify-between","text-sm","text-muted"],[1,"info-message"],[1,"text-xs","text-muted","mt-2"],["type","button",1,"promethea-button","danger",3,"click"],[1,"flex","items-center","gap-md"],[1,"material-icons","text-lg"],[1,"section-title","modal-header-title"],[1,"p-lg"],[1,"generic-form"],["type","number","name","floorPlanWidth","min","500","max","5000","step","50",1,"form-input",3,"ngModelChange","ngModel"],["type","number","name","floorPlanHeight","min","500","max","5000","step","50",1,"form-input",3,"ngModelChange","ngModel"],[1,"standard-label","mb-md"],["type","button",1,"promethea-button","ghost","x-small",3,"click"],[1,"font-semibold"],[1,"flex","justify-center","mt-lg"],[1,"dimension-preview","border","shadow-card","rounded-lg","bg-smoke"],[1,"text-muted","p-sm"],[1,"flex","flex-col","gap-sm"],["class","flex items-center gap-sm p-sm border rounded",4,"ngFor","ngForOf"],["type","text","name","mergedTableNumber","placeholder","Es: U123",1,"form-input",3,"ngModelChange","ngModel"],["type","number","name","mergedTableCapacity","min","2","max","50",1,"form-input",3,"ngModelChange","ngModel"],["type","text","name","mergedTableName","placeholder","Es: Tavolo Unito per Gruppo",1,"form-input",3,"ngModelChange","ngModel"],[1,"form-row","mt-lg"],[1,"flex","items-center","gap-sm","p-sm","border","rounded"]],template:function(e,i){if(e&1){let n=P();a(0,"div",2)(1,"div",3)(2,"div",4)(3,"span",5),l(4,"map"),o(),a(5,"h1",6),l(6,"Mappa Ristorante"),o()(),a(7,"p",7),l(8,"Crea e modifica la disposizione dei tavoli nel tuo ristorante"),o()(),a(9,"div",8)(10,"div",9)(11,"div",10)(12,"label",11),l(13,"Mappa"),o(),a(14,"div",12)(15,"select",13),b("ngModelChange",function(s){return u(n),p(i.onFloorPlanSelectById(s))}),a(16,"option",14),l(17,"Seleziona mappa"),o(),E(18,Ae,2,4,"option",15),o(),a(19,"div",4)(20,"button",16),b("click",function(){return u(n),p(i.startEditFloorPlanName())}),a(21,"span",17),l(22,"edit"),o()(),a(23,"button",18),b("click",function(s){return u(n),p(i.onDeleteFloorPlan(i.currentFloorPlan(),s))}),a(24,"span",17),l(25,"delete"),o()()()(),E(26,Oe,12,1,"div",19),o(),a(27,"div",10)(28,"label",11),l(29,"Zoom"),o(),a(30,"div",12)(31,"button",20),b("click",function(){return u(n),p(i.zoomOut())}),a(32,"span",17),l(33,"zoom_out"),o()(),a(34,"span",21),l(35),o(),a(36,"button",22),b("click",function(){return u(n),p(i.zoomIn())}),a(37,"span",17),l(38,"zoom_in"),o()(),a(39,"button",23),b("click",function(){return u(n),p(i.resetCanvasZoom())}),a(40,"span",17),l(41,"refresh"),o()(),a(42,"label",24)(43,"input",25),R("ngModelChange",function(s){return u(n),N(i.snapToGrid,s)||(i.snapToGrid=s),p(s)}),b("change",function(){return u(n),p(i.refreshCanvasSize())}),o(),a(44,"div",26)(45,"span",7),l(46),o()()()()()(),a(47,"div",27)(48,"div",10)(49,"label",11),l(50,"Mappa"),o(),a(51,"div",4)(52,"button",28),b("click",function(){return u(n),p(i.createNewFloorPlan())}),a(53,"span",17),l(54,"add"),o(),l(55," Nuova Mappa "),o(),a(56,"button",29),b("click",function(){return u(n),p(i.openDimensionsModal())}),a(57,"span",17),l(58,"aspect_ratio"),o(),l(59," Dimensioni "),o()()(),a(60,"div",10)(61,"label",11),l(62,"Tavoli"),o(),a(63,"div",30)(64,"button",28),b("click",function(){return u(n),p(i.toggleDrawingMode())}),a(65,"span",17),l(66,"add_circle"),o(),l(67),o(),a(68,"button",31),b("click",function(){return u(n),p(i.toggleMergeMode())}),a(69,"span",17),l(70,"merge"),o(),l(71),o()()()(),E(72,je,29,6,"div",32)(73,Ye,18,4,"div",33)(74,tt,26,11,"div",34),o(),a(75,"div",35)(76,"div",36,0),E(78,ot,7,16,"div",37)(79,rt,11,0,"div",38),o(),a(80,"div",39)(81,"div",40)(82,"div",41)(83,"span",42),l(84,"Dimensioni mappa:"),o(),a(85,"span",43),l(86),o()(),a(87,"div",41)(88,"span",42),l(89,"Visualizzato:"),o(),a(90,"span",43),l(91),o()(),a(92,"div",41)(93,"span",42),l(94,"Scala:"),o(),a(95,"span",43),l(96),o()(),a(97,"div",41)(98,"span",42),l(99,"Tavoli:"),o(),a(100,"span",43),l(101),o()()()()()(),E(102,bt,72,29,"div",44)(103,vt,51,8,"div",44)(104,_t,48,6,"div",44)}e&2&&(c(15),g("ngModel",i.currentFloorPlanId())("disabled",i.floorPlans().length===0||i.isEditingFloorPlanName),c(3),g("ngForOf",i.floorPlans()),c(2),g("disabled",!i.currentFloorPlan()||i.isEditingFloorPlanName),c(3),g("disabled",!i.currentFloorPlan()||i.isEditingFloorPlanName),c(3),g("ngIf",i.isEditingFloorPlanName&&i.currentFloorPlan()),c(9),w("",(i.canvasScale()*100).toFixed(0),"%"),c(8),V("ngModel",i.snapToGrid),c(3),w("Griglia (",i.gridSize,"px)"),c(10),g("disabled",!i.currentFloorPlan()),c(8),O("active",i.isDrawing()),c(3),w(" ",i.isDrawing()?"Annulla":"Aggiungi"," "),c(),O("active",i.isMergeMode()),c(3),w(" ",i.isMergeMode()?"Annulla":"Unisci"," "),c(),g("ngIf",i.selectedTable()&&!i.isDrawing()),c(),g("ngIf",i.selectedTable()&&!i.isDrawing()),c(),g("ngIf",i.isMergeMode()),c(4),g("ngIf",i.currentFloorPlan()),c(),g("ngIf",!i.currentFloorPlan()),c(7),j("",i.floorPlanWidth()," \xD7 ",i.floorPlanHeight()," px"),c(5),j("",i.visualWidth().toFixed(0)," \xD7 ",i.visualHeight().toFixed(0)," px"),c(5),w("",(i.canvasScale()*100).toFixed(0),"%"),c(5),H(i.tables().length),c(),g("ngIf",i.showTableModal()),c(),g("ngIf",i.showDimensionsModal()),c(),g("ngIf",i.showMergeModal()))},dependencies:[ve,pe,ge,be,Ve,Ee,Ce,Ie,Se,Pe,Fe,_e,ye,xe,Te,ke,De,Me,we],styles:[".canvas-container[_ngcontent-%COMP%]{position:relative;width:100%;height:100vh;min-height:400px;border:2px solid var(--smoke-1);border-radius:12px;background-color:var(--background);overflow:auto!important;-webkit-overflow-scrolling:touch!important;padding:var(--gap-sm);box-sizing:border-box;contain:content}.canvas-wrapper[_ngcontent-%COMP%]{position:relative;display:inline-block;min-width:100%;min-height:100%}.floor-plan-canvas[_ngcontent-%COMP%]{position:relative;background-color:var(--background);box-shadow:0 4px 12px var(--smoke-1);border-radius:8px;transform-origin:0 0;overflow:visible;margin:0;isolation:isolate;contain:layout paint}@media (max-width: 768px){.canvas-container[_ngcontent-%COMP%]{height:50vh;min-height:300px;max-height:500px;padding:8px}}.table-element[_ngcontent-%COMP%]{position:absolute;border:2px solid var(--smoke-1);background:var(--vetro);cursor:grab;display:flex;align-items:center;justify-content:center;transition:transform .2s ease-out;z-index:10;transform-origin:center;border-radius:inherit}.table-element.selected[_ngcontent-%COMP%]{border-color:var(--primary);background:var(--gradiente);z-index:30;box-shadow:0 8px 32px var(--shadow-2)}.table-content[_ngcontent-%COMP%]{text-align:center;padding:var(--gap-sm);width:100%;display:flex;flex-direction:column;gap:calc(var(--gap-sm) / 2)}.table-number[_ngcontent-%COMP%]{font-weight:800;font-size:var(--fs-sm);color:var(--text-color);line-height:1}.table-capacity[_ngcontent-%COMP%]{font-size:calc(var(--fs-sm) * .8);color:var(--text-muted);display:flex;justify-content:center;font-weight:600;line-height:1}@media (max-width: 768px){.canvas-container[_ngcontent-%COMP%]{height:60vh;min-height:400px;max-height:600px;padding:8px}}.dimensions-info[_ngcontent-%COMP%]{background-color:var(--smoke-1);border-radius:8px;padding:var(--gap-sm);margin-top:var(--gap-sm)}.dimension-item[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center}.dimension-label[_ngcontent-%COMP%]{color:var(--text-muted);margin-bottom:var(--gap-sm)}.dimension-value[_ngcontent-%COMP%]{font-weight:600;color:var(--text-color)}.table-element.adjacent-highlight[_ngcontent-%COMP%]{border:3px solid #FFD700!important;box-shadow:0 0 0 2px #ffd70080,0 0 20px 5px #ffd700b3!important;z-index:999!important;animation:_ngcontent-%COMP%_pulse-yellow 1.5s infinite alternate!important;transform:scale(1.02)!important;transition:all .3s ease!important}@keyframes _ngcontent-%COMP%_pulse-yellow{0%{box-shadow:0 0 0 2px #ffd70080,0 0 20px 5px #ffd700b3}to{box-shadow:0 0 0 4px #ffd700cc,0 0 30px 10px #ffd700e6}}.table-element.merge-selected.adjacent-highlight[_ngcontent-%COMP%]{border:3px double #FFD700!important;box-shadow:0 0 0 3px #ffd7004d,0 0 25px 8px #ffd70099,inset 0 0 15px #ffd70066!important}.table-preview[_ngcontent-%COMP%]{background-color:var(--vetro);border:2px solid var(--smoke-1);display:flex;align-items:center;justify-content:center;margin:0 auto;transition:all .3s ease;position:relative;overflow:hidden}.table-preview.shape-circle[_ngcontent-%COMP%]{border-radius:50%!important}.preview-content[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center;gap:calc(var(--gap-sm) / 2);pointer-events:none}.preview-content[_ngcontent-%COMP%]   .table-number[_ngcontent-%COMP%]{font-weight:800;font-size:var(--fs-sm);color:var(--text-color);line-height:1}.preview-content[_ngcontent-%COMP%]   .table-capacity[_ngcontent-%COMP%]{font-size:calc(var(--fs-sm) * .8);color:var(--text-muted);font-weight:600;line-height:1}.modal-md[_ngcontent-%COMP%]   .table-preview[_ngcontent-%COMP%]{max-width:200px;max-height:200px}"]})};export{Re as FloorPlanEditor};
