import{a as $}from"./chunk-M4XWLE45.js";import{a as L}from"./chunk-XHPMDJAM.js";import{qb as M,rb as A}from"./chunk-7ARAJ5DM.js";import{a as G}from"./chunk-PUZFKEPN.js";import{B as V,b as C,d as U,e as T,j as N,o as I,r as w,s as z,t as R,u as O,z as D}from"./chunk-YO2SNT5L.js";import{b as x,d as F}from"./chunk-MEEOFM4U.js";import"./chunk-RD7WPZ3N.js";import"./chunk-JDHQCX3C.js";import{k as y,l as b,v as E}from"./chunk-RJWLMJIA.js";import{Ib as n,Kb as g,La as a,T as S,Va as _,_a as f,ca as d,dc as P,f as h,gb as l,qb as o,rb as r,sb as c,yb as v}from"./chunk-KIAVC6JW.js";import{g as u}from"./chunk-RA2WU32H.js";function k(s,e){if(s&1&&(o(0,"option",29),n(1),r()),s&2){let t=e.$implicit;l("value",t),a(),g(" ",t," ")}}function q(s,e){if(s&1&&(o(0,"option",29),n(1),r()),s&2){let t=e.$implicit;l("value",t.code),a(),g(" ",t.name," ")}}function j(s,e){s&1&&(o(0,"div",30),c(1,"lucide-angular",31),n(2," Nessuna provincia disponibile per questa regione "),r()),s&2&&(a(),l("size",16))}function H(s,e){s&1&&(o(0,"div",8),c(1,"lucide-angular",31),n(2," Seleziona prima una regione "),r()),s&2&&(a(),l("size",16))}function J(s,e){s&1&&(o(0,"span"),n(1,"Salvataggio..."),r())}function K(s,e){s&1&&(o(0,"span"),n(1,"Salva modifiche"),r())}var B=class s{fb=d(D);authService=d(F);supabaseService=d(x);tutorialService=d(L);geographyService=d(G);cdRef=d(P);pushService=d($);pushPermission="default";hasActivePush=!1;pushLoading=!1;destroy$=new h;supabaseClient=this.supabaseService.getSupabaseClient();profileForm;loading=!1;userProfile;provinces=[];regions=[];filteredProvinces=[];selectedProvinceName="";ngOnInit(){this.pushPermission=this.pushService.isSupported()?Notification.permission:"unsupported",this.pushService.hasActiveSubscription().then(e=>this.hasActivePush=e),this.initForm(),this.loadProvinces(),this.loadUserProfile()}ngOnDestroy(){this.destroy$.next(),this.destroy$.complete()}initForm(){this.profileForm=this.fb.group({phone:[""],address:[""],region:[""],province:[""]})}loadProvinces(){return u(this,null,function*(){this.geographyService.getFilteredProvinces().pipe(S(this.destroy$)).subscribe({next:e=>{this.provinces=e,this.regions=[...new Set(e.map(i=>i.region))].filter(i=>i!=="Tutte").sort();let t=this.profileForm.get("region")?.value;t&&this.filterProvincesByRegion(t),this.cdRef.detectChanges()},error:e=>console.error("Errore caricamento province:",e)})})}filterProvincesByRegion(e){this.filteredProvinces=e?this.provinces.filter(t=>t.region===e):[],e||this.profileForm.patchValue({province:""})}onRegionChange(e){let i=e.target.value;this.filterProvincesByRegion(i)}onProvinceChange(e){let i=e.target.value,m=this.provinces.find(p=>p.code===i);this.selectedProvinceName=m?m.name:""}loadUserProfile(){return u(this,null,function*(){this.loading=!0;try{let e=this.authService.currentUserValue;if(!e)throw new Error("Utente non autenticato");let{data:t,error:i}=yield this.supabaseClient.from("users").select("*").eq("id",e.id).single();if(i){if(i.code==="PGRST116"){yield this.createUserProfile(e.id);return}throw i}t&&(this.userProfile=t,this.patchForm(t))}catch(e){console.error("Errore caricamento profilo:",e)}finally{this.loading=!1,this.cdRef.detectChanges()}})}createUserProfile(e){return u(this,null,function*(){let t=this.authService.currentUserValue;if(!t)return;let i={id:e,email:t.email,first_name:t.first_name||"",last_name:t.last_name||"",phone:null,address:null,avatar_url:null,preferences:{email_notifications:!0,sms_notifications:!0,newsletter:!0},is_active:!0,role:"customer",created_at:new Date().toISOString(),updated_at:new Date().toISOString()},{data:m,error:p}=yield this.supabaseClient.from("users").insert(i).select().single();if(p){console.error("Errore creazione profilo:",p);return}m&&(this.userProfile=m,this.patchForm(m))})}patchForm(e){let t="";if(e.province){let i=this.provinces.find(m=>m.code===e.province);i&&(t=i.region,this.filterProvincesByRegion(t))}this.profileForm.patchValue({phone:e.phone||"",address:e.address||"",region:t,province:e.province||""})}onSubmit(){return u(this,null,function*(){if(!this.profileForm.invalid){this.loading=!0;try{let e=this.authService.currentUserValue;if(!e)throw new Error("Utente non autenticato");let t=this.profileForm.value,i={phone:t.phone||null,address:t.address||null,province:t.province||null,updated_at:new Date().toISOString()},{error:m}=yield this.supabaseClient.from("users").update(i).eq("id",e.id);if(m)throw m;alert("Profilo aggiornato con successo!")}catch(e){console.error("Errore salvataggio:",e),alert("Errore durante il salvataggio: "+(e.message||"Errore sconosciuto"))}finally{this.loading=!1,this.cdRef.detectChanges()}}})}restartTutorial(){let t=this.authService.getCurrentContext()==="staff"?"business":"customer";this.tutorialService.restartTutorial(t)}static \u0275fac=function(t){return new(t||s)};static \u0275cmp=_({type:s,selectors:[["app-profile-user"]],decls:76,vars:15,consts:[[1,"page-container"],[1,"profile-form",3,"ngSubmit","formGroup"],[1,"form-card"],[1,"form-row"],[1,"form-group"],[1,"standard-label"],["name","user",1,"nav-icon",3,"size"],["type","text","disabled","",1,"disabled-input",3,"value"],[1,"text-muted","text-mini","mt-sm"],[1,"material-icons"],["name","mail",1,"nav-icon",3,"size"],["type","email","disabled","",1,"disabled-input",3,"value"],[1,"flex","items-center","gap-sm","mb-md","mt-lg"],[1,"material-icons","text-md"],[1,"text-md","font-semibold","m-0"],[1,"form-row","mt-sm"],["formControlName","region",1,"standard-select",3,"change"],["value",""],[3,"value",4,"ngFor","ngForOf"],["formControlName","province",1,"standard-select",3,"change","disabled"],["class","text-warning text-mini mt-sm",4,"ngIf"],["class","text-muted text-mini mt-sm",4,"ngIf"],["type","tel","formControlName","phone","placeholder","+39 123 456 7890"],["type","text","formControlName","address","placeholder","Via Roma 123, Milano"],[1,"modal-footer","p-sm"],["type","submit",1,"promethea-button",3,"disabled"],[4,"ngIf"],["type","button",1,"promethea-button","outline",3,"click"],["name","play-circle",3,"size"],[3,"value"],[1,"text-warning","text-mini","mt-sm"],["name","info",3,"size"]],template:function(t,i){if(t&1&&(o(0,"div",0)(1,"form",1),v("ngSubmit",function(){return i.onSubmit()}),o(2,"div",2)(3,"div",3)(4,"div",4)(5,"label",5),c(6,"lucide-angular",6),n(7," Nome "),r(),c(8,"input",7),o(9,"div",8),n(10,"Il nome non pu\xF2 essere modificato"),r()(),o(11,"div",4)(12,"label",5)(13,"span",9),n(14,"person"),r(),n(15," Cognome "),r(),c(16,"input",7),o(17,"div",8),n(18,"Il cognome non pu\xF2 essere modificato"),r()()(),o(19,"div",4)(20,"label",5),c(21,"lucide-angular",10),n(22," Email "),r(),c(23,"input",11),o(24,"div",8),n(25,"L'email non pu\xF2 essere modificata"),r()(),o(26,"div",12)(27,"span",13),n(28,"contact_phone"),r(),o(29,"h2",14),n(30,"Informazioni di Contatto"),r()(),o(31,"div",15)(32,"div",4)(33,"label",5)(34,"span",9),n(35,"public"),r(),n(36," Regione "),r(),o(37,"select",16),v("change",function(p){return i.onRegionChange(p)}),o(38,"option",17),n(39,"Seleziona Regione"),r(),f(40,k,2,2,"option",18),r()(),o(41,"div",4)(42,"label",5)(43,"span",9),n(44,"map"),r(),n(45," Provincia "),r(),o(46,"select",19),v("change",function(p){return i.onProvinceChange(p)}),o(47,"option",17),n(48,"Seleziona Provincia"),r(),f(49,q,2,2,"option",18),r(),f(50,j,3,1,"div",20)(51,H,3,1,"div",21),r()(),o(52,"div",3)(53,"div",4)(54,"label",5)(55,"span",9),n(56,"phone"),r(),n(57," Telefono "),r(),c(58,"input",22),o(59,"div",8),n(60,"Numero per le notifiche e prenotazioni"),r()(),o(61,"div",4)(62,"label",5)(63,"span",9),n(64,"location_on"),r(),n(65," Indirizzo "),r(),c(66,"input",23),o(67,"div",8),n(68,"Indirizzo per consegne a domicilio"),r()()()(),o(69,"div",24)(70,"button",25),f(71,J,2,0,"span",26)(72,K,2,0,"span",26),r(),o(73,"button",27),v("click",function(){return i.restartTutorial()}),c(74,"lucide-angular",28),n(75," Rivedi il tutorial "),r()()()()),t&2){let m,p;a(),l("formGroup",i.profileForm),a(5),l("size",20),a(2),l("value",i.userProfile==null?null:i.userProfile.first_name),a(8),l("value",i.userProfile==null?null:i.userProfile.last_name),a(5),l("size",20),a(2),l("value",i.userProfile==null?null:i.userProfile.email),a(17),l("ngForOf",i.regions),a(6),l("disabled",!i.filteredProvinces.length),a(3),l("ngForOf",i.filteredProvinces),a(),l("ngIf",!i.filteredProvinces.length&&((m=i.profileForm.get("region"))==null?null:m.value)),a(),l("ngIf",!((p=i.profileForm.get("region"))!=null&&p.value)),a(19),l("disabled",i.loading||i.profileForm.invalid),a(),l("ngIf",i.loading),a(),l("ngIf",!i.loading),a(2),l("size",18)}},dependencies:[E,y,b,V,N,R,O,C,z,U,T,I,w,A,M],encapsulation:2})};export{B as ProfileUser};
