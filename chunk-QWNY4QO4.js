import{a as p,b as d,d as g}from"./chunk-TB7INTC7.js";import{Y as l,ca as u}from"./chunk-5BU4UD4M.js";import{g as n}from"./chunk-RA2WU32H.js";var v=class a{supabaseService=u(d);authService=u(g);isSupported(){return"serviceWorker"in navigator&&"PushManager"in window&&"Notification"in window}getPermissionStatus(){return this.isSupported()?Notification.permission:"unsupported"}requestPermissionAndSubscribe(){return n(this,null,function*(){if(console.log("PushService: requestPermissionAndSubscribe - start"),!this.isSupported()){console.warn("PushService: not supported");let e=yield this.hasActiveSubscription();return console.log("PushService: after upsert, hasActiveSubscription =",e),!1}if(Notification.permission==="denied")return console.log("PushService: permission already denied"),!1;try{console.log("PushService: requesting permission...");let e=yield Notification.requestPermission();if(console.log("PushService: permission result:",e),e!=="granted")return!1;console.log("PushService: getting service worker...");let r=yield navigator.serviceWorker.ready;console.log("PushService: service worker ready:",r),console.log("PushService: creating subscription...");let t=yield r.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:this.urlBase64ToUint8Array(p.vapidPublicKey)});console.log("PushService: subscription created:",t.toJSON());let s=this.getUserId();if(!s)return console.error("PushService: user not logged in"),!1;let i=t.toJSON(),o=new Date().toISOString();console.log("PushService: upserting to Supabase...");let{error:c}=yield this.supabaseService.getSupabaseClient().from("push_subscriptions").upsert({user_id:s,endpoint:i.endpoint,p256dh_key:i.keys?.p256dh,auth_key:i.keys?.auth,device_type:this.getDeviceType(),browser:this.getBrowserName(),user_agent:navigator.userAgent,consent_given_at:o,consent_user_agent:navigator.userAgent,is_active:!0,revoked_at:null},{onConflict:"user_id,endpoint"});return c?(console.error("PushService: Supabase upsert error:",c),!1):(console.log("PushService: upsert successful"),!0)}catch(e){return console.error("PushService: exception in requestPermissionAndSubscribe:",e),!1}})}revokeConsent(){return n(this,null,function*(){let e=this.getUserId();if(!e)return!1;try{let t=yield(yield navigator.serviceWorker.ready).pushManager.getSubscription();t&&(yield t.unsubscribe());let{error:s}=yield this.supabaseService.getSupabaseClient().from("push_subscriptions").update({is_active:!1,revoked_at:new Date().toISOString()}).eq("user_id",e);return!s}catch(r){return console.error("Errore revoca consenso:",r),!1}})}hasActiveSubscription(){return n(this,null,function*(){let e=this.getUserId();if(!e)return console.log("\u{1F50D} hasActiveSubscription - no userId"),!1;let{data:r,error:t}=yield this.supabaseService.getSupabaseClient().from("push_subscriptions").select("id").eq("user_id",e).eq("is_active",!0).limit(1);if(t)return console.error("\u274C hasActiveSubscription - DB error:",t),!1;let s=(r?.length??0)>0;return console.log("\u{1F50D} hasActiveSubscription - active:",s),s})}urlBase64ToUint8Array(e){let r="=".repeat((4-e.length%4)%4),t=(e+r).replace(/-/g,"+").replace(/_/g,"/"),s=window.atob(t),i=new Uint8Array(s.length);for(let o=0;o<s.length;++o)i[o]=s.charCodeAt(o);return i.buffer}getDeviceType(){let e=navigator.userAgent;return/tablet|ipad/i.test(e)?"tablet":/mobile|iphone|android/i.test(e)?"mobile":"desktop"}getBrowserName(){let e=navigator.userAgent;return e.includes("Chrome")?"Chrome":e.includes("Firefox")?"Firefox":e.includes("Safari")?"Safari":e.includes("Edge")?"Edge":"Unknown"}getUserId(){let e=this.authService.currentUserValue?.id??null;return console.log("PushService: getUserId =",e),e}static \u0275fac=function(r){return new(r||a)};static \u0275prov=l({token:a,factory:a.\u0275fac,providedIn:"root"})};export{v as a};
