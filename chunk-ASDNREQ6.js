import{a as f}from"./chunk-PYCM5Q4Y.js";import{D as v,J as h,Y as b,g as l,u as c}from"./chunk-25TB2OJR.js";import{a as d,b as m,i as g,j as a}from"./chunk-4ZZIO3ZI.js";var _=class u extends f{restaurantReservationsSubject=new l([]);restaurantReservations$=this.restaurantReservationsSubject.asObservable();refreshTriggerSubject=new l(void 0);refreshTrigger$=this.refreshTriggerSubject.asObservable();constructor(){super(),this.authService.currentUser$.pipe(v(e=>!!e),h(1)).subscribe(()=>{this.loadCustomerReservations()}),this.loadRestaurantReservations()}getTableName(){return"reservations"}loadCustomerReservations(){return a(this,null,function*(){try{let e=this.authService.currentUserValue;if(!e){console.log("No user found for customer reservations"),this.dataSubject.next([]);return}yield this.loadData({customer_id:e.id}),console.log("Customer reservations loaded via BaseService")}catch(e){console.error("Error in loadCustomerReservations:",e),this.handleError("loadCustomerReservations",e)}})}loadRestaurantReservations(){return a(this,null,function*(){try{this.loadingSubject.next(!0);let e=yield this.getCurrentRestaurantId();if(!e){console.log("No restaurant ID available for staff"),this.restaurantReservationsSubject.next([]),this.loadingSubject.next(!1);return}console.log("\u{1F50D} Querying reservations for restaurant:",e);let{data:t,error:r}=yield this.supabaseService.getSupabaseClient().from(this.getTableName()).select(`
        *,
        users:users!customer_id (
          first_name,
          last_name,
          email,
          phone
        ),
        tables:tables!table_id (
          table_name,
          table_number,
          capacity
        )
      `).eq("restaurant_id",e).order("reservation_date",{ascending:!0}).order("reservation_time",{ascending:!0});if(r)throw r;console.log("\u2705 Restaurant reservations loaded:",t?.length),console.log("\u{1F4E7} Sample reservation:",t?.[0]),this.restaurantReservationsSubject.next(t||[])}catch(e){console.error("Error loading restaurant reservations:",e),this.handleError("loadRestaurantReservations",e)}finally{this.loadingSubject.next(!1)}})}createCustomerReservation(e){return a(this,null,function*(){try{let t=this.authService.currentUserValue;if(!t)throw new Error("User not authenticated");let r={restaurant_id:e.restaurant_id,customer_id:t.id,table_id:e.table_id,reservation_date:e.reservation_date,reservation_time:e.reservation_time,party_size:e.party_size,special_requests:e.special_requests,status:"pending"},i=yield this.create(r);return i&&(yield this.loadCustomerReservations(),yield this.loadRestaurantReservations()),i}catch(t){return console.error("\u274C Error creating customer reservation:",t),this.handleError("createCustomerReservation",t),null}})}createRestaurantReservation(e){return a(this,null,function*(){try{let t=yield this.getCurrentRestaurantId();if(!t)throw new Error("Nessun ristorante selezionato");let r=m(d({},e),{restaurant_id:t,customer_id:e.customer_id||null,table_id:e.table_id||null,menu_id:e.menu_id||null,status:e.status||"confirmed",created_at:new Date().toISOString(),updated_at:new Date().toISOString()});console.log("\u{1F4E4} Creazione prenotazione con menu_id:",r.menu_id);let{data:i,error:s}=yield this.supabaseService.getSupabaseClient().from("reservations").insert(r).select(`
        *,
        tables (
          table_name,
          table_number,
          capacity
        ),
        menus (
          id,
          name,
          is_default,
          is_active
        )
      `).single();if(s)throw s;return yield this.loadRestaurantReservations(),i}catch(t){return console.error("Error creating restaurant reservation:",t),null}})}updateReservation(e,t){return a(this,null,function*(){try{console.log("\u{1F527} Aggiornamento prenotazione:",{reservationId:e,updates:t});let r={},i=["customer_name","customer_surname","customer_phone","customer_email","reservation_date","reservation_time","party_size","special_requests","table_id","status","menu_id","updated_at"];Object.keys(t).forEach(n=>{if(i.includes(n)&&t[n]!==void 0){let o=t[n];n==="menu_id"&&(o==="null"||o==="")?r[n]=null:r[n]=o}}),r.updated_at=new Date().toISOString(),console.log("\u{1F4E4} Dati validi per l'aggiornamento:",r);let{error:s}=yield this.supabaseService.getSupabaseClient().from("reservations").update(r).eq("id",e);if(s)throw console.error("\u274C Errore Supabase:",s),console.error("\u274C Dettagli:",s.details),console.error("\u274C Hint:",s.hint),console.error("\u274C Messaggio:",s.message),s;return console.log("\u2705 Prenotazione aggiornata con successo"),!0}catch(r){return console.error("\u274C Errore aggiornamento prenotazione:",r),!1}})}updateReservationStatus(e,t){return a(this,null,function*(){return yield this.updateReservation(e,{status:t})})}assignTableToReservation(e,t){return a(this,null,function*(){let r=yield this.update(e,{table_id:t});return r&&(yield this.loadRestaurantReservations(),this.triggerRefresh()),r})}removeTableFromReservation(e){return a(this,null,function*(){let t=yield this.update(e,{table_id:null});return t&&(yield this.loadRestaurantReservations(),this.triggerRefresh()),t})}deleteReservation(e){return a(this,null,function*(){let t=yield g(u.prototype,this,"delete").call(this,e);return t&&(yield this.loadRestaurantReservations(),this.triggerRefresh()),t})}triggerRefresh(){this.refreshTriggerSubject.next(void 0)}getFutureReservations(e){let t=new Date().toISOString().split("T")[0];return e.filter(r=>r.reservation_date>=t&&["pending","confirmed"].includes(r.status))}getReservationsByDate(e,t){return e.filter(r=>r.reservation_date===t)}getActiveReservations(e){let t=new Date().toISOString().split("T")[0];return e.filter(r=>r.reservation_date===t&&["pending","confirmed"].includes(r.status))}getCustomerName(e){return e.users?`${e.users.first_name||""} ${e.users.last_name||""}`.trim():e.customer_name?e.customer_name:"Cliente"}getCustomerContact(e){return e.users?e.users.phone||e.users.email||"":e.customer_phone||e.customer_email||""}getTableInfo(e){return e.tables?`${e.tables.table_name} (${e.tables.table_number})`:"N/A"}getRestaurantFutureReservations$(){return this.restaurantReservations$.pipe(c(e=>this.getFutureReservations(e)))}getRestaurantTodayReservations$(){return this.restaurantReservations$.pipe(c(e=>this.getActiveReservations(e)))}clearCache(){super.clearCache(),setTimeout(()=>{this.restaurantReservationsSubject&&this.restaurantReservationsSubject.next([])},0)}checkTableAvailability(e,t,r){return a(this,null,function*(){try{let{data:i,error:s}=yield this.supabaseService.getSupabaseClient().from("reservations").select("id").eq("table_id",e).eq("reservation_date",t).eq("reservation_time",r).in("status",["pending","confirmed"]).limit(1);if(s)throw s;return!i||i.length===0}catch(i){return console.error("\u274C Error checking table availability:",i),!1}})}getAvailableTimes(e,t){return a(this,null,function*(){try{let r=["12:00","12:30","13:00","13:30","14:00","19:00","19:30","20:00","20:30","21:00","21:30"],{data:i,error:s}=yield this.supabaseService.getSupabaseClient().from("reservations").select("reservation_time").eq("table_id",e).eq("reservation_date",t).in("status",["pending","confirmed"]);if(s)throw s;let n=i?.map(o=>o.reservation_time)||[];return r.filter(o=>!n.includes(o))}catch(r){return console.error("\u274C Error getting available times:",r),[]}})}getReservationWithMenu(e){return a(this,null,function*(){try{let{data:t,error:r}=yield this.supabaseService.getSupabaseClient().from("reservations").select(`
        *,
        menus (*)
      `).eq("id",e).single();if(r)throw r;return t}catch(t){return console.error("Error fetching reservation with menu:",t),null}})}updateReservationMenu(e,t){return a(this,null,function*(){try{let{error:r}=yield this.supabaseService.getSupabaseClient().from("reservations").update({menu_id:t,updated_at:new Date().toISOString()}).eq("id",e);if(r)throw r;return!0}catch(r){return console.error("Error updating reservation menu:",r),!1}})}static \u0275fac=function(t){return new(t||u)};static \u0275prov=b({token:u,factory:u.\u0275fac,providedIn:"root"})};export{_ as a};
