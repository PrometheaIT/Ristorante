import{a as m}from"./chunk-CXV4BLDF.js";import{w as b}from"./chunk-L5SOXNIK.js";import{F as g,L as f,_ as p,a as l,b as d,da as u,f as s,m as h}from"./chunk-KZSY5CHT.js";var v=class n{supabaseService=u(b);authService=u(m);dishesSubject=new h([]);dishes$=this.dishesSubject.asObservable();constructor(){this.authService.currentUser$.pipe(g(r=>!!r),f(1)).subscribe(()=>{this.loadDishes()})}loadDishes(){return s(this,null,function*(){try{let r=this.authService.currentUserValue;if(!r){console.log("No user found");return}let{data:e,error:t}=yield this.supabaseService.getSupabaseClient().from("restaurants").select("id").eq("owner_id",r.id).limit(1);if(t||!e||e.length===0){console.error("\u274C No restaurant found for user:",r.id);return}let i=e[0].id,{data:o,error:a}=yield this.supabaseService.getSupabaseClient().from("dishes").select("*").eq("restaurant_id",i).order("created_at",{ascending:!1});if(a){console.error("Error loading dishes:",a);return}console.log("Dishes loaded:",o?.length),this.dishesSubject.next(o||[])}catch(r){console.error("Error in loadDishes:",r)}})}createDish(r){return s(this,null,function*(){try{let e=this.authService.currentUserValue;if(!e)return console.error("No user authenticated"),null;let{data:t,error:i}=yield this.supabaseService.getSupabaseClient().from("restaurants").select("id").eq("owner_id",e.id).limit(1);if(i||!t||t.length===0)return console.error("\u274C No restaurant found for user:",e.id),null;let o=t[0].id,a=d(l({},r),{restaurant_id:o,status:"available",created_at:new Date().toISOString(),category_id:r.category_id||null});console.log("\u{1F4DD} Creating dish:",a);let{data:S,error:c}=yield this.supabaseService.getSupabaseClient().from("dishes").insert(a).select().single();if(c)throw console.error("\u274C Error creating dish:",c),c;return console.log("\u2705 Dish created successfully"),yield this.loadDishes(),S}catch(e){return console.error("\u{1F4A5} Error in createDish:",e),null}})}updateDish(r,e){return s(this,null,function*(){try{let{error:t}=yield this.supabaseService.getSupabaseClient().from("dishes").update(e).eq("id",r);if(t)throw t;return yield this.loadDishes(),!0}catch(t){return console.error("Error updating dish:",t),!1}})}getDishById(r){let e=this.dishesSubject.value,t=e.find(i=>i.id===r);return t||(console.warn("Piatto non trovato in cache:",r),console.log("Piatti in cache:",e.length)),t}getDefaultCategoryId(r){return s(this,null,function*(){try{let{data:e,error:t}=yield this.supabaseService.getSupabaseClient().from("categories").select("id").eq("restaurant_id",r).eq("is_default",!0).limit(1).single();if(t||!e){console.error("No default category found, using first category");let{data:i}=yield this.supabaseService.getSupabaseClient().from("categories").select("id").eq("restaurant_id",r).limit(1).single();return i?.id||null}return e.id}catch(e){return console.error("Error getting default category:",e),null}})}reloadDishes(){return s(this,null,function*(){yield this.loadDishes()})}static \u0275fac=function(e){return new(e||n)};static \u0275prov=p({token:n,factory:n.\u0275fac,providedIn:"root"})};export{v as a};
