import{c as oe,d as le,e as se,f as me,g as L}from"./chunk-FEI4XXIJ.js";import{a as re}from"./chunk-QUTFIOET.js";import"./chunk-SVYAZSVR.js";import{A as ae,a as q,b as Q,d as Y,i as J,k as X,s as Z,t as $,u as ee,v as te,w as ie,y as ne}from"./chunk-YO2SNT5L.js";import"./chunk-MEEOFM4U.js";import"./chunk-RD7WPZ3N.js";import"./chunk-JDHQCX3C.js";import{k as R,l as G,s as H,v as K}from"./chunk-RJWLMJIA.js";import{Ib as a,Jb as x,Kb as v,La as o,Lb as P,Ob as f,Pb as S,Qb as M,T as w,Va as j,Vb as W,Xb as F,Y as O,_a as g,ca as B,f as z,gb as c,hb as V,ib as k,kb as U,la as _,ma as p,na as A,qb as t,rb as n,sb as h,tb as E,ub as C,vb as b,xa as N,yb as u,zb as d}from"./chunk-KIAVC6JW.js";import{g as y}from"./chunk-RA2WU32H.js";var D=class l extends re{getTableName(){return"promotions"}getByStatus(i){return this.dataSubject.value.filter(e=>e.status===i)}getActiveNow(){let i=new Date;return this.dataSubject.value.filter(e=>e.status==="active"&&new Date(e.valid_from)<=i&&(!e.valid_until||new Date(e.valid_until)>=i))}getStatusCounts(){let i=this.dataSubject.value;return{all:i.length,draft:i.filter(e=>e.status==="draft").length,active:i.filter(e=>e.status==="active").length,paused:i.filter(e=>e.status==="paused").length,expired:i.filter(e=>e.status==="expired").length,archived:i.filter(e=>e.status==="archived").length}}toggleStatus(i,e){return y(this,null,function*(){return this.update(i,{status:e})})}toggleActiveState(i){return y(this,null,function*(){let e=i.status==="active"?"paused":"active";return this.toggleStatus(i.id,e)})}duplicate(i){return y(this,null,function*(){let e={name:`${i.name} (copia)`,description:i.description,internal_note:i.internal_note,type:i.type,target:i.target,discount_value:i.discount_value,max_discount_amount:i.max_discount_amount,valid_from:new Date().toISOString().split("T")[0],valid_until:null,max_uses_total:i.max_uses_total,max_uses_per_customer:i.max_uses_per_customer,min_order_amount:i.min_order_amount,priority:i.priority,stacking:i.stacking,status:"draft",is_public:i.is_public};return this.create(e)})}getStats(i){return y(this,null,function*(){try{let{data:e,error:s}=yield this.run(this.supabaseService.getSupabaseClient().from("promotion_usages").select("discount_applied, order_total_before, order_total_after").eq("promotion_id",i));if(s||!e)return null;let r=e,m=r.reduce((T,I)=>T+(I.discount_applied??0),0),ce=r.length>0?r.reduce((T,I)=>T+(I.order_total_before??0),0)/r.length:0;return{promotion_id:i,total_uses:r.length,total_discount_given:m,avg_order_value:ce}}catch{return null}})}formatDiscountValue(i){switch(i.type){case"percentage":return`${i.discount_value}%`;case"fixed_amount":return`-\u20AC${i.discount_value.toFixed(2)}`;case"happy_hour":return`${i.discount_value}% (Happy Hour)`;case"buy_x_get_y":return"Bundle";case"free_item":return"Omaggio";default:return`${i.discount_value}`}}isExpired(i){return!!(i.valid_until&&new Date(i.valid_until)<new Date||i.max_uses_total&&i.current_uses>=i.max_uses_total)}static \u0275fac=(()=>{let i;return function(s){return(i||(i=A(l)))(s||l)}})();static \u0275prov=O({token:l,factory:l.\u0275fac,providedIn:"root"})};function pe(l,i){if(l&1&&(t(0,"div",22)(1,"span",17),a(2,"error_outline"),n(),t(3,"span"),a(4),n()()),l&2){let e=d();o(4),x(e.error)}}function ue(l,i){if(l&1){let e=b();t(0,"button",23),u("click",function(){let r=_(e).$implicit,m=d();return p(m.setFilter(r.key))}),a(1),t(2,"span",24),a(3),n()()}if(l&2){let e=i.$implicit,s=d();k("active",s.activeFilter()===e.key),o(),v(" ",e.label," "),o(2),x(s.statusCounts[e.key])}}function ge(l,i){l&1&&(t(0,"div",25)(1,"span",26),a(2,"refresh"),n()())}function xe(l,i){l&1&&(E(0),a(1," Crea la tua prima promozione per iniziare! "),C())}function ve(l,i){if(l&1&&(E(0),a(1),C()),l&2){let e,s=d(2);o(),v(' Nessuna promozione con stato "',(e=s.statusLabels[s.activeFilter()])==null?null:e.label,'" ')}}function fe(l,i){if(l&1){let e=b();t(0,"button",16),u("click",function(){_(e);let r=d(2);return p(r.openCreateModal())}),t(1,"span",17),a(2,"add"),n(),a(3," Crea promozione "),n()}}function Se(l,i){if(l&1&&(t(0,"div",27)(1,"span",28),a(2,"campaign"),n(),t(3,"p",29),a(4,"Nessuna promozione"),n(),t(5,"p",30),g(6,xe,2,0,"ng-container",31)(7,ve,2,1,"ng-container",31),n(),g(8,fe,4,0,"button",32),n()),l&2){let e=d();o(6),c("ngIf",e.activeFilter()==="all"),o(),c("ngIf",e.activeFilter()!=="all"),o(),c("ngIf",e.activeFilter()==="all")}}function Me(l,i){if(l&1&&(t(0,"p",57),a(1),n()),l&2){let e=d().$implicit;o(),v(" ",e.description," ")}}function ye(l,i){if(l&1&&(t(0,"div",58)(1,"div",59)(2,"span"),a(3,"Utilizzi"),n(),t(4,"span"),a(5),n()(),t(6,"div",60),h(7,"div",61),n()()),l&2){let e=d().$implicit,s=d(2);o(5),P("",e.current_uses," / ",e.max_uses_total,""),o(2),V("width",s.getUsagePercent(e),"%"),k("usage-danger",s.getUsagePercent(e)>=90)}}function be(l,i){if(l&1&&(t(0,"div",62)(1,"span",45),a(2,"all_inclusive"),n(),t(3,"span",46),a(4),n()()),l&2){let e=d().$implicit;o(4),v("Utilizzi: ",e.current_uses," (illimitato)")}}function he(l,i){if(l&1&&(t(0,"div",62)(1,"span",45),a(2,"shopping_cart"),n(),t(3,"span",46),a(4),n()()),l&2){let e=d().$implicit;o(4),v("Min. ordine: \u20AC",e.min_order_amount,"")}}function we(l,i){if(l&1){let e=b();t(0,"button",63),u("click",function(){_(e);let r=d().$implicit,m=d(2);return p(m.publishDraft(r))}),t(1,"span",17),a(2,"rocket_launch"),n(),a(3," Pubblica "),n()}}function ke(l,i){if(l&1){let e=b();t(0,"button",64),u("click",function(){_(e);let r=d().$implicit,m=d(2);return p(m.toggleStatus(r))}),t(1,"span",17),a(2),n(),a(3),n()}if(l&2){let e=d().$implicit;o(2),v(" ",e.status==="active"?"pause":"play_arrow"," "),o(),v(" ",e.status==="active"?"Sospendi":"Riattiva"," ")}}function Ee(l,i){if(l&1){let e=b();t(0,"div",35)(1,"div",36)(2,"div",37)(3,"span",17),a(4),n(),t(5,"span",38),a(6),n()(),t(7,"span"),a(8),n()(),t(9,"h3",39),a(10),n(),g(11,Me,2,1,"p",40),t(12,"div",41)(13,"span",42),a(14),n(),t(15,"span",43),a(16),n()(),t(17,"div",44)(18,"span",45),a(19,"event"),n(),t(20,"span",46),a(21),n()(),g(22,ye,8,6,"div",47)(23,be,5,1,"div",48)(24,he,5,1,"div",48),t(25,"div",49),g(26,we,4,0,"button",50)(27,ke,4,2,"button",51),t(28,"div",52)(29,"button",53),u("click",function(){let r=_(e).$implicit,m=d(2);return p(m.openStatsModal(r))}),t(30,"span",17),a(31,"bar_chart"),n()(),t(32,"button",54),u("click",function(){let r=_(e).$implicit,m=d(2);return p(m.duplicate(r))}),t(33,"span",17),a(34,"content_copy"),n()(),t(35,"button",55),u("click",function(){let r=_(e).$implicit,m=d(2);return p(m.openEditModal(r))}),t(36,"span",17),a(37,"edit"),n()(),t(38,"button",56),u("click",function(){let r=_(e).$implicit,m=d(2);return p(m.openDeleteModal(r))}),t(39,"span",17),a(40,"delete_outline"),n()()()()()}if(l&2){let e=i.$implicit,s=d(2);k("expired-card",s.isExpired(e)),o(3),V("color",s.typeLabels[e.type].color),o(),v(" ",s.typeLabels[e.type].icon," "),o(2),x(s.typeLabels[e.type].label),o(),U(s.statusLabels[e.status].chipClass),o(),v(" ",s.statusLabels[e.status].label," "),o(2),x(e.name),o(),c("ngIf",e.description),o(3),x(s.formatDiscount(e)),o(2),v(" su ",s.targetLabels[e.target]," "),o(5),P(" ",s.formatDate(e.valid_from)," \u2192 ",s.formatDate(e.valid_until)," "),o(),c("ngIf",e.max_uses_total),o(),c("ngIf",!e.max_uses_total),o(),c("ngIf",e.min_order_amount>0),o(2),c("ngIf",e.status==="draft"),o(),c("ngIf",e.status==="active"||e.status==="paused")}}function Ce(l,i){if(l&1&&(t(0,"div",33),g(1,Ee,41,20,"div",34),n()),l&2){let e=d();o(),c("ngForOf",e.filteredPromotions)("ngForTrackBy",e.trackById)}}function Pe(l,i){if(l&1&&(t(0,"option",102),a(1),n()),l&2){let e=i.$implicit,s=d(2);c("value",e),o(),v(" ",s.typeLabels[e].label," ")}}function De(l,i){if(l&1&&(t(0,"option",102),a(1),n()),l&2){let e=i.$implicit,s=d(2);c("value",e),o(),v(" ",s.targetLabels[e]," ")}}function Te(l,i){if(l&1){let e=b();t(0,"div",74)(1,"label",75),a(2," Sconto massimo \u20AC "),t(3,"span",5),a(4,"(opzionale)"),n()(),t(5,"input",103),M("ngModelChange",function(r){_(e);let m=d(2);return S(m.formData.max_discount_amount,r)||(m.formData.max_discount_amount=r),p(r)}),n()()}if(l&2){let e=d(2);o(5),f("ngModel",e.formData.max_discount_amount)}}function Ie(l,i){if(l&1&&(t(0,"option",102),a(1),n()),l&2){let e=i.$implicit,s=d(2);c("value",e),o(),P(" ",s.stackingLabels[e].label," \u2014 ",s.stackingLabels[e].description," ")}}function Ve(l,i){l&1&&(t(0,"span",17),a(1,"refresh"),n())}function We(l,i){l&1&&(t(0,"span",104),a(1,"loading..."),n())}function Fe(l,i){if(l&1&&(E(0),t(1,"span",17),a(2),n(),a(3),C()),l&2){let e=d(2);o(2),x(e.selectedPromotion?"save":"add_circle"),o(),v(" ",e.selectedPromotion?"Salva modifiche":"Crea promozione"," ")}}function Le(l,i){if(l&1){let e=b();t(0,"div",65),u("click.self",function(){_(e);let r=d();return p(r.closeFormModal())}),t(1,"div",66)(2,"div",67)(3,"div",37)(4,"span",4),a(5),n(),t(6,"span",68),a(7),n()(),t(8,"button",69),u("click",function(){_(e);let r=d();return p(r.closeFormModal())}),t(9,"span",17),a(10,"close"),n()()(),t(11,"div",70)(12,"p",71)(13,"span",72),a(14,"info"),n(),a(15," Identit\xE0 "),n(),t(16,"div",73)(17,"div",74)(18,"label",75),a(19,"Nome promozione *"),n(),t(20,"input",76),M("ngModelChange",function(r){_(e);let m=d();return S(m.formData.name,r)||(m.formData.name=r),p(r)}),n()()(),t(21,"div",73)(22,"div",74)(23,"label",75),a(24,"Descrizione pubblica"),n(),t(25,"textarea",77),M("ngModelChange",function(r){_(e);let m=d();return S(m.formData.description,r)||(m.formData.description=r),p(r)}),n()(),t(26,"div",74)(27,"label",75)(28,"span",78),a(29,"lock"),n(),a(30," Nota interna "),n(),t(31,"textarea",79),M("ngModelChange",function(r){_(e);let m=d();return S(m.formData.internal_note,r)||(m.formData.internal_note=r),p(r)}),n()()(),h(32,"hr",80),t(33,"p",71)(34,"span",72),a(35,"percent"),n(),a(36," Tipo e Valore "),n(),t(37,"div",73)(38,"div",74)(39,"label",75),a(40,"Tipo promozione"),n(),t(41,"select",81),M("ngModelChange",function(r){_(e);let m=d();return S(m.formData.type,r)||(m.formData.type=r),p(r)}),g(42,Pe,2,2,"option",82),n()(),t(43,"div",74)(44,"label",75),a(45,"Applicata su"),n(),t(46,"select",81),M("ngModelChange",function(r){_(e);let m=d();return S(m.formData.target,r)||(m.formData.target=r),p(r)}),g(47,De,2,2,"option",82),n()()(),t(48,"div",73)(49,"div",74)(50,"label",75),a(51," Valore sconto "),t(52,"span",38),a(53),n()(),t(54,"input",83),M("ngModelChange",function(r){_(e);let m=d();return S(m.formData.discount_value,r)||(m.formData.discount_value=r),p(r)}),n()(),g(55,Te,6,1,"div",84),t(56,"div",74)(57,"label",75),a(58,"Ordine minimo \u20AC"),n(),t(59,"input",85),M("ngModelChange",function(r){_(e);let m=d();return S(m.formData.min_order_amount,r)||(m.formData.min_order_amount=r),p(r)}),n()()(),h(60,"hr",80),t(61,"p",71)(62,"span",72),a(63,"event"),n(),a(64," Validit\xE0 e Limiti "),n(),t(65,"div",73)(66,"div",74)(67,"label",75),a(68,"Data inizio *"),n(),t(69,"input",86),M("ngModelChange",function(r){_(e);let m=d();return S(m.formData.valid_from,r)||(m.formData.valid_from=r),p(r)}),n()(),t(70,"div",74)(71,"label",75),a(72," Data fine "),t(73,"span",5),a(74,"(lascia vuoto = nessuna scadenza)"),n()(),t(75,"input",86),M("ngModelChange",function(r){_(e);let m=d();return S(m.formData.valid_until,r)||(m.formData.valid_until=r),p(r)}),n()()(),t(76,"div",73)(77,"div",74)(78,"label",75),a(79," Utilizzi totali "),t(80,"span",5),a(81,"(vuoto = illimitato)"),n()(),t(82,"input",87),M("ngModelChange",function(r){_(e);let m=d();return S(m.formData.max_uses_total,r)||(m.formData.max_uses_total=r),p(r)}),n()(),t(83,"div",74)(84,"label",75),a(85,"Max per cliente"),n(),t(86,"input",88),M("ngModelChange",function(r){_(e);let m=d();return S(m.formData.max_uses_per_customer,r)||(m.formData.max_uses_per_customer=r),p(r)}),n()()(),h(87,"hr",80),t(88,"p",71)(89,"span",72),a(90,"tune"),n(),a(91," Regole e Visibilit\xE0 "),n(),t(92,"div",73)(93,"div",74)(94,"label",75),a(95,"Compatibilit\xE0 con altri sconti"),n(),t(96,"select",81),M("ngModelChange",function(r){_(e);let m=d();return S(m.formData.stacking,r)||(m.formData.stacking=r),p(r)}),g(97,Ie,2,3,"option",82),n()(),t(98,"div",74)(99,"label",75),a(100," Priorit\xE0 "),t(101,"span",5),a(102,"(pi\xF9 alto = vince in caso di conflitto)"),n()(),t(103,"input",89),M("ngModelChange",function(r){_(e);let m=d();return S(m.formData.priority,r)||(m.formData.priority=r),p(r)}),n()()(),t(104,"div",73)(105,"div",74)(106,"label",75),a(107,"Stato iniziale"),n(),t(108,"select",81),M("ngModelChange",function(r){_(e);let m=d();return S(m.formData.status,r)||(m.formData.status=r),p(r)}),t(109,"option",90),a(110,"Bozza (non ancora attiva)"),n(),t(111,"option",91),a(112,"Attiva subito"),n(),t(113,"option",92),a(114,"Sospesa"),n()()(),t(115,"div",93)(116,"label",94)(117,"input",95),M("ngModelChange",function(r){_(e);let m=d();return S(m.formData.is_public,r)||(m.formData.is_public=r),p(r)}),n(),t(118,"div",96)(119,"strong"),a(120,"Visibile ai clienti"),n(),t(121,"span",30),a(122,"La promozione apparir\xE0 nel men\xF9 pubblico"),n()()()()()(),t(123,"div",97)(124,"button",98),u("click",function(){_(e);let r=d();return p(r.closeFormModal())}),a(125," Annulla "),n(),t(126,"button",99),u("click",function(){_(e);let r=d();return p(r.savePromotion())}),g(127,Ve,2,0,"span",100)(128,We,2,0,"span",101)(129,Fe,4,2,"ng-container",31),n()()()()}if(l&2){let e=d();o(5),x(e.selectedPromotion?"edit":"add_circle"),o(2),v(" ",e.selectedPromotion?"Modifica promozione":"Nuova promozione"," "),o(13),f("ngModel",e.formData.name),o(5),f("ngModel",e.formData.description),o(6),f("ngModel",e.formData.internal_note),o(10),f("ngModel",e.formData.type),o(),c("ngForOf",e.promotionTypes),o(4),f("ngModel",e.formData.target),o(),c("ngForOf",e.discountTargets),o(6),x(e.discountSuffix),o(),f("ngModel",e.formData.discount_value),c("placeholder",e.formData.type==="percentage"?"10":"5.00"),o(),c("ngIf",e.showMaxCap),o(4),f("ngModel",e.formData.min_order_amount),o(10),f("ngModel",e.formData.valid_from),o(6),f("ngModel",e.formData.valid_until),o(7),f("ngModel",e.formData.max_uses_total),o(4),f("ngModel",e.formData.max_uses_per_customer),o(10),f("ngModel",e.formData.stacking),o(),c("ngForOf",e.stackingPolicies),o(6),f("ngModel",e.formData.priority),o(5),f("ngModel",e.formData.status),o(9),f("ngModel",e.formData.is_public),o(7),c("disabled",e.isSaving),o(2),c("disabled",e.isSaving||!e.formData.name.trim()),o(),c("ngIf",e.isSaving),o(),c("ngIf",e.isSaving),o(),c("ngIf",!e.isSaving)}}function ze(l,i){if(l&1){let e=b();t(0,"div",65),u("click.self",function(){_(e);let r=d();return p(r.closeDeleteModal())}),t(1,"div",105)(2,"div",67)(3,"div",37)(4,"span",106),a(5,"delete_forever"),n(),t(6,"span",68),a(7,"Elimina promozione"),n()(),t(8,"button",69),u("click",function(){_(e);let r=d();return p(r.closeDeleteModal())}),t(9,"span",17),a(10,"close"),n()()(),t(11,"div",70)(12,"p",58),a(13,"Stai per eliminare:"),n(),t(14,"div",107)(15,"span",29),a(16),n(),t(17,"span",5),a(18),n()(),t(19,"p",108),a(20," Questa azione \xE8 irreversibile. Gli utilizzi gi\xE0 registrati non verranno cancellati. "),n()(),t(21,"div",97)(22,"button",98),u("click",function(){_(e);let r=d();return p(r.closeDeleteModal())}),a(23," Annulla "),n(),t(24,"button",109),u("click",function(){_(e);let r=d();return p(r.confirmDelete())}),t(25,"span",17),a(26,"delete_forever"),n(),a(27," Elimina definitivamente "),n()()()()}if(l&2){let e=d();o(16),x(e.selectedPromotion==null?null:e.selectedPromotion.name),o(2),x(e.formatDiscount(e.selectedPromotion)),o(4),c("disabled",e.isSaving),o(2),c("disabled",e.isSaving)}}function Oe(l,i){l&1&&(t(0,"div",25)(1,"span",26),a(2,"refresh"),n()())}function Be(l,i){if(l&1&&(t(0,"div",116)(1,"span",4),a(2,"donut_large"),n(),t(3,"span",5),a(4,"Saturazione"),n(),t(5,"span",6),a(6),n()()),l&2){let e=d(3);o(6),v("",e.getUsagePercent(e.selectedPromotion),"%")}}function Ae(l,i){if(l&1&&(t(0,"div",115)(1,"div",116)(2,"span",4),a(3,"receipt_long"),n(),t(4,"span",5),a(5,"Utilizzi totali"),n(),t(6,"span",6),a(7),n()(),t(8,"div",116)(9,"span",4),a(10,"savings"),n(),t(11,"span",5),a(12,"Sconto erogato"),n(),t(13,"span",6),a(14),W(15,"number"),n()(),t(16,"div",116)(17,"span",4),a(18,"shopping_basket"),n(),t(19,"span",5),a(20,"Scontrino medio"),n(),t(21,"span",6),a(22),W(23,"number"),n()(),g(24,Be,7,1,"div",117),n()),l&2){let e=d(2);o(7),x(e.selectedStats.total_uses),o(7),v("\u20AC",F(15,4,e.selectedStats.total_discount_given,"1.2-2"),""),o(8),v("\u20AC",F(23,7,e.selectedStats.avg_order_value,"1.2-2"),""),o(2),c("ngIf",e.selectedPromotion==null?null:e.selectedPromotion.max_uses_total)}}function Ne(l,i){l&1&&(t(0,"div",118)(1,"span",28),a(2,"bar_chart"),n(),t(3,"p",108),a(4,"Nessun utilizzo registrato ancora"),n()())}function je(l,i){if(l&1){let e=b();t(0,"div",65),u("click.self",function(){_(e);let r=d();return p(r.closeStatsModal())}),t(1,"div",110)(2,"div",67)(3,"div",37)(4,"span",4),a(5,"bar_chart"),n(),t(6,"span",68),a(7,"Statistiche"),n()(),t(8,"button",69),u("click",function(){_(e);let r=d();return p(r.closeStatsModal())}),t(9,"span",17),a(10,"close"),n()()(),t(11,"div",70)(12,"p",111),a(13),n(),g(14,Oe,3,0,"div",18)(15,Ae,25,10,"div",112)(16,Ne,5,0,"div",113),n(),t(17,"div",97)(18,"button",114),u("click",function(){_(e);let r=d();return p(r.closeStatsModal())}),a(19," Chiudi "),n()()()()}if(l&2){let e=d();o(13),x(e.selectedPromotion==null?null:e.selectedPromotion.name),o(),c("ngIf",e.loadingStats),o(),c("ngIf",!e.loadingStats&&e.selectedStats),o(),c("ngIf",!e.loadingStats&&!e.selectedStats)}}var de=class l{promotionService=B(D);destroy$=new z;promotions=[];loading=!1;error=null;activeFilter=N("all");statusCounts={all:0,draft:0,active:0,paused:0,expired:0,archived:0};showFormModal=!1;showDeleteModal=!1;showStatsModal=!1;isSaving=!1;selectedPromotion=null;formData=L();selectedStats=null;loadingStats=!1;typeLabels=oe;statusLabels=le;targetLabels=se;stackingLabels=me;promotionTypes=["percentage","fixed_amount","happy_hour","buy_x_get_y","free_item"];discountTargets=["order","category","product","delivery"];stackingPolicies=["exclusive","cumulative","best_deal"];filterTabs=[{key:"all",label:"Tutte"},{key:"active",label:"Attive"},{key:"draft",label:"Bozze"},{key:"paused",label:"Sospese"},{key:"expired",label:"Scadute"},{key:"archived",label:"Archivio"}];get filteredPromotions(){let i=this.activeFilter();return i==="all"?this.promotions:this.promotions.filter(e=>e.status===i)}ngOnInit(){this.promotionService.data$.pipe(w(this.destroy$)).subscribe(i=>{this.promotions=i,this.statusCounts=this.promotionService.getStatusCounts()}),this.promotionService.loading$.pipe(w(this.destroy$)).subscribe(i=>this.loading=i),this.promotionService.error$.pipe(w(this.destroy$)).subscribe(i=>this.error=i),this.promotionService.loadData()}ngOnDestroy(){this.destroy$.next(),this.destroy$.complete()}setFilter(i){this.activeFilter.set(i)}openCreateModal(){this.selectedPromotion=null,this.formData=L(),this.showFormModal=!0}openEditModal(i){this.selectedPromotion=i,this.formData={name:i.name,description:i.description??null,internal_note:i.internal_note??null,image_url:i.image_url??null,type:i.type,target:i.target,discount_value:i.discount_value,max_discount_amount:i.max_discount_amount??null,valid_from:i.valid_from.split("T")[0],valid_until:i.valid_until?i.valid_until.split("T")[0]:null,max_uses_total:i.max_uses_total??null,max_uses_per_customer:i.max_uses_per_customer??null,min_order_amount:i.min_order_amount,priority:i.priority,stacking:i.stacking,status:i.status,is_public:i.is_public},this.showFormModal=!0}closeFormModal(){this.showFormModal=!1,this.selectedPromotion=null}savePromotion(){return y(this,null,function*(){if(this.formData.name?.trim()){this.isSaving=!0;try{this.selectedPromotion?yield this.promotionService.update(this.selectedPromotion.id,this.formData):yield this.promotionService.create(this.formData),this.closeFormModal()}finally{this.isSaving=!1}}})}openDeleteModal(i){this.selectedPromotion=i,this.showDeleteModal=!0}closeDeleteModal(){this.showDeleteModal=!1,this.selectedPromotion=null}confirmDelete(){return y(this,null,function*(){if(this.selectedPromotion){this.isSaving=!0;try{yield this.promotionService.delete(this.selectedPromotion.id),this.closeDeleteModal()}finally{this.isSaving=!1}}})}toggleStatus(i){return y(this,null,function*(){yield this.promotionService.toggleActiveState(i)})}duplicate(i){return y(this,null,function*(){yield this.promotionService.duplicate(i)})}publishDraft(i){return y(this,null,function*(){yield this.promotionService.toggleStatus(i.id,"active")})}openStatsModal(i){return y(this,null,function*(){this.selectedPromotion=i,this.selectedStats=null,this.showStatsModal=!0,this.loadingStats=!0;try{this.selectedStats=yield this.promotionService.getStats(i.id)}finally{this.loadingStats=!1}})}closeStatsModal(){this.showStatsModal=!1,this.selectedPromotion=null,this.selectedStats=null}formatDiscount(i){return this.promotionService.formatDiscountValue(i)}isExpired(i){return this.promotionService.isExpired(i)}formatDate(i){return i?new Date(i).toLocaleDateString("it-IT",{day:"2-digit",month:"short",year:"numeric"}):"\u221E"}get discountSuffix(){return this.formData.type==="percentage"?"%":"\u20AC"}get showMaxCap(){return this.formData.type==="percentage"}canToggle(i){return i.status!=="expired"&&i.status!=="archived"}getUsagePercent(i){return!i.max_uses_total||i.max_uses_total===0?0:Math.min(100,Math.round(i.current_uses/i.max_uses_total*100))}trackById(i,e){return e.id}objectKeys(i){return Object.keys(i)}static \u0275fac=function(e){return new(e||l)};static \u0275cmp=j({type:l,selectors:[["app-marketing-management"]],decls:53,vars:13,consts:[[1,"page-container"],[1,"p-lg"],[1,"grid-cards","mb-lg",2,"grid-template-columns","repeat(auto-fit, minmax(150px, 1fr))"],[1,"card","p-md","items-center","text-center","gap-sm"],[1,"material-icons","gradient-text"],[1,"text-muted","text-mini"],[1,"font-bold","text-md"],[1,"material-icons",2,"color","#10b981"],[1,"font-bold","text-md",2,"color","#10b981"],[1,"material-icons",2,"color","#f59e0b"],[1,"font-bold","text-md",2,"color","#f59e0b"],[1,"material-icons",2,"color","var(--text-muted)"],["class","info-message mb-lg",4,"ngIf"],[1,"flex","justify-between","gap-sm"],[1,"flex","flex-wrap","gap-sm","mb-lg"],["class","chip","style","cursor: pointer",3,"active","click",4,"ngFor","ngForOf"],[1,"promethea-button",3,"click"],[1,"material-icons"],["class","flex justify-center p-lg",4,"ngIf"],["class","card p-lg text-center gap-md items-center",4,"ngIf"],["class","grid-cards",4,"ngIf"],["class","modal-overlay",3,"click.self",4,"ngIf"],[1,"info-message","mb-lg"],[1,"chip",2,"cursor","pointer",3,"click"],[1,"chip-mini",2,"margin-left","4px"],[1,"flex","justify-center","p-lg"],[1,"material-icons","animate-spin","gradient-text","text-lg"],[1,"card","p-lg","text-center","gap-md","items-center"],[1,"material-icons","text-lg",2,"opacity","0.3"],[1,"font-bold"],[1,"text-muted"],[4,"ngIf"],["class","promethea-button",3,"click",4,"ngIf"],[1,"grid-cards"],["class","card promotion-card",3,"expired-card",4,"ngFor","ngForOf","ngForTrackBy"],[1,"card","promotion-card"],[1,"flex","justify-between","items-center","gap-sm","mb-sm"],[1,"flex","items-center","gap-sm"],[1,"chip-mini"],[1,"card-title"],["class","text-muted text-mini mb-sm",4,"ngIf"],[1,"discount-badge","flex","items-center","justify-center","p-sm","rounded","mb-sm",2,"background","color-mix(in srgb, var(--primary) 12%, transparent)"],[1,"font-bold","text-md","gradient-text"],[1,"text-mini","text-muted",2,"margin-left","6px"],[1,"flex","gap-sm","items-center","mb-sm"],[1,"material-icons","text-mini","text-muted"],[1,"text-mini","text-muted"],["class","mb-sm",4,"ngIf"],["class","flex items-center gap-sm mb-sm",4,"ngIf"],[1,"card-footer","flex","gap-sm","flex-wrap","justify-between"],["class","promethea-button","style","flex: 1; font-size: var(--fs-mini)",3,"click",4,"ngIf"],["class","promethea-button ghost","style","flex: 1; font-size: var(--fs-mini)",3,"click",4,"ngIf"],[1,"flex","gap-sm"],["title","Statistiche",1,"icon-button","x-small",3,"click"],["title","Duplica",1,"icon-button","x-small",3,"click"],["title","Modifica",1,"icon-button","x-small",3,"click"],["title","Elimina",1,"icon-button","x-small",2,"color","var(--secondary)",3,"click"],[1,"text-muted","text-mini","mb-sm"],[1,"mb-sm"],[1,"flex","justify-between","text-mini","text-muted","mb-sm"],[1,"usage-bar"],[1,"usage-fill"],[1,"flex","items-center","gap-sm","mb-sm"],[1,"promethea-button",2,"flex","1","font-size","var(--fs-mini)",3,"click"],[1,"promethea-button","ghost",2,"flex","1","font-size","var(--fs-mini)",3,"click"],[1,"modal-overlay",3,"click.self"],[1,"modal-container","modal-lg"],[1,"modal-header"],[1,"section-title"],[1,"icon-button",3,"click"],[1,"form-card"],[1,"font-bold","mb-sm","flex","items-center","gap-sm"],[1,"material-icons","text-mini","gradient-text"],[1,"form-row"],[1,"form-group"],[1,"standard-label"],["type","text","placeholder","Es. Sconto Aperitivo Serale","maxlength","80",3,"ngModelChange","ngModel"],["placeholder","Testo che vedr\xE0 il cliente","rows","2",2,"min-height","4rem",3,"ngModelChange","ngModel"],[1,"material-icons","text-mini"],["placeholder","Solo per il tuo staff (non visibile al cliente)","rows","2",2,"min-height","4rem",3,"ngModelChange","ngModel"],[2,"border-color","var(--smoke-1)","margin","var(--gap-md) 0"],[3,"ngModelChange","ngModel"],[3,"value",4,"ngFor","ngForOf"],["type","number","min","0","step","0.01",3,"ngModelChange","ngModel","placeholder"],["class","form-group",4,"ngIf"],["type","number","placeholder","0 = nessun minimo","min","0","step","0.01",3,"ngModelChange","ngModel"],["type","date",3,"ngModelChange","ngModel"],["type","number","placeholder","Es. 100","min","1",3,"ngModelChange","ngModel"],["type","number","placeholder","1","min","1",3,"ngModelChange","ngModel"],["type","number","placeholder","0","min","0","max","100",3,"ngModelChange","ngModel"],["value","draft"],["value","active"],["value","paused"],[1,"form-group",2,"justify-content","center"],[1,"checkbox-label"],["type","checkbox",3,"ngModelChange","ngModel"],[1,"checkbox-content"],[1,"modal-footer"],[1,"promethea-button","ghost",3,"click","disabled"],[1,"promethea-button",3,"click","disabled"],["class","material-icons",4,"ngIf"],["class","animate-spin",4,"ngIf"],[3,"value"],["type","number","placeholder","Es. 15 \u2192 max \u20AC15 anche se % \xE8 alta","min","0","step","0.01",3,"ngModelChange","ngModel"],[1,"animate-spin"],[1,"modal-container","modal-sm"],[1,"material-icons",2,"color","var(--secondary)"],[1,"card","p-md","gap-sm",2,"background","color-mix(in srgb, var(--secondary) 8%, transparent)"],[1,"text-muted","mt-sm"],[1,"promethea-button",2,"background","var(--secondary)",3,"click","disabled"],[1,"modal-container","modal-md"],[1,"font-bold","mb-lg"],["class","grid-cards","style","grid-template-columns: repeat(auto-fit, minmax(140px, 1fr))",4,"ngIf"],["class","text-center p-lg",4,"ngIf"],[1,"promethea-button","ghost",3,"click"],[1,"grid-cards",2,"grid-template-columns","repeat(auto-fit, minmax(140px, 1fr))"],[1,"card","p-md","text-center","gap-sm","items-center"],["class","card p-md text-center gap-sm items-center",4,"ngIf"],[1,"text-center","p-lg"]],template:function(e,s){e&1&&(t(0,"div",0)(1,"div",1)(2,"div",2)(3,"div",3)(4,"span",4),a(5,"local_offer"),n(),t(6,"span",5),a(7,"Totale"),n(),t(8,"span",6),a(9),n()(),t(10,"div",3)(11,"span",7),a(12,"bolt"),n(),t(13,"span",5),a(14,"Attive ora"),n(),t(15,"span",8),a(16),n()(),t(17,"div",3)(18,"span",4),a(19,"drafts"),n(),t(20,"span",5),a(21,"Bozze"),n(),t(22,"span",6),a(23),n()(),t(24,"div",3)(25,"span",9),a(26,"pause_circle"),n(),t(27,"span",5),a(28,"Sospese"),n(),t(29,"span",10),a(30),n()(),t(31,"div",3)(32,"span",11),a(33,"event_busy"),n(),t(34,"span",5),a(35,"Scadute"),n(),t(36,"span",6),a(37),n()()(),g(38,pe,5,1,"div",12),t(39,"div",13)(40,"div",14),g(41,ue,4,4,"button",15),n(),t(42,"button",16),u("click",function(){return s.openCreateModal()}),t(43,"span",17),a(44,"add"),n(),t(45,"span"),a(46,"Nuova promo"),n()()(),g(47,ge,3,0,"div",18)(48,Se,9,3,"div",19)(49,Ce,2,2,"div",20),n()(),g(50,Le,130,28,"div",21)(51,ze,28,4,"div",21)(52,je,20,4,"div",21)),e&2&&(o(9),x(s.statusCounts.all),o(7),x(s.statusCounts.active),o(7),x(s.statusCounts.draft),o(7),x(s.statusCounts.paused),o(7),x(s.statusCounts.expired),o(),c("ngIf",s.error),o(3),c("ngForOf",s.filterTabs),o(6),c("ngIf",s.loading&&s.promotions.length===0),o(),c("ngIf",!s.loading&&s.filteredPromotions.length===0),o(),c("ngIf",s.filteredPromotions.length>0),o(),c("ngIf",s.showFormModal),o(),c("ngIf",s.showDeleteModal),o(),c("ngIf",s.showStatsModal))},dependencies:[K,R,G,H,ae,$,ee,Q,X,q,Z,Y,ne,ie,te,J],styles:[".usage-bar[_ngcontent-%COMP%]{width:100%;height:6px;background:var(--smoke-1);border-radius:999px;overflow:hidden}.usage-fill[_ngcontent-%COMP%]{height:100%;background:var(--gradiente);border-radius:999px;transition:width .4s ease}.usage-danger[_ngcontent-%COMP%]{background:linear-gradient(135deg,#f59e0b,var(--secondary))}.expired-card[_ngcontent-%COMP%]{opacity:.65;filter:grayscale(30%)}.discount-badge[_ngcontent-%COMP%]{border-radius:12px;min-height:44px}"]})};export{de as MarketingManagement};
