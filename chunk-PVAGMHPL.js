import{B as m,D as b}from"./chunk-KBL2L3GY.js";import{H as l,N as g,a as o,b as u,ba as p,f as i,ga as c,m as d}from"./chunk-UE7YVF6I.js";var f=class s{supabaseService=c(m);authService=c(b);ingredientsSubject=new d([]);ingredients$=this.ingredientsSubject.asObservable();constructor(){this.authService.currentUser$.pipe(l(e=>!!e),g(1)).subscribe(()=>{this.loadIngredients()})}loadIngredients(){return i(this,null,function*(){try{let e=yield this.getCurrentRestaurantId();if(!e){console.log("No restaurant found");return}let{data:r,error:t}=yield this.supabaseService.getSupabaseClient().from("ingredients").select(`
        *,
        units (*),
        suppliers (company_name, contact_name)
      `).eq("restaurant_id",e).eq("is_active",!0).order("name");if(t){console.error("Error loading ingredients:",t);return}console.log("Ingredients loaded with units and suppliers:",r?.length),this.ingredientsSubject.next(r||[])}catch(e){console.error("Error in loadIngredients:",e)}})}createIngredient(e){return i(this,null,function*(){try{let r=yield this.getCurrentRestaurantId();if(!r)return console.error("No restaurant found"),null;console.log("\u{1F3EA} Using restaurant:",r);let t=u(o({},e),{expiry_date:e.expiry_date===""?null:e.expiry_date,restaurant_id:r});console.log("\u{1F4DD} Creating ingredient:",t);let{data:n,error:a}=yield this.supabaseService.getSupabaseClient().from("ingredients").insert(t).select().single();if(a)throw console.error("\u274C Error creating ingredient:",a),a;return console.log("\u2705 Ingredient created successfully"),yield this.loadIngredients(),n}catch(r){return console.error("\u{1F4A5} Error in createIngredient:",r),null}})}updateIngredient(e,r){return i(this,null,function*(){try{let t=u(o({},r),{expiry_date:r.expiry_date===""?null:r.expiry_date}),{error:n}=yield this.supabaseService.getSupabaseClient().from("ingredients").update(t).eq("id",e);if(n)throw n;return yield this.loadIngredients(),!0}catch(t){return console.error("Error updating ingredient:",t),!1}})}deleteIngredient(e){return i(this,null,function*(){try{let{error:r}=yield this.supabaseService.getSupabaseClient().from("ingredients").update({is_active:!1}).eq("id",e);if(r)throw r;return yield this.loadIngredients(),!0}catch(r){return console.error("Error deleting ingredient:",r),!1}})}getIngredients(){return this.ingredientsSubject.value}getIngredientById(e){return this.ingredientsSubject.value.find(r=>r.id===e)}getLowStockIngredients(){return this.ingredientsSubject.value.filter(e=>e.alert_enabled&&e.current_stock<=e.minimum_stock)}searchIngredients(e){return e?this.ingredientsSubject.value.filter(r=>r.name.toLowerCase().includes(e.toLowerCase())||r.description?.toLowerCase().includes(e.toLowerCase())):this.ingredientsSubject.value}calculateIngredientCost(e,r){if(!e.unit_id||!e.units)return e.cost_per_unit*r;let t=e.units,n=r;switch(t.symbol){case"kg":n=r/1e3;break;case"L":n=r/1e3;break;case"g":case"mL":case"pz":n=r;break;default:n=r}return e.cost_per_unit*n}getCurrentRestaurantId(){return i(this,null,function*(){let e=this.authService.getCurrentStaffRestaurantId();if(e)return e;let r=this.authService.currentUserValue;if(!r)return null;let{data:t}=yield this.supabaseService.getSupabaseClient().from("restaurants").select("id").eq("owner_id",r.id).limit(1).single();return t?.id||null})}static \u0275fac=function(r){return new(r||s)};static \u0275prov=p({token:s,factory:s.\u0275fac,providedIn:"root"})};export{f as a};
