import{a as F}from"./chunk-NUBJZEUZ.js";import{c as ve}from"./chunk-UGJ6CWPF.js";import{a as ue}from"./chunk-5VB7O5BW.js";import{a as E}from"./chunk-ET44XX2C.js";import"./chunk-AMYEPXIV.js";import"./chunk-SY2ZWW6D.js";import{Ab as ge}from"./chunk-N3VPFYDE.js";import{A as _e,b as oe,d as ce,i as le,s as de,t as pe,u as me}from"./chunk-45CSFDAZ.js";import{b as ae,d as se}from"./chunk-TB7INTC7.js";import"./chunk-Q3EITIAW.js";import"./chunk-RC3HHTXM.js";import{j as Z,k as ee,l as te,p as ie,s as ne,v as re}from"./chunk-MPTEMNWF.js";import{G as L,Hb as V,I as j,Ib as s,J as q,Jb as b,Kb as y,La as l,Lb as D,Ob as P,Pb as K,Qb as M,Va as W,Vb as w,Wb as I,Xb as J,Y as R,Zb as B,_a as g,a as N,ca as S,dc as X,g as k,gb as m,hb as H,kb as z,la as f,ma as x,qb as r,rb as n,s as T,sb as U,t as $,tb as Q,ub as Y,vb as C,yb as h,zb as d}from"./chunk-5BU4UD4M.js";import{g as u}from"./chunk-RA2WU32H.js";var G=class o{supabase=S(ae).getSupabaseClient();authService=S(se);orderHelper=S(ve);orderState=S(F);dishService=S(E);dishCache=new Map;dishesLoaded=!1;lastLoadTime=0;CACHE_TTL=3e4;statusFilter=new k("all");searchTerm=new k("");floorPlanFilter=new k("all");rawGroups=new k([]);filteredGroups$=$([this.rawGroups.asObservable(),this.statusFilter.asObservable(),this.searchTerm.asObservable().pipe(L(300)),this.floorPlanFilter.asObservable()]).pipe(T(([t,e,i,a])=>this.filterGroups(t,e,i,a)),q());stats$=this.filteredGroups$.pipe(T(t=>this.calculateStats(t)));constructor(){console.log("\u{1F3C1} [KitchenService] Inizializzazione"),this.initializeService()}setFloorPlanFilter(t){this.floorPlanFilter.next(t)}loadFloorPlans(){return u(this,null,function*(){try{let t=yield this.authService.getCurrentRestaurantId();if(!t)return[];let{data:e,error:i}=yield this.supabase.from("restaurant_floor_plans").select("id, name").eq("restaurant_id",t).eq("is_active",!0).order("name",{ascending:!0});return i?(console.error("Errore caricamento mappe:",i),[]):e||[]}catch(t){return console.error("Errore caricamento mappe:",t),[]}})}getFloorPlanForTable(t){return u(this,null,function*(){try{let{data:e,error:i}=yield this.supabase.from("tables").select(`
          restaurant_floor_plans!inner (
            id,
            name
          )
        `).eq("id",t).single();if(i)throw i;return e.restaurant_floor_plans&&Array.isArray(e.restaurant_floor_plans)?e.restaurant_floor_plans[0]:null}catch(e){return console.error("Errore recupero mappa per tavolo:",e),null}})}forceRefresh(){return u(this,null,function*(){console.log("\u{1F504} [KitchenService] Forzatura refresh dati"),yield this.loadKitchenData(!0)})}setStatusFilter(t){this.statusFilter.next(t)}setSearchTerm(t){this.searchTerm.next(t)}updateItemStatus(t,e){return u(this,null,function*(){return yield this.orderState.updateItemStatus(t,e)})}updateComandaStatus(t,e){return u(this,null,function*(){let i=yield this.orderState.updateComandaStatus(t,e);return i&&["preparing","ready","served","cancelled"].includes(e)&&(yield this.orderState.updateAllItemsInComanda(t,e)),i})}markAllItemsInComandaAsReady(t){return u(this,null,function*(){return yield this.orderState.updateAllItemsInComanda(t,"ready")})}markAllItemsInGroupAsReady(t){return u(this,null,function*(){let e=t.comande.map(i=>this.markAllItemsInComandaAsReady(i.id));return yield Promise.all(e),!0})}calculateElapsedTime(t){if(!t)return 0;try{let e=new Date(t);return Math.max(0,Math.floor((new Date().getTime()-e.getTime())/(1e3*60)))}catch{return 0}}formatTime(t){return t?new Date(t).toLocaleTimeString("it-IT",{hour:"2-digit",minute:"2-digit"}):""}loadInitialData(){return u(this,null,function*(){try{yield this.loadKitchenData()}catch(t){console.error("Errore caricamento iniziale dati cucina:",t)}})}calculateGroupStatusSummary(t){let e={waiting:0,preparing:0,ready:0,served:0,ordered:0,cancelled:0,out_of_stock:0};return t.forEach(i=>{i.items.forEach(a=>{switch(a.status){case"waiting":e.waiting++;break;case"preparing":e.preparing++;break;case"ready":e.ready++;break;case"served":e.served++;break;case"ordered":e.ordered++;break;case"cancelled":e.cancelled++;break;case"out_of_stock":e.out_of_stock++;break;default:e.ordered++;break}})}),e}filterGroups(t,e,i,a){let c=t;if(e!=="all"&&(c=c.filter(p=>p.comande.some(_=>_.items.some(v=>v.status===e)))),i.trim()){let p=i.toLowerCase();c=c.filter(_=>_.table_name.toLowerCase().includes(p)||_.customer_name.toLowerCase().includes(p)||_.comande.some(v=>v.items.some(O=>O.dish_name.toLowerCase().includes(p))))}return a!=="all"&&(c=c.filter(p=>p.floor_plan_id===a)),c}calculateStats(t){let e={waiting:0,preparing:0,ready:0,totalGroups:t.length,totalItems:0};return t.forEach(i=>{i.comande.forEach(a=>{a.items.forEach(c=>{e.totalItems++,c.status==="waiting"&&e.waiting++,c.status==="preparing"&&e.preparing++,c.status==="ready"&&e.ready++})})}),e}initializeService(){return u(this,null,function*(){try{console.log("\u{1F527} [KitchenService] Inizializzazione servizio"),yield this.loadDishes(),yield this.loadKitchenData()}catch(t){console.error("\u274C [KitchenService] Errore inizializzazione:",t)}})}loadDishes(t=!1){return u(this,null,function*(){if(this.dishesLoaded&&!t){console.log("\u{1F35D} [KitchenService] Piatti gi\xE0 caricati, uso cache");return}try{console.log("\u{1F35D} [KitchenService] Caricamento piatti..."),yield this.dishService.loadData();let e=this.dishService.getDishes();if(e.length===0){console.warn("\u26A0\uFE0F [KitchenService] Nessun piatto caricato");return}this.updateDishCache(e),this.dishesLoaded=!0,console.log(`\u2705 [KitchenService] ${e.length} piatti caricati`)}catch(e){console.error("\u274C [KitchenService] Errore caricamento piatti:",e)}})}updateDishCache(t){if(this.dishCache.clear(),t.forEach(e=>{e&&e.id&&e.name&&this.dishCache.set(e.id,{name:e.name,preparation_time:e.preparation_time||15})}),console.log(`\u{1F4E6} [KitchenService] Cache piatti aggiornata: ${this.dishCache.size} piatti`),this.dishCache.size>0){let e=Array.from(this.dishCache.entries()).slice(0,5);console.log("\u{1F50D} [KitchenService] Primi 5 piatti in cache:",e)}}getDishInfo(t){if(!t)return console.warn("\u26A0\uFE0F [KitchenService] dishId \xE8 undefined o null"),{name:"Piatto sconosciuto",preparation_time:15};let e=this.dishCache.get(t);if(e)return e;try{let i=this.dishService.getDishById(t);if(i){let a={name:i.name||`Piatto #${t.substring(0,4)}`,preparation_time:i.preparation_time||15};return this.dishCache.set(t,a),console.log(`\u2705 [KitchenService] Piatto trovato: ${a.name} (${t})`),a}}catch(i){console.error(`\u274C [KitchenService] Errore recupero piatto ${t}:`,i)}return console.warn(`\u26A0\uFE0F [KitchenService] Piatto non trovato: ${t}`),{name:`Piatto #${t.substring(0,4)}`,preparation_time:15}}loadKitchenData(t=!1){return u(this,null,function*(){let e=Date.now();if(!t&&e-this.lastLoadTime<this.CACHE_TTL){console.log("\u23F3 [KitchenService] Dati ancora freschi, salto refresh");return}try{let i=yield this.authService.getCurrentRestaurantId();if(!i){console.error("\u274C [KitchenService] Nessun restaurant ID trovato"),this.rawGroups.next([]);return}console.log("\u{1F50D} [KitchenService] Caricamento ordini per restaurant:",i);let{data:a,error:c}=yield this.supabase.from("order_headers").select(`
        id,
        order_number,
        table_id,
        customer_name,
        created_at,
        tables:table_id (
          table_number,
          table_name,
          floor_plan_id,
          restaurant_floor_plans (id, name)
        ),
        comande:comande!order_header_id (
          id,
          comanda_number,
          status,
          created_at,
          order_items (
            id,
            dish_id,
            quantity,
            status,
            item_notes,
            created_at
          )
        )
      `).eq("restaurant_id",i).in("status",["active","open","pending"]).order("created_at",{ascending:!0});if(c)throw c;let p=this.transformData(a||[]);this.rawGroups.next(p),this.lastLoadTime=e}catch(i){console.error("\u274C [KitchenService] Errore caricamento dati cucina:",i),this.rawGroups.next([])}})}transformData(t){return console.log("\u{1F504} [KitchenService] Trasformazione dati..."),t.map(e=>{let i="no-floor-plan",a="Senza mappa";if(e.tables){let _=Array.isArray(e.tables)?e.tables[0]:e.tables;_?.floor_plan_id&&(i=_.floor_plan_id,_.restaurant_floor_plans?a=(Array.isArray(_.restaurant_floor_plans)?_.restaurant_floor_plans[0]:_.restaurant_floor_plans)?.name||`Mappa ${i.substring(0,4)}...`:a=`Mappa ${i.substring(0,4)}...`)}let c=this.transformComande(e.comande||[],e),p=this.calculateGroupStatusSummary(c);return{order_header_id:e.id,order_number:e.order_number,table_number:e.tables?.table_number?.toString()||e.table_id,table_name:e.tables?.table_name||`Tavolo ${e.table_id}`,created_at:e.created_at,customer_name:e.customer_name||"Cliente",floor_plan_id:i,floor_plan_name:a,table_id:e.table_id,comande:c,status_summary:p}})}transformComande(t,e){return t.map(i=>{console.log(`\u{1F4DD} [KitchenService] Trasformazione comanda ${i.id}`);let a=(i.order_items||[]).map(v=>{console.log(`\u{1F50D} [KitchenService] Item ${v.id}: dish_id = ${v.dish_id}`);let O=this.getDishInfo(v.dish_id);return{id:v.id,dish_id:v.dish_id,dish_name:O.name,quantity:v.quantity,status:v.status||"ordered",notes:v.item_notes||"",special_requests:v.item_notes||"",created_at:v.created_at,preparation_time:O.preparation_time,table_number:e.tables?.table_number||"N/A"}}),c=a.length,p=a.filter(v=>["ready","served","cancelled","out_of_stock"].includes(v.status)).length,_=c>0?Math.round(p/c*100):0;return{id:i.id,comanda_number:i.comanda_number||1,status:i.status||"ordered",created_at:i.created_at,items:a,completed_items:p,total_items:c,progress_percentage:_}})}static \u0275fac=function(e){return new(e||o)};static \u0275prov=R({token:o,factory:o.\u0275fac,providedIn:"root"})};var A=class o{dishService=S(E);ingredientService=S(ue);getRecipeDetails(t){let e=this.getDishById(t);if(!e)return{ingredients:[],instructions:"Ricetta non disponibile",preparationTime:15};let i=this.transformIngredientsForDisplay(e.ingredients_composition||[]);return{dishName:e.name,ingredients:i,instructions:e.recipe_instructions||"Nessuna istruzione di preparazione disponibile",preparationTime:e.preparation_time||15}}getDishById(t){let e=this.dishService.getDishes();if(!e||!Array.isArray(e))return console.warn("\u26A0\uFE0F [RecipeService] Nessun piatto disponibile"),null;let i=e.find(a=>a.id===t);return i||(console.warn(`\u26A0\uFE0F [RecipeService] Piatto con ID ${t} non trovato`),null)}getRecipeDetails$(t){return $([this.dishService.data$,this.ingredientService.data$]).pipe(T(([e,i])=>{let a=e.find(p=>p.id===t);if(!a)return{ingredients:[],instructions:"Ricetta non disponibile",preparationTime:15};let c=(a.ingredients_composition||[]).map(p=>{let _=i.find(v=>v.id===p.ingredient_id);return{id:p.ingredient_id,name:_?.name||"Ingrediente sconosciuto",quantity:p.quantity||0,unit:p.unit_symbol||_?.units?.symbol||"pz",notes:p.recipe_notes||"",cost:p.cost||0,description:_?.description}});return{dishName:a.name,ingredients:c,instructions:a.recipe_instructions||"Nessuna istruzione disponibile",preparationTime:a.preparation_time||15}}))}transformIngredientsForDisplay(t){if(!t||!Array.isArray(t))return console.warn("\u26A0\uFE0F [RecipeService] Composition non valida:",t),[];let e=this.ingredientService.getIngredients();return t.map(i=>{let a="Ingrediente sconosciuto",c="pz";if(i.ingredient_id&&e){let p=e.find(_=>_.id===i.ingredient_id);p&&(a=p.name,p.units?.symbol&&(c=p.units.symbol))}return{id:i.ingredient_id,name:i.ingredient_name||a,quantity:i.quantity||0,unit:i.unit_symbol||c,notes:i.recipe_notes||"",cost:i.cost||0}})}calculateRecipeCost(t){let e=this.getDishById(t);return!e||!e.ingredients_composition?0:e.ingredients_composition.reduce((i,a)=>i+(a.cost||0),0)}getPreparationTime(t){return this.getDishById(t)?.preparation_time||15}static \u0275fac=function(e){return new(e||o)};static \u0275prov=R({token:o,factory:o.\u0275fac,providedIn:"root"})};function xe(o,t){if(o&1&&(r(0,"option",29),s(1),n()),o&2){let e=t.$implicit;m("value",e.id),l(),y(" ",e.name," ")}}function ye(o,t){o&1&&(r(0,"div",30)(1,"span",14),s(2,"restaurant_menu"),n(),r(3,"h3"),s(4,"Nessun ordine attivo"),n(),r(5,"p",31),s(6,"Tutti gli ordini sono stati completati"),n()())}function Se(o,t){if(o&1&&(r(0,"span",47),s(1),n()),o&2){let e=d().$implicit,i=d();l(),y(" \u23F3 ",i.getGroupStatusSummary(e).waiting," in attesa ")}}function be(o,t){if(o&1&&(r(0,"span",48),s(1),n()),o&2){let e=d().$implicit,i=d();l(),y(" \u{1F468}\u200D\u{1F373} ",i.getGroupStatusSummary(e).preparing," in preparazione ")}}function Ce(o,t){if(o&1&&(r(0,"span",49),s(1),n()),o&2){let e=d().$implicit,i=d();l(),y(" \u2705 ",i.getGroupStatusSummary(e).ready," pronto ")}}function we(o,t){if(o&1){let e=C();r(0,"select",61),M("ngModelChange",function(a){f(e);let c=d().$implicit;return K(c.status,a)||(c.status=a),x(a)}),h("change",function(a){f(e);let c=d().$implicit,p=d(3);return x(p.updateComandaStatus(c,a))}),r(1,"option",62),s(2,"Ordinato"),n(),r(3,"option",17),s(4,"In Attesa"),n(),r(5,"option",18),s(6,"In Preparazione"),n(),r(7,"option",19),s(8,"Pronto"),n(),r(9,"option",63),s(10,"Cancellato"),n()()}if(o&2){let e=d().$implicit;P("ngModel",e.status)}}function Ie(o,t){if(o&1){let e=C();r(0,"button",86),h("click",function(){f(e);let a=d().$implicit,c=d(5);return x(c.forceOrderedToWaiting(a))}),r(1,"span",14),s(2,"play_arrow"),n(),s(3," Prendi in carico "),n()}}function Ee(o,t){if(o&1){let e=C();r(0,"button",24),h("click",function(){f(e);let a=d().$implicit,c=d(5);return x(c.startItemPreparation(a))}),r(1,"span",14),s(2,"kitchen"),n(),s(3," Inizia preparazione "),n()}}function ke(o,t){if(o&1){let e=C();r(0,"button",24),h("click",function(){f(e);let a=d().$implicit,c=d(5);return x(c.markItemAsReady(a))}),r(1,"span",14),s(2,"check_circle"),n(),s(3," Segnala pronto "),n()}}function Te(o,t){o&1&&(r(0,"div",87)(1,"span",88),s(2,"done_all"),n(),r(3,"span",31),s(4,"Pronto - in attesa della sala"),n()())}function De(o,t){if(o&1&&(r(0,"div",89)(1,"p",90),s(2),n()()),o&2){let e=d().$implicit;l(2),b(e.notes)}}function Pe(o,t){if(o&1&&(r(0,"option",29),s(1),n()),o&2){let e=d().$implicit,i=d(6);m("value",e),l(),y(" ",i.getStatusText(e)," ")}}function Ke(o,t){if(o&1&&(Q(0),g(1,Pe,2,2,"option",91),Y()),o&2){let e=t.$implicit,i=d().$implicit;l(),m("ngIf",e!==i.status)}}function Me(o,t){if(o&1){let e=C();r(0,"div",4)(1,"div",67)(2,"div",68)(3,"div",69)(4,"span",70),s(5),n(),r(6,"span",71),s(7),n()(),r(8,"div",72),g(9,Ie,4,0,"button",73)(10,Ee,4,0,"button",74)(11,ke,4,0,"button",74)(12,Te,5,0,"div",75),n()(),r(13,"div",76)(14,"span",77)(15,"span",14),s(16,"schedule"),n(),s(17),n()(),g(18,De,3,1,"div",78),r(19,"div",79)(20,"div",80)(21,"select",81),M("ngModelChange",function(a){let c=f(e).$implicit;return K(c.status,a)||(c.status=a),x(a)}),h("change",function(a){let c=f(e).$implicit,p=d(2).$implicit,_=d(3);return x(_.updateItemStatus(c,a,p.id))}),r(22,"option",82),s(23),n(),g(24,Ke,2,1,"ng-container",83),n(),r(25,"div",55)(26,"button",84),h("click",function(){let a=f(e).$implicit,c=d(5);return x(c.markItemAsOutOfStock(a))}),r(27,"span",14),s(28,"block"),n()(),r(29,"button",85),h("click",function(){let a=f(e).$implicit,c=d(5);return x(c.openRecipeModal(a))}),r(30,"span",14),s(31,"menu_book"),n()()()()()()()}if(o&2){let e=t.$implicit,i=d(5);z("status-"+e.status),l(5),y("",e.quantity,"\xD7"),l(2),b(i.getDishDisplayName(e)),l(2),m("ngIf",e.status==="ordered"),l(),m("ngIf",e.status==="waiting"),l(),m("ngIf",e.status==="preparing"),l(),m("ngIf",e.status==="ready"),l(2),m("ngClass","text-"+i.getTimerColor(e)),l(3),D(" ",i.getElapsedTimeCached(e),"/",e.preparation_time||15,"min "),l(),m("ngIf",e.notes),l(3),P("ngModel",e.status),l(),m("value",e.status),l(),y(" ",i.getStatusText(e.status)," "),l(),m("ngForOf",i.getAllowedStatusesForItem(e))}}function Oe(o,t){if(o&1){let e=C();r(0,"button",24),h("click",function(){f(e);let a=d(3).$implicit,c=d(3);return x(c.markAllItemsInComandaAsReady(a))}),r(1,"span",14),s(2,"done_all"),n(),s(3," Piatti Pronti "),n()}}function $e(o,t){if(o&1&&(r(0,"div",92),g(1,Oe,4,0,"button",74),n()),o&2){let e=t.$implicit;l(),m("ngIf",e.length>1)}}function Re(o,t){if(o&1&&(r(0,"div",50)(1,"div",64),g(2,Me,32,16,"div",65),n(),g(3,$e,2,1,"div",66),n()),o&2){let e=d().$implicit,i=d(3);l(2),m("ngForOf",e.items)("ngForTrackBy",i.trackByItem),l(),m("ngIf",e.items)}}function Fe(o,t){if(o&1){let e=C();r(0,"div",52)(1,"div",53),h("click",function(){let a=f(e).index,c=d(2).$implicit,p=d();return x(p.toggleComandaExpansion(c.order_header_id,a))}),r(2,"div",54)(3,"div",55)(4,"span",14),s(5),n(),r(6,"span",56),s(7),n()(),r(8,"div"),g(9,we,11,1,"select",57),n()(),r(10,"div",38)(11,"span",58),s(12),n(),r(13,"div",59),U(14,"div",60),n()()(),g(15,Re,4,3,"div",46),n()}if(o&2){let e=t.$implicit,i=t.index,a=d(2).$implicit,c=d();l(5),y(" ",c.isComandaExpanded(a.order_header_id,i)?"expand_less":"expand_more"," "),l(2),y("Comanda ",i+1,""),l(2),m("ngIf",c.isComandaEditableByKitchen(e)),l(3),D("",e.completed_items,"/",e.total_items,""),l(2),H("width",e.progress_percentage,"%")("background",c.getComandaStatusColor(e.status)==="warning"?"var(--warning)":c.getComandaStatusColor(e.status)==="primary"?"var(--primary)":c.getComandaStatusColor(e.status)==="success"?"var(--success)":"var(--secondary)"),l(),m("ngIf",c.isComandaExpanded(a.order_header_id,i))}}function Ge(o,t){if(o&1&&(r(0,"div",50),g(1,Fe,16,10,"div",51),n()),o&2){let e=d().$implicit,i=d();l(),m("ngForOf",e.comande)("ngForTrackBy",i.trackByComanda)}}function Ae(o,t){if(o&1){let e=C();r(0,"div",32)(1,"div",33),h("click",function(){let a=f(e).$implicit,c=d();return x(c.toggleGroupExpansion(a.order_header_id))}),r(2,"div",34)(3,"div",35)(4,"span",36),s(5,"table_restaurant"),n(),r(6,"h2",37),s(7),n()(),r(8,"div",38)(9,"span",39),s(10),n(),r(11,"span",40),s(12),n()()(),r(13,"div",41)(14,"span",42)(15,"span",14),s(16,"schedule"),n(),s(17),n(),r(18,"span",42)(19,"span",14),s(20,"list_alt"),n(),s(21),n(),g(22,Se,2,1,"span",43)(23,be,2,1,"span",44)(24,Ce,2,1,"span",45),n()(),g(25,Ge,2,2,"div",46),n()}if(o&2){let e=t.$implicit,i=d();l(7),y(" Tavolo ",e.table_number," "),l(2),z(i.getGroupStatusColor(e)),l(),y(" ",i.getGroupStatusText(e)," "),l(2),y(" ",i.isGroupExpanded(e.order_header_id)?"expand_less":"expand_more"," "),l(5),y(" ",i.formatTime(e.created_at)," "),l(4),D(" ",e.comande.length," ",e.comande.length===1?"comanda":"comande"," "),l(),m("ngIf",i.getGroupStatusSummary(e).waiting>0),l(),m("ngIf",i.getGroupStatusSummary(e).preparing>0),l(),m("ngIf",i.getGroupStatusSummary(e).ready>0),l(),m("ngIf",i.isGroupExpanded(e.order_header_id))}}function ze(o,t){if(o&1&&(r(0,"span",102),s(1),n()),o&2){let e=d(2);l(),y(" ",e.selectedRecipeItem.preparation_time," min ")}}function Ve(o,t){if(o&1&&(r(0,"div",71),s(1),w(2,"number"),n()),o&2){let e=d().$implicit;l(),y(" \u20AC",J(2,1,e.cost,"1.2-2")," ")}}function Be(o,t){if(o&1&&(r(0,"div",114)(1,"label",13)(2,"span",14),s(3,"notes"),n(),s(4," Note di preparazione: "),n(),r(5,"p",111),s(6),n()()),o&2){let e=d().$implicit;l(6),b(e.notes)}}function Ne(o,t){if(o&1&&(r(0,"div",4)(1,"div",109)(2,"div")(3,"strong",110),s(4),n(),r(5,"div",111),s(6),n()(),g(7,Ve,3,4,"div",112),n(),g(8,Be,7,1,"div",113),n()),o&2){let e=t.$implicit;l(4),b(e.name||"Ingrediente"),l(2),D(" ",e.quantity||0," ",e.unit||""," "),l(),m("ngIf",e.cost>0),l(),m("ngIf",e.notes)}}function Le(o,t){if(o&1&&(r(0,"div",64),g(1,Ne,9,5,"div",108),n()),o&2){let e=d(3);l(),m("ngForOf",e.getRecipeDetails().ingredients)}}function je(o,t){o&1&&(r(0,"div",115)(1,"span",116),s(2,"info"),n(),r(3,"p",31),s(4,"Nessun ingrediente definito per questo piatto"),n()())}function qe(o,t){if(o&1&&(r(0,"div",4)(1,"div",5)(2,"span",14),s(3,"menu_book"),n(),r(4,"h3",7),s(5,"Istruzioni di Preparazione"),n()(),r(6,"p",31),s(7),n()()),o&2){let e=d(3);l(7),b(e.getRecipeDetails().instructions)}}function We(o,t){o&1&&(r(0,"div",117)(1,"span",116),s(2,"info"),n(),r(3,"p",31),s(4,"Nessuna istruzione di preparazione disponibile"),n()())}function He(o,t){if(o&1&&(r(0,"div")(1,"div",103)(2,"div",5)(3,"span",14),s(4,"list_alt"),n(),r(5,"h3",7),s(6,"Ingredienti"),n(),r(7,"span",104),s(8),n()(),g(9,Le,2,1,"div",105)(10,je,5,0,"ng-template",null,1,B),n(),g(12,qe,8,1,"div",106)(13,We,5,0,"div",107),n()),o&2){let e=V(11),i=d(2);l(8),b(i.getRecipeDetails().ingredients.length||0),l(),m("ngIf",i.getRecipeDetails().ingredients&&i.getRecipeDetails().ingredients.length>0)("ngIfElse",e),l(3),m("ngIf",i.getRecipeDetails().instructions),l(),m("ngIf",!i.getRecipeDetails().instructions)}}function Ue(o,t){o&1&&(r(0,"div",118)(1,"span",116),s(2,"info"),n(),r(3,"p",31),s(4,"Nessuna ricetta disponibile per questo piatto"),n()())}function Qe(o,t){if(o&1){let e=C();r(0,"div",93),h("click",function(){f(e);let a=d();return x(a.closeRecipeModal())}),r(1,"div",94),h("click",function(a){return f(e),x(a.stopPropagation())}),r(2,"div",95)(3,"h2",96)(4,"span",14),s(5,"menu_book"),n(),s(6),g(7,ze,2,1,"span",97),n(),r(8,"button",98),h("click",function(){f(e);let a=d();return x(a.closeRecipeModal())}),r(9,"span",14),s(10,"close"),n()()(),r(11,"div",99),g(12,He,14,5,"div",100)(13,Ue,5,0,"ng-template",null,0,B),n(),r(15,"div",101)(16,"button",24),h("click",function(){f(e);let a=d();return x(a.closeRecipeModal())}),r(17,"span",14),s(18,"close"),n(),s(19," Chiudi "),n()()()()}if(o&2){let e=V(14),i=d();l(6),y(" Ricetta - ",i.selectedRecipeItem==null?null:i.selectedRecipeItem.dish_name," "),l(),m("ngIf",i.selectedRecipeItem),l(5),m("ngIf",i.selectedRecipeItem)("ngIfElse",e)}}var fe=class o{kitchenService=S(G);orderStatusService=S(F);recipeService=S(A);cdr=S(X);dishService=S(E);dishNameCache=new Map;allowedStatusesCache=new Map;elapsedTimeCache=new Map;lastCacheUpdate=new Map;CACHE_TTL=3e4;floorPlans=[];selectedFloorPlanId="all";recipeDetails$;statusFilter="all";searchTerm="";filteredGroups$=this.kitchenService.filteredGroups$;stats$=this.kitchenService.stats$;showRecipeModal=!1;selectedRecipeItem=null;expandedGroups={};expandedComande={};subscriptions=new N;ngOnInit(){return u(this,null,function*(){console.log("\u{1F3C1} KitchenDisplay initialized"),yield this.loadFloorPlans(),yield this.forceRefresh(),this.filteredGroups$.pipe(j(1)).subscribe(t=>{t.forEach(e=>{this.expandedGroups[e.order_header_id]=!0,e.comande?.forEach((i,a)=>{let c=`${e.order_header_id}-${a}`;this.expandedComande[c]=!0})})})})}ngOnDestroy(){this.subscriptions.unsubscribe()}loadFloorPlans(){return u(this,null,function*(){try{this.floorPlans=yield this.kitchenService.loadFloorPlans()}catch(t){console.error("Errore caricamento mappe:",t)}})}onFloorPlanChange(){this.kitchenService.setFloorPlanFilter(this.selectedFloorPlanId)}startItemPreparation(t){return u(this,null,function*(){(yield this.orderStatusService.updateItemStatus(t.id,"preparing"))?yield this.forceRefresh():alert("Errore")})}markItemAsReady(t){return u(this,null,function*(){(yield this.orderStatusService.updateItemStatus(t.id,"ready"))?yield this.forceRefresh():alert("Errore")})}markItemAsOutOfStock(t){return u(this,null,function*(){(yield this.orderStatusService.updateItemStatus(t.id,"out_of_stock"))?yield this.forceRefresh():alert("Errore")})}updateItemStatus(t,e,i){return u(this,null,function*(){let a=e.target,c=a.value;this.orderStatusService.canTransitionItem(t.status,c,"kitchen")?(yield this.orderStatusService.updateItemStatus(t.id,c,i))?(console.log(`\u2705 Item ${t.id} aggiornato`),yield this.forceRefresh()):(console.error(`\u274C Errore aggiornamento item ${t.id}`),a.value=t.status):(console.warn(`\u26D4 Transizione non consentita: ${t.status} \u2192 ${c}`),a.value=t.status,alert("Transizione non consentita!"))})}updateComandaStatus(t,e){return u(this,null,function*(){let i=e.target,a=i.value;(yield this.orderStatusService.updateComandaStatus(t.id,a))?yield this.forceRefresh():i.value=t.status})}markAllItemsInComandaAsReady(t){return u(this,null,function*(){(yield this.kitchenService.markAllItemsInComandaAsReady(t))?yield this.forceRefresh():alert("Errore")})}toggleGroupExpansion(t){this.expandedGroups[t]=!this.expandedGroups[t]}toggleComandaExpansion(t,e){let i=`${t}-${e}`;this.expandedComande[i]=!this.expandedComande[i]}isGroupExpanded(t){return this.expandedGroups[t]!==!1}isComandaExpanded(t,e){let i=`${t}-${e}`;return this.expandedComande[i]!==!1}onStatusFilterChange(t){this.statusFilter=t,this.kitchenService.setStatusFilter(t)}onSearchChange(){this.kitchenService.setSearchTerm(this.searchTerm)}getStatusText(t){return{ordered:"Ordinato",waiting:"In Attesa",preparing:"In Preparazione",ready:"Pronto",served:"Servito",cancelled:"Cancellato",out_of_stock:"Esaurito"}[t]||t}getStatusShortText(t){return{ordered:"Ordinato",waiting:"Attesa",preparing:"Prep.",ready:"Pronto",served:"Servito",out_of_stock:"Esaurito"}[t]||t}getStatusColor(t){return{waiting:"warning",preparing:"primary",ready:"success",served:"secondary",ordered:"info",cancelled:"danger",out_of_stock:"dark"}[t]||"secondary"}getGroupStatusColor(t){return this.getGroupStatusSummary(t).waiting>0?"warning":this.getGroupStatusSummary(t).preparing>0?"primary":this.getGroupStatusSummary(t).ready>0?"success":"secondary"}getGroupStatusText(t){let e=this.getGroupStatusSummary(t);return e.waiting>0?"In Attesa":e.preparing>0?"In Preparazione":e.ready>0?"Pronto":"Servito"}getComandaStatusColor(t){return{ordered:"info",waiting:"warning",preparing:"primary",ready:"success",served:"secondary",cancelled:"danger"}[t]||"secondary"}formatTime(t){return this.kitchenService.formatTime(t)}getElapsedTimeCached(t){let e=Date.now(),i=t.id,a=this.lastCacheUpdate.get(i)||0,c=this.elapsedTimeCache.get(i);if(c!==void 0&&e-a<this.CACHE_TTL)return c;let p=this.kitchenService.calculateElapsedTime(t);return this.elapsedTimeCache.set(i,p),this.lastCacheUpdate.set(i,e),p}getTimerColor(t){let e=this.getElapsedTimeCached(t),i=t.preparation_time||15;if(i===0)return"secondary";let a=e/i*100;return a<50?"success":a<75?"warning":"danger"}getRemainingTime(t){let e=this.getElapsedTimeCached(t),i=t.preparation_time||15;return Math.max(0,i-e)}hasItemsInGroup(t){return t.comande.some(e=>e.items&&e.items.length>0)}getGroupStatusSummary(t){if(t.status_summary)return t.status_summary;let e={waiting:0,preparing:0,ready:0,served:0,ordered:0,cancelled:0,out_of_stock:0};return t.comande?.forEach(i=>{i.items?.forEach(a=>{let c=a.status||"ordered";e.hasOwnProperty(c)&&e[c]++})}),e}getComandaProgress(t){return{completed:t.completed_items||0,total:t.total_items||0,percentage:t.progress_percentage||0}}getRecipeDetails(){return this.selectedRecipeItem?this.recipeService.getRecipeDetails(this.selectedRecipeItem.dish_id):{ingredients:[],instructions:"Nessun piatto selezionato",preparationTime:15}}openRecipeModal(t){this.selectedRecipeItem=t,this.showRecipeModal=!0,this.recipeDetails$=this.recipeService.getRecipeDetails$(t.dish_id)}closeRecipeModal(){this.selectedRecipeItem=null,this.showRecipeModal=!1}getDishDisplayName(t){let e=this.dishService.getDishById(t.dish_id);return e&&e.name&&e.name!=="Piatto"?e.name:t.dish_name&&t.dish_name!=="Piatto"?t.dish_name:`Piatto #${t.dish_id?.substring(0,8)||"???"}`}getAllowedStatusesForItem(t){let e=`${t.status}_kitchen`;if(this.allowedStatusesCache.has(e))return this.allowedStatusesCache.get(e);let a=["waiting","preparing","ready","out_of_stock"].filter(c=>this.orderStatusService.canTransitionItem(t.status,c,"kitchen"));return this.allowedStatusesCache.set(e,a),a}isComandaEditableByKitchen(t){return["ordered","waiting","preparing","ready"].includes(t.status)}canTransitionTo(t,e){return this.orderStatusService.canTransitionItem(t.status,e,"kitchen")}forceOrderedToWaiting(t){return u(this,null,function*(){(yield this.orderStatusService.updateItemStatus(t.id,"waiting"))?yield this.forceRefresh():alert("Impossibile forzare lo stato")})}forceRefresh(){return u(this,null,function*(){yield this.kitchenService.forceRefresh()})}updateItemStatusQuick(t,e){return u(this,null,function*(){try{(yield this.orderStatusService.updateItemStatus(t.id,e))?yield this.forceRefresh():alert("Errore nel cambio stato")}catch(i){console.error("Errore:",i),alert("Errore nel cambio stato")}})}trackByGroup(t,e){return e?.order_header_id??t}trackByComanda(t,e){return e?.id??e?.comanda_number??t}trackByItem(t,e){return e?.id??t}static \u0275fac=function(e){return new(e||o)};static \u0275cmp=W({type:o,selectors:[["app-kitchen-display"]],decls:88,vars:24,consts:[["noRecipe",""],["noIngredients",""],[1,"page-container"],["data-tutorial","kitchen-cards",1,"grid-cards","p-sm"],[1,"card"],[1,"flex","items-center","gap-sm","mb-md"],[1,"material-icons","text-primary","text-md"],[1,"card-title"],[1,"text-md","font-bold","text-primary","justify-center","flex"],[1,"text-muted","card-footer"],["data-tutorial","kitchen-filters",1,"form-card","mt-lg"],[1,"form-row"],[1,"form-group"],[1,"standard-label"],[1,"material-icons"],[3,"change","value"],["value","all"],["value","waiting"],["value","preparing"],["value","ready"],[3,"ngModelChange","ngModel"],[3,"value",4,"ngFor","ngForOf"],["type","text","placeholder","Ordine, tavolo, piatto...",3,"ngModelChange","ngModel"],[1,"modal-footer","p-sm"],[1,"promethea-button",3,"click"],["data-tutorial","kitchen-orders",1,"mt-lg"],["class","empty-state",4,"ngIf"],["class","form-card border mt-lg",4,"ngFor","ngForOf","ngForTrackBy"],["class","modal-overlay",3,"click",4,"ngIf"],[3,"value"],[1,"empty-state"],[1,"text-muted"],[1,"form-card","border","mt-lg"],[1,"flex","flex-col","gap-sm",2,"cursor","pointer",3,"click"],[1,"flex","justify-between","items-center"],[1,"flex","gap-sm","items-center"],[1,"material-icons","text-lg"],[1,"text-md","m-0","flex","items-center","gap-sm"],[1,"flex","items-center","p-sm","gap-sm"],[1,"chip"],[1,"material-icons","text-md"],[1,"flex","flex-wrap","gap-sm","mt-sm"],[1,"chip","bg-smoke"],["class","chip warning",4,"ngIf"],["class","chip primary",4,"ngIf"],["class","chip success",4,"ngIf"],["class","mt-sm",4,"ngIf"],[1,"chip","warning"],[1,"chip","primary"],[1,"chip","success"],[1,"mt-sm"],["class","mb-lg",4,"ngFor","ngForOf","ngForTrackBy"],[1,"mb-lg"],[1,"flex","flex-col","p-sm","rounded","bg-smoke","cursor-pointer",3,"click"],[1,"flex","justify-between"],[1,"flex","gap-sm"],[1,"font-semibold","text-md"],["class","text-mini","style","min-width: 130px;",3,"ngModel","ngModelChange","change",4,"ngIf"],[1,"text-sm","font-semibold"],[2,"width","100px","height","8px","background","var(--smoke-1)","border-radius","4px","overflow","hidden"],[2,"height","100%","transition","width 0.3s ease"],[1,"text-mini",2,"min-width","130px",3,"ngModelChange","change","ngModel"],["value","ordered"],["value","cancelled"],[1,"grid-cards"],["class","card",3,"class",4,"ngFor","ngForOf","ngForTrackBy"],["class","flex justify-end mt-lg",4,"ngIf"],[1,"card-body"],[1,"flex","justify-between","flex-wrap"],[1,"flex","gap-sm","mb-sm"],[1,"font-bold","text-primary"],[1,"font-semibold"],[1,"flex","flex-wrap","gap-sm"],["class","promethea-button ghost",3,"click",4,"ngIf"],["class","promethea-button",3,"click",4,"ngIf"],["class","flex items-center gap-sm",4,"ngIf"],[1,"flex","items-center","gap-sm","flex-wrap"],[1,"text-mini",3,"ngClass"],["class","mt-sm p-xs rounded bg-smoke",4,"ngIf"],[1,"flex","flex-col","gap-md","mt-sm",2,"width","100%"],[1,"flex","justify-between","gap-sm",2,"width","100%"],[1,"text-mini",2,"min-width","140px",3,"ngModelChange","change","ngModel"],["selected","","disabled","",3,"value"],[4,"ngFor","ngForOf"],["title","Segnala esaurito",1,"icon-button",3,"click"],["title","Vedi ricetta",1,"icon-button",3,"click"],[1,"promethea-button","ghost",3,"click"],[1,"flex","items-center","gap-sm"],[1,"material-icons","text-success"],[1,"mt-sm","p-xs","rounded","bg-smoke"],[1,"text-muted","text-mini"],[3,"value",4,"ngIf"],[1,"flex","justify-end","mt-lg"],[1,"modal-overlay",3,"click"],[1,"modal-container","modal-lg",3,"click"],[1,"modal-header"],[1,"section-title","m-0"],["class","chip active ml-md",4,"ngIf"],["type","button",1,"icon-button",3,"click"],[1,"modal-content"],[4,"ngIf","ngIfElse"],[1,"modal-footer","w-100"],[1,"chip","active","ml-md"],[1,"card","mb-lg"],[1,"chip","active"],["class","grid-cards",4,"ngIf","ngIfElse"],["class","card",4,"ngIf"],["class","card text-center p-md",4,"ngIf"],["class","card",4,"ngFor","ngForOf"],[1,"flex","justify-between","items-start","mb-sm"],[1,"text-md"],[1,"text-muted","text-sm","mt-1"],["class","font-semibold",4,"ngIf"],["class","mt-lg",4,"ngIf"],[1,"mt-lg"],[1,"text-center","p-md"],[1,"material-icons","text-muted"],[1,"card","text-center","p-md"],[1,"card","text-center","p-xl"]],template:function(e,i){if(e&1&&(r(0,"div",2)(1,"div",3)(2,"div",4)(3,"div",5)(4,"span",6),s(5,"schedule"),n(),r(6,"h3",7),s(7,"In Attesa"),n()(),r(8,"div",8),s(9),w(10,"async"),n(),r(11,"span",9),s(12,"Piatti in attesa"),n()(),r(13,"div",4)(14,"div",5)(15,"span",6),s(16,"kitchen"),n(),r(17,"h3",7),s(18,"In Preparazione"),n()(),r(19,"div",8),s(20),w(21,"async"),n(),r(22,"span",9),s(23,"Piatti in preparazione"),n()(),r(24,"div",4)(25,"div",5)(26,"span",6),s(27,"done"),n(),r(28,"h3",7),s(29,"Pronti"),n()(),r(30,"div",8),s(31),w(32,"async"),n(),r(33,"span",9),s(34,"Piatti pronti"),n()(),r(35,"div",4)(36,"div",5)(37,"span",6),s(38,"list_alt"),n(),r(39,"h3",7),s(40,"Ordini Attivi"),n()(),r(41,"div",8),s(42),w(43,"async"),n(),r(44,"span",9),s(45,"Gruppi attivi"),n()()(),r(46,"div",10)(47,"div",11)(48,"div",12)(49,"label",13)(50,"span",14),s(51,"filter_list"),n(),s(52," Stato: "),n(),r(53,"select",15),h("change",function(c){return i.onStatusFilterChange(c.target.value)}),r(54,"option",16),s(55,"Tutti gli ordini"),n(),r(56,"option",17),s(57,"In Attesa"),n(),r(58,"option",18),s(59,"In Preparazione"),n(),r(60,"option",19),s(61,"Pronti"),n()()(),r(62,"div",12)(63,"label",13)(64,"span",14),s(65,"map"),n(),s(66," Mappa: "),n(),r(67,"select",20),M("ngModelChange",function(c){return K(i.selectedFloorPlanId,c)||(i.selectedFloorPlanId=c),c}),h("ngModelChange",function(){return i.onFloorPlanChange()}),r(68,"option",16),s(69,"Tutte le mappe"),n(),g(70,xe,2,2,"option",21),n()()(),r(71,"div",11)(72,"label",13)(73,"span",14),s(74,"search"),n(),s(75," Cerca: "),n(),r(76,"input",22),M("ngModelChange",function(c){return K(i.searchTerm,c)||(i.searchTerm=c),c}),h("ngModelChange",function(){return i.onSearchChange()}),n()()(),r(77,"div",23)(78,"button",24),h("click",function(){return i.forceRefresh()}),r(79,"span",14),s(80,"refresh"),n(),s(81," Aggiorna "),n()(),r(82,"div",25),g(83,ye,7,0,"div",26),w(84,"async"),g(85,Ae,26,12,"div",27),w(86,"async"),n()(),g(87,Qe,20,4,"div",28)),e&2){let a,c,p,_,v;l(9),b(((a=I(10,12,i.stats$))==null?null:a.waiting)||0),l(11),b(((c=I(21,14,i.stats$))==null?null:c.preparing)||0),l(11),b(((p=I(32,16,i.stats$))==null?null:p.ready)||0),l(11),b(((_=I(43,18,i.stats$))==null?null:_.totalGroups)||0),l(11),m("value",i.statusFilter),l(14),P("ngModel",i.selectedFloorPlanId),l(3),m("ngForOf",i.floorPlans),l(6),P("ngModel",i.searchTerm),l(7),m("ngIf",((v=I(84,20,i.filteredGroups$))==null?null:v.length)===0),l(2),m("ngForOf",I(86,22,i.filteredGroups$))("ngForTrackBy",i.trackByGroup),l(2),m("ngIf",i.showRecipeModal)}},dependencies:[re,Z,ee,te,ie,ne,_e,pe,me,oe,de,ce,le,ge],styles:[".order-card[_ngcontent-%COMP%]{transition:all .3s cubic-bezier(.2,.9,.2,1)}.order-card[_ngcontent-%COMP%]:hover{transform:translateY(-2px);box-shadow:0 8px 25px var(--shadow-2)}.order-progress[_ngcontent-%COMP%]{width:100%;display:flex;flex-direction:column;gap:var(--gap-sm)}.progress-fill[_ngcontent-%COMP%]{height:100%;border-radius:4px;transition:width .3s ease}.progress-fill.waiting-bg[_ngcontent-%COMP%]{background:var(--secondary)}.progress-fill.preparing-bg[_ngcontent-%COMP%]{background:var(--primary)}.progress-fill.ready-bg[_ngcontent-%COMP%]{background:#10b981}.item-info[_ngcontent-%COMP%]{flex:1;display:flex;flex-direction:column;gap:var(--gap-sm)}.item-name[_ngcontent-%COMP%]{font-size:var(--fs-md);line-height:1.2;font-weight:700}.item-header[_ngcontent-%COMP%]{display:flex;flex-direction:row;flex-wrap:nowrap;gap:var(--gap-sm);justify-content:space-between}.item-actions[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:var(--gap-sm);padding:var(--gap-sm);min-width:200px}.chip.waiting[_ngcontent-%COMP%]{background:color-mix(in srgb,var(--secondary) 20%,transparent);color:var(--secondary)}.chip.preparing[_ngcontent-%COMP%]{background:color-mix(in srgb,var(--primary) 20%,transparent);color:var(--primary)}.chip.ready[_ngcontent-%COMP%]{background:color-mix(in srgb,#10b981 20%,transparent);color:#10b981}.chip.served[_ngcontent-%COMP%]{background:color-mix(in srgb,#6b7280 20%,transparent);color:#6b7280}.chip.time-normal[_ngcontent-%COMP%]{background:var(--smoke-1)}.chip.time-warning[_ngcontent-%COMP%]{background:color-mix(in srgb,#f59e0b 20%,transparent);color:#f59e0b}.chip.time-critical[_ngcontent-%COMP%]{background:color-mix(in srgb,#ef4444 20%,transparent);color:#ef4444}.promethea-button.small[_ngcontent-%COMP%]{padding:var(--gap-sm) var(--gap-md);font-size:.875rem;min-height:36px}@media (max-width: 768px){.item-actions[_ngcontent-%COMP%]{align-items:stretch;min-width:auto}.item-actions[_ngcontent-%COMP%]   .flex[_ngcontent-%COMP%]{justify-content:space-between}.order-progress[_ngcontent-%COMP%]{min-width:auto}}.rotate-90[_ngcontent-%COMP%]{transform:rotate(90deg);transition:transform .3s ease}.order-progress[_ngcontent-%COMP%]{min-width:200px}.progress-bar[_ngcontent-%COMP%]{width:100%;height:8px;background:var(--smoke-1);border-radius:4px;overflow:hidden}.progress-fill[_ngcontent-%COMP%]{height:100%;transition:width .3s ease}.warning-bg[_ngcontent-%COMP%]{background:#ff9800}.primary-bg[_ngcontent-%COMP%]{background:#2196f3}.success-bg[_ngcontent-%COMP%]{background:#4caf50}.secondary-bg[_ngcontent-%COMP%]{background:#9c27b0}.card-body[_ngcontent-%COMP%]{justify-content:space-between;flex-wrap:wrap}.card[_ngcontent-%COMP%]{overflow:hidden}"]})};export{fe as KitchenDisplay};
