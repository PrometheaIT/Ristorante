import{a as Le}from"./chunk-RAFP4OT7.js";import{a as je}from"./chunk-LDOS2BDR.js";import{a as We}from"./chunk-IIRQPHPS.js";import{a as qe}from"./chunk-IUBNC3L3.js";import{a as Be}from"./chunk-XWK66B65.js";import{a as Ne}from"./chunk-E7B43P7T.js";import{b as re,d as ne,e as Re,g as Fe,h as ae,i as De,q as oe,r as le,s as se,v as He,x as de}from"./chunk-B4OL4BIV.js";import{a as ze}from"./chunk-24HI7PXV.js";import{a as Ae}from"./chunk-QWZIJWYH.js";import{a as q}from"./chunk-4RQOBPFF.js";import{a as ce}from"./chunk-TT5HVSFC.js";import{b as Ve}from"./chunk-OPNETFGM.js";import{b as ke}from"./chunk-L3BVOY7C.js";import{b as Te,c as ee,d as te,e as Ee,f as Oe,i as Me,j as Ie,l as Pe,m as ie}from"./chunk-JKK4MZBS.js";import{Cb as W,Db as L,Eb as H,Fa as Ce,Gb as K,Hb as o,I as we,Ib as I,Ja as s,Jb as h,Kb as V,Lb as j,Nb as C,Oa as ge,Ob as y,Pb as T,Qb as ye,Tb as A,Wb as M,Xb as fe,Yb as P,Za as J,Zb as X,_b as xe,a as Y,b as pe,ba as D,cb as f,ga as w,h as _,i as Se,kb as m,la as u,lb as r,ma as p,mb as a,nb as N,qb as ve,rb as he,sb as S,v as _e,va as z,vb as g,xb as c}from"./chunk-G3XPJWB3.js";var $=class l{supabaseService=w(ke);createForHeader(t,e){return _(this,null,function*(){try{let i=e||(yield this.getNextOrdineNumber(t)),{data:n,error:d}=yield this.supabaseService.getSupabaseClient().from("ordini").insert({order_header_id:t,ordine_number:i}).select().single();return d?(console.error("\u274C Errore creazione ordine:",d),null):n}catch(i){return console.error("\u274C Errore creazione ordine:",i),null}})}getNextOrdineNumber(t){return _(this,null,function*(){let{data:e,error:i}=yield this.supabaseService.getSupabaseClient().from("ordini").select("ordine_number").eq("order_header_id",t).order("ordine_number",{ascending:!1}).limit(1);return i?(console.error("Errore calcolo prossimo ordine:",i),1):e&&e.length>0?e[0].ordine_number+1:1})}loadByOrderHeaderId(t){return _(this,null,function*(){let{data:e,error:i}=yield this.supabaseService.getSupabaseClient().from("ordini").select("*").eq("order_header_id",t).order("ordine_number",{ascending:!0});return i?(console.error("Errore caricamento ordini:",i),[]):e||[]})}static \u0275fac=function(e){return new(e||l)};static \u0275prov=D({token:l,factory:l.\u0275fac,providedIn:"root"})};var Z=class l extends q{getTableName(){return"comande"}hasRestaurantId(){return!0}createForOrdine(t,e){return _(this,null,function*(){try{let i=yield this.getCurrentRestaurantId();if(!i)return console.error("\u274C Nessun restaurantId"),null;let{data:n,error:d}=yield this.supabaseService.getSupabaseClient().from("ordini").select(`
        *,
        order_header:order_header_id (
          id,
          table_id,
          tavolata_id,
          order_number,
          customer_name,
          customer_phone,
          restaurant_id
        )
      `).eq("id",t).single();if(d)throw d;let v=n.order_header;if(!v)throw new Error("Order header non trovato");let b=e||(yield this.getNextComandaNumber(t)),O={order_number:`CMD-${v.order_number}-${n.ordine_number}-${b}`,restaurant_id:i,ordine_id:t,tavolata_id:v.id,comanda_number:b,table_id:v.table_id,customer_name:v.customer_name||"Cliente",customer_phone:v.customer_phone||"",status:"ordered",subtotal:0,tax_amount:0,discount_amount:0,total_amount:0,customer_notes:"",order_type:"dine_in"},{data:E,error:R}=yield this.supabaseService.getSupabaseClient().from(this.getTableName()).insert(O).select().single();if(R)throw R;return E}catch(i){return console.error("\u{1F4A5} ERRORE createForOrdine:",i),null}})}getNextComandaNumber(t){return _(this,null,function*(){try{let{data:e,error:i}=yield this.supabaseService.getSupabaseClient().from(this.getTableName()).select("comanda_number").eq("ordine_id",t).order("comanda_number",{ascending:!1}).limit(1);if(i)throw i;return e&&e.length>0?e[0].comanda_number+1:1}catch(e){return console.error("Errore calcolo prossima comanda:",e),1}})}loadByOrdineId(t){return _(this,null,function*(){try{let{data:e,error:i}=yield this.supabaseService.getSupabaseClient().from(this.getTableName()).select("*").eq("ordine_id",t).order("comanda_number",{ascending:!0});if(i)throw i;return e||[]}catch(e){return console.error("Errore caricamento comande:",e),[]}})}updateStatus(t,e){return _(this,null,function*(){return yield this.update(t,{status:e,updated_at:new Date().toISOString()})})}updateTotalAmount(t,e){return _(this,null,function*(){return yield this.update(t,{total_amount:e,subtotal:e,updated_at:new Date().toISOString()})})}recalculateTotal(t){return _(this,null,function*(){try{let{data:e,error:i}=yield this.supabaseService.getSupabaseClient().from("order_items").select("total_price").eq("order_id",t);if(i)throw i;let n=(e||[]).reduce((d,v)=>d+(v.total_price||0),0);return yield this.updateTotalAmount(t,n),n}catch(e){return console.error("Errore ricalcolo totale:",e),0}})}static \u0275fac=(()=>{let t;return function(i){return(t||(t=z(l)))(i||l)}})();static \u0275prov=D({token:l,factory:l.\u0275fac,providedIn:"root"})};var G=class l extends q{getTableName(){return"order_items"}hasRestaurantId(){return!0}addItemToComanda(t,e,i=1,n,d=""){return _(this,null,function*(){try{console.log("\u{1F504} OrderItemService.addItemToComanda chiamato",{comandaId:t,dishId:e,quantity:i,unitPrice:n});let v=yield this.getCurrentRestaurantId();if(!v)return console.error("\u274C Nessun restaurantId"),null;let b=n*i,x={order_id:t,dish_id:e,quantity:i,unit_price:n,total_price:b,item_notes:d||"",status:"ordered",restaurant_id:v};console.log("\u{1F4E4} Insert order item con dati:",x);let{data:O,error:E}=yield this.supabaseService.getSupabaseClient().from(this.getTableName()).insert(x).select().single();if(E)return console.error("\u274C ERRORE INSERT:",{message:E.message,details:E.details,hint:E.hint,code:E.code}),null;console.log("\u2705 Order item inserito:",O);let R=yield this.getDishName(e);return pe(Y({},O),{dish_name:R,comanda_id:O.order_id})}catch(v){return console.error("\u{1F4A5} Errore critico:",v),null}})}getDishName(t){return _(this,null,function*(){try{let{data:e,error:i}=yield this.supabaseService.getSupabaseClient().from("dishes").select("name").eq("id",t).single();return i||!e?(console.warn("\u26A0\uFE0F Impossibile recuperare nome piatto:",i),"Piatto"):e.name}catch(e){return console.error("Errore recupero nome piatto:",e),"Piatto"}})}loadByComandaId(t){return _(this,null,function*(){try{let{data:e,error:i}=yield this.supabaseService.getSupabaseClient().from("order_items").select(`
        *,
        dish:dish_id(name)
      `).eq("order_id",t).order("created_at",{ascending:!0});if(i)throw i;return(e||[]).map(n=>pe(Y({},n),{dish_name:n.dish?.name||"Piatto",comanda_id:n.order_id}))}catch(e){return console.error("Errore caricamento order_items:",e),[]}})}updateQuantity(t,e){return _(this,null,function*(){try{let{data:i,error:n}=yield this.supabaseService.getSupabaseClient().from(this.getTableName()).select("unit_price").eq("id",t).single();if(n)throw n;let d=i.unit_price*e,{error:v}=yield this.supabaseService.getSupabaseClient().from(this.getTableName()).update({quantity:e,total_price:d,updated_at:new Date().toISOString()}).eq("id",t);if(v)throw v;return!0}catch(i){return console.error("Errore aggiornamento quantit\xE0:",i),!1}})}delete(t){return _(this,null,function*(){try{let{error:e}=yield this.supabaseService.getSupabaseClient().from(this.getTableName()).delete().eq("id",t);if(e)throw e;let n=this.dataSubject.value.filter(d=>d.id!==t);return this.dataSubject.next(n),!0}catch(e){return console.error("Errore eliminazione order item:",e),this.errorSubject.next(e.message),!1}})}updateComandaTotal(t){return _(this,null,function*(){try{let{data:e,error:i}=yield this.supabaseService.getSupabaseClient().from(this.getTableName()).select("total_price").eq("order_id",t);if(i)throw i;let n=(e||[]).reduce((v,b)=>v+(b.total_price||0),0),{error:d}=yield this.supabaseService.getSupabaseClient().from("comande").update({total_amount:n,updated_at:new Date().toISOString()}).eq("id",t);if(d)throw d;return n}catch(e){return console.error("Errore aggiornamento totale comanda:",e),0}})}updateItemStatus(t,e){return _(this,null,function*(){try{let{error:i}=yield this.supabaseService.getSupabaseClient().from(this.getTableName()).update({status:e,updated_at:new Date().toISOString()}).eq("id",t);if(i)throw i;return!0}catch(i){return console.error("Errore aggiornamento stato item:",i),!1}})}updateAllItemsStatus(t,e){return _(this,null,function*(){try{let i=yield this.loadByComandaId(t),n=!0;for(let d of i)(yield this.updateItemStatus(d.id,e))||(n=!1);return n}catch(i){return console.error("Errore aggiornamento stati piatti:",i),!1}})}static \u0275fac=(()=>{let t;return function(i){return(t||(t=z(l)))(i||l)}})();static \u0275prov=D({token:l,factory:l.\u0275fac,providedIn:"root"})};var U=class l extends q{ordineService=w($);comandaService=w(Z);orderItemService=w(G);getTableName(){return"order_headers"}hasRestaurantId(){return!0}createForTable(t,e){return _(this,null,function*(){try{let i=yield this.getCurrentRestaurantId();if(!i)return null;let n=yield this.generateOrderNumber(i),d={restaurant_id:i,table_id:t,order_number:n,status:"active",customer_name:e||"Cliente",total_amount:0};return console.log("\u{1F4E4} Creazione OrderHeader:",d),yield this.create(d)}catch(i){return console.error("Errore creazione order header:",i),null}})}generateOrderNumber(t){return _(this,null,function*(){let e=new Date,i=e.getFullYear().toString().slice(-2),n=(e.getMonth()+1).toString().padStart(2,"0"),d=e.getDate().toString().padStart(2,"0");return`ORD-${i}${n}${d}-${Date.now().toString().slice(-4)}`})}loadWithDetails(t){return _(this,null,function*(){try{let e=yield this.getByIdAsync(t);if(!e)return null;let i=yield this.ordineService.loadByOrderHeaderId(t);for(let n of i){let d=yield this.comandaService.loadByOrdineId(n.id);for(let v of d){let b=yield this.orderItemService.loadByComandaId(v.id);v.order_items=b}n.comande=d}return e.ordini=i,e}catch(e){return console.error("Errore caricamento dettagli:",e),null}})}getByIdAsync(t){return _(this,null,function*(){try{let{data:e,error:i}=yield this.supabaseService.getSupabaseClient().from(this.getTableName()).select("*").eq("id",t).single();if(i)throw i;return e}catch(e){return console.error("Errore getById:",e),null}})}closeHeader(t){return _(this,null,function*(){return yield this.update(t,{status:"completed",updated_at:new Date().toISOString()})})}loadWithOrders(){return _(this,null,function*(){try{yield this.loadData();let t=this.data;for(let e of t){let i=yield this.loadWithDetails(e.id);i&&Object.assign(e,i)}this.dataSubject.next([...t])}catch(t){console.error("Errore loadWithOrders:",t)}})}getActiveOrderHeaderByTable(t){return _(this,null,function*(){try{let e=yield this.getCurrentRestaurantId();if(!e)return null;let{data:i,error:n}=yield this.supabaseService.getSupabaseClient().from("order_headers").select(`
        id,
        restaurant_id,
        table_id,
        order_number,
        status,
        customer_name,
        customer_phone,
        total_amount,
        created_at,
        updated_at
      `).eq("restaurant_id",e).eq("table_id",t).eq("status","active").order("created_at",{ascending:!1}).limit(1).single();return n?(n.code==="PGRST116"||console.error("\u274C Errore query order_headers:",n),null):i}catch(e){return console.error("\u274C Errore getActiveOrderHeaderByTable:",e),null}})}getTableOrderItemsCount(t){return _(this,null,function*(){try{let e=yield this.getCurrentRestaurantId();if(!e)return 0;let{data:i,error:n}=yield this.supabaseService.getSupabaseClient().from("order_items").select(`
        id,
        comanda:order_id!inner (
          ordine:ordine_id!inner (
            order_header:order_header_id!inner (
              id
            )
          )
        )
      `,{count:"exact",head:!0}).eq("comanda.ordine.order_header.restaurant_id",e).eq("comanda.ordine.order_header.table_id",t).eq("comanda.ordine.order_header.status","active");if(n)throw n;return i?.length||0}catch(e){return console.error("Error counting table orders:",e),0}})}static \u0275fac=(()=>{let t;return function(i){return(t||(t=z(l)))(i||l)}})();static \u0275prov=D({token:l,factory:l.\u0275fac,providedIn:"root"})};var me=class l extends q{getTableName(){return"tables"}calculateTableStatus(t){return _(this,null,function*(){try{console.log("\u{1F504} CALCOLO STATO TAVOLI - VERSIONE AGGIORNATA");let e=yield this.getCurrentRestaurantId();if(!e)return console.error("\u274C Restaurant ID non trovato"),[];if(!t||t.length===0)return[];let i=new Date().toISOString().split("T")[0],n=t.map(x=>x.id);console.log(`\u{1F4CA} Tavoli da analizzare: ${n.length}`,n);let d=[];try{if(n.length>0){let x=this.supabaseService.getSupabaseClient(),{data:O,error:E}=yield x.from("order_headers").select(`
              *,
              ordini (
                id,
                ordine_number,
                created_at
              )
            `).eq("restaurant_id",e).eq("status","active").in("table_id",n);E?console.error("\u274C Errore caricamento order headers:",E):(d=O||[],console.log(`\u2705 Order headers attivi trovati: ${d.length}`))}}catch(x){console.error("\u274C Errore nella query order headers:",x)}let v=[];try{let x=this.supabaseService.getSupabaseClient(),{data:O,error:E}=yield x.from("reservations").select("*").eq("restaurant_id",e).eq("reservation_date",i).in("status",["confirmed","pending"]).in("table_id",n);E?console.error("\u274C Errore caricamento prenotazioni:",E):(v=O||[],console.log(`\u2705 Prenotazioni oggi: ${v.length}`))}catch(x){console.error("\u274C Errore nella query prenotazioni:",x)}let b=[];for(let x of t)try{let O=d.filter(B=>B.table_id===x.id),E=v.filter(B=>B.table_id===x.id),R="free",k=null,F=[],be=null;O.length>0?(R="occupied",be=O[0]?.tavolata_id,O.forEach(B=>{B.ordini&&B.ordini.length>0&&(F=F.concat(B.ordini))}),console.log(`\u2705 Tavolo ${x.table_number} -> OCCUPATO (${O.length} order headers, ${F.length} ordini)`)):E.length>0?(R="reserved",k=E[0],console.log(`\u2705 Tavolo ${x.table_number} -> PRENOTATO`)):console.log(`\u2705 Tavolo ${x.table_number} -> LIBERO`),b.push({table:x,status:R,currentReservation:k,currentOrders:F,tavolataId:be})}catch(O){console.error(`\u274C Errore calcolo stato tavolo ${x.id}:`,O),b.push({table:x,status:"free",currentReservation:null,currentOrders:[],tavolataId:null})}return console.log("\u2705 STATO TAVOLI CALCOLATO:",{totali:b.length,liberi:b.filter(x=>x.status==="free").length,prenotati:b.filter(x=>x.status==="reserved").length,occupati:b.filter(x=>x.status==="occupied").length}),b}catch(e){return console.error("\u274C Errore generale nel calcolo stato tavoli:",e),[]}})}updateSingleTableStatus(t){return _(this,null,function*(){try{console.log(`\u{1F50D} Aggiornamento STATO REALE tavolo ${t}`);let e=yield this.getCurrentRestaurantId();if(!e)return console.error("\u274C Restaurant ID non trovato"),null;let i=this.supabaseService.getSupabaseClient(),{data:n,error:d}=yield i.from("tables").select("*").eq("id",t).single();if(d||!n)return console.error("\u274C Errore recupero tavolo:",d),null;console.log(`\u{1F4CB} Tavolo trovato: ${n.table_number}`);let v=[];try{let{data:k,error:F}=yield i.from("order_headers").select(`
            *,
            ordini (
              id,
              ordine_number,
              created_at
            )
          `).eq("restaurant_id",e).eq("table_id",t).eq("status","active");F?console.error("\u274C Errore query order headers:",F):(v=k||[],console.log(`\u2705 Order headers attivi per tavolo ${n.table_number}: ${v.length}`))}catch(k){console.error("\u274C Errore nella query order headers:",k)}let b="free",x=[],O=null,E=null;if(v&&v.length>0)b="occupied",O=v[0]?.tavolata_id,v.forEach(k=>{k.ordini&&k.ordini.length>0&&(x=x.concat(k.ordini))}),console.log(`\u2705 Tavolo ${n.table_number}: ${v.length} order headers attivi \u2192 OCCUPATO`);else try{let k=new Date().toISOString().split("T")[0],{data:F}=yield i.from("reservations").select("*").eq("restaurant_id",e).eq("table_id",t).eq("reservation_date",k).in("status",["confirmed","pending"]);F&&F.length>0?(b="reserved",E=F[0],console.log(`\u2705 Tavolo ${n.table_number}: prenotato \u2192 RISERVATO`)):console.log(`\u2705 Tavolo ${n.table_number}: libero`)}catch(k){console.error("\u274C Errore query prenotazioni:",k)}let R={table:n,status:b,currentReservation:E,currentOrders:x,tavolataId:O};return console.log(`\u{1F4CA} Stato calcolato per tavolo ${n.table_number}:`,R),R}catch(e){return console.error(`\u274C Errore aggiornamento stato tavolo ${t}:`,e),null}})}notifyTableStatusChanged(t){return _(this,null,function*(){try{let e=yield this.updateSingleTableStatus(t);e&&console.log(`\u{1F4E2} Notifica cambio stato tavolo ${t}:`,e.status)}catch(e){console.error("\u274C Errore notifica cambio stato:",e)}})}getTableStatusInRealTime(t){return _(this,null,function*(){try{return yield this.updateSingleTableStatus(t)}catch(e){return console.error("\u274C Errore recupero stato in tempo reale:",e),null}})}static \u0275fac=(()=>{let t;return function(i){return(t||(t=z(l)))(i||l)}})();static \u0275prov=D({token:l,factory:l.\u0275fac,providedIn:"root"})};var Je=()=>({id:"all",name:"\u{1F37D}\uFE0F Tutti i piatti"}),$e=()=>[];function Ke(l,t){if(l&1&&(r(0,"span",48),o(1),a()),l&2){let e=c(2);s(),h(" Comanda ",e.currentComanda.comanda_number," ")}}function Xe(l,t){if(l&1&&(r(0,"option",51),o(1),a()),l&2){let e=t.$implicit;m("ngValue",e),s(),V(" Ordine ",e.ordine_number," (",(e.comande==null?null:e.comande.length)||0," comande) ")}}function et(l,t){if(l&1){let e=S();r(0,"select",49),T("ngModelChange",function(n){u(e);let d=c(2);return y(d.currentOrdine,n)||(d.currentOrdine=n),p(n)}),g("ngModelChange",function(n){u(e);let d=c(2);return p(d.onOrdineChange(n))}),f(1,Xe,2,3,"option",50),a()}if(l&2){let e=c(2);C("ngModel",e.currentOrdine),s(),m("ngForOf",e.ordini)}}function tt(l,t){if(l&1&&(r(0,"option",51),o(1),a()),l&2){let e=t.$implicit;m("ngValue",e),s(),V(" Comanda ",e.comanda_number," (",(e.order_items==null?null:e.order_items.length)||0," piatti) ")}}function it(l,t){if(l&1){let e=S();r(0,"select",49),T("ngModelChange",function(n){u(e);let d=c(3);return y(d.currentComanda,n)||(d.currentComanda=n),p(n)}),g("ngModelChange",function(n){u(e);let d=c(3);return p(d.switchComanda(n.id))}),f(1,tt,2,3,"option",50),a()}if(l&2){let e=c(3);C("ngModel",e.currentComanda),s(),m("ngForOf",e.getComandeForDropdown())}}function rt(l,t){if(l&1&&(r(0,"div",41),o(1),a()),l&2){let e=c(3);s(),h(" Comanda ",e.getCurrentComande()[0].comanda_number," ")}}function nt(l,t){if(l&1&&(r(0,"div"),f(1,it,2,2,"select",15)(2,rt,2,1,"div",52),a()),l&2){let e=c(2);s(),m("ngIf",e.shouldShowComandaDropdown()),s(),m("ngIf",e.getCurrentComande().length===1)}}function at(l,t){l&1&&(r(0,"span",60),o(1," Menu Dedicato "),a())}function ot(l,t){l&1&&(r(0,"span"),o(1," Seleziona Menu "),a())}function lt(l,t){if(l&1&&(r(0,"div",61)(1,"div",14)(2,"span",62),o(3,"event_available"),a(),r(4,"span",63),o(5),a(),r(6,"span",64),o(7,"Dedicato"),a()()()),l&2){let e=c(3);s(5),I(e.dedicatedMenu.name)}}function st(l,t){l&1&&(r(0,"span",69)(1,"span",70),o(2,"star"),a(),o(3," Default "),a())}function dt(l,t){if(l&1&&(r(0,"div",66)(1,"div",67)(2,"div",14)(3,"span",8),o(4,"restaurant_menu"),a(),r(5,"span",63),o(6),a()(),f(7,st,4,0,"span",68),a()()),l&2){let e=c(4);s(6),I(e.globalMenus[0].name),s(),m("ngIf",e.globalMenus[0].is_default)}}function ct(l,t){if(l&1&&(r(0,"option",51),o(1),a()),l&2){let e=t.$implicit;m("ngValue",e),s(),V(" ",e.is_default?"\u2B50 ":"","",e.name," ")}}function mt(l,t){if(l&1){let e=S();r(0,"div")(1,"select",49),T("ngModelChange",function(n){u(e);let d=c(4);return y(d.selectedMenu,n)||(d.selectedMenu=n),p(n)}),g("ngModelChange",function(n){u(e);let d=c(4);return p(d.onMenuSelectChange(n))}),r(2,"option",51),o(3," \u{1F37D}\uFE0F Tutti i piatti "),a(),f(4,ct,2,3,"option",50),a()()}if(l&2){let e=c(4);s(),C("ngModel",e.selectedMenu),s(),m("ngValue",A(3,Je)),s(2),m("ngForOf",e.globalMenus)}}function ut(l,t){if(l&1&&(r(0,"div"),f(1,dt,8,2,"div",65)(2,mt,5,4,"div",16),a()),l&2){let e=c(3);s(),m("ngIf",e.globalMenus.length===1),s(),m("ngIf",e.globalMenus.length>1)}}function pt(l,t){l&1&&(r(0,"div",71)(1,"span",72),o(2,"restaurant_menu"),a(),r(3,"p",73),o(4,"Nessun menu disponibile"),a()())}function _t(l,t){l&1&&(r(0,"span",69)(1,"span",70),o(2,"star"),a(),o(3," Predefinito "),a())}function gt(l,t){l&1&&(r(0,"span",77)(1,"span",70),o(2,"event_available"),a(),o(3," Dedicato "),a())}function vt(l,t){if(l&1&&(r(0,"div",74)(1,"span",75),o(2),a(),f(3,_t,4,0,"span",68)(4,gt,4,0,"span",76),a()),l&2){let e=c(3);s(2),h("",e.dishes.length," piatti disponibili"),s(),m("ngIf",e.selectedMenu.is_default),s(),m("ngIf",e.selectedMenu.type==="dedicated")}}function ht(l,t){if(l&1&&(r(0,"div",53)(1,"div",54)(2,"label",55)(3,"span",8),o(4,"restaurant_menu"),a(),f(5,at,2,0,"span",56)(6,ot,2,0,"span",16),a(),f(7,lt,8,1,"div",57)(8,ut,3,2,"div",16)(9,pt,5,0,"div",58)(10,vt,5,3,"div",59),a()()),l&2){let e=c(2);s(5),m("ngIf",e.dedicatedMenu),s(),m("ngIf",!e.dedicatedMenu),s(),m("ngIf",e.dedicatedMenu),s(),m("ngIf",!e.dedicatedMenu&&e.globalMenus.length>0),s(),m("ngIf",!e.hasMenusToShow()),s(),m("ngIf",e.selectedMenu)}}function ft(l,t){if(l&1&&(r(0,"option",78),o(1),M(2,"slice"),a()),l&2){let e=t.$implicit;m("value",e.id),s(),V(" ",X(2,3,e.name,0,10),"",e.name.length>10?"...":""," ")}}function xt(l,t){if(l&1){let e=S();r(0,"div",32),g("click",function(){let n=u(e).$implicit,d=c(2);return p(d.selectedCategory=n.id)}),r(1,"span",8),o(2,"category"),a(),r(3,"span",33),o(4),M(5,"slice"),a(),r(6,"span",13),o(7),a()()}if(l&2){let e=t.$implicit,i=c(2);H("active",i.selectedCategory===e.id),s(4),V("",X(5,5,e.name,0,8),"",e.name.length>8?"...":""),s(3),I(i.getDishesCountByCategory(e.id))}}function bt(l,t){if(l&1&&(r(0,"small",13),o(1),M(2,"slice"),a()),l&2){let e=c().$implicit;s(),V(" ",X(2,2,e.description,0,40),"",e.description.length>40?"...":""," ")}}function St(l,t){if(l&1){let e=S();r(0,"div",86)(1,"div",35)(2,"div",87)(3,"strong",88),o(4),a(),r(5,"span",89),o(6),M(7,"number"),a(),f(8,bt,3,6,"small",90),a(),r(9,"div",91)(10,"button",92),g("click",function(){let n=u(e).$implicit,d=c(4);return p(d.addDishToOrder(n))}),r(11,"span",8),o(12,"add"),a()()()()()}if(l&2){let e=t.$implicit,i=c(4);s(4),I(e.name),s(2),h("\u20AC",P(7,4,e.base_price,"1.2-2")),s(2),m("ngIf",e.description),s(2),m("disabled",!i.orderingStatus.allowed)}}function wt(l,t){if(l&1&&(ve(0),r(1,"div",80)(2,"div",81)(3,"span",82),o(4,"category"),a(),o(5),a(),r(6,"div",83),o(7),a()(),r(8,"div",84),f(9,St,13,7,"div",85),a(),he()),l&2){let e=t.$implicit,i=c(3);s(5),h(" ",e.category.name," "),s(2),I(e.dishes.length),s(2),m("ngForOf",e.dishes)("ngForTrackBy",i.trackByDishId)}}function Ct(l,t){if(l&1&&(ve(0),f(1,wt,10,4,"ng-container",79),he()),l&2){let e=c(2);s(),m("ngForOf",e.getDishesGroupedByCategory())}}function yt(l,t){if(l&1){let e=S();r(0,"div",93)(1,"span",8),o(2,"search_off"),a(),r(3,"p",94),o(4,"Nessun piatto trovato"),a(),r(5,"button",95),g("click",function(){u(e);let n=c(2);return p(n.resetDishFilters())}),o(6," Reset filtri "),a()()}}function Tt(l,t){if(l&1&&(r(0,"option",51),o(1),a()),l&2){let e=t.$implicit;m("ngValue",e),s(),V(" Comanda ",e.comanda_number," (",(e.order_items==null?null:e.order_items.length)||0," piatti) ")}}function Et(l,t){if(l&1){let e=S();r(0,"div",96)(1,"select",25),T("ngModelChange",function(n){u(e);let d=c(2);return y(d.currentComanda,n)||(d.currentComanda=n),p(n)}),g("ngModelChange",function(n){u(e);let d=c(2);return p(d.switchComanda(n.id))}),f(2,Tt,2,3,"option",50),a()()}if(l&2){let e=c(2);s(),C("ngModel",e.currentComanda),s(),m("ngForOf",e.getComandeForDropdown())}}function Ot(l,t){if(l&1){let e=S();r(0,"div",103)(1,"div",104)(2,"div",9)(3,"strong"),o(4),a(),r(5,"div",12)(6,"span",13),o(7),M(8,"number"),a(),r(9,"span",13),o(10,"\u2022"),a(),r(11,"span",13),o(12),M(13,"number"),a()()(),r(14,"div",14)(15,"button",105),g("click",function(n){let d=u(e).$implicit;return c(3).updateQuantity(d,-1),p(n.stopPropagation())}),r(16,"span",8),o(17,"remove"),a()(),r(18,"span",106),o(19),a(),r(20,"button",107),g("click",function(n){let d=u(e).$implicit;return c(3).updateQuantity(d,1),p(n.stopPropagation())}),r(21,"span",8),o(22,"add"),a()(),r(23,"button",108),g("click",function(n){let d=u(e).$implicit;return c(3).removeItem(d),p(n.stopPropagation())}),r(24,"span",8),o(25,"delete"),a()()()()()}if(l&2){let e=t.$implicit,i=c(3);s(4),I(e.dish_name||"Piatto"),s(3),h("\u20AC",P(8,5,e.unit_price,"1.2-2")," cad."),s(5),h("Tot: \u20AC",P(13,8,e.unit_price*e.quantity,"1.2-2")),s(7),I(e.quantity),s(),m("disabled",!i.orderingStatus.allowed)}}function Mt(l,t){if(l&1&&(r(0,"div",38)(1,"span",13),o(2),a(),r(3,"strong",109),o(4),M(5,"number"),a()()),l&2){let e=c(3);s(2),h(" Totale generale (",e.ordini.length," comande): "),s(2),h(" \u20AC",P(5,2,e.calculateRealtimeTotal(),"1.2-2")," ")}}function It(l,t){if(l&1&&(r(0,"div"),f(1,Ot,26,11,"div",97),r(2,"div",98)(3,"div",99)(4,"strong",100),o(5,"Totale Comanda:"),a(),r(6,"strong",101),o(7),M(8,"number"),a()(),f(9,Mt,6,5,"div",102),a()()),l&2){let e=c(2);s(),m("ngForOf",e.getComandaItems()),s(6),h(" \u20AC",P(8,3,e.currentComanda==null?null:e.currentComanda.total_amount,"1.2-2")," "),s(2),m("ngIf",e.ordini.length>1)}}function Pt(l,t){l&1&&(r(0,"div",110)(1,"span",111),o(2,"restaurant_menu"),a(),r(3,"p",94),o(4,"Nessun piatto in questa comanda"),a(),r(5,"p",73),o(6,"Clicca sui piatti per aggiungerli"),a()())}function kt(l,t){if(l&1){let e=S();r(0,"div",3),g("click",function(){u(e);let n=c();return p(n.close())}),r(1,"div",4),g("click",function(n){return u(e),p(n.stopPropagation())}),r(2,"div",5)(3,"div",6)(4,"button",7),g("click",function(){u(e);let n=c();return p(n.close())}),r(5,"span",8),o(6,"arrow_back"),a()(),r(7,"div",9)(8,"h1",10),o(9),f(10,Ke,2,1,"span",11),a(),r(11,"div",12)(12,"span",13),o(13),M(14,"number"),a()()()(),r(15,"div",14),f(16,et,2,2,"select",15)(17,nt,3,2,"div",16),r(18,"button",17),g("click",function(){u(e);let n=c();return p(n.close())}),r(19,"span",8),o(20,"close"),a()()()(),r(21,"div",18),f(22,ht,11,6,"div",19),r(23,"div",20)(24,"div",21)(25,"div",22)(26,"input",23),T("ngModelChange",function(n){u(e);let d=c();return y(d.dishSearchTerm,n)||(d.dishSearchTerm=n),p(n)}),a()(),r(27,"div",24)(28,"select",25),T("ngModelChange",function(n){u(e);let d=c();return y(d.selectedCategory,n)||(d.selectedCategory=n),p(n)}),r(29,"option",26),o(30,"Tutte"),a(),f(31,ft,3,7,"option",27),M(32,"async"),a()(),r(33,"div",28)(34,"button",7),g("click",function(){u(e);let n=c();return p(n.resetDishFilters())}),r(35,"span",8),o(36,"refresh"),a()()()()(),r(37,"div",29)(38,"div",30)(39,"div",31)(40,"div",32),g("click",function(){u(e);let n=c();return p(n.selectedCategory="all")}),r(41,"span",8),o(42,"restaurant_menu"),a(),r(43,"span",33),o(44,"Tutti"),a(),r(45,"span",13),o(46),a()(),f(47,xt,8,9,"div",34),M(48,"async"),a(),r(49,"div",35),f(50,Ct,2,1,"ng-container",36)(51,yt,7,0,"ng-template",null,0,xe),a()(),r(53,"div",30)(54,"div",37)(55,"div",38)(56,"h3",39)(57,"span",40),o(58,"receipt"),a(),o(59),a(),r(60,"span",41),o(61),a()(),f(62,Et,3,2,"div",42),a(),r(63,"div",43),f(64,It,10,6,"div",36)(65,Pt,7,0,"ng-template",null,1,xe),a()()()(),r(67,"div",44)(68,"button",45),g("click",function(){u(e);let n=c();return p(n.close())}),r(69,"span",8),o(70,"close"),a(),o(71," Chiudi "),a(),r(72,"button",46),g("click",function(){u(e);let n=c();return p(n.createNewComanda())}),r(73,"span",8),o(74,"receipt"),a(),o(75,` Nuova Comanda
`),a(),r(76,"button",47),g("click",function(){u(e);let n=c();return p(n.saveOrder())}),r(77,"span",8),o(78,"save"),a(),o(79," Salva "),a()()()()}if(l&2){let e,i=W(52),n=W(66),d=c();s(),H("fullscreen-mobile",d.isMobile),s(8),h(" Tavolo ",d.table.table_number," "),s(),m("ngIf",d.currentComanda),s(3),j(" ",d.getComandaItems().length," piatto",d.getComandaItems().length!==1?"i":""," \u2022 \u20AC",P(14,30,d.calcolaTotaleTavolata(),"1.2-2")," "),s(3),m("ngIf",d.ordini.length>1),s(),m("ngIf",d.shouldShowComandaDropdown()),s(5),m("ngIf",d.hasMenusToShow()),s(4),C("ngModel",d.dishSearchTerm),s(2),C("ngModel",d.selectedCategory),s(3),m("ngForOf",fe(32,33,d.categories$)),s(6),H("mobile-vertical",d.isMobile),s(3),H("active",d.selectedCategory==="all"),s(6),I(d.getDishesCountByCategory("all")),s(),m("ngForOf",(e=fe(48,35,d.categories$))==null?null:e.slice(0,4)),s(3),m("ngIf",d.getDishesGroupedByCategory().length>0)("ngIfElse",i),s(9),h(" Comanda ",(d.currentComanda==null?null:d.currentComanda.comanda_number)||"1"," "),s(2),V(" ",d.getComandaItems().length," piatto",d.getComandaItems().length!==1?"i":""," "),s(),m("ngIf",d.shouldShowComandaDropdown()),s(2),m("ngIf",d.getComandaItems().length>0)("ngIfElse",n),s(8),m("disabled",!d.currentOrdine),s(4),m("disabled",!d.orderingStatus.allowed)("title",d.orderingStatus.allowed?"Salva ordine":d.orderingStatus.reason)}}function Vt(l,t){if(l&1){let e=S();r(0,"div",93)(1,"span",8),o(2,"receipt"),a(),r(3,"h3"),o(4,"Nessun ordine attivo"),a(),r(5,"p",94),o(6,"Non ci sono ordini per questo tavolo"),a(),r(7,"button",123),g("click",function(){u(e);let n=c(2);return p(n.switchToEditMode())}),r(8,"span",8),o(9,"add"),a(),o(10," Crea Primo Ordine "),a()()}}function Rt(l,t){if(l&1&&(r(0,"div",96)(1,"small",94),o(2),a()()),l&2){let e=c().$implicit;s(2),h("Note: ",e.item_notes)}}function Ft(l,t){if(l&1&&(r(0,"div",159)(1,"div",9)(2,"div",160)(3,"strong"),o(4),a(),f(5,Rt,3,1,"div",42),a(),r(6,"div",161)(7,"span"),o(8),M(9,"number"),a(),r(10,"span"),o(11,"\u2022"),a(),r(12,"span"),o(13),a()(),r(14,"span",162),o(15),a()(),r(16,"div",138)(17,"span",63),o(18),M(19,"number"),a(),r(20,"small",136),o(21,"Totale"),a()()()),l&2){let e=t.$implicit,i=c(9);s(4),I(i.getDishName(e)),s(),m("ngIf",e.item_notes),s(3),h("\u20AC",P(9,8,e.unit_price,"1.2-2")," cad."),s(5),h("Quantit\xE0: ",e.quantity),s(),L("background-color",i.getOrderStatusColor(e.status)),s(),h(" ",i.getOrderStatusText(e.status)," "),s(3),h("\u20AC",P(19,11,e.total_price,"1.2-2"))}}function Dt(l,t){if(l&1&&(r(0,"div",157),f(1,Ft,22,14,"div",158),a()),l&2){let e=c().$implicit;s(),m("ngForOf",e.order_items)}}function Ht(l,t){l&1&&(r(0,"div",163)(1,"span",8),o(2,"restaurant_menu"),a(),r(3,"p",94),o(4,"Nessun piatto in questa comanda"),a()())}function zt(l,t){if(l&1){let e=S();r(0,"div",150)(1,"div",151)(2,"div",14)(3,"div",133)(4,"div",14)(5,"h5",63),o(6),a(),r(7,"span",152),g("click",function(n){let d=u(e).$implicit,v=c(7);return p(v.handleStatusClick(d,n))}),o(8),a(),r(9,"button",153),g("click",function(n){let d=u(e).$implicit,v=c(7);return p(v.toggleCancelRestore(d,n))}),r(10,"span",8),o(11),a()()(),r(12,"div",146),o(13),a()()(),r(14,"div",137)(15,"span",154),o(16),M(17,"number"),a()()(),f(18,Dt,2,1,"div",155)(19,Ht,5,0,"div",156),a()}if(l&2){let e=t.$implicit,i=c(7);s(6),h("Comanda ",e.comanda_number),s(),L("background-color",i.getOrderStatusColor(e.status)),H("cursor-pointer",i.isStatusClickable(e.status))("opacity-50",!i.isStatusClickable(e.status)),m("title",ye(i.getStatusTitle(e.status))),s(),h(" ",i.getOrderStatusText(e.status)," "),s(),m("ngClass",e.status==="cancelled"?"success":"danger")("title",e.status==="cancelled"?"Ripristina comanda":"Cancella comanda"),s(2),h(" ",e.status==="cancelled"?"replay":"close"," "),s(2),V(" ",(e.order_items==null?null:e.order_items.length)||0," piatto",(e.order_items==null?null:e.order_items.length)!==1?"i":""," "),s(3),h(" \u20AC",P(17,18,i.getComandaTotal(e),"1.2-2")," "),s(2),m("ngIf",e.order_items&&e.order_items.length>0),s(),m("ngIf",!e.order_items||e.order_items.length===0)}}function qt(l,t){if(l&1&&(r(0,"div",148),f(1,zt,20,21,"div",149),a()),l&2){let e=c().$implicit;s(),m("ngForOf",e.comande||A(1,$e))}}function Bt(l,t){if(l&1){let e=S();r(0,"div",142)(1,"div",143),g("click",function(){let n=u(e).$implicit,d=c(5);return p(d.toggleOrderExpansion(n.id))}),r(2,"div",14)(3,"span",144),o(4),a(),r(5,"div",133)(6,"div",14)(7,"h4",63),o(8),a(),r(9,"span",145),o(10),a()(),r(11,"div",146),o(12),M(13,"number"),a()()()(),f(14,qt,2,2,"div",147),a()}if(l&2){let e=t.$implicit,i=c(5);s(4),h(" ",i.isOrderExpanded(e.id)?"expand_less":"expand_more"," "),s(4),h("Ordine ",e.ordine_number),s(2),V(" ",(e.comande==null?null:e.comande.length)||0," comanda",(e.comande==null?null:e.comande.length)!==1?"e":""," "),s(2),h(" Totale: \u20AC",P(13,6,i.calcolaTotaleOrdine(e),"1.2-2")," "),s(2),m("ngIf",i.isOrderExpanded(e.id))}}function Nt(l,t){if(l&1&&(r(0,"div",98),f(1,Bt,15,9,"div",140),r(2,"div",141)(3,"div",133)(4,"strong",100),o(5),a(),r(6,"small",94),o(7),a()(),r(8,"strong",101),o(9),M(10,"number"),a()()()),l&2){let e=c(),i=e.$implicit,n=e.index,d=c(3);s(),m("ngForOf",i.ordini||A(7,$e)),s(4),h("Totale Tavolata ",n+1),s(2),h("",(i.ordini==null?null:i.ordini.length)||0," ordini"),s(2),h(" \u20AC",P(10,4,d.calcolaTotaleOrderHeader(i),"1.2-2")," ")}}function At(l,t){if(l&1){let e=S();r(0,"div",130)(1,"div",131),g("click",function(){let n=u(e).$implicit,d=c(3);return p(d.toggleOrderHeaderExpansion(n.id))}),r(2,"div",132)(3,"div",133)(4,"div",134)(5,"h3",63),o(6),a(),r(7,"div",135),o(8),a()(),r(9,"div",136),o(10),M(11,"date"),a()()(),r(12,"div",137)(13,"div",138)(14,"span",83),o(15),M(16,"number"),a(),r(17,"span",13),o(18,"Totale tavolata"),a()()()(),f(19,Nt,11,8,"div",139),a()}if(l&2){let e=t.$implicit,i=t.index,n=c(3);s(6),h("Tavolata ",i+1),s(2),V(" ",(e.ordini==null?null:e.ordini.length)||0," ordine",(e.ordini==null?null:e.ordini.length)!==1?"i":""," "),s(2),h(" ",P(11,6,e.created_at,"dd/MM/yyyy HH:mm")," "),s(5),h(" \u20AC",P(16,9,n.calcolaTotaleOrderHeader(e),"1.2-2")," "),s(4),m("ngIf",n.orderHeadersExpanded[e.id])}}function Wt(l,t){if(l&1&&(r(0,"div",124),f(1,At,20,12,"div",125),r(2,"div",126)(3,"div",38)(4,"div")(5,"strong",127),o(6,"TOTALE TAVOLO"),a(),r(7,"p",128),o(8),a()(),r(9,"strong",129),o(10),M(11,"number"),a()()()()),l&2){let e=c(2);s(),m("ngForOf",e.orderHeaders),s(7),j(" ",e.orderHeaders.length," tavolata",e.orderHeaders.length!==1?"e":""," \u2022 ",e.getTotalComandeCount()," comande "),s(2),h(" \u20AC",P(11,5,e.calcolaTotaleTavolata(),"1.2-2")," ")}}function Lt(l,t){if(l&1){let e=S();r(0,"div",3),g("click",function(){u(e);let n=c();return p(n.close())}),r(1,"div",112),g("click",function(n){return u(e),p(n.stopPropagation())}),r(2,"div",113)(3,"div",14)(4,"div",114)(5,"span",8),o(6,"receipt_long"),a()(),r(7,"div")(8,"h1",115),o(9),a(),r(10,"div",12)(11,"span",41),o(12),a(),r(13,"span",75),o(14),M(15,"number"),a()()()(),r(16,"button",7),g("click",function(){u(e);let n=c();return p(n.close())}),r(17,"span",8),o(18,"close"),a()()(),r(19,"div",116),f(20,Vt,11,0,"div",117)(21,Wt,12,8,"div",118),r(22,"div",119)(23,"button",120),g("click",function(){u(e);let n=c();return p(n.generateBill())}),r(24,"span",8),o(25,"receipt"),a(),o(26),a(),r(27,"button",121),g("click",function(){u(e);let n=c();return p(n.switchToEditMode())}),r(28,"span",8),o(29,"add"),a(),o(30," Aggiungi Piatti "),a(),r(31,"button",122),g("click",function(){u(e);let n=c();return p(n.close())}),r(32,"span",8),o(33,"close"),a(),o(34," Chiudi "),a()()()()()}if(l&2){let e=c();s(),H("fullscreen-mobile",e.isMobile),s(8),h("Ordini Tavolo ",e.table.table_number||"N/A"),s(3),V(" ",e.orderHeaders.length||0," Ordine",e.orderHeaders.length!==1?"i":""," "),s(2),h(" Totale: \u20AC",P(15,10,e.calcolaTotaleTavolata(),"1.2-2")," "),s(6),m("ngIf",!e.orderHeaders||e.orderHeaders.length===0),s(),m("ngIf",e.orderHeaders&&e.orderHeaders.length>0),s(2),m("disabled",!e.isReadyForBill()),s(3),h(" ",e.isReadyForBill()?"STAMPA SCONTRINO":"Non pronto per conto"," ")}}function jt(l,t){if(l&1){let e=S();r(0,"div",3),g("click",function(){u(e);let n=c();return p(n.showBillPreviewModal=!1)}),r(1,"div",112),g("click",function(n){return u(e),p(n.stopPropagation())}),r(2,"div",113)(3,"h1",115),o(4,"Anteprima Scontrino"),a(),r(5,"button",7),g("click",function(){u(e);let n=c();return p(n.showBillPreviewModal=!1)}),r(6,"span",8),o(7,"close"),a()()(),N(8,"div",164),r(9,"div",165)(10,"button",122),g("click",function(){u(e);let n=c();return p(n.showBillPreviewModal=!1)}),o(11," Chiudi "),a(),r(12,"button",121),g("click",function(){u(e);let n=c();return p(n.printBill())}),r(13,"span",8),o(14,"print"),a(),o(15," Stampa "),a()()()()}if(l&2){let e=c();s(8),m("innerHTML",e.billPreviewHtml,Ce)}}var ue=class l{orderHeaderService=w(U);orderItemService=w(G);dishService=w(ze);loadingService=w(ce);comandaService=w(Z);ordineService=w($);categoryService=w(qe);menuService=w(We);table;mode="edit";existingOrderHeader;orderHeaders=[];currentTavolataId=null;orderingStatus={allowed:!0,reason:""};saved=new ge;closeRequested=new ge;orderHeader=null;currentComanda=null;dishes=[];searchTerm="";selectedCategory="all";isMobile=!1;hasUnsavedChanges=!1;isNewOrder=!1;activeMenus=[];selectedMenu={id:"all",name:"Tutti i piatti"};menuDishes=[];currentOrdine=null;ordini=[];orderHeadersExpanded={};ordersExpanded={};dishSearchTerm="";categories$=_e([]);dishesByCategory$=_e({});showMoveSelectForItem=null;showBillPreviewModal=!1;billPreviewHtml="";ngOnInit(){return _(this,null,function*(){console.log("\u{1F504} OrderEditor init - mode:",this.mode),this.dishes=this.dishService.getActiveDishes(),yield this.categoryService.loadData(),console.log("\u{1F4CA} Categorie caricate:",this.categoryService.getCategories().length),yield this.loadActiveMenus(),this.mode==="view"&&this.existingOrderHeader?yield this.loadOrderForView():this.mode==="edit"&&(yield this.setupForEdit())})}loadActiveMenus(){return _(this,null,function*(){try{if(console.log("\u{1F4CB} Caricamento menu attivi..."),yield this.menuService.loadMenus(),this.activeMenus=this.menuService.getCurrentMenus().filter(t=>t.is_active),console.log("\u2705 Menu attivi caricati:",this.activeMenus.length),this.activeMenus.length>0){let t=this.activeMenus.find(e=>e.is_default);t?this.selectedMenu=t:this.selectedMenu=this.activeMenus[0],yield this.loadDishesForSelectedMenu()}}catch(t){console.error("\u274C Errore caricamento menu:",t)}})}loadDishesForSelectedMenu(){return _(this,null,function*(){if(this.selectedMenu.id==="all")this.dishes=this.dishService.getActiveDishes(),this.menuDishes=[];else try{this.menuDishes=yield this.menuService.getDishesWithDetailsByMenu(this.selectedMenu.id),this.dishes=this.menuDishes.filter(t=>t.dish&&!t.dish.deleted_at).map(t=>t.dish),console.log(`\u2705 Caricati ${this.dishes.length} piatti per menu: ${this.selectedMenu.name}`)}catch(t){console.error("\u274C Errore caricamento piatti menu:",t),this.dishes=this.dishService.getActiveDishes()}})}loadOrderForView(){return _(this,null,function*(){if(this.existingOrderHeader)try{this.loadingService.start();let t=yield this.orderHeaderService.loadWithDetails(this.existingOrderHeader.id);if(t?.ordini&&t.ordini.length>0){this.orderHeader=t;for(let e of t.ordini)if(e.comande&&e.comande.length>0){let i=e.comande.find(n=>n.status!=="cancelled");if(i){this.currentComanda=i;break}}}}catch(t){console.error("\u274C Errore caricamento ordine:",t)}finally{this.loadingService.stop()}})}setupForEdit(){return _(this,null,function*(){try{this.loadingService.start(),this.existingOrderHeader?yield this.loadOrderForEdit(this.existingOrderHeader.id):yield this.createNewOrder(),yield this.debugErrors(),this.currentComanda||(yield this.ensureActiveComanda())}catch(t){console.error("\u274C Errore setup edit:",t)}finally{this.loadingService.stop()}})}ensureActiveComanda(){return _(this,null,function*(){if(!this.currentComanda){if(this.orderHeader?.ordini?.length)for(let t of this.orderHeader.ordini){let e=t.comande?.find(i=>i.status!=="cancelled");if(e){this.currentComanda=e,this.currentOrdine=t;return}}if(this.orderHeader){let t=yield this.ordineService.createForHeader(this.orderHeader.id);t&&(this.currentOrdine=t,this.orderHeader.ordini||(this.orderHeader.ordini=[]),this.orderHeader.ordini.push(t),yield this.createNewComanda())}}})}loadOrderForEdit(t){return _(this,null,function*(){let e=yield this.orderHeaderService.loadWithDetails(t);if(e){if(this.orderHeader=e,e.ordini?.length){let i=e.ordini[e.ordini.length-1];if(this.currentOrdine=i,i.comande?.length){let n=i.comande.slice().reverse().find(d=>d.status!=="cancelled");n&&(this.currentComanda=n)}}this.currentComanda||(yield this.ensureActiveComanda())}})}createNewOrder(){return _(this,null,function*(){console.log("\u{1F195} Creazione COMPLETA ordine per tavolo:",this.table.table_number);try{let t=yield this.orderHeaderService.createForTable(this.table.id,"Cliente");if(!t){console.error("\u274C Impossibile creare order header"),this.showError("Impossibile creare la tavolata");return}this.orderHeader=t,console.log("\u2705 OrderHeader creato:",t.id);let e=yield this.ordineService.createForHeader(t.id);if(!e){console.error("\u274C Impossibile creare ordine"),this.showError("Impossibile creare l'ordine");return}this.currentOrdine=e,console.log("\u2705 Ordine creato:",e.id);let i=yield this.comandaService.createForOrdine(e.id);if(!i){console.error("\u274C Impossibile creare comanda"),this.showError("Impossibile creare la comanda");return}this.currentComanda=i,console.log("\u2705 Comanda creata:",{id:i.id,order_number:i.order_number,comanda_number:i.comanda_number}),this.orderHeader.ordini||(this.orderHeader.ordini=[]),this.orderHeader.ordini.push(e),e.comande||(e.comande=[]),e.comande.push(i),this.currentComanda.order_items=[],this.updateTotals(),console.log("\u2705 Struttura completa creata:",{orderHeaderId:t.id,ordineId:e.id,comandaId:i.id,comandaNumber:i.comanda_number,orderNumber:i.order_number})}catch(t){console.error("\u274C Errore completo creazione ordine:",t),this.showError(`Errore: ${t.message||"Sconosciuto"}`)}})}showError(t){console.error("\u{1F4A5} ERRORE UTENTE:",t)}createNewComanda(){return _(this,null,function*(){if(!this.orderHeader){console.error("\u274C Nessun order header");return}if(!this.currentOrdine){let e=yield this.ordineService.createForHeader(this.orderHeader.id);if(!e){console.error("\u274C Impossibile creare ordine");return}this.currentOrdine=e,this.orderHeader.ordini||(this.orderHeader.ordini=[]),this.orderHeader.ordini.push(e)}let t=yield this.comandaService.createForOrdine(this.currentOrdine.id);t&&(this.currentComanda=t,this.currentComanda.order_items=[],this.currentOrdine.comande||(this.currentOrdine.comande=[]),this.currentOrdine.comande.push(t))})}addDish(t){return _(this,null,function*(){try{if(console.log("\u2795 [OrderEditor] Aggiungi piatto:",t.name),!this.orderHeader&&(console.log("\u{1F195} Creo nuovo ordine..."),yield this.createNewOrder(),!this.orderHeader)){console.error("\u274C Impossibile creare ordine");return}if(!this.currentComanda&&(console.log("\u{1F195} Creo nuova comanda..."),yield this.ensureActiveComanda(),!this.currentComanda)){console.error("\u274C Impossibile creare comanda");return}this.currentComanda.order_items||(this.currentComanda.order_items=[]);let e=this.currentComanda.order_items.find(i=>i.dish_id===t.id);if(e)console.log("\u{1F4C8} Incrementa quantit\xE0 per piatto esistente"),yield this.updateQuantity(e,1);else{console.log("\u{1F195} Aggiungi nuovo piatto");let i=yield this.orderItemService.addItemToComanda(this.currentComanda.id,t.id,1,t.base_price,"");i?(i.dish_name=t.name,this.currentComanda.order_items.push(i),yield this.updateComandaTotalInDatabase(),this.updateTotals(),console.log("\u2705 Piatto aggiunto con successo")):console.error("\u274C Impossibile aggiungere piatto - vedi log precedenti")}}catch(e){console.error("\u{1F4A5} [OrderEditor] Errore critico in addDish:",e)}})}updateComandaTotalInDatabase(){return _(this,null,function*(){if(this.currentComanda)try{let t=this.getComandaTotal(this.currentComanda);(yield this.comandaService.updateTotalAmount(this.currentComanda.id,t))&&(this.currentComanda.total_amount=t,console.log("\u2705 Totale comanda aggiornato nel DB:",t))}catch(t){console.error("\u274C Errore aggiornamento totale comanda:",t)}})}updateQuantity(t,e){return _(this,null,function*(){if(!this.currentComanda?.order_items)return;let i=t.quantity+e;if(i<1){yield this.removeItem(t);return}try{(yield this.orderItemService.updateQuantity(t.id,i))&&(t.quantity=i,t.total_price=t.unit_price*i,yield this.updateComandaTotalInDatabase(),this.updateTotals(),console.log("\u2705 Quantit\xE0 aggiornata:",t.quantity))}catch(n){console.error("\u274C Errore aggiornamento quantit\xE0:",n)}})}removeItem(t){return _(this,null,function*(){if(this.currentComanda?.order_items)try{(yield this.orderItemService.delete(t.id))&&(this.currentComanda.order_items=this.currentComanda.order_items.filter(i=>i.id!==t.id),this.updateComandaTotal(this.currentComanda),this.updateTotals())}catch(e){console.error("\u274C Errore rimozione piatto:",e)}})}updateComandaTotal(t){if(!t.order_items){t.total_amount=0;return}t.total_amount=t.order_items.reduce((e,i)=>e+(i.total_price||i.unit_price*i.quantity),0)}updateTotals(){this.currentComanda&&(this.updateComandaTotal(this.currentComanda),this.orderHeader&&(this.orderHeader.total_amount=this.calculateRealtimeTotal()))}getFilteredDishes(){let t=this.dishes;if(this.selectedCategory!=="all"&&(t=t.filter(e=>e.category_id===this.selectedCategory)),this.searchTerm){let e=this.searchTerm.toLowerCase();t=t.filter(i=>i.name.toLowerCase().includes(e)||i.description?.toLowerCase().includes(e))}return t}get globalMenus(){return this.activeMenus.filter(t=>t.type==="global")}get dedicatedMenu(){return this.activeMenus.find(t=>t.type==="dedicated")||null}getComandaItems(){return this.currentComanda?.order_items||[]}getComandaTotal(t){let e=t||this.currentComanda;return!e||!e.order_items?0:e.order_items.reduce((i,n)=>i+(n.total_price||n.unit_price*n.quantity),0)}getOrderTotal(t){return t?this.getComandaTotal(t):this.orderHeader?.total_amount||0}onOrdineChange(t){this.currentOrdine=t,t.comande&&t.comande.length>0?this.currentComanda=t.comande[0]:this.currentComanda=null}save(){return _(this,null,function*(){this.orderHeader&&this.saved.emit(this.orderHeader)})}close(){this.closeRequested.emit()}inject(t){return w(t)}calcolaTotaleTavolata(){return this.getOrderTotal()}calcolaTotaleOrderHeader(t){return t.total_amount||0}calcolaTotaleOrdine(t){return t.comande?.reduce((e,i)=>e+(i.total_amount||0),0)??0}hasMenusToShow(){return this.activeMenus.length>0}hasDedicatedMenu(){return this.activeMenus.some(t=>t.type==="dedicated")}hasGlobalMenus(){return this.activeMenus.some(t=>t.type==="global")}getAvailableDishes(){return this.getFilteredDishes()}onMenuSelectChange(t){console.log("\u{1F4DD} Menu selezionato:",t.name),this.selectedMenu=t,this.loadDishesForSelectedMenu()}getDishesCountByCategory(t){let e=this.getFilteredDishes();return t==="all"?e.length:e.filter(i=>i.category_id===t).length}getDishesGroupedByCategory(){let t=this.getFilteredDishes(),e=[],i=this.categoryService.getCategories()??[];return console.log("\u{1F4CA} Categorie disponibili:",i.length),console.log("\u{1F4CA} Piatti filtrati:",t.length),i.forEach(n=>{let d=t.filter(v=>v.category_id===n.id);d.length>0&&e.push({category:n,dishes:d})}),e}shouldShowComandaDropdown(){return(this.currentOrdine?.comande?.length||0)>1}getCurrentComande(){return this.currentOrdine?.comande??[]}getComandeForDropdown(){return this.currentOrdine?.comande||[]}addDishToOrder(t){this.addDish(t)}updateItemQuantity(t,e){this.updateQuantity(t,e)}getDishName(t){return t.dish_name||t.dish?.name||"Piatto"}toggleMoveSelect(t){this.showMoveSelectForItem=this.showMoveSelectForItem===t?null:t}moveItemToComanda(t,e){console.log("Sposta item a comanda:",e)}toggleOrderHeaderExpansion(t){this.orderHeadersExpanded[t]=!this.orderHeadersExpanded[t]}toggleOrderExpansion(t){this.ordersExpanded[t]=!this.ordersExpanded[t]}isOrderExpanded(t){return this.ordersExpanded[t]||!1}getOrderStatusColor(t){return{ordered:"#f39c12",waiting:"#3498db",preparing:"#9b59b6",ready:"#2ecc71",served:"#27ae60",cancelled:"#e74c3c"}[t]||"#95a5a6"}getOrderStatusText(t){return{ordered:"Ordinato",waiting:"In attesa",preparing:"In preparazione",ready:"Pronto",served:"Servito",cancelled:"Cancellato"}[t]||t}getStatusTitle(t){return{ordered:"Click per mettere in attesa la cucina",waiting:"In attesa di preparazione (cucina)",preparing:"In preparazione (cucina)",ready:"Click per segnare come servito",served:"Comanda servita",cancelled:"Comanda cancellata - Click per ripristinare"}[t]||"Stato comanda"}isStatusClickable(t){return!1}handleStatusClick(t,e){e.stopPropagation()}toggleCancelRestore(t,e){e.stopPropagation()}generateBill(){this.showBillPreviewModal=!0,this.billPreviewHtml="<h1>Anteprima scontrino</h1>"}printBill(){let t=window.open("","_blank");t&&(t.document.write(this.billPreviewHtml),t.document.close(),t.print())}isReadyForBill(){return!!this.orderHeader}switchToEditMode(){this.closeRequested.emit()}getTotalComandeCount(){return 1}saveOrder(){return _(this,null,function*(){if(!(!this.orderHeader||!this.currentComanda)){this.loadingService.start();try{if(this.orderHeader.ordini){for(let t of this.orderHeader.ordini)if(t.comande)for(let e of t.comande)yield this.comandaService.update(e.id,{total_amount:e.total_amount,updated_at:new Date().toISOString()})}yield this.orderHeaderService.update(this.orderHeader.id,{total_amount:this.orderHeader.total_amount,updated_at:new Date().toISOString()}),console.log("\u2705 Ordine salvato con successo"),this.saved.emit(this.orderHeader)}catch(t){console.error("\u274C Errore salvataggio ordine:",t)}finally{this.loadingService.stop()}}})}resetDishFilters(){this.searchTerm="",this.selectedCategory="all",this.dishSearchTerm=""}trackByDishId(t,e){return e.id}debugErrors(){return _(this,null,function*(){try{console.log("\u{1F50D} DEBUG ERRORI 406/400");let t=yield this.orderHeaderService.getActiveOrderHeaderByTable(this.table.id);if(console.log("\u{1F4CA} Risultato getActiveOrderHeaderByTable:",t),this.currentOrdine){console.log("\u{1F504} Test creazione comanda per ordine:",this.currentOrdine.id);let e=yield this.comandaService.createForOrdine(this.currentOrdine.id);console.log("\u{1F4CA} Risultato createForOrdine:",e)}}catch(t){console.error("\u274C Errore debug:",{message:t.message,details:t.details,code:t.code,hint:t.hint})}})}switchComanda(t){if(!this.currentOrdine?.comande)return;let e=this.currentOrdine.comande.find(i=>i.id===t);e&&(this.currentComanda=e)}calculateRealtimeTotal(){if(!this.orderHeader?.ordini)return 0;let t=0;for(let e of this.orderHeader.ordini)if(e.comande)for(let i of e.comande){if(!i.order_items)continue;let n=i.order_items.reduce((d,v)=>d+(v.total_price||v.unit_price*v.quantity),0);t+=n}return t}static \u0275fac=function(e){return new(e||l)};static \u0275cmp=J({type:l,selectors:[["app-order-editor"]],inputs:{table:"table",mode:"mode",existingOrderHeader:"existingOrderHeader",orderHeaders:"orderHeaders",currentTavolataId:"currentTavolataId",orderingStatus:"orderingStatus"},outputs:{saved:"saved",closeRequested:"closeRequested"},decls:3,vars:3,consts:[["noDishes",""],["emptyOrder",""],["class","modal-overlay",3,"click",4,"ngIf"],[1,"modal-overlay",3,"click"],[1,"modal-container","modal-lg","fullscreen-mobile",3,"click"],[1,"modal-header","compact-header"],[1,"flex","items-center","gap-sm","flex-1"],[1,"icon-button",3,"click"],[1,"material-icons"],[1,"flex","flex-col","flex-1"],[1,"section-title","text-md"],["class","chip active ml-sm",4,"ngIf"],[1,"flex","items-center","gap-sm","mt-sm"],[1,"text-muted","text-mini"],[1,"flex","items-center","gap-sm"],["class","form-input",3,"ngModel","ngModelChange",4,"ngIf"],[4,"ngIf"],["title","Chiudi",1,"icon-button",3,"click"],[1,"p-lg","mobile-scroll"],["class","menu-selector mb-lg",4,"ngIf"],[1,"search-bar-mobile","mb-md"],[1,"form-row"],[1,"form-group",2,"flex","3"],["type","text","placeholder","Cerca piatto...","autofocus","",1,"form-input","touch-target",3,"ngModelChange","ngModel"],[1,"form-group",2,"flex","1"],[1,"form-input","touch-target",3,"ngModelChange","ngModel"],["value","all"],[3,"value",4,"ngFor","ngForOf"],[1,"flex",2,"margin-bottom","var(--gap-sm)"],[1,"grid-form"],[1,"flex","flex-col","gap-md"],[1,"quick-actions-mobile"],[1,"quick-action-button",3,"click"],[1,"text-mini"],["class","quick-action-button",3,"active","click",4,"ngFor","ngForOf"],[1,"flex","flex-col","gap-sm"],[4,"ngIf","ngIfElse"],[1,"form-card",2,"margin","0","padding","var(--gap-sm)"],[1,"flex","justify-between","items-center"],[1,"flex","items-center","gap-sm","font-semibold"],[1,"material-icons","text-primary","text-md"],[1,"chip","active"],["class","mt-sm",4,"ngIf"],[1,"form-card",2,"margin","0","max-height","50vh","overflow-y","auto"],[1,"modal-footer","mobile-footer"],[1,"promethea-button","ghost","flex-1","mobile-button",3,"click"],["title","Crea una nuova comanda nell'ordine corrente",1,"promethea-button","flex-1",3,"click","disabled"],[1,"promethea-button","primary","flex-1",3,"click","disabled","title"],[1,"chip","active","ml-sm"],[1,"form-input",3,"ngModelChange","ngModel"],[3,"ngValue",4,"ngFor","ngForOf"],[3,"ngValue"],["class","chip active",4,"ngIf"],[1,"menu-selector","mb-lg"],[1,"form-group"],[1,"standard-label"],["class","text-primary font-semibold",4,"ngIf"],["class","p-sm bg-primary-light rounded mb-md",4,"ngIf"],["class","p-sm bg-smoke rounded text-center",4,"ngIf"],["class","mt-sm flex items-center gap-sm",4,"ngIf"],[1,"text-primary","font-semibold"],[1,"p-sm","bg-primary-light","rounded","mb-md"],[1,"material-icons","text-primary"],[1,"font-semibold"],[1,"chip","bg-primary","ml-sm","text-white"],["class","p-sm bg-glass rounded border",4,"ngIf"],[1,"p-sm","bg-glass","rounded","border"],[1,"flex","items-center","justify-between"],["class","chip bg-glass",4,"ngIf"],[1,"chip","bg-glass"],[1,"material-icons","text-mini"],[1,"p-sm","bg-smoke","rounded","text-center"],[1,"material-icons","text-muted"],[1,"text-muted","text-mini","mt-sm"],[1,"mt-sm","flex","items-center","gap-sm"],[1,"chip"],["class","chip bg-primary text-white",4,"ngIf"],[1,"chip","bg-primary","text-white"],[3,"value"],[4,"ngFor","ngForOf"],[1,"flex","gap-sm","items-center"],[1,"font-bold","text-md"],[1,"material-icons","text-md"],[1,"font-bold","text-primary","text-md"],[1,"dishes-grid"],["class","card dish-card mobile-card",4,"ngFor","ngForOf","ngForTrackBy"],[1,"card","dish-card","mobile-card"],[1,"flex","gap-sm","flex-col","flex-1"],[1,"dish-name"],[1,"dish-price","text-primary"],["class","text-muted text-mini",4,"ngIf"],[1,"flex","gap-sm","justify-end"],["title","Aggiungi 1",1,"icon-button","x-small",3,"click","disabled"],[1,"empty-state"],[1,"text-muted"],[1,"promethea-button","ghost","mt-sm",3,"click"],[1,"mt-sm"],["class","mb-sm pb-sm border-b border-[var(--smoke-1)] last:border-0",4,"ngFor","ngForOf"],[1,"mt-md","pt-md","border-t","border-[var(--smoke-1)]"],[1,"flex","justify-between","items-center","mb-sm"],[1,"text-md"],[1,"text-primary","text-md"],["class","flex justify-between items-center",4,"ngIf"],[1,"mb-sm","pb-sm","border-b","border-[var(--smoke-1)]","last:border-0"],[1,"flex","justify-between","items-start","gap-sm"],["title","Riduci quantit\xE0",1,"icon-button","x-small",3,"click"],[1,"font-bold","px-2","text-center","text-sm","min-w-[20px]"],["title","Aumenta quantit\xE0",1,"icon-button","x-small",3,"click","disabled"],["title","Elimina piatto",1,"icon-button","x-small","ml-1","text-danger",3,"click"],[1,"text-secondary"],[1,"empty-state","py-lg"],[1,"material-icons","text-lg"],[1,"modal-container","modal-lg",3,"click"],[1,"modal-header"],[1,"header-icon"],[1,"section-title"],[1,"p-lg"],["class","empty-state",4,"ngIf"],["class","flex flex-col gap-lg",4,"ngIf"],[1,"modal-footer","mt-lg"],[1,"promethea-button","success","flex-1",3,"click","disabled"],[1,"promethea-button","primary","flex-1",3,"click"],[1,"promethea-button","ghost","flex-1",3,"click"],[1,"promethea-button","primary","mt-sm",3,"click"],[1,"flex","flex-col","gap-lg"],["class","form-card",4,"ngFor","ngForOf"],[1,"form-card","mt-md","bg-gradient","text-white"],[1,"text-white"],[1,"text-white","text-sm","opacity-80"],[1,"text-white","text-xl"],[1,"form-card"],[1,"flex","justify-between","items-center","cursor-pointer",3,"click"],[1,"flex","items-center","gap-md","flex-1"],[1,"flex","flex-col"],[1,"flex","items-center","gap-sm","flex-wrap"],[1,"chip","small","mt-sm"],[1,"text-muted","mt-sm"],[1,"flex","items-center","gap-md"],[1,"flex","flex-col","items-end"],["class","mt-md pt-md border-t border-[var(--smoke-1)]",4,"ngIf"],["class","mb-lg",4,"ngFor","ngForOf"],[1,"flex","justify-between","items-center","mt-lg","pt-lg","border-t"],[1,"mb-lg"],[1,"flex","justify-between","items-center","cursor-pointer","mt-sm","p-sm","rounded","bg-smoke",3,"click"],[1,"material-icons","text-secondary"],[1,"chip","small"],[1,"text-muted","text-sm"],["class","p-sm",4,"ngIf"],[1,"p-sm"],["class","mb-md",4,"ngFor","ngForOf"],[1,"mb-md"],[1,"flex","justify-between","items-center","p-sm","rounded","bg-smoke-1"],[1,"chip","small","link",3,"click","title"],[1,"icon-button","small","ml-sm",3,"click","ngClass","title"],[1,"font-bold"],["class","space-y-sm mt-sm",4,"ngIf"],["class","empty-state py-md",4,"ngIf"],[1,"space-y-sm","mt-sm"],["class","flex justify-between items-start p-sm flex-wrap",4,"ngFor","ngForOf"],[1,"flex","justify-between","items-start","p-sm","flex-wrap"],[1,"flex","items-start","gap-sm"],[1,"flex","items-center","gap-sm","mt-sm","text-muted"],[1,"chip","x-small","mt-sm",2,"max-width","fit-content"],[1,"empty-state","py-md"],[1,"p-lg",3,"innerHTML"],[1,"modal-footer"]],template:function(e,i){e&1&&f(0,kt,80,37,"div",2)(1,Lt,35,13,"div",2)(2,jt,16,1,"div",2),e&2&&(m("ngIf",i.mode==="edit"),s(),m("ngIf",i.mode==="view"),s(),m("ngIf",i.showBillPreviewModal))},dependencies:[ie,Te,ee,te,de,le,se,re,oe,ne,ae,Oe,Pe,Ie,Me],styles:[".mobile-scroll[_ngcontent-%COMP%]{overflow-y:auto;max-height:60vh;-webkit-overflow-scrolling:touch}@media (max-width: 768px){.mobile-scroll[_ngcontent-%COMP%]{max-height:70vh;padding:var(--gap-sm)}.fullscreen-mobile[_ngcontent-%COMP%]{max-height:100dvh;height:100%;width:100%;border-radius:0}.mobile-footer[_ngcontent-%COMP%]{flex-direction:column;gap:var(--gap-sm)}.mobile-button[_ngcontent-%COMP%]{width:100%}}.dishes-grid[_ngcontent-%COMP%]{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:var(--gap-sm);margin-bottom:var(--gap-md)}@media (max-width: 768px){.dishes-grid[_ngcontent-%COMP%]{grid-template-columns:repeat(2,1fr)}}.dish-card[_ngcontent-%COMP%]{border:1px solid var(--smoke-1);border-radius:12px;padding:var(--gap-sm);background:var(--background);transition:all .2s ease;cursor:pointer}.dish-card[_ngcontent-%COMP%]:hover{transform:translateY(-2px);border-color:var(--primary);box-shadow:0 4px 12px var(--smoke-2)}.dish-name[_ngcontent-%COMP%]{font-weight:600;font-size:var(--fs-sm);line-height:1.3;color:var(--text-color);margin-bottom:4px}.dish-price[_ngcontent-%COMP%]{font-weight:700;font-size:var(--fs-sm);color:var(--primary)}.quick-actions-mobile[_ngcontent-%COMP%]{display:flex;gap:var(--gap-sm);overflow-x:auto;padding-bottom:var(--gap-sm);margin-bottom:var(--gap-md);-webkit-overflow-scrolling:touch;scrollbar-width:none}.quick-actions-mobile[_ngcontent-%COMP%]::-webkit-scrollbar{display:none}.quick-action-button[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:var(--gap-sm);min-width:80px;border:1px solid var(--smoke-1);border-radius:12px;background:var(--background);transition:all .2s ease;cursor:pointer;flex-shrink:0}.quick-action-button[_ngcontent-%COMP%]:hover, .quick-action-button.active[_ngcontent-%COMP%]{background:var(--smoke-1);border-color:var(--primary)}.quick-action-button[_ngcontent-%COMP%]   .material-icons[_ngcontent-%COMP%]{font-size:var(--fs-md);margin-bottom:4px}.grid-form[_ngcontent-%COMP%]{display:grid;grid-template-columns:1fr 1fr;gap:var(--gap-lg)}@media (max-width: 768px){.grid-form.mobile-vertical[_ngcontent-%COMP%]{grid-template-columns:1fr;gap:var(--gap-md)}}.search-bar-mobile[_ngcontent-%COMP%]   .form-row[_ngcontent-%COMP%]{display:flex;gap:var(--gap-sm);margin-bottom:var(--gap-md)}@media (max-width: 768px){.search-bar-mobile[_ngcontent-%COMP%]   .form-row[_ngcontent-%COMP%]{flex-direction:column}}.menu-selector[_ngcontent-%COMP%]{background:var(--vetro);border:1px solid var(--smoke-1);border-radius:12px;padding:var(--gap-md);margin-bottom:var(--gap-lg)}.empty-state[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:var(--gap-lg);color:var(--text-muted);text-align:center}.empty-state[_ngcontent-%COMP%]   .material-icons[_ngcontent-%COMP%]{font-size:var(--fs-lg);margin-bottom:var(--gap-sm);opacity:.5}.bill-preview[_ngcontent-%COMP%]{font-family:Courier New,monospace;background:#fff;color:#000;padding:var(--gap-lg);max-height:60vh;overflow-y:auto}@media print{.bill-preview[_ngcontent-%COMP%]{max-height:none;overflow:visible}}.icon-button[disabled][_ngcontent-%COMP%], .promethea-button[disabled][_ngcontent-%COMP%]{opacity:.5;cursor:not-allowed;pointer-events:none}@keyframes _ngcontent-%COMP%_fadeIn{0%{opacity:0}to{opacity:1}}.modal-overlay[_ngcontent-%COMP%]{animation:_ngcontent-%COMP%_fadeIn .2s ease-out}.compact-header[_ngcontent-%COMP%]{padding:var(--gap-sm) var(--gap-md)}.compact-header[_ngcontent-%COMP%]   .section-title[_ngcontent-%COMP%]{font-size:var(--fs-md)}"]})};var Ze=()=>[1,2,3,4,5,6,7,8,9,10];function $t(l,t){if(l&1&&(r(0,"option",61),o(1),a()),l&2){let e=t.$implicit;m("ngValue",e),s(),I(e.name)}}function Qt(l,t){if(l&1&&(r(0,"option",61),o(1),a()),l&2){let e=t.$implicit;m("ngValue",e),s(),h(" ",e.name," ")}}function Zt(l,t){if(l&1){let e=S();r(0,"div",62)(1,"h2",63),o(2),a(),r(3,"div",18)(4,"button",36),g("click",function(){u(e);let n=c();return p(n.zoomOut())}),r(5,"span",37),o(6,"zoom_out"),a()(),r(7,"div",64)(8,"span",39),o(9,"search"),a(),r(10,"span",40),o(11),a()(),r(12,"button",36),g("click",function(){u(e);let n=c();return p(n.zoomIn())}),r(13,"span",37),o(14,"zoom_in"),a()(),r(15,"button",41),g("click",function(){u(e);let n=c();return p(n.resetZoom())}),r(16,"span",37),o(17,"history"),a()(),r(18,"select",65),T("ngModelChange",function(n){u(e);let d=c();return y(d.currentFloorPlan,n)||(d.currentFloorPlan=n),p(n)}),g("ngModelChange",function(n){u(e);let d=c();return p(d.onFloorPlanSelect(n))}),f(19,Qt,2,2,"option",27),a(),r(20,"button",41),g("click",function(){u(e);let n=c();return p(n.safeToggleFullscreen())}),r(21,"span",37),o(22,"fullscreen_exit"),a()()()()}if(l&2){let e=c();s(2),I((e.currentFloorPlan==null?null:e.currentFloorPlan.name)||"Mappa"),s(2),m("disabled",e.zoomLevel<=e.minZoom),s(7),h("",(e.zoomLevel*100).toFixed(0),"%"),s(),m("disabled",e.zoomLevel>=e.maxZoom),s(6),C("ngModel",e.currentFloorPlan),s(),m("ngForOf",e.floorPlans)}}function Gt(l,t){if(l&1&&(r(0,"div",72)(1,"small"),o(2),a()()),l&2){let e=c().$implicit;s(2),h("Pren: ",e.currentReservation.customer_name)}}function Ut(l,t){if(l&1&&(r(0,"div",72)(1,"small"),o(2),a()()),l&2){let e=c().$implicit,i=c();s(2),h("Ord: ",i.getTableOrderCount(e.table.id)," piatti")}}function Yt(l,t){if(l&1){let e=S();r(0,"div",66),g("click",function(){let n=u(e).$implicit,d=c();return p(d.onTableClick(n))}),r(1,"div",67)(2,"div",68),o(3),a(),r(4,"div",69)(5,"div",70),o(6),r(7,"span",37),o(8,"person"),a()()(),f(9,Gt,3,1,"div",71)(10,Ut,3,1,"div",71),a()()}if(l&2){let e=t.$implicit,i=c();K(i.getTableClass(e)),m("ngStyle",i.getTableStyle(e.table)),s(),H("text-large",i.isLargeText),s(2),I(e.table.table_number),s(3),I(e.table.capacity),s(3),m("ngIf",e.currentReservation),s(),m("ngIf",e.currentOrders)}}function Jt(l,t){l&1&&(r(0,"div",73)(1,"span",37),o(2,"search_off"),a(),r(3,"h3"),o(4,"Nessun tavolo trovato"),a(),r(5,"p",8),o(6,"Modifica i filtri di ricerca"),a()())}function Kt(l,t){if(l&1){let e=S();r(0,"div",83)(1,"button",84),g("click",function(){u(e);let n=c(2);return n.openManualReservationModal(),p(n.showQuickActionsModal=!1)}),r(2,"span",37),o(3,"event"),a(),o(4," Crea Prenotazione "),a(),r(5,"button",85),g("click",function(){u(e);let n=c(2);return p(n.openOrderEditor())}),r(6,"span",37),o(7),a(),o(8),a()()}if(l&2){let e=c(2);s(5),m("disabled",!e.orderingStatus.allowed)("title",e.orderingStatus.allowed?"Crea nuovo ordine":"Disabilitato: fuori orario dei turni"),s(2),I(e.orderingStatus.allowed?"restaurant":"schedule"),s(),h(" ",e.orderingStatus.allowed?"Crea Ordine":"Fuori Turno"," ")}}function Xt(l,t){if(l&1){let e=S();r(0,"div",83)(1,"button",42),g("click",function(){u(e);let n=c(2);return n.openEditReservationModal(),p(n.showQuickActionsModal=!1)}),r(2,"span",37),o(3,"edit"),a(),o(4," Modifica Prenotazione "),a(),r(5,"button",86),g("click",function(){u(e);let n=c(2);return p(n.openOrderEditor())}),r(6,"span",37),o(7,"check"),a(),o(8," Conferma Arrivo (Crea Ordine) "),a()()}if(l&2){let e=c(2);s(5),m("disabled",!e.orderingStatus.allowed)}}function ei(l,t){if(l&1){let e=S();r(0,"div",83)(1,"button",84),g("click",function(){u(e);let n=c(2);return p(n.openOrderEditor())}),r(2,"span",37),o(3,"receipt"),a(),o(4," Visualizza Ordini "),a()()}}function ti(l,t){if(l&1){let e=S();r(0,"div",74)(1,"div",75)(2,"div",76)(3,"div",46)(4,"div",77)(5,"span",37),o(6,"table_restaurant"),a()(),r(7,"div")(8,"h1",7),o(9),a()()(),r(10,"button",41),g("click",function(){u(e);let n=c();return p(n.deselectTable())}),r(11,"span",37),o(12,"close"),a()()(),r(13,"div",78)(14,"div",79)(15,"div",80)(16,"span",81),o(17),a()(),f(18,Kt,9,4,"div",82)(19,Xt,9,1,"div",82)(20,ei,5,0,"div",82),a()()()()}if(l&2){let e=c();s(9),h("Tavolo ",e.selectedTable==null?null:e.selectedTable.table_number),s(7),K(e.getStatusColorClass((e.selectedTableStatus==null?null:e.selectedTableStatus.status)||"free")),s(),h(" ",e.getStatusText((e.selectedTableStatus==null?null:e.selectedTableStatus.status)||"free")," "),s(),m("ngIf",(e.selectedTableStatus==null?null:e.selectedTableStatus.status)==="free"),s(),m("ngIf",(e.selectedTableStatus==null?null:e.selectedTableStatus.status)==="reserved"),s(),m("ngIf",(e.selectedTableStatus==null?null:e.selectedTableStatus.status)==="occupied")}}function ii(l,t){if(l&1&&(r(0,"option",100),o(1),a()),l&2){let e=t.$implicit,i=c(2);m("value",e)("disabled",i.selectedTable&&e>i.selectedTable.capacity),s(),j(" ",e," ",e===1?"persona":"persone"," ",i.selectedTable&&e>i.selectedTable.capacity?" (Troppe persone)":""," ")}}function ri(l,t){if(l&1){let e=S();r(0,"div",74)(1,"div",87)(2,"div",76)(3,"div",46)(4,"div",77)(5,"span",37),o(6,"event"),a()(),r(7,"div")(8,"h2",40),o(9),a()()(),r(10,"button",41),g("click",function(){u(e);let n=c();return p(n.closeManualReservationModal())}),r(11,"span",37),o(12,"close"),a()()(),r(13,"div",78)(14,"form",88,2),g("ngSubmit",function(n){return u(e),c().createManualReservation(),p(n.preventDefault())}),r(16,"div",23)(17,"div",24)(18,"label",25),o(19,"Nome Cliente *"),a(),r(20,"input",89),T("ngModelChange",function(n){u(e);let d=c();return y(d.manualReservationData.customer_name,n)||(d.manualReservationData.customer_name=n),p(n)}),a()(),r(21,"div",24)(22,"label",25),o(23,"Telefono *"),a(),r(24,"input",90),T("ngModelChange",function(n){u(e);let d=c();return y(d.manualReservationData.customer_phone,n)||(d.manualReservationData.customer_phone=n),p(n)}),a()()(),r(25,"div",23)(26,"div",24)(27,"label",25),o(28,"Data *"),a(),r(29,"input",91),T("ngModelChange",function(n){u(e);let d=c();return y(d.manualReservationData.reservation_date,n)||(d.manualReservationData.reservation_date=n),p(n)}),a()(),r(30,"div",24)(31,"label",25),o(32,"Orario *"),a(),r(33,"input",92),T("ngModelChange",function(n){u(e);let d=c();return y(d.manualReservationData.reservation_time,n)||(d.manualReservationData.reservation_time=n),p(n)}),a()()(),r(34,"div",24)(35,"label",25),o(36,"Numero Persone *"),a(),r(37,"select",93),T("ngModelChange",function(n){u(e);let d=c();return y(d.manualReservationData.party_size,n)||(d.manualReservationData.party_size=n),p(n)}),f(38,ii,2,5,"option",94),a(),r(39,"div",95),o(40),a()(),r(41,"div",24)(42,"label",25),o(43,"Note Speciali"),a(),r(44,"textarea",96),T("ngModelChange",function(n){u(e);let d=c();return y(d.manualReservationData.special_requests,n)||(d.manualReservationData.special_requests=n),p(n)}),a()(),r(45,"div",97)(46,"button",98),g("click",function(){u(e);let n=c();return p(n.closeManualReservationModal())}),o(47," Annulla "),a(),r(48,"button",99)(49,"span",37),o(50,"add"),a(),o(51," Crea Prenotazione "),a()()()()()()}if(l&2){let e=W(15),i=c();s(9),h("Nuova Prenotazione - Tavolo ",i.selectedTable==null?null:i.selectedTable.table_number),s(11),C("ngModel",i.manualReservationData.customer_name),s(4),C("ngModel",i.manualReservationData.customer_phone),s(5),C("ngModel",i.manualReservationData.reservation_date),s(4),C("ngModel",i.manualReservationData.reservation_time),s(4),C("ngModel",i.manualReservationData.party_size),s(),m("ngForOf",A(10,Ze)),s(2),h(" Capacit\xE0 massima tavolo: ",(i.selectedTable==null?null:i.selectedTable.capacity)||0," persone "),s(4),C("ngModel",i.manualReservationData.special_requests),s(4),m("disabled",!e.valid)}}function ni(l,t){if(l&1&&(r(0,"option",100),o(1),a()),l&2){let e=t.$implicit,i=c(2);m("value",e)("disabled",i.selectedTable&&e>i.selectedTable.capacity),s(),j(" ",e," ",e===1?"persona":"persone"," ",i.selectedTable&&e>i.selectedTable.capacity?" (Troppe persone)":""," ")}}function ai(l,t){if(l&1){let e=S();r(0,"button",103),g("click",function(){u(e);let n=c(2);return p(n.deleteReservation())}),r(1,"span",37),o(2,"delete"),a(),o(3," Elimina "),a()}}function oi(l,t){if(l&1){let e=S();r(0,"div",74)(1,"div",87)(2,"div",76)(3,"div",46)(4,"div",77)(5,"span",37),o(6,"edit"),a()(),r(7,"div")(8,"h1",7),o(9),a()()(),r(10,"button",41),g("click",function(){u(e);let n=c();return p(n.closeEditReservationModal())}),r(11,"span",37),o(12,"close"),a()()(),r(13,"div",78)(14,"form",88,2),g("ngSubmit",function(n){return u(e),c().updateReservation(),p(n.preventDefault())}),r(16,"div",23)(17,"div",24)(18,"label",25),o(19,"Nome Cliente *"),a(),r(20,"input",89),T("ngModelChange",function(n){u(e);let d=c();return y(d.editingReservation.customer_name,n)||(d.editingReservation.customer_name=n),p(n)}),a()(),r(21,"div",24)(22,"label",25),o(23,"Telefono *"),a(),r(24,"input",90),T("ngModelChange",function(n){u(e);let d=c();return y(d.editingReservation.customer_phone,n)||(d.editingReservation.customer_phone=n),p(n)}),a()()(),r(25,"div",23)(26,"div",24)(27,"label",25),o(28,"Data *"),a(),r(29,"input",91),T("ngModelChange",function(n){u(e);let d=c();return y(d.editingReservation.reservation_date,n)||(d.editingReservation.reservation_date=n),p(n)}),a()(),r(30,"div",24)(31,"label",25),o(32,"Orario *"),a(),r(33,"input",92),T("ngModelChange",function(n){u(e);let d=c();return y(d.editingReservation.reservation_time,n)||(d.editingReservation.reservation_time=n),p(n)}),a()()(),r(34,"div",24)(35,"label",25),o(36,"Numero Persone *"),a(),r(37,"select",93),T("ngModelChange",function(n){u(e);let d=c();return y(d.editingReservation.party_size,n)||(d.editingReservation.party_size=n),p(n)}),f(38,ni,2,5,"option",94),a(),r(39,"div",95),o(40),a()(),r(41,"div",24)(42,"label",25),o(43,"Note Speciali"),a(),r(44,"textarea",96),T("ngModelChange",function(n){u(e);let d=c();return y(d.editingReservation.special_requests,n)||(d.editingReservation.special_requests=n),p(n)}),a()(),r(45,"div",97)(46,"div",101),f(47,ai,4,0,"button",102),r(48,"div",5)(49,"button",98),g("click",function(){u(e);let n=c();return p(n.closeEditReservationModal())}),o(50," Annulla "),a(),r(51,"button",99)(52,"span",37),o(53,"save"),a(),o(54," Salva "),a()()()()()()()()}if(l&2){let e=W(15),i=c();s(9),h("Modifica Prenotazione - Tavolo ",i.selectedTable==null?null:i.selectedTable.table_number),s(11),C("ngModel",i.editingReservation.customer_name),s(4),C("ngModel",i.editingReservation.customer_phone),s(5),C("ngModel",i.editingReservation.reservation_date),s(4),C("ngModel",i.editingReservation.reservation_time),s(4),C("ngModel",i.editingReservation.party_size),s(),m("ngForOf",A(11,Ze)),s(2),h(" Capacit\xE0 massima tavolo: ",(i.selectedTable==null?null:i.selectedTable.capacity)||0," persone "),s(4),C("ngModel",i.editingReservation.special_requests),s(3),m("ngIf",i.isReservationDeletable(i.editingReservation)),s(4),m("disabled",!e.valid)}}function li(l,t){if(l&1){let e=S();r(0,"app-order-editor",104),g("saved",function(){u(e);let n=c();return p(n.closeOrderEditorModal())})("closeRequested",function(){u(e);let n=c();return p(n.closeOrderEditorModal())}),a()}if(l&2){let e=c();m("table",e.orderEditorData.table)("mode","edit")("existingOrderHeader",e.orderEditorData.existingOrderHeader)}}function si(l,t){if(l&1){let e=S();r(0,"app-order-editor",105),g("closeRequested",function(){u(e);let n=c();return p(n.closeOrderEditorViewModal())}),a()}if(l&2){let e=c();m("table",e.selectedTable)("mode","view")("existingOrderHeader",e.orderEditorData.existingOrderHeader||null)}}var Qe=class l{tableStatusService=w(me);floorManagementService=w(Le);loadingService=w(ce);tableService=w(Ne);floorPlanService=w(Be);reservationService=w(Ae);authService=w(Ve);orderHeaderService=w(U);shiftService=w(je);zoomLevel=1;minZoom=.5;maxZoom=3;mobileView=!1;isFullscreen=!1;isLargeText=!1;searchTerm="";statusFilter="all";showQuickActionsModal=!1;showManualReservationModal=!1;showEditReservationModal=!1;showAssignReservationModal=!1;showTableReservationsModal=!1;showTableAssignmentModal=!1;showOrderEditorModal=!1;showOrderEditorViewModal=!1;orderEditorData={table:null,mode:"edit",existingOrderHeader:null,orderHeaders:[],currentTavolataId:null};currentFloorPlan=null;tableStatuses=[];selectedTable=null;selectedTableStatus=null;currentRestaurant=null;tableOrderCounts=new Map;manualReservationData={customer_name:"",customer_phone:"",reservation_date:"",reservation_time:"",party_size:2,special_requests:""};editingReservation=null;orderingStatus={allowed:!1,reason:"Caricamento...",currentShift:null};availableReservationsWithoutTable=[];selectedReservationForAssignment=null;assignmentReservation=null;suggestedTablesByFloorPlan={};selectedFloorPlanForAssignment=null;selectedTableReservations={active:null,futureReservations:[],shiftInfo:{current:null,next:null}};subscriptions=new Se;get floorPlans(){return this.floorPlanService.data}get dishes(){return[]}ngOnInit(){return _(this,null,function*(){yield this.loadInitialData(),this.checkMobileView(),window.addEventListener("resize",()=>this.checkMobileView()),this.startShiftChecking()})}ngOnDestroy(){this.subscriptions.unsubscribe(),window.removeEventListener("resize",()=>this.checkMobileView())}loadInitialData(){return _(this,null,function*(){this.loadingService.start();try{yield Promise.all([this.floorPlanService.loadFloorPlans(),this.tableService.loadData(),this.floorManagementService.loadTodaysReservations()]);let t=this.tableService.data.filter(e=>!e.is_merged||e.parent_table_id===null);this.tableStatuses=yield this.tableStatusService.calculateTableStatus(t),this.floorPlans.length>0&&!this.currentFloorPlan&&(this.currentFloorPlan=this.floorPlans[0],yield this.loadTablesForFloorPlan())}finally{this.loadingService.stop()}})}onTableClick(t){return _(this,null,function*(){this.selectedTable=t.table,this.selectedTableStatus=t,yield this.loadTableReservations(t.table.id),this.showQuickActionsModal=!0})}deselectTable(){this.selectedTable=null,this.selectedTableStatus=null,this.showQuickActionsModal=!1,this.showManualReservationModal=!1,this.showEditReservationModal=!1}openManualReservationModal(){return _(this,null,function*(){if(!this.selectedTable)return;let t=new Date;this.manualReservationData={customer_name:"",customer_phone:"",reservation_date:t.toISOString().split("T")[0],reservation_time:t.toTimeString().split(" ")[0].substring(0,5),party_size:this.selectedTable.capacity||2,special_requests:""},this.showQuickActionsModal=!1,this.showManualReservationModal=!0})}closeManualReservationModal(){this.showManualReservationModal=!1}createManualReservation(){return _(this,null,function*(){if(this.selectedTable)try{let t=yield this.getCurrentRestaurantId();if(!t)return;let e={restaurant_id:t,table_id:this.selectedTable.id,reservation_date:this.manualReservationData.reservation_date,reservation_time:this.manualReservationData.reservation_time,party_size:this.manualReservationData.party_size,special_requests:this.manualReservationData.special_requests,status:"confirmed",customer_name:this.manualReservationData.customer_name,customer_phone:this.manualReservationData.customer_phone};(yield this.reservationService.createRestaurantReservation(e))?(this.closeManualReservationModal(),yield this.loadInitialData(),alert("Prenotazione creata con successo!")):alert("Errore nella creazione della prenotazione")}catch(t){console.error("Error creating manual reservation:",t),alert("Errore durante la creazione della prenotazione: "+t.message)}})}openOrderEditor(){return _(this,null,function*(){if(!this.selectedTable)return;let t=yield this.orderHeaderService.getActiveOrderHeaderByTable(this.selectedTable.id);t?(this.orderEditorData={table:this.selectedTable,mode:"view",existingOrderHeader:t,orderHeaders:[t],currentTavolataId:t.id},this.showOrderEditorViewModal=!0):(this.orderEditorData={table:this.selectedTable,mode:"edit",existingOrderHeader:null,orderHeaders:[],currentTavolataId:null},this.showOrderEditorModal=!0),this.showQuickActionsModal=!1})}closeOrderEditorModal(){this.showOrderEditorModal=!1,this.loadTablesForFloorPlan()}closeOrderEditorViewModal(){this.showOrderEditorViewModal=!1}loadTableReservations(t){return _(this,null,function*(){try{let e=yield this.getCurrentRestaurantId();if(!e)return;let i=new Date().toISOString().split("T")[0],n=this.reservationService.data.filter(b=>b.restaurant_id===e&&b.table_id===t&&b.reservation_date===i&&["confirmed","pending"].includes(b.status)).sort((b,x)=>b.reservation_time.localeCompare(x.reservation_time)),d=null,v=[];for(let b of n){let x=new Date(`${b.reservation_date}T${b.reservation_time}`),O=new Date,E=(x.getTime()-O.getTime())/(1e3*60*60);E>=0&&E<=1.5?d=b:E>1.5&&v.push(b)}this.selectedTableReservations={active:d,futureReservations:v,shiftInfo:{current:null,next:null}}}catch(e){console.error("Errore caricamento prenotazioni tavolo:",e),this.selectedTableReservations={active:null,futureReservations:[],shiftInfo:{current:null,next:null}}}})}checkMobileView(){this.mobileView=window.innerWidth<=768}getFilteredTables(){let t=this.tableStatuses;if(this.statusFilter!=="all"&&(t=t.filter(e=>e.status===this.statusFilter)),this.searchTerm){let e=this.searchTerm.toLowerCase();t=t.filter(i=>i.table.table_number.toLowerCase().includes(e)||i.table.table_name.toLowerCase().includes(e))}return t}getTableClass(t){let e=this.selectedTable?.id===t.table.id;return`table-element shape-${t.table.shape} ${t.status} ${e?"selected":""}`}getTableStyle(t){return{left:t.position_x+"px",top:t.position_y+"px",width:t.width+"px",height:t.height+"px","border-radius":t.shape==="circle"?"50%":"0px",transform:`rotate(${t.rotation}deg)`}}startShiftChecking(){this.checkCurrentShift(),this.subscriptions.add(we(6e4).subscribe(()=>this.checkCurrentShift()))}checkCurrentShift(){return _(this,null,function*(){let t=yield this.shiftService.getOrderingStatus();this.orderingStatus=t})}getShiftStatusClass(){return this.orderingStatus.allowed?"shift-active":"shift-inactive"}getShiftStatusText(){return this.orderingStatus.allowed?"\u{1F4CB} Orario di turno":"\u23F0 "+this.orderingStatus.reason}getCurrentRestaurantId(){return _(this,null,function*(){try{let t=this.authService.getCurrentStaffRestaurantId();return t||(this.authService.currentUserValue?(yield this.reservationService.loadData(),this.reservationService.data.length>0&&this.reservationService.data[0]?.restaurant_id||null):null)}catch(t){return console.error("Errore in getCurrentRestaurantId:",t),null}})}getStatusColorClass(t=""){return`status-${t}`}getStatusText(t=""){return{free:"Libero",reserved:"Prenotato",occupied:"Occupato"}[t]||t}getTableOrderItemsCount(t){return _(this,null,function*(){return yield this.orderHeaderService.getTableOrderItemsCount(t)})}onFloorPlanSelect(t){this.currentFloorPlan=t,this.loadTablesForFloorPlan(),this.deselectTable()}safeToggleFullscreen(){return _(this,null,function*(){this.isFullscreen=!this.isFullscreen})}zoomIn(){this.zoomLevel=Math.min(this.zoomLevel*1.25,this.maxZoom)}zoomOut(){this.zoomLevel=Math.max(this.zoomLevel/1.25,this.minZoom)}resetZoom(){this.zoomLevel=1}getScaledWidth(){return(this.currentFloorPlan?.width||1e3)*this.zoomLevel}getScaledHeight(){return(this.currentFloorPlan?.height||800)*this.zoomLevel}updateReservation(){return _(this,null,function*(){if(this.editingReservation)try{(yield this.reservationService.updateReservation(this.editingReservation.id,this.editingReservation))?(yield this.loadInitialData(),this.closeEditReservationModal(),this.deselectTable()):alert("Errore durante l'aggiornamento della prenotazione")}catch(t){console.error("Errore nell'aggiornamento della prenotazione:",t),alert("Errore durante l'aggiornamento della prenotazione")}})}deleteReservation(){return _(this,null,function*(){if(this.editingReservation&&this.isReservationDeletable(this.editingReservation))try{(yield this.reservationService.deleteReservation(this.editingReservation.id))?(yield this.loadInitialData(),this.closeEditReservationModal(),this.deselectTable()):alert("Errore durante l'eliminazione della prenotazione")}catch(t){console.error("Errore nell'eliminazione della prenotazione:",t),alert("Errore durante l'eliminazione della prenotazione")}else alert("Impossibile eliminare questa prenotazione")})}isReservationDeletable(t){return!t?.reservation_date||!t?.reservation_time?!1:new Date(`${t.reservation_date}T${t.reservation_time}`)>new Date}openEditReservationModal(){this.selectedTableStatus?.currentReservation&&(this.editingReservation=Y({},this.selectedTableStatus.currentReservation),this.showEditReservationModal=!0,this.showQuickActionsModal=!1)}closeEditReservationModal(){this.showEditReservationModal=!1,this.editingReservation=null}getFreeTablesCount(){return this.tableStatuses.filter(t=>t.status==="free").length}getReservedTablesCount(){return this.tableStatuses.filter(t=>t.status==="reserved").length}getOccupiedTablesCount(){return this.tableStatuses.filter(t=>t.status==="occupied").length}getTotalTablesCount(){return this.tableStatuses.length}toggleSize(){this.isLargeText=!this.isLargeText}getTableOrderItemsCountSync(t){return 0}loadAllTableOrderCounts(){return _(this,null,function*(){this.tableOrderCounts.clear();let t=this.tableStatuses.map(e=>_(this,null,function*(){try{let i=yield this.orderHeaderService.getTableOrderItemsCount(e.table.id);this.tableOrderCounts.set(e.table.id,i)}catch(i){console.error(`Errore caricamento ordini per tavolo ${e.table.id}:`,i),this.tableOrderCounts.set(e.table.id,0)}}));yield Promise.all(t)})}getTableOrderCount(t){return this.tableOrderCounts.get(t)||0}loadTablesForFloorPlan(){return _(this,null,function*(){if(!this.currentFloorPlan)return;let e=this.tableService.getTablesByFloorPlan(this.currentFloorPlan.id).filter(i=>!i.is_merged||i.parent_table_id===null);this.tableStatuses=yield this.tableStatusService.calculateTableStatus(e),yield this.loadAllTableOrderCounts()})}getTablesWithOrdersCount(){return Array.from(this.tableOrderCounts.values()).filter(t=>t>0).length}static \u0275fac=function(e){return new(e||l)};static \u0275cmp=J({type:l,selectors:[["app-table-map"]],decls:140,vars:40,consts:[["mapContainer","","mapCard",""],["floorPlanCanvas",""],["reservationForm","ngForm"],[1,"page-container"],[1,"section-header"],[1,"flex","gap-sm"],[1,"material-icons","fs-lg"],[1,"section-title"],[1,"text-muted"],[1,"grid-cards"],[1,"card"],[1,"flex","flex-col","gap-md"],[1,"flex","items-center","gap-sm","mb-md"],[1,"material-icons","text-primary","text-md"],[1,"card-title"],[1,"text-md","font-bold","text-primary","justify-center","flex"],[1,"form-card","flex-col","flex","gap-md"],[1,"flex","justify-between","items-center","m-sm02"],[1,"flex","items-center","gap-md"],[1,"flex"],[1,"text-muted","text-sm"],[1,"text-sm","text-muted"],[1,"form-card"],[1,"form-row"],[1,"form-group"],[1,"standard-label"],[1,"form-input",3,"ngModelChange","change","ngModel"],[3,"ngValue",4,"ngFor","ngForOf"],[1,"form-input",3,"ngModelChange","ngModel"],["value","all"],["value","free"],["value","reserved"],["value","occupied"],["type","text","placeholder","Numero o nome tavolo...",1,"form-input",3,"ngModelChange","ngModel"],[1,"modal-footer",2,"margin","0","justify-content","space-between"],[1,"flex","gap-md"],[1,"icon-button",3,"click","disabled"],[1,"material-icons"],[1,"flex","items-center","gap-sm","px-md","py-sm","justify-center"],[1,"material-icons","text-sm"],[1,"font-semibold"],[1,"icon-button",3,"click"],[1,"promethea-button","primary",3,"click"],[1,"form-card","mt-lg",2,"overflow","auto"],["class","fullscreen-header",4,"ngIf"],[1,"flex","justify-between","items-center","mb-md","flex-wrap"],[1,"flex","items-center","gap-sm"],[1,"flex","gap-sm","mr-md"],[1,"legend-color","free"],[1,"text-sm"],[1,"legend-color","reserved"],[1,"legend-color","occupied"],[1,"canvas-container"],[1,"canvas-wrapper"],[1,"floor-plan-canvas"],[1,"grid-overlay"],["class","table-element",3,"class","ngStyle","click",4,"ngFor","ngForOf"],["class","empty-state",4,"ngIf"],["class","modal-overlay",4,"ngIf"],[3,"table","mode","existingOrderHeader","saved","closeRequested",4,"ngIf"],[3,"table","mode","existingOrderHeader","closeRequested",4,"ngIf"],[3,"ngValue"],[1,"fullscreen-header"],[1,"font-bold","text-lg"],[1,"flex","items-center","gap-sm","bg-smoke","px-md","py-sm","rounded-full","min-w-32","justify-center"],[1,"form-input","text-sm",3,"ngModelChange","ngModel"],[1,"table-element",3,"click","ngStyle"],[1,"table-content"],[1,"table-number"],[1,"table-details"],[1,"table-capacity"],["class","table-info",4,"ngIf"],[1,"table-info"],[1,"empty-state"],[1,"modal-overlay"],[1,"modal-container","modal-sm"],[1,"modal-header"],[1,"header-icon"],[1,"p-lg"],[1,"flex","flex-col","gap-lg"],[1,"flex","justify-center"],[1,"chip"],["class","flex flex-col gap-sm",4,"ngIf"],[1,"flex","flex-col","gap-sm"],[1,"promethea-button",3,"click"],[1,"promethea-button","primary",3,"click","disabled","title"],[1,"promethea-button","success",3,"click","disabled"],[1,"modal-container","modal-md"],[1,"generic-form",3,"ngSubmit"],["type","text","name","customer_name","required","","placeholder","Inserisci il nome del cliente",1,"form-input",3,"ngModelChange","ngModel"],["type","tel","name","customer_phone","required","","placeholder","Inserisci il telefono",1,"form-input",3,"ngModelChange","ngModel"],["type","date","name","reservation_date","required","",1,"form-input",3,"ngModelChange","ngModel"],["type","time","name","reservation_time","required","",1,"form-input",3,"ngModelChange","ngModel"],["name","party_size","required","",1,"form-input",3,"ngModelChange","ngModel"],[3,"value","disabled",4,"ngFor","ngForOf"],[1,"text-muted","mt-sm"],["name","special_requests","rows","3","placeholder","Note o richieste speciali...",1,"form-input",3,"ngModelChange","ngModel"],[1,"modal-footer"],["type","button",1,"promethea-button","ghost",3,"click"],["type","submit",1,"promethea-button",3,"disabled"],[3,"value","disabled"],[1,"flex","justify-between","items-center","w-full"],["type","button","class","promethea-button danger",3,"click",4,"ngIf"],["type","button",1,"promethea-button","danger",3,"click"],[3,"saved","closeRequested","table","mode","existingOrderHeader"],[3,"closeRequested","table","mode","existingOrderHeader"]],template:function(e,i){if(e&1){let n=S();r(0,"div",3)(1,"div",4)(2,"div",5)(3,"span",6),o(4,"brunch_dining"),a(),r(5,"h1",7),o(6,"Prenotazioni Tavoli"),a()(),r(7,"p",8),o(8,"Gestisci prenotazioni e ordini in tempo reale"),a()(),r(9,"div",9)(10,"div",10)(11,"div",11)(12,"div",12)(13,"span",13),o(14,"event_available"),a(),r(15,"div",14),o(16,"Tavoli Liberi"),a()(),r(17,"div",15),o(18),a()()(),r(19,"div",10)(20,"div",11)(21,"div",12)(22,"span",13),o(23,"event"),a(),r(24,"div",14),o(25,"Prenotati"),a()(),r(26,"div",15),o(27),a()()(),r(28,"div",10)(29,"div",11)(30,"div",12)(31,"span",13),o(32,"restaurant"),a(),r(33,"div",14),o(34,"Occupati"),a()(),r(35,"div",15),o(36),a()()(),r(37,"div",10)(38,"div",11)(39,"div",12)(40,"span",13),o(41,"table_restaurant"),a(),r(42,"div",14),o(43,"Tavoli Totali"),a()(),r(44,"div",15),o(45),a()()()(),r(46,"div",16)(47,"div",17)(48,"div",18)(49,"div",19),o(50),a(),r(51,"div",20),o(52),a()(),r(53,"div",21),o(54," \u23F0 Si pu\xF2 ordinare 1h prima/dopo il turno "),a()()(),r(55,"div",22)(56,"div",23)(57,"div",24)(58,"label",25),o(59,"Mappa"),a(),r(60,"select",26),T("ngModelChange",function(v){return u(n),y(i.currentFloorPlan,v)||(i.currentFloorPlan=v),p(v)}),g("change",function(){return u(n),p(i.onFloorPlanSelect(i.currentFloorPlan))}),f(61,$t,2,2,"option",27),a()(),r(62,"div",24)(63,"label",25),o(64,"Stato"),a(),r(65,"select",28),T("ngModelChange",function(v){return u(n),y(i.statusFilter,v)||(i.statusFilter=v),p(v)}),r(66,"option",29),o(67,"Tutti gli stati"),a(),r(68,"option",30),o(69,"Libero"),a(),r(70,"option",31),o(71,"Prenotato"),a(),r(72,"option",32),o(73,"Occupato"),a()()(),r(74,"div",24)(75,"label",25),o(76,"Cerca"),a(),r(77,"input",33),T("ngModelChange",function(v){return u(n),y(i.searchTerm,v)||(i.searchTerm=v),p(v)}),a()(),r(78,"div",24)(79,"label",25),o(80,"Azioni"),a(),r(81,"div",34)(82,"div",35)(83,"button",36),g("click",function(){return u(n),p(i.zoomOut())}),r(84,"span",37),o(85,"zoom_out"),a()(),r(86,"div",38)(87,"span",39),o(88,"search"),a(),r(89,"span",40),o(90),a()(),r(91,"button",36),g("click",function(){return u(n),p(i.zoomIn())}),r(92,"span",37),o(93,"zoom_in"),a()(),r(94,"button",41),g("click",function(){return u(n),p(i.resetZoom())}),r(95,"span",37),o(96,"history"),a()()(),r(97,"button",42),g("click",function(){return u(n),p(i.loadInitialData())}),r(98,"span",37),o(99,"refresh"),a(),o(100," Aggiorna "),a()()()()(),r(101,"div",43,0),f(104,Zt,23,6,"div",44),r(105,"div",45)(106,"h2",40),o(107),a(),r(108,"div",46)(109,"div",47)(110,"div",46),N(111,"div",48),r(112,"span",49),o(113,"Libero"),a()(),r(114,"div",46),N(115,"div",50),r(116,"span",49),o(117,"Prenotato"),a()(),r(118,"div",46),N(119,"div",51),r(120,"span",49),o(121,"Occupato"),a()()(),r(122,"button",41),g("click",function(){return u(n),p(i.safeToggleFullscreen())}),r(123,"span",37),o(124),a()(),r(125,"button",41),g("click",function(){return u(n),p(i.toggleSize())}),r(126,"span",37),o(127),a()()()(),r(128,"div",52)(129,"div",53)(130,"div",54,1),N(132,"div",55),f(133,Yt,11,9,"div",56)(134,Jt,7,0,"div",57),a()()()(),f(135,ti,21,7,"div",58)(136,ri,52,11,"div",58)(137,oi,55,12,"div",58)(138,li,1,3,"app-order-editor",59)(139,si,1,3,"app-order-editor",60),a()}e&2&&(s(18),h(" ",i.getFreeTablesCount()," "),s(9),h(" ",i.getReservedTablesCount()," "),s(9),h(" ",i.getOccupiedTablesCount()," "),s(9),h(" ",i.getTotalTablesCount()," "),s(4),K(i.getShiftStatusClass()),s(),h(" ",i.getShiftStatusText()," "),s(2),h(" ",i.orderingStatus.reason," "),s(8),C("ngModel",i.currentFloorPlan),s(),m("ngForOf",i.floorPlans),s(4),C("ngModel",i.statusFilter),s(12),C("ngModel",i.searchTerm),s(6),m("disabled",i.zoomLevel<=i.minZoom),s(7),h("",(i.zoomLevel*100).toFixed(0),"%"),s(),m("disabled",i.zoomLevel>=i.maxZoom),s(13),m("ngIf",i.isFullscreen),s(3),I(i.currentFloorPlan?i.currentFloorPlan.name:"Mappa"),s(15),H("active",i.isFullscreen),s(2),h(" ",i.isFullscreen?"fullscreen_exit":"fullscreen"," "),s(3),h(" ",i.isLargeText?"text_decrease":"text_increase"," "),s(2),L("width",i.getScaledWidth(),"px")("height",i.getScaledHeight(),"px"),s(),L("width",i.currentFloorPlan?i.currentFloorPlan.width:1e3,"px")("height",i.currentFloorPlan?i.currentFloorPlan.height:800,"px")("transform","scale("+i.zoomLevel+")")("transform-origin","0 0"),s(3),m("ngForOf",i.getFilteredTables()),s(),m("ngIf",i.getFilteredTables().length===0),s(),m("ngIf",i.showQuickActionsModal),s(),m("ngIf",i.showManualReservationModal),s(),m("ngIf",i.showEditReservationModal),s(),m("ngIf",i.showOrderEditorModal),s(),m("ngIf",i.showOrderEditorViewModal))},dependencies:[ie,ee,te,Ee,de,De,le,se,re,oe,ne,Re,He,ae,Fe,ue],styles:[".fullscreen-header[_ngcontent-%COMP%]{position:fixed;top:0;left:0;right:0;z-index:1000;background:var(--background);padding:var(--gap-sm);display:flex;flex-wrap:wrap;justify-content:space-between;align-items:center;border-bottom:1px solid var(--smoke-1);-webkit-backdrop-filter:blur(10px);backdrop-filter:blur(10px);gap:var(--gap-sm)}.fullscreen-header[_ngcontent-%COMP%]   h2[_ngcontent-%COMP%]{font-size:var(--fs-md)!important;margin:0;flex:1;min-width:120px}.table-map-fullscreen[_ngcontent-%COMP%]   .canvas-container[_ngcontent-%COMP%]{position:absolute!important;inset:70px 0 0!important;height:auto!important;max-height:none!important;min-height:auto!important;border:none!important;margin-top:0!important;border-radius:0!important;padding:var(--gap-md)!important;overflow:auto!important;-webkit-overflow-scrolling:touch!important}.table-map-fullscreen[_ngcontent-%COMP%]   .canvas-wrapper[_ngcontent-%COMP%]{width:auto!important;height:auto!important}.table-map-fullscreen[_ngcontent-%COMP%]   .floor-plan-canvas[_ngcontent-%COMP%]{transform-origin:0 0!important}.canvas-container[_ngcontent-%COMP%]{position:relative;width:100%;min-height:400px;border:2px solid var(--smoke-1);border-radius:12px;background-color:var(--background);overflow:auto!important;-webkit-overflow-scrolling:touch!important;padding:var(--gap-sm);box-sizing:border-box}.canvas-wrapper[_ngcontent-%COMP%]{position:relative;min-width:100%;min-height:100%}.floor-plan-canvas[_ngcontent-%COMP%]{position:relative;background-color:var(--background);box-shadow:0 4px 12px var(--smoke-1);border-radius:8px;transform-origin:0 0;transition:transform .2s ease-out}@media (max-width: 768px){.chip.active.ml-sm[_ngcontent-%COMP%]{display:none}.canvas-container[_ngcontent-%COMP%]{min-height:400px;max-height:80vh;overflow:auto!important;-webkit-overflow-scrolling:touch!important;touch-action:pan-x pan-y!important;display:block}}.table-map-fullscreen[_ngcontent-%COMP%]   .floor-plan-canvas[_ngcontent-%COMP%]{display:block!important;width:max-content!important;height:max-content!important;min-width:100%!important;min-height:100%!important;margin:auto!important;transform-origin:center center;transition:transform .2s ease-out;background:var(--background)}@media (max-width: 768px){.fullscreen-header[_ngcontent-%COMP%]{padding:var(--gap-sm)}.table-map-fullscreen[_ngcontent-%COMP%]   .canvas-container[_ngcontent-%COMP%]{top:80px}}.icon-button[disabled][_ngcontent-%COMP%]{opacity:.4;cursor:not-allowed}.quick-actions-mobile[_ngcontent-%COMP%]{display:flex!important;gap:var(--gap-sm)!important;overflow-x:auto!important;padding-bottom:var(--gap-sm)!important;-webkit-overflow-scrolling:touch!important;scrollbar-width:none!important;flex-wrap:wrap}.quick-actions-mobile[_ngcontent-%COMP%]::-webkit-scrollbar{display:none!important}.quick-action-button[_ngcontent-%COMP%]{display:flex!important;flex-direction:column!important;align-items:center!important;justify-content:center!important;padding:var(--gap-sm)!important;min-width:80px!important;border:1px solid var(--smoke-1)!important;border-radius:12px!important;background:var(--background)!important;transition:all .2s ease!important;cursor:pointer!important;flex-shrink:0!important}.quick-action-button[_ngcontent-%COMP%]:hover, .quick-action-button[_ngcontent-%COMP%]:active{background:var(--smoke-1)!important;border-color:var(--primary)!important}.quick-action-button[_ngcontent-%COMP%]   .material-icons[_ngcontent-%COMP%]{font-size:var(--fs-md)!important;margin-bottom:4px!important}.mobile-scroll[_ngcontent-%COMP%]{overflow-y:auto;height:calc(100vh - 200px);max-height:500px;scroll-behavior:auto!important}.dish-card[_ngcontent-%COMP%]{min-height:120px;transition:none!important}.modal-container.modal-lg[_ngcontent-%COMP%]{max-height:90vh;display:flex;flex-direction:column}.modal-container.modal-lg[_ngcontent-%COMP%]   .modal-body[_ngcontent-%COMP%]{flex:1;overflow:hidden}.dish-card[_ngcontent-%COMP%]{border:1px solid var(--smoke-1)!important;border-radius:12px!important;padding:var(--gap-sm);background:var(--background);transition:none;cursor:pointer!important}.dish-card[_ngcontent-%COMP%]:hover, .dish-card[_ngcontent-%COMP%]:active{transform:translateY(-2px)!important;border-color:var(--primary)!important;box-shadow:0 4px 12px var(--smoke-2)!important}.dish-card.mobile-card[_ngcontent-%COMP%]{margin-bottom:var(--gap-sm)!important}.dish-name[_ngcontent-%COMP%]{font-weight:600!important;font-size:var(--fs-sm)!important;line-height:1.3!important;color:var(--text-color)!important}.dish-price[_ngcontent-%COMP%]{font-weight:700!important;font-size:var(--fs-sm)!important;color:var(--primary)!important}.bill-preview[_ngcontent-%COMP%]{background:var(--background);color:var(--text-color);max-height:70vh;overflow-y:auto;padding:var(--gap-lg)}.bill-preview[_ngcontent-%COMP%]   .header[_ngcontent-%COMP%]{margin-bottom:var(--gap-lg);padding-bottom:var(--gap-md);border-bottom:2px solid var(--smoke-1)}.bill-preview[_ngcontent-%COMP%]   .comanda[_ngcontent-%COMP%]{background:var(--vetro);border:1px solid var(--smoke-1);border-radius:12px;margin-bottom:var(--gap-md);transition:all .3s ease}.bill-preview[_ngcontent-%COMP%]   .comanda[_ngcontent-%COMP%]:hover{border-color:var(--secondary);box-shadow:0 4px 12px var(--smoke-2)}.bill-preview[_ngcontent-%COMP%]   .comanda-header[_ngcontent-%COMP%]{color:var(--text-color);font-weight:600;border-bottom:1px solid var(--smoke-1);padding-bottom:var(--gap-sm);margin-bottom:var(--gap-sm)}.bill-preview[_ngcontent-%COMP%]   .item[_ngcontent-%COMP%]{padding:calc(var(--gap-sm) / 2) 0;border-bottom:1px dashed var(--smoke-1)}.bill-preview[_ngcontent-%COMP%]   .item[_ngcontent-%COMP%]:last-child{border-bottom:none}.bill-preview[_ngcontent-%COMP%]   .comanda-total[_ngcontent-%COMP%]{color:var(--primary);font-weight:600;margin-top:var(--gap-sm);padding-top:var(--gap-sm)}.bill-preview[_ngcontent-%COMP%]   .header-total[_ngcontent-%COMP%]{background:color-mix(in srgb,var(--primary) 10%,transparent);padding:var(--gap-sm);border-radius:8px;margin-top:var(--gap-md)}.bill-preview[_ngcontent-%COMP%]   .grand-total[_ngcontent-%COMP%]{background:var(--gradiente);color:#fff;padding:var(--gap-lg);border-radius:16px;margin-top:var(--gap-lg);box-shadow:0 8px 24px var(--shadow-2)}@media print{.bill-preview[_ngcontent-%COMP%]   .grand-total[_ngcontent-%COMP%]{background:#000!important;-webkit-print-color-adjust:exact;print-color-adjust:exact}.modal-footer[_ngcontent-%COMP%]{display:none!important}}.canvas-wrapper[_ngcontent-%COMP%]{max-width:100%;max-height:100%}.legend-color[_ngcontent-%COMP%]{width:var(--fs-md);height:var(--fs-sm);display:flex;border-radius:var(--gap-sm)}.legend-color.free[_ngcontent-%COMP%]{background:#10b981}.legend-color.reserved[_ngcontent-%COMP%]{background:#f59e0b}.legend-color.occupied[_ngcontent-%COMP%]{background:#ef4444}.legend-color.merged[_ngcontent-%COMP%]{background:#ff6b35}.detail[_ngcontent-%COMP%]{display:flex;gap:var(--gap-sm)}.table-suggestion-card[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:var(--gap-sm);padding:var(--gap-sm)}.table-suggestion-icon[_ngcontent-%COMP%]{font-size:var(--fs-md)}.fullscreen-mobile[_ngcontent-%COMP%]{max-height:100dvh;height:100%}.table-card.disabled[_ngcontent-%COMP%]{opacity:.5;pointer-events:none}.overlay-disabled[_ngcontent-%COMP%]{position:absolute;inset:0;background:var(--background);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:10}"]})};export{Qe as TableMap};
