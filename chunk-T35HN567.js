import{a as S}from"./chunk-5M5JQCWW.js";import{b as m,d as h}from"./chunk-NPMWXJE4.js";import{Z as y,ca as g,g as p}from"./chunk-R56C6QW6.js";import{j as c}from"./chunk-4ZZIO3ZI.js";var R=class v{supabaseService=g(m);authService=g(h);reservationService=g(S);todaysReservationsSubject=new p([]);todaysReservations$=this.todaysReservationsSubject.asObservable();loadTodaysReservations(){return c(this,null,function*(){try{let e=yield this.getCurrentRestaurantId();console.log("\u{1F50D} Restaurant ID per prenotazioni:",e);let t=new Date().toISOString().split("T")[0];console.log("\u{1F4C5} Data di oggi per query:",t);let{data:r,error:a}=yield this.supabaseService.getSupabaseClient().from("reservations").select("*").eq("restaurant_id",e).eq("reservation_date",t).in("status",["confirmed","pending"]).order("reservation_time",{ascending:!0});if(a)throw console.error("\u274C Errore query prenotazioni:",a),a;console.log("\u{1F4CB} Prenotazioni caricate dal DB:",{totale:r?.length||0,conTavolo:r?.filter(i=>i.table_id)?.length||0,senzaTavolo:r?.filter(i=>!i.table_id)?.length||0}),this.todaysReservationsSubject.next(r||[])}catch(e){console.error("\u274C Errore caricamento prenotazioni:",e),this.todaysReservationsSubject.next([])}})}assignTableToReservation(e,t){return c(this,null,function*(){try{let r=yield this.reservationService.assignTableToReservation(e,t);return r&&(yield this.loadTodaysReservations()),r}catch(r){return console.error("\u274C Error assigning table to reservation:",r),!1}})}removeTableAssignment(e){return c(this,null,function*(){try{let t=yield this.reservationService.removeTableFromReservation(e);return t&&(yield this.loadTodaysReservations()),t}catch(t){return console.error("\u274C Error removing table assignment:",t),!1}})}getReservationsWithoutTable(){return this.todaysReservationsSubject.value.filter(e=>!e.table_id)}getReservationsWithTable(){return this.todaysReservationsSubject.value.filter(e=>e.table_id)}getCurrentReservations(){return this.todaysReservationsSubject.value}suggestTablesForReservation(e,t){return c(this,null,function*(){try{let r=yield this.getCurrentRestaurantId();if(!r)return[];let a=this.getCurrentReservations(),i=a.find(s=>s.id===e);if(!i)return[];let{data:o,error:l}=yield this.supabaseService.getSupabaseClient().from("tables").select("*").eq("restaurant_id",r).eq("is_active",!0).gte("capacity",t).order("capacity",{ascending:!0});if(l)throw l;let u=new Date().toISOString().split("T")[0],f=a.filter(s=>s.reservation_date===u&&["confirmed","pending"].includes(s.status)).map(s=>s.table_id).filter(s=>s!==null&&s!==i.table_id);return o?.filter(s=>!f.includes(s.id))||[]}catch(r){return console.error("\u274C Error suggesting tables:",r),[]}})}debugReservations(){return c(this,null,function*(){let e=new Date().toISOString().split("T")[0];console.log("\u{1F50D} DEBUG - Data di oggi:",e),console.log("\u{1F50D} DEBUG - Prenotazioni caricate:",this.todaysReservationsSubject.value),console.log("\u{1F50D} DEBUG - Prenotazioni senza tavolo:",this.getReservationsWithoutTable())})}getCurrentRestaurantId(){return c(this,null,function*(){try{let e=this.authService.currentUserValue;if(!e)return null;let t=this.authService.getCurrentStaffRestaurantId();if(t)return t;let{data:r,error:a}=yield this.supabaseService.getSupabaseClient().from("restaurants").select("id").eq("owner_id",e.id).limit(1).single();return a?(console.error("Error getting restaurant by owner:",a),null):r?.id||null}catch(e){return console.error("Exception getting restaurant:",e),null}})}suggestTablesGroupedByFloorPlan(e,t){return c(this,null,function*(){try{let r=yield this.getCurrentRestaurantId();if(!r)return[];let a=this.getCurrentReservations(),i=a.find(n=>n.id===e);if(!i)return[];let{data:o,error:l}=yield this.supabaseService.getSupabaseClient().from("tables").select(`
        *,
        floor_plans!inner (
          id,
          name
        )
      `).eq("restaurant_id",r).eq("is_active",!0).gte("capacity",t).order("capacity",{ascending:!0});if(l)throw l;let u=new Date().toISOString().split("T")[0],f=a.filter(n=>n.reservation_date===u&&["confirmed","pending"].includes(n.status)).map(n=>n.table_id).filter(n=>n!==null&&n!==i.table_id),b=o?.filter(n=>!f.includes(n.id))||[],s={};return b.forEach(n=>{let d=n.floor_plan_id||"no-floor-plan",T=n.floor_plans?.name||"Senza mappa";s[d]||(s[d]={floorPlan:{id:d,name:T},tables:[]}),s[d].tables.push(n)}),Object.values(s)}catch(r){return console.error("\u274C Error suggesting grouped tables:",r),[]}})}getAllTablesGroupedByFloorPlan(){return c(this,null,function*(){try{let e=yield this.getCurrentRestaurantId();if(!e)return[];let{data:t,error:r}=yield this.supabaseService.getSupabaseClient().from("tables").select(`
        *,
        restaurant_floor_plans (
          id,
          name
        )
      `).eq("restaurant_id",e).eq("is_active",!0).order("table_number",{ascending:!0});if(r)throw r;console.log("\u{1F50D} Struttura dati:",t?.slice(0,1));let a={};t?.forEach(o=>{let l=o.floor_plan_id||"no-floor-plan",u="Senza mappa";o.restaurant_floor_plans&&(Array.isArray(o.restaurant_floor_plans)&&o.restaurant_floor_plans.length>0?u=o.restaurant_floor_plans[0].name:o.restaurant_floor_plans.name&&(u=o.restaurant_floor_plans.name)),a[l]||(a[l]={floorPlan:{id:l,name:u},tables:[]}),a[l].tables.push(o)});let i=Object.values(a);return i.sort((o,l)=>o.floorPlan.id==="no-floor-plan"?1:l.floorPlan.id==="no-floor-plan"?-1:o.floorPlan.name.localeCompare(l.floorPlan.name)),console.log("\u2705 Tavoli raggruppati:",i),i}catch(e){return console.error("\u274C Error getting all tables grouped by floor plan:",e),[]}})}getAvailableTablesGroupedByFloorPlan(e){return c(this,null,function*(){try{if(!(yield this.getCurrentRestaurantId()))return[];yield this.loadTodaysReservations();let r=this.getCurrentReservations();return yield this.getAllTablesGroupedByFloorPlan()}catch(t){return console.error("\u274C Error getting available tables grouped by floor plan:",t),[]}})}static \u0275fac=function(t){return new(t||v)};static \u0275prov=y({token:v,factory:v.\u0275fac,providedIn:"root"})};export{R as a};
