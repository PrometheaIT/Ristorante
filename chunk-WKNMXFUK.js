import{a as v}from"./chunk-QPUWITB2.js";import{a as _}from"./chunk-XJU7QOT3.js";import{a as f,b as h,ba as l,f as i,ga as m,l as p,m as y,za as b}from"./chunk-UE7YVF6I.js";var g=class c{orderUpdatesSubject=new p;orderUpdates$=this.orderUpdatesSubject.asObservable();tableUpdatesSubject=new p;tableUpdates$=this.tableUpdatesSubject.asObservable();notifyOrderUpdate(e){this.orderUpdatesSubject.next(e)}notifyTableUpdate(e){this.tableUpdatesSubject.next(e)}notifyDataChange(){this.orderUpdatesSubject.next("refresh_all")}static \u0275fac=function(t){return new(t||c)};static \u0275prov=l({token:c,factory:c.\u0275fac,providedIn:"root"})};var S=class c extends _{shiftService=m(v);notificationService=m(g);ordersSubject=new y([]);orders$=this.ordersSubject.asObservable();getTableName(){return"orders"}getOrdersStats(e="today"){return i(this,null,function*(){let t=yield this.getCurrentRestaurantId();if(!t)return{count:0,revenue:0};let r=this.getDateFilter(e),{data:n,error:s}=yield this.supabaseService.getSupabaseClient().from("orders").select("total_amount, status").eq("restaurant_id",t).gte("created_at",r.start).lte("created_at",r.end);if(s)return console.error("Error fetching orders stats:",s),{count:0,revenue:0};let a=n?.filter(o=>o.status==="completed")||[];return{count:a.length,revenue:a.reduce((o,u)=>o+u.total_amount,0)}})}getDateFilter(e){let t=new Date,r=new Date;switch(e){case"today":r.setHours(0,0,0,0);break;case"week":r.setDate(t.getDate()-7);break;case"month":r.setMonth(t.getMonth()-1);break}return{start:r.toISOString(),end:t.toISOString()}}getOrdersWithItems(){return i(this,arguments,function*(e={}){let t=yield this.getCurrentRestaurantId();if(!t)return[];try{let r=this.supabaseService.getSupabaseClient().from("orders").select(e.includeItems?`*,
        order_items(
          *,
          dishes(
            name,
            base_price
          )
        )`:"*").eq("restaurant_id",t);e.status?.length&&(r=r.in("status",e.status));let{data:n,error:s}=yield r;return s?(console.error("\u274C Error in getOrdersWithItems query:",s),console.error("\u274C Query details:",s.details,s.hint,s.message),[]):n||[]}catch(r){return console.error("\u{1F4A5} Unexpected error in getOrdersWithItems:",r),[]}})}loadActiveOrders(){return i(this,null,function*(){try{let e=yield this.getCurrentRestaurantId();if(!e)return console.error("\u274C No restaurant found"),[];let{data:t,error:r}=yield this.supabaseService.getSupabaseClient().from("orders").select(`
          *,
          order_items (
            *,
            dishes (name, base_price)
          )
        `).eq("restaurant_id",e).not("status","in",'("completed", "cancelled")').order("created_at",{ascending:!1});if(r)return console.error("\u274C Error loading active orders:",r),[];let n=(t||[]).map(s=>(s.order_items&&Array.isArray(s.order_items)?s.order_items=s.order_items.map(a=>h(f({},a),{dish_name:a.dishes?.name||"Piatto",total_price:a.total_price||a.quantity*a.unit_price})):s.order_items=[],s));return console.log("\u{1F4CA} Active orders loaded:",n.length),n}catch(e){return console.error("\u274C Error loading active orders:",e),[]}})}forceRefreshActiveOrders(){return i(this,null,function*(){try{console.log("\u{1F504} Force refreshing active orders..."),yield this.loadOrders();let e=yield this.loadActiveOrders();return console.log("\u2705 Active orders force refreshed:",e.length),e}catch(e){return console.error("\u274C Error force refreshing active orders:",e),[]}})}updateOrderItemStatus(e,t){return i(this,null,function*(){try{let r={status:t};console.log(`\u{1F504} Updating order item ${e} to status: ${t}`);let{error:n}=yield this.supabaseService.getSupabaseClient().from("order_items").update(r).eq("id",e);if(n)throw console.error("\u274C Supabase error updating order item:",n),n;let{data:s,error:a}=yield this.supabaseService.getSupabaseClient().from("order_items").select("order_id").eq("id",e).single();return a?console.error("\u274C Error getting order_id for item:",a):s&&(yield this.updateOrderStatusBasedOnItems(s.order_id),this.notificationService.notifyOrderUpdate(s.order_id)),console.log("\u2705 Order item status updated successfully"),!0}catch(r){return console.error("\u274C Error updating order item status:",r),!1}})}updateOrderStatusBasedOnItems(e){return i(this,null,function*(){try{let{data:t,error:r}=yield this.supabaseService.getSupabaseClient().from("orders").select(`
          *,
          order_items (*)
        `).eq("id",e).single();if(r)throw r;let n=this.calculateOverallOrderStatus(t.order_items),{error:s}=yield this.supabaseService.getSupabaseClient().from("orders").update({status:n,updated_at:new Date().toISOString()}).eq("id",e);if(s)throw s;return this.notificationService.notifyOrderUpdate(e),!0}catch(t){return console.error("Error updating order status:",t),!1}})}getOrderProgress(e){let t=e.filter(a=>a.status!=="out_of_stock"&&a.status!=="cancelled"),r=t.filter(a=>a.status==="ready"||a.status==="served").length,n=t.length,s=n>0?r/n*100:0;return{completed:r,total:n,percentage:s}}loadOrders(){return i(this,null,function*(){try{let e=yield this.getCurrentRestaurantId();if(!e){console.log("No restaurant found");return}let{data:t,error:r}=yield this.supabaseService.getSupabaseClient().from("orders").select("*").eq("restaurant_id",e).order("created_at",{ascending:!1});if(r){console.error("Error loading orders:",r);return}console.log("Orders loaded:",t?.length),this.dataSubject.next(t||[])}catch(e){console.error("Error in loadOrders:",e)}})}getTodayOrders(){return i(this,null,function*(){try{let e=yield this.getCurrentRestaurantId();if(!e)return{count:0,revenue:0};let t=new Date,r=new Date(t.setHours(0,0,0,0)).toISOString(),n=new Date(t.setHours(23,59,59,999)).toISOString(),{data:s,error:a}=yield this.supabaseService.getSupabaseClient().from("orders").select("id, total_amount, status").eq("restaurant_id",e).gte("created_at",r).lte("created_at",n);if(a)return console.error("\u274C Error fetching today orders:",a),{count:0,revenue:0};let o=s?.filter(d=>d.status==="completed")||[],u=o.reduce((d,O)=>d+(O.total_amount||0),0);return{count:o.length,revenue:u}}catch(e){return console.error("\u274C Error in getTodayOrders:",e),{count:0,revenue:0}}})}getLast7DaysSales(){return i(this,null,function*(){try{let e=yield this.getCurrentRestaurantId();if(!e)return[];let t=[];for(let a=6;a>=0;a--){let o=new Date;o.setDate(o.getDate()-a),t.push(o.toISOString().split("T")[0])}let{data:r,error:n}=yield this.supabaseService.getSupabaseClient().from("orders").select("created_at, total_amount, status").eq("restaurant_id",e).eq("status","completed").gte("created_at",t[0]).lte("created_at",t[6]+"T23:59:59.999Z");if(n)return console.error("\u274C Error fetching last 7 days sales:",n),this.getEmptySalesData(t);let s=new Map;return t.forEach(a=>s.set(a,0)),r?.forEach(a=>{let o=a.created_at.split("T")[0];s.has(o)&&s.set(o,s.get(o)+(a.total_amount||0))}),t.map(a=>({day:this.formatChartDay(a),amount:s.get(a)||0}))}catch(e){return console.error("\u274C Error in getLast7DaysSales:",e),this.getEmptySalesData()}})}getTopDishes(e=5){return i(this,null,function*(){try{let t=yield this.getCurrentRestaurantId();if(!t)return[];let{data:r,error:n}=yield this.supabaseService.getSupabaseClient().from("order_items").select(`
        dish_id,
        quantity,
        dishes!inner (
          name,
          base_price,
          restaurant_id
        )
      `).eq("dishes.restaurant_id",t).limit(1e3);if(n)return console.error("\u274C Error fetching top dishes:",n),[];let s=new Map;return r?.forEach(a=>{let o=a.dish_id,u=a.dishes;s.has(o)||s.set(o,{name:u.name,quantity:0,revenue:0});let d=s.get(o);d.quantity+=a.quantity,d.revenue+=a.quantity*(u.base_price||0)}),Array.from(s.entries()).map(([a,o])=>({dish_id:a,name:o.name,quantity:o.quantity,revenue:o.revenue})).sort((a,o)=>o.quantity-a.quantity).slice(0,e)}catch(t){return console.error("\u274C Error in getTopDishes:",t),[]}})}getCurrentOrders(){return this.dataSubject.value.filter(t=>["pending","confirmed","in_progress","preparing","ready","active","open"].includes(t.status))}getOrderItemsCount(e){return i(this,null,function*(){try{let{data:t,error:r}=yield this.supabaseService.getSupabaseClient().from("order_items").select("id").eq("order_id",e);return r?(console.error("\u274C Error counting order items:",r),0):t?.length||0}catch(t){return console.error("\u274C Error in getOrderItemsCount:",t),0}})}getEmptySalesData(e){let t=[];for(let r=6;r>=0;r--){let n=new Date;n.setDate(n.getDate()-r),t.push(this.formatChartDay(n.toISOString().split("T")[0]))}return(e||t).map(r=>({day:this.formatChartDay(r),amount:0}))}formatChartDay(e){return new Date(e).toLocaleDateString("it-IT",{weekday:"short",day:"numeric"})}calculateOverallOrderStatus(e){if(!e||e.length===0)return"received";let t={waiting:0,preparing:0,ready:0,served:0,out_of_stock:0};return e.forEach(r=>{t.hasOwnProperty(r.status)&&t[r.status]++}),t.ready>0?"ready":t.preparing>0?"preparing":t.waiting>0?"waiting":t.served===e.length?"served":t.out_of_stock===e.length?"cancelled":"received"}updateOrderItemStatusDirect(e,t){return i(this,null,function*(){try{console.log(`\u{1F504} Direct update for item ${e} to ${t}`);let{error:r}=yield this.supabaseService.getSupabaseClient().from("order_items").update({status:t}).eq("id",e);return r?(console.error("\u274C Direct update error:",r),yield this.tryAlternativeUpdate(e,t)):(console.log("\u2705 Direct update successful"),!0)}catch(r){return console.error("\u274C Error in direct update:",r),!1}})}tryAlternativeUpdate(e,t){return i(this,null,function*(){try{let{error:r}=yield this.supabaseService.getSupabaseClient().from("order_items").update({status:t}).eq("id",e);return r?(console.error("\u274C Alternative update also failed:",r),!1):!0}catch(r){return console.error("\u274C Error in alternative update:",r),!1}})}checkTableStructure(){return i(this,null,function*(){try{let{data:e,error:t}=yield this.supabaseService.getSupabaseClient().from("order_items").select("*").limit(1);t?console.error("\u274C Error checking table structure:",t):(console.log("\u{1F50D} Order items table structure sample:",e),e&&e.length>0&&console.log("\u{1F4CA} Available columns:",Object.keys(e[0])))}catch(e){console.error("\u274C Error in checkTableStructure:",e)}})}areAllItemsServed(e){return!e||!e.order_items||e.order_items.length===0?!1:e.order_items.every(t=>t.status==="served"||t.status==="out_of_stock")}static \u0275fac=(()=>{let e;return function(r){return(e||(e=b(c)))(r||c)}})();static \u0275prov=l({token:c,factory:c.\u0275fac,providedIn:"root"})};export{g as a,S as b};
