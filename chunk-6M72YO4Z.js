import{b,d as f}from"./chunk-Z644G36S.js";import{Z as _,ca as g,g as h}from"./chunk-DE3VKQQR.js";import{a as c,b as m,j as n}from"./chunk-4ZZIO3ZI.js";var y=class d{supabaseService=g(b);auth=g(f);restaurantSubject=new h(null);restaurant$=this.restaurantSubject.asObservable();loadRestaurantById(e){return n(this,null,function*(){try{let r=this.supabaseService.getSupabaseClient(),{data:t,error:a}=yield r.from("restaurants").select("*").eq("id",e).eq("is_active",!0).single();if(a)throw a;if(t){if(t.logo_url&&!t.logo_url.startsWith("http")){let{data:{publicUrl:s}}=r.storage.from("restaurant-images").getPublicUrl(t.logo_url);t.logo_url=s}if(t.cover_image_url){let{data:{publicUrl:s}}=r.storage.from("restaurant-images").getPublicUrl(t.cover_image_url);t.cover_image_url=s}}return t}catch(r){return console.error("\u274C Error loading restaurant by ID:",r),null}})}loadRestaurant(e){return n(this,null,function*(){let r=yield this.loadRestaurantById(e);return this.restaurantSubject.next(r),r})}loadRestaurantsByCuisine(e){return n(this,null,function*(){try{let r=this.supabaseService.getSupabaseClient().from("restaurants").select("*").eq("is_active",!0).order("name");e&&(r=r.eq("cuisine_type",e));let{data:t,error:a}=yield r;if(a)throw a;return t||[]}catch(r){return console.error("\u274C Error loading restaurants:",r),[]}})}loadRestaurantShifts(e){return n(this,null,function*(){try{let{data:r,error:t}=yield this.supabaseService.getSupabaseClient().from("shifts").select("*").eq("restaurant_id",e).eq("is_active",!0).order("start_time");if(t)throw t;return r||[]}catch(r){return console.error("\u274C Error loading restaurant shifts:",r),[]}})}loadRestaurantDishes(t){return n(this,arguments,function*(e,r={}){let{includeCategories:a=!1,onlyActive:s=!0}=r;try{let o=this.supabaseService.getSupabaseClient().from("dishes").select(`
          id,
          name,
          description,
          base_price,
          delivery_price,
          takeaway_price,
          image_url,
          preparation_time,
          status,
          category_id,
          categories ( id, name )
        `).eq("restaurant_id",e);s&&(o=o.eq("status","available"));let{data:u,error:l}=yield o.order("name");if(l)throw l;return(u||[]).map(i=>{let p={id:i.id,name:i.name,description:i.description,base_price:i.base_price,delivery_price:i.delivery_price,takeaway_price:i.takeaway_price,image_url:i.image_url,preparation_time:i.preparation_time,status:i.status,category_id:i.category_id};return a&&i.categories&&i.categories.length>0&&(p.category_name=i.categories[0].name),p})}catch(o){return console.error("\u274C Error loading restaurant dishes:",o),[]}})}loadRestaurantCategories(e){return n(this,null,function*(){try{let{data:r,error:t}=yield this.supabaseService.getSupabaseClient().from("categories").select("*").eq("restaurant_id",e).order("order_index");if(t)throw t;return r||[]}catch(r){return console.error("\u274C Error loading restaurant categories:",r),[]}})}loadRestaurantPhotos(e){return n(this,null,function*(){try{let r=this.supabaseService.getSupabaseClient(),{data:t,error:a}=yield r.from("restaurant_photos").select("file_path").eq("restaurant_id",e).order("display_order",{ascending:!0});if(a)throw a;return(t||[]).map(s=>r.storage.from("restaurant-images").getPublicUrl(s.file_path).data.publicUrl)}catch(r){return console.error("\u274C Error loading restaurant photos:",r),[]}})}loadRestaurantMenus(e){return n(this,null,function*(){try{let{data:r,error:t}=yield this.supabaseService.getSupabaseClient().from("menus").select("*").eq("restaurant_id",e).eq("is_active",!0).order("display_order");if(t)throw t;return r||[]}catch(r){return console.error("\u274C Error loading restaurant menus:",r),[]}})}loadMenuDishes(e){return n(this,null,function*(){try{let{data:r,error:t}=yield this.supabaseService.getSupabaseClient().from("menu_dishes").select(`
          dish:dishes!dish_id (
            id, name, description, base_price, delivery_price,
            takeaway_price, image_url, preparation_time, status, category_id
          )
        `).eq("menu_id",e).eq("is_active",!0).order("display_order");if(t)throw t;return(r||[]).filter(a=>a.dish&&!a.dish.deleted_at).map(a=>a.dish)}catch(r){return console.error("\u274C Error loading menu dishes:",r),[]}})}loadActiveMenuDishes(e){return n(this,null,function*(){try{let r=this.supabaseService.getSupabaseClient(),{data:t,error:a}=yield r.from("menus").select("id").eq("restaurant_id",e).eq("is_active",!0);if(a)throw a;if(!t?.length)return[];let s=t.map(i=>i.id),{data:o,error:u}=yield r.from("menu_dishes").select(`
          dish:dishes!dish_id (
            id, name, description, base_price, delivery_price,
            takeaway_price, image_url, preparation_time, status, category_id
          )
        `).in("menu_id",s).eq("is_active",!0);if(u)throw u;let l=new Map;return(o||[]).forEach(i=>{i.dish&&!i.dish.deleted_at&&i.dish.status==="available"&&l.set(i.dish.id,i.dish)}),Array.from(l.values())}catch(r){return console.error("\u274C Error loading active menu dishes:",r),[]}})}getRestaurantFloorPlans(e){return n(this,null,function*(){try{let{data:r,error:t}=yield this.supabaseService.getSupabaseClient().from("restaurant_floor_plans").select("id, name").eq("restaurant_id",e).eq("is_active",!0).order("name");if(t)throw t;return r||[]}catch(r){return console.error("\u274C Error loading floor plans:",r),[]}})}getCurrentRestaurantId(){return n(this,null,function*(){return this.auth.getCurrentStaffRestaurantId()})}loadCurrentRestaurant(){return n(this,null,function*(){let e=yield this.getCurrentRestaurantId();return e?this.loadRestaurantById(e):null})}updateRestaurant(e,r){return n(this,null,function*(){try{let t=this.supabaseService.getSupabaseClient(),{error:a}=yield t.from("restaurants").update(m(c({},r),{updated_at:new Date().toISOString()})).eq("id",e);if(a)throw a;let s=this.restaurantSubject.value;return s&&s.id===e?this.restaurantSubject.next(c(c({},s),r)):yield this.loadRestaurant(e),!0}catch(t){return console.error("\u274C Error updating restaurant:",t),!1}})}uploadLogo(e){return n(this,null,function*(){let r=yield this.getCurrentRestaurantId();if(!r)return null;let t=this.supabaseService.getSupabaseClient(),a=`restaurants/${r}/logos/${Date.now()}_${e.name}`;try{let{error:s}=yield t.storage.from("restaurant-images").upload(a,e,{upsert:!0});if(s)throw s;let{data:{publicUrl:o}}=t.storage.from("restaurant-images").getPublicUrl(a);return(yield this.updateRestaurant(r,{logo_url:o}))?o:null}catch(s){return console.error("\u274C Error uploading logo:",s),null}})}removeLogo(){return n(this,null,function*(){let e=yield this.getCurrentRestaurantId();return e?this.updateRestaurant(e,{logo_url:null}):!1})}geocodeAddress(e,r){return n(this,null,function*(){if(!e||!r)return null;let a=`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(`${e}, ${r}, Italia`)}&limit=1`;try{let o=yield(yield fetch(a,{headers:{"User-Agent":"Platea/1.0"}})).json();if(Array.isArray(o)&&o.length>0){let{lat:u,lon:l}=o[0];return{lat:parseFloat(u),lng:parseFloat(l)}}return null}catch(s){return console.error("\u274C Errore geocoding:",s),null}})}static \u0275fac=function(r){return new(r||d)};static \u0275prov=_({token:d,factory:d.\u0275fac,providedIn:"root"})};export{y as a};
