import{a as D}from"./chunk-E6M32VL2.js";import{a as q}from"./chunk-GS53O7WG.js";import{b as O,d as C}from"./chunk-N3KHNVQY.js";import{M as S,R as w,g as i,ga as g,la as m,m as b}from"./chunk-HCHBVVTJ.js";var h=class d{supabaseService=m(O);authService=m(C);generateTavolataId(){return typeof crypto<"u"&&crypto.randomUUID?crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(r){let e=Math.random()*16|0;return(r==="x"?e:e&3|8).toString(16)})}getCurrentTavolataId(r){return i(this,null,function*(){try{let e=yield this.getCurrentRestaurantId();if(!e)return null;let{data:t,error:a}=yield this.supabaseService.getSupabaseClient().from("orders").select("tavolata_id, status").eq("restaurant_id",e).eq("table_id",r).not("status","in",'("completed", "cancelled", "paid")').order("created_at",{ascending:!1}).limit(1);return a?(console.error("\u274C Error getting current tavolata:",a),null):(console.log("\u{1F4CB} Tavolata corrente trovata:",t?.[0]?.tavolata_id),t&&t.length>0?t[0].tavolata_id:null)}catch(e){return console.error("Error getting current tavolata:",e),null}})}startNewTavolata(r){return i(this,null,function*(){try{let e=this.generateTavolataId();return console.log("\u{1F195} Creazione nuova tavolata:",e,"per tavolo:",r),e}catch(e){return console.error("\u274C Errore in startNewTavolata:",e),`tavolata_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}})}isTavolataActive(r){return i(this,null,function*(){try{let{data:e,error:t}=yield this.supabaseService.getSupabaseClient().from("orders").select("id").eq("tavolata_id",r).not("status","in",'("completed", "cancelled", "paid")').limit(1);if(t)throw t;return e&&e.length>0||!1}catch(e){return console.error("Error checking tavolata:",e),!1}})}getCurrentRestaurantId(){return i(this,null,function*(){let r=this.authService.currentUserValue;if(!r)return console.error("Nessun utente autenticato"),null;let e=this.authService.getCurrentStaffRestaurantId();if(e)return e;try{let{data:t,error:a}=yield this.supabaseService.getSupabaseClient().from("restaurants").select("id").eq("owner_id",r.id).limit(1).single();return a?(console.error("Error getting restaurant by owner:",a),null):t?.id||null}catch(t){return console.error("Exception getting restaurant:",t),null}})}static \u0275fac=function(e){return new(e||d)};static \u0275prov=g({token:d,factory:d.\u0275fac,providedIn:"root"})};var f=class d{orderUpdatesSubject=new b;orderUpdates$=this.orderUpdatesSubject.asObservable();tableUpdatesSubject=new b;tableUpdates$=this.tableUpdatesSubject.asObservable();notifyOrderUpdate(r){this.orderUpdatesSubject.next(r)}notifyTableUpdate(r){this.tableUpdatesSubject.next(r)}notifyDataChange(){this.orderUpdatesSubject.next("refresh_all")}static \u0275fac=function(e){return new(e||d)};static \u0275prov=g({token:d,factory:d.\u0275fac,providedIn:"root"})};var E=class d extends q{shiftService=m(D);notificationService=m(f);tavolataService=m(h);operationLocks=new Map;getTableName(){return"orders"}constructor(){super(),this.authService.currentUser$.pipe(S(r=>!!r),w(1)).subscribe(()=>{this.loadData()})}createOrder(r,e){return i(this,null,function*(){try{if(console.log("\u{1F4DD} Creazione ordine per tavolo:",r),!this.authService.currentUserValue)return null;let a=yield this.getCurrentRestaurantId();if(!a)return null;let n=yield this.tavolataService.getCurrentTavolataId(r);n||(n=yield this.tavolataService.startNewTavolata(r));let o=yield this.getNextComandaNumber(r,n),s={restaurant_id:a,table_id:r,tavolata_id:n,comanda_number:o,order_number:`ORD-${Date.now()}-${o}`,order_type:"dine_in",status:"received",subtotal:0,tax_amount:0,discount_amount:0,total_amount:0,customer_name:e?.customer_name||"Cliente",customer_phone:e?.customer_phone||"",created_at:new Date().toISOString(),updated_at:new Date().toISOString()},{data:c,error:u}=yield this.supabaseService.getSupabaseClient().from("orders").insert(s).select().single();return u?null:(console.log("\u2705 Ordine creato:",c.id),c)}catch(t){return console.error("\u274C Errore createOrder:",t),null}})}addDishToOrder(r,e,t=1,a){return i(this,null,function*(){let n=`add-${r}-${e.id}-${a||"no-notes"}`;this.operationLocks.has(n)&&(console.log("\u23F3 Operazione gi\xE0 in corso, attendo..."),yield this.operationLocks.get(n));let o,s=new Promise(c=>{o=c});this.operationLocks.set(n,s);try{let c=a?.trim()||null;console.log("\u2795 Aggiunta piatto:",e.name||"Senza nome","a ordine:",r,"note:",c);let u=this.supabaseService.getSupabaseClient().from("order_items").select("*").eq("order_id",r).eq("dish_id",e.id);c===null?u=u.or("item_notes.is.null,item_notes.eq."):u=u.eq("item_notes",c);let{data:p,error:y}=yield u.limit(1);if(y&&console.error("\u274C Errore nel fetch degli item esistenti:",y),p&&p.length>0){let l=p[0],v=l.quantity+t;console.log(`\u{1F504} Aggiornamento item esistente ${l.id}: ${l.quantity} \u2192 ${v}`);let{error:_}=yield this.supabaseService.getSupabaseClient().from("order_items").update({quantity:v,updated_at:new Date().toISOString()}).eq("id",l.id);if(_)throw console.error("\u274C Errore nell'aggiornamento:",_),_}else{console.log("\u{1F195} Creazione nuovo item per piatto:",e.name||"Senza nome");let{error:l}=yield this.supabaseService.getSupabaseClient().from("order_items").insert({order_id:r,dish_id:e.id,quantity:t,unit_price:e.base_price,status:"waiting",item_notes:c,created_at:new Date().toISOString(),updated_at:new Date().toISOString()});if(l)throw console.error("\u274C Errore nell'inserimento:",l),l}return yield this.updateOrderTotal(r),this.notificationService.notifyOrderUpdate(r),console.log("\u2705 Piatto aggiunto con successo"),!0}catch(c){return console.error("\u274C Errore addDishToOrder:",c),!1}finally{o(null),this.operationLocks.delete(n)}})}refreshOrder(r){return i(this,null,function*(){try{let{data:e,error:t}=yield this.supabaseService.getSupabaseClient().from("orders").select(`
        *,
        order_items (*,
          dishes (
            id,
            name, 
            base_price,
            category_id
          )
        )
      `).eq("id",r).single();return t?(console.error("\u274C Errore refreshOrder:",t),null):e}catch(e){return console.error("\u274C Errore refreshOrder:",e),null}})}getTableOrders(r,e){return i(this,null,function*(){try{let t=yield this.getCurrentRestaurantId();if(!t)return[];let a=this.supabaseService.getSupabaseClient().from("orders").select(`
          *,
          order_items (*,
            dishes (name, base_price, category_id)
          )
        `).eq("restaurant_id",t).eq("table_id",r).not("status","in",'("completed", "cancelled")').order("comanda_number",{ascending:!0});e&&(a=a.eq("tavolata_id",e));let{data:n,error:o}=yield a;return o?(console.error("\u274C Errore getTableOrders:",o),[]):n||[]}catch(t){return console.error("\u274C Errore getTableOrders:",t),[]}})}updateOrderTotal(r){return i(this,null,function*(){try{let{data:e,error:t}=yield this.supabaseService.getSupabaseClient().from("order_items").select("quantity, unit_price").eq("order_id",r);if(t)return console.error("\u274C Errore nel calcolo del totale:",t),!1;let a=e?.reduce((o,s)=>o+s.quantity*s.unit_price,0)||0,{error:n}=yield this.supabaseService.getSupabaseClient().from("orders").update({subtotal:a,total_amount:a,updated_at:new Date().toISOString()}).eq("id",r);return n?(console.error("\u274C Errore nell'aggiornamento del totale:",n),!1):!0}catch(e){return console.error("\u274C Errore updateOrderTotal:",e),!1}})}closeTavolata(r,e){return i(this,null,function*(){try{let{error:t}=yield this.supabaseService.getSupabaseClient().from("orders").update({status:"completed",updated_at:new Date().toISOString()}).eq("table_id",r).eq("tavolata_id",e).not("status","in",'("completed", "cancelled")');return t?(console.error("\u274C Errore closeTavolata:",t),!1):(console.log("\u2705 Tavolata chiusa:",e),!0)}catch(t){return console.error("\u274C Errore closeTavolata:",t),!1}})}getNextComandaNumber(r,e){return i(this,null,function*(){try{let t=yield this.getCurrentRestaurantId();if(!t)return 1;let{data:a}=yield this.supabaseService.getSupabaseClient().from("orders").select("comanda_number").eq("restaurant_id",t).eq("table_id",r).eq("tavolata_id",e).order("comanda_number",{ascending:!1}).limit(1);return a&&a.length>0?a[0].comanda_number+1:1}catch(t){return console.error("\u274C Errore getNextComandaNumber:",t),1}})}calculateOverallOrderStatus(r){return!r||r.length===0?"received":r.every(e=>e.status==="served")?"served":r.some(e=>e.status==="ready")?"ready":r.some(e=>e.status==="preparing")?"preparing":"received"}areAllItemsServed(r){return!r?.order_items||r.order_items.length===0?!1:r.order_items.every(e=>e.status==="served"||e.status==="out_of_stock")}getTodayOrders(){return i(this,null,function*(){try{let r=yield this.getCurrentRestaurantId();if(!r)return{count:0,revenue:0};let e=new Date,t=new Date(e.setHours(0,0,0,0)).toISOString(),a=new Date(e.setHours(23,59,59,999)).toISOString(),{data:n,error:o}=yield this.supabaseService.getSupabaseClient().from("orders").select("id, total_amount, status").eq("restaurant_id",r).gte("created_at",t).lte("created_at",a);if(o)return console.error("Error fetching today orders:",o),{count:0,revenue:0};let s=n?.filter(u=>u.status==="completed")||[],c=s.reduce((u,p)=>u+(p.total_amount||0),0);return{count:s.length,revenue:c}}catch(r){return console.error("Error in getTodayOrders:",r),{count:0,revenue:0}}})}getLast7DaysSales(){return i(this,null,function*(){try{let r=yield this.getCurrentRestaurantId();if(!r)return[];let e=[];for(let o=6;o>=0;o--){let s=new Date;s.setDate(s.getDate()-o),e.push(s.toISOString().split("T")[0])}let{data:t,error:a}=yield this.supabaseService.getSupabaseClient().from("orders").select("created_at, total_amount, status").eq("restaurant_id",r).eq("status","completed").gte("created_at",e[0]).lte("created_at",e[6]+"T23:59:59.999Z");if(a)return console.error("Error fetching last 7 days sales:",a),this.getEmptySalesData(e);let n=new Map;return e.forEach(o=>n.set(o,0)),t?.forEach(o=>{let s=o.created_at.split("T")[0];n.has(s)&&n.set(s,n.get(s)+(o.total_amount||0))}),e.map(o=>({day:this.formatChartDay(o),amount:n.get(o)||0}))}catch(r){return console.error("Error in getLast7DaysSales:",r),this.getEmptySalesData()}})}getTopDishes(r=5){return i(this,null,function*(){try{let e=yield this.getCurrentRestaurantId();if(!e)return[];let{data:t,error:a}=yield this.supabaseService.getSupabaseClient().from("order_items").select(`
          dish_id,
          quantity,
          dishes!inner (
            name,
            base_price,
            restaurant_id
          )
        `).eq("dishes.restaurant_id",e).limit(1e3);if(a)return console.error("Error fetching top dishes:",a),[];let n=new Map;return t?.forEach(o=>{let s=o.dish_id,c=o.dishes;n.has(s)||n.set(s,{name:c.name,quantity:0,revenue:0});let u=n.get(s);u.quantity+=o.quantity,u.revenue+=o.quantity*(c.base_price||0)}),Array.from(n.entries()).map(([o,s])=>({dish_id:o,name:s.name,quantity:s.quantity,revenue:s.revenue})).sort((o,s)=>s.quantity-o.quantity).slice(0,r)}catch(e){return console.error("Error in getTopDishes:",e),[]}})}getEmptySalesData(r){let e=[];for(let t=6;t>=0;t--){let a=new Date;a.setDate(a.getDate()-t),e.push(this.formatChartDay(a.toISOString().split("T")[0]))}return(r||e).map(t=>({day:this.formatChartDay(t),amount:0}))}formatChartDay(r){return new Date(r).toLocaleDateString("it-IT",{weekday:"short",day:"numeric"})}getActiveOrders(){return i(this,null,function*(){try{let r=yield this.getCurrentRestaurantId();if(!r)return[];let{data:e,error:t}=yield this.supabaseService.getSupabaseClient().from("orders").select(`
          *,
          order_items (
            *,
            dishes (name, base_price)
          )
        `).eq("restaurant_id",r).not("status","in",'("completed", "cancelled")').order("created_at",{ascending:!1});return t?(console.error("Error loading active orders:",t),[]):e||[]}catch(r){return console.error("Error in getActiveOrders:",r),[]}})}getOrderItemsCount(r){return i(this,null,function*(){try{let{data:e,error:t}=yield this.supabaseService.getSupabaseClient().from("order_items").select("id").eq("order_id",r);return t?(console.error("Error counting order items:",t),0):e?.length||0}catch(e){return console.error("Error in getOrderItemsCount:",e),0}})}updateOrderItemQuantity(r,e){return i(this,null,function*(){if(r&&r.startsWith("temp-"))return console.warn("\u274C Tentativo di aggiornare item temporaneo:",r),!1;let t=`update-${r}`;this.operationLocks.has(t)&&(yield this.operationLocks.get(t));let a,n=new Promise(o=>{a=o});this.operationLocks.set(t,n);try{let{data:o,error:s}=yield this.supabaseService.getSupabaseClient().from("order_items").select("quantity, order_id").eq("id",r).single();if(s)throw s;let c=o.quantity+e;if(c<1)return yield this.deleteOrderItem(r);let{error:u}=yield this.supabaseService.getSupabaseClient().from("order_items").update({quantity:c,updated_at:new Date().toISOString()}).eq("id",r);if(u)throw u;return yield this.updateOrderTotal(o.order_id),this.notificationService.notifyOrderUpdate(o.order_id),!0}catch(o){return console.error("\u274C Errore updateOrderItemQuantity:",o),!1}finally{a(null),this.operationLocks.delete(t)}})}deleteOrderItem(r){return i(this,null,function*(){try{let{data:e,error:t}=yield this.supabaseService.getSupabaseClient().from("order_items").select("order_id").eq("id",r).single();if(t)throw t;let{error:a}=yield this.supabaseService.getSupabaseClient().from("order_items").delete().eq("id",r);if(a)throw a;return yield this.updateOrderTotal(e.order_id),!0}catch(e){return console.error("\u274C Error deleting order item:",e),!1}})}updateOrderItemStatus(r,e){return i(this,null,function*(){try{let{error:t}=yield this.supabaseService.getSupabaseClient().from("order_items").update({status:e,updated_at:new Date().toISOString()}).eq("id",r);if(t)return console.error("\u274C Error updating order item:",t),!1;let{data:a}=yield this.supabaseService.getSupabaseClient().from("order_items").select("order_id").eq("id",r).single();return a&&this.notificationService.notifyOrderUpdate(a.order_id),!0}catch(t){return console.error("\u274C Error updating order item status:",t),!1}})}createOrderForHeader(r,e,t){return i(this,null,function*(){try{let a=yield this.getCurrentRestaurantId();if(!a)return null;let{data:n}=yield this.supabaseService.getSupabaseClient().from("orders").select("comanda_number").eq("order_header_id",e).order("comanda_number",{ascending:!1}).limit(1),o=n&&n.length>0?n[0].comanda_number+1:1,s={restaurant_id:a,table_id:r,order_header_id:e,tavolata_id:t,comanda_number:o,order_number:`COM-${Date.now()}-${o}`,order_type:"dine_in",status:"received",subtotal:0,tax_amount:0,discount_amount:0,total_amount:0,customer_name:"Cliente",customer_phone:"",created_at:new Date().toISOString(),updated_at:new Date().toISOString()},{data:c,error:u}=yield this.supabaseService.getSupabaseClient().from("orders").insert(s).select().single();if(u)throw u;return c}catch(a){return console.error("Errore creazione comanda:",a),null}})}calculateOrderTotal(r){return!r.order_items||r.order_items.length===0?0:r.order_items.reduce((e,t)=>e+(t.total_price||0),0)}calculateTavolataTotal(r){return r.reduce((e,t)=>{let a=this.calculateOrderHeaderTotal(t);return e+a},0)}getOrderHeadersByTavolata(r){return i(this,null,function*(){try{let{data:e,error:t}=yield this.supabaseService.getSupabaseClient().from("order_headers").select(`
        *,
        orders (*,
          order_items (*,
            dishes (name, base_price, category_id)
          )
        )
      `).eq("tavolata_id",r).order("created_at",{ascending:!0});if(t)throw t;return e||[]}catch(e){return console.error("Errore caricamento order_headers:",e),[]}})}createNewOrder(r,e){return i(this,null,function*(){try{let t=yield this.getCurrentRestaurantId();if(!t)return null;let a={restaurant_id:t,table_id:r,tavolata_id:e,order_number:`ORD-${Date.now()}-${Math.floor(Math.random()*1e3)}`,status:"active",customer_name:"Cliente",customer_phone:"",total_amount:0,created_at:new Date().toISOString(),updated_at:new Date().toISOString()},{data:n,error:o}=yield this.supabaseService.getSupabaseClient().from("order_headers").insert(a).select().single();if(o)throw o;let s=yield this.createOrderForHeader(r,n.id,e);return{header:n,order:s}}catch(t){return console.error("Errore creazione nuovo ordine:",t),null}})}calculateOrderHeaderTotal(r){return!r.orders||r.orders.length===0?0:r.orders.reduce((e,t)=>{let a=this.calculateOrderTotal(t);return e+a},0)}static \u0275fac=function(e){return new(e||d)};static \u0275prov=g({token:d,factory:d.\u0275fac,providedIn:"root"})};export{f as a,h as b,E as c};
