import{b as S,d as m}from"./chunk-N3KHNVQY.js";import{M as h,R as l,a as o,b as u,g as i,ga as d,la as c,n as f}from"./chunk-HCHBVVTJ.js";var p=class n{supabaseService=c(S);authService=c(m);shiftsSubject=new f([]);shifts$=this.shiftsSubject.asObservable();constructor(){this.authService.currentUser$.pipe(h(e=>!!e),l(1)).subscribe(()=>{this.loadShifts()})}loadShifts(){return i(this,null,function*(){try{let e=yield this.getCurrentRestaurantId();if(!e){console.error("\u274C No restaurant found");return}let{data:t,error:r}=yield this.supabaseService.getSupabaseClient().from("shifts").select("*").eq("restaurant_id",e).order("start_time");if(r){console.error("Error loading shifts:",r);return}if(!t||t.length===0){yield this.createDefaultShifts(e),yield this.loadShifts();return}this.shiftsSubject.next(t)}catch(e){console.error("Error in loadShifts:",e)}})}createDefaultShifts(e){return i(this,null,function*(){let t=[{restaurant_id:e,name:"Pranzo",start_time:"12:00:00",end_time:"15:00:00",days_of_week:[1,2,3,4,5,6,7],is_active:!0},{restaurant_id:e,name:"Cena",start_time:"19:00:00",end_time:"23:00:00",days_of_week:[1,2,3,4,5,6,7],is_active:!0}];try{let{error:r}=yield this.supabaseService.getSupabaseClient().from("shifts").insert(t);if(r)throw r;console.log("\u2705 Default shifts created")}catch(r){console.error("\u274C Error creating default shifts:",r)}})}getShifts(){return this.shiftsSubject.value}getCurrentShift(){let e=new Date,t=e.toTimeString().split(" ")[0],r=e.getDay(),a=r===0?7:r,g=this.getShifts().filter(s=>s.is_active);for(let s of g)if(s.days_of_week.includes(a)&&t>=s.start_time&&t<=s.end_time)return s;return null}createShift(e){return i(this,null,function*(){try{let t=yield this.getCurrentRestaurantId();if(!t)return console.error("\u274C No restaurant found"),null;let{data:r,error:a}=yield this.supabaseService.getSupabaseClient().from("shifts").insert(u(o({},e),{restaurant_id:t})).select().single();if(a)throw a;return yield this.loadShifts(),r}catch(t){return console.error("Error creating shift:",t),null}})}updateShift(e,t){return i(this,null,function*(){try{let{error:r}=yield this.supabaseService.getSupabaseClient().from("shifts").update(u(o({},t),{updated_at:new Date().toISOString()})).eq("id",e);if(r)throw r;return yield this.loadShifts(),!0}catch(r){return console.error("Error updating shift:",r),!1}})}getCurrentRestaurantId(){return i(this,null,function*(){let e=this.authService.getCurrentStaffRestaurantId();if(e)return e;let t=this.authService.currentUserValue;if(!t)return null;let{data:r}=yield this.supabaseService.getSupabaseClient().from("restaurants").select("id").eq("owner_id",t.id).limit(1).single();return r?.id||null})}deleteShift(e){return i(this,null,function*(){try{let{error:t}=yield this.supabaseService.getSupabaseClient().from("shifts").delete().eq("id",e);if(t)throw t;return yield this.loadShifts(),!0}catch(t){return console.error("Error deleting shift:",t),!1}})}static \u0275fac=function(t){return new(t||n)};static \u0275prov=d({token:n,factory:n.\u0275fac,providedIn:"root"})};export{p as a};
