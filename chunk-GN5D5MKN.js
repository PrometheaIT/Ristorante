import{a as P}from"./chunk-6RSBAXEF.js";import{eb as Y,fb as Z}from"./chunk-GDRKFSJ5.js";import{a as te}from"./chunk-ZUZCAAJK.js";import{a as ee}from"./chunk-FH5TYEUV.js";import{b as B,c as v,d as G,e as q,h as A,i as W,m as $,p as j,q as U,r as H,s as Q,w as J,x as K,y as X}from"./chunk-D6L6OQLW.js";import{d as O}from"./chunk-SMFU76LW.js";import"./chunk-TSK5DXKO.js";import{j as M,k,u as D}from"./chunk-WSJCHGNS.js";import{Bb as _,Ea as I,Fb as F,Gb as V,Ha as s,Hb as R,Nb as a,Ob as E,Pb as b,Tb as N,U as T,Ub as z,Vb as L,Xa as C,ab as h,ca as y,f as x,ia as p,ja as d,nb as c,ob as o,pb as r,qb as f,wb as w,zb as g}from"./chunk-QIXMMTC2.js";import{j as S}from"./chunk-4ZZIO3ZI.js";var re=["logoInput"];function oe(l,e){if(l&1&&(o(0,"option",43),a(1),r()),l&2){let t=e.$implicit;c("value",t),s(),E(t)}}function ne(l,e){if(l&1&&(o(0,"option",43),a(1),r()),l&2){let t=e.$implicit;c("value",t.code),s(),E(t.name)}}function ae(l,e){if(l&1&&f(0,"img",44),l&2){let t=_();c("src",t.logoPreview,I)}}function le(l,e){l&1&&(o(0,"span",45),a(1,"add_a_photo"),r())}function se(l,e){if(l&1){let t=w();o(0,"button",46),g("click",function(){p(t);let n=_();return d(n.removeLogo())}),f(1,"lucide-angular",47),a(2," Rimuovi Logo "),r()}if(l&2){let t=_();c("disabled",t.loading),s(),c("size",20)}}function ce(l,e){l&1&&(o(0,"span",29),a(1,"sync"),r())}function me(l,e){l&1&&(o(0,"span",29),a(1,"save"),r())}function pe(l,e){if(l&1&&(o(0,"option",43),a(1),r()),l&2){let t=e.$implicit;c("value",t.id),s(),b(" ",t.title," ")}}var ie=class l{fb=y(J);restaurantService=y(ee);geographyService=y(te);tutorialService=y(P);authService=y(O);destroy$=new x;profileForm;loading=!1;logoPreview;restaurant=null;provinces=[];regions=[];filteredProvinces=[];logoInput;ngOnInit(){this.initForm(),this.loadProvinces(),this.loadRestaurantData()}ngOnDestroy(){this.destroy$.next(),this.destroy$.complete()}initForm(){this.profileForm=this.fb.group({name:["",[v.required,v.minLength(2)]],description:[""],address:["",v.required],phone:["",[v.required,v.pattern(/^[\+\d\s\-\(\)]{8,20}$/)]],email:["",[v.required,v.email]],region:[""],province:[""]})}loadProvinces(){return S(this,null,function*(){this.geographyService.getFilteredProvinces().pipe(T(this.destroy$)).subscribe(e=>{this.provinces=e,this.regions=[...new Set(e.map(t=>t.region))].filter(t=>t!=="Tutte").sort()})})}loadRestaurantData(){return S(this,null,function*(){this.loading=!0;try{this.restaurant=yield this.restaurantService.loadCurrentRestaurant(),this.restaurant&&(this.patchForm(this.restaurant),this.logoPreview=this.restaurant.logo_url||void 0)}catch(e){console.error("Errore caricamento profilo:",e)}finally{this.loading=!1}})}patchForm(e){let t=e.province,i="";if(t&&this.provinces.length){let n=this.provinces.find(m=>m.code===t);n&&(i=n.region,this.filterProvincesByRegion(i))}this.profileForm.patchValue({name:e.name,description:e.description||"",address:e.address,phone:e.phone,email:e.email,region:i,province:t||""})}filterProvincesByRegion(e){this.filteredProvinces=e?this.provinces.filter(i=>i.region===e):[];let t=this.profileForm.get("province");this.filteredProvinces.length>0?t?.enable():(t?.disable(),this.profileForm.patchValue({province:""}))}onRegionChange(e){let t=e.target.value;this.filterProvincesByRegion(t)}onProvinceChange(e){let t=e.target.value;if(t){let i=this.provinces.find(n=>n.code===t);i&&(this.profileForm.patchValue({region:i.region}),this.filterProvincesByRegion(i.region))}else this.profileForm.patchValue({region:""}),this.filteredProvinces=[]}triggerLogoInput(){this.logoInput.nativeElement.click()}onLogoSelected(e){return S(this,null,function*(){let t=e.target;if(!t.files?.length)return;let i=t.files[0];if(i.size>5*1024*1024){alert("Il file non pu\xF2 superare i 5MB");return}if(!i.type.startsWith("image/")){alert("Seleziona un file immagine");return}this.loading=!0;try{let n=yield this.restaurantService.uploadLogo(i);n&&(this.logoPreview=n,alert("Logo caricato con successo!"))}catch(n){alert("Errore caricamento logo: "+n.message)}finally{this.loading=!1,t.value=""}})}removeLogo(){return S(this,null,function*(){if(this.logoPreview&&confirm("Rimuovere il logo?")){this.loading=!0;try{(yield this.restaurantService.removeLogo())&&(this.logoPreview=void 0,alert("Logo rimosso"))}catch(e){alert("Errore: "+e.message)}finally{this.loading=!1}}})}onSubmit(){return S(this,null,function*(){if(!this.profileForm.invalid){this.loading=!0;try{let e=this.profileForm.value,t=yield this.restaurantService.getCurrentRestaurantId();if(!t)throw new Error("Ristorante non trovato");let i={name:e.name,description:e.description||null,address:e.address,phone:this.cleanPhoneNumber(e.phone),email:e.email,province:e.province||null};if(e.address&&e.province){let m=yield this.restaurantService.geocodeAddress(e.address,e.province);m?(i.latitude=m.lat,i.longitude=m.lng,console.log("\u2705 Coordinate ottenute:",m)):(console.warn("\u26A0\uFE0F Geocoding fallito, procedo senza coordinate"),alert("Indirizzo non geolocalizzato automaticamente. Puoi inserire le coordinate manualmente in seguito."))}(yield this.restaurantService.updateRestaurant(t,i))&&(alert("Profilo aggiornato!"),yield this.loadRestaurantData())}catch(e){alert("Errore salvataggio: "+e.message)}finally{this.loading=!1}}})}cleanPhoneNumber(e){return e?e.startsWith("+")?"+"+e.substring(1).replace(/\D/g,""):e.replace(/\D/g,""):""}get tutorialSteps(){return this.tutorialService.steps()}get tutorialSections(){return(this.authService.getCurrentContext()==="staff"?P.BUSINESS_STEPS:P.CUSTOMER_STEPS).filter(n=>n.requiredPermission?this.authService.hasPermission(n.requiredPermission):!0).filter(n=>n.tooltipTarget||n.subSteps&&n.subSteps.length>0)}selectedStepId=null;startSelectedTutorial(){this.selectedStepId&&this.tutorialService.startTutorialFromStep(this.selectedStepId,"single")}restartFullTutorial(){let t=this.authService.getCurrentContext()==="staff"?"business":"customer";this.tutorialService.restartTutorial(t)}static \u0275fac=function(t){return new(t||l)};static \u0275cmp=C({type:l,selectors:[["app-profile"]],viewQuery:function(t,i){if(t&1&&F(re,5),t&2){let n;V(n=R())&&(i.logoInput=n.first)}},decls:86,vars:17,consts:[["logoInput",""],[1,"page-container"],[1,"flex","flex-col","gap-sm",3,"ngSubmit","formGroup"],["data-tutorial","profile-info",1,"form-card"],[1,"form-row","mb-md"],[1,"material-icons","text-md"],[1,"text-md","font-semibold","m-0"],[1,"form-row","mb-sm"],[1,"form-group"],[1,"standard-label"],["type","text","formControlName","name","placeholder","Es: Trattoria da Mario"],["type","email","formControlName","email","placeholder","info@ristorante.it"],["type","tel","formControlName","phone","placeholder","+39 123 456 7890"],["formControlName","region",3,"change"],["value",""],[3,"value",4,"ngFor","ngForOf"],["formControlName","province",3,"change"],["type","text","formControlName","address","placeholder","Via Roma 123, Milano"],["formControlName","description","rows","3","placeholder","Racconta la storia del tuo ristorante..."],["data-tutorial","profile-logo",1,"form-card"],[1,"flex","items-center","gap-sm","mb-md"],[1,"form-row"],["type","file","accept","image/*",2,"display","none",3,"change"],[1,"flex","items-center","gap-md","flex-wrap"],[1,"logo-preview-container",2,"width","120px","height","120px","border","2px dashed var(--smoke-2)","border-radius","12px","display","flex","align-items","center","justify-content","center","overflow","hidden","background","var(--smoke-1)"],["alt","Logo","style","max-width: 100%; max-height: 100%; object-fit: contain;",3,"src",4,"ngIf"],["class","material-icons","style","font-size: 48px; color: var(--smoke-3);",4,"ngIf"],[1,"flex","flex-col","gap-sm"],["type","button",1,"promethea-button","ghost",3,"click","disabled"],[1,"material-icons"],["type","button","class","promethea-button ghost","style","color: var(--danger);",3,"disabled","click",4,"ngIf"],[1,"text-mini","text-muted"],[1,"modal-footer"],["type","submit",1,"promethea-button",3,"disabled"],["class","material-icons",4,"ngIf"],["data-tutorial","profile-actions",1,"form-row","p-sm"],["for","tutorial-step",1,"standard-label"],["id","tutorial-step",3,"ngModelChange","ngModel"],[3,"ngValue"],[1,"flex","gap-sm","items-center","p-sm"],[1,"promethea-button","primary","ml-2",3,"click","disabled"],["type","button",1,"promethea-button","outline",3,"click"],["name","play-circle",3,"size"],[3,"value"],["alt","Logo",2,"max-width","100%","max-height","100%","object-fit","contain",3,"src"],[1,"material-icons",2,"font-size","48px","color","var(--smoke-3)"],["type","button",1,"promethea-button","ghost",2,"color","var(--danger)",3,"click","disabled"],["name","trash-2",3,"size"]],template:function(t,i){if(t&1){let n=w();o(0,"div",1)(1,"form",2),g("ngSubmit",function(){return p(n),d(i.onSubmit())}),o(2,"div",3)(3,"div",4)(4,"span",5),a(5,"info"),r(),o(6,"h2",6),a(7,"Informazioni Base"),r()(),o(8,"div",7)(9,"div",8)(10,"label",9),a(11,"Nome Ristorante *"),r(),f(12,"input",10),r()(),o(13,"div",7)(14,"div",8)(15,"label",9),a(16,"Email *"),r(),f(17,"input",11),r(),o(18,"div",8)(19,"label",9),a(20,"Telefono *"),r(),f(21,"input",12),r()(),o(22,"div",7)(23,"div",8)(24,"label",9),a(25,"Regione"),r(),o(26,"select",13),g("change",function(u){return p(n),d(i.onRegionChange(u))}),o(27,"option",14),a(28,"Seleziona Regione"),r(),h(29,oe,2,2,"option",15),r()(),o(30,"div",8)(31,"label",9),a(32,"Provincia"),r(),o(33,"select",16),g("change",function(u){return p(n),d(i.onProvinceChange(u))}),o(34,"option",14),a(35,"Seleziona Provincia"),r(),h(36,ne,2,2,"option",15),r()()(),o(37,"div",8)(38,"label",9),a(39,"Indirizzo *"),r(),f(40,"input",17),r(),o(41,"div",8)(42,"label",9),a(43,"Descrizione"),r(),f(44,"textarea",18),r()(),o(45,"div",19)(46,"div",20)(47,"span",5),a(48,"image"),r(),o(49,"h2",6),a(50,"Logo Ristorante"),r()(),o(51,"div",21)(52,"div",8)(53,"input",22,0),g("change",function(u){return p(n),d(i.onLogoSelected(u))}),r(),o(55,"div",23)(56,"div",24),h(57,ae,1,1,"img",25)(58,le,2,0,"span",26),r(),o(59,"div",27)(60,"button",28),g("click",function(){return p(n),d(i.triggerLogoInput())}),o(61,"span",29),a(62,"cloud_upload"),r(),a(63),r(),h(64,se,3,2,"button",30),o(65,"span",31),a(66,"Formati: JPG, PNG, WEBP. Max 5MB."),r()()()()()(),o(67,"div",32)(68,"button",33),h(69,ce,2,0,"span",34)(70,me,2,0,"span",34),a(71),r()()(),o(72,"div",35)(73,"div",8)(74,"label",36),a(75,"Scegli una sezione da rivedere:"),r(),o(76,"select",37),L("ngModelChange",function(u){return p(n),z(i.selectedStepId,u)||(i.selectedStepId=u),d(u)}),o(77,"option",38),a(78,"-- Seleziona --"),r(),h(79,pe,2,2,"option",15),r()(),o(80,"div",39)(81,"button",40),g("click",function(){return p(n),d(i.startSelectedTutorial())}),a(82," Avvia sezione "),r(),o(83,"button",41),g("click",function(){return p(n),d(i.restartFullTutorial())}),f(84,"lucide-angular",42),a(85," Tutorial completo "),r()()()()}t&2&&(s(),c("formGroup",i.profileForm),s(28),c("ngForOf",i.regions),s(7),c("ngForOf",i.filteredProvinces),s(21),c("ngIf",i.logoPreview),s(),c("ngIf",!i.logoPreview),s(2),c("disabled",i.loading),s(3),b(" ",i.logoPreview?"Sostituisci":"Carica"," Logo "),s(),c("ngIf",i.logoPreview),s(4),c("disabled",i.loading||i.profileForm.invalid),s(),c("ngIf",i.loading),s(),c("ngIf",!i.loading),s(),b(" ",i.loading?"Salvataggio...":"Salva Profilo"," "),s(5),N("ngModel",i.selectedStepId),s(),c("ngValue",null),s(2),c("ngForOf",i.tutorialSections),s(2),c("disabled",!i.selectedStepId),s(3),c("size",18))},dependencies:[D,M,k,X,W,H,Q,B,U,G,q,$,j,Z,Y,K,A],encapsulation:2})};export{ie as Profile};
