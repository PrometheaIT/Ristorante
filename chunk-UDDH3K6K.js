import{a as p}from"./chunk-AMYEPXIV.js";import{Y as b,na as d}from"./chunk-5BU4UD4M.js";import{a as c,b as u,g as n}from"./chunk-RA2WU32H.js";var g=class l extends p{getTableName(){return"tables"}loadData(){return n(this,null,function*(){try{let e=yield this.getCurrentRestaurantId();if(!e)return;let{data:r,error:t}=yield this.supabaseService.getSupabaseClient().from(this.getTableName()).select("*").eq("restaurant_id",e).eq("is_active",!0).order("created_at",{ascending:!1});if(t)throw t;console.log("\u{1F4CA} TableService.loadData - dati caricati:",r?.length||0,"tavoli"),console.log("\u{1F4CA} Dettaglio versioni:",r?.map(a=>({id:a.id,version:a.version,floor_plan_id:a.floor_plan_id}))),this.dataSubject.next(r||[])}catch(e){console.error(`Error loading ${this.getTableName()}:`,e),this.errorSubject.next(e.message),this.dataSubject.next([])}})}getTables(){return this.dataSubject.value}getTablesByFloorPlan(e,r){let t=this.dataSubject.value.filter(o=>o.floor_plan_id===e);console.log(`\u{1F50D} getTablesByFloorPlan: floorPlanId=${e}, totale tavoli nel dataSubject per questo floorPlan: ${t.length}`),console.log("\u{1F50D} Versioni presenti:",t.map(o=>o.version));let a=t.filter(o=>{if(r===void 0)return!0;let i=Number(o.version),s=Number(r);return i===s});return console.log(`\u{1F50D} Dopo filtro versione=${r}: ${a.length} tavoli`),a}createTable(e){return n(this,null,function*(){try{console.log("\u{1F4DD} Creating table with shape:",e.shape);let{data:r,error:t}=yield this.supabaseService.getSupabaseClient().from("tables").insert(e).select().single();if(t)throw console.error("\u274C Error creating table:",t),console.error("\u274C Error details:",t.details),t;return console.log("\u2705 Table created successfully"),yield this.loadData(),r}catch(r){return console.error("\u{1F4A5} Error in createTable:",r),null}})}updateTable(e,r){return n(this,null,function*(){try{console.log(`\u{1F4BE} updateTable for table ${e}:`,r);let t=this.dataSubject.value,a=t.map(i=>i.id===e?c(c({},i),r):i);this.dataSubject.next(a);let{error:o}=yield this.supabaseService.getSupabaseClient().from("tables").update(r).eq("id",e);if(o)throw console.error("\u274C Database error updating table:",o),this.dataSubject.next(t),o;return console.log(`\u2705 Table ${e} updated successfully`),!0}catch(t){return console.error("\u274C Error updating table:",t),yield this.loadData(),!1}})}deleteTable(e){return n(this,null,function*(){try{let{error:r}=yield this.supabaseService.getSupabaseClient().from("tables").update({is_active:!1}).eq("id",e);if(r)throw r;return yield this.loadData(),!0}catch(r){return console.error("\u274C Error deleting table:",r),!1}})}checkTableOverlap(e,r){let t=this.getTablesByFloorPlan(e.floor_plan_id),a=Array.isArray(r)?r:r?[r]:[];for(let o of t){if(a.includes(o.id))continue;if(this.doTablesOverlap(e,o))return!0}return!1}doTablesOverlap(e,r){return!(e.position_x+e.width<=r.position_x||e.position_x>=r.position_x+r.width||e.position_y+e.height<=r.position_y||e.position_y>=r.position_y+r.height)}updateTableOnlineBookable(e,r){return n(this,null,function*(){try{let{error:t}=yield this.supabaseService.getSupabaseClient().from("tables").update({is_online_bookable:r}).eq("id",e);if(t)throw t;return yield this.loadData(),!0}catch(t){return console.error("\u274C Error updating table online bookable status:",t),!1}})}getTablesAvailableForOnlineBooking(e){return this.getTablesByFloorPlan(e).filter(r=>r.is_online_bookable&&!r.is_merged&&r.is_active)}getVisibleTablesByFloorPlan(e,r){let t=this.getTablesByFloorPlan(e,r);return console.log(`\u{1F50D} getVisibleTablesByFloorPlan: floorPlanId=${e}, version=${r}, trovati=${t.length}`),t.filter(a=>!a.is_merged||a.parent_table_id===null)}getNextVersion(e){return n(this,null,function*(){return this.getTablesByFloorPlan(e).reduce((a,o)=>Math.max(a,o.version||1),1)+1})}getTableStyle(e){let r;e.border_radius!==void 0&&e.border_radius!==null?r=e.border_radius===50?"50%":`${e.border_radius}px`:r=e.shape==="circle"?"50%":"8px";let t=e.rotation||0,a={left:e.position_x+"px",top:e.position_y+"px",width:e.width+"px",height:e.height+"px","border-radius":r,transform:`rotate(${t}deg)`};return t!==0&&console.log(`\u{1F3A8} Tavolo ${e.table_number}: applicata rotazione di ${t}\xB0`),e.is_merged&&(a.border="3px dashed #ff6b35",a.background="rgba(255, 107, 53, 0.1)"),e.is_online_bookable||(a.background="repeating-linear-gradient(45deg, var(--primary), var(--smoke-1) 10px, var(--smoke-1) 10px, var(--primary) 20px)"),a}getTableClass(e,r,t,a){let o=["table-element",`shape-${e.shape}`];return r?.id===e.id&&o.push("selected"),t.some(i=>i.id===e.id)&&o.push("merge-selected"),e.is_merged&&e.parent_table_id?o.push("merged-child","hidden-table"):e.merged_tables_ids&&e.merged_tables_ids.length>0&&o.push("merged-parent"),e.is_online_bookable||o.push("not-online-bookable"),o.join(" ")}generateNextTableNumber(e){let r=e.map(t=>parseInt(t.table_number)).filter(t=>!isNaN(t));return r.length>0?Math.max(...r)+1:1}rotateTable(e,r){return n(this,null,function*(){try{let t=(r%360+360)%360,a=this.dataSubject.value,o=a.map(s=>s.id===e?u(c({},s),{rotation:t}):s);this.dataSubject.next(o);let{error:i}=yield this.supabaseService.getSupabaseClient().from("tables").update({rotation:t,updated_at:new Date().toISOString()}).eq("id",e);return i?(console.error("\u274C Database error rotating table:",i),this.dataSubject.next(a),!1):!0}catch(t){return console.error("\u274C Error rotating table:",t),!1}})}getAllTablesByFloorPlan(e){return this.dataSubject.value.filter(r=>r.floor_plan_id===e)}calculateMaxCapacity(e){return!e||e.length===0?0:e.reduce((r,t)=>r+(t.capacity||0),0)}getCapacityByTableType(e){let r={};return e.forEach(t=>{let a=t.capacity||0;r[a]=(r[a]||0)+1}),r}getTableStats(e){let r=e.length,t=this.calculateMaxCapacity(e),a=e.filter(i=>i.is_online_bookable).length,o=r>0?Math.round(t/r):0;return{totalTables:r,maxCapacity:t,availableForOnline:a,averageCapacity:o}}validateTableDimensions(e){let{width:r,height:t}=e;return(e.shape==="circle"||e.shape==="square")&&(t=r),r<20&&(r=20),r>1e3&&(r=1e3),t<20&&(t=20),t>1e3&&(t=1e3),{width:r,height:t}}static \u0275fac=(()=>{let e;return function(t){return(e||(e=d(l)))(t||l)}})();static \u0275prov=b({token:l,factory:l.\u0275fac,providedIn:"root"})};export{g as a};
