import{a as f}from"./chunk-ZZFA3ZHU.js";import{a as h}from"./chunk-MMFTZZDS.js";import{_ as d,a as o,b as p,da as g,g as s,n as u,sa as m}from"./chunk-PX5DELEN.js";var S=class l extends h{getTableName(){return"expenses"}supplierService=g(f);categoriesSubject=new u([]);categories$=this.categoriesSubject.asObservable();suppliersSubject=new u([]);suppliers$=this.suppliersSubject.asObservable();getDefaultCategories(){return["Affitto","Bollette (Luce/Gas/Acqua)","Telefono/Internet","Personale","Forniture","Manutenzione","Marketing","Assicurazione","Tasse","Mutuo","Utensili e Attrezzature","Pulizia e Igiene","Spese Bancarie","Software e Tecnologia","Trasporti e Consegne","Formazione","Altro"]}loadCategories(){return s(this,null,function*(){try{let e=yield this.getCurrentRestaurantId();if(!e)return;let{data:r,error:t}=yield this.supabaseService.getSupabaseClient().from("expense_categories").select("*").eq("restaurant_id",e).eq("is_active",!0).order("name");if(t)throw t;this.categoriesSubject.next(r||[])}catch(e){console.error("Error loading expense categories:",e)}})}createCategory(e){return s(this,null,function*(){try{let r=yield this.getCurrentRestaurantId();if(!r)return null;let t=p(o({},e),{is_active:e.is_active??!0,restaurant_id:r,created_at:new Date().toISOString()}),{data:a,error:n}=yield this.supabaseService.getSupabaseClient().from("expense_categories").insert(t).select().single();if(n)throw n;return yield this.loadCategories(),a}catch(r){return console.error("Error creating expense category:",r),null}})}loadExpensesForMonth(e){return s(this,null,function*(){try{let r=yield this.getCurrentRestaurantId();if(!r){console.log("\u274C No restaurant ID found"),this.dataSubject.next([]);return}let t=this.formatMonthForDatabase(e);console.log("\u{1F50D} Loading expenses for:",{month:e,formattedMonth:t,restaurantId:r});let{data:a,error:n}=yield this.supabaseService.getSupabaseClient().from(this.getTableName()).select("*").eq("restaurant_id",r).eq("month",t).order("type",{ascending:!0}).order("category",{ascending:!0});if(n)throw console.error("\u274C Supabase error loading expenses:",n),n;console.log("\u2705 Expenses loaded successfully:",a?.length||0,"items"),this.dataSubject.next(a||[])}catch(r){console.error("\u274C Error loading expenses for month:",r),this.dataSubject.next([])}})}loadExpensesWithSeparateSuppliers(e,r){return s(this,null,function*(){try{let{data:t,error:a}=yield this.supabaseService.getSupabaseClient().from(this.getTableName()).select("*").eq("restaurant_id",e).eq("month",r).order("type",{ascending:!0}).order("category",{ascending:!0});if(a)throw a;if(!t||t.length===0){this.dataSubject.next([]);return}let n=yield this.enrichExpensesWithSuppliers(t);this.dataSubject.next(n)}catch(t){console.error("\u274C Error in loadExpensesWithSeparateSuppliers:",t),this.dataSubject.next([])}})}enrichExpensesWithSuppliers(e){return s(this,null,function*(){let r=[...new Set(e.filter(t=>t.supplier_id).map(t=>t.supplier_id))].filter(Boolean);if(r.length===0)return e;try{let{data:t,error:a}=yield this.supabaseService.getSupabaseClient().from("suppliers").select("id, company_name, contact_name, email, phone, is_platform_supplier, is_approved").in("id",r);if(a)throw a;let n=new Map(t?.map(i=>[i.id,i])||[]);return e.map(i=>p(o({},i),{suppliers:i.supplier_id&&n.get(i.supplier_id)||null}))}catch(t){return console.error("\u274C Error enriching expenses with suppliers:",t),e}})}createExpense(e){return s(this,null,function*(){try{let r=yield this.getCurrentRestaurantId();if(!r)return null;let t=p(o({},e),{restaurant_id:r,created_at:new Date().toISOString(),updated_at:new Date().toISOString()}),{data:a,error:n}=yield this.supabaseService.getSupabaseClient().from(this.getTableName()).insert(t).select("*").single();if(n)throw n;return yield this.loadExpensesForMonth(e.month),console.log("\u2705 Expense created:",a),a}catch(r){return console.error("\u274C Error creating expense:",r),null}})}getExpenseWithSupplier(e){return s(this,null,function*(){try{let{data:r,error:t}=yield this.supabaseService.getSupabaseClient().from(this.getTableName()).select("*").eq("id",e).single();if(t)throw t;let a=null;return r.supplier_id&&(a=yield this.supplierService.getSupplierById(r.supplier_id)),{expense:r,supplier:a}}catch(r){return console.error("\u274C Error loading expense with supplier:",r),null}})}loadExpensesForDateRange(e,r){return s(this,null,function*(){try{let t=yield this.getCurrentRestaurantId();if(!t)return console.log("\u274C No restaurant ID found for date range"),[];let a=this.formatMonthForDatabase(e),n=this.formatMonthForDatabase(r);console.log("\u{1F50D} Loading expenses for date range:",{startMonth:e,formattedStart:a,endMonth:r,formattedEnd:n,restaurantId:t});let{data:i,error:c}=yield this.supabaseService.getSupabaseClient().from(this.getTableName()).select(`
          *,
          suppliers (
            company_name,
            contact_name,
            email,
            phone
          )
        `).eq("restaurant_id",t).gte("month",a).lte("month",n).order("month",{ascending:!1}).order("type",{ascending:!0}).order("category",{ascending:!0});if(c)throw console.error("\u274C Supabase error loading expenses for date range:",c),c;return console.log("\u2705 Date range expenses loaded:",i?.length||0,"items"),i||[]}catch(t){return console.error("\u274C Error loading expenses for date range:",t),[]}})}formatMonthForDatabase(e){if(!e)return console.warn("\u26A0\uFE0F Month parameter is empty, using current month"),new Date().toISOString().split("T")[0];if(e.match(/^\d{4}-\d{2}-\d{2}$/))return e;if(e.match(/^\d{4}-\d{2}$/))return`${e}-01`;try{let r=new Date(e);if(isNaN(r.getTime()))throw new Error("Invalid date");return r.toISOString().split("T")[0]}catch{return console.error("\u274C Invalid month format:",e,"using current month"),new Date().toISOString().split("T")[0]}}calculateMonthlyTotal(e){let r=e.filter(a=>a.type==="fissa").reduce((a,n)=>a+n.amount,0),t=e.filter(a=>a.type==="variabile").reduce((a,n)=>a+n.amount,0);return{fisse:r,variabili:t,totale:r+t}}getAvailableMonths(){return s(this,null,function*(){try{let e=yield this.getCurrentRestaurantId();if(!e)return[];let{data:r,error:t}=yield this.supabaseService.getSupabaseClient().from(this.getTableName()).select("month").eq("restaurant_id",e).order("month",{ascending:!1});if(t)throw t;return[...new Set(r?.map(n=>n.month)||[])]}catch(e){return console.error("Error getting available months:",e),[]}})}debugExpenses(){return s(this,null,function*(){try{let e=yield this.getCurrentRestaurantId();if(console.log("\u{1F50D} DEBUG - Restaurant ID:",e),!e)return;let{data:r,error:t}=yield this.supabaseService.getSupabaseClient().from(this.getTableName()).select("*").eq("restaurant_id",e).limit(10);if(t){console.error("\u274C DEBUG - Error loading expenses:",t);return}console.log("\u{1F50D} DEBUG - First 10 expenses:",r)}catch(e){console.error("\u274C DEBUG - Error:",e)}})}loadSuppliers(){return s(this,null,function*(){try{let e=yield this.getCurrentRestaurantId();if(!e)return;console.log("\u{1F50D} Loading suppliers for restaurant:",e);let{data:r,error:t}=yield this.supabaseService.getSupabaseClient().from("suppliers").select("*").or(`restaurant_id.eq.${e},is_platform_supplier.eq.true`).eq("is_approved",!0).order("company_name");if(t){console.error("\u274C Error loading suppliers:",t);return}let a=(r||[]).map(n=>({id:n.id,company_name:n.company_name,contact_name:n.contact_name,email:n.email,phone:n.phone,is_platform_supplier:n.is_platform_supplier,is_approved:n.is_approved,type:n.is_platform_supplier?"platform":"manual"}));console.log("\u2705 Suppliers loaded:",a.length),this.suppliersSubject.next(a)}catch(e){console.error("\u274C Error in loadSuppliers:",e)}})}createManualSupplier(e){return s(this,null,function*(){try{let r=yield this.getCurrentRestaurantId();if(!r)return null;let t=p(o({},e),{restaurant_id:r,is_platform_supplier:!1,is_approved:!0,created_at:new Date().toISOString()}),{data:a,error:n}=yield this.supabaseService.getSupabaseClient().from("suppliers").insert(t).select().single();if(n)throw n;yield this.loadSuppliers();let i={id:a.id,company_name:a.company_name,contact_name:a.contact_name,email:a.email,phone:a.phone,is_platform_supplier:a.is_platform_supplier,is_approved:a.is_approved,type:"manual"};return console.log("\u2705 Manual supplier created:",i),i}catch(r){return console.error("\u274C Error creating manual supplier:",r),null}})}static \u0275fac=(()=>{let e;return function(t){return(e||(e=m(l)))(t||l)}})();static \u0275prov=d({token:l,factory:l.\u0275fac,providedIn:"root"})};export{S as a};
