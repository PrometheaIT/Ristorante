import{a as v}from"./chunk-GKNZLVDN.js";import{a as _}from"./chunk-5BFIQ7BP.js";import{$ as l,a as f,b as h,ea as g,f as i,l as m,m as y,xa as b}from"./chunk-K5RDB55Y.js";var p=class d{orderUpdatesSubject=new m;orderUpdates$=this.orderUpdatesSubject.asObservable();tableUpdatesSubject=new m;tableUpdates$=this.tableUpdatesSubject.asObservable();notifyOrderUpdate(e){this.orderUpdatesSubject.next(e)}notifyTableUpdate(e){this.tableUpdatesSubject.next(e)}notifyDataChange(){this.orderUpdatesSubject.next("refresh_all")}static \u0275fac=function(r){return new(r||d)};static \u0275prov=l({token:d,factory:d.\u0275fac,providedIn:"root"})};var S=class d extends _{shiftService=g(v);notificationService=g(p);ordersSubject=new y([]);orders$=this.ordersSubject.asObservable();getTableName(){return"orders"}getOrdersStats(e="today"){return i(this,null,function*(){let r=yield this.getCurrentRestaurantId();if(!r)return{count:0,revenue:0};let t=this.getDateFilter(e),{data:n,error:s}=yield this.supabaseService.getSupabaseClient().from("orders").select("total_amount, status").eq("restaurant_id",r).gte("created_at",t.start).lte("created_at",t.end);if(s)return console.error("Error fetching orders stats:",s),{count:0,revenue:0};let a=n?.filter(o=>o.status==="completed")||[];return{count:a.length,revenue:a.reduce((o,c)=>o+c.total_amount,0)}})}getDateFilter(e){let r=new Date,t=new Date;switch(e){case"today":t.setHours(0,0,0,0);break;case"week":t.setDate(r.getDate()-7);break;case"month":t.setMonth(r.getMonth()-1);break}return{start:t.toISOString(),end:r.toISOString()}}getOrdersWithItems(){return i(this,arguments,function*(e={}){let r=yield this.getCurrentRestaurantId();if(!r)return[];try{let t=this.supabaseService.getSupabaseClient().from("orders").select(e.includeItems?`*,
        order_items(
          *,
          dishes(
            name,
            base_price
          )
        )`:"*").eq("restaurant_id",r);e.status?.length&&(t=t.in("status",e.status));let{data:n,error:s}=yield t;return s?(console.error("\u274C Error in getOrdersWithItems query:",s),console.error("\u274C Query details:",s.details,s.hint,s.message),[]):n||[]}catch(t){return console.error("\u{1F4A5} Unexpected error in getOrdersWithItems:",t),[]}})}loadActiveOrders(){return i(this,null,function*(){try{let e=this.authService.currentUserValue;if(!e)return[];let{data:r,error:t}=yield this.supabaseService.getSupabaseClient().from("restaurants").select("id").eq("owner_id",e.id).limit(1);if(t||!r||r.length===0)return console.error("\u274C No restaurant found for user:",e.id),[];let n=r[0].id,{data:s,error:a}=yield this.supabaseService.getSupabaseClient().from("orders").select(`
          *,
          order_items (
            *,
            dishes (name, base_price)
          )
        `).eq("restaurant_id",n).not("status","in",'("completed", "cancelled")').order("created_at",{ascending:!1});if(a)return console.error("\u274C Error loading active orders:",a),[];let o=(s||[]).map(c=>(c.order_items&&Array.isArray(c.order_items)?c.order_items=c.order_items.map(u=>h(f({},u),{dish_name:u.dishes?.name||"Piatto",total_price:u.total_price||u.quantity*u.unit_price})):c.order_items=[],c));return console.log("\u{1F4CA} Active orders loaded:",o.length),o}catch(e){return console.error("\u274C Error loading active orders:",e),[]}})}forceRefreshActiveOrders(){return i(this,null,function*(){try{console.log("\u{1F504} Force refreshing active orders..."),yield this.loadOrders();let e=yield this.loadActiveOrders();return console.log("\u2705 Active orders force refreshed:",e.length),e}catch(e){return console.error("\u274C Error force refreshing active orders:",e),[]}})}updateOrderItemStatus(e,r){return i(this,null,function*(){try{let t={status:r};console.log(`\u{1F504} Updating order item ${e} to status: ${r}`);let{error:n}=yield this.supabaseService.getSupabaseClient().from("order_items").update(t).eq("id",e);if(n)throw console.error("\u274C Supabase error updating order item:",n),n;let{data:s,error:a}=yield this.supabaseService.getSupabaseClient().from("order_items").select("order_id").eq("id",e).single();return a?console.error("\u274C Error getting order_id for item:",a):s&&(yield this.updateOrderStatusBasedOnItems(s.order_id),this.notificationService.notifyOrderUpdate(s.order_id)),console.log("\u2705 Order item status updated successfully"),!0}catch(t){return console.error("\u274C Error updating order item status:",t),!1}})}updateOrderStatusBasedOnItems(e){return i(this,null,function*(){try{let{data:r,error:t}=yield this.supabaseService.getSupabaseClient().from("orders").select(`
          *,
          order_items (*)
        `).eq("id",e).single();if(t)throw t;let n=this.calculateOverallOrderStatus(r.order_items),{error:s}=yield this.supabaseService.getSupabaseClient().from("orders").update({status:n,updated_at:new Date().toISOString()}).eq("id",e);if(s)throw s;return this.notificationService.notifyOrderUpdate(e),!0}catch(r){return console.error("Error updating order status:",r),!1}})}getOrderProgress(e){let r=e.filter(a=>a.status!=="out_of_stock"&&a.status!=="cancelled"),t=r.filter(a=>a.status==="ready"||a.status==="served").length,n=r.length,s=n>0?t/n*100:0;return{completed:t,total:n,percentage:s}}loadOrders(){return i(this,null,function*(){try{let e=this.authService.currentUserValue;if(!e){console.log("No user found");return}let{data:r,error:t}=yield this.supabaseService.getSupabaseClient().from("restaurants").select("id").eq("owner_id",e.id).limit(1);if(t||!r||r.length===0){console.error("\u274C No restaurant found for user:",e.id);return}let n=r[0].id,{data:s,error:a}=yield this.supabaseService.getSupabaseClient().from("orders").select("*").eq("restaurant_id",n).order("created_at",{ascending:!1});if(a){console.error("Error loading orders:",a);return}console.log("Orders loaded:",s?.length),this.ordersSubject.next(s||[])}catch(e){console.error("Error in loadOrders:",e)}})}updateOrders(e){this.ordersSubject.next(e)}getTodayOrders(){return i(this,null,function*(){try{let e=yield this.getCurrentRestaurantId();if(!e)return{count:0,revenue:0};let r=new Date,t=new Date(r.setHours(0,0,0,0)).toISOString(),n=new Date(r.setHours(23,59,59,999)).toISOString(),{data:s,error:a}=yield this.supabaseService.getSupabaseClient().from("orders").select("id, total_amount, status").eq("restaurant_id",e).gte("created_at",t).lte("created_at",n);if(a)return console.error("\u274C Error fetching today orders:",a),{count:0,revenue:0};let o=s?.filter(u=>u.status==="completed")||[],c=o.reduce((u,O)=>u+(O.total_amount||0),0);return{count:o.length,revenue:c}}catch(e){return console.error("\u274C Error in getTodayOrders:",e),{count:0,revenue:0}}})}getLast7DaysSales(){return i(this,null,function*(){try{let e=yield this.getCurrentRestaurantId();if(!e)return[];let r=[];for(let a=6;a>=0;a--){let o=new Date;o.setDate(o.getDate()-a),r.push(o.toISOString().split("T")[0])}let{data:t,error:n}=yield this.supabaseService.getSupabaseClient().from("orders").select("created_at, total_amount, status").eq("restaurant_id",e).eq("status","completed").gte("created_at",r[0]).lte("created_at",r[6]+"T23:59:59.999Z");if(n)return console.error("\u274C Error fetching last 7 days sales:",n),this.getEmptySalesData(r);let s=new Map;return r.forEach(a=>s.set(a,0)),t?.forEach(a=>{let o=a.created_at.split("T")[0];s.has(o)&&s.set(o,s.get(o)+(a.total_amount||0))}),r.map(a=>({day:this.formatChartDay(a),amount:s.get(a)||0}))}catch(e){return console.error("\u274C Error in getLast7DaysSales:",e),this.getEmptySalesData()}})}getTopDishes(e=5){return i(this,null,function*(){try{let r=yield this.getCurrentRestaurantId();if(!r)return[];let{data:t,error:n}=yield this.supabaseService.getSupabaseClient().from("order_items").select(`
        dish_id,
        quantity,
        dishes!inner (
          name,
          base_price,
          restaurant_id
        )
      `).eq("dishes.restaurant_id",r).limit(1e3);if(n)return console.error("\u274C Error fetching top dishes:",n),[];let s=new Map;return t?.forEach(a=>{let o=a.dish_id,c=a.dishes;s.has(o)||s.set(o,{name:c.name,quantity:0,revenue:0});let u=s.get(o);u.quantity+=a.quantity,u.revenue+=a.quantity*(c.base_price||0)}),Array.from(s.entries()).map(([a,o])=>({dish_id:a,name:o.name,quantity:o.quantity,revenue:o.revenue})).sort((a,o)=>o.quantity-a.quantity).slice(0,e)}catch(r){return console.error("\u274C Error in getTopDishes:",r),[]}})}getCurrentOrders(){return this.ordersSubject.value.filter(r=>["pending","confirmed","in_progress","preparing","ready","active","open"].includes(r.status))}getOrderItemsCount(e){return i(this,null,function*(){try{let{data:r,error:t}=yield this.supabaseService.getSupabaseClient().from("order_items").select("id").eq("order_id",e);return t?(console.error("\u274C Error counting order items:",t),0):r?.length||0}catch(r){return console.error("\u274C Error in getOrderItemsCount:",r),0}})}getEmptySalesData(e){let r=[];for(let t=6;t>=0;t--){let n=new Date;n.setDate(n.getDate()-t),r.push(this.formatChartDay(n.toISOString().split("T")[0]))}return(e||r).map(t=>({day:this.formatChartDay(t),amount:0}))}formatChartDay(e){return new Date(e).toLocaleDateString("it-IT",{weekday:"short",day:"numeric"})}calculateOverallOrderStatus(e){if(!e||e.length===0)return"received";let r={waiting:0,preparing:0,ready:0,served:0,out_of_stock:0};return e.forEach(t=>{r.hasOwnProperty(t.status)&&r[t.status]++}),r.ready>0?"ready":r.preparing>0?"preparing":r.waiting>0?"waiting":r.served===e.length?"served":r.out_of_stock===e.length?"cancelled":"received"}updateOrderItemStatusDirect(e,r){return i(this,null,function*(){try{console.log(`\u{1F504} Direct update for item ${e} to ${r}`);let{error:t}=yield this.supabaseService.getSupabaseClient().from("order_items").update({status:r}).eq("id",e);return t?(console.error("\u274C Direct update error:",t),yield this.tryAlternativeUpdate(e,r)):(console.log("\u2705 Direct update successful"),!0)}catch(t){return console.error("\u274C Error in direct update:",t),!1}})}tryAlternativeUpdate(e,r){return i(this,null,function*(){try{let{error:t}=yield this.supabaseService.getSupabaseClient().from("order_items").update({status:r}).eq("id",e);return t?(console.error("\u274C Alternative update also failed:",t),!1):!0}catch(t){return console.error("\u274C Error in alternative update:",t),!1}})}checkTableStructure(){return i(this,null,function*(){try{let{data:e,error:r}=yield this.supabaseService.getSupabaseClient().from("order_items").select("*").limit(1);r?console.error("\u274C Error checking table structure:",r):(console.log("\u{1F50D} Order items table structure sample:",e),e&&e.length>0&&console.log("\u{1F4CA} Available columns:",Object.keys(e[0])))}catch(e){console.error("\u274C Error in checkTableStructure:",e)}})}areAllItemsServed(e){return!e||!e.order_items||e.order_items.length===0?!1:e.order_items.every(r=>r.status==="served"||r.status==="out_of_stock")}static \u0275fac=(()=>{let e;return function(t){return(e||(e=b(d)))(t||d)}})();static \u0275prov=l({token:d,factory:d.\u0275fac,providedIn:"root"})};export{p as a,S as b};
