import{a as p,b as g,d}from"./chunk-MEEOFM4U.js";import{Y as l,ca as u}from"./chunk-KIAVC6JW.js";import{g as n}from"./chunk-RA2WU32H.js";var f=class a{supabaseService=u(g);authService=u(d);isSupported(){return"serviceWorker"in navigator&&"PushManager"in window&&"Notification"in window}getPermissionStatus(){return this.isSupported()?Notification.permission:"unsupported"}requestPermissionAndSubscribe(){return n(this,null,function*(){if(console.log("1. requestPermissionAndSubscribe started"),!this.isSupported())return console.warn("Push non supportato"),!1;if(Notification.permission==="denied")return console.log("Permesso gi\xE0 negato"),!1;try{console.log("2. Richiedo permesso...");let e=yield Notification.requestPermission();if(console.log("3. Permesso ottenuto:",e),e!=="granted")return!1;console.log("4. Ottengo service worker...");let r=yield navigator.serviceWorker.ready;console.log("5. Service worker pronto:",r),console.log("6. Creo subscription...");let s=yield r.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:this.urlBase64ToUint8Array(p.vapidPublicKey)});console.log("7. Subscription creata:",s.toJSON());let t=this.getUserId();if(!t)return console.error("Utente non loggato"),!1;let o=s.toJSON(),i=new Date().toISOString();console.log("8. Salvo su Supabase...");let{error:c}=yield this.supabaseService.getSupabaseClient().from("push_subscriptions").upsert({user_id:t,endpoint:o.endpoint,p256dh_key:o.keys?.p256dh,auth_key:o.keys?.auth,device_type:this.getDeviceType(),browser:this.getBrowserName(),user_agent:navigator.userAgent,consent_given_at:i,consent_user_agent:navigator.userAgent,is_active:!0,revoked_at:null},{onConflict:"user_id,endpoint"});return c?(console.error("9. Errore salvataggio:",c),!1):(console.log("10. Salvataggio riuscito!"),!0)}catch(e){return console.error("\u274C ERRORE CATCH:",e),!1}})}revokeConsent(){return n(this,null,function*(){let e=this.getUserId();if(!e)return!1;try{let s=yield(yield navigator.serviceWorker.ready).pushManager.getSubscription();s&&(yield s.unsubscribe());let{error:t}=yield this.supabaseService.getSupabaseClient().from("push_subscriptions").update({is_active:!1,revoked_at:new Date().toISOString()}).eq("user_id",e);return!t}catch(r){return console.error("Errore revoca consenso:",r),!1}})}hasActiveSubscription(){return n(this,null,function*(){let e=this.getUserId();if(!e)return!1;let{data:r}=yield this.supabaseService.getSupabaseClient().from("push_subscriptions").select("id").eq("user_id",e).eq("is_active",!0).maybeSingle();return!!r})}urlBase64ToUint8Array(e){let r="=".repeat((4-e.length%4)%4),s=(e+r).replace(/-/g,"+").replace(/_/g,"/"),t=window.atob(s),o=new Uint8Array(t.length);for(let i=0;i<t.length;++i)o[i]=t.charCodeAt(i);return o.buffer}getDeviceType(){let e=navigator.userAgent;return/tablet|ipad/i.test(e)?"tablet":/mobile|iphone|android/i.test(e)?"mobile":"desktop"}getBrowserName(){let e=navigator.userAgent;return e.includes("Chrome")?"Chrome":e.includes("Firefox")?"Firefox":e.includes("Safari")?"Safari":e.includes("Edge")?"Edge":"Unknown"}getUserId(){return this.authService.currentUserValue?.id??null}static \u0275fac=function(r){return new(r||a)};static \u0275prov=l({token:a,factory:a.\u0275fac,providedIn:"root"})};export{f as a};
