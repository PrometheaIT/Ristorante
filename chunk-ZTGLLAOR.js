import{a as C}from"./chunk-CXV4BLDF.js";import{w as E}from"./chunk-L5SOXNIK.js";import{F as O,L as w,_ as D,a as f,b as S,da as _,f as i,m as v}from"./chunk-KZSY5CHT.js";var I=class b{supabaseService=_(E);authService=_(C);ordersSubject=new v([]);orders$=this.ordersSubject.asObservable();possibleStatuses=["pending","active","open","confirmed","in_progress","preparing"];constructor(){this.authService.currentUser$.pipe(O(e=>!!e),w(1)).subscribe(()=>{this.loadOrders()})}generateOrderNumber(){let e=new Date().getTime(),r=Math.floor(Math.random()*1e3);return`ORD-${e}-${r}`}createOrder(e){return i(this,null,function*(){if(e.status&&e.status!=="pending")return yield this.tryCreateWithStatus(e,e.status);for(let r of this.possibleStatuses){console.log(`\u{1F504} Tentativo con status: ${r}`);let t=yield this.tryCreateWithStatus(e,r);if(t)return console.log(`\u2705 Ordine creato con successo con status: ${r}`),t}return console.error("\u{1F4A5} Tutti i tentativi di status hanno fallito"),null})}tryCreateWithStatus(e,r){return i(this,null,function*(){try{let t=S(f({},e),{status:r,tax_amount:e.tax_amount||0,discount_amount:e.discount_amount||0,created_at:new Date().toISOString(),updated_at:new Date().toISOString()});console.log(`\u{1F4DD} Creazione ordine con status: ${r}`,t);let{data:n,error:s}=yield this.supabaseService.getSupabaseClient().from("orders").insert(t).select().single();if(s){if(s.code==="23514")return console.log(`\u274C Status "${r}" non valido per il constraint`),null;throw console.error(`\u274C Errore con status "${r}":`,s),s}return yield this.loadOrders(),n}catch(t){return console.error(`\u{1F4A5} Errore con status "${r}":`,t),null}})}updateOrder(e,r){return i(this,null,function*(){try{let t=S(f({},r),{updated_at:new Date().toISOString()}),{error:n}=yield this.supabaseService.getSupabaseClient().from("orders").update(t).eq("id",e);if(n)throw n;return yield this.loadOrders(),!0}catch(t){return console.error("\u274C Error updating order:",t),!1}})}createOrderItems(e){return i(this,null,function*(){try{if(e.length===0)return!0;let{error:r}=yield this.supabaseService.getSupabaseClient().from("order_items").insert(e);if(r)throw r;return!0}catch(r){return console.error("\u274C Error creating order items:",r),!1}})}deleteOrderItems(e){return i(this,null,function*(){try{let{error:r}=yield this.supabaseService.getSupabaseClient().from("order_items").delete().eq("order_id",e);if(r)throw r;return!0}catch(r){return console.error("\u274C Error deleting order items:",r),!1}})}loadOrders(){return i(this,null,function*(){try{let e=this.authService.currentUserValue;if(!e){console.log("No user found");return}let{data:r,error:t}=yield this.supabaseService.getSupabaseClient().from("restaurants").select("id").eq("owner_id",e.id).limit(1);if(t||!r||r.length===0){console.error("\u274C No restaurant found for user:",e.id);return}let n=r[0].id,{data:s,error:u}=yield this.supabaseService.getSupabaseClient().from("orders").select("*").eq("restaurant_id",n).order("created_at",{ascending:!1});if(u){console.error("Error loading orders:",u);return}console.log("Orders loaded:",s?.length),this.ordersSubject.next(s||[])}catch(e){console.error("Error in loadOrders:",e)}})}getTodayOrders(){return i(this,null,function*(){try{let e=this.authService.currentUserValue;if(!e)return{count:0,revenue:0};let{data:r,error:t}=yield this.supabaseService.getSupabaseClient().from("restaurants").select("id").eq("owner_id",e.id).limit(1);if(t||!r||r.length===0)return console.error("\u274C No restaurant found for user:",e.id),{count:0,revenue:0};let n=r[0].id,s=new Date().toISOString().split("T")[0],{data:u,error:l}=yield this.supabaseService.getSupabaseClient().from("orders").select("*").eq("restaurant_id",n).gte("created_at",s+"T00:00:00").lte("created_at",s+"T23:59:59");if(l)return console.error("Error fetching today orders:",l),{count:0,revenue:0};let c=u?.length||0,h=u?.reduce((m,d)=>m+d.total_amount,0)||0;return{count:c,revenue:h}}catch(e){return console.error("Error in getTodayOrders:",e),{count:0,revenue:0}}})}getCurrentOrders(){return this.ordersSubject.value.filter(r=>["pending","confirmed","preparing","ready"].includes(r.status))}getTopDishes(e=5){return i(this,null,function*(){try{let r=this.authService.currentUserValue;if(!r)return[];let{data:t,error:n}=yield this.supabaseService.getSupabaseClient().from("restaurants").select("id").eq("owner_id",r.id).limit(1);if(n||!t||t.length===0)return console.error("\u274C No restaurant found for user:",r.id),[];let s=t[0].id,{data:u,error:l}=yield this.supabaseService.getSupabaseClient().from("orders").select("id").eq("restaurant_id",s);if(l||!u)return console.error("Error fetching restaurant orders:",l),[];let c=u.map(a=>a.id);if(c.length===0)return[];let{data:h,error:m}=yield this.supabaseService.getSupabaseClient().from("order_items").select(`
          quantity,
          unit_price,
          total_price,
          dishes (name, restaurant_id)
        `).in("order_id",c);if(m)return console.error("Error fetching top dishes:",m),[];let d=h,o=new Map;return d?.forEach(a=>{if(a.dishes&&a.dishes.restaurant_id===s){let g=a.dishes.name;if(!g)return;o.has(g)||o.set(g,{orders:0,revenue:0});let y=o.get(g);y.orders+=a.quantity,y.revenue+=a.total_price}}),Array.from(o,([a,g])=>f({name:a},g)).sort((a,g)=>g.orders-a.orders).slice(0,e)}catch(r){return console.error("Error in getTopDishes:",r),[]}})}getLast7DaysSales(){return i(this,null,function*(){try{let e=this.authService.currentUserValue;if(!e)return[];let{data:r,error:t}=yield this.supabaseService.getSupabaseClient().from("restaurants").select("id").eq("owner_id",e.id).limit(1);if(t||!r||r.length===0)return console.error("\u274C No restaurant found for user:",e.id),[];let n=r[0].id,s=new Date;s.setDate(s.getDate()-6);let{data:u,error:l}=yield this.supabaseService.getSupabaseClient().from("orders").select("created_at, total_amount").eq("restaurant_id",n).gte("created_at",s.toISOString().split("T")[0]+"T00:00:00").order("created_at",{ascending:!0});if(l)return console.error("Error fetching sales data:",l),[];let c=new Map,h=["DOM","LUN","MAR","MER","GIO","VEN","SAB"];u?.forEach(d=>{let o=new Date(d.created_at),p=o.toISOString().split("T")[0],a=h[o.getDay()];c.has(p)||c.set(p,{day:a,amount:0}),c.get(p).amount+=d.total_amount});let m=[];for(let d=6;d>=0;d--){let o=new Date;o.setDate(o.getDate()-d);let p=o.toISOString().split("T")[0],a=h[o.getDay()];c.has(p)?m.push(c.get(p)):m.push({day:a,amount:0})}return m}catch(e){return console.error("Error in getLast7DaysSales:",e),[]}})}getOrderItemsCount(e){return i(this,null,function*(){try{let{data:r,error:t}=yield this.supabaseService.getSupabaseClient().from("order_items").select("id").eq("order_id",e);return t?(console.error("Error counting order items:",t),0):r?.length||0}catch(r){return console.error("Error in getOrderItemsCount:",r),0}})}static \u0275fac=function(r){return new(r||b)};static \u0275prov=D({token:b,factory:b.\u0275fac,providedIn:"root"})};export{I as a};
