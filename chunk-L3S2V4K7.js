import{a as ve}from"./chunk-XMFPU2G7.js";import{a as fe}from"./chunk-NFORIBAQ.js";import{c as ce,d as ue,e as pe,f as _e,g as W}from"./chunk-FEI4XXIJ.js";import{a as me}from"./chunk-AMYEPXIV.js";import"./chunk-SY2ZWW6D.js";import{Ab as xe,zb as ge}from"./chunk-N3VPFYDE.js";import{A as de,a as X,b as Z,d as ee,i as te,k as ie,s as ne,t as ae,u as re,v as oe,w as le,y as se}from"./chunk-45CSFDAZ.js";import{b as Y,d as J}from"./chunk-TB7INTC7.js";import"./chunk-Q3EITIAW.js";import"./chunk-RC3HHTXM.js";import{k as G,l as q,r as H,s as K,v as Q}from"./chunk-MPTEMNWF.js";import{C as B,Ib as a,Jb as g,Kb as f,La as o,Lb as I,Ob as v,Pb as S,Qb as y,T as P,Va as R,Vb as F,Xb as N,Y as A,_a as x,ca as E,f as O,gb as c,hb as D,ib as T,kb as $,la as u,ma as p,na as U,qb as t,rb as n,sb as M,tb as V,ub as z,vb as b,xa as j,yb as _,zb as m}from"./chunk-5BU4UD4M.js";import{g as h}from"./chunk-RA2WU32H.js";var L=class l extends me{getTableName(){return"promotions"}getByStatus(i){return this.dataSubject.value.filter(e=>e.status===i)}getActiveNow(){let i=new Date;return this.dataSubject.value.filter(e=>e.status==="active"&&new Date(e.valid_from)<=i&&(!e.valid_until||new Date(e.valid_until)>=i))}getStatusCounts(){let i=this.dataSubject.value;return{all:i.length,draft:i.filter(e=>e.status==="draft").length,active:i.filter(e=>e.status==="active").length,paused:i.filter(e=>e.status==="paused").length,expired:i.filter(e=>e.status==="expired").length,archived:i.filter(e=>e.status==="archived").length}}toggleStatus(i,e){return h(this,null,function*(){return this.update(i,{status:e})})}toggleActiveState(i){return h(this,null,function*(){let e=i.status==="active"?"paused":"active";return this.toggleStatus(i.id,e)})}duplicate(i){return h(this,null,function*(){let e={name:`${i.name} (copia)`,description:i.description,internal_note:i.internal_note,type:i.type,target:i.target,discount_value:i.discount_value,max_discount_amount:i.max_discount_amount,valid_from:new Date().toISOString().split("T")[0],valid_until:null,max_uses_total:i.max_uses_total,max_uses_per_customer:i.max_uses_per_customer,min_order_amount:i.min_order_amount,priority:i.priority,stacking:i.stacking,status:"draft",is_public:i.is_public};return this.create(e)})}getStats(i){return h(this,null,function*(){try{let{data:e,error:s}=yield this.run(this.supabaseService.getSupabaseClient().from("promotion_usages").select("discount_applied, order_total_before, order_total_after").eq("promotion_id",i));if(s||!e)return null;let r=e,d=r.reduce((w,C)=>w+(C.discount_applied??0),0),k=r.length>0?r.reduce((w,C)=>w+(C.order_total_before??0),0)/r.length:0;return{promotion_id:i,total_uses:r.length,total_discount_given:d,avg_order_value:k}}catch{return null}})}formatDiscountValue(i){switch(i.type){case"percentage":return`${i.discount_value}%`;case"fixed_amount":return`-\u20AC${i.discount_value.toFixed(2)}`;case"happy_hour":return`${i.discount_value}% (Happy Hour)`;case"buy_x_get_y":return"Bundle";case"free_item":return"Omaggio";default:return`${i.discount_value}`}}isExpired(i){return!!(i.valid_until&&new Date(i.valid_until)<new Date||i.max_uses_total&&i.current_uses>=i.max_uses_total)}static \u0275fac=(()=>{let i;return function(s){return(i||(i=U(l)))(s||l)}})();static \u0275prov=A({token:l,factory:l.\u0275fac,providedIn:"root"})};function he(l,i){if(l&1&&(t(0,"div",32)(1,"span",18),a(2,"error_outline"),n(),t(3,"span"),a(4),n()()),l&2){let e=m();o(4),g(e.error)}}function Me(l,i){if(l&1){let e=b();t(0,"button",33),_("click",function(){let r=u(e).$implicit,d=m();return p(d.setFilter(r.key))}),a(1),t(2,"span",34),a(3),n()()}if(l&2){let e=i.$implicit,s=m();T("active",s.activeFilter()===e.key),o(),f(" ",e.label," "),o(2),g(s.statusCounts[e.key])}}function be(l,i){l&1&&(t(0,"div",35)(1,"span",36),a(2,"refresh"),n()())}function we(l,i){l&1&&(V(0),a(1," Crea la tua prima promozione per iniziare! "),z())}function ke(l,i){if(l&1&&(V(0),a(1),z()),l&2){let e,s=m(2);o(),f(' Nessuna promozione con stato "',(e=s.statusLabels[s.activeFilter()])==null?null:e.label,'" ')}}function Ee(l,i){if(l&1){let e=b();t(0,"button",17),_("click",function(){u(e);let r=m(2);return p(r.openCreateModal())}),t(1,"span",18),a(2,"add"),n(),a(3," Crea promozione "),n()}}function Ce(l,i){if(l&1&&(t(0,"div",37)(1,"span",38),a(2,"campaign"),n(),t(3,"p",39),a(4,"Nessuna promozione"),n(),t(5,"p",40),x(6,we,2,0,"ng-container",41)(7,ke,2,1,"ng-container",41),n(),x(8,Ee,4,0,"button",42),n()),l&2){let e=m();o(6),c("ngIf",e.activeFilter()==="all"),o(),c("ngIf",e.activeFilter()!=="all"),o(),c("ngIf",e.activeFilter()==="all")}}function Pe(l,i){if(l&1&&(t(0,"p",67),a(1),n()),l&2){let e=m().$implicit;o(),f(" ",e.description," ")}}function Ie(l,i){if(l&1&&(t(0,"div",68)(1,"div",69)(2,"span"),a(3,"Utilizzi"),n(),t(4,"span"),a(5),n()(),t(6,"div",70),M(7,"div",71),n()()),l&2){let e=m().$implicit,s=m(2);o(5),I("",e.current_uses," / ",e.max_uses_total,""),o(2),D("width",s.getUsagePercent(e),"%"),T("usage-danger",s.getUsagePercent(e)>=90)}}function De(l,i){if(l&1&&(t(0,"div",72)(1,"span",54),a(2,"all_inclusive"),n(),t(3,"span",55),a(4),n()()),l&2){let e=m().$implicit;o(4),f("Utilizzi: ",e.current_uses," (illimitato)")}}function Te(l,i){if(l&1&&(t(0,"div",72)(1,"span",54),a(2,"shopping_cart"),n(),t(3,"span",55),a(4),n()()),l&2){let e=m().$implicit;o(4),f("Min. ordine: \u20AC",e.min_order_amount,"")}}function Ve(l,i){if(l&1){let e=b();t(0,"button",73),_("click",function(){u(e);let r=m().$implicit,d=m(2);return p(d.publishDraft(r))}),t(1,"span",18),a(2,"rocket_launch"),n(),a(3," Pubblica "),n()}}function ze(l,i){if(l&1){let e=b();t(0,"button",74),_("click",function(){u(e);let r=m().$implicit,d=m(2);return p(d.toggleStatus(r))}),t(1,"span",18),a(2),n(),a(3),n()}if(l&2){let e=m().$implicit;o(2),f(" ",e.status==="active"?"pause":"play_arrow"," "),o(),f(" ",e.status==="active"?"Sospendi":"Riattiva"," ")}}function Fe(l,i){if(l&1){let e=b();t(0,"button",75),_("click",function(){u(e);let r=m().$implicit,d=m(2);return p(d.sendNotification(r))}),M(1,"lucide-angular",76),n()}if(l&2){let e=m().$implicit,s=m(2);c("title",s.notifiedPromotions.has(e.id)?"Notifica gi\xE0 inviata":s.daysUntilNext>0?"Limite settimanale: riprova tra "+s.daysUntilNext+" giorni":"Invia notifica ai follower")("disabled",!s.canSendNotification(e)||s.sendingNotification===e.id),o(),D("color",s.notifiedPromotions.has(e.id)?"var(--text-muted)":s.daysUntilNext>0?"#f59e0b":"#10b981"),c("name",s.notifiedPromotions.has(e.id)?"bell-off":"bell")("size",18)}}function Ne(l,i){if(l&1){let e=b();t(0,"div",45)(1,"div",46)(2,"div",24)(3,"span",18),a(4),n(),t(5,"span",47),a(6),n()(),t(7,"span"),a(8),n()(),t(9,"h3",48),a(10),n(),x(11,Pe,2,1,"p",49),t(12,"div",50)(13,"span",51),a(14),n(),t(15,"span",52),a(16),n()(),t(17,"div",53)(18,"span",54),a(19,"event"),n(),t(20,"span",55),a(21),n()(),x(22,Ie,8,6,"div",56)(23,De,5,1,"div",57)(24,Te,5,1,"div",57),t(25,"div",58),x(26,Ve,4,0,"button",59)(27,ze,4,2,"button",60)(28,Fe,2,6,"button",61),t(29,"div",62)(30,"button",63),_("click",function(){let r=u(e).$implicit,d=m(2);return p(d.openStatsModal(r))}),t(31,"span",18),a(32,"bar_chart"),n()(),t(33,"button",64),_("click",function(){let r=u(e).$implicit,d=m(2);return p(d.duplicate(r))}),t(34,"span",18),a(35,"content_copy"),n()(),t(36,"button",65),_("click",function(){let r=u(e).$implicit,d=m(2);return p(d.openEditModal(r))}),t(37,"span",18),a(38,"edit"),n()(),t(39,"button",66),_("click",function(){let r=u(e).$implicit,d=m(2);return p(d.openDeleteModal(r))}),t(40,"span",18),a(41,"delete_outline"),n()()()()()}if(l&2){let e=i.$implicit,s=m(2);T("expired-card",s.isExpired(e)),o(3),D("color",s.typeLabels[e.type].color),o(),f(" ",s.typeLabels[e.type].icon," "),o(2),g(s.typeLabels[e.type].label),o(),$(s.statusLabels[e.status].chipClass),o(),f(" ",s.statusLabels[e.status].label," "),o(2),g(e.name),o(),c("ngIf",e.description),o(3),g(s.formatDiscount(e)),o(2),f(" su ",s.targetLabels[e.target]," "),o(5),I(" ",s.formatDate(e.valid_from)," \u2192 ",s.formatDate(e.valid_until)," "),o(),c("ngIf",e.max_uses_total),o(),c("ngIf",!e.max_uses_total),o(),c("ngIf",e.min_order_amount>0),o(2),c("ngIf",e.status==="draft"),o(),c("ngIf",e.status==="active"||e.status==="paused"),o(),c("ngIf",e.status==="active")}}function Le(l,i){if(l&1&&(t(0,"div",43),x(1,Ne,42,21,"div",44),n()),l&2){let e=m();o(),c("ngForOf",e.filteredPromotions)("ngForTrackBy",e.trackById)}}function We(l,i){l&1&&(t(0,"div",77),M(1,"lucide-angular",78),t(2,"p"),a(3,"Nessun follower ancora. Condividi le tue promozioni per crescere!"),n()()),l&2&&(o(),c("size",40))}function Oe(l,i){l&1&&(t(0,"div",79),M(1,"lucide-angular",80),n()),l&2&&(o(),c("size",24))}function Be(l,i){if(l&1&&(t(0,"tr")(1,"td")(2,"div",24),M(3,"lucide-angular",84),t(4,"span",85),a(5),n()()(),t(6,"td",40),a(7),n(),t(8,"td",5),a(9),F(10,"date"),n()()),l&2){let e=i.$implicit;o(3),c("size",16),o(2),I(" ",(e.users==null?null:e.users.first_name)||"\u2014"," ",(e.users==null?null:e.users.last_name)||""," "),o(2),g((e.users==null?null:e.users.email)||"\u2014"),o(2),g(N(10,5,e.followed_at,"dd/MM/yyyy"))}}function Ae(l,i){if(l&1&&(t(0,"div",81)(1,"table",82)(2,"thead")(3,"tr")(4,"th"),a(5,"Nome"),n(),t(6,"th"),a(7,"Email"),n(),t(8,"th"),a(9,"Segue dal"),n()()(),t(10,"tbody"),x(11,Be,11,8,"tr",83),n()()()),l&2){let e=m();o(11),c("ngForOf",e.followers)}}function Ue(l,i){if(l&1&&(t(0,"option",124),a(1),n()),l&2){let e=i.$implicit,s=m(2);c("value",e),o(),f(" ",s.typeLabels[e].label," ")}}function je(l,i){if(l&1&&(t(0,"option",124),a(1),n()),l&2){let e=i.$implicit,s=m(2);c("value",e),o(),f(" ",s.targetLabels[e]," ")}}function Re(l,i){if(l&1){let e=b();t(0,"div",96)(1,"label",97),a(2," Sconto massimo \u20AC "),t(3,"span",5),a(4,"(opzionale)"),n()(),t(5,"input",125),y("ngModelChange",function(r){u(e);let d=m(2);return S(d.formData.max_discount_amount,r)||(d.formData.max_discount_amount=r),p(r)}),n()()}if(l&2){let e=m(2);o(5),v("ngModel",e.formData.max_discount_amount)}}function $e(l,i){if(l&1&&(t(0,"option",124),a(1),n()),l&2){let e=i.$implicit,s=m(2);c("value",e),o(),I(" ",s.stackingLabels[e].label," \u2014 ",s.stackingLabels[e].description," ")}}function Ge(l,i){l&1&&(t(0,"span",18),a(1,"refresh"),n())}function qe(l,i){l&1&&(t(0,"span",126),a(1,"loading..."),n())}function He(l,i){if(l&1&&(V(0),t(1,"span",18),a(2),n(),a(3),z()),l&2){let e=m(2);o(2),g(e.selectedPromotion?"save":"add_circle"),o(),f(" ",e.selectedPromotion?"Salva modifiche":"Crea promozione"," ")}}function Ke(l,i){if(l&1){let e=b();t(0,"div",86),_("click.self",function(){u(e);let r=m();return p(r.closeFormModal())}),t(1,"div",87)(2,"div",88)(3,"div",24)(4,"span",89),a(5),n(),t(6,"span",90),a(7),n()(),t(8,"button",91),_("click",function(){u(e);let r=m();return p(r.closeFormModal())}),t(9,"span",18),a(10,"close"),n()()(),t(11,"div",92)(12,"p",93)(13,"span",94),a(14,"info"),n(),a(15," Identit\xE0 "),n(),t(16,"div",95)(17,"div",96)(18,"label",97),a(19,"Nome promozione *"),n(),t(20,"input",98),y("ngModelChange",function(r){u(e);let d=m();return S(d.formData.name,r)||(d.formData.name=r),p(r)}),n()()(),t(21,"div",95)(22,"div",96)(23,"label",97),a(24,"Descrizione pubblica"),n(),t(25,"textarea",99),y("ngModelChange",function(r){u(e);let d=m();return S(d.formData.description,r)||(d.formData.description=r),p(r)}),n()(),t(26,"div",96)(27,"label",97)(28,"span",100),a(29,"lock"),n(),a(30," Nota interna "),n(),t(31,"textarea",101),y("ngModelChange",function(r){u(e);let d=m();return S(d.formData.internal_note,r)||(d.formData.internal_note=r),p(r)}),n()()(),M(32,"hr",102),t(33,"p",93)(34,"span",94),a(35,"percent"),n(),a(36," Tipo e Valore "),n(),t(37,"div",95)(38,"div",96)(39,"label",97),a(40,"Tipo promozione"),n(),t(41,"select",103),y("ngModelChange",function(r){u(e);let d=m();return S(d.formData.type,r)||(d.formData.type=r),p(r)}),x(42,Ue,2,2,"option",104),n()(),t(43,"div",96)(44,"label",97),a(45,"Applicata su"),n(),t(46,"select",103),y("ngModelChange",function(r){u(e);let d=m();return S(d.formData.target,r)||(d.formData.target=r),p(r)}),x(47,je,2,2,"option",104),n()()(),t(48,"div",95)(49,"div",96)(50,"label",97),a(51," Valore sconto "),t(52,"span",47),a(53),n()(),t(54,"input",105),y("ngModelChange",function(r){u(e);let d=m();return S(d.formData.discount_value,r)||(d.formData.discount_value=r),p(r)}),n()(),x(55,Re,6,1,"div",106),t(56,"div",96)(57,"label",97),a(58,"Ordine minimo \u20AC"),n(),t(59,"input",107),y("ngModelChange",function(r){u(e);let d=m();return S(d.formData.min_order_amount,r)||(d.formData.min_order_amount=r),p(r)}),n()()(),M(60,"hr",102),t(61,"p",93)(62,"span",94),a(63,"event"),n(),a(64," Validit\xE0 e Limiti "),n(),t(65,"div",95)(66,"div",96)(67,"label",97),a(68,"Data inizio *"),n(),t(69,"input",108),y("ngModelChange",function(r){u(e);let d=m();return S(d.formData.valid_from,r)||(d.formData.valid_from=r),p(r)}),n()(),t(70,"div",96)(71,"label",97),a(72," Data fine "),t(73,"span",5),a(74,"(lascia vuoto = nessuna scadenza)"),n()(),t(75,"input",108),y("ngModelChange",function(r){u(e);let d=m();return S(d.formData.valid_until,r)||(d.formData.valid_until=r),p(r)}),n()()(),t(76,"div",95)(77,"div",96)(78,"label",97),a(79," Utilizzi totali "),t(80,"span",5),a(81,"(vuoto = illimitato)"),n()(),t(82,"input",109),y("ngModelChange",function(r){u(e);let d=m();return S(d.formData.max_uses_total,r)||(d.formData.max_uses_total=r),p(r)}),n()(),t(83,"div",96)(84,"label",97),a(85,"Max per cliente"),n(),t(86,"input",110),y("ngModelChange",function(r){u(e);let d=m();return S(d.formData.max_uses_per_customer,r)||(d.formData.max_uses_per_customer=r),p(r)}),n()()(),M(87,"hr",102),t(88,"p",93)(89,"span",94),a(90,"tune"),n(),a(91," Regole e Visibilit\xE0 "),n(),t(92,"div",95)(93,"div",96)(94,"label",97),a(95,"Compatibilit\xE0 con altri sconti"),n(),t(96,"select",103),y("ngModelChange",function(r){u(e);let d=m();return S(d.formData.stacking,r)||(d.formData.stacking=r),p(r)}),x(97,$e,2,3,"option",104),n()(),t(98,"div",96)(99,"label",97),a(100," Priorit\xE0 "),t(101,"span",5),a(102,"(pi\xF9 alto = vince in caso di conflitto)"),n()(),t(103,"input",111),y("ngModelChange",function(r){u(e);let d=m();return S(d.formData.priority,r)||(d.formData.priority=r),p(r)}),n()()(),t(104,"div",95)(105,"div",96)(106,"label",97),a(107,"Stato iniziale"),n(),t(108,"select",103),y("ngModelChange",function(r){u(e);let d=m();return S(d.formData.status,r)||(d.formData.status=r),p(r)}),t(109,"option",112),a(110,"Bozza (non ancora attiva)"),n(),t(111,"option",113),a(112,"Attiva subito"),n(),t(113,"option",114),a(114,"Sospesa"),n()()(),t(115,"div",115)(116,"label",116)(117,"input",117),y("ngModelChange",function(r){u(e);let d=m();return S(d.formData.is_public,r)||(d.formData.is_public=r),p(r)}),n(),t(118,"div",118)(119,"strong"),a(120,"Visibile ai clienti"),n(),t(121,"span",40),a(122,"La promozione apparir\xE0 nel men\xF9 pubblico"),n()()()()()(),t(123,"div",119)(124,"button",120),_("click",function(){u(e);let r=m();return p(r.closeFormModal())}),a(125," Annulla "),n(),t(126,"button",121),_("click",function(){u(e);let r=m();return p(r.savePromotion())}),x(127,Ge,2,0,"span",122)(128,qe,2,0,"span",123)(129,He,4,2,"ng-container",41),n()()()()}if(l&2){let e=m();o(5),g(e.selectedPromotion?"edit":"add_circle"),o(2),f(" ",e.selectedPromotion?"Modifica promozione":"Nuova promozione"," "),o(13),v("ngModel",e.formData.name),o(5),v("ngModel",e.formData.description),o(6),v("ngModel",e.formData.internal_note),o(10),v("ngModel",e.formData.type),o(),c("ngForOf",e.promotionTypes),o(4),v("ngModel",e.formData.target),o(),c("ngForOf",e.discountTargets),o(6),g(e.discountSuffix),o(),v("ngModel",e.formData.discount_value),c("placeholder",e.formData.type==="percentage"?"10":"5.00"),o(),c("ngIf",e.showMaxCap),o(4),v("ngModel",e.formData.min_order_amount),o(10),v("ngModel",e.formData.valid_from),o(6),v("ngModel",e.formData.valid_until),o(7),v("ngModel",e.formData.max_uses_total),o(4),v("ngModel",e.formData.max_uses_per_customer),o(10),v("ngModel",e.formData.stacking),o(),c("ngForOf",e.stackingPolicies),o(6),v("ngModel",e.formData.priority),o(5),v("ngModel",e.formData.status),o(9),v("ngModel",e.formData.is_public),o(7),c("disabled",e.isSaving),o(2),c("disabled",e.isSaving||!e.formData.name.trim()),o(),c("ngIf",e.isSaving),o(),c("ngIf",e.isSaving),o(),c("ngIf",!e.isSaving)}}function Qe(l,i){if(l&1){let e=b();t(0,"div",86),_("click.self",function(){u(e);let r=m();return p(r.closeDeleteModal())}),t(1,"div",127)(2,"div",88)(3,"div",24)(4,"span",128),a(5,"delete_forever"),n(),t(6,"span",90),a(7,"Elimina promozione"),n()(),t(8,"button",91),_("click",function(){u(e);let r=m();return p(r.closeDeleteModal())}),t(9,"span",18),a(10,"close"),n()()(),t(11,"div",92)(12,"p",68),a(13,"Stai per eliminare:"),n(),t(14,"div",129)(15,"span",39),a(16),n(),t(17,"span",5),a(18),n()(),t(19,"p",130),a(20," Questa azione \xE8 irreversibile. Gli utilizzi gi\xE0 registrati non verranno cancellati. "),n()(),t(21,"div",119)(22,"button",120),_("click",function(){u(e);let r=m();return p(r.closeDeleteModal())}),a(23," Annulla "),n(),t(24,"button",131),_("click",function(){u(e);let r=m();return p(r.confirmDelete())}),t(25,"span",18),a(26,"delete_forever"),n(),a(27," Elimina definitivamente "),n()()()()}if(l&2){let e=m();o(16),g(e.selectedPromotion==null?null:e.selectedPromotion.name),o(2),g(e.formatDiscount(e.selectedPromotion)),o(4),c("disabled",e.isSaving),o(2),c("disabled",e.isSaving)}}function Ye(l,i){l&1&&(t(0,"div",35)(1,"span",36),a(2,"refresh"),n()())}function Je(l,i){if(l&1&&(t(0,"div",138)(1,"span",89),a(2,"donut_large"),n(),t(3,"span",5),a(4,"Saturazione"),n(),t(5,"span",6),a(6),n()()),l&2){let e=m(3);o(6),f("",e.getUsagePercent(e.selectedPromotion),"%")}}function Xe(l,i){if(l&1&&(t(0,"div",137)(1,"div",138)(2,"span",89),a(3,"receipt_long"),n(),t(4,"span",5),a(5,"Utilizzi totali"),n(),t(6,"span",6),a(7),n()(),t(8,"div",138)(9,"span",89),a(10,"savings"),n(),t(11,"span",5),a(12,"Sconto erogato"),n(),t(13,"span",6),a(14),F(15,"number"),n()(),t(16,"div",138)(17,"span",89),a(18,"shopping_basket"),n(),t(19,"span",5),a(20,"Scontrino medio"),n(),t(21,"span",6),a(22),F(23,"number"),n()(),x(24,Je,7,1,"div",139),n()),l&2){let e=m(2);o(7),g(e.selectedStats.total_uses),o(7),f("\u20AC",N(15,4,e.selectedStats.total_discount_given,"1.2-2"),""),o(8),f("\u20AC",N(23,7,e.selectedStats.avg_order_value,"1.2-2"),""),o(2),c("ngIf",e.selectedPromotion==null?null:e.selectedPromotion.max_uses_total)}}function Ze(l,i){l&1&&(t(0,"div",140)(1,"span",38),a(2,"bar_chart"),n(),t(3,"p",130),a(4,"Nessun utilizzo registrato ancora"),n()())}function et(l,i){if(l&1){let e=b();t(0,"div",86),_("click.self",function(){u(e);let r=m();return p(r.closeStatsModal())}),t(1,"div",132)(2,"div",88)(3,"div",24)(4,"span",89),a(5,"bar_chart"),n(),t(6,"span",90),a(7,"Statistiche"),n()(),t(8,"button",91),_("click",function(){u(e);let r=m();return p(r.closeStatsModal())}),t(9,"span",18),a(10,"close"),n()()(),t(11,"div",92)(12,"p",133),a(13),n(),x(14,Ye,3,0,"div",19)(15,Xe,25,10,"div",134)(16,Ze,5,0,"div",135),n(),t(17,"div",119)(18,"button",136),_("click",function(){u(e);let r=m();return p(r.closeStatsModal())}),a(19," Chiudi "),n()()()()}if(l&2){let e=m();o(13),g(e.selectedPromotion==null?null:e.selectedPromotion.name),o(),c("ngIf",e.loadingStats),o(),c("ngIf",!e.loadingStats&&e.selectedStats),o(),c("ngIf",!e.loadingStats&&!e.selectedStats)}}var Se=class l{promotionService=E(L);destroy$=new O;followerService=E(fe);authService=E(J);promoNotifService=E(ve);supabaseService=E(Y);promotions=[];loading=!1;error=null;followerCount=0;followers=[];isLoadingFollowers=!1;notifiedPromotions=new Set;sendingNotification=null;daysUntilNext=0;activeFilter=j("all");statusCounts={all:0,draft:0,active:0,paused:0,expired:0,archived:0};showFormModal=!1;showDeleteModal=!1;showStatsModal=!1;isSaving=!1;selectedPromotion=null;formData=W();selectedStats=null;loadingStats=!1;typeLabels=ce;statusLabels=ue;targetLabels=pe;stackingLabels=_e;promotionTypes=["percentage","fixed_amount","happy_hour","buy_x_get_y","free_item"];discountTargets=["order","category","product","delivery"];stackingPolicies=["exclusive","cumulative","best_deal"];filterTabs=[{key:"all",label:"Tutte"},{key:"active",label:"Attive"},{key:"draft",label:"Bozze"},{key:"paused",label:"Sospese"},{key:"expired",label:"Scadute"},{key:"archived",label:"Archivio"}];get filteredPromotions(){let i=this.activeFilter();return i==="all"?this.promotions:this.promotions.filter(e=>e.status===i)}ngOnInit(){this.promotionService.data$.pipe(P(this.destroy$)).subscribe(i=>{this.promotions=i,this.statusCounts=this.promotionService.getStatusCounts(),this.loadNotificationStates()}),this.promotionService.loading$.pipe(P(this.destroy$)).subscribe(i=>this.loading=i),this.promotionService.error$.pipe(P(this.destroy$)).subscribe(i=>this.error=i),this.promotionService.loadData(),this.authService.activeRestaurantId$.pipe(P(this.destroy$),B(i=>!!i)).subscribe(i=>{this.loadFollowers(i)})}ngOnDestroy(){this.destroy$.next(),this.destroy$.complete()}setFilter(i){this.activeFilter.set(i)}openCreateModal(){this.selectedPromotion=null,this.formData=W(),this.showFormModal=!0}openEditModal(i){this.selectedPromotion=i,this.formData={name:i.name,description:i.description??null,internal_note:i.internal_note??null,image_url:i.image_url??null,type:i.type,target:i.target,discount_value:i.discount_value,max_discount_amount:i.max_discount_amount??null,valid_from:i.valid_from.split("T")[0],valid_until:i.valid_until?i.valid_until.split("T")[0]:null,max_uses_total:i.max_uses_total??null,max_uses_per_customer:i.max_uses_per_customer??null,min_order_amount:i.min_order_amount,priority:i.priority,stacking:i.stacking,status:i.status,is_public:i.is_public},this.showFormModal=!0}closeFormModal(){this.showFormModal=!1,this.selectedPromotion=null}savePromotion(){return h(this,null,function*(){if(this.formData.name?.trim()){this.isSaving=!0;try{this.selectedPromotion?yield this.promotionService.update(this.selectedPromotion.id,this.formData):yield this.promotionService.create(this.formData),this.closeFormModal()}finally{this.isSaving=!1}}})}openDeleteModal(i){this.selectedPromotion=i,this.showDeleteModal=!0}closeDeleteModal(){this.showDeleteModal=!1,this.selectedPromotion=null}confirmDelete(){return h(this,null,function*(){if(this.selectedPromotion){this.isSaving=!0;try{yield this.promotionService.delete(this.selectedPromotion.id),this.closeDeleteModal()}finally{this.isSaving=!1}}})}toggleStatus(i){return h(this,null,function*(){yield this.promotionService.toggleActiveState(i)})}duplicate(i){return h(this,null,function*(){yield this.promotionService.duplicate(i)})}publishDraft(i){return h(this,null,function*(){yield this.promotionService.toggleStatus(i.id,"active")})}openStatsModal(i){return h(this,null,function*(){this.selectedPromotion=i,this.selectedStats=null,this.showStatsModal=!0,this.loadingStats=!0;try{this.selectedStats=yield this.promotionService.getStats(i.id)}finally{this.loadingStats=!1}})}closeStatsModal(){this.showStatsModal=!1,this.selectedPromotion=null,this.selectedStats=null}formatDiscount(i){return this.promotionService.formatDiscountValue(i)}isExpired(i){return this.promotionService.isExpired(i)}formatDate(i){return i?new Date(i).toLocaleDateString("it-IT",{day:"2-digit",month:"short",year:"numeric"}):"\u221E"}get discountSuffix(){return this.formData.type==="percentage"?"%":"\u20AC"}get showMaxCap(){return this.formData.type==="percentage"}canToggle(i){return i.status!=="expired"&&i.status!=="archived"}getUsagePercent(i){return!i.max_uses_total||i.max_uses_total===0?0:Math.min(100,Math.round(i.current_uses/i.max_uses_total*100))}trackById(i,e){return e.id}objectKeys(i){return Object.keys(i)}loadFollowers(i){return h(this,null,function*(){this.isLoadingFollowers=!0;try{this.followers=yield this.followerService.getFollowersForRestaurant(i),this.followerCount=this.followers.length}finally{this.isLoadingFollowers=!1}})}loadNotificationStates(){return h(this,null,function*(){let i=yield this.promoNotifService.daysUntilNextAllowed();this.daysUntilNext=i;for(let e of this.promotions)(yield this.promoNotifService.hasBeenNotified(e.id))&&this.notifiedPromotions.add(e.id)})}sendNotification(i){return h(this,null,function*(){if(!this.sendingNotification){this.sendingNotification=i.id;try{if(!this.authService.isRestaurantUser()){alert("\u26A0\uFE0F Devi essere in modalit\xE0 ristorante per inviare promozioni.");return}let e=this.authService.getCurrentRestaurantId();if(!e){alert("\u26A0\uFE0F Nessun ristorante attivo selezionato.");return}if((yield this.followerService.getFollowersForRestaurant(e)).filter(w=>w.users).length===0){alert("\u26A0\uFE0F Nessun follower con notifiche push attive.");return}let d=yield this.promoNotifService.daysUntilNextAllowed();if(d>0){alert(`\u26A0\uFE0F Limite settimanale raggiunto. Riprova tra ${d} giorni.`);return}let k=yield this.promoNotifService.sendPromotionPush(i.id);if(k.success)this.notifiedPromotions.add(i.id),this.daysUntilNext=7,alert(`\u2705 Notifica inviata a ${k.sent} follower`);else{let w={already_sent:"Notifica gi\xE0 inviata per questa promozione.",weekly_limit:`Limite settimanale raggiunto. Riprova tra ${this.daysUntilNext} giorni.`,no_recipients:"Nessun follower con notifiche push attive.",unknown:k.message||"Errore sconosciuto"},C=k.errorCode??"unknown";alert("\u26A0\uFE0F "+w[C])}}catch(e){console.error("Errore in sendNotification:",e),alert("\u274C Errore durante l'invio della notifica. Controlla console.")}finally{this.sendingNotification=null}}})}canSendNotification(i){return i.status==="active"&&!this.notifiedPromotions.has(i.id)&&this.daysUntilNext===0&&this.sendingNotification===null}static \u0275fac=function(e){return new(e||l)};static \u0275cmp=R({type:l,selectors:[["app-marketing-management"]],decls:59,vars:23,consts:[[1,"page-container"],[1,"p-lg"],[1,"grid-cards","mb-lg"],[1,"card","p-md","items-center","text-center","gap-sm"],["name","tag",2,"color","var(--primary)",3,"size"],[1,"text-muted","text-mini"],[1,"font-bold","text-md"],["name","zap",2,"color","#10b981",3,"size"],[1,"font-bold","text-md",2,"color","#10b981"],["name","file-text",2,"color","var(--tertiary)",3,"size"],["name","pause-circle",2,"color","#f59e0b",3,"size"],[1,"font-bold","text-md",2,"color","#f59e0b"],["name","calendar-x",2,"color","var(--text-muted)",3,"size"],["class","info-message mb-lg",4,"ngIf"],[1,"flex","justify-between","gap-sm"],[1,"flex","flex-wrap","gap-sm","mb-lg"],["class","chip","style","cursor: pointer",3,"active","click",4,"ngFor","ngForOf"],[1,"promethea-button",3,"click"],[1,"material-icons"],["class","flex justify-center p-lg",4,"ngIf"],["class","card p-lg text-center gap-md items-center",4,"ngIf"],["class","grid-cards",4,"ngIf"],[1,"card","p-md","mt-lg"],[1,"flex","items-center","justify-between","mb-md"],[1,"flex","items-center","gap-sm"],["name","heart",2,"color","#e11d48",3,"size"],[1,"section-title","m-0"],[1,"chip","bg-primary","font-bold"],["class","text-center py-lg text-muted",4,"ngIf"],["class","text-center py-md text-muted",4,"ngIf"],["class","table-section",4,"ngIf"],["class","modal-overlay",3,"click.self",4,"ngIf"],[1,"info-message","mb-lg"],[1,"chip",2,"cursor","pointer",3,"click"],[1,"chip-mini",2,"margin-left","4px"],[1,"flex","justify-center","p-lg"],[1,"material-icons","animate-spin","gradient-text","text-lg"],[1,"card","p-lg","text-center","gap-md","items-center"],[1,"material-icons","text-lg",2,"opacity","0.3"],[1,"font-bold"],[1,"text-muted"],[4,"ngIf"],["class","promethea-button",3,"click",4,"ngIf"],[1,"grid-cards"],["class","card promotion-card",3,"expired-card",4,"ngFor","ngForOf","ngForTrackBy"],[1,"card","promotion-card"],[1,"flex","justify-between","items-center","gap-sm","mb-sm"],[1,"chip-mini"],[1,"card-title"],["class","text-muted text-mini mb-sm",4,"ngIf"],[1,"discount-badge","flex","items-center","justify-center","p-sm","rounded","mb-sm",2,"background","color-mix(in srgb, var(--primary) 12%, transparent)"],[1,"font-bold","text-md","gradient-text"],[1,"text-mini","text-muted",2,"margin-left","6px"],[1,"flex","gap-sm","items-center","mb-sm"],[1,"material-icons","text-mini","text-muted"],[1,"text-mini","text-muted"],["class","mb-sm",4,"ngIf"],["class","flex items-center gap-sm mb-sm",4,"ngIf"],[1,"card-footer","flex","gap-sm","flex-wrap","justify-between"],["class","promethea-button","style","flex: 1; font-size: var(--fs-mini)",3,"click",4,"ngIf"],["class","promethea-button ghost","style","flex: 1; font-size: var(--fs-mini)",3,"click",4,"ngIf"],["class","icon-button x-small",3,"title","disabled","click",4,"ngIf"],[1,"flex","gap-sm"],["title","Statistiche",1,"icon-button","x-small",3,"click"],["title","Duplica",1,"icon-button","x-small",3,"click"],["title","Modifica",1,"icon-button","x-small",3,"click"],["title","Elimina",1,"icon-button","x-small",2,"color","var(--secondary)",3,"click"],[1,"text-muted","text-mini","mb-sm"],[1,"mb-sm"],[1,"flex","justify-between","text-mini","text-muted","mb-sm"],[1,"usage-bar"],[1,"usage-fill"],[1,"flex","items-center","gap-sm","mb-sm"],[1,"promethea-button",2,"flex","1","font-size","var(--fs-mini)",3,"click"],[1,"promethea-button","ghost",2,"flex","1","font-size","var(--fs-mini)",3,"click"],[1,"icon-button","x-small",3,"click","title","disabled"],[3,"name","size"],[1,"text-center","py-lg","text-muted"],["name","users",1,"mb-sm",3,"size"],[1,"text-center","py-md","text-muted"],["name","loader",3,"size"],[1,"table-section"],[1,"crm-table"],[4,"ngFor","ngForOf"],["name","user",1,"text-muted",3,"size"],[1,"font-semibold"],[1,"modal-overlay",3,"click.self"],[1,"modal-container","modal-lg"],[1,"modal-header"],[1,"material-icons","gradient-text"],[1,"section-title"],[1,"icon-button",3,"click"],[1,"form-card"],[1,"font-bold","mb-sm","flex","items-center","gap-sm"],[1,"material-icons","text-mini","gradient-text"],[1,"form-row"],[1,"form-group"],[1,"standard-label"],["type","text","placeholder","Es. Sconto Aperitivo Serale","maxlength","80",3,"ngModelChange","ngModel"],["placeholder","Testo che vedr\xE0 il cliente","rows","2",2,"min-height","4rem",3,"ngModelChange","ngModel"],[1,"material-icons","text-mini"],["placeholder","Solo per il tuo staff (non visibile al cliente)","rows","2",2,"min-height","4rem",3,"ngModelChange","ngModel"],[2,"border-color","var(--smoke-1)","margin","var(--gap-md) 0"],[3,"ngModelChange","ngModel"],[3,"value",4,"ngFor","ngForOf"],["type","number","min","0","step","0.01",3,"ngModelChange","ngModel","placeholder"],["class","form-group",4,"ngIf"],["type","number","placeholder","0 = nessun minimo","min","0","step","0.01",3,"ngModelChange","ngModel"],["type","date",3,"ngModelChange","ngModel"],["type","number","placeholder","Es. 100","min","1",3,"ngModelChange","ngModel"],["type","number","placeholder","1","min","1",3,"ngModelChange","ngModel"],["type","number","placeholder","0","min","0","max","100",3,"ngModelChange","ngModel"],["value","draft"],["value","active"],["value","paused"],[1,"form-group",2,"justify-content","center"],[1,"checkbox-label"],["type","checkbox",3,"ngModelChange","ngModel"],[1,"checkbox-content"],[1,"modal-footer"],[1,"promethea-button","ghost",3,"click","disabled"],[1,"promethea-button",3,"click","disabled"],["class","material-icons",4,"ngIf"],["class","animate-spin",4,"ngIf"],[3,"value"],["type","number","placeholder","Es. 15 \u2192 max \u20AC15 anche se % \xE8 alta","min","0","step","0.01",3,"ngModelChange","ngModel"],[1,"animate-spin"],[1,"modal-container","modal-sm"],[1,"material-icons",2,"color","var(--secondary)"],[1,"card","p-md","gap-sm",2,"background","color-mix(in srgb, var(--secondary) 8%, transparent)"],[1,"text-muted","mt-sm"],[1,"promethea-button",2,"background","var(--secondary)",3,"click","disabled"],[1,"modal-container","modal-md"],[1,"font-bold","mb-lg"],["class","grid-cards","style","grid-template-columns: repeat(auto-fit, minmax(140px, 1fr))",4,"ngIf"],["class","text-center p-lg",4,"ngIf"],[1,"promethea-button","ghost",3,"click"],[1,"grid-cards",2,"grid-template-columns","repeat(auto-fit, minmax(140px, 1fr))"],[1,"card","p-md","text-center","gap-sm","items-center"],["class","card p-md text-center gap-sm items-center",4,"ngIf"],[1,"text-center","p-lg"]],template:function(e,s){e&1&&(t(0,"div",0)(1,"div",1)(2,"div",2)(3,"div",3),M(4,"lucide-angular",4),t(5,"span",5),a(6,"Totale"),n(),t(7,"span",6),a(8),n()(),t(9,"div",3),M(10,"lucide-angular",7),t(11,"span",5),a(12,"Attive ora"),n(),t(13,"span",8),a(14),n()(),t(15,"div",3),M(16,"lucide-angular",9),t(17,"span",5),a(18,"Bozze"),n(),t(19,"span",6),a(20),n()(),t(21,"div",3),M(22,"lucide-angular",10),t(23,"span",5),a(24,"Sospese"),n(),t(25,"span",11),a(26),n()(),t(27,"div",3),M(28,"lucide-angular",12),t(29,"span",5),a(30,"Scadute"),n(),t(31,"span",6),a(32),n()()(),x(33,he,5,1,"div",13),t(34,"div",14)(35,"div",15),x(36,Me,4,4,"button",16),n(),t(37,"button",17),_("click",function(){return s.openCreateModal()}),t(38,"span",18),a(39,"add"),n(),t(40,"span"),a(41,"Nuova promo"),n()()(),x(42,be,3,0,"div",19)(43,Ce,9,3,"div",20)(44,Le,2,2,"div",21),t(45,"div",22)(46,"div",23)(47,"div",24),M(48,"lucide-angular",25),t(49,"h3",26),a(50,"Follower"),n(),t(51,"span",27),a(52),n()()(),x(53,We,4,1,"div",28)(54,Oe,2,1,"div",29)(55,Ae,12,1,"div",30),n()()(),x(56,Ke,130,28,"div",31)(57,Qe,28,4,"div",31)(58,et,20,4,"div",31)),e&2&&(o(4),c("size",24),o(4),g(s.statusCounts.all),o(2),c("size",24),o(4),g(s.statusCounts.active),o(2),c("size",24),o(4),g(s.statusCounts.draft),o(2),c("size",24),o(4),g(s.statusCounts.paused),o(2),c("size",24),o(4),g(s.statusCounts.expired),o(),c("ngIf",s.error),o(3),c("ngForOf",s.filterTabs),o(6),c("ngIf",s.loading&&s.promotions.length===0),o(),c("ngIf",!s.loading&&s.filteredPromotions.length===0),o(),c("ngIf",s.filteredPromotions.length>0),o(4),c("size",22),o(4),g(s.followerCount),o(),c("ngIf",!s.isLoadingFollowers&&s.followers.length===0),o(),c("ngIf",s.isLoadingFollowers),o(),c("ngIf",!s.isLoadingFollowers&&s.followers.length>0),o(),c("ngIf",s.showFormModal),o(),c("ngIf",s.showDeleteModal),o(),c("ngIf",s.showStatsModal))},dependencies:[Q,G,q,K,H,de,ae,re,Z,ie,X,ne,ee,se,le,oe,te,xe,ge],styles:[".usage-bar[_ngcontent-%COMP%]{width:100%;height:6px;background:var(--smoke-1);border-radius:999px;overflow:hidden}.usage-fill[_ngcontent-%COMP%]{height:100%;background:var(--gradiente);border-radius:999px;transition:width .4s ease}.usage-danger[_ngcontent-%COMP%]{background:linear-gradient(135deg,#f59e0b,var(--secondary))}.expired-card[_ngcontent-%COMP%]{opacity:.65;filter:grayscale(30%)}.discount-badge[_ngcontent-%COMP%]{border-radius:12px;min-height:44px}"]})};export{Se as MarketingManagement};
