import{a as p}from"./chunk-VQ7WJPK7.js";import{A as o,M as n,_ as f,a as c,b as g,g as i}from"./chunk-3SWAHN2Y.js";var x=class s extends p{getTableName(){return"categories"}constructor(){super(),this.authService.currentUser$.pipe(n(1)).subscribe(e=>{e&&this.loadData()})}getDefaultCategory(){return this.data$.pipe(o(e=>e.find(r=>r.is_default)||null))}getNonDefaultCategories(){return this.data$.pipe(o(e=>e.filter(r=>!r.is_default)))}getCategoriesSorted(){return this.data$.pipe(o(e=>[...e].sort((r,t)=>r.order_index-t.order_index)))}createCategory(e){return i(this,null,function*(){if(console.log("\u{1F4DD} Creating category:",e),!e.name||e.name.trim()==="")return this.errorSubject.next("Il nome della categoria \xE8 obbligatorio"),null;let r=yield this.getNextOrderIndex();if(r===null)return this.errorSubject.next("Impossibile determinare order_index"),null;let t=g(c({},e),{order_index:r});return this.create(t)})}createDefaultCategory(e,r){return i(this,null,function*(){if(yield this.getDefaultCategory().pipe(n(1)).toPromise())return this.errorSubject.next("Esiste gi\xE0 una categoria di default"),null;let a={name:e,description:r||null,is_default:!0,order_index:0};return this.create(a)})}reorderCategories(e){return i(this,null,function*(){try{let r=e.map((t,a)=>this.update(t,{order_index:a}));return yield Promise.all(r),!0}catch(r){return console.error("Error reordering categories:",r),this.errorSubject.next("Errore nel riordinamento delle categorie"),!1}})}moveCategory(e,r){return i(this,null,function*(){let t=yield this.data$.pipe(n(1)).toPromise();if(!t)return!1;let a=t.findIndex(m=>m.id===e);if(a===-1)return!1;let d=r==="up"?a-1:a+1;if(d<0||d>=t.length)return this.errorSubject.next(`Impossibile spostare la categoria ${r}`),!1;let u=t[a],l=t[d];return yield this.update(u.id,{order_index:l.order_index}),yield this.update(l.id,{order_index:u.order_index}),!0})}getNextOrderIndex(){return i(this,null,function*(){try{let e=yield this.getCurrentRestaurantId();if(!e)return null;let{data:r,error:t}=yield this.supabaseService.getSupabaseClient().from("categories").select("order_index").eq("restaurant_id",e).order("order_index",{ascending:!1}).limit(1);return t?(console.error("Error getting next order index:",t),0):!r||r.length===0?0:r[0].order_index+1}catch(e){return console.error("Error in getNextOrderIndex:",e),0}})}loadCategories(){return i(this,null,function*(){return this.loadData()})}getCategories(){return this.dataSubject.value}static \u0275fac=function(r){return new(r||s)};static \u0275prov=f({token:s,factory:s.\u0275fac,providedIn:"root"})};export{x as a};
