import{b as h}from"./chunk-TAPIY3IR.js";import{b as p}from"./chunk-HZAFCD3S.js";import{_ as g,a as y,b as w,da as m,g as i,m as b}from"./chunk-3SWAHN2Y.js";var f=class c{supabaseService=m(p);authService=m(h);generateTavolataId(){return typeof crypto<"u"&&crypto.randomUUID?crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(r){let e=Math.random()*16|0;return(r==="x"?e:e&3|8).toString(16)})}getCurrentTavolataId(r){return i(this,null,function*(){try{let e=yield this.getCurrentRestaurantId();if(!e)return null;let{data:t,error:a}=yield this.supabaseService.getSupabaseClient().from("orders").select("tavolata_id, status").eq("restaurant_id",e).eq("table_id",r).not("status","in",'("completed", "cancelled", "paid")').order("created_at",{ascending:!1}).limit(1);return a?(console.error("\u274C Error getting current tavolata:",a),null):(console.log("\u{1F4CB} Tavolata corrente trovata:",t?.[0]?.tavolata_id),t&&t.length>0?t[0].tavolata_id:null)}catch(e){return console.error("Error getting current tavolata:",e),null}})}startNewTavolata(r){return i(this,null,function*(){try{let e=this.generateTavolataId();return console.log("\u{1F195} Creazione nuova tavolata:",e,"per tavolo:",r),e}catch(e){return console.error("\u274C Errore in startNewTavolata:",e),`tavolata_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}})}isTavolataActive(r){return i(this,null,function*(){try{let{data:e,error:t}=yield this.supabaseService.getSupabaseClient().from("orders").select("id").eq("tavolata_id",r).not("status","in",'("completed", "cancelled", "paid")').limit(1);if(t)throw t;return e&&e.length>0||!1}catch(e){return console.error("Error checking tavolata:",e),!1}})}getCurrentRestaurantId(){return i(this,null,function*(){let r=this.authService.currentUserValue;if(!r)return console.error("Nessun utente autenticato"),null;let e=this.authService.getCurrentStaffRestaurantId();if(e)return e;try{let{data:t,error:a}=yield this.supabaseService.getSupabaseClient().from("restaurants").select("id").eq("owner_id",r.id).limit(1).single();return a?(console.error("Error getting restaurant by owner:",a),null):t?.id||null}catch(t){return console.error("Exception getting restaurant:",t),null}})}static \u0275fac=function(e){return new(e||c)};static \u0275prov=g({token:c,factory:c.\u0275fac,providedIn:"root"})};var _=class c{orderUpdatesSubject=new b;orderUpdates$=this.orderUpdatesSubject.asObservable();tableUpdatesSubject=new b;tableUpdates$=this.tableUpdatesSubject.asObservable();notifyOrderUpdate(r){this.orderUpdatesSubject.next(r)}notifyTableUpdate(r){this.tableUpdatesSubject.next(r)}notifyDataChange(){this.orderUpdatesSubject.next("refresh_all")}static \u0275fac=function(e){return new(e||c)};static \u0275prov=g({token:c,factory:c.\u0275fac,providedIn:"root"})};var C=class c{notificationService=m(_);tavolataService=m(f);supabaseService=m(p);authService=m(h);operationLocks=new Map;getOrderHeadersByTavolata(r){return i(this,null,function*(){try{let{data:e,error:t}=yield this.supabaseService.getSupabaseClient().from("order_headers").select(`
          *,
          table:table_id (
            table_number,
            table_name
          ),
          orders:orders!order_header_id (
            *,
            order_items (
              *,
              dish:dish_id (
                name,
                base_price,
                category_id
              )
            )
          )
        `).eq("tavolata_id",r).order("created_at",{ascending:!0});if(t)throw t;return(e||[]).map(a=>w(y({},a),{orders:(a.orders||[]).sort((s,o)=>(s.comanda_number||0)-(o.comanda_number||0))}))}catch(e){return console.error("\u274C Errore caricamento order_headers:",e),[]}})}createNewOrderHeader(r,e,t="Cliente"){return i(this,null,function*(){try{let a=yield this.getCurrentRestaurantId();if(!a)return console.error("\u274C Nessun ristorante trovato"),null;let s=yield this.generateOrderNumber(e),{data:o,error:n}=yield this.supabaseService.getSupabaseClient().from("order_headers").insert({restaurant_id:a,table_id:r,tavolata_id:e,order_number:s,status:"active",customer_name:t,total_amount:0,created_at:new Date().toISOString(),updated_at:new Date().toISOString()}).select().single();if(n)throw n;let d=yield this.createOrderForHeader(r,o.id,e);return console.log(`\u2705 Creato ordine: ${s} con comanda 1`),{header:o,order:d}}catch(a){return console.error("\u274C Errore creazione nuovo ordine:",a),null}})}createOrderForHeader(r,e,t){return i(this,null,function*(){try{if(e.startsWith("temp-"))return console.warn("\u26A0\uFE0F Tentativo di creare comanda per header temporaneo:",e),this.createTempOrder(r,e,t);let a=yield this.getCurrentRestaurantId();if(!a)throw new Error("Nessun ristorante");let s=yield this.getNextComandaNumber(e),o={restaurant_id:a,table_id:r,order_header_id:e,tavolata_id:t,comanda_number:s,order_number:`COM-${Date.now()}-${s}`,order_type:"dine_in",status:"received",subtotal:0,tax_amount:0,discount_amount:0,total_amount:0,customer_name:"Cliente",created_at:new Date().toISOString(),updated_at:new Date().toISOString()},{data:n,error:d}=yield this.supabaseService.getSupabaseClient().from("orders").insert(o).select(`
        *,
        order_items (
          *,
          dish:dish_id (
            name,
            base_price
          )
        )
      `).single();if(d)throw d;return n}catch(a){throw console.error("\u274C Errore creazione comanda:",a),a}})}createTempOrder(r,e,t,a=1){return{id:`temp-order-${Date.now()}`,restaurant_id:"temp",table_id:r,order_header_id:e,tavolata_id:t,comanda_number:a,order_number:`TEMP-COM-${Date.now()}-${a}`,order_type:"dine_in",status:"draft",subtotal:0,tax_amount:0,discount_amount:0,total_amount:0,customer_name:"Cliente",created_at:new Date().toISOString(),updated_at:new Date().toISOString(),order_items:[]}}refreshOrder(r){return i(this,null,function*(){try{let{data:e,error:t}=yield this.supabaseService.getSupabaseClient().from("orders").select(`
          *,
          order_items (
            *,
            dish:dish_id (
              name,
              base_price
            )
          )
        `).eq("id",r).single();if(t)throw t;return e}catch(e){return console.error("\u274C Errore refresh ordine:",e),null}})}addDishToOrder(r,e,t=1,a){return i(this,null,function*(){let s=`add-${r}-${e.id}`;if(this.operationLocks.has(s))return yield this.operationLocks.get(s),!1;let o=new Promise(n=>{this.operationLocks.set(s,Promise.resolve())});try{let n=a?.trim()||null;console.log(`\u{1F50D} Cerco ${e.name} nella comanda ${r}`);let{data:d,error:u}=yield this.supabaseService.getSupabaseClient().from("order_items").select("id, quantity, unit_price").eq("order_id",r).eq("dish_id",e.id);if(u&&console.error("\u274C Errore ricerca item:",u),d&&d.length>0){let l=d[0],v=l.quantity+t;console.log(`\u2705 Trovato esistente: ${l.quantity} \u2192 ${v}`);let{error:S}=yield this.supabaseService.getSupabaseClient().from("order_items").update({quantity:v,updated_at:new Date().toISOString()}).eq("id",l.id);if(S)return console.error("\u274C Errore aggiornamento:",S),!1}else{console.log(`\u2795 Nuovo item per ${e.name}`);let{error:l}=yield this.supabaseService.getSupabaseClient().from("order_items").insert({order_id:r,dish_id:e.id,quantity:t,unit_price:e.base_price,status:"waiting",item_notes:n,created_at:new Date().toISOString(),updated_at:new Date().toISOString()});if(l)return console.error("\u274C Errore inserimento:",l),!1}return yield this.updateOrderTotal(r),this.notificationService.notifyOrderUpdate(r),!0}catch(n){return console.error("\u274C Errore addDishToOrder:",n),!1}finally{this.operationLocks.delete(s)}})}updateOrderItemQuantity(r,e){return i(this,null,function*(){if(r.startsWith("temp-"))return!1;try{let{data:t,error:a}=yield this.supabaseService.getSupabaseClient().from("order_items").select("quantity, order_id, unit_price").eq("id",r).single();if(a)throw a;let s=t.quantity+e;if(s<1)return yield this.deleteOrderItem(r);let{error:o}=yield this.supabaseService.getSupabaseClient().from("order_items").update({quantity:s,updated_at:new Date().toISOString()}).eq("id",r);if(o)throw o;return yield this.updateOrderTotal(t.order_id),this.notificationService.notifyOrderUpdate(t.order_id),!0}catch(t){return console.error("\u274C Errore aggiornamento quantit\xE0:",t),!1}})}deleteOrderItem(r){return i(this,null,function*(){try{let{data:e,error:t}=yield this.supabaseService.getSupabaseClient().from("order_items").select("order_id").eq("id",r).single();if(t)throw t;let{error:a}=yield this.supabaseService.getSupabaseClient().from("order_items").delete().eq("id",r);if(a)throw a;return yield this.updateOrderTotal(e.order_id),!0}catch(e){return console.error("\u274C Errore eliminazione item:",e),!1}})}getNextComandaNumber(r){return i(this,null,function*(){if(r.startsWith("temp-"))return 1;try{let{data:e,error:t}=yield this.supabaseService.getSupabaseClient().from("orders").select("comanda_number").eq("order_header_id",r).order("comanda_number",{ascending:!1}).limit(1);return t?(console.error("\u274C Errore recupero comande:",t),1):e&&e.length>0?e[0].comanda_number+1:1}catch(e){return console.error("\u274C Errore getNextComandaNumber:",e),1}})}updateOrderTotal(r){return i(this,null,function*(){try{let{data:e,error:t}=yield this.supabaseService.getSupabaseClient().from("order_items").select("total_price").eq("order_id",r);if(t)throw t;let a=e.reduce((o,n)=>o+(n.total_price||0),0),{error:s}=yield this.supabaseService.getSupabaseClient().from("orders").update({subtotal:a,total_amount:a,updated_at:new Date().toISOString()}).eq("id",r);if(s)throw s}catch(e){console.error("\u274C Errore aggiornamento totale:",e)}})}calculateOrderTotal(r){return!r.order_items||r.order_items.length===0?0:r.order_items.reduce((e,t)=>e+(t.total_price||0),0)}calculateOrderHeaderTotal(r){return!r.orders||r.orders.length===0?0:r.orders.reduce((e,t)=>e+this.calculateOrderTotal(t),0)}calculateTavolataTotal(r){return r.reduce((e,t)=>e+this.calculateOrderHeaderTotal(t),0)}calculateOverallOrderStatus(r){return!r||r.length===0?"received":r.every(e=>e.status==="served")?"served":r.some(e=>e.status==="ready")?"ready":r.some(e=>e.status==="preparing")?"preparing":"received"}areAllItemsServed(r){return!r?.order_items||r.order_items.length===0?!1:r.order_items.every(e=>e.status==="served"||e.status==="out_of_stock")}getActiveOrders(){return i(this,null,function*(){try{let r=yield this.getCurrentRestaurantId();if(!r)return[];let{data:e,error:t}=yield this.supabaseService.getSupabaseClient().from("orders").select(`
          *,
          order_items (
            *,
            dish:dish_id (
              name,
              base_price
            )
          )
        `).eq("restaurant_id",r).in("status",["received","preparing","ready"]).order("created_at",{ascending:!1});if(t)throw t;return e||[]}catch(r){return console.error("\u274C Errore caricamento ordini attivi:",r),[]}})}closeTavolata(r,e){return i(this,null,function*(){try{let{error:t}=yield this.supabaseService.getSupabaseClient().from("orders").update({status:"completed",updated_at:new Date().toISOString()}).eq("table_id",r).eq("tavolata_id",e).in("status",["received","preparing","ready","served"]);if(t)throw t;return!0}catch(t){return console.error("\u274C Errore chiusura tavolata:",t),!1}})}getCurrentRestaurantId(){return i(this,null,function*(){let r=this.authService.currentUserValue;if(!r)return null;if(r.restaurant_id)return r.restaurant_id;try{let{data:e}=yield this.supabaseService.getSupabaseClient().from("restaurant_staff").select("restaurant_id").eq("user_id",r.id).single();return e?.restaurant_id||null}catch{return null}})}generateOrderNumber(r){return i(this,null,function*(){try{let e=Date.now(),t=Math.floor(Math.random()*1e3),a=`ORD-${e}-${t}`,{data:s}=yield this.supabaseService.getSupabaseClient().from("order_headers").select("id").eq("order_number",a).maybeSingle();return s?this.generateOrderNumber(r):a}catch(e){return console.error("\u274C Errore generazione numero ordine:",e),`ORD-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}})}deleteEmptyOrders(r){return i(this,null,function*(){try{let{data:e,error:t}=yield this.supabaseService.getSupabaseClient().from("orders").select("id").eq("order_header_id",r);if(t)throw t;let a=0,s=[];for(let o of e){let{data:n}=yield this.supabaseService.getSupabaseClient().from("order_items").select("id").eq("order_id",o.id).limit(1);(!n||n.length===0)&&(s.push(this.supabaseService.getSupabaseClient().from("orders").delete().eq("id",o.id)),a++)}return s.length>0&&(yield Promise.all(s)),console.log(`\u{1F5D1}\uFE0F Eliminate ${a} comande vuote`),a}catch(e){return console.error("\u274C Errore eliminazione comande vuote:",e),0}})}saveAndValidateOrder(r,e){return i(this,null,function*(){try{console.log(`\u{1F4BE} Salvataggio ordine per tavolata: ${r}, order header: ${e}`);let t=yield this.deleteEmptyOrders(e);return(yield this.orderHeaderHasItems(e))?(yield this.updateOrderHeaderTotal(e),{success:!0,message:t>0?`\u2705 Ordine salvato! Sono state rimosse ${t} comande vuote.`:"\u2705 Ordine salvato con successo!",deletedOrdersCount:t}):(yield this.supabaseService.getSupabaseClient().from("order_headers").delete().eq("id",e),{success:!1,message:"\u274C Aggiungi almeno un piatto!",deletedOrdersCount:t})}catch(t){return console.error("\u274C Errore salvataggio ordine:",t),{success:!1,message:"\u274C Errore durante il salvataggio"}}})}orderHeaderHasItems(r){return i(this,null,function*(){try{let{data:e,error:t}=yield this.supabaseService.getSupabaseClient().from("orders").select(`
          id,
          order_items (id)
        `).eq("order_header_id",r).limit(1);if(t)throw t;return e?.some(a=>a.order_items&&a.order_items.length>0)||!1}catch(e){return console.error("\u274C Errore verifica items:",e),!1}})}updateOrderHeaderTotal(r){return i(this,null,function*(){try{let{data:e,error:t}=yield this.supabaseService.getSupabaseClient().from("orders").select("total_amount").eq("order_header_id",r);if(t)throw t;let a=e.reduce((s,o)=>s+(o.total_amount||0),0);yield this.supabaseService.getSupabaseClient().from("order_headers").update({total_amount:a,updated_at:new Date().toISOString()}).eq("id",r)}catch(e){console.error("\u274C Errore aggiornamento totale header:",e)}})}getTableOrders(r,e){return i(this,null,function*(){try{let t=yield this.getCurrentRestaurantId();if(!t)return[];let a=this.supabaseService.getSupabaseClient().from("orders").select(`
        *,
        order_items (
          *,
          dish:dish_id (
            name,
            base_price,
            category_id
          )
        )
      `).eq("restaurant_id",t).eq("table_id",r).not("status","in",'("completed", "cancelled")').order("comanda_number",{ascending:!0});e&&(a=a.eq("tavolata_id",e));let{data:s,error:o}=yield a;return o?(console.error("\u274C Errore getTableOrders:",o),[]):s||[]}catch(t){return console.error("\u274C Errore getTableOrders:",t),[]}})}loadData(){return i(this,null,function*(){console.log("\u2139\uFE0F loadData chiamato - metodo mantenuto per compatibilit\xE0")})}getTodayOrders(){return i(this,null,function*(){try{let r=yield this.getCurrentRestaurantId();if(!r)return{count:0,revenue:0};let e=new Date,t=new Date(e.setHours(0,0,0,0)).toISOString(),a=new Date(e.setHours(23,59,59,999)).toISOString(),{data:s,error:o}=yield this.supabaseService.getSupabaseClient().from("orders").select("id, total_amount, status").eq("restaurant_id",r).gte("created_at",t).lte("created_at",a);if(o)return console.error("\u274C Error fetching today orders:",o),{count:0,revenue:0};let n=s?.filter(u=>u.status==="completed")||[],d=n.reduce((u,l)=>u+(l.total_amount||0),0);return{count:n.length,revenue:d}}catch(r){return console.error("\u274C Error in getTodayOrders:",r),{count:0,revenue:0}}})}getLast7DaysSales(){return i(this,null,function*(){try{let r=yield this.getCurrentRestaurantId();if(!r)return[];let e=[];for(let o=6;o>=0;o--){let n=new Date;n.setDate(n.getDate()-o),e.push(n.toISOString().split("T")[0])}let{data:t,error:a}=yield this.supabaseService.getSupabaseClient().from("orders").select("created_at, total_amount, status").eq("restaurant_id",r).eq("status","completed").gte("created_at",e[0]).lte("created_at",e[6]+"T23:59:59.999Z");if(a)return console.error("\u274C Error fetching last 7 days sales:",a),this.getEmptySalesData(e);let s=new Map;return e.forEach(o=>s.set(o,0)),t?.forEach(o=>{let n=o.created_at.split("T")[0];s.has(n)&&s.set(n,s.get(n)+(o.total_amount||0))}),e.map(o=>({day:this.formatChartDay(o),amount:s.get(o)||0}))}catch(r){return console.error("\u274C Error in getLast7DaysSales:",r),this.getEmptySalesData()}})}getTopDishes(r=5){return i(this,null,function*(){try{let e=yield this.getCurrentRestaurantId();if(!e)return[];let{data:t,error:a}=yield this.supabaseService.getSupabaseClient().from("order_items").select(`
        dish_id,
        quantity,
        dishes!inner (
          name,
          base_price,
          restaurant_id
        )
      `).eq("dishes.restaurant_id",e).limit(1e3);if(a)return console.error("\u274C Error fetching top dishes:",a),[];let s=new Map;return t?.forEach(o=>{let n=o.dish_id,d=o.dishes;s.has(n)||s.set(n,{name:d.name,quantity:0,revenue:0});let u=s.get(n);u.quantity+=o.quantity,u.revenue+=o.quantity*(d.base_price||0)}),Array.from(s.entries()).map(([o,n])=>({dish_id:o,name:n.name,quantity:n.quantity,revenue:n.revenue})).sort((o,n)=>n.quantity-o.quantity).slice(0,r)}catch(e){return console.error("\u274C Error in getTopDishes:",e),[]}})}getOrderItemsCount(r){return i(this,null,function*(){try{let{data:e,error:t}=yield this.supabaseService.getSupabaseClient().from("order_items").select("id").eq("order_id",r);return t?(console.error("\u274C Error counting order items:",t),0):e?.length||0}catch(e){return console.error("\u274C Error in getOrderItemsCount:",e),0}})}getEmptySalesData(r){let e=[];for(let t=6;t>=0;t--){let a=new Date;a.setDate(a.getDate()-t),e.push(this.formatChartDay(a.toISOString().split("T")[0]))}return(r||e).map(t=>({day:this.formatChartDay(t),amount:0}))}formatChartDay(r){return new Date(r).toLocaleDateString("it-IT",{weekday:"short",day:"numeric"})}updateOrderItemStatus(r,e){return i(this,null,function*(){try{let{error:t}=yield this.supabaseService.getSupabaseClient().from("order_items").update({status:e,updated_at:new Date().toISOString()}).eq("id",r);if(t)return console.error("\u274C Errore aggiornamento stato item:",t),!1;try{let{data:a}=yield this.supabaseService.getSupabaseClient().from("order_items").select("order_id").eq("id",r).single();a&&this.notificationService.notifyOrderUpdate(a.order_id)}catch(a){console.warn("\u26A0\uFE0F Errore notifica aggiornamento:",a)}return!0}catch(t){return console.error("\u274C Errore updateOrderItemStatus:",t),!1}})}deleteOrder(r){return i(this,null,function*(){try{let{error:e}=yield this.supabaseService.getSupabaseClient().from("orders").delete().eq("id",r);if(e)throw e;return!0}catch(e){return console.error("\u274C Errore eliminazione comanda:",e),!1}})}deleteOrderHeader(r){return i(this,null,function*(){try{let{error:e}=yield this.supabaseService.getSupabaseClient().from("order_headers").delete().eq("id",r);if(e)throw e;return!0}catch(e){return console.error("\u274C Errore eliminazione order header:",e),!1}})}getActiveOrderHeadersForKitchen(){return i(this,null,function*(){try{let r=yield this.getCurrentRestaurantId();if(!r)return[];let{data:e,error:t}=yield this.supabaseService.getSupabaseClient().from("order_headers").select(`
        *,
        table:table_id (
          table_number,
          table_name
        ),
        orders:orders!order_header_id (
          *,
          order_items (
            *,
            dish:dish_id (
              name,
              base_price,
              category_id
            )
          )
        )
      `).eq("restaurant_id",r).eq("status","active").order("created_at",{ascending:!0});if(t)throw t;return(e||[]).filter(s=>s.orders?.some(o=>o.order_items?.some(n=>!["served","out_of_stock","cancelled"].includes(n.status))))}catch(r){return console.error("\u274C Errore caricamento order header per cucina:",r),[]}})}static \u0275fac=function(e){return new(e||c)};static \u0275prov=g({token:c,factory:c.\u0275fac,providedIn:"root"})};export{_ as a,f as b,C as c};
