import{a as q}from"./chunk-GKNZLVDN.js";import{a as C}from"./chunk-KNL3CWA3.js";import{A as D}from"./chunk-DCWKKS33.js";import{$ as E,G as w,M as O,a as f,b as _,ea as S,f as i,m as v}from"./chunk-K5RDB55Y.js";var I=class b{supabaseService=S(D);authService=S(C);shiftService=S(q);ordersSubject=new v([]);orders$=this.ordersSubject.asObservable();possibleStatuses=["pending","active","open","confirmed","in_progress","preparing"];constructor(){this.authService.currentUser$.pipe(w(e=>!!e),O(1)).subscribe(()=>{this.loadOrders()})}generateOrderNumber(){let e=new Date().getTime(),r=Math.floor(Math.random()*1e3);return`ORD-${e}-${r}`}createOrder(e){return i(this,null,function*(){let r=this.shiftService.getCurrentShift(),t=_(f({},e),{shift_id:r?.id});if(t.status&&t.status!=="pending")return yield this.tryCreateWithStatus(t,t.status);for(let a of this.possibleStatuses){console.log(`\u{1F504} Tentativo con status: ${a}`);let s=yield this.tryCreateWithStatus(t,a);if(s)return console.log(`\u2705 Ordine creato con successo con status: ${a}`),s}return console.error("\u{1F4A5} Tutti i tentativi di status hanno fallito"),null})}loadActiveOrders(){return i(this,null,function*(){try{let e=this.authService.currentUserValue;if(!e)return[];let{data:r,error:t}=yield this.supabaseService.getSupabaseClient().from("restaurants").select("id").eq("owner_id",e.id).limit(1);if(t||!r||r.length===0)return console.error("\u274C No restaurant found for user:",e.id),[];let a=r[0].id,{data:s,error:n}=yield this.supabaseService.getSupabaseClient().from("orders").select(`
          *,
          order_items (
            *,
            dishes (name, base_price)
          )
        `).eq("restaurant_id",a).not("status","in",'("completed", "cancelled")').order("created_at",{ascending:!1});if(n)return console.error("\u274C Error loading active orders:",n),[];let c=(s||[]).map(o=>(o.order_items&&Array.isArray(o.order_items)?o.order_items=o.order_items.map(d=>_(f({},d),{dish_name:d.dishes?.name||"Piatto",total_price:d.total_price||d.quantity*d.unit_price})):o.order_items=[],o));return console.log("\u{1F4CA} Active orders loaded:",c.length),c.forEach(o=>{console.log(`\u{1F4CA} Order ${o.id} has ${o.order_items?.length} items`)}),c}catch(e){return console.error("\u274C Error loading active orders:",e),[]}})}completeOrder(e){return i(this,null,function*(){try{console.log("\u{1F535} Completing order:",e);let{data:r,error:t}=yield this.supabaseService.getSupabaseClient().from("orders").update({status:"completed",updated_at:new Date().toISOString()}).eq("id",e).select();if(t)throw console.error("\u274C Error completing order:",t),t;return console.log("\u2705 Order completed successfully:",r),yield this.forceRefreshActiveOrders(),!0}catch(r){return console.error("\u274C Error completing order:",r),!1}})}tryCreateWithStatus(e,r){return i(this,null,function*(){try{let t=_(f({},e),{status:r,tax_amount:e.tax_amount||0,discount_amount:e.discount_amount||0,created_at:new Date().toISOString(),updated_at:new Date().toISOString()});console.log(`\u{1F4DD} Creazione ordine con status: ${r}`,t);let{data:a,error:s}=yield this.supabaseService.getSupabaseClient().from("orders").insert(t).select().single();if(s){if(s.code==="23514")return console.log(`\u274C Status "${r}" non valido per il constraint`),null;throw console.error(`\u274C Errore con status "${r}":`,s),s}return yield this.loadOrders(),a}catch(t){return console.error(`\u{1F4A5} Errore con status "${r}":`,t),null}})}updateOrder(e,r){return i(this,null,function*(){try{let t=_(f({},r),{updated_at:new Date().toISOString()}),{error:a}=yield this.supabaseService.getSupabaseClient().from("orders").update(t).eq("id",e);if(a)throw a;return yield this.loadOrders(),!0}catch(t){return console.error("\u274C Error updating order:",t),!1}})}getOrderItemsWithDishes(e){return i(this,null,function*(){try{let{data:r,error:t}=yield this.supabaseService.getSupabaseClient().from("order_items").select(`
          *,
          dishes (name, base_price, description)
        `).eq("order_id",e);if(t)throw t;return r||[]}catch(r){return console.error("\u274C Error fetching order items with dishes:",r),[]}})}createOrderItems(e){return i(this,null,function*(){try{if(e.length===0)return!0;console.log("\u{1F4E6} Inserting order items (clean):",e);let{error:r}=yield this.supabaseService.getSupabaseClient().from("order_items").insert(e);if(r)throw console.error("\u274C Error creating order items:",r),r;return!0}catch(r){return console.error("\u274C Error creating order items:",r),!1}})}deleteOrderItems(e){return i(this,null,function*(){try{let{error:r}=yield this.supabaseService.getSupabaseClient().from("order_items").delete().eq("order_id",e);if(r)throw r;return!0}catch(r){return console.error("\u274C Error deleting order items:",r),!1}})}loadOrders(){return i(this,null,function*(){try{let e=this.authService.currentUserValue;if(!e){console.log("No user found");return}let{data:r,error:t}=yield this.supabaseService.getSupabaseClient().from("restaurants").select("id").eq("owner_id",e.id).limit(1);if(t||!r||r.length===0){console.error("\u274C No restaurant found for user:",e.id);return}let a=r[0].id,{data:s,error:n}=yield this.supabaseService.getSupabaseClient().from("orders").select("*").eq("restaurant_id",a).order("created_at",{ascending:!1});if(n){console.error("Error loading orders:",n);return}console.log("Orders loaded:",s?.length),this.ordersSubject.next(s||[])}catch(e){console.error("Error in loadOrders:",e)}})}getTodayOrders(){return i(this,null,function*(){try{let e=this.authService.currentUserValue;if(!e)return{count:0,revenue:0};let{data:r,error:t}=yield this.supabaseService.getSupabaseClient().from("restaurants").select("id").eq("owner_id",e.id).limit(1);if(t||!r||r.length===0)return console.error("\u274C No restaurant found for user:",e.id),{count:0,revenue:0};let a=r[0].id,s=new Date().toISOString().split("T")[0],{data:n,error:c}=yield this.supabaseService.getSupabaseClient().from("orders").select("*").eq("restaurant_id",a).gte("created_at",s+"T00:00:00").lte("created_at",s+"T23:59:59");if(c)return console.error("Error fetching today orders:",c),{count:0,revenue:0};let o=n?.length||0,d=n?.reduce((h,m)=>h+m.total_amount,0)||0;return{count:o,revenue:d}}catch(e){return console.error("Error in getTodayOrders:",e),{count:0,revenue:0}}})}getCurrentOrders(){return this.ordersSubject.value.filter(r=>["pending","confirmed","preparing","ready"].includes(r.status))}getTopDishes(e=5){return i(this,null,function*(){try{let r=this.authService.currentUserValue;if(!r)return[];let{data:t,error:a}=yield this.supabaseService.getSupabaseClient().from("restaurants").select("id").eq("owner_id",r.id).limit(1);if(a||!t||t.length===0)return console.error("\u274C No restaurant found for user:",r.id),[];let s=t[0].id,{data:n,error:c}=yield this.supabaseService.getSupabaseClient().from("orders").select("id").eq("restaurant_id",s);if(c||!n)return console.error("Error fetching restaurant orders:",c),[];let o=n.map(u=>u.id);if(o.length===0)return[];let{data:d,error:h}=yield this.supabaseService.getSupabaseClient().from("order_items").select(`
          quantity,
          unit_price,
          total_price,
          dishes (name, restaurant_id)
        `).in("order_id",o);if(h)return console.error("Error fetching top dishes:",h),[];let m=d,l=new Map;return m?.forEach(u=>{if(u.dishes&&u.dishes.restaurant_id===s){let g=u.dishes.name;if(!g)return;l.has(g)||l.set(g,{orders:0,revenue:0});let y=l.get(g);y.orders+=u.quantity,y.revenue+=u.total_price}}),Array.from(l,([u,g])=>f({name:u},g)).sort((u,g)=>g.orders-u.orders).slice(0,e)}catch(r){return console.error("Error in getTopDishes:",r),[]}})}getLast7DaysSales(){return i(this,null,function*(){try{let e=this.authService.currentUserValue;if(!e)return[];let{data:r,error:t}=yield this.supabaseService.getSupabaseClient().from("restaurants").select("id").eq("owner_id",e.id).limit(1);if(t||!r||r.length===0)return console.error("\u274C No restaurant found for user:",e.id),[];let a=r[0].id,s=new Date;s.setDate(s.getDate()-6);let{data:n,error:c}=yield this.supabaseService.getSupabaseClient().from("orders").select("created_at, total_amount").eq("restaurant_id",a).gte("created_at",s.toISOString().split("T")[0]+"T00:00:00").order("created_at",{ascending:!0});if(c)return console.error("Error fetching sales data:",c),[];let o=new Map,d=["DOM","LUN","MAR","MER","GIO","VEN","SAB"];n?.forEach(m=>{let l=new Date(m.created_at),p=l.toISOString().split("T")[0],u=d[l.getDay()];o.has(p)||o.set(p,{day:u,amount:0}),o.get(p).amount+=m.total_amount});let h=[];for(let m=6;m>=0;m--){let l=new Date;l.setDate(l.getDate()-m);let p=l.toISOString().split("T")[0],u=d[l.getDay()];o.has(p)?h.push(o.get(p)):h.push({day:u,amount:0})}return h}catch(e){return console.error("Error in getLast7DaysSales:",e),[]}})}getOrderItemsCount(e){return i(this,null,function*(){try{let{data:r,error:t}=yield this.supabaseService.getSupabaseClient().from("order_items").select("id").eq("order_id",e);return t?(console.error("Error counting order items:",t),0):r?.length||0}catch(r){return console.error("Error in getOrderItemsCount:",r),0}})}getTodayRevenue(){return i(this,null,function*(){try{let e=this.authService.currentUserValue;if(!e)return 0;let{data:r,error:t}=yield this.supabaseService.getSupabaseClient().from("restaurants").select("id").eq("owner_id",e.id).limit(1);if(t||!r||r.length===0)return 0;let a=r[0].id,s=new Date().toISOString().split("T")[0],{data:n,error:c}=yield this.supabaseService.getSupabaseClient().from("orders").select("total_amount").eq("restaurant_id",a).eq("created_at::date",s).eq("status","completed");if(c)throw c;return n?.reduce((o,d)=>o+d.total_amount,0)||0}catch(e){return console.error("Error getting today revenue:",e),0}})}getShiftRevenue(e,r){return i(this,null,function*(){try{let{data:t,error:a}=yield this.supabaseService.getSupabaseClient().from("orders").select("total_amount").eq("shift_id",e).eq("created_at::date",r).eq("status","completed");if(a)throw a;return t?.reduce((s,n)=>s+n.total_amount,0)||0}catch(t){return console.error("Error getting shift revenue:",t),0}})}forceRefreshActiveOrders(){return i(this,null,function*(){try{console.log("\u{1F504} Force refreshing active orders..."),yield this.loadOrders();let e=yield this.loadActiveOrders();return console.log("\u2705 Active orders force refreshed:",e.length),e}catch(e){return console.error("\u274C Error force refreshing active orders:",e),[]}})}static \u0275fac=function(r){return new(r||b)};static \u0275prov=E({token:b,factory:b.\u0275fac,providedIn:"root"})};export{I as a};
