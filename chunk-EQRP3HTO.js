import{a as pe}from"./chunk-QWNY4QO4.js";import{a as x}from"./chunk-O3MMBNXC.js";import{Ab as le,zb as ae}from"./chunk-N3VPFYDE.js";import{a as ce}from"./chunk-EMJC2RNZ.js";import{a as se}from"./chunk-H4E5DJY3.js";import{A as re,B as oe,b as H,c as S,d as Q,e as J,i as K,j as X,o as Y,r as Z,s as ee,t as te,u as ie,z as ne}from"./chunk-45CSFDAZ.js";import{d as j}from"./chunk-TB7INTC7.js";import"./chunk-Q3EITIAW.js";import"./chunk-RC3HHTXM.js";import{k as U,l as $,v as W}from"./chunk-MPTEMNWF.js";import{C as V,E as F,Eb as z,Fb as M,Gb as D,Ia as A,Ib as a,Jb as T,Kb as y,L,La as s,Ob as O,Pb as B,Qb as q,S as R,T as w,Va as k,_a as m,ca as _,dc as G,f as C,gb as c,la as u,m as N,ma as f,qb as r,rb as i,sb as d,tb as E,ub as I,vb as b,yb as g,zb as P}from"./chunk-5BU4UD4M.js";import{g as v}from"./chunk-RA2WU32H.js";var me=["logoInput"];function ue(o,e){if(o&1&&(r(0,"option",45),a(1),i()),o&2){let t=e.$implicit;c("value",t),s(),T(t)}}function fe(o,e){if(o&1&&(r(0,"option",45),a(1),i()),o&2){let t=e.$implicit;c("value",t.code),s(),T(t.name)}}function ge(o,e){if(o&1&&d(0,"img",46),o&2){let t=P();c("src",t.logoPreview,A)}}function he(o,e){o&1&&(r(0,"span",47),a(1,"add_a_photo"),i())}function ve(o,e){if(o&1){let t=b();r(0,"button",48),g("click",function(){u(t);let l=P();return f(l.removeLogo())}),d(1,"lucide-angular",49),a(2," Rimuovi Logo "),i()}if(o&2){let t=P();c("disabled",t.loading),s(),c("size",20)}}function _e(o,e){o&1&&(r(0,"span",58),a(1,"Attive"),i())}function Se(o,e){o&1&&(r(0,"span",59),a(1,"Bloccate dal browser"),i())}function Pe(o,e){o&1&&(r(0,"span",60),a(1,"Non attivate"),i())}function be(o,e){o&1&&(r(0,"div",61),d(1,"lucide-angular",62),r(2,"span"),a(3," Ai sensi del "),r(4,"strong"),a(5,"GDPR Art.7"),i(),a(6,", il consenso \xE8 libero e revocabile in qualsiasi momento. Salviamo solo i dati tecnici necessari all'invio. Nessun dato \xE8 ceduto a terzi. "),i()())}function ye(o,e){o&1&&(E(0),r(1,"p",63),a(2," Le notifiche sono bloccate. Per attivarle clicca sull'icona del lucchetto nella barra degli indirizzi del browser e consenti le notifiche. "),i(),I())}function xe(o,e){o&1&&d(0,"lucide-angular",69)}function we(o,e){o&1&&(r(0,"p",70),a(1," Dovrai consentire le notifiche dal browser dopo il click. "),i())}function Ee(o,e){if(o&1){let t=b();E(0),r(1,"p",63),a(2," Ricevi notifiche la chat. "),i(),r(3,"div",64)(4,"label",65)(5,"input",66),g("change",function(){u(t);let l=P(2);return f(l.togglePush())}),i(),r(6,"span"),a(7,"Attiva notifiche push"),i()(),m(8,xe,1,0,"lucide-angular",67),i(),m(9,we,2,0,"p",68),I()}if(o&2){let t=P(2);s(5),c("checked",t.isPushActive)("disabled",t.pushLoading),s(3),c("ngIf",t.pushLoading),s(),c("ngIf",t.pushPermission==="default")}}function Ie(o,e){if(o&1&&(r(0,"div",50)(1,"div",51),d(2,"lucide-angular",52),r(3,"strong",53),a(4,"Notifiche push"),i(),m(5,_e,2,0,"span",54)(6,Se,2,0,"span",55)(7,Pe,2,0,"span",56),i(),m(8,be,7,0,"div",33)(9,ye,3,0,"ng-container",57)(10,Ee,10,4,"ng-container",57),i()),o&2){let t=P();s(5),c("ngIf",t.pushPermission==="granted"&&t.hasActivePush),s(),c("ngIf",t.pushPermission==="denied"),s(),c("ngIf",t.pushPermission==="default"),s(),c("ngIf",t.pushPermission!=="denied"),s(),c("ngIf",t.pushPermission==="denied"),s(),c("ngIf",t.pushPermission!=="denied")}}function Te(o,e){o&1&&(r(0,"div",61),d(1,"lucide-angular",71),r(2,"span"),a(3,"Le notifiche push non sono supportate su questo browser."),i()())}function Ce(o,e){o&1&&(r(0,"span",29),a(1,"sync"),i())}function Ne(o,e){o&1&&(r(0,"span",29),a(1,"save"),i())}function Ve(o,e){if(o&1&&(r(0,"option",45),a(1),i()),o&2){let t=e.$implicit;c("value",t.id),s(),y(" ",t.title," ")}}var de=class o{fb=_(ne);restaurantService=_(se);geographyService=_(ce);tutorialService=_(x);authService=_(j);pushService=_(pe);cdr=_(G);pushPermission="default";hasActivePush=!1;pushLoading=!1;isOwner=!1;destroy$=new C;profileForm;loading=!1;logoPreview;restaurant=null;provinces=[];regions=[];filteredProvinces=[];logoInput;ngOnInit(){this.pushPermission=this.pushService.isSupported()?Notification.permission:"unsupported",this.authService.currentUser$.pipe(V(e=>!!e),L(),R(()=>this.pushService.hasActiveSubscription()),F(e=>(console.error("Errore nel controllo notifiche:",e),N(!1))),w(this.destroy$)).subscribe(e=>{this.hasActivePush=e,console.log("hasActivePush after auth:",e)}),this.initForm(),this.loadProvinces(),this.loadRestaurantData()}ngOnDestroy(){this.destroy$.next(),this.destroy$.complete()}initForm(){this.profileForm=this.fb.group({name:["",[S.required,S.minLength(2)]],description:[""],address:["",S.required],phone:["",[S.required,S.pattern(/^[\+\d\s\-\(\)]{8,20}$/)]],email:["",[S.required,S.email]],region:[""],province:[""]})}loadProvinces(){return v(this,null,function*(){this.geographyService.getFilteredProvinces().pipe(w(this.destroy$)).subscribe(e=>{this.provinces=e,this.regions=[...new Set(e.map(t=>t.region))].filter(t=>t!=="Tutte").sort()})})}loadRestaurantData(){return v(this,null,function*(){this.loading=!0;try{if(this.restaurant=yield this.restaurantService.loadCurrentRestaurant(),this.restaurant){this.patchForm(this.restaurant),this.logoPreview=this.restaurant.logo_url||void 0;let e=this.authService.currentUserValue;this.isOwner=e?this.restaurant.owner_id===e.id:!1,this.isOwner||this.profileForm.disable()}}catch(e){console.error("Errore caricamento profilo:",e)}finally{this.loading=!1}})}patchForm(e){let t=e.province,n="";if(t&&this.provinces.length){let l=this.provinces.find(p=>p.code===t);l&&(n=l.region,this.filterProvincesByRegion(n))}this.profileForm.patchValue({name:e.name,description:e.description||"",address:e.address,phone:e.phone,email:e.email,region:n,province:t||""})}filterProvincesByRegion(e){this.filteredProvinces=e?this.provinces.filter(n=>n.region===e):[];let t=this.profileForm.get("province");this.filteredProvinces.length>0?t?.enable():(t?.disable(),this.profileForm.patchValue({province:""}))}onRegionChange(e){let t=e.target.value;this.filterProvincesByRegion(t)}onProvinceChange(e){let t=e.target.value;if(t){let n=this.provinces.find(l=>l.code===t);n&&(this.profileForm.patchValue({region:n.region}),this.filterProvincesByRegion(n.region))}else this.profileForm.patchValue({region:""}),this.filteredProvinces=[]}triggerLogoInput(){this.logoInput.nativeElement.click()}onLogoSelected(e){return v(this,null,function*(){let t=e.target;if(!t.files?.length)return;let n=t.files[0];if(n.size>5*1024*1024){alert("Il file non pu\xF2 superare i 5MB");return}if(!n.type.startsWith("image/")){alert("Seleziona un file immagine");return}this.loading=!0;try{let l=yield this.restaurantService.uploadLogo(n);l&&(this.logoPreview=l,alert("Logo caricato con successo!"))}catch(l){alert("Errore caricamento logo: "+l.message)}finally{this.loading=!1,t.value=""}})}removeLogo(){return v(this,null,function*(){if(this.logoPreview&&confirm("Rimuovere il logo?")){this.loading=!0;try{(yield this.restaurantService.removeLogo())&&(this.logoPreview=void 0,alert("Logo rimosso"))}catch(e){alert("Errore: "+e.message)}finally{this.loading=!1}}})}onSubmit(){return v(this,null,function*(){if(!this.isOwner){alert("Non hai i permessi per modificare questo profilo.");return}if(!this.profileForm.invalid){this.loading=!0;try{let e=this.profileForm.value,t=yield this.restaurantService.getCurrentRestaurantId();if(!t)throw new Error("Ristorante non trovato");let n={name:e.name,description:e.description||null,address:e.address,phone:this.cleanPhoneNumber(e.phone),email:e.email,province:e.province||null};if(e.address&&e.province){let p=yield this.restaurantService.geocodeAddress(e.address,e.province);p?(n.latitude=p.lat,n.longitude=p.lng,console.log("\u2705 Coordinate ottenute:",p)):(console.warn("\u26A0\uFE0F Geocoding fallito, procedo senza coordinate"),alert("Indirizzo non geolocalizzato automaticamente. Puoi inserire le coordinate manualmente in seguito."))}(yield this.restaurantService.updateRestaurant(t,n))&&(alert("Profilo aggiornato!"),yield this.loadRestaurantData())}catch(e){alert("Errore salvataggio: "+e.message)}finally{this.loading=!1}}})}cleanPhoneNumber(e){return e?e.startsWith("+")?"+"+e.substring(1).replace(/\D/g,""):e.replace(/\D/g,""):""}get tutorialSteps(){return this.tutorialService.steps()}get tutorialSections(){return(this.authService.getCurrentContext()==="staff"?x.BUSINESS_STEPS:x.CUSTOMER_STEPS).filter(l=>l.requiredPermission?this.authService.hasPermission(l.requiredPermission):!0).filter(l=>l.tooltipTarget||l.subSteps&&l.subSteps.length>0)}selectedStepId=null;startSelectedTutorial(){this.selectedStepId&&this.tutorialService.startTutorialFromStep(this.selectedStepId,"single")}restartFullTutorial(){let t=this.authService.getCurrentContext()==="staff"?"business":"customer";this.tutorialService.restartTutorial(t)}enablePushNotifications(){return v(this,null,function*(){console.log("A. enablePushNotifications called"),this.pushLoading=!0;try{let e=yield this.pushService.requestPermissionAndSubscribe();console.log("B. Risultato:",e),this.pushPermission=Notification.permission,this.hasActivePush=e,console.log("C. Stato aggiornato - hasActivePush:",this.hasActivePush),this.cdr.detectChanges()}catch(e){console.error("D. Errore in enablePushNotifications:",e)}finally{this.pushLoading=!1,this.cdr.detectChanges(),console.log("E. pushLoading = false")}})}disablePushNotifications(){return v(this,null,function*(){console.log("disablePushNotifications - start"),this.pushLoading=!0,yield this.pushService.revokeConsent(),this.hasActivePush=!1,console.log("disablePushNotifications - hasActivePush set to false"),this.pushLoading=!1,this.cdr.detectChanges()})}get isPushActive(){let e=this.pushPermission==="granted"&&this.hasActivePush;return console.log("isPushActive computed:",e,"pushPermission:",this.pushPermission,"hasActivePush:",this.hasActivePush),e}togglePush(){return v(this,null,function*(){this.pushLoading||(this.isPushActive?yield this.disablePushNotifications():yield this.enablePushNotifications())})}static \u0275fac=function(t){return new(t||o)};static \u0275cmp=k({type:o,selectors:[["app-profile"]],viewQuery:function(t,n){if(t&1&&z(me,5),t&2){let l;M(l=D())&&(n.logoInput=l.first)}},decls:88,vars:19,consts:[["logoInput",""],[1,"page-container"],[1,"flex","flex-col","gap-sm",3,"ngSubmit","formGroup"],["data-tutorial","profile-info",1,"form-card"],[1,"form-row","mb-md"],[1,"material-icons","text-md"],[1,"text-md","font-semibold","m-0"],[1,"form-row","mb-sm"],[1,"form-group"],[1,"standard-label"],["type","text","formControlName","name","placeholder","Es: Trattoria da Mario"],["type","email","formControlName","email","placeholder","info@ristorante.it"],["type","tel","formControlName","phone","placeholder","+39 123 456 7890"],["formControlName","region",3,"change"],["value",""],[3,"value",4,"ngFor","ngForOf"],["formControlName","province",3,"change"],["type","text","formControlName","address","placeholder","Via Roma 123, Milano"],["formControlName","description","rows","3","placeholder","Racconta la storia del tuo ristorante..."],["data-tutorial","profile-logo",1,"form-card"],[1,"flex","items-center","gap-sm","mb-md"],[1,"form-row"],["type","file","accept","image/*",2,"display","none",3,"change"],[1,"flex","items-center","gap-md","flex-wrap"],[1,"logo-preview-container",2,"width","120px","height","120px","border","2px dashed var(--smoke-2)","border-radius","12px","display","flex","align-items","center","justify-content","center","overflow","hidden","background","var(--smoke-1)"],["alt","Logo","style","max-width: 100%; max-height: 100%; object-fit: contain;",3,"src",4,"ngIf"],["class","material-icons","style","font-size: 48px; color: var(--smoke-3);",4,"ngIf"],[1,"flex","flex-col","gap-sm"],["type","button",1,"promethea-button","ghost",3,"click","disabled"],[1,"material-icons"],["type","button","class","promethea-button ghost","style","color: var(--danger);",3,"disabled","click",4,"ngIf"],[1,"text-mini","text-muted"],["class","card p-md gap-md",4,"ngIf"],["class","info-message",4,"ngIf"],[1,"modal-footer"],["type","submit",1,"promethea-button",3,"disabled"],["class","material-icons",4,"ngIf"],["data-tutorial","profile-actions",1,"form-row","p-sm"],["for","tutorial-step",1,"standard-label"],["id","tutorial-step",3,"ngModelChange","ngModel"],[3,"ngValue"],[1,"flex","gap-sm","items-center","p-sm"],[1,"promethea-button","primary","ml-2",3,"click","disabled"],["type","button",1,"promethea-button","outline",3,"click"],["name","play-circle",3,"size"],[3,"value"],["alt","Logo",2,"max-width","100%","max-height","100%","object-fit","contain",3,"src"],[1,"material-icons",2,"font-size","48px","color","var(--smoke-3)"],["type","button",1,"promethea-button","ghost",2,"color","var(--danger)",3,"click","disabled"],["name","trash-2",3,"size"],[1,"card","p-md","gap-md"],[1,"flex","items-center","gap-sm"],["name","bell",1,"gradient-text"],[1,"text-md"],["class","chip active",4,"ngIf"],["class","chip warning",4,"ngIf"],["class","chip",4,"ngIf"],[4,"ngIf"],[1,"chip","active"],[1,"chip","warning"],[1,"chip"],[1,"info-message"],["name","shield-check"],[1,"text-muted"],[1,"flex","items-center","gap-md"],[1,"checkbox-label",2,"display","flex","align-items","center","gap","0.5rem","cursor","pointer"],["type","checkbox",3,"change","checked","disabled"],["name","refresh-cw","class","animate-spin","style","width: 1.2rem;",4,"ngIf"],["class","text-xs text-muted",4,"ngIf"],["name","refresh-cw",1,"animate-spin",2,"width","1.2rem"],[1,"text-xs","text-muted"],["name","alert-circle"]],template:function(t,n){if(t&1){let l=b();r(0,"div",1)(1,"form",2),g("ngSubmit",function(){return u(l),f(n.onSubmit())}),r(2,"div",3)(3,"div",4)(4,"span",5),a(5,"info"),i(),r(6,"h2",6),a(7,"Informazioni Base"),i()(),r(8,"div",7)(9,"div",8)(10,"label",9),a(11,"Nome Ristorante *"),i(),d(12,"input",10),i()(),r(13,"div",7)(14,"div",8)(15,"label",9),a(16,"Email *"),i(),d(17,"input",11),i(),r(18,"div",8)(19,"label",9),a(20,"Telefono *"),i(),d(21,"input",12),i()(),r(22,"div",7)(23,"div",8)(24,"label",9),a(25,"Regione"),i(),r(26,"select",13),g("change",function(h){return u(l),f(n.onRegionChange(h))}),r(27,"option",14),a(28,"Seleziona Regione"),i(),m(29,ue,2,2,"option",15),i()(),r(30,"div",8)(31,"label",9),a(32,"Provincia"),i(),r(33,"select",16),g("change",function(h){return u(l),f(n.onProvinceChange(h))}),r(34,"option",14),a(35,"Seleziona Provincia"),i(),m(36,fe,2,2,"option",15),i()()(),r(37,"div",8)(38,"label",9),a(39,"Indirizzo *"),i(),d(40,"input",17),i(),r(41,"div",8)(42,"label",9),a(43,"Descrizione"),i(),d(44,"textarea",18),i()(),r(45,"div",19)(46,"div",20)(47,"span",5),a(48,"image"),i(),r(49,"h2",6),a(50,"Logo Ristorante"),i()(),r(51,"div",21)(52,"div",8)(53,"input",22,0),g("change",function(h){return u(l),f(n.onLogoSelected(h))}),i(),r(55,"div",23)(56,"div",24),m(57,ge,1,1,"img",25)(58,he,2,0,"span",26),i(),r(59,"div",27)(60,"button",28),g("click",function(){return u(l),f(n.triggerLogoInput())}),r(61,"span",29),a(62,"cloud_upload"),i(),a(63),i(),m(64,ve,3,2,"button",30),r(65,"span",31),a(66,"Formati: JPG, PNG, WEBP. Max 5MB."),i()()()()()(),m(67,Ie,11,6,"div",32)(68,Te,4,0,"div",33),r(69,"div",34)(70,"button",35),m(71,Ce,2,0,"span",36)(72,Ne,2,0,"span",36),a(73),i()()(),r(74,"div",37)(75,"div",8)(76,"label",38),a(77,"Scegli una sezione da rivedere:"),i(),r(78,"select",39),q("ngModelChange",function(h){return u(l),B(n.selectedStepId,h)||(n.selectedStepId=h),f(h)}),r(79,"option",40),a(80,"-- Seleziona --"),i(),m(81,Ve,2,2,"option",15),i()(),r(82,"div",41)(83,"button",42),g("click",function(){return u(l),f(n.startSelectedTutorial())}),a(84," Avvia sezione "),i(),r(85,"button",43),g("click",function(){return u(l),f(n.restartFullTutorial())}),d(86,"lucide-angular",44),a(87," Tutorial completo "),i()()()()}t&2&&(s(),c("formGroup",n.profileForm),s(28),c("ngForOf",n.regions),s(7),c("ngForOf",n.filteredProvinces),s(21),c("ngIf",n.logoPreview),s(),c("ngIf",!n.logoPreview),s(2),c("disabled",n.loading),s(3),y(" ",n.logoPreview?"Sostituisci":"Carica"," Logo "),s(),c("ngIf",n.logoPreview),s(3),c("ngIf",n.pushService.isSupported()),s(),c("ngIf",!n.pushService.isSupported()),s(2),c("disabled",n.loading||n.profileForm.invalid),s(),c("ngIf",n.loading),s(),c("ngIf",!n.loading),s(),y(" ",n.loading?"Salvataggio...":"Salva Profilo"," "),s(5),O("ngModel",n.selectedStepId),s(),c("ngValue",null),s(2),c("ngForOf",n.tutorialSections),s(2),c("disabled",!n.selectedStepId),s(3),c("size",18))},dependencies:[W,U,$,oe,X,te,ie,H,ee,Q,J,Y,Z,le,ae,re,K],encapsulation:2})};export{de as Profile};
