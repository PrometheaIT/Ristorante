import{a as E}from"./chunk-SY2ZWW6D.js";import{b as M,d as R}from"./chunk-TB7INTC7.js";import{P as j,Y as y,ca as S,g as m,s as x}from"./chunk-5BU4UD4M.js";import{a as g,b as f,g as c}from"./chunk-RA2WU32H.js";var D=class C{supabase=S(M);authService=S(R);loadingService=S(E);messagesSubject=new m([]);messages$=this.messagesSubject.asObservable().pipe(j(1));conversationsSubject=new m([]);conversations$=this.conversationsSubject.asObservable().pipe(j(1));activeConversationSubject=new m(null);activeConversation$=this.activeConversationSubject.asObservable();loadingSubject=new m(!1);loading$=this.loadingSubject.asObservable();realtimeChannel=null;unreadCountSubject=new m(new Map);unreadCount$=this.unreadCountSubject.asObservable();globalRealtimeChannel=null;lastReadMap=new Map;totalUnread$=this.unreadCount$.pipe(x(e=>Array.from(e.values()).reduce((t,s)=>t+s,0)));constructor(){this.authService.activeRestaurantId$.subscribe(()=>{this.unreadCountSubject.next(new Map),this.setupGlobalRealtimeSubscription()})}incrementUnread(e,t=1){let s=this.unreadCountSubject.value,a=(s.get(e)||0)+t;s.set(e,a),this.unreadCountSubject.next(new Map(s))}resetUnread(e){let t=this.unreadCountSubject.value;t.has(e)&&(t.delete(e),this.unreadCountSubject.next(new Map(t)))}loadConversations(){return c(this,null,function*(){let e=this.authService.getCurrentRestaurantId(),t=this.authService.currentUserValue?.id;if(!e||!t){this.conversationsSubject.next([]);return}this.loadingSubject.next(!0);try{let{data:s,error:a}=yield this.run(this.supabase.getSupabaseClient().from("chat_participants").select("conversation_id").eq("user_id",t).is("left_at",null));if(a)throw a;let r=s?.map(n=>n.conversation_id)||[];if(r.length===0){this.conversationsSubject.next([]);return}let{data:p,error:v}=yield this.run(this.supabase.getSupabaseClient().from("chat_conversations").select(`
          *,
          participants:chat_participants(*),
          last_message:chat_messages(
            id, content, sender_id, created_at
          )
        `).in("id",r).eq("restaurant_id",e).order("updated_at",{ascending:!1}));if(v)throw v;this.lastReadMap.clear();let i=[];for(let n of p||[]){let l={id:n.id,restaurant_id:n.restaurant_id,type:n.type,name:n.name,created_at:n.created_at,updated_at:n.updated_at,last_message:null,other_participant:void 0};if(n.last_message?.length){let o=n.last_message.sort((u,h)=>new Date(h.created_at).getTime()-new Date(u.created_at).getTime());l.last_message=o[0]}let _=n.participants?.find(o=>o.user_id===t),d=_?.last_read_at;d||(d=_?.joined_at||n.created_at),this.lastReadMap.set(n.id,d);let{count:b,error:w}=yield this.supabase.getSupabaseClient().from("chat_messages").select("id",{count:"exact",head:!0}).eq("conversation_id",n.id).gt("created_at",d).neq("sender_id",t);if(!w&&b&&b>0&&this.incrementUnread(n.id,b),l.type==="direct"){let o=n.participants?.find(u=>u.user_id!==t);if(o){let{data:u,error:h}=yield this.supabase.getSupabaseClient().from("users").select("id, first_name, last_name, avatar_url").eq("id",o.user_id).single();!h&&u?l.other_participant=u:console.error("Errore nel recuperare utente per conversazione",l.id,h)}else console.warn("Altro partecipante non trovato per conversazione",l.id,n.participants)}i.push(l)}this.conversationsSubject.next(i)}catch(s){console.error("Error loading conversations:",s)}finally{this.loadingSubject.next(!1),this.setupGlobalRealtimeSubscription()}})}setActiveConversation(e){return c(this,null,function*(){if(this.activeConversationSubject.value?.id!==e?.id)if(this.realtimeChannel&&(yield this.supabase.getSupabaseClient().removeChannel(this.realtimeChannel),this.realtimeChannel=null),this.activeConversationSubject.next(e),e){let t=this.authService.currentUserValue?.id;if(t){let s=new Date().toISOString();yield this.supabase.getSupabaseClient().from("chat_participants").update({last_read_at:s}).eq("conversation_id",e.id).eq("user_id",t),this.lastReadMap.set(e.id,s),this.resetUnread(e.id)}yield this.loadMessages(e.id),this.subscribeToMessages(e.id)}else this.messagesSubject.next([])})}loadMessages(e){return c(this,null,function*(){this.loadingSubject.next(!0);try{let{data:t,error:s}=yield this.run(this.supabase.getSupabaseClient().from("chat_messages").select(`
            *,
            sender:sender_id(id, first_name, last_name, email, avatar_url)
          `).eq("conversation_id",e).order("created_at",{ascending:!0}));if(s)throw s;this.messagesSubject.next(t||[])}catch(t){console.error("Error loading messages:",t)}finally{this.loadingSubject.next(!1)}})}sendMessage(e,t){return c(this,null,function*(){let s=this.authService.currentUserValue;if(!s)return null;try{let{data:a,error:r}=yield this.run(this.supabase.getSupabaseClient().from("chat_messages").insert({conversation_id:e,sender_id:s.id,content:t.trim()}).select(`
          *,
          sender:sender_id(id, first_name, last_name, email, avatar_url)
        `).single());if(r)throw r;if(!a)return null;let p=this.messagesSubject.value;this.messagesSubject.next([...p,a]);let i=this.conversationsSubject.value.map(n=>n.id===e?f(g({},n),{last_message:a}):n);return this.conversationsSubject.next(i),a}catch(a){return console.error("Error sending message:",a),null}})}updateMessage(e,t){return c(this,null,function*(){try{let{error:s}=yield this.run(this.supabase.getSupabaseClient().from("chat_messages").update({content:t.trim()}).eq("id",e));if(s)throw s;let a=this.messagesSubject.value.map(r=>r.id===e?f(g({},r),{content:t,updated_at:new Date().toISOString()}):r);return this.messagesSubject.next(a),!0}catch(s){return console.error("Error updating message:",s),!1}})}deleteMessage(e){return c(this,null,function*(){try{let{error:t}=yield this.run(this.supabase.getSupabaseClient().from("chat_messages").delete().eq("id",e));if(t)throw t;let s=this.messagesSubject.value.filter(a=>a.id!==e);return this.messagesSubject.next(s),!0}catch(t){return console.error("Error deleting message:",t),!1}})}subscribeToMessages(e){this.realtimeChannel=this.supabase.getSupabaseClient().channel(`messages:${e}`).on("postgres_changes",{event:"*",schema:"public",table:"chat_messages",filter:`conversation_id=eq.${e}`},t=>{this.handleRealtimeMessage(t)}).subscribe()}handleRealtimeMessage(e){let t=this.messagesSubject.value,s=this.activeConversationSubject.value?.id;switch(console.log("\u{1F4E8} Realtime message event:",e.eventType,e.new?.conversation_id,"active:",s),e.eventType){case"INSERT":t.some(a=>a.id===e.new.id)||(e.new.conversation_id!==s&&(console.log("\u{1F514} incrementUnread per conversazione:",e.new.conversation_id),this.incrementUnread(e.new.conversation_id)),this.loadSenderAndAdd(e.new));break;case"UPDATE":this.messagesSubject.next(t.map(a=>a.id===e.new.id?g(g({},a),e.new):a));break;case"DELETE":this.messagesSubject.next(t.filter(a=>a.id!==e.old.id));break}}loadSenderAndAdd(e){return c(this,null,function*(){let{data:t}=yield this.supabase.getSupabaseClient().from("users").select("id, first_name, last_name, email, avatar_url").eq("id",e.sender_id).single(),s=f(g({},e),{sender:t});this.messagesSubject.next([...this.messagesSubject.value,s])})}createDirectConversation(e){return c(this,null,function*(){console.log("\u{1F680} createDirectConversation - START",{otherUserId:e});let t=this.authService.getCurrentRestaurantId(),s=this.authService.currentUserValue;if(!t||!s)return console.log("\u274C createDirectConversation - missing restaurantId or currentUser"),null;console.log("\u2705 createDirectConversation - params",{restaurantId:t,currentUserId:s.id}),console.log("\u{1F50D} Checking existing conversation...");let{data:a,error:r}=yield this.run(this.supabase.getSupabaseClient().rpc("get_direct_conversation",{p_restaurant_id:t,p_user1:s.id,p_user2:e}));if(r)throw console.error("\u274C Error checking existing conversation:",r),r;if(console.log("\u{1F4E6} Existing conversation result:",a),a&&a.length>0){console.log("\u{1F504} Conversation already exists, enriching...");let o=a[0];if(!o.other_participant){console.log("\u{1F464} Fetching other user for existing conv:",e);let{data:u,error:h}=yield this.supabase.getSupabaseClient().from("users").select("id, first_name, last_name, avatar_url").eq("id",e).single();h?console.error("\u274C Error fetching other user:",h):(console.log("\u2705 Other user fetched:",u),o.other_participant=u)}return console.log("\u{1F389} Returning existing conversation:",o),o}console.log("\u{1F195} Creating new conversation...");let{data:p,error:v}=yield this.run(this.supabase.getSupabaseClient().from("chat_conversations").insert({restaurant_id:t,type:"direct",name:null}).select().single());if(v||!p)return console.error("\u274C Error creating conversation:",v),null;let i=p;console.log("\u2705 New conversation created:",i);let n=[{conversation_id:i.id,user_id:s.id},{conversation_id:i.id,user_id:e}];console.log("\u{1F465} Adding participants:",n);let{error:l}=yield this.run(this.supabase.getSupabaseClient().from("chat_participants").insert(n));if(l)return console.error("\u274C Error adding participants:",l),yield this.supabase.getSupabaseClient().from("chat_conversations").delete().eq("id",i.id),null;console.log("\u2705 Participants added"),console.log("\u{1F464} Fetching other user for new conv:",e);let{data:_,error:d}=yield this.supabase.getSupabaseClient().from("users").select("id, first_name, last_name, avatar_url").eq("id",e).single();d?console.error("\u274C Error fetching other user:",d):console.log("\u2705 Other user fetched:",_);let b={id:i.id,restaurant_id:i.restaurant_id,type:i.type,name:i.name,created_at:i.created_at,updated_at:i.updated_at,other_participant:_||null,last_message:null},w=this.conversationsSubject.value;return this.conversationsSubject.next([b,...w]),this.setupGlobalRealtimeSubscription(),setTimeout(()=>{let o=this.conversationsSubject.value;this.conversationsSubject.next([...o])},50),b})}run(e){return c(this,null,function*(){this.loadingService.start();try{return yield e}finally{this.loadingService.stop()}})}ngOnDestroy(){this.realtimeChannel&&this.supabase.getSupabaseClient().removeChannel(this.realtimeChannel),this.messagesSubject.complete(),this.conversationsSubject.complete(),this.activeConversationSubject.complete(),this.loadingSubject.complete()}setupGlobalRealtimeSubscription(){if(!this.authService.getCurrentRestaurantId())return;let t=this.conversationsSubject.value.map(a=>a.id);if(t.length===0){console.log("\u26A0\uFE0F Nessuna conversazione, subscription globale non avviata");return}this.globalRealtimeChannel&&this.supabase.getSupabaseClient().removeChannel(this.globalRealtimeChannel);let s=`conversation_id=in.(${t.join(",")})`;console.log("\u{1F50D} Filtro globale:",s),this.globalRealtimeChannel=this.supabase.getSupabaseClient().channel("global-messages").on("postgres_changes",{event:"INSERT",schema:"public",table:"chat_messages",filter:s},a=>{console.log("\u{1F4E8} Messaggio globale ricevuto:",a),this.handleGlobalMessage(a)}).subscribe(a=>{console.log("\u{1F4E1} Subscription globale status:",a)})}handleGlobalMessage(e){let t=this.activeConversationSubject.value?.id,s=e.new.conversation_id,a=this.authService.currentUserValue?.id;if(e.new.sender_id!==a){if(s!==t){let r=this.lastReadMap.get(s);(!r||new Date(e.new.created_at)>new Date(r))&&this.incrementUnread(s)}this.updateConversationLastMessage(e.new)}}updateConversationLastMessage(e){let t=this.conversationsSubject.value,s=t.findIndex(a=>a.id===e.conversation_id);if(s!==-1){let a=[...t];a[s]=f(g({},a[s]),{last_message:e});let[r]=a.splice(s,1);a.unshift(r),this.conversationsSubject.next(a)}}static \u0275fac=function(t){return new(t||C)};static \u0275prov=y({token:C,factory:C.\u0275fac,providedIn:"root"})};export{D as a};
