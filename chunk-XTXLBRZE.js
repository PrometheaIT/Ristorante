import{a as b}from"./chunk-CLUFVB5A.js";import{Z as c,ua as u}from"./chunk-DE3VKQQR.js";import{a as l,j as n}from"./chunk-4ZZIO3ZI.js";var d=class s extends b{getTableName(){return"tables"}loadData(){return n(this,null,function*(){try{let e=yield this.getCurrentRestaurantId();if(!e)return;let{data:r,error:a}=yield this.supabaseService.getSupabaseClient().from(this.getTableName()).select("*").eq("restaurant_id",e).eq("is_active",!0).order("created_at",{ascending:!1});if(a)throw a;this.dataSubject.next(r||[])}catch(e){console.error(`Error loading ${this.getTableName()}:`,e),this.errorSubject.next(e.message),this.dataSubject.next([])}})}getTables(){return this.dataSubject.value}getTablesByFloorPlan(e){return this.dataSubject.value.filter(r=>r.floor_plan_id===e)}createTable(e){return n(this,null,function*(){try{console.log("\u{1F4DD} Creating table with shape:",e.shape);let{data:r,error:a}=yield this.supabaseService.getSupabaseClient().from("tables").insert(e).select().single();if(a)throw console.error("\u274C Error creating table:",a),console.error("\u274C Error details:",a.details),a;return console.log("\u2705 Table created successfully"),yield this.loadData(),r}catch(r){return console.error("\u{1F4A5} Error in createTable:",r),null}})}updateTable(e,r){return n(this,null,function*(){try{console.log(`\u{1F4BE} updateTable for table ${e}:`,r);let a=this.dataSubject.value,t=a.map(i=>i.id===e?l(l({},i),r):i);this.dataSubject.next(t);let{error:o}=yield this.supabaseService.getSupabaseClient().from("tables").update(r).eq("id",e);if(o)throw console.error("\u274C Database error updating table:",o),this.dataSubject.next(a),o;return console.log(`\u2705 Table ${e} updated successfully`),!0}catch(a){return console.error("\u274C Error updating table:",a),yield this.loadData(),!1}})}deleteTable(e){return n(this,null,function*(){try{let{error:r}=yield this.supabaseService.getSupabaseClient().from("tables").update({is_active:!1}).eq("id",e);if(r)throw r;return yield this.loadData(),!0}catch(r){return console.error("\u274C Error deleting table:",r),!1}})}checkTableOverlap(e,r){let a=this.getTablesByFloorPlan(e.floor_plan_id),t=Array.isArray(r)?r:r?[r]:[];for(let o of a){if(t.includes(o.id))continue;if(this.doTablesOverlap(e,o))return!0}return!1}doTablesOverlap(e,r){return!(e.position_x+e.width<=r.position_x||e.position_x>=r.position_x+r.width||e.position_y+e.height<=r.position_y||e.position_y>=r.position_y+r.height)}updateTableOnlineBookable(e,r){return n(this,null,function*(){try{let{error:a}=yield this.supabaseService.getSupabaseClient().from("tables").update({is_online_bookable:r}).eq("id",e);if(a)throw a;return yield this.loadData(),!0}catch(a){return console.error("\u274C Error updating table online bookable status:",a),!1}})}getTablesAvailableForOnlineBooking(e){return this.getTablesByFloorPlan(e).filter(r=>r.is_online_bookable&&!r.is_merged&&r.is_active)}getVisibleTablesByFloorPlan(e){let r=this.getTablesByFloorPlan(e),a=r.filter(t=>!t.is_merged||t.parent_table_id===null);return console.log("\u{1F50D} DEBUG getVisibleTablesByFloorPlan:",{floorPlanId:e,allTablesCount:r.length,visibleTablesCount:a.length,allTables:r,visibleTables:a}),a}getTableStyle(e){let r;e.border_radius!==void 0&&e.border_radius!==null?r=e.border_radius===50?"50%":`${e.border_radius}px`:r=e.shape==="circle"?"50%":"8px";let a=e.rotation||0,t={left:e.position_x+"px",top:e.position_y+"px",width:e.width+"px",height:e.height+"px","border-radius":r,transform:`rotate(${a}deg)`};return a!==0&&console.log(`\u{1F3A8} Tavolo ${e.table_number}: applicata rotazione di ${a}\xB0`),e.is_merged&&(t.border="3px dashed #ff6b35",t.background="rgba(255, 107, 53, 0.1)"),e.is_online_bookable||(t.background="repeating-linear-gradient(45deg, var(--primary), var(--smoke-1) 10px, var(--smoke-1) 10px, var(--primary) 20px)"),t}getTableClass(e,r,a,t){let o=["table-element",`shape-${e.shape}`];return r?.id===e.id&&o.push("selected"),a.some(i=>i.id===e.id)&&o.push("merge-selected"),e.is_merged&&e.parent_table_id?o.push("merged-child","hidden-table"):e.merged_tables_ids&&e.merged_tables_ids.length>0&&o.push("merged-parent"),e.is_online_bookable||o.push("not-online-bookable"),o.join(" ")}generateNextTableNumber(e){let r=e.map(a=>parseInt(a.table_number)).filter(a=>!isNaN(a));return r.length>0?Math.max(...r)+1:1}rotateTable(e,r){return n(this,null,function*(){try{let a=(r%360+360)%360;console.log(`\u{1F504} Rotating table ${e} to ${a}\xB0`);let{error:t}=yield this.supabaseService.getSupabaseClient().from("tables").update({rotation:a,updated_at:new Date().toISOString()}).eq("id",e);return t?(console.error("\u274C Database error rotating table:",t),!1):(console.log(`\u2705 Table ${e} rotated successfully to ${a}\xB0`),!0)}catch(a){return console.error("\u274C Error rotating table:",a),!1}})}getAllTablesByFloorPlan(e){return this.dataSubject.value.filter(r=>r.floor_plan_id===e)}calculateMaxCapacity(e){return!e||e.length===0?0:e.reduce((r,a)=>r+(a.capacity||0),0)}getCapacityByTableType(e){let r={};return e.forEach(a=>{let t=a.capacity||0;r[t]=(r[t]||0)+1}),r}getTableStats(e){let r=e.length,a=this.calculateMaxCapacity(e),t=e.filter(i=>i.is_online_bookable).length,o=r>0?Math.round(a/r):0;return{totalTables:r,maxCapacity:a,availableForOnline:t,averageCapacity:o}}validateTableDimensions(e){let{width:r,height:a}=e;return(e.shape==="circle"||e.shape==="square")&&(a=r),r<20&&(r=20),r>1e3&&(r=1e3),a<20&&(a=20),a>1e3&&(a=1e3),{width:r,height:a}}static \u0275fac=(()=>{let e;return function(a){return(e||(e=u(s)))(a||s)}})();static \u0275prov=c({token:s,factory:s.\u0275fac,providedIn:"root"})};export{d as a};
