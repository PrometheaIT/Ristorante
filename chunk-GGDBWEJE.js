import{a as ze}from"./chunk-YZV43U52.js";import{a as B}from"./chunk-GB7WVUTD.js";import"./chunk-RWHEAJGO.js";import"./chunk-MEGBB4Y7.js";import{ya as Ne,za as Re}from"./chunk-UFRMGX42.js";import{a as _e,b as Se,d as xe,e as Te,g as we,h as Me,i as Pe,j as Ee,l as Fe,q as ye,r as Ce,s as Ie,t as De,u as ke,x as Ve}from"./chunk-22BNR7AL.js";import{b as X,d as fe}from"./chunk-NPMWXJE4.js";import"./chunk-6GCWWUP3.js";import{j as pe,k as ge,l as be,s as ve}from"./chunk-N5RTTLWI.js";import{Ab as ie,Bb as ne,Cb as ae,Eb as j,Fb as O,Ha as c,Hb as me,Ib as l,Jb as A,Kb as w,Lb as G,Mb as oe,Nb as he,Ob as V,Pb as N,Qb as R,Ra as se,Vb as ue,Xa as de,Z as W,a as le,ab as P,ca as F,dc as M,hb as ce,ia as u,ib as g,ja as p,jb as a,kb as r,lb as L,pa as I,rb as E,ub as b,wb as h}from"./chunk-R56C6QW6.js";import{a as f,b as S,j as T}from"./chunk-4ZZIO3ZI.js";var U=class d{supabaseService=F(X);mergeTables(t,e,i,n){return T(this,null,function*(){try{let o=t.map(_=>_.id),s={restaurant_id:n,floor_plan_id:i,table_name:e.table_name,table_number:e.table_number,capacity:e.capacity,shape:"rectangle",position_x:e.position_x,position_y:e.position_y,width:e.width,height:e.height,rotation:0,is_active:!0,is_online_bookable:!0,is_merged:!1,parent_table_id:null,merged_tables_ids:o},{data:m,error:v}=yield this.supabaseService.getSupabaseClient().from("tables").insert(s).select().single();if(v)throw v;for(let _ of t){let y={is_online_bookable:!1,is_merged:!0,parent_table_id:m.id},{error:D}=yield this.supabaseService.getSupabaseClient().from("tables").update(y).eq("id",_.id);if(D)throw D}return m}catch(o){return console.error("\u274C Error merging tables:",o),null}})}splitMergedTable(t){return T(this,null,function*(){try{console.log("\u{1F50D} Cerco tavoli figli per:",t.id);let{data:e,error:i}=yield this.supabaseService.getSupabaseClient().from("tables").select("*").eq("parent_table_id",t.id);if(i)throw console.error("\u274C Errore nel fetch dei tavoli figli:",i),i;console.log("\u{1F4CB} Tavoli figli trovati:",e?.length);for(let o of e||[]){let s={is_online_bookable:!0,is_merged:!1,parent_table_id:null};console.log("\u{1F504} Ripristino tavolo:",o.table_number);let{error:m}=yield this.supabaseService.getSupabaseClient().from("tables").update(s).eq("id",o.id);if(m)throw console.error("\u274C Errore nell'aggiornamento del tavolo:",m),m}console.log("\u{1F5D1}\uFE0F Elimino tavolo unito principale:",t.id);let{error:n}=yield this.supabaseService.getSupabaseClient().from("tables").delete().eq("id",t.id);if(n)throw console.error("\u274C Errore nell'eliminazione del tavolo unito:",n),n;return console.log("\u2705 Separazione completata con successo"),!0}catch(e){return console.error("\u274C Error splitting merged table:",e),!1}})}getMergedTableChildren(t){return T(this,null,function*(){try{let{data:e,error:i}=yield this.supabaseService.getSupabaseClient().from("tables").select("*").eq("parent_table_id",t);if(i)throw i;return e||[]}catch(e){return console.error("\u274C Error fetching merged table children:",e),[]}})}static \u0275fac=function(e){return new(e||d)};static \u0275prov=W({token:d,factory:d.\u0275fac,providedIn:"root"})};var H=class d{state=I({floorPlans:[],currentFloorPlan:null,tables:[],selectedTable:null,selectedTables:[],isDrawing:!1,isMergeMode:!1,showTableModal:!1,showEditTableModal:!1,showMergeModal:!1,showDimensionsModal:!1,tableForm:this.getDefaultTableForm()});floorPlans=M(()=>this.state().floorPlans);currentFloorPlan=M(()=>this.state().currentFloorPlan);tables=M(()=>this.state().tables);selectedTable=M(()=>this.state().selectedTable);selectedTables=M(()=>this.state().selectedTables);isDrawing=M(()=>this.state().isDrawing);isMergeMode=M(()=>this.state().isMergeMode);showTableModal=M(()=>this.state().showTableModal);showEditTableModal=M(()=>this.state().showEditTableModal);showMergeModal=M(()=>this.state().showMergeModal);showDimensionsModal=M(()=>this.state().showDimensionsModal);tableForm=M(()=>this.state().tableForm);setFloorPlans(t){this.state.update(e=>S(f({},e),{floorPlans:t}))}setCurrentFloorPlan(t){this.state.update(e=>S(f({},e),{currentFloorPlan:t}))}setTables(t){this.state.update(e=>S(f({},e),{tables:t}))}setSelectedTable(t){this.state.update(e=>S(f({},e),{selectedTable:t}))}setSelectedTables(t){this.state.update(e=>S(f({},e),{selectedTables:t}))}setIsDrawing(t){this.state.update(e=>S(f({},e),{isDrawing:t}))}setIsMergeMode(t){this.state.update(e=>S(f({},e),{isMergeMode:t}))}setShowTableModal(t){this.state.update(e=>S(f({},e),{showTableModal:t}))}setShowEditTableModal(t){this.state.update(e=>S(f({},e),{showEditTableModal:t}))}setShowMergeModal(t){this.state.update(e=>S(f({},e),{showMergeModal:t}))}setShowDimensionsModal(t){this.state.update(e=>S(f({},e),{showDimensionsModal:t}))}updateTableForm(t){this.state.update(e=>S(f({},e),{tableForm:f(f({},e.tableForm),t)}))}resetTableForm(){this.state.update(t=>S(f({},t),{tableForm:this.getDefaultTableForm()}))}addToSelectedTables(t){this.state.update(e=>S(f({},e),{selectedTables:[...e.selectedTables,t]}))}removeFromSelectedTables(t){this.state.update(e=>S(f({},e),{selectedTables:e.selectedTables.filter(i=>i.id!==t)}))}clearSelectedTables(){this.state.update(t=>S(f({},t),{selectedTables:[]}))}initializeTableFormForShape(t){let e=this.state().tableForm;switch(t){case"circle":e.borderRadius=50,e.gridHeight=e.gridWidth,e.height=e.width;break;case"square":e.borderRadius=12,e.gridHeight=e.gridWidth,e.height=e.width;break;case"rectangle":e.borderRadius=8;break}e.shape=t,this.state.update(i=>S(f({},i),{tableForm:f({},e)}))}updateAutoTableNumber(t){this.state.update(e=>S(f({},e),{tableForm:S(f({},e.tableForm),{tableNumber:t.toString()})}))}resetState(){this.state.set({floorPlans:[],currentFloorPlan:null,tables:[],selectedTable:null,selectedTables:[],isDrawing:!1,isMergeMode:!1,showTableModal:!1,showEditTableModal:!1,showMergeModal:!1,showDimensionsModal:!1,tableForm:this.getDefaultTableForm()})}getDefaultTableForm(){return{shape:"rectangle",gridWidth:6,gridHeight:4,width:120,height:80,capacity:2,borderRadius:8,tableName:"",tableNumber:"",isOnlineBookable:!0,isMerged:!1}}resetForNewFloorPlan(){this.state.update(t=>S(f({},t),{tables:[],selectedTable:null,selectedTables:[],isDrawing:!1,isMergeMode:!1,showTableModal:!1,showEditTableModal:!1,showMergeModal:!1,showDimensionsModal:!1}))}static \u0275fac=function(e){return new(e||d)};static \u0275prov=W({token:d,factory:d.\u0275fac,providedIn:"root"})};var $=class d{stateService=F(H);tableService=F(B);dragState=null;rafId=null;startTableDrag(t,e,i,n=1){let o=this.tableService.getTables(),s=o.find(C=>C.id===t);if(!s){console.error("\u274C Tavolo non trovato:",t);return}let m=i.getBoundingClientRect(),v=(e.clientX-m.left)/n,_=(e.clientY-m.top)/n;console.log("\u{1F7E2} START DRAG per tavolo:",s.table_number,"scale:",n);let y=this.getTablesInMergeGroup(s,o),D=new Map(y.map(C=>[C.id,{x:C.position_x,y:C.position_y}])),x=C=>{this.dragState?.isDragging&&(this.rafId&&cancelAnimationFrame(this.rafId),this.rafId=requestAnimationFrame(()=>{this.handlePointerMove(i,C,o,n)}))},k=()=>this.handlePointerUp();this.dragState={isDragging:!0,startX:v,startY:_,initialPositions:D,moveHandler:x,upHandler:k},document.addEventListener("pointermove",x),document.addEventListener("pointerup",k,{once:!0});let z=e.target;if(z)try{z.setPointerCapture(e.pointerId),z.style.touchAction="none"}catch{console.warn("Pointer capture not supported")}}handlePointerMove(t,e,i,n){if(!this.dragState?.isDragging)return;let o=t.getBoundingClientRect(),s=(e.clientX-o.left)/n,m=(e.clientY-o.top)/n,v=s-this.dragState.startX,_=m-this.dragState.startY,y=this.stateService.currentFloorPlan();if(!y)return;let D=this.stateService.tables().map(x=>{let k=this.dragState.initialPositions.get(x.id);if(!k)return x;let z=k.x+v,C=k.y+_;z=Math.round(z/20)*20,C=Math.round(C/20)*20;let K=y.width-x.width,J=y.height-x.height,q=Math.max(0,Math.min(z,K)),Y=Math.max(0,Math.min(C,J)),ee=S(f({},x),{position_x:q,position_y:Y}),te=Array.from(this.dragState.initialPositions.keys());return this.tableService.checkTableOverlap(ee,te)?x:S(f({},x),{position_x:q,position_y:Y})});this.stateService.setTables(D)}handlePointerUp(){return T(this,null,function*(){if(!this.dragState?.isDragging)return;console.log("\u{1F7E2} HANDLE POINTER UP - Saving final positions");let t=[];for(let[e,i]of this.dragState.initialPositions){let n=this.stateService.tables().find(o=>o.id===e);n&&(n.position_x!==i.x||n.position_y!==i.y)&&(console.log(`\u{1F4BE} Saving table ${n.table_number}: (${i.x}, ${i.y}) \u2192 (${n.position_x}, ${n.position_y})`),t.push(this.tableService.updateTable(e,{position_x:n.position_x,position_y:n.position_y})))}try{yield Promise.all(t),console.log("\u2705 All table positions saved successfully")}catch(e){console.error("\u274C Error saving table positions:",e)}this.cleanupDrag()})}cleanupDrag(){this.dragState?.moveHandler&&document.removeEventListener("pointermove",this.dragState.moveHandler),this.rafId&&(cancelAnimationFrame(this.rafId),this.rafId=null),this.dragState=null}getTablesInMergeGroup(t,e){let i=[t];if(t.merged_tables_ids&&t.merged_tables_ids.length>0&&!t.parent_table_id)t.merged_tables_ids.forEach(n=>{let o=e.find(s=>s.id===n);o&&i.push(o)});else if(t.parent_table_id){let n=e.find(o=>o.id===t.parent_table_id);n&&(i.find(o=>o.id===n.id)||i.push(n),n.merged_tables_ids&&n.merged_tables_ids.forEach(o=>{if(o!==t.id){let s=e.find(m=>m.id===o);s&&!i.find(m=>m.id===s.id)&&i.push(s)}}))}return i}handleCanvasClick(t,e){if(!this.stateService.isDrawing())return null;let i=e.getBoundingClientRect(),n=t.clientX-i.left,o=t.clientY-i.top,s=n,m=o;return s=Math.round(n/20)*20,m=Math.round(o/20)*20,{x:s,y:m}}areTablesAdjacent(t,e,i=0){let n=t.position_x,o=t.position_x+t.width,s=t.position_y,m=t.position_y+t.height,v=e.position_x,_=e.position_x+e.width,y=e.position_y,D=e.position_y+e.height,x=2,k=n-i-x,z=o+i+x,C=s-i-x,K=m+i+x,J=v-x,q=_+x,Y=y-x,ee=D+x,te=k<=q&&z>=J,re=C<=ee&&K>=Y;return te&&re}areSelectedTablesAdjacent(t,e){if(t.length<2)return!0;let i=new Map;t.forEach(s=>{i.set(s.id,[])});for(let s=0;s<t.length;s++)for(let m=s+1;m<t.length;m++)this.areTablesAdjacent(t[s],t[m])&&(i.get(t[s].id).push(t[m].id),i.get(t[m].id).push(t[s].id));let n=new Set,o=[t[0].id];for(;o.length>0;){let s=o.shift();n.has(s)||(n.add(s),(i.get(s)||[]).forEach(v=>{n.has(v)||o.push(v)}))}return n.size===t.length}getAdjacentTablesToSelection(t,e){if(t.length===0)return[];let i=[],n=t.map(o=>o.id);return e.forEach(o=>{if(!(n.includes(o.id)||o.is_merged)){for(let s of t)if(this.areTablesAdjacent(o,s)){i.push(o);break}}}),i}showAdjacencyWarning(t,e){let i=`Il Tavolo ${t.table_number} non \xE8 vicino ai tavoli selezionati. 
  Seleziona solo tavoli che si toccano tra loro.`;alert(i)}findTableAtPosition(t,e,i){for(let o of t){let s=o.position_x,m=o.position_x+o.width,v=o.position_y,_=o.position_y+o.height;if(e>=s-15&&e<=m+15&&i>=v-15&&i<=_+15)return o}return null}findAdjacentGroups(t){let e=[],i=new Set;for(let n of t)if(!i.has(n.id)){let o=this.findConnectedTables(n,t,i);o.length>1&&e.push(o)}return e}findConnectedTables(t,e,i){let n=[],o=[t];for(;o.length>0;){let s=o.shift();if(!i.has(s.id)){i.add(s.id),n.push(s);for(let m of e)!i.has(m.id)&&m.id!==s.id&&this.areTablesAdjacent(s,m,0)&&o.push(m)}}return n}static \u0275fac=function(e){return new(e||d)};static \u0275prov=W({token:d,factory:d.\u0275fac,providedIn:"root"})};var Q=class d{tableService=F(B);stateService=F(H);rotateTable(t,e){return T(this,null,function*(){try{let i=this.getMainTableForRotation(t);if(!i)return console.error("\u274C Tavolo non valido per la rotazione"),!1;console.log(`\u{1F504} Rotazione tavolo ${i.table_number} di ${e}\xB0`);let n=(i.rotation+e)%360;return this.updateTablesRotationLocal([i],e),(yield this.tableService.rotateTable(i.id,n))?(console.log("\u2705 Tavolo ruotato con successo"),!0):(console.error("\u274C Errore nel salvataggio della rotazione"),yield this.tableService.loadData(),!1)}catch(i){return console.error("\u274C Errore nella rotazione:",i),!1}})}rotateToAngle(t,e){let i=t.rotation||0;return(e-i+180)%360-180}getMainTableForRotation(t){let e=this.stateService.currentFloorPlan();if(!e)return null;let i=this.tableService.getAllTablesByFloorPlan(e.id);if(console.log("\u{1F50D} Cerca tavolo principale per rotazione:",{tableId:t.id,isMerged:t.is_merged,parentId:t.parent_table_id}),t.parent_table_id){console.log("\u{1F476} Tavolo figlio, cerco il parent");let n=i.find(o=>o.id===t.parent_table_id);if(n)return console.log("\u2705 Trovato parent:",n.id),n}return console.log("\u2705 Usa il tavolo stesso come principale"),t}updateTablesRotationLocal(t,e){let n=this.stateService.tables().map(s=>{if(t.find(v=>v.id===s.id)){let v=(s.rotation+e)%360;return S(f({},s),{rotation:v})}return s});this.stateService.setTables(n);let o=this.stateService.selectedTable();if(o&&t.some(s=>s.id===o.id)){let s=n.find(m=>m.id===o.id);s&&this.stateService.setSelectedTable(s)}}getTablesInRotationGroup(t){let e=this.stateService.currentFloorPlan();if(!e)return[t];let i=this.tableService.getAllTablesByFloorPlan(e.id),n=[t];if(t.merged_tables_ids&&t.merged_tables_ids.length>0&&!t.parent_table_id)t.merged_tables_ids.forEach(s=>{let m=i.find(v=>v.id===s);m&&n.push(m)});else if(t.parent_table_id){let s=i.find(m=>m.id===t.parent_table_id);s&&(n.push(s),s.merged_tables_ids&&s.merged_tables_ids.forEach(m=>{if(m!==t.id){let v=i.find(_=>_.id===m);v&&n.push(v)}}))}return n.filter((s,m,v)=>m===v.findIndex(_=>_.id===s.id))}static \u0275fac=function(e){return new(e||d)};static \u0275prov=W({token:d,factory:d.\u0275fac,providedIn:"root"})};var Ae=["floorPlanCanvas"],He=["canvasContainer"],Oe=(d,t,e)=>({"width.px":d,"height.px":t,"border-radius":e});function Be(d,t){if(d&1&&(a(0,"option",40),l(1),r()),d&2){let e=t.$implicit;g("ngValue",e.id),c(),oe(" ",e.name," (",e.width,"\xD7",e.height,") ")}}function Le(d,t){if(d&1){let e=E();a(0,"div",41)(1,"div",8)(2,"input",42),R("ngModelChange",function(n){u(e);let o=h();return N(o.editedFloorPlanName,n)||(o.editedFloorPlanName=n),p(n)}),b("keyup.enter",function(){u(e);let n=h();return p(n.saveFloorPlanName())})("keyup.escape",function(){u(e);let n=h();return p(n.cancelEditFloorPlanName())}),r(),a(3,"div",12)(4,"button",43),b("click",function(){u(e);let n=h();return p(n.saveFloorPlanName())}),a(5,"span",14),l(6,"check"),r()(),a(7,"button",44),b("click",function(){u(e);let n=h();return p(n.cancelEditFloorPlanName())}),a(8,"span",14),l(9,"close"),r()()()(),a(10,"div",45),l(11," Premi Invio per salvare, Esc per annullare "),r()()}if(d&2){let e=h();c(2),V("ngModel",e.editedFloorPlanName)}}function je(d,t){if(d&1){let e=E();a(0,"div",12)(1,"button",59),b("click",function(){u(e);let n=h(2);return p(n.rotateToAngle(0))}),a(2,"span",14),l(3,"north"),r()(),a(4,"button",60),b("click",function(){u(e);let n=h(2);return p(n.rotateToAngle(90))}),a(5,"span",14),l(6,"east"),r()(),a(7,"button",61),b("click",function(){u(e);let n=h(2);return p(n.rotateToAngle(180))}),a(8,"span",14),l(9,"south"),r()(),a(10,"button",62),b("click",function(){u(e);let n=h(2);return p(n.rotateToAngle(270))}),a(11,"span",14),l(12,"west"),r()()()}}function Ge(d,t){d&1&&(a(0,"div",63)(1,"span",64),l(2,"info"),r(),l(3," Premi Ctrl + rotellina del mouse per ruotare di \xB15\xB0 "),r())}function qe(d,t){if(d&1){let e=E();a(0,"div",46)(1,"div",47)(2,"div",48)(3,"div",49)(4,"span",14),l(5,"rotate_right"),r(),a(6,"div")(7,"strong"),l(8,"Rotazione Tavolo"),r()()(),a(9,"div",8),P(10,je,13,0,"div",50),a(11,"div",51)(12,"button",52),b("click",function(){u(e);let n=h();return p(n.rotateSelectedTable(-30))}),a(13,"span",14),l(14,"rotate_left"),r()(),a(15,"div",53)(16,"span",54),l(17),r(),a(18,"span",55),l(19,"Rotazione"),r()(),a(20,"button",56),b("click",function(){u(e);let n=h();return p(n.rotateSelectedTable(30))}),a(21,"span",14),l(22,"rotate_right"),r()()(),a(23,"button",57),b("click",function(){u(e);let n=h();return p(n.rotateToAngle(0))}),a(24,"span",14),l(25,"restart_alt"),r()()()(),P(26,Ge,4,0,"div",58),r()()}if(d&2){let e=h();c(10),g("ngIf",!e.isMobileView()),c(2),g("disabled",e.isRotating),c(5),w("",e.selectedTable().rotation||0,"\xB0"),c(3),g("disabled",e.isRotating),c(3),g("disabled",e.isRotating),c(3),g("ngIf",e.selectedTable()&&!e.isDrawing()&&!e.isMobileView())}}function Ye(d,t){d&1&&(a(0,"span",72),l(1," Unito "),r())}function Xe(d,t){if(d&1){let e=E();a(0,"button",73),b("click",function(){u(e);let n=h(2);return p(n.onSplitTable(n.selectedTable()))}),a(1,"span",14),l(2,"call_split"),r(),l(3," Separa "),r()}}function Ue(d,t){if(d&1){let e=E();a(0,"div",65)(1,"div",48)(2,"div",66)(3,"strong"),l(4,"Tavolo Selezionato"),r(),a(5,"span",29),l(6),P(7,Ye,2,0,"span",67),r()(),a(8,"div",68)(9,"button",69),b("click",function(){u(e);let n=h();return p(n.openEditTableModal())}),a(10,"span",14),l(11,"edit"),r(),l(12," Modifica "),r(),P(13,Xe,4,0,"button",70),a(14,"button",71),b("click",function(){u(e);let n=h();return p(n.deselectAll())}),a(15,"span",14),l(16,"close"),r(),l(17," Deseleziona "),r()()()()}if(d&2){let e=h();c(6),G(" Tavolo ",e.selectedTable().table_number," - ",e.selectedTable().capacity," persone "),c(),g("ngIf",e.selectedTable().merged_tables_ids&&e.selectedTable().merged_tables_ids.length>0),c(6),g("ngIf",e.selectedTable().merged_tables_ids&&e.selectedTable().merged_tables_ids.length>0)}}function Ze(d,t){d&1&&(a(0,"div",29),l(1," Seleziona 2-4 tavoli confinanti da unire "),r())}function $e(d,t){if(d&1&&(a(0,"span",85),l(1),r()),d&2){let e=h(3);c(),w(" (",e.getSelectedTableNumbers(),") ")}}function Qe(d,t){if(d&1&&(a(0,"div",29),l(1),P(2,$e,2,1,"span",84),r()),d&2){let e=h(2);c(),w(" Tavoli selezionati: ",e.selectedTables().length," "),c(),g("ngIf",e.selectedTables().length>0)}}function Ke(d,t){if(d&1&&(a(0,"span"),l(1),r()),d&2){let e=h(2);c(),w("(",e.selectedTables().length,")")}}function Je(d,t){if(d&1){let e=E();a(0,"div",86)(1,"div",49)(2,"span",87),l(3,"info"),r(),a(4,"div",88)(5,"p",23),l(6),r()(),a(7,"button",89),b("click",function(){u(e);let n=h(2);return p(n.highlightMessage.set(null))}),a(8,"span",14),l(9,"close"),r()()()()}if(d&2){let e=h(2);c(5),O("text-warning",!0),c(),w(" ",e.highlightMessage()," ")}}function et(d,t){d&1&&(a(0,"div",90),L(1,"lucide-angular",91),l(2," Seleziona un altro tavolo adiacente per unire "),r())}function tt(d,t){d&1&&(a(0,"div",92)(1,"span",14),l(2,"warning"),r(),l(3," I tavoli selezionati non sono tutti adiacenti tra loro "),r())}function it(d,t){if(d&1&&(a(0,"div",93)(1,"span",14),l(2,"check_circle"),r(),l(3),r()),d&2){let e=h(2);c(3),w(" Tavoli pronti per l'unione! Capacit\xE0 totale: ",e.getTotalCapacity()," persone ")}}function nt(d,t){if(d&1){let e=E();a(0,"div",74)(1,"div",48)(2,"div",75)(3,"strong"),l(4,"Modalit\xE0 Unione Tavoli"),r(),P(5,Ze,2,0,"div",76)(6,Qe,3,2,"div",76),r(),a(7,"div",68)(8,"button",71),b("click",function(){u(e);let n=h();return p(n.highlightAdjacentTables())}),a(9,"span",14),l(10,"highlight"),r(),l(11,` Mostra vicini
`),r(),a(12,"button",77),b("click",function(){u(e);let n=h();return p(n.openMergeModal())}),a(13,"span",14),l(14,"merge"),r(),l(15," Crea tavolo unito "),P(16,Ke,2,1,"span",78),r(),a(17,"button",79),b("click",function(){u(e);let n=h();return p(n.stateService.clearSelectedTables())}),a(18,"span",14),l(19,"clear"),r(),l(20," Deseleziona "),r()()(),P(21,Je,10,3,"div",80),a(22,"div",41),P(23,et,3,0,"div",81)(24,tt,4,0,"div",82)(25,it,4,1,"div",83),r()()}if(d&2){let e=h();c(5),g("ngIf",e.selectedTables().length===0),c(),g("ngIf",e.selectedTables().length>0),c(6),O("active",e.canMergeTables()),g("disabled",!e.canMergeTables()),c(4),g("ngIf",e.selectedTables().length>0),c(),g("disabled",e.selectedTables().length===0),c(4),g("ngIf",e.highlightMessage()),c(2),g("ngIf",e.selectedTables().length===1),c(),g("ngIf",e.selectedTables().length>1&&!e.canMergeTables()),c(),g("ngIf",e.canMergeTables())}}function at(d,t){if(d&1&&L(0,"div",100),d&2){let e=h(2);j("background-size",e.gridSize,"px")}}function ot(d,t){if(d&1){let e=E();a(0,"div",101),b("pointerdown",function(n){let o=u(e).$implicit,s=h(2);return p(s.onTablePointerDown(n,o))}),a(1,"div",102)(2,"div",103),l(3),r(),a(4,"div",104),l(5),r()()()}if(d&2){let e=t.$implicit,i=h(2);me(i.getTableClass(e)),g("ngStyle",i.getTableStyle(e)),ce("data-table-id",e.id),c(3),A(e.table_number),c(2),w("",e.capacity," p")}}function rt(d,t){d&1&&(a(0,"div",105)(1,"span",14),l(2,"table_restaurant"),r(),a(3,"h3"),l(4,"Nessun tavolo configurato"),r(),a(5,"p"),l(6,'Clicca su "Aggiungi" per creare il primo tavolo'),r()())}function lt(d,t){if(d&1&&(a(0,"div",94)(1,"div",95,1),L(3,"div",96),P(4,at,1,2,"div",97)(5,ot,6,6,"div",98)(6,rt,7,0,"div",99),r()()),d&2){let e=h();j("width",e.floorPlanWidth()*e.canvasScale(),"px")("height",e.floorPlanHeight()*e.canvasScale(),"px"),c(),j("width",e.floorPlanWidth(),"px")("height",e.floorPlanHeight(),"px")("transform","scale("+e.canvasScale()+")")("transform-origin","0 0"),c(3),g("ngIf",e.snapToGrid),c(),g("ngForOf",e.tables())("ngForTrackBy",e.trackByTableId),c(),g("ngIf",e.tables().length===0)}}function st(d,t){if(d&1){let e=E();a(0,"div",106)(1,"span",14),l(2,"map"),r(),a(3,"h3"),l(4,"Nessuna mappa selezionata"),r(),a(5,"p"),l(6,"Crea una nuova mappa o seleziona una esistente"),r(),a(7,"button",107),b("click",function(){u(e);let n=h();return p(n.createNewFloorPlan())}),a(8,"span",14),l(9,"add"),r(),l(10," Crea Nuova Mappa "),r()()}}function dt(d,t){if(d&1){let e=E();a(0,"div",134),b("click",function(){let n=u(e).$implicit,o=h(2);return p(o.onShapeSelect(n))}),a(1,"div",135)(2,"span",14),l(3),r(),a(4,"strong"),l(5),r()()()}if(d&2){let e=t.$implicit,i=h(2);O("active",i.stateService.tableForm().shape===e.type),c(3),A(e.icon),c(2),A(e.name)}}function ct(d,t){if(d&1){let e=E();a(0,"div",6)(1,"label",7),l(2,"Larghezza (quadrati)"),r(),a(3,"input",136),b("ngModelChange",function(n){u(e);let o=h(2);return p(o.onGridWidthChange(n))}),r(),a(4,"span",29),l(5),r()()}if(d&2){let e=h(2);c(3),g("ngModel",e.stateService.tableForm().gridWidth)("disabled",e.stateService.tableForm().shape==="circle"||e.stateService.tableForm().shape==="square"),c(2),w("1 quadrato = ",e.gridSize,"px")}}function mt(d,t){if(d&1){let e=E();a(0,"div",6)(1,"label",7),l(2,"Altezza (quadrati)"),r(),a(3,"input",137),b("ngModelChange",function(n){u(e);let o=h(2);return p(o.onGridHeightChange(n))}),r(),a(4,"span",29),l(5),r()()}if(d&2){let e=h(2);c(3),g("ngModel",e.stateService.tableForm().gridHeight)("disabled",e.stateService.tableForm().shape==="circle"||e.tableForm().isMerged!==void 0&&e.tableForm().isMerged),c(2),w("1 quadrato = ",e.gridSize,"px")}}function ht(d,t){if(d&1){let e=E();a(0,"div",6)(1,"label",7),l(2,"Larghezza (px)"),r(),a(3,"input",138),b("ngModelChange",function(n){u(e);let o=h(2);return p(o.onWidthChange(n))}),r(),a(4,"span",29),l(5,"Min: 20px, Max: 1000px"),r()()}if(d&2){let e=h(2);c(3),g("ngModel",e.stateService.tableForm().width)("disabled",e.stateService.tableForm().shape==="circle")}}function ut(d,t){if(d&1){let e=E();a(0,"div",6)(1,"label",7),l(2,"Altezza (px)"),r(),a(3,"input",139),b("ngModelChange",function(n){u(e);let o=h(2);return p(o.onHeightChange(n))}),r(),a(4,"span",29),l(5,"Min: 20px, Max: 1000px"),r()()}if(d&2){let e=h(2);c(3),g("ngModel",e.stateService.tableForm().height)("disabled",e.stateService.tableForm().shape==="circle"||e.stateService.tableForm().shape==="square")}}function pt(d,t){if(d&1){let e=E();a(0,"div",6)(1,"label",7),l(2,"Border Radius (px)"),r(),a(3,"input",140),b("ngModelChange",function(n){u(e);let o=h(2);return p(o.onBorderRadiusChange(n))}),r(),a(4,"div",141)(5,"span"),l(6,"0px (spigoli vivi)"),r(),a(7,"span")(8,"strong"),l(9),r()(),a(10,"span"),l(11,"50px (molto arrotondato)"),r()()()}if(d&2){let e=h(2);c(3),g("ngModel",e.stateService.tableForm().borderRadius),c(6),w("",e.stateService.tableForm().borderRadius,"px")}}function gt(d,t){d&1&&(a(0,"div",6)(1,"div",142),L(2,"lucide-angular",91),a(3,"span"),l(4,"Per i tavoli circolari il border radius \xE8 automaticamente impostato al 50%"),r()()())}function bt(d,t){if(d&1&&(a(0,"div",143),l(1),r()),d&2){let e=h(2);c(),he(" DEBUG: width=",e.previewWidth(),", height=",e.previewHeight(),", shape=",e.stateService.tableForm().shape,", borderRadius=",e.stateService.tableForm().borderRadius," ")}}function vt(d,t){if(d&1){let e=E();a(0,"button",144),b("click",function(){u(e);let n=h(2);return p(n.onDeleteTable())}),a(1,"span",14),l(2,"delete"),r(),l(3," Elimina "),r()}}function ft(d,t){if(d&1){let e=E();a(0,"div",108)(1,"div",109)(2,"div",110)(3,"div",49)(4,"div",111)(5,"span",14),l(6),r()(),a(7,"div")(8,"h1",112),l(9),r()()(),a(10,"button",113),b("click",function(){u(e);let n=h();return p(n.stateService.setShowTableModal(!1))}),a(11,"span",14),l(12,"close"),r()()(),a(13,"div",4)(14,"form")(15,"div",3)(16,"div",114)(17,"label",7),l(18,"Forma del Tavolo"),r(),a(19,"div",115),P(20,dt,6,4,"div",116),r()(),a(21,"div",117)(22,"div",6)(23,"label",7),l(24,"Numero Tavolo"),r(),a(25,"input",118),R("ngModelChange",function(n){u(e);let o=h();return N(o.stateService.tableForm().tableNumber,n)||(o.stateService.tableForm().tableNumber=n),p(n)}),r()(),a(26,"div",6)(27,"label",7),l(28,"Capacit\xE0"),r(),a(29,"input",119),R("ngModelChange",function(n){u(e);let o=h();return N(o.stateService.tableForm().capacity,n)||(o.stateService.tableForm().capacity=n),p(n)}),r()()(),a(30,"div",117)(31,"div",6)(32,"label",7),l(33,"Nome Tavolo (opzionale)"),r(),a(34,"input",120),R("ngModelChange",function(n){u(e);let o=h();return N(o.stateService.tableForm().tableName,n)||(o.stateService.tableForm().tableName=n),p(n)}),r()(),a(35,"div",6)(36,"label",121)(37,"input",122),R("ngModelChange",function(n){u(e);let o=h();return N(o.stateService.tableForm().isOnlineBookable,n)||(o.stateService.tableForm().isOnlineBookable=n),p(n)}),r(),a(38,"div",28)(39,"strong"),l(40,"Prenotabile online"),r(),a(41,"span",29),l(42,"Se deselezionato, prenotabile solo dal personale"),r()()()()(),a(43,"div",117),P(44,ct,6,3,"div",123)(45,mt,6,3,"div",123)(46,ht,6,2,"div",123)(47,ut,6,2,"div",123),r(),a(48,"div",117),P(49,pt,12,2,"div",123)(50,gt,5,0,"div",123),r(),a(51,"div",124)(52,"strong"),l(53,"Anteprima"),r(),a(54,"div",125)(55,"div",126)(56,"div",127)(57,"span",103),l(58),r(),a(59,"span",104),l(60),r()()()(),a(61,"div",128),l(62),r(),P(63,bt,2,4,"div",129),r()(),a(64,"div",130)(65,"button",131),b("click",function(){u(e);let n=h();return p(n.stateService.setShowTableModal(!1))}),l(66," Annulla "),r(),a(67,"button",132),b("click",function(){u(e);let n=h();return p(n.onSaveTable())}),a(68,"span",14),l(69),r(),l(70),r(),P(71,vt,4,0,"button",133),r()()()()()}if(d&2){let e=h();c(6),A(e.modalMode()==="create"?"add_circle":"edit"),c(3),w(" ",e.modalMode()==="create"?"Crea Nuovo Tavolo":"Modifica Tavolo"," "),c(11),g("ngForOf",e.tableShapes),c(5),V("ngModel",e.stateService.tableForm().tableNumber),c(4),V("ngModel",e.stateService.tableForm().capacity),c(5),V("ngModel",e.stateService.tableForm().tableName),c(3),V("ngModel",e.stateService.tableForm().isOnlineBookable),c(7),g("ngIf",e.modalMode()==="create"),c(),g("ngIf",e.modalMode()==="create"),c(),g("ngIf",e.modalMode()==="edit"),c(),g("ngIf",e.modalMode()==="edit"),c(2),g("ngIf",e.stateService.tableForm().shape!=="circle"),c(),g("ngIf",e.stateService.tableForm().shape==="circle"),c(5),O("shape-circle",e.stateService.tableForm().shape==="circle"),g("ngStyle",ue(25,Oe,e.previewWidth(),e.previewHeight(),e.previewBorderRadius())),c(3),A(e.stateService.tableForm().tableNumber||"1"),c(2),w("",e.stateService.tableForm().capacity," p"),c(2),oe(" ",e.previewWidth()," \xD7 ",e.previewHeight()," px | Border Radius: ",e.stateService.tableForm().shape==="circle"?"50% (automatico)":e.stateService.tableForm().borderRadius+"px"," "),c(),g("ngIf",!1),c(6),A(e.modalMode()==="create"?"add":"save"),c(),w(" ",e.modalMode()==="create"?"Crea Tavolo":"Aggiorna Tavolo"," "),c(),g("ngIf",e.modalMode()==="edit")}}function _t(d,t){if(d&1){let e=E();a(0,"div",108)(1,"div",109)(2,"div",110)(3,"div",145)(4,"div",111)(5,"span",146),l(6,"aspect_ratio"),r()(),a(7,"h1",147),l(8,"Dimensioni Sala"),r()(),a(9,"button",113),b("click",function(){u(e);let n=h();return p(n.onCancelDimensionsModal())}),a(10,"span",14),l(11,"close"),r()()(),a(12,"div",148)(13,"form",149)(14,"div",117)(15,"div",6)(16,"label",7),l(17,"Larghezza (px)"),r(),a(18,"input",150),R("ngModelChange",function(n){u(e);let o=h();return N(o.dimensionsForm.width,n)||(o.dimensionsForm.width=n),p(n)}),r(),a(19,"span",29),l(20,"Min: 500px, Max: 5000px"),r()(),a(21,"div",6)(22,"label",7),l(23,"Altezza (px)"),r(),a(24,"input",151),R("ngModelChange",function(n){u(e);let o=h();return N(o.dimensionsForm.height,n)||(o.dimensionsForm.height=n),p(n)}),r(),a(25,"span",29),l(26,"Min: 500px, Max: 5000px"),r()()(),a(27,"div",114)(28,"label",152),l(29,"Dimensioni Predefinite"),r(),a(30,"div",12)(31,"button",153),b("click",function(){u(e);let n=h();return p(n.setDimensions(1e3,800))}),l(32," Piccola (1000\xD7800) "),r(),a(33,"button",153),b("click",function(){u(e);let n=h();return p(n.setDimensions(1500,1200))}),l(34," Media (1500\xD71200) "),r(),a(35,"button",153),b("click",function(){u(e);let n=h();return p(n.setDimensions(2e3,1600))}),l(36," Grande (2000\xD71600) "),r()()(),a(37,"div",124)(38,"strong",154),l(39,"Anteprima Dimensioni"),r(),a(40,"div",155)(41,"div",156)(42,"div",157),l(43),r()()()(),a(44,"div",130)(45,"button",131),b("click",function(){u(e);let n=h();return p(n.onCancelDimensionsModal())}),l(46," Annulla "),r(),a(47,"button",132),b("click",function(){u(e);let n=h();return p(n.onSaveDimensions())}),a(48,"span",14),l(49,"save"),r(),l(50," Salva Dimensioni "),r()()()()()()}if(d&2){let e=h();c(18),V("ngModel",e.dimensionsForm.width),c(6),V("ngModel",e.dimensionsForm.height),c(17),j("width",e.dimensionsForm.width*.1,"px")("height",e.dimensionsForm.height*.1,"px"),c(2),G(" ",e.dimensionsForm.width," \xD7 ",e.dimensionsForm.height," px ")}}function St(d,t){if(d&1&&(a(0,"div",164)(1,"span",14),l(2,"table_restaurant"),r(),a(3,"div",88)(4,"strong"),l(5),r(),a(6,"div",29),l(7),r()()()),d&2){let e=t.$implicit;c(5),w("Tavolo ",e.table_number),c(2),w("",e.capacity," persone")}}function xt(d,t){if(d&1){let e=E();a(0,"div",108)(1,"div",109)(2,"div",110)(3,"div",49)(4,"div",111)(5,"span",14),l(6,"merge"),r()(),a(7,"div")(8,"h1",112),l(9,"Unisci Tavoli"),r()()(),a(10,"button",113),b("click",function(){u(e);let n=h();return p(n.closeMergeModal())}),a(11,"span",14),l(12,"close"),r()()(),a(13,"div")(14,"form",149)(15,"div",3)(16,"div",114)(17,"label",7),l(18,"Tavoli da unire"),r(),a(19,"div",158),P(20,St,8,2,"div",159),r()(),a(21,"div",117)(22,"div",6)(23,"label",7),l(24,"Numero Nuovo Tavolo"),r(),a(25,"input",160),R("ngModelChange",function(n){u(e);let o=h();return N(o.mergeForm.tableNumber,n)||(o.mergeForm.tableNumber=n),p(n)}),r()(),a(26,"div",6)(27,"label",7),l(28,"Capacit\xE0 Totale"),r(),a(29,"input",161),R("ngModelChange",function(n){u(e);let o=h();return N(o.mergeForm.capacity,n)||(o.mergeForm.capacity=n),p(n)}),r()()(),a(30,"div",114)(31,"label",7),l(32,"Nome Tavolo Unito"),r(),a(33,"input",162),R("ngModelChange",function(n){u(e);let o=h();return N(o.mergeForm.tableName,n)||(o.mergeForm.tableName=n),p(n)}),r()(),a(34,"div",163)(35,"div",6)(36,"span"),l(37),r()(),a(38,"div",6)(39,"span"),l(40),r()()()(),a(41,"div",130)(42,"button",131),b("click",function(){u(e);let n=h();return p(n.closeMergeModal())}),l(43," Annulla "),r(),a(44,"button",132),b("click",function(){u(e);let n=h();return p(n.onMergeTables())}),a(45,"span",14),l(46,"merge"),r(),l(47," Crea Tavolo Unito "),r()()()()()()}if(d&2){let e=h();c(20),g("ngForOf",e.selectedTables()),c(5),V("ngModel",e.mergeForm.tableNumber),c(4),V("ngModel",e.mergeForm.capacity),c(4),V("ngModel",e.mergeForm.tableName),c(4),w("Capacit\xE0 originale: ",e.getTotalCapacity()," "),c(3),w("Nuova capacit\xE0: ",e.mergeForm.capacity)}}var We=class d{floorPlanService=F(ze);tableService=F(B);floorPlanInteractionService=F($);stateService=F(H);tableMergeService=F(U);authService=F(fe);supabaseService=F(X);tableRotationService=F(Q);renderer=F(se);canvasRef;containerRef;isDragging=!1;isRotating=!1;resizeObserver;destroyed=!1;subscriptions=new le;currentRestaurantId=null;highlightMessage=I(null);canvasScale=I(1);containerWidth=I(0);containerHeight=I(0);isMobileView=I(!1);userZoomed=I(!1);floorPlanWidth=M(()=>this.currentFloorPlan()?.width||1e3);floorPlanHeight=M(()=>this.currentFloorPlan()?.height||800);visualWidth=M(()=>this.floorPlanWidth()*this.canvasScale());visualHeight=M(()=>this.floorPlanHeight()*this.canvasScale());floorPlans=this.stateService.floorPlans;currentFloorPlan=this.stateService.currentFloorPlan;tables=this.stateService.tables;selectedTable=this.stateService.selectedTable;selectedTables=this.stateService.selectedTables;isDrawing=this.stateService.isDrawing;isMergeMode=this.stateService.isMergeMode;showTableModal=this.stateService.showTableModal;showEditTableModal=this.stateService.showEditTableModal;showMergeModal=this.stateService.showMergeModal;showDimensionsModal=this.stateService.showDimensionsModal;tableForm=this.stateService.tableForm;currentFloorPlanId=M(()=>this.currentFloorPlan()?.id||null);gridSize=20;snapToGrid=!0;isLargeText=!1;isEditingFloorPlanName=!1;modalMode=I("create");currentTableId=I(null);modalPosition={x:0,y:0};dimensionsForm={width:1e3,height:800};mergeForm={tableName:"",tableNumber:"",capacity:4};editingFloorPlan=null;editedFloorPlanName="";tableShapes=[];visualGridSize=M(()=>20/this.canvasScale());ngOnInit(){return T(this,null,function*(){console.log("\u{1F3C1} FloorPlanEditor ngOnInit"),this.tableShapes=this.floorPlanService.getTableShapes(),yield this.loadInitialData(),this.subscriptions.add(this.floorPlanService.data$.subscribe(e=>{if(this.stateService.setFloorPlans(e),e.length>0){let i=this.currentFloorPlan();if(!i||!e.find(n=>n.id===i.id)){let n=e[0];this.stateService.setCurrentFloorPlan(n),this.loadTablesForFloorPlan()}}else e.length===0&&this.createDefaultFloorPlan()})),this.subscriptions.add(this.tableService.data$.subscribe(()=>{!this.isRotating&&!this.isDragging&&this.loadTablesForFloorPlan()}));let t=this.generateNextTableNumber();this.stateService.updateAutoTableNumber(t)})}loadInitialData(){return T(this,null,function*(){try{let t=this.authService.currentUserValue;if(t){let{data:e,error:i}=yield this.supabaseService.getSupabaseClient().from("restaurants").select("id").eq("owner_id",t.id).limit(1);if(i){console.error("\u274C Error loading restaurants:",i);return}e&&e.length>0&&(this.currentRestaurantId=e[0].id)}yield this.floorPlanService.loadData(),yield this.tableService.loadData()}catch(t){console.error("\u{1F4A5} Error in loadInitialData:",t)}})}ngAfterViewInit(){setTimeout(()=>{if(!this.canvasRef||!this.containerRef){console.warn("Elementi non disponibili, riprovo..."),setTimeout(()=>this.ngAfterViewInit(),100);return}this.setupCanvasInteractions(),this.setupResponsiveCanvas(),this.setupPinchToZoom(),this.updateCanvasDimensions()},300)}ngOnDestroy(){this.subscriptions.unsubscribe(),this.resizeObserver&&this.resizeObserver.disconnect(),this.destroyed=!0}setupResponsiveCanvas(){let t=this.containerRef?.nativeElement;t&&(this.resizeObserver=new ResizeObserver(e=>{for(let i of e)this.containerWidth.set(i.contentRect.width),this.containerHeight.set(i.contentRect.height),this.isMobileView.set(i.contentRect.width<768),this.updateCanvasDimensions()}),this.resizeObserver.observe(t))}canvasWidth=I(1e3);canvasHeight=I(800);updateCanvasDimensions(){let t=this.containerWidth(),e=this.containerHeight();if(t===0||e===0)return;let i=this.currentFloorPlan();if(i){if(!this.userZoomed()){let n=this.isMobileView()?20:40,o=t-n,s=e-n,m=o/i.width,v=s/i.height,_=Math.min(m,v);_=Math.max(.1,Math.min(_,2)),this.canvasScale.set(_)}this.canvasWidth.set(i.width),this.canvasHeight.set(i.height),console.log("\u{1F4D0} Canvas updated:",{userZoomed:this.userZoomed(),container:`${t}x${e}`,floorPlan:`${i.width}x${i.height}`,scale:this.canvasScale(),visual:`${this.visualWidth()}x${this.visualHeight()}`})}}refreshCanvasSize(){this.updateCanvasDimensions()}zoomIn(){let t=this.canvasScale(),e=Math.min(t*1.2,3);this.canvasScale.set(e),this.userZoomed.set(!0),setTimeout(()=>{this.adjustScrollAfterZoom(t,e)},10)}zoomOut(){let t=this.canvasScale(),e=Math.max(t*.8,.1);this.canvasScale.set(e),this.userZoomed.set(!0),setTimeout(()=>{this.adjustScrollAfterZoom(t,e)},10)}adjustScrollAfterZoom(t,e){let i=this.containerRef?.nativeElement;if(!i)return;let n=i.scrollLeft+i.clientWidth/2,o=i.scrollTop+i.clientHeight/2,s=n*e/t-i.clientWidth/2,m=o*e/t-i.clientHeight/2;i.scrollLeft=Math.max(0,s),i.scrollTop=Math.max(0,m)}resetCanvasZoom(){this.userZoomed.set(!1),this.updateCanvasDimensions()}loadTablesForFloorPlan(){let t=this.currentFloorPlan();if(!t){this.stateService.setTables([]);return}let e=this.tableService.getVisibleTablesByFloorPlan(t.id);console.log("\u{1F4CA} Loading tables for floor plan:",{floorPlanId:t.id,floorPlanName:t.name,tablesCount:e.length,tables:e.map(i=>({id:i.id,number:i.table_number}))}),this.stateService.setTables(e)}onFloorPlanSelect(t){this.isEditingFloorPlanName&&this.cancelEditFloorPlanName(),this.userZoomed.set(!1),this.stateService.setCurrentFloorPlan(t),this.loadTablesForFloorPlan(),this.deselectAll(),this.cancelEditFloorPlan(),setTimeout(()=>this.updateCanvasDimensions(),50)}onFloorPlanSelectById(t){let e=this.floorPlans().find(i=>i.id===t);e&&this.onFloorPlanSelect(e)}selectTable(t){if(this.isMergeMode()){this.toggleTableSelection(t);return}this.deselectAll(),this.stateService.setSelectedTable(t)}deselectAll(){this.stateService.setSelectedTable(null),this.stateService.setShowEditTableModal(!1)}onCreateTable(){return T(this,null,function*(){let t=this.currentFloorPlan();if(!t||!this.currentRestaurantId){console.error("\u274C Missing required data");return}try{let e=this.tableForm(),i={shape:e.shape,width:e.gridWidth*this.gridSize,height:e.gridHeight*this.gridSize,border_radius:e.borderRadius},n=this.tableService.validateTableDimensions(i),o={restaurant_id:this.currentRestaurantId,floor_plan_id:t.id,table_name:e.tableName||`Tavolo ${e.tableNumber}`,table_number:e.tableNumber,capacity:e.capacity,shape:e.shape,position_x:this.modalPosition.x,position_y:this.modalPosition.y,width:n.width,height:n.height,rotation:0,is_active:!0,is_online_bookable:e.isOnlineBookable,is_merged:!1,parent_table_id:null,merged_tables_ids:[],border_radius:e.borderRadius};if(this.tableService.checkTableOverlap(o)){alert("Il tavolo si sovrappone a un altro tavolo. Scegli una posizione diversa.");return}console.log("\u{1F4DD} Creating table:",o),(yield this.tableService.createTable(o))?(console.log("\u2705 Table created successfully"),this.stateService.setShowTableModal(!1),this.stateService.setIsDrawing(!1)):console.error("\u274C Table creation failed")}catch(e){console.error("\u{1F4A5} Error creating table:",e)}})}onUpdateTable(){return T(this,null,function*(){let t=this.currentTableId();if(!(!t||!this.currentFloorPlan()))try{let e=this.tableForm(),i=this.currentFloorPlan(),n={id:t,shape:e.shape,width:e.width,height:e.height,border_radius:e.borderRadius,position_x:0,position_y:0},o=this.tableService.validateTableDimensions(n),m=this.tableService.getTables().find(k=>k.id===t);if(!m)return;if(m.position_x<0||m.position_y<0||m.position_x+o.width>i.width||m.position_y+o.height>i.height){alert("Il tavolo esce dai confini della mappa. Riduci le dimensioni o sposta il tavolo.");return}let _={shape:e.shape,width:o.width,height:o.height,border_radius:e.borderRadius,table_name:e.tableName,table_number:e.tableNumber,capacity:e.capacity,is_online_bookable:e.isOnlineBookable},y=f(f({},m),_);if(this.tableService.checkTableOverlap(y,t)){alert("Il tavolo si sovrappone a un altro tavolo. Modifica le dimensioni o la posizione.");return}(yield this.tableService.updateTable(t,_))?(console.log("\u2705 Tavolo aggiornato con successo"),this.stateService.setShowTableModal(!1),this.deselectAll()):console.error("\u274C Errore nell'aggiornamento del tavolo")}catch(e){console.error("\u274C Error updating table:",e)}})}onDeleteTable(){return T(this,null,function*(){let t=this.selectedTable();if(t&&confirm("Sei sicuro di voler eliminare questo tavolo?"))try{(yield this.tableService.deleteTable(t.id))&&this.deselectAll()}catch(e){console.error("\u274C Error deleting table:",e)}})}onCancelCreateTable(){this.stateService.setShowTableModal(!1),this.stateService.setIsDrawing(!1)}createNewFloorPlan(){return T(this,null,function*(){if(this.currentRestaurantId)try{let t=this.floorPlanService.getDefaultDimensions(),e={restaurant_id:this.currentRestaurantId,name:`Mappa ${this.floorPlans().length+1}`,width:t.width,height:t.height,is_active:!0},i=yield this.floorPlanService.createFloorPlan(e);i&&(this.stateService.resetForNewFloorPlan(),this.stateService.setCurrentFloorPlan(i),this.stateService.setTables([]),this.userZoomed.set(!1),setTimeout(()=>{this.openDimensionsModal(),setTimeout(()=>this.updateCanvasDimensions(),50)},100))}catch(t){console.error("\u{1F4A5} Error creating floor plan:",t)}})}onDeleteFloorPlan(t,e){return T(this,null,function*(){if(e.stopPropagation(),!!confirm(`Sei sicuro di voler eliminare la mappa "${t.name}"?`))try{if((yield this.floorPlanService.deleteFloorPlan(t.id))&&this.currentFloorPlan()?.id===t.id){let n=this.floorPlans().find(o=>o.id!==t.id)||null;this.stateService.setCurrentFloorPlan(n),this.loadTablesForFloorPlan()}}catch(i){console.error("\u{1F4A5} Error deleting floor plan:",i)}})}rotateSelectedTable(t=30){return T(this,null,function*(){let e=this.selectedTable();if(!(!e||this.isRotating)){this.isRotating=!0;try{if(!(yield this.tableRotationService.rotateTable(e,t)))throw new Error("Errore nel salvataggio della rotazione");console.log("\u2705 Tavolo ruotato con successo")}catch(i){console.error("\u274C Errore nella rotazione del gruppo:",i);try{yield this.tableService.loadData(),this.loadTablesForFloorPlan()}catch(n){console.error("\u274C Errore nel ricaricare i dati:",n)}alert("Errore durante la rotazione: "+(i.message||"Errore sconosciuto"))}finally{this.isRotating=!1}}})}rotateToAngle(t){let e=this.selectedTable();if(!e||this.isRotating)return;let i=this.tableRotationService.rotateToAngle(e,t);this.rotateSelectedTable(i)}onMouseWheel(t){if(!(!this.selectedTable()||this.isDrawing())&&t.ctrlKey){t.preventDefault();let e=t.deltaY>0?-5:5;this.rotateSelectedTable(e)}}updateTablesRotation(t,e){let n=this.stateService.tables().map(s=>{if(t.find(v=>v.id===s.id)){let v=(s.rotation+e)%360;return S(f({},s),{rotation:v})}return s});this.stateService.setTables(n);let o=this.selectedTable();if(o&&t.some(s=>s.id===o.id)){let s=n.find(m=>m.id===o.id);s&&this.stateService.setSelectedTable(s)}}toggleDrawingMode(){this.stateService.setIsDrawing(!this.isDrawing()),this.isDrawing()||this.deselectAll()}toggleMergeMode(){let t=this.isMergeMode();this.stateService.setIsMergeMode(!t),t?this.stateService.clearSelectedTables():this.stateService.setSelectedTables([]),this.deselectAll()}setDrawingMode(t){this.stateService.setIsDrawing(t)}closeMergeModal(){this.stateService.setShowMergeModal(!1)}toggleTableSelection(t){if(!this.isMergeMode()||t.is_merged)return;let e=this.selectedTables();e.findIndex(n=>n.id===t.id)>-1?this.stateService.removeFromSelectedTables(t.id):e.length===0||e.some(n=>this.floorPlanInteractionService.areTablesAdjacent(n,t))?e.length<4&&this.stateService.addToSelectedTables(t):this.floorPlanInteractionService.showAdjacencyWarning(t,e)}canMergeTables(){let t=this.selectedTables();return t.length>=2&&t.length<=4&&t.every(i=>!i.is_merged)&&this.floorPlanInteractionService.areSelectedTablesAdjacent(t,this.tables())}openMergeModal(){this.canMergeTables()&&(this.mergeForm={tableName:this.floorPlanService.getMergedTableName(this.selectedTables()),tableNumber:this.floorPlanService.getMergedTableNumber(this.selectedTables()),capacity:this.floorPlanService.getTotalCapacity(this.selectedTables())},this.stateService.setShowMergeModal(!0))}onMergeTables(){return T(this,null,function*(){let t=this.currentFloorPlan();if(!(!t||!this.currentRestaurantId||!this.canMergeTables()))try{let e=this.selectedTables(),i=Math.min(...e.map(_=>_.position_x)),n=Math.min(...e.map(_=>_.position_y)),o=Math.max(...e.map(_=>_.position_x+_.width)),s=Math.max(...e.map(_=>_.position_y+_.height)),m={table_name:this.mergeForm.tableName,table_number:this.mergeForm.tableNumber,capacity:this.mergeForm.capacity,position_x:i,position_y:n,width:o-i,height:s-n};(yield this.tableMergeService.mergeTables(e,m,t.id,this.currentRestaurantId))&&(this.stateService.setShowMergeModal(!1),this.stateService.setIsMergeMode(!1),this.stateService.clearSelectedTables(),yield this.tableService.loadData(),this.loadTablesForFloorPlan())}catch(e){console.error("\u274C Error merging tables:",e)}})}onSplitTable(t){return T(this,null,function*(){if(!t.merged_tables_ids||t.merged_tables_ids.length===0){console.log("\u274C Questo tavolo non \xE8 un tavolo unito");return}if(confirm("Sei sicuro di voler separare questo tavolo?"))try{console.log("\u{1F527} Separando tavolo unito:",t.table_number),(yield this.tableMergeService.splitMergedTable(t))?(console.log("\u2705 Tavolo separato con successo"),yield this.tableService.loadData(),this.loadTablesForFloorPlan(),this.deselectAll()):(console.error("\u274C Errore durante la separazione del tavolo"),alert("Errore durante la separazione del tavolo. Riprova."))}catch(e){console.error("\u274C Error splitting table:",e),alert("Errore durante la separazione del tavolo: "+e.message)}})}openDimensionsModal(){let t=this.currentFloorPlan();t&&(this.dimensionsForm={width:t.width,height:t.height},console.log("\u{1F4CF} Opening dimensions modal for:",{floorPlanId:t.id,name:t.name,currentTables:this.tables().length,dimensions:this.dimensionsForm}),this.stateService.setShowDimensionsModal(!0))}onCancelDimensionsModal(){this.stateService.setShowDimensionsModal(!1)}onSaveDimensions(){return T(this,null,function*(){let t=this.currentFloorPlan();if(t)try{let e=this.tables().filter(n=>n.floor_plan_id===t.id);if(e.length>0){let n=e.filter(o=>o.position_x+o.width>this.dimensionsForm.width||o.position_y+o.height>this.dimensionsForm.height);if(n.length>0){if(!confirm(`${n.length} tavolo(i) escono dai nuovi bordi della mappa. Vuoi continuare? I tavoli verranno spostati automaticamente.`))return;for(let s of n)s.position_x=Math.min(s.position_x,this.dimensionsForm.width-s.width),s.position_y=Math.min(s.position_y,this.dimensionsForm.height-s.height),yield this.tableService.updateTable(s.id,{position_x:s.position_x,position_y:s.position_y})}}if(yield this.floorPlanService.updateFloorPlan(t.id,{width:this.dimensionsForm.width,height:this.dimensionsForm.height})){let n=f(f({},t),this.dimensionsForm);this.stateService.setCurrentFloorPlan(n),this.stateService.setShowDimensionsModal(!1),this.updateCanvasDimensions(),console.log("\u2705 Dimensioni mappa aggiornate con successo")}}catch(e){console.error("\u274C Error updating floor plan dimensions:",e)}})}setDimensions(t,e){this.dimensionsForm.width=t,this.dimensionsForm.height=e}startEditFloorPlan(t,e){e.stopPropagation(),t&&(this.editingFloorPlan=t,this.editedFloorPlanName=t.name)}cancelEditFloorPlan(){this.editingFloorPlan=null}createDefaultFloorPlan(){return T(this,null,function*(){if(this.currentRestaurantId)try{let t=this.floorPlanService.getDefaultDimensions(),e={restaurant_id:this.currentRestaurantId,name:"Mappa Principale",width:t.width,height:t.height,is_active:!0},i=yield this.floorPlanService.createFloorPlan(e);i&&this.stateService.setCurrentFloorPlan(i)}catch(t){console.error("\u{1F4A5} Error creating default floor plan:",t)}})}generateNextTableNumber(){return this.tableService.generateNextTableNumber(this.tables())}highlightAdjacentTables(){console.log("\u{1F3AF} Mostra vicini - Inizio"),this.highlightMessage.set(null);let t=this.tables();if(t.length<2){this.highlightMessage.set("Ci sono meno di 2 tavoli nella mappa. Aggiungi altri tavoli per vedere quelli vicini."),console.warn("\u26A0\uFE0F Meno di 2 tavoli nella mappa");return}console.log("\u{1F4CA} Tavoli totali:",t.length);let i=this.findAdjacentTableGroups(t).filter(o=>o.length>1);if(i.length===0){this.highlightMessage.set("Non ci sono tavoli vicini tra loro in questa mappa. Sposta i tavoli pi\xF9 vicini per poterli unire."),console.warn("\u26A0\uFE0F Nessun gruppo di tavoli adiacenti trovato");return}console.log(`\u{1F50D} Trovati ${i.length} gruppi di tavoli adiacenti`);let n=0;i.forEach(o=>{n+=o.length}),this.highlightMessage.set(`Trovati ${i.length} gruppi di tavoli adiacenti (${n} tavoli totali). L'evidenziazione verr\xE0 rimossa tra 5 secondi.`),i.forEach(o=>{o.forEach(s=>{this.highlightTable(s)})}),setTimeout(()=>{this.clearAllHighlights(),setTimeout(()=>{this.highlightMessage.set(null)},500)},5e3)}findAdjacentTableGroups(t){let e=[],i=new Set;for(let n of t)if(!i.has(n.id)){let o=this.findConnectedTables(n,t,i);e.push(o)}return e.filter(n=>n.length>0)}findConnectedTables(t,e,i){let n=[],o=[t];for(;o.length>0;){let s=o.shift();if(!i.has(s.id)){i.add(s.id),n.push(s);for(let m of e)!i.has(m.id)&&m.id!==s.id&&this.floorPlanInteractionService.areTablesAdjacent(s,m,0)&&o.push(m)}}return n}highlightTable(t){let e=document.querySelector(`[data-table-id="${t.id}"]`);e?(e.classList.add("adjacent-highlight"),console.log(`\u2705 Evidenziato tavolo ${t.table_number}`)):console.warn(`\u26A0\uFE0F Tavolo ${t.table_number} non trovato nel DOM`)}clearAllHighlights(){document.querySelectorAll(".adjacent-highlight").forEach(e=>{e.classList.remove("adjacent-highlight")}),console.log("\u{1F9F9} Evidenziazioni rimosse")}getPreviewBorderRadius(){let t=this.tableForm();return this.floorPlanService.getPreviewBorderRadius(t.shape,t.borderRadius)}getPreviewBorderRadiusValue(){let t=this.tableForm();return this.floorPlanService.getPreviewBorderRadiusValue(t.shape,t.borderRadius)}getEditPreviewBorderRadius(){let t=this.selectedTable();return t?this.floorPlanService.getPreviewBorderRadius(t.shape,t.border_radius??8):"8px"}getEditPreviewBorderRadiusValue(){let t=this.selectedTable();return t?this.floorPlanService.getPreviewBorderRadiusValue(t.shape,t.border_radius??8):"8px"}getSelectedTableNumbers(){return this.floorPlanService.getSelectedTableNumbers(this.selectedTables())}getTableElement(t){if(!this.canvasRef?.nativeElement)return null;let e=this.canvasRef.nativeElement.querySelector(`[data-table-id="${t.id}"]`);return e||null}setupCanvasInteractions(){if(!this.canvasRef?.nativeElement){console.warn("Canvas ref non disponibile, rimando l'inizializzazione"),setTimeout(()=>this.setupCanvasInteractions(),100);return}let t=this.canvasRef.nativeElement;this.renderer.listen(t,"click",e=>this.onCanvasClick(e)),this.renderer.listen(t,"pointerdown",e=>this.onCanvasPointerDown(e)),this.renderer.listen(t,"touchstart",e=>{this.onCanvasTouchStart(e)},{passive:!1}),this.renderer.listen(document,"pointermove",()=>{this.isDragging&&t.classList.add("dragging-active")}),this.renderer.listen(document,"pointerup",()=>{this.isDragging=!1,t.classList.remove("dragging-active")})}onCanvasPointerDown(t){if(this.isDrawing())return;let i=t.target.closest(".table-element");if(i){this.isDragging=!0;let n=i.getAttribute("data-table-id"),o=this.tables().find(s=>s.id===n);o&&(console.log("\u{1F7E2} START DRAG for table:",o.table_number),i.classList.add("dragging"),i.style.transition="none",this.selectTable(o),this.floorPlanInteractionService.startTableDrag(o.id,t,this.canvasRef.nativeElement,this.canvasScale()))}else this.deselectAll();t.preventDefault(),t.stopPropagation()}onCanvasTouchStart(t){if(this.isDrawing())return;let i=t.target.closest(".table-element");if(i){t.preventDefault();let n=i.getAttribute("data-table-id"),o=this.tables().find(s=>s.id===n);if(o){this.isDragging=!0;let s=t.touches[0],m=new PointerEvent("pointerdown",{clientX:s.clientX,clientY:s.clientY,pointerId:1});i.classList.add("dragging"),i.style.transition="none",this.selectTable(o),this.floorPlanInteractionService.startTableDrag(o.id,m,this.canvasRef.nativeElement)}}else this.deselectAll()}setupPinchToZoom(){if(!this.canvasRef?.nativeElement){console.warn("Canvas ref non disponibile per pinch-to-zoom, rimando l'inizializzazione"),setTimeout(()=>this.setupPinchToZoom(),100);return}let t=this.canvasRef.nativeElement,e=0,i=0;this.renderer.listen(t,"touchstart",n=>{if(n.touches.length===2){n.preventDefault();let o=n.touches[0],s=n.touches[1];e=Math.hypot(s.clientX-o.clientX,s.clientY-o.clientY),i=this.canvasScale()}},{passive:!1}),this.renderer.listen(t,"touchmove",n=>{if(n.touches.length===2){n.preventDefault();let o=n.touches[0],s=n.touches[1],m=Math.hypot(s.clientX-o.clientX,s.clientY-o.clientY);if(e>0){let v=m/e,_=i*v,y=Math.max(.3,Math.min(_,3));this.canvasScale.set(y),this.updateCanvasDimensions()}}},{passive:!1}),this.renderer.listen(t,"touchend",()=>{e=0,i=0})}toggleSize(){this.isLargeText=!this.isLargeText}trackByTableId(t,e){return e.id}trackByFloorPlanId(t,e){return e.id}logCanvasInfo(){console.log("\u{1F4D0} Canvas Info:",{floorPlanWidth:this.floorPlanWidth(),floorPlanHeight:this.floorPlanHeight(),canvasScale:this.canvasScale(),visualWidth:this.visualWidth(),visualHeight:this.visualHeight(),isMobile:this.isMobileView()})}onTablePointerDown(t,e){if(t.stopPropagation(),t.preventDefault(),!this.isDrawing()){if(this.isMergeMode()){this.toggleTableSelection(e);return}if(this.selectTable(e),t.pointerType==="mouse"&&t.button===0){this.isDragging=!0;let i=t.target;i&&(i.classList.add("dragging"),i.style.transition="none"),this.floorPlanInteractionService.startTableDrag(e.id,t,this.canvasRef.nativeElement,this.canvasScale())}}}onDimensionChange(){if(this.modalMode()==="edit"){let t=this.stateService.tableForm();(t.shape==="circle"||t.shape==="square")&&this.stateService.updateTableForm({height:t.width,gridHeight:Math.round(t.width/this.gridSize)})}}onGridDimensionChange(){if(this.modalMode()==="create"){let t=this.stateService.tableForm(),e=t.gridWidth*this.gridSize,i=t.gridHeight*this.gridSize;if(t.shape==="circle"||t.shape==="square"){let n=t.gridWidth*this.gridSize;this.stateService.updateTableForm({width:e,height:n,gridHeight:t.gridWidth})}else this.stateService.updateTableForm({width:e,height:i})}}startEditFloorPlanName(){let t=this.currentFloorPlan();t&&(this.isEditingFloorPlanName=!0,this.editedFloorPlanName=t.name)}saveFloorPlanName(){return T(this,null,function*(){let t=this.currentFloorPlan();if(!(!t||!this.editedFloorPlanName.trim()))try{if(yield this.floorPlanService.updateFloorPlan(t.id,{name:this.editedFloorPlanName})){let i=S(f({},t),{name:this.editedFloorPlanName});this.stateService.setCurrentFloorPlan(i),yield this.floorPlanService.loadData(),this.isEditingFloorPlanName=!1,this.editedFloorPlanName=""}}catch(e){console.error("\u274C Error saving floor plan name:",e)}})}cancelEditFloorPlanName(){this.isEditingFloorPlanName=!1,this.editedFloorPlanName=""}getScrollDimensions(){let t=this.containerRef?.nativeElement,e=this.canvasRef?.nativeElement;if(!t||!e)return{scrollWidth:0,scrollHeight:0};let i=this.floorPlanWidth()*this.canvasScale(),n=this.floorPlanHeight()*this.canvasScale(),o=t.clientWidth,s=t.clientHeight,m=Math.max(0,i-o),v=Math.max(0,n-s);return{scrollWidth:m,scrollHeight:v,canScroll:m>0||v>0}}getTotalCapacity(){return this.floorPlanService.getTotalCapacity(this.selectedTables())}getTableStyle(t){return this.tableService.getTableStyle(t)}getTableClass(t){let i=[this.tableService.getTableClass(t,this.selectedTable(),this.selectedTables(),this.isMergeMode())];return this.isMergeMode()&&this.selectedTables().some(n=>n.id===t.id)&&i.push("merge-selected"),i.join(" ")}getMergedTableName(){return this.floorPlanService.getMergedTableName(this.selectedTables())}getMergedTableNumber(){return this.floorPlanService.getMergedTableNumber(this.selectedTables())}areTablesAdjacent(t,e){return this.floorPlanInteractionService.areTablesAdjacent(t,e)}areSelectedTablesAdjacent(){return this.floorPlanInteractionService.areSelectedTablesAdjacent(this.selectedTables(),this.tables())}showAdjacencyWarning(t){this.floorPlanInteractionService.showAdjacencyWarning(t,this.selectedTables())}testHighlight(){if(console.log("\u{1F526} TEST HIGHLIGHT - Verifica tavoli nel DOM:"),!this.canvasRef?.nativeElement){console.error("\u274C Canvas non trovato");return}let t=this.canvasRef.nativeElement.querySelectorAll(".table-element");if(console.log(`Tavoli nel DOM: ${t.length}`),t.length>0){let i=t[0];i.style.border="5px solid red !important",i.style.boxShadow="0 0 20px red !important",console.log("\u2705 Primo tavolo evidenziato (stile diretto)"),i.classList.add("test-highlight"),console.log("\u2705 Aggiunta classe test-highlight")}let e=this.floorPlanInteractionService.getAdjacentTablesToSelection(this.selectedTables(),this.tables());console.log("Tavoli adiacenti dal servizio:",e.map(i=>i.table_number))}previewWidth=M(()=>{let t=this.stateService.tableForm(),e=this.modalMode(),i=e==="create"?t.gridWidth*this.gridSize:t.width;return console.log("\u{1F4CF} previewWidth calcolato:",{mode:e,gridWidth:t.gridWidth,width:t.width,gridSize:this.gridSize,result:i}),i});previewHeight=M(()=>{let t=this.stateService.tableForm(),e=this.modalMode(),i;return e==="create"?i=t.gridHeight*this.gridSize:i=t.height,console.log("\u{1F4CF} previewHeight calcolato:",{mode:e,gridHeight:t.gridHeight,height:t.height,result:i}),i});previewBorderRadius=M(()=>{let t=this.stateService.tableForm(),e;return t.shape==="circle"?e="50%":e=`${t.borderRadius}px`,console.log("\u{1F504} previewBorderRadius calcolato:",{shape:t.shape,borderRadius:t.borderRadius,result:e}),e});updatePreview(){console.log("\u{1F504} Aggiorno anteprima...");let t=this.stateService.tableForm();this.stateService.updateTableForm(f({},t))}openCreateTableModal(t){this.modalMode.set("create"),this.modalPosition=t,this.currentTableId.set(null),this.stateService.resetTableForm(),this.stateService.setShowTableModal(!0)}openEditTableModal(t){let e=t||this.selectedTable();if(!e)return;this.modalMode.set("edit"),this.currentTableId.set(e.id);let i=e.is_merged||e.merged_tables_ids&&e.merged_tables_ids.length>0,n=Math.round(e.width/this.gridSize),o=Math.round(e.height/this.gridSize);this.stateService.updateTableForm({shape:e.shape,gridWidth:n,gridHeight:o,width:e.width,height:e.height,borderRadius:e.border_radius||8,tableNumber:e.table_number,capacity:e.capacity,tableName:e.table_name||"",isOnlineBookable:e.is_online_bookable,isMerged:i}),this.stateService.setShowTableModal(!0),i&&setTimeout(()=>{alert("\u26A0\uFE0F Questo tavolo \xE8 unito. Per modificare le dimensioni, separalo prima.")},100)}onSaveTable(){return T(this,null,function*(){if(this.modalMode()==="edit"&&this.tableForm().isMerged){let t=this.tableForm(),i=this.tableService.getTables().find(n=>n.id===this.currentTableId());if(i&&(t.width!==i.width||t.height!==i.height)){alert("\u274C Non puoi modificare le dimensioni di un tavolo unito. Separalo prima.");return}}this.modalMode()==="create"?yield this.onCreateTable():yield this.onUpdateTable()})}onCanvasClick(t){if(!this.isDrawing()||!this.currentFloorPlan())return;let i=this.canvasRef.nativeElement.getBoundingClientRect(),n=this.canvasScale(),o=this.floorPlanWidth(),s=this.floorPlanHeight(),m=i.left+i.width/2,v=i.top+i.height/2,_=t.clientX-m,y=t.clientY-v,D=_/n+o/2,x=y/n+s/2,k=this.snapToGrid?Math.round(D/this.gridSize)*this.gridSize:D,z=this.snapToGrid?Math.round(x/this.gridSize)*this.gridSize:x;this.openCreateTableModal({x:k,y:z}),t.stopPropagation()}onGridWidthChange(t){let e=this.stateService.tableForm();this.stateService.updateTableForm({gridWidth:t});let i=t*this.gridSize;e.shape==="circle"||e.shape==="square"?this.stateService.updateTableForm({width:i,height:i,gridHeight:t}):this.stateService.updateTableForm({width:i})}onGridHeightChange(t){let e=this.stateService.tableForm();if(this.stateService.updateTableForm({gridHeight:t}),e.shape!=="circle"&&e.shape!=="square"){let i=t*this.gridSize;this.stateService.updateTableForm({height:i})}}onWidthChange(t){let e=this.stateService.tableForm();this.stateService.updateTableForm({width:t}),e.shape==="circle"||e.shape==="square"?this.stateService.updateTableForm({height:t,gridWidth:Math.round(t/this.gridSize),gridHeight:Math.round(t/this.gridSize)}):this.stateService.updateTableForm({gridWidth:Math.round(t/this.gridSize)})}onHeightChange(t){let e=this.stateService.tableForm();e.shape!=="circle"&&e.shape!=="square"&&this.stateService.updateTableForm({height:t,gridHeight:Math.round(t/this.gridSize)})}onBorderRadiusChange(t){this.stateService.updateTableForm({borderRadius:t})}onShapeSelect(t){console.log("\u{1F3AF} Cambio forma a:",t.type),this.stateService.initializeTableFormForShape(t.type),setTimeout(()=>{let e=this.stateService.tableForm();if(this.modalMode()==="create"){let i=e.gridWidth*this.gridSize,n=e.gridHeight*this.gridSize;e.shape==="circle"||e.shape==="square"?this.stateService.updateTableForm({width:i,height:i,gridHeight:e.gridWidth}):this.stateService.updateTableForm({width:i,height:n})}else(e.shape==="circle"||e.shape==="square")&&this.stateService.updateTableForm({height:e.width,gridHeight:Math.round(e.width/this.gridSize)})},0)}static \u0275fac=function(e){return new(e||d)};static \u0275cmp=de({type:d,selectors:[["app-floor-plan"]],viewQuery:function(e,i){if(e&1&&(ie(Ae,5),ie(He,5)),e&2){let n;ne(n=ae())&&(i.canvasRef=n.first),ne(n=ae())&&(i.containerRef=n.first)}},hostBindings:function(e,i){e&1&&b("wheel",function(o){return i.onMouseWheel(o)})},decls:96,vars:30,consts:[["canvasContainer",""],["floorPlanCanvas",""],[1,"page-container"],[1,"form-card"],[1,"flex","flex-col"],[1,"form-row","mb-md"],[1,"form-group"],[1,"standard-label"],[1,"flex","gap-sm","items-center"],[1,"form-select",3,"ngModelChange","ngModel","disabled"],["value",""],[3,"ngValue",4,"ngFor","ngForOf"],[1,"flex","gap-sm"],["title","Modifica nome mappa",1,"icon-button",3,"click","disabled"],[1,"material-icons"],["title","Elimina mappa",1,"icon-button",3,"click","disabled"],["class","mt-sm",4,"ngIf"],[1,"form-row"],[1,"modal-footer",2,"justify-content","flex-start"],[1,"promethea-button",3,"click"],[1,"promethea-button","ghost",3,"click","disabled"],[1,"promethea-button","ghost",3,"click"],["title","Zoom -",1,"icon-button",3,"click"],[1,"text-sm"],["title","Zoom +",1,"icon-button",3,"click"],["title","Reset zoom",1,"icon-button",3,"click"],[1,"checkbox-label","ml-sm"],["type","checkbox",3,"ngModelChange","change","ngModel"],[1,"checkbox-content"],[1,"text-muted"],["class","form-row p-sm0",4,"ngIf"],["class","rounded mb-sm p-sm","style","background-color: var(--smoke-1); ",4,"ngIf"],["class","form-card mt-md",4,"ngIf"],[1,"canvas-container"],["class","canvas-wrapper",3,"width","height",4,"ngIf"],["class","empty-floorplan",4,"ngIf"],[1,"bg-smoke","rounded","p-md","mt-sm","flex","justify-between","flex-wrap","gap-md"],[1,"flex","flex-col","gap-sm","align-center"],[1,"font-bold"],["class","modal-overlay",4,"ngIf"],[3,"ngValue"],[1,"mt-sm"],["type","text","placeholder","Nuovo nome mappa","autofocus","",1,"form-input",3,"ngModelChange","keyup.enter","keyup.escape","ngModel"],["title","Salva",1,"icon-button","success",3,"click"],["title","Annulla",1,"icon-button",3,"click"],[1,"text-sm","text-muted","mt-sm"],[1,"form-row","p-sm0"],[1,"form-group","mt-md"],[1,"flex","justify-between","items-center","flex-wrap","gap-md"],[1,"flex","items-center","gap-sm"],["class","flex gap-sm",4,"ngIf"],[1,"flex","items-center","gap-sm","border-l","pl-sm"],["title","Ruota di -30\xB0",1,"icon-button",3,"click","disabled"],[1,"flex","flex-col","items-center"],[1,"text-sm","font-bold"],[1,"text-mini","text-muted"],["title","Ruota di +30\xB0",1,"icon-button",3,"click","disabled"],["title","Reset rotazione a 0\xB0",1,"icon-button",3,"click","disabled"],["class","text-mini text-muted mt-sm text-center",4,"ngIf"],["title","0\xB0",1,"icon-button",3,"click"],["title","90\xB0",1,"icon-button",3,"click"],["title","180\xB0",1,"icon-button",3,"click"],["title","270\xB0",1,"icon-button",3,"click"],[1,"text-mini","text-muted","mt-sm","text-center"],[1,"material-icons","text-mini"],[1,"rounded","mb-sm","p-sm",2,"background-color","var(--smoke-1)"],[1,"flex","flex-col","w-100"],["class","chip active small ml-sm",4,"ngIf"],[1,"modal-footer","w-100"],[1,"promethea-button","primary","small",3,"click"],["class","promethea-button warning small",3,"click",4,"ngIf"],[1,"promethea-button","ghost","small",3,"click"],[1,"chip","active","small","ml-sm"],[1,"promethea-button","warning","small",3,"click"],[1,"form-card","mt-md"],[1,"w-100"],["class","text-muted",4,"ngIf"],[1,"promethea-button","small",3,"click","disabled"],[4,"ngIf"],[1,"promethea-button","ghost","small",3,"click","disabled"],["class","mt-lg",4,"ngIf"],["class","alert alert-info",4,"ngIf"],["class","alert alert-warning",4,"ngIf"],["class","alert alert-success",4,"ngIf"],["class","ml-sm",4,"ngIf"],[1,"ml-sm"],[1,"mt-lg"],[1,"material-icons","text-warning"],[1,"flex-1"],[1,"icon-button","small",3,"click"],[1,"alert","alert-info"],["name","info"],[1,"alert","alert-warning"],[1,"alert","alert-success"],[1,"canvas-wrapper"],[1,"floor-plan-canvas"],[1,"canvas-background"],["class","grid-overlay",3,"background-size",4,"ngIf"],["class","table-element",3,"class","ngStyle","pointerdown",4,"ngFor","ngForOf","ngForTrackBy"],["class","empty-state",4,"ngIf"],[1,"grid-overlay"],[1,"table-element",3,"pointerdown","ngStyle"],[1,"table-content"],[1,"table-number"],[1,"table-capacity"],[1,"empty-state"],[1,"empty-floorplan"],[1,"promethea-button","primary","mt-md",3,"click"],[1,"modal-overlay"],[1,"modal-container","modal-md"],[1,"modal-header"],[1,"header-icon"],[1,"section-title"],[1,"icon-button",3,"click"],[1,"form-group","mb-lg"],[1,"grid-cards","mb-md"],["class","card text-center hover-lift",3,"active","click",4,"ngFor","ngForOf"],[1,"form-row","mb-lg"],["type","text","name","tableNumber","placeholder","Es: 1",1,"form-input",3,"ngModelChange","ngModel"],["type","number","name","capacity","min","1","max","100",1,"form-input",3,"ngModelChange","ngModel"],["type","text","name","tableName","placeholder","Es: Tavolo finestra",1,"form-input",3,"ngModelChange","ngModel"],[1,"checkbox-label"],["type","checkbox","name","isOnlineBookable",3,"ngModelChange","ngModel"],["class","form-group",4,"ngIf"],[1,"form-card","text-center"],[1,"flex","justify-center","mt-md"],[1,"table-preview",3,"ngStyle"],[1,"preview-content"],[1,"text-muted","mt-sm","mt-lg","justify-center","flex"],["class","text-xs text-muted mt-2",4,"ngIf"],[1,"modal-footer"],["type","button",1,"promethea-button","ghost",3,"click"],["type","button",1,"promethea-button",3,"click"],["type","button","class","promethea-button danger",3,"click",4,"ngIf"],[1,"card","text-center","hover-lift",3,"click"],[1,"flex","flex-col","items-center","gap-sm"],["type","number","name","gridWidth","min","2","max","20",1,"form-input",3,"ngModelChange","ngModel","disabled"],["type","number","name","gridHeight","min","2","max","20",1,"form-input",3,"ngModelChange","ngModel","disabled"],["type","number","name","width","min","20","max","1000","step","10",1,"form-input",3,"ngModelChange","ngModel","disabled"],["type","number","name","height","min","20","max","1000","step","10",1,"form-input",3,"ngModelChange","ngModel","disabled"],["type","range","name","borderRadius","min","0","max","50","step","1",1,"form-input",3,"ngModelChange","ngModel"],[1,"flex","justify-between","text-sm","text-muted"],[1,"info-message"],[1,"text-xs","text-muted","mt-2"],["type","button",1,"promethea-button","danger",3,"click"],[1,"flex","items-center","gap-md"],[1,"material-icons","text-lg"],[1,"section-title","modal-header-title"],[1,"p-lg"],[1,"generic-form"],["type","number","name","floorPlanWidth","min","500","max","5000","step","50",1,"form-input",3,"ngModelChange","ngModel"],["type","number","name","floorPlanHeight","min","500","max","5000","step","50",1,"form-input",3,"ngModelChange","ngModel"],[1,"standard-label","mb-md"],["type","button",1,"promethea-button","ghost","x-small",3,"click"],[1,"font-semibold"],[1,"flex","justify-center","mt-lg"],[1,"dimension-preview","border","shadow-card","rounded-lg","bg-smoke"],[1,"text-muted","p-sm"],[1,"flex","flex-col","gap-sm"],["class","flex items-center gap-sm p-sm border rounded",4,"ngFor","ngForOf"],["type","text","name","mergedTableNumber","placeholder","Es: U123",1,"form-input",3,"ngModelChange","ngModel"],["type","number","name","mergedTableCapacity","min","2","max","50",1,"form-input",3,"ngModelChange","ngModel"],["type","text","name","mergedTableName","placeholder","Es: Tavolo Unito per Gruppo",1,"form-input",3,"ngModelChange","ngModel"],[1,"form-row","mt-lg"],[1,"flex","items-center","gap-sm","p-sm","border","rounded"]],template:function(e,i){if(e&1){let n=E();a(0,"div",2)(1,"div",3)(2,"div",4)(3,"div",5)(4,"div",6)(5,"label",7),l(6,"Mappa"),r(),a(7,"div",8)(8,"select",9),b("ngModelChange",function(s){return u(n),p(i.onFloorPlanSelectById(s))}),a(9,"option",10),l(10,"Seleziona mappa"),r(),P(11,Be,2,4,"option",11),r(),a(12,"div",12)(13,"button",13),b("click",function(){return u(n),p(i.startEditFloorPlanName())}),a(14,"span",14),l(15,"edit"),r()(),a(16,"button",15),b("click",function(s){return u(n),p(i.onDeleteFloorPlan(i.currentFloorPlan(),s))}),a(17,"span",14),l(18,"delete"),r()()()(),P(19,Le,12,1,"div",16),r()(),a(20,"div",17)(21,"div",6)(22,"label",7),l(23,"Mappa"),r(),a(24,"div",18)(25,"button",19),b("click",function(){return u(n),p(i.createNewFloorPlan())}),a(26,"span",14),l(27,"add"),r(),l(28," Nuova Mappa "),r(),a(29,"button",20),b("click",function(){return u(n),p(i.openDimensionsModal())}),a(30,"span",14),l(31,"aspect_ratio"),r(),l(32," Dimensioni "),r()()(),a(33,"div",6)(34,"label",7),l(35,"Tavoli"),r(),a(36,"div",18)(37,"button",19),b("click",function(){return u(n),p(i.toggleDrawingMode())}),a(38,"span",14),l(39,"add_circle"),r(),l(40),r(),a(41,"button",21),b("click",function(){return u(n),p(i.toggleMergeMode())}),a(42,"span",14),l(43,"merge"),r(),l(44),r()()()(),a(45,"div",6)(46,"label",7),l(47,"Zoom"),r(),a(48,"div",8)(49,"button",22),b("click",function(){return u(n),p(i.zoomOut())}),a(50,"span",14),l(51,"zoom_out"),r()(),a(52,"span",23),l(53),r(),a(54,"button",24),b("click",function(){return u(n),p(i.zoomIn())}),a(55,"span",14),l(56,"zoom_in"),r()(),a(57,"button",25),b("click",function(){return u(n),p(i.resetCanvasZoom())}),a(58,"span",14),l(59,"refresh"),r()(),a(60,"label",26)(61,"input",27),R("ngModelChange",function(s){return u(n),N(i.snapToGrid,s)||(i.snapToGrid=s),p(s)}),b("change",function(){return u(n),p(i.refreshCanvasSize())}),r(),a(62,"div",28)(63,"span",29),l(64),r()()()()(),P(65,qe,27,6,"div",30)(66,Ue,18,4,"div",31)(67,nt,26,11,"div",32),r(),a(68,"div",33,0),P(70,lt,7,16,"div",34)(71,st,11,0,"div",35),r(),a(72,"div",36)(73,"div",37)(74,"span",29),l(75,"Dimensioni mappa:"),r(),a(76,"span",38),l(77),r()(),a(78,"div",37)(79,"span",29),l(80,"Visualizzato:"),r(),a(81,"span",38),l(82),r()(),a(83,"div",37)(84,"span",29),l(85,"Scala:"),r(),a(86,"span",38),l(87),r()(),a(88,"div",37)(89,"span",29),l(90,"Tavoli:"),r(),a(91,"span",38),l(92),r()()()()(),P(93,ft,72,29,"div",39)(94,_t,51,8,"div",39)(95,xt,48,6,"div",39)}e&2&&(c(8),g("ngModel",i.currentFloorPlanId())("disabled",i.floorPlans().length===0||i.isEditingFloorPlanName),c(3),g("ngForOf",i.floorPlans()),c(2),g("disabled",!i.currentFloorPlan()||i.isEditingFloorPlanName),c(3),g("disabled",!i.currentFloorPlan()||i.isEditingFloorPlanName),c(3),g("ngIf",i.isEditingFloorPlanName&&i.currentFloorPlan()),c(10),g("disabled",!i.currentFloorPlan()),c(8),O("active",i.isDrawing()),c(3),w(" ",i.isDrawing()?"Annulla":"Aggiungi"," "),c(),O("active",i.isMergeMode()),c(3),w(" ",i.isMergeMode()?"Annulla":"Unisci"," "),c(9),w("",(i.canvasScale()*100).toFixed(0),"%"),c(8),V("ngModel",i.snapToGrid),c(3),w("Griglia (",i.gridSize,"px)"),c(),g("ngIf",i.selectedTable()&&!i.isDrawing()),c(),g("ngIf",i.selectedTable()&&!i.isDrawing()),c(),g("ngIf",i.isMergeMode()),c(3),g("ngIf",i.currentFloorPlan()),c(),g("ngIf",!i.currentFloorPlan()),c(6),G("",i.floorPlanWidth()," \xD7 ",i.floorPlanHeight()," px"),c(5),G("",i.visualWidth().toFixed(0)," \xD7 ",i.visualHeight().toFixed(0)," px"),c(5),w("",(i.canvasScale()*100).toFixed(0),"%"),c(5),A(i.tables().length),c(),g("ngIf",i.showTableModal()),c(),g("ngIf",i.showDimensionsModal()),c(),g("ngIf",i.showMergeModal()))},dependencies:[ve,pe,ge,be,Ve,Pe,Ce,Ie,Se,Ee,Fe,_e,ye,xe,Te,ke,De,Me,we,Re,Ne],styles:[".canvas-container[_ngcontent-%COMP%]{position:relative;width:100%;height:100vh;min-height:400px;border:2px solid var(--smoke-1);border-radius:12px;background-color:var(--background);overflow:auto!important;-webkit-overflow-scrolling:touch!important;padding:var(--gap-sm);box-sizing:border-box;contain:content}.canvas-wrapper[_ngcontent-%COMP%]{position:relative;display:inline-block;min-width:100%;min-height:100%}.floor-plan-canvas[_ngcontent-%COMP%]{position:relative;background-color:var(--background);box-shadow:0 4px 12px var(--smoke-1);border-radius:8px;transform-origin:0 0;overflow:visible;margin:0;isolation:isolate;contain:layout paint}@media (max-width: 768px){.canvas-container[_ngcontent-%COMP%]{height:50vh;min-height:300px;max-height:500px;padding:8px}}.table-element[_ngcontent-%COMP%]{position:absolute;border:2px solid var(--smoke-1);background:var(--vetro);cursor:grab;display:flex;align-items:center;justify-content:center;transition:transform .2s ease-out;z-index:10;transform-origin:center;border-radius:inherit}.table-element.selected[_ngcontent-%COMP%]{border-color:var(--primary);background:var(--gradiente);z-index:30;box-shadow:0 8px 32px var(--shadow-2)}.table-content[_ngcontent-%COMP%]{text-align:center;padding:var(--gap-sm);width:100%;display:flex;flex-direction:column;gap:calc(var(--gap-sm) / 2)}.table-number[_ngcontent-%COMP%]{font-weight:800;font-size:var(--fs-sm);color:var(--text-color);line-height:1}.table-capacity[_ngcontent-%COMP%]{font-size:calc(var(--fs-sm) * .8);color:var(--text-muted);display:flex;justify-content:center;font-weight:600;line-height:1}@media (max-width: 768px){.canvas-container[_ngcontent-%COMP%]{height:60vh;min-height:400px;max-height:600px;padding:8px}}.table-element.adjacent-highlight[_ngcontent-%COMP%]{border:3px solid #FFD700!important;box-shadow:0 0 0 2px #ffd70080,0 0 20px 5px #ffd700b3!important;z-index:999!important;animation:_ngcontent-%COMP%_pulse-yellow 1.5s infinite alternate!important;transform:scale(1.02)!important;transition:all .3s ease!important}@keyframes _ngcontent-%COMP%_pulse-yellow{0%{box-shadow:0 0 0 2px #ffd70080,0 0 20px 5px #ffd700b3}to{box-shadow:0 0 0 4px #ffd700cc,0 0 30px 10px #ffd700e6}}.table-element.merge-selected.adjacent-highlight[_ngcontent-%COMP%]{border:3px double #FFD700!important;box-shadow:0 0 0 3px #ffd7004d,0 0 25px 8px #ffd70099,inset 0 0 15px #ffd70066!important}.table-preview[_ngcontent-%COMP%]{background-color:var(--vetro);border:2px solid var(--smoke-1);display:flex;align-items:center;justify-content:center;margin:0 auto;transition:all .3s ease;position:relative;overflow:hidden}.table-preview.shape-circle[_ngcontent-%COMP%]{border-radius:50%!important}.preview-content[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center;gap:calc(var(--gap-sm) / 2);pointer-events:none}.preview-content[_ngcontent-%COMP%]   .table-number[_ngcontent-%COMP%]{font-weight:800;font-size:var(--fs-sm);color:var(--text-color);line-height:1}.preview-content[_ngcontent-%COMP%]   .table-capacity[_ngcontent-%COMP%]{font-size:calc(var(--fs-sm) * .8);color:var(--text-muted);font-weight:600;line-height:1}.modal-md[_ngcontent-%COMP%]   .table-preview[_ngcontent-%COMP%]{max-width:200px;max-height:200px}"]})};export{We as FloorPlanEditor};
