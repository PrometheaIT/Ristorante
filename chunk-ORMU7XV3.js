import{a as w}from"./chunk-JHXQBKXN.js";import{a as x}from"./chunk-VQ7WJPK7.js";import{_ as b,a as c,b as u,da as _,g as o,n as g,sa as S}from"./chunk-3SWAHN2Y.js";var v=class d extends x{getTableName(){return"expenses"}supplierService=_(w);categoriesSubject=new g([]);categories$=this.categoriesSubject.asObservable();suppliersSubject=new g([]);suppliers$=this.suppliersSubject.asObservable();recurringTemplatesSubject=new g([]);recurringTemplates$=this.recurringTemplatesSubject.asObservable();create(t){return o(this,null,function*(){try{let e=yield this.getCurrentRestaurantId();if(!e)return null;let r=u(c({},t),{restaurant_id:e,created_at:new Date().toISOString(),updated_at:new Date().toISOString()}),{data:a,error:n}=yield this.supabaseService.getSupabaseClient().from(this.getTableName()).insert(r).select("*").single();if(n)throw n;return t.month?yield this.loadExpensesForMonth(t.month,!1):yield this.loadData(),console.log("\u2705 Expense created:",a),a}catch(e){return console.error("\u274C Error creating expense:",e),null}})}update(t,e){return o(this,null,function*(){try{let r=yield this.getCurrentRestaurantId();if(!r)return!1;let a=u(c({},e),{updated_at:new Date().toISOString()});"deleted_at"in e&&(a.is_active=e.deleted_at===null),"is_active"in e&&(a.deleted_at=e.is_active?null:new Date().toISOString()),console.log("\u{1F504} Updating expense with synchronized data:",a);let{error:n}=yield this.supabaseService.getSupabaseClient().from(this.getTableName()).update(a).eq("id",t).eq("restaurant_id",r);if(n)throw n;return e.month?yield this.loadExpensesForMonth(e.month,!1):yield this.loadData(),!0}catch(r){return console.error("\u274C Error updating expense:",r),!1}})}getDefaultCategories(){return["Affitto","Bollette (Luce/Gas/Acqua)","Telefono/Internet","Personale","Forniture","Manutenzione","Marketing","Assicurazione","Tasse","Mutuo","Utensili e Attrezzature","Pulizia e Igiene","Spese Bancarie","Software e Tecnologia","Trasporti e Consegne","Formazione","Altro"]}loadCategories(){return o(this,null,function*(){try{let t=yield this.getCurrentRestaurantId();if(!t)return;let{data:e,error:r}=yield this.supabaseService.getSupabaseClient().from("expense_categories").select("*").eq("restaurant_id",t).eq("is_active",!0).order("name");if(r)throw r;this.categoriesSubject.next(e||[])}catch(t){console.error("Error loading expense categories:",t)}})}createCategory(t){return o(this,null,function*(){try{let e=yield this.getCurrentRestaurantId();if(!e)return null;let r=u(c({},t),{is_active:t.is_active??!0,restaurant_id:e,created_at:new Date().toISOString()}),{data:a,error:n}=yield this.supabaseService.getSupabaseClient().from("expense_categories").insert(r).select().single();if(n)throw n;return yield this.loadCategories(),a}catch(e){return console.error("Error creating expense category:",e),null}})}loadExpensesForDateRange(t,e){return o(this,null,function*(){try{let r=yield this.getCurrentRestaurantId();if(!r)return console.log("\u274C No restaurant ID found for date range"),[];let a=this.formatMonthForDatabase(t),n=this.formatMonthForDatabase(e);console.log("\u{1F50D} Loading expenses for date range:",{startMonth:t,formattedStart:a,endMonth:e,formattedEnd:n,restaurantId:r});let{data:i,error:l}=yield this.supabaseService.getSupabaseClient().from(this.getTableName()).select(`
          *,
          suppliers (
            company_name,
            contact_name,
            email,
            phone
          )
        `).eq("restaurant_id",r).gte("month",a).lte("month",n).is("deleted_at",null).eq("is_active",!0).order("month",{ascending:!1}).order("type",{ascending:!0}).order("category",{ascending:!0});if(l)throw console.error("\u274C Supabase error loading expenses for date range:",l),l;return console.log("\u2705 Date range expenses loaded:",i?.length||0,"items"),i||[]}catch(r){return console.error("\u274C Error loading expenses for date range:",r),[]}})}formatMonthForDatabase(t){if(!t)return console.warn("\u26A0\uFE0F Month parameter is empty, using current month"),new Date().toISOString().split("T")[0];if(t.match(/^\d{4}-\d{2}-\d{2}$/))return t;if(t.match(/^\d{4}-\d{2}$/))return`${t}-01`;try{let e=new Date(t);if(isNaN(e.getTime()))throw new Error("Invalid date");return e.toISOString().split("T")[0]}catch{return console.error("\u274C Invalid month format:",t,"using current month"),new Date().toISOString().split("T")[0]}}calculateMonthlyTotal(t){let e=t.filter(a=>a.type==="fissa").reduce((a,n)=>a+n.amount,0),r=t.filter(a=>a.type==="variabile").reduce((a,n)=>a+n.amount,0);return{fisse:e,variabili:r,totale:e+r}}getAvailableMonths(){return o(this,null,function*(){try{let t=yield this.getCurrentRestaurantId();if(!t)return[];let{data:e,error:r}=yield this.supabaseService.getSupabaseClient().from(this.getTableName()).select("month").eq("restaurant_id",t).order("month",{ascending:!1});if(r)throw r;return[...new Set(e?.map(n=>n.month)||[])]}catch(t){return console.error("Error getting available months:",t),[]}})}debugExpenses(){return o(this,null,function*(){try{let t=yield this.getCurrentRestaurantId();if(console.log("\u{1F50D} DEBUG - Restaurant ID:",t),!t)return;let{data:e,error:r}=yield this.supabaseService.getSupabaseClient().from(this.getTableName()).select("*").eq("restaurant_id",t).limit(10);if(r){console.error("\u274C DEBUG - Error loading expenses:",r);return}console.log("\u{1F50D} DEBUG - First 10 expenses:",e)}catch(t){console.error("\u274C DEBUG - Error:",t)}})}loadSuppliers(){return o(this,null,function*(){try{let t=yield this.getCurrentRestaurantId();if(!t)return;console.log("\u{1F50D} Loading suppliers for restaurant:",t);let{data:e,error:r}=yield this.supabaseService.getSupabaseClient().from("suppliers").select("*").or(`restaurant_id.eq.${t},is_platform_supplier.eq.true`).eq("is_approved",!0).order("company_name");if(r){console.error("\u274C Error loading suppliers:",r);return}let a=(e||[]).map(n=>({id:n.id,company_name:n.company_name,contact_name:n.contact_name,email:n.email,phone:n.phone,is_platform_supplier:n.is_platform_supplier,is_approved:n.is_approved,type:n.is_platform_supplier?"platform":"manual"}));console.log("\u2705 Suppliers loaded:",a.length),this.suppliersSubject.next(a)}catch(t){console.error("\u274C Error in loadSuppliers:",t)}})}createRecurringTemplate(t){return o(this,null,function*(){try{let e=yield this.getCurrentRestaurantId();if(!e)return null;let r=u(c({},t),{restaurant_id:e,is_active:!0,created_at:new Date().toISOString(),updated_at:new Date().toISOString()}),{data:a,error:n}=yield this.supabaseService.getSupabaseClient().from("recurring_expense_templates").insert(r).select().single();if(n)throw n;return yield this.loadRecurringTemplates(),a}catch(e){return console.error("\u274C Error creating recurring template:",e),null}})}loadRecurringTemplates(){return o(this,null,function*(){try{let t=yield this.getCurrentRestaurantId();if(!t)return;let{data:e,error:r}=yield this.supabaseService.getSupabaseClient().from("recurring_expense_templates").select("*").eq("restaurant_id",t).eq("is_active",!0).order("name");if(r)throw r;this.recurringTemplatesSubject.next(e||[])}catch(t){console.error("\u274C Error loading recurring templates:",t)}})}generateRecurringExpensesForMonth(t){return o(this,null,function*(){try{let e=yield this.getCurrentRestaurantId();if(!e)return console.log("\u274C No restaurant ID found"),[];let r=this.formatMonthForDatabase(t);console.log("\u{1F504} Generating recurring expenses for:",r);try{let{error:s}=yield this.supabaseService.getSupabaseClient().from("recurring_expense_templates").select("id").limit(1);if(s&&s.code==="PGRST205")return console.error("\u274C Table recurring_expense_templates does not exist"),[]}catch(s){return console.error("\u274C Error checking table existence:",s),[]}let{data:a,error:n}=yield this.supabaseService.getSupabaseClient().from("recurring_expense_templates").select("*").eq("restaurant_id",e).eq("is_active",!0).lte("start_month",r).or(`end_month.is.null,end_month.gte.${r}`).order("name");if(n)return console.error("\u274C Error loading recurring templates:",n),[];if(!a||a.length===0)return console.log("\u2139\uFE0F No recurring templates found for this month"),[];let{data:i}=yield this.supabaseService.getSupabaseClient().from(this.getTableName()).select("id, name, month").eq("restaurant_id",e).eq("month",r),l=i?.map(s=>s.name.toLowerCase())||[],p=a.filter(s=>!l.includes(s.name.toLowerCase()));console.log(`\u{1F50D} Found ${a.length} templates, ${p.length} to generate`);let m=[],h=new Date().toISOString();for(let s of p){let y={name:s.name,amount:s.amount,type:s.type,category:s.category,month:r,notes:s.notes,supplier_id:s.supplier_id,is_recurring:!0,template_id:s.id,restaurant_id:e,created_at:h,updated_at:h},{data:f,error:E}=yield this.supabaseService.getSupabaseClient().from(this.getTableName()).insert(y).select().single();!E&&f&&(m.push(f),console.log(`\u2705 Generated expense: ${s.name} (\u20AC${s.amount})`))}return m}catch(e){return console.error("\u274C Error generating recurring expenses:",e),[]}})}updateRecurringTemplate(t,e){return o(this,null,function*(){try{let r=yield this.getCurrentRestaurantId();if(!r)return!1;let{error:a}=yield this.supabaseService.getSupabaseClient().from("recurring_expense_templates").update(u(c({},e),{updated_at:new Date().toISOString()})).eq("id",t).eq("restaurant_id",r);if(a)throw a;return yield this.loadRecurringTemplates(),!0}catch(r){return console.error("\u274C Error updating recurring template:",r),!1}})}loadExpensesForMonth(t,e=!0){return o(this,null,function*(){try{let r=yield this.getCurrentRestaurantId();if(!r){console.log("\u274C No restaurant ID found"),this.dataSubject.next([]);return}let a=this.formatMonthForDatabase(t);console.log("\u{1F50D} Loading expenses for:",{month:a,restaurantId:r}),e&&(yield this.generateRecurringExpensesForMonth(t));let{data:n,error:i}=yield this.supabaseService.getSupabaseClient().from(this.getTableName()).select("*").eq("restaurant_id",r).eq("month",a).is("deleted_at",null).eq("is_active",!0).order("type",{ascending:!0}).order("category",{ascending:!0});if(i)throw console.error("\u274C Supabase error loading expenses:",i),i;console.log("\u2705 Expenses loaded successfully:",n?.length||0,"items"),this.dataSubject.next(n||[])}catch(r){console.error("\u274C Error loading expenses for month:",r),this.dataSubject.next([])}})}getCurrentMonth(){let t=new Date;return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-01`}getNextMonth(t){let e=new Date(t);return e.setMonth(e.getMonth()+1),e.toISOString().split("T")[0]}debugExpenseCreation(t){return o(this,null,function*(){try{let e=yield this.getCurrentRestaurantId();console.log("\u{1F50D} DEBUG - Restaurant ID:",e),console.log("\u{1F50D} DEBUG - Expense data to insert:",t);let{data:r,error:a}=yield this.supabaseService.getSupabaseClient().from(this.getTableName()).insert(u(c({},t),{restaurant_id:e,created_at:new Date().toISOString(),updated_at:new Date().toISOString()})).select().single();a?console.error("\u274C DEBUG - Supabase error:",a):console.log("\u2705 DEBUG - Expense created:",r)}catch(e){console.error("\u274C DEBUG - Error:",e)}})}loadDeletedExpensesForMonth(t){return o(this,null,function*(){try{let e=yield this.getCurrentRestaurantId();if(!e)return[];let r=this.formatMonthForDatabase(t);console.log("\u{1F5D1}\uFE0F Loading deleted expenses for month:",r);let{data:a,error:n}=yield this.supabaseService.getSupabaseClient().from(this.getTableName()).select("*").eq("restaurant_id",e).eq("month",r).not("deleted_at","is",null).order("deleted_at",{ascending:!1}).order("type",{ascending:!0});if(n)throw n;return console.log("\u2705 Deleted expenses loaded:",a?.length||0),a||[]}catch(e){return console.error("\u274C Error loading deleted expenses:",e),[]}})}loadDeletedExpensesForDateRange(t,e){return o(this,null,function*(){try{let r=yield this.getCurrentRestaurantId();if(!r)return[];let a=this.formatMonthForDatabase(t),n=this.formatMonthForDatabase(e);console.log("\u{1F5D1}\uFE0F Loading deleted expenses for date range:",{formattedStart:a,formattedEnd:n});let{data:i,error:l}=yield this.supabaseService.getSupabaseClient().from(this.getTableName()).select("*").eq("restaurant_id",r).gte("month",a).lte("month",n).not("deleted_at","is",null).order("deleted_at",{ascending:!1}).order("month",{ascending:!1});if(l)throw l;return i||[]}catch(r){return console.error("\u274C Error loading deleted expenses for date range:",r),[]}})}hardDelete(t){return o(this,null,function*(){try{let e=yield this.getCurrentRestaurantId();if(!e)return!1;let{error:r}=yield this.supabaseService.getSupabaseClient().from(this.getTableName()).delete().eq("id",t).eq("restaurant_id",e);if(r)throw r;return!0}catch(e){return console.error("\u274C Error hard deleting expense:",e),!1}})}static \u0275fac=(()=>{let t;return function(r){return(t||(t=S(d)))(r||d)}})();static \u0275prov=b({token:d,factory:d.\u0275fac,providedIn:"root"})};export{v as a};
