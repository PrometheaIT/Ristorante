import{a as K}from"./chunk-BRXADSFW.js";import{$a as te,_a as ee}from"./chunk-GKVEDNPF.js";import{a as q,b as z,c as M,d as U,e as G,h as L,i as j,m as B,p as H,q as Q,r as W,s as J,w as X,x as Y,y as Z}from"./chunk-QAJQXQTD.js";import{b as V,c as N,d as A}from"./chunk-Z644G36S.js";import"./chunk-XYJRESY4.js";import{j as O,k as F,u as $}from"./chunk-6ELNIGGB.js";import{Ab as d,Ha as s,Ib as P,Jb as b,Mb as o,Nb as S,Ob as h,Pb as T,Xa as D,a as k,ab as p,ca as I,ia as g,ja as v,mb as m,nb as a,ob as n,pb as E,vb as y,yb as x}from"./chunk-DE3VKQQR.js";import{a as R,b as C,j as u}from"./chunk-4ZZIO3ZI.js";function ne(r,t){if(r&1&&(a(0,"div",15)(1,"span",16),o(2),n(),a(3,"span",17),o(4),n()()),r&2){let e=t.$implicit,i=d(2);s(2),h("",e.label,":"),s(2),S(i.staffByRole[e.value]||0)}}function ae(r,t){if(r&1&&(a(0,"div",4)(1,"div",5)(2,"div",6)(3,"span",7),o(4,"groups"),n(),a(5,"h3",8),o(6,"Totale Membri"),n()(),a(7,"div",9),o(8),n(),a(9,"div",10),o(10),n()(),a(11,"div",5)(12,"div",6)(13,"span",11),o(14," schedule "),n(),a(15,"h3",8),o(16,"Inviti in Attesa"),n()(),a(17,"div",12),o(18),n(),a(19,"div",10),o(20),n()(),a(21,"div",5)(22,"div",6)(23,"span",7),o(24,"badge"),n(),a(25,"h3",8),o(26,"Distribuzione Ruoli"),n()(),a(27,"div",13),p(28,ne,5,2,"div",14),n()(),a(29,"div",5)(30,"div",6)(31,"span",7),o(32,"admin_panel_settings"),n(),a(33,"h3",8),o(34,"Permessi"),n()(),a(35,"div",9),o(36),n(),a(37,"div",10),o(38," Ruoli configurati "),n()()()),r&2){let e=d();s(8),h(" ",e.totalStaffMembers," "),s(2),h(" ",e.activeStaffMembers," attivi "),s(3),P("color",e.pendingInvitations>0?"#f59e0b":""),b("text-primary",e.pendingInvitations===0),s(4),P("color",e.pendingInvitations>0?"#f59e0b":""),b("text-primary",e.pendingInvitations===0),s(),h(" ",e.pendingInvitations," "),s(2),h(" ",e.pendingInvitations===0?"Nessun invito":"Da confermare"," "),s(8),m("ngForOf",e.roleOptions),s(8),h(" ",e.rolePermissions.length,"/4 ")}}function re(r,t){r&1&&(a(0,"span"),o(1,"L'email \xE8 obbligatoria"),n())}function se(r,t){r&1&&(a(0,"span"),o(1,"Inserisci un'email valida"),n())}function oe(r,t){if(r&1&&(a(0,"div",47),p(1,re,2,0,"span",41)(2,se,2,0,"span",41),n()),r&2){let e,i,l=d(2);s(),m("ngIf",(e=l.staffForm.get("email"))==null||e.errors==null?null:e.errors.required),s(),m("ngIf",(i=l.staffForm.get("email"))==null||i.errors==null?null:i.errors.email)}}function le(r,t){if(r&1&&(a(0,"option",48),o(1),n()),r&2){let e=t.$implicit;m("value",e.value),s(),h(" ",e.label," ")}}function me(r,t){r&1&&(a(0,"span"),o(1,"Il ruolo \xE8 obbligatorio"),n())}function de(r,t){if(r&1&&(a(0,"div",47),p(1,me,2,0,"span",41),n()),r&2){let e,i=d(2);s(),m("ngIf",(e=i.staffForm.get("role"))==null||e.errors==null?null:e.errors.required)}}function ce(r,t){if(r&1&&(a(0,"div",49)(1,"strong"),o(2),n(),a(3,"p"),o(4),n()()),r&2){let e,i,l=d(2);s(2),S(l.getRoleDisplayName((e=l.staffForm.get("role"))==null?null:e.value)),s(2),S(l.getRoleDescription((i=l.staffForm.get("role"))==null?null:i.value))}}function fe(r,t){r&1&&(a(0,"span",50),o(1,"sync"),n())}function pe(r,t){r&1&&(a(0,"span",11),o(1,"person_add"),n())}function _e(r,t){r&1&&(a(0,"span"),o(1,"Aggiunta in corso..."),n())}function ue(r,t){r&1&&(a(0,"span"),o(1,"Aggiungi Membro"),n())}function ge(r,t){r&1&&(a(0,"div",51)(1,"div",52)(2,"span",53),o(3,"group_off"),n(),a(4,"h3",54),o(5,"Nessun membro dello staff"),n()(),a(6,"p",55),o(7,"Aggiungi il primo membro del team utilizzando il form sopra."),n()())}function ve(r,t){if(r&1&&(a(0,"div",64)(1,"div",65),E(2,"lucide-angular",27),n(),a(3,"div",66)(4,"div",36),o(5),n(),a(6,"div",67)(7,"span",68)(8,"span",11),o(9,"schedule"),n(),o(10," Invito in attesa "),n()()()()),r&2){let e=d().$implicit;s(2),m("size",20),s(3),S(e.email)}}function xe(r,t){if(r&1&&(a(0,"div",64)(1,"div",69)(2,"div",70),E(3,"lucide-angular",71),n(),a(4,"div",72),o(5),n()(),a(6,"div",36),o(7),n()()),r&2){let e=d().$implicit;s(3),m("size",20),s(2),T("",e.user.first_name," ",e.user.last_name),s(2),S(e.user.email)}}function Se(r,t){if(r&1){let e=y();a(0,"div",73)(1,"button",74),x("click",function(){g(e);let l=d().$implicit,c=d(3);return v(c.resendInvitation(l))}),a(2,"span",11),o(3,"send"),n(),o(4," Reinvia "),n(),a(5,"button",75),x("click",function(){g(e);let l=d().$implicit,c=d(3);return v(c.cancelInvitation(l))}),a(6,"span",11),o(7,"cancel"),n(),o(8," Annulla "),n()()}}function he(r,t){if(r&1&&(a(0,"option",48),o(1),n()),r&2){let e=t.$implicit;m("value",e.value),s(),h(" ",e.label," ")}}function be(r,t){r&1&&(a(0,"span",81)(1,"span",11),o(2,"sync"),n()())}function ye(r,t){if(r&1){let e=y();a(0,"div",78)(1,"select",79),x("change",function(l){g(e);let c=d(2).$implicit,f=d(3);return v(f.onRoleChangeAttempt(c,l))}),p(2,he,2,2,"option",32),n(),p(3,be,3,0,"span",80),n()}if(r&2){let e=d(2).$implicit,i=d(3);s(),m("ngModel",e.role)("disabled",i.updatingRoles[e.id]),s(),m("ngForOf",i.roleOptions),s(),m("ngIf",i.updatingRoles[e.id])}}function Ee(r,t){if(r&1&&(a(0,"div",76),p(1,ye,4,4,"div",77),n()),r&2){let e=d().$implicit,i=d(3);s(),m("ngIf",i.canEditStaff(e))}}function we(r,t){r&1&&(a(0,"span",11),o(1,"delete"),n())}function Ie(r,t){r&1&&(a(0,"span",11),o(1,"sync"),n())}function Me(r,t){r&1&&(a(0,"span"),o(1,"Rimozione..."),n())}function Re(r,t){r&1&&(a(0,"span"),o(1,"Rimuovi"),n())}function Ce(r,t){if(r&1){let e=y();a(0,"button",86),x("click",function(){g(e);let l=d(2).$implicit,c=d(3);return v(c.removeStaff(l))}),p(1,we,2,0,"span",40)(2,Ie,2,0,"span",40)(3,Me,2,0,"span",41)(4,Re,2,0,"span",41),n()}if(r&2){let e=d(2).$implicit,i=d(3);m("disabled",i.deletingMembers[e.id]),s(),m("ngIf",!i.deletingMembers[e.id]),s(),m("ngIf",i.deletingMembers[e.id]),s(),m("ngIf",i.deletingMembers[e.id]),s(),m("ngIf",!i.deletingMembers[e.id])}}function Pe(r,t){if(r&1){let e=y();a(0,"div",82),p(1,Ce,5,5,"button",83),a(2,"button",84),x("click",function(){g(e);let l=d().$implicit,c=d(3);return v(c.showMemberDetails(l))}),E(3,"lucide-angular",85),o(4," Dettagli "),n()()}if(r&2){let e=d().$implicit,i=d(3);s(),m("ngIf",i.canRemoveStaff(e))}}function ke(r,t){if(r&1&&(a(0,"div",58),p(1,ve,11,2,"div",59)(2,xe,8,4,"div",59),a(3,"div",60),p(4,Se,9,0,"div",61)(5,Ee,2,1,"div",62)(6,Pe,5,1,"div",63),n()()),r&2){let e=t.$implicit,i=d(3);b("pending-invitation",i.isPendingInvitation(e)),s(),m("ngIf",e.invitation_status==="pending"),s(),m("ngIf",e.invitation_status==="accepted"&&e.user),s(2),m("ngIf",i.isPendingInvitation(e)),s(),m("ngIf",i.isActiveMember(e)),s(),m("ngIf",i.isActiveMember(e))}}function De(r,t){if(r&1&&(a(0,"div",56),p(1,ke,7,7,"div",57),n()),r&2){let e=d(2);s(),m("ngForOf",e.staffMembers)}}function Te(r,t){if(r&1){let e=y();a(0,"label",100)(1,"input",101),x("change",function(l){let c=g(e).$implicit,f=d(4);return v(f.togglePermission("manager",c.key,l))}),n(),a(2,"div")(3,"strong"),o(4),n(),a(5,"div",102),o(6),n()()()}if(r&2){let e=t.$implicit,i=d(4);s(),m("checked",i.isPermissionEnabled("manager",e.key)),s(3),S(e.label),s(2),S(e.description)}}function Oe(r,t){if(r&1&&(a(0,"div",97)(1,"div",98),p(2,Te,7,3,"label",99),n()()),r&2){let e=d(3);b("collapsed",e.collapsedRoles.manager),s(2),m("ngForOf",e.permissionService.allPermissions)}}function Fe(r,t){if(r&1){let e=y();a(0,"label",105)(1,"input",101),x("change",function(l){let c=g(e).$implicit,f=d(4);return v(f.togglePermission("chef",c.key,l))}),n(),a(2,"div")(3,"strong"),o(4),n(),a(5,"div",102),o(6),n()()()}if(r&2){let e=t.$implicit,i=d(4);s(),m("checked",i.isPermissionEnabled("chef",e.key)),s(3),S(e.label),s(2),S(e.description)}}function $e(r,t){if(r&1&&(a(0,"div",103)(1,"div",98),p(2,Fe,7,3,"label",104),n()()),r&2){let e=d(3);b("collapsed",e.collapsedRoles.chef),s(2),m("ngForOf",e.permissionService.allPermissions)}}function Ve(r,t){if(r&1){let e=y();a(0,"label",105)(1,"input",101),x("change",function(l){let c=g(e).$implicit,f=d(4);return v(f.togglePermission("waiter",c.key,l))}),n(),a(2,"div")(3,"strong"),o(4),n(),a(5,"div",102),o(6),n()()()}if(r&2){let e=t.$implicit,i=d(4);s(),m("checked",i.isPermissionEnabled("waiter",e.key)),s(3),S(e.label),s(2),S(e.description)}}function Ne(r,t){if(r&1&&(a(0,"div",97)(1,"div",98),p(2,Ve,7,3,"label",104),n()()),r&2){let e=d(3);m("@collapse",e.collapsedRoles.waiter?"collapsed":"expanded"),s(2),m("ngForOf",e.permissionService.allPermissions)}}function Ae(r,t){if(r&1){let e=y();a(0,"label",105)(1,"input",101),x("change",function(l){let c=g(e).$implicit,f=d(4);return v(f.togglePermission("kitchen_staff",c.key,l))}),n(),a(2,"div")(3,"strong"),o(4),n(),a(5,"div",102),o(6),n()()()}if(r&2){let e=t.$implicit,i=d(4);s(),m("checked",i.isPermissionEnabled("kitchen_staff",e.key)),s(3),S(e.label),s(2),S(e.description)}}function qe(r,t){if(r&1&&(a(0,"div",97)(1,"div",98),p(2,Ae,7,3,"label",104),n()()),r&2){let e=d(3);m("@collapse",e.collapsedRoles.kitchen_staff?"collapsed":"expanded"),s(2),m("ngForOf",e.permissionService.allPermissions)}}function ze(r,t){if(r&1){let e=y();a(0,"div",19)(1,"div",6)(2,"span",21),o(3,"admin_panel_settings"),n(),a(4,"h2",8),o(5,"Gestione Permessi Ruoli"),n()(),a(6,"p",36),o(7,"Configura cosa pu\xF2 fare ogni ruolo nel tuo ristorante"),n(),a(8,"div",87)(9,"div",88)(10,"button",89),x("click",function(){g(e);let l=d(2);return v(l.toggleRoleCollapse("manager"))}),a(11,"h3",90)(12,"span",21),o(13,"supervisor_account"),n(),o(14),n(),a(15,"span",91),o(16," keyboard_arrow_down "),n()(),p(17,Oe,3,3,"div",92),n(),a(18,"div",88)(19,"button",89),x("click",function(){g(e);let l=d(2);return v(l.toggleRoleCollapse("chef"))}),a(20,"h3",90)(21,"span",21),o(22,"restaurant"),n(),o(23),n(),a(24,"span",91),o(25," keyboard_arrow_down "),n()(),p(26,$e,3,3,"div",93),n(),a(27,"div",88)(28,"button",89),x("click",function(){g(e);let l=d(2);return v(l.toggleRoleCollapse("waiter"))}),a(29,"h3",90),E(30,"lucide-angular",71),o(31),n(),a(32,"span",91),o(33," keyboard_arrow_down "),n()(),p(34,Ne,3,2,"div",94),n(),a(35,"div",88)(36,"button",89),x("click",function(){g(e);let l=d(2);return v(l.toggleRoleCollapse("kitchen_staff"))}),a(37,"h3",90)(38,"span",21),o(39,"kitchen"),n(),o(40),n(),a(41,"span",91),o(42," keyboard_arrow_down "),n()(),p(43,qe,3,2,"div",94),n()(),a(44,"div",95)(45,"p",96),E(46,"lucide-angular",85),o(47," I permessi verranno applicati automaticamente ai nuovi membri dello staff "),n()()()}if(r&2){let e=d(2);s(14),h(" ",e.getRoleDisplayName("manager")," "),s(),b("rotate-180",!e.collapsedRoles.manager),s(2),m("ngIf",!e.collapsedRoles.manager),s(6),h(" ",e.getRoleDisplayName("chef")," "),s(),b("rotate-180",!e.collapsedRoles.chef),s(2),m("ngIf",!e.collapsedRoles.chef),s(4),m("size",20),s(),h(" ",e.getRoleDisplayName("waiter")," "),s(),b("rotate-180",!e.collapsedRoles.waiter),s(2),m("ngIf",!e.collapsedRoles.waiter),s(6),h(" ",e.getRoleDisplayName("kitchen_staff")," "),s(),b("rotate-180",!e.collapsedRoles.kitchen_staff),s(2),m("ngIf",!e.collapsedRoles.kitchen_staff)}}function Ue(r,t){if(r&1){let e=y();a(0,"div",18)(1,"div",19)(2,"div",20)(3,"span",21),o(4,"person_add"),n(),a(5,"h2",22),o(6,"Aggiungi Nuovo Membro"),n()(),a(7,"form",23),x("ngSubmit",function(){g(e);let l=d();return v(l.onAddStaff())}),a(8,"div",24)(9,"div",25)(10,"label",26),E(11,"lucide-angular",27),o(12," Email * "),n(),E(13,"input",28),p(14,oe,3,2,"div",29),n(),a(15,"div",25)(16,"label",26)(17,"span",11),o(18,"badge"),n(),o(19," Ruolo * "),n(),a(20,"select",30)(21,"option",31),o(22,"Seleziona un ruolo"),n(),p(23,le,2,2,"option",32),n(),p(24,de,2,1,"div",29)(25,ce,5,2,"div",33),n()(),a(26,"div",25)(27,"label",34),E(28,"input",35),a(29,"div")(30,"strong"),o(31,"Invia invito via email"),n(),a(32,"div",36),o(33,"Invia un'email di invito con le credenziali di accesso"),n()()()(),a(34,"div",37)(35,"button",38),p(36,fe,2,0,"span",39)(37,pe,2,0,"span",40)(38,_e,2,0,"span",41)(39,ue,2,0,"span",41),n(),a(40,"button",42),x("click",function(){g(e);let l=d();return v(l.staffForm.reset({send_invitation:!0}))}),a(41,"span",11),o(42,"clear"),n(),o(43," Pulisci "),n()()()(),a(44,"div",19)(45,"div",6)(46,"span",21),o(47,"list"),n(),a(48,"h2",8),o(49,"Team del Ristorante"),n(),a(50,"span",43),o(51),n()(),p(52,ge,8,0,"div",44)(53,De,2,1,"div",45),n(),p(54,ze,48,17,"div",46),n()}if(r&2){let e,i=d();s(7),m("formGroup",i.staffForm),s(4),m("size",20),s(2),b("border-red-500",i.isFieldInvalid("email")),s(),m("ngIf",i.isFieldInvalid("email")),s(6),b("border-red-500",i.isFieldInvalid("role")),s(3),m("ngForOf",i.roleOptions),s(),m("ngIf",i.isFieldInvalid("role")),s(),m("ngIf",(e=i.staffForm.get("role"))==null?null:e.value),s(10),m("disabled",i.staffForm.invalid||i.addingStaff),s(),m("ngIf",i.addingStaff),s(),m("ngIf",!i.addingStaff),s(),m("ngIf",i.addingStaff),s(),m("ngIf",!i.addingStaff),s(),m("disabled",i.addingStaff),s(11),h("",i.staffMembers.length," membri"),s(),m("ngIf",i.staffMembers.length===0&&!i.loadingService.isLoadingSync()),s(),m("ngIf",i.staffMembers.length>0),s(),m("ngIf",i.isOwner)}}function Ge(r,t){r&1&&(a(0,"div",58)(1,"div",106)(2,"span",107),o(3,"block"),n(),a(4,"h3",108),o(5,"Accesso Negato"),n(),a(6,"p",36),o(7,"Non hai i permessi per gestire il personale del ristorante."),n(),a(8,"p",36),o(9,"Solo il titolare e i responsabili possono accedere a questa sezione."),n()()())}var ie=class r{supabase=I(V).getSupabaseClient();fb=I(X);authService=I(A);permissionService=I(N);loadingService=I(K);isOwner=!1;isManager=!1;currentUserRole=null;authSubscription=new k;staffForm;staffMembers=[];addingStaff=!1;updatingRoles={};deletingMembers={};showPermissionsSection=!1;savingPermissions={};rolePermissions=[];roleOptions=[{value:"manager",label:"Responsabile",description:"Gestione completa eccetto eliminazioni"},{value:"chef",label:"Chef",description:"Cucina e ingredienti"},{value:"waiter",label:"Cameriere",description:"Prenotazioni e gestione tavoli"},{value:"kitchen_staff",label:"Dipendente di Cucina",description:"Supporto in cucina e preparazione"}];constructor(){this.staffForm=this.fb.group({email:["",[M.required,M.email]],role:["",M.required],send_invitation:[!0]})}ngOnInit(){return u(this,null,function*(){console.log("StaffManagement OnInit - DEBUG:"),this.loadingService.start(),this.authSubscription=this.authService.currentUser$.subscribe(()=>{this.updateAuthState()}),this.updateAuthState();try{yield Promise.all([this.loadStaffMembers(),this.loadRolePermissions()])}catch(t){console.error("Errore nel caricamento iniziale:",t)}finally{this.loadingService.stop()}})}ngOnDestroy(){this.authSubscription&&this.authSubscription.unsubscribe()}updateAuthState(){this.isOwner=this.authService.isOwner(),this.isManager=this.authService.isManager(),this.currentUserRole=this.authService.getStaffRole(),console.log("\u{1F504} StaffManagement Auth State Updated:",{isOwner:this.isOwner,isManager:this.isManager,currentUserRole:this.currentUserRole})}loadStaffMembers(){return u(this,null,function*(){this.loadingService.start();try{let t=this.authService.getCurrentRestaurantId();if(!t){console.error("Nessun ristorante associato");return}console.log("\u{1F50D} Loading staff for restaurant:",t);let{data:e,error:i}=yield this.supabase.from("restaurant_staff").select("*").eq("restaurant_id",t).in("invitation_status",["pending","accepted"]).order("created_at",{ascending:!1});if(i)throw console.error("\u274C Error loading staff:",i),i;let l=yield Promise.all((e||[]).map(c=>u(this,null,function*(){let f=null,_=null;if(c.user_id){let{data:w}=yield this.supabase.from("users").select("id, first_name, last_name, email, phone").eq("id",c.user_id).single();f=w}if(c.invited_by){let{data:w}=yield this.supabase.from("users").select("first_name, last_name").eq("id",c.invited_by).single();_=w}return C(R({},c),{user:f,inviter:_})})));console.log("\u2705 Staff loaded with users:",l.length),this.staffMembers=l}catch(t){console.error("Error loading staff members:",t),alert("Errore nel caricamento del personale: "+t.message)}finally{this.loadingService.stop()}})}getRolePermissions(t){return u(this,null,function*(){let e=this.authService.getCurrentRestaurantId();if(!e)return this.permissionService.getDefaultPermissionsForRole(t);try{let{data:i,error:l}=yield this.supabase.from("restaurant_role_permissions").select("permissions").eq("restaurant_id",e).eq("role",t).single();if(l){if(l.code==="PGRST116")return this.permissionService.getDefaultPermissionsForRole(t);throw l}return i?.permissions||this.permissionService.getDefaultPermissionsForRole(t)}catch(i){return console.error("Error getting role permissions:",i),this.permissionService.getDefaultPermissionsForRole(t)}})}getPermissionsStatus(){console.log("\u{1F50D} DEBUG Permissions Status:"),console.log(" - Restaurant ID:",this.authService.getCurrentRestaurantId()),console.log(" - Role Permissions loaded:",this.rolePermissions.length),this.rolePermissions.forEach(t=>{console.log(`   - ${t.role}:`,t.permissions)})}updateExistingStaffPermissions(t){return u(this,null,function*(){if(!confirm(`Vuoi applicare i nuovi permessi a tutti i membri esistenti con ruolo "${this.getRoleDisplayName(t)}"?`))return;let e=this.authService.getCurrentRestaurantId();if(e)try{let i=this.rolePermissions.find(c=>c.role===t);if(!i)return;let{error:l}=yield this.supabase.from("restaurant_staff").update({permissions:i.permissions,updated_at:new Date().toISOString()}).eq("restaurant_id",e).eq("role",t).eq("invitation_status","accepted");if(l)throw l;yield this.authService.loadPermissions(),alert(`Permessi aggiornati per tutti i membri con ruolo ${this.getRoleDisplayName(t)}`)}catch(i){console.error("Error updating staff permissions:",i),alert("Errore nell'aggiornamento dei permessi: "+i.message)}})}generateToken(){return Math.random().toString(36).substring(2)+Date.now().toString(36)}getRoleDisplayName(t){return{manager:"Responsabile",chef:"Chef",waiter:"Cameriere",kitchen_staff:"Staff Cucina"}[t]||t}getRoleDescription(t){return{owner:"Accesso completo a tutte le funzionalit\xE0",manager:"Gestione completa eccetto eliminazioni definitive",chef:"Gestione cucina, ingredienti e inventario",waiter:"Gestione prenotazioni, tavoli e ordini",kitchen_staff:"Visualizzazione ordini in cucina"}[t]||"Ruolo del personale"}markFormGroupTouched(){Object.keys(this.staffForm.controls).forEach(t=>{this.staffForm.get(t)?.markAsTouched()})}isFieldInvalid(t){let e=this.staffForm.get(t);return!!(e&&e.invalid&&(e.dirty||e.touched))}ngAfterViewInit(){console.log("\u{1F50D} DEBUG Staff Management:"),console.log(" - Utente autenticato:",this.authService.isAuthenticated()),console.log(" - Utente ristorante:",this.authService.isRestaurantUser()),console.log(" - Ruolo staff:",this.authService.getStaffRole()),console.log(" - isOwner():",this.authService.isOwner()),console.log(" - isManager():",this.authService.isManager()),console.log(" - Staff record:",this.authService.getCurrentStaff()),console.log(" - Restaurant ID:",this.authService.getCurrentRestaurantId())}canEditStaff(t){let e=this.authService.isOwner(),i=this.authService.getStaffRole(),l=this.authService.currentUserValue?.id;return t.user_id===l?!1:e?!0:i==="manager"?t.role!=="manager":!1}canRemoveStaff(t){let e=this.authService.isOwner(),i=this.authService.getStaffRole(),l=this.authService.currentUserValue?.id;return t.user_id===l?!1:e?!0:i==="manager"?["chef","waiter","kitchen_staff"].includes(t.role):!1}handleError(t,e){console.error("Staff Management Error:",t),t?.code==="23503"?alert("Impossibile completare l'operazione: esistono dati collegati a questo membro dello staff."):t?.message?alert("Errore: "+t.message):alert(e)}isPendingInvitation(t){return t.invitation_status==="pending"}isActiveMember(t){return t.invitation_status==="accepted"}getInvitationStatusDisplay(t){return{pending:"In attesa",accepted:"Accettato",active:"Attivo",expired:"Scaduto"}[t]||t}resendInvitation(t){return u(this,null,function*(){try{console.log(`Reinvio invito a ${t.email}`),alert("Invito reinviato (funzionalit\xE0 email da implementare)")}catch(e){console.error("Error resending invitation:",e),alert("Errore: "+e.message)}})}cancelInvitation(t){return u(this,null,function*(){if(confirm(`Sei sicuro di voler annullare l'invito per ${t.email}?`))try{let{error:e}=yield this.supabase.from("restaurant_staff").delete().eq("id",t.id);if(e)throw e;yield this.loadStaffMembers(),alert("Invito annullato con successo!")}catch(e){console.error("Error canceling invitation:",e),alert("Errore: "+e.message)}})}togglePermission(t,e,i){return u(this,null,function*(){let l=i.target.checked,c=this.rolePermissions.find(_=>_.role===t);if(!c)return;this.savingPermissions[t]=!0;let f=[...c.permissions];l?f.includes(e)||f.push(e):f=f.filter(_=>_!==e);try{yield this.updateRolePermissions(t,f)}catch(_){i.target.checked=!l,console.error("Errore nel salvataggio del permesso:",_)}finally{this.savingPermissions[t]=!1}})}updateRolePermissions(t,e){return u(this,null,function*(){let i=this.authService.getCurrentRestaurantId();if(!i)return console.error("Nessun restaurantId trovato"),!1;try{let{data:l,error:c}=yield this.supabase.from("restaurant_role_permissions").select("id").eq("restaurant_id",i).eq("role",t).single(),f;if(c&&c.code!=="PGRST116")throw c;if(l?f=yield this.supabase.from("restaurant_role_permissions").update({permissions:e,updated_at:new Date().toISOString()}).eq("id",l.id):f=yield this.supabase.from("restaurant_role_permissions").insert({restaurant_id:i,role:t,permissions:e,created_at:new Date().toISOString(),updated_at:new Date().toISOString()}),f.error)throw f.error;let{error:_}=yield this.supabase.from("restaurant_staff").update({permissions:e,updated_at:new Date().toISOString()}).eq("restaurant_id",i).eq("role",t).eq("invitation_status","accepted");return _&&console.warn(`\u26A0\uFE0F Non tutti i permessi sono stati aggiornati: ${_.message}`),this.authService.getStaffRole()===t?yield this.authService.reloadCurrentUserPermissions():yield this.loadRolePermissions(),console.log(`\u2705 Permessi aggiornati per ${t}:`,e),!0}catch(l){return console.error("\u274C Errore aggiornamento permessi:",l),alert("Errore nel salvataggio dei permessi: "+l.message),!1}})}isPermissionEnabled(t,e){return this.rolePermissions.find(l=>l.role===t)?.permissions.includes(e)||!1}loadRolePermissions(){return u(this,null,function*(){let t=this.authService.getCurrentRestaurantId();if(t)try{let{data:e,error:i}=yield this.supabase.from("restaurant_role_permissions").select("*").eq("restaurant_id",t);if(i)throw i;this.rolePermissions=e||[],this.rolePermissions.length===0&&(yield this.createDefaultPermissions())}catch(e){console.error("Errore caricamento permessi:",e)}})}createDefaultPermissions(){return u(this,null,function*(){let t=this.authService.getCurrentRestaurantId();if(!t)return;let e=[{role:"manager",permissions:this.permissionService.getDefaultPermissionsForRole("manager")},{role:"chef",permissions:this.permissionService.getDefaultPermissionsForRole("chef")},{role:"waiter",permissions:this.permissionService.getDefaultPermissionsForRole("waiter")},{role:"kitchen_staff",permissions:this.permissionService.getDefaultPermissionsForRole("kitchen_staff")}];try{for(let i of e){let{error:l}=yield this.supabase.from("restaurant_role_permissions").insert({restaurant_id:t,role:i.role,permissions:i.permissions});if(l)throw l}yield this.loadRolePermissions()}catch(i){console.error("Errore creazione permessi predefiniti:",i)}})}collapsedRoles={manager:!0,chef:!0,waiter:!0,kitchen_staff:!0};toggleRoleCollapse(t){this.collapsedRoles[t]=!this.collapsedRoles[t]}onAddStaff(){return u(this,null,function*(){if(!this.staffForm.invalid){this.loadingService.start(),this.addingStaff=!0;try{let t=this.staffForm.value,e=this.authService.getCurrentRestaurantId(),i=this.authService.currentUserValue;if(!e||!i)throw new Error("Ristorante o utente non trovato");let{data:l}=yield this.supabase.from("restaurant_staff").select("id").eq("restaurant_id",e).eq("email",t.email.toLowerCase().trim()).eq("invitation_status","pending").single();if(l)throw new Error("Esiste gi\xE0 un invito pendente per questa email");let{error:c}=yield this.supabase.from("restaurant_staff").insert({restaurant_id:e,email:t.email.toLowerCase().trim(),role:t.role,invitation_status:"pending",invitation_token:this.generateToken(),invitation_expires_at:new Date(Date.now()+720*60*60*1e3).toISOString(),invited_by:i.id,permissions:yield this.getRolePermissions(t.role)});if(c)throw c;alert("Invito creato con successo!"),this.staffForm.reset(),yield this.loadStaffMembers()}catch(t){alert("Errore: "+t.message),console.error("Error in onAddStaff:",t)}finally{this.addingStaff=!1,this.loadingService.stop()}}})}onRoleChangeAttempt(t,e){let i=e.target,l=i.value;if(console.log("\u{1F50D} DEBUG onRoleChangeAttempt:",{memberId:t.id,currentRole:t.role,newRole:l,user:t.user}),t.role===l)return;let c=t.role,f=t.user?`${t.user.first_name} ${t.user.last_name}`:t.email,_=this.getRoleDisplayName(c),w=this.getRoleDisplayName(l);console.log("\u{1F50D} Ruoli per conferma:",{oldRole:c,oldRoleDisplay:_,newRole:l,newRoleDisplay:w}),confirm(`Sei sicuro di voler cambiare il ruolo di ${f} da "${_}" a "${w}"?`)?this.updateStaffRole(t,l,c):i.value=c}updateStaffRole(t,e,i){return u(this,null,function*(){if(console.log("\u{1F50D} DEBUG updateStaffRole:",{memberId:t.id,oldRole:i,newRole:e,currentMemberRole:t.role}),!this.canEditStaff(t)){alert("Non hai i permessi per modificare questo membro dello staff");return}this.updatingRoles[t.id]=!0;try{let{error:l}=yield this.supabase.from("restaurant_staff").update({role:e,permissions:yield this.getRolePermissions(e),updated_at:new Date().toISOString()}).eq("id",t.id);if(l)throw l;let c=this.staffMembers.findIndex(_=>_.id===t.id);c!==-1&&(this.staffMembers[c]=C(R({},this.staffMembers[c]),{role:e}),this.staffMembers=[...this.staffMembers]),yield this.authService.refreshPermissions();let f=t.user?`${t.user.first_name} ${t.user.last_name}`:t.email;console.log(`\u2705 Ruolo aggiornato: ${f} -> ${e}`),alert(`Ruolo di ${f} aggiornato con successo da "${this.getRoleDisplayName(i)}" a "${this.getRoleDisplayName(e)}"!`)}catch(l){console.error("\u274C Error updating staff role:",l),yield this.loadStaffMembers(),alert("Errore nell'aggiornamento del ruolo: "+l.message)}finally{this.updatingRoles[t.id]=!1}})}removeStaff(t){return u(this,null,function*(){if(!this.canRemoveStaff(t)){alert("Non hai i permessi per rimuovere questo membro dello staff");return}let e=t.user?`${t.user.first_name} ${t.user.last_name}`:t.email;if(confirm(`Sei sicuro di voler rimuovere ${e} dallo staff?

Questa azione non pu\xF2 essere annullata.`)){this.deletingMembers[t.id]=!0;try{let{error:i}=yield this.supabase.from("restaurant_staff").delete().eq("id",t.id);if(i)throw i;this.staffMembers=this.staffMembers.filter(l=>l.id!==t.id),alert("Membro rimosso con successo dallo staff!")}catch(i){console.error("Error removing staff:",i),alert("Errore: "+i.message)}finally{this.deletingMembers[t.id]=!1}}})}showMemberDetails(t){let i=`
  Nome: ${t.user?`${t.user.first_name} ${t.user.last_name}`:t.email}
  Email: ${t.user?.email||t.email}
  Ruolo: ${this.getRoleDisplayName(t.role)}
  Stato: ${this.getInvitationStatusDisplay(t.invitation_status)}
  Data aggiunta: ${new Date(t.created_at).toLocaleDateString("it-IT")}
  ${t.inviter?`Invitato da: ${t.inviter.first_name} ${t.inviter.last_name}`:""}
    `.trim();alert(i)}isEditingSelf(t){return t.user_id===this.authService.currentUserValue?.id}applyPermissionsToExisting(){return u(this,null,function*(){if(confirm("Applicare i permessi modificati a tutti i membri dello staff?"))try{for(let t of this.rolePermissions){let{error:e}=yield this.supabase.from("restaurant_staff").update({permissions:t.permissions,updated_at:new Date().toISOString()}).eq("restaurant_id",this.authService.getCurrentRestaurantId()).eq("role",t.role).eq("invitation_status","accepted");e&&console.warn(`\u26A0\uFE0F Errore per ${t.role}:`,e.message)}alert("Permessi applicati a tutto lo staff!"),yield this.authService.refreshPermissions()}catch(t){console.error("Errore applicazione permessi:",t)}})}get totalStaffMembers(){return this.staffMembers.length}get activeStaffMembers(){return this.staffMembers.filter(t=>t.invitation_status==="accepted").length}get pendingInvitations(){return this.staffMembers.filter(t=>t.invitation_status==="pending").length}get staffByRole(){let t={manager:0,chef:0,waiter:0,kitchen_staff:0};return this.staffMembers.filter(e=>e.invitation_status==="accepted").forEach(e=>{t[e.role]!==void 0&&t[e.role]++}),t}static \u0275fac=function(e){return new(e||r)};static \u0275cmp=D({type:r,selectors:[["app-staff-management"]],decls:4,vars:3,consts:[[1,"page-container"],["class","grid-cards p-sm mb-sm",4,"ngIf"],["class","flex flex-col gap-md",4,"ngIf"],["class","card",4,"ngIf"],[1,"grid-cards","p-sm","mb-sm"],[1,"card","transition","hover-lift"],[1,"flex","items-center","gap-sm","mb-md"],[1,"material-icons","text-primary"],[1,"text-md","font-semibold","m-0"],[1,"text-lg","font-bold","text-primary","flex","justify-center"],[1,"text-muted","text-center","mt-sm"],[1,"material-icons"],[1,"text-lg","font-bold","flex","justify-center"],[1,"flex","flex-col","gap-sm","mt-sm"],["class","flex justify-between items-center",4,"ngFor","ngForOf"],[1,"flex","justify-between","items-center"],[1,"text-mini"],[1,"font-bold"],[1,"flex","flex-col","gap-md"],[1,"form-card"],[1,"flex","items-center","gap-sm","mb-lg"],[1,"material-icons","text-md"],[1,"text-md","font-semibold"],[1,"flex","flex-col",3,"ngSubmit","formGroup"],[1,"form-row"],[1,"form-group","mb-md"],[1,"standard-label"],["name","mail",1,"nav-icon",3,"size"],["type","email","formControlName","email","placeholder","mario.rossi@example.com"],["class","text-red-500 text-sm",4,"ngIf"],["formControlName","role"],["value",""],[3,"value",4,"ngFor","ngForOf"],["class","p-md mt-sm bg-smoke rounded border",4,"ngIf"],[1,"flex","items-center","gap-sm","cursor-pointer","p-sm","rounded","transition","hover:bg-[var(--smoke-1)]"],["type","checkbox","formControlName","send_invitation"],[1,"text-muted"],[1,"modal-footer","w-100"],["type","submit",1,"promethea-button",3,"disabled"],["class","material-icons text-md mt-sm",4,"ngIf"],["class","material-icons",4,"ngIf"],[4,"ngIf"],["type","button",1,"promethea-button","ghost",3,"click","disabled"],[1,"chip"],["class","empty-state",4,"ngIf"],["class","grid-form",4,"ngIf"],["class","form-card",4,"ngIf"],[1,"text-red-500","text-sm"],[3,"value"],[1,"p-md","mt-sm","bg-smoke","rounded","border"],[1,"material-icons","text-md","mt-sm"],[1,"empty-state"],[1,"flex","gap-md","justify-center","mt-lg"],[1,"material-icons","text-6xl","text-muted","mb-4"],[1,"font-semibold","mb-md"],[1,"text-muted","flex","justify-center"],[1,"grid-form"],["class","card",3,"pending-invitation",4,"ngFor","ngForOf"],[1,"card"],["class","staff-info",4,"ngIf"],[1,"staff-member"],["class","action-group",4,"ngIf"],["class","role-selector",4,"ngIf"],["class","modal-footer p-md0",4,"ngIf"],[1,"staff-info"],[1,"avatartondo","pending"],[1,"staff-details"],[1,"flex","gap-sm","mb-sm"],[1,"staff-status","pending"],[1,"flex","gap-sm","items-center"],[1,"avatartondo"],["name","user",1,"nav-icon",3,"size"],[1,"font-semibold"],[1,"action-group"],["title","Reinvia invito",1,"promethea-button",3,"click"],["title","Annulla invito",1,"promethea-button","ghost",3,"click"],[1,"role-selector"],["style","width: 100%;",4,"ngIf"],[2,"width","100%"],[1,"form-select",3,"change","ngModel","disabled"],["class","loading-spinner",4,"ngIf"],[1,"loading-spinner"],[1,"modal-footer","p-md0"],["class","promethea-button","title","Rimuovi membro",3,"disabled","click",4,"ngIf"],["title","Dettagli membro",1,"promethea-button","ghost",3,"click"],["name","info"],["title","Rimuovi membro",1,"promethea-button",3,"click","disabled"],[1,"flex","flex-col","gap-lg","mt-lg"],[1,"role-permissions-accordion","rounded-lg","overflow-hidden"],[1,"icon-button","bottone-ruolo",3,"click"],[1,"flex","items-center","gap-sm","font-bold","m-0","text-md"],[1,"material-icons","transition-transform","duration-200"],["class","mt-sm",3,"collapsed",4,"ngIf"],["class","mt-sm collapse-section",3,"collapsed",4,"ngIf"],["class","mt-sm",4,"ngIf"],[1,"mt-lg","pt-md","border-t"],[1,"text-muted","text-center"],[1,"mt-sm"],[1,"grid-cards","p-md","bg-smoke","rounded"],["class","flex items-center gap-sm cursor-pointer p-sm rounded transition",4,"ngFor","ngForOf"],[1,"flex","items-center","gap-sm","cursor-pointer","p-sm","rounded","transition"],["type","checkbox",3,"change","checked"],[1,"text-muted","text-mini"],[1,"mt-sm","collapse-section"],["class","flex items-center gap-sm cursor-pointer p-sm rounded transition hover:bg-[var(--smoke-2)]",4,"ngFor","ngForOf"],[1,"flex","items-center","gap-sm","cursor-pointer","p-sm","rounded","transition","hover:bg-[var(--smoke-2)]"],[1,"text-center","p-xl","opacity-70"],[1,"material-icons","text-6xl"],[1,"text-md","font-semibold","mt-4"]],template:function(e,i){e&1&&(a(0,"div",0),p(1,ae,39,14,"div",1)(2,Ue,55,20,"div",2)(3,Ge,10,0,"div",3),n()),e&2&&(s(),m("ngIf",i.isOwner||i.isManager),s(),m("ngIf",i.isOwner||i.isManager),s(),m("ngIf",!(i.isOwner||i.isManager)))},dependencies:[$,O,F,Z,j,W,J,z,q,Q,U,G,B,H,Y,L,te,ee],styles:[".pending-invitation[_ngcontent-%COMP%]{background:color-mix(in srgb,var(--secondary) 5%,transparent)}.staff-info[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:var(--gap-sm);width:100%}.avatartondo.pending[_ngcontent-%COMP%]{background:var(--smoke-3);color:var(--tertiary)}.staff-status[_ngcontent-%COMP%]{display:inline-flex;align-items:center;gap:4px;padding:4px 8px;border-radius:999px;font-size:.75rem;font-weight:600}.staff-member[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:var(--gap-sm);padding:0;width:100%;margin-top:var(--gap-md)}.staff-status.pending[_ngcontent-%COMP%]{background:color-mix(in srgb,var(--secondary) 20%,transparent);color:var(--secondary)}.action-group[_ngcontent-%COMP%]{display:flex;gap:var(--gap-sm)}.bottone-ruolo[_ngcontent-%COMP%]{display:flex;width:100%;justify-content:space-between;padding:var(--gap-sm) var(--gap-md)}@media (max-width: 768px){.staff-item[_ngcontent-%COMP%]{flex-direction:column;align-items:flex-start;gap:var(--gap-md)}.staff-actions[_ngcontent-%COMP%]{align-self:flex-end}}.permission-section[_ngcontent-%COMP%]{transition:all .3s ease;overflow:hidden;max-height:500px;opacity:1}.permission-section.collapsed[_ngcontent-%COMP%]{max-height:0;opacity:0;padding:0;margin:0;overflow:hidden}"]})};export{ie as StaffManagement};
