import{b as p,d as m}from"./chunk-NPMWXJE4.js";import{Z as l,ca as u}from"./chunk-R56C6QW6.js";import{j as n}from"./chunk-4ZZIO3ZI.js";var f=class d{supabase=u(p).getSupabaseClient();authService=u(m);kitchenTransitions={ordered:["waiting","out_of_stock"],waiting:["preparing","ready","out_of_stock"],preparing:["ready","out_of_stock"],ready:["out_of_stock"],out_of_stock:[]};waiterTransitions={ordered:["waiting","cancelled"],waiting:["preparing","cancelled"],preparing:["ready","cancelled"],ready:["served","cancelled"],served:[],cancelled:["ordered"]};canTransitionItem(t,r,e){return console.log(`\u{1F50D} Verifica transizione: ${t} \u2192 ${r} (${e})`),t===r?!1:r==="out_of_stock"?!0:((e==="kitchen"?this.kitchenTransitions:this.waiterTransitions)[t]||[]).includes(r)}updateItemStatus(t,r,e){return n(this,null,function*(){try{if(!(yield this.authService.getCurrentRestaurantId()))return!1;let{error:a}=yield this.supabase.from("order_items").update({status:r,updated_at:new Date().toISOString()}).eq("id",t);return!a&&e&&(yield this.syncComandaStatus(e)),!a}catch{return!1}})}updateComandaStatus(t,r){return n(this,null,function*(){try{let e=yield this.authService.getCurrentRestaurantId();if(!e)return!1;console.log(`\u{1F504} [OrderStateService] Aggiornamento comanda ${t} a ${r}`);let{error:i}=yield this.supabase.from("comande").update({status:r,updated_at:new Date().toISOString()}).eq("id",t).eq("restaurant_id",e);if(i)return console.error("\u274C Errore aggiornamento comanda:",i),!1;let{data:a,error:c}=yield this.supabase.from("order_items").select("id").eq("order_id",t).eq("restaurant_id",e);if(c)return console.error("\u274C Errore recupero items comanda:",c),!1;if(a&&a.length>0){let s=a.map(g=>g.id),{error:o}=yield this.supabase.from("order_items").update({status:r,updated_at:new Date().toISOString()}).in("id",s).eq("restaurant_id",e);if(o)return console.error("\u274C Errore aggiornamento items:",o),!1;console.log(`\u2705 Aggiornati ${a.length} piatti per comanda ${t}`)}return!0}catch(e){return console.error("\u274C Errore updateComandaStatus:",e),!1}})}updateAllItemsInComanda(t,r){return n(this,null,function*(){try{let e=yield this.authService.getCurrentRestaurantId();if(!e)return!1;let{error:i}=yield this.supabase.from("order_items").update({status:r,updated_at:new Date().toISOString()}).eq("order_id",t).eq("restaurant_id",e);return!i}catch(e){return console.error("\u274C Errore updateAllItemsInComanda:",e),!1}})}syncComandaStatus(t){return n(this,null,function*(){let r=yield this.authService.getCurrentRestaurantId(),{data:e,error:i}=yield this.supabase.from("order_items").select("status").eq("order_id",t).eq("restaurant_id",r);if(i||!e||e.length===0)return;let a=e[0].status;e.every(s=>s.status===a)?yield this.supabase.from("comande").update({status:a,updated_at:new Date().toISOString()}).eq("id",t):e.some(o=>o.status==="preparing")&&(yield this.supabase.from("comande").update({status:"preparing",updated_at:new Date().toISOString()}).eq("id",t))})}static \u0275fac=function(r){return new(r||d)};static \u0275prov=l({token:d,factory:d.\u0275fac,providedIn:"root"})};export{f as a};
