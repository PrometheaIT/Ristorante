import{a as S}from"./chunk-4RQOBPFF.js";import{a as w,b as O,ba as m,ga as I,h as i,n as h,va as T}from"./chunk-G3XPJWB3.js";var _=class o{validTransitions={waiting:["preparing","out_of_stock"],preparing:["ready","out_of_stock"],ready:["served"],served:[],out_of_stock:[]};canTransition(e,r){let t=this.orderTransitions[e];return t?t.includes(r):!1}getNextValidStatuses(e){return this.orderTransitions[e]||[]}orderTransitions={ordered:["waiting","cancelled"],waiting:["preparing","cancelled"],preparing:["ready","cancelled"],ready:["served","cancelled"],served:[],cancelled:["ordered"]};itemTransitions={ordered:["waiting","cancelled","out_of_stock"],waiting:["preparing","cancelled","out_of_stock"],preparing:["ready","cancelled","out_of_stock"],ready:["served","cancelled","out_of_stock"],served:[],cancelled:["ordered","out_of_stock"],out_of_stock:[]};kitchenItemTransitions={waiting:["preparing","ready","out_of_stock"],preparing:["ready","out_of_stock"],ready:["out_of_stock"],out_of_stock:[]};waiterClickableStatuses=["ordered","ready"];kitchenModifiableStatuses=["waiting","preparing"];finalStatuses=["served","cancelled"];canTransitionOrder(e,r){let t=this.orderTransitions[e];return t?t.includes(r):!1}getNextWaiterStatus(e){return this.orderTransitions[e]?e==="ordered"?"waiting":e==="ready"?"served":null:null}isWaiterClickable(e){return this.waiterClickableStatuses.includes(e)}getNextKitchenStatuses(e){return e==="waiting"?["preparing"]:e==="preparing"?["ready"]:[]}isWaiterModifiable(e){return this.waiterClickableStatuses.includes(e)}isKitchenModifiable(e){return this.kitchenModifiableStatuses.includes(e)}isFinalStatus(e){return this.finalStatuses.includes(e)}getAllOrderStatuses(){return Object.keys(this.orderTransitions)}getInitialStatus(){return"ordered"}canTransitionItem(e,r,t="kitchen"){if(console.log(`\u{1F50D} Verifica transizione piatto: ${e} \u2192 ${r} (ruolo: ${t})`),e===r)return console.warn("\u26A0\uFE0F Transizione a stesso stato non consentita"),!1;if(t==="kitchen"){let a=this.kitchenItemTransitions[e];return a?a.includes(r):!1}else{let a=this.itemTransitions[e];return a?a.includes(r):!1}}getNextKitchenItemStatuses(e){return this.kitchenItemTransitions[e]||[]}getOrderStatusText(e){return{waiting:"In Attesa",preparing:"In Preparazione",ready:"Pronto",served:"Servito",ordered:"Ordinato",cancelled:"Cancellato",completed:"Completato"}[e]||e}getOrderStatusColor(e){return{waiting:"warning",preparing:"preparing",ready:"success",served:"secondary",ordered:"info",cancelled:"danger",completed:"dark"}[e]||"secondary"}static \u0275fac=function(r){return new(r||o)};static \u0275prov=m({token:o,factory:o.\u0275fac,providedIn:"root"})};var y=class o extends S{hasRestaurantId(){return!0}itemStatusChanged=new h;itemStatusChanged$=this.itemStatusChanged.asObservable();getTableName(){return"order_items"}loadData(){return i(this,null,function*(){try{this.loadingSubject.next(!0);let e=yield this.getCurrentRestaurantId();if(!e){this.dataSubject.next([]);return}let{data:r,error:t}=yield this.supabaseService.getSupabaseClient().from("order_items").select(`
        *,
        dishes!inner (name, base_price, category_id),
        orders!inner (restaurant_id, status)
      `).eq("orders.restaurant_id",e).order("created_at",{ascending:!0});if(t)throw t;console.log("\u2705 OrderItemService: Caricati",r?.length||0,"order items");let a=(r||[]).filter(s=>s.orders&&["waiting","preparing","ready","ordered"].includes(s.orders.status)).map(s=>O(w({},s),{dish_name:s.dishes?.name||"Piatto"}));this.dataSubject.next(a)}catch(e){console.error("\u274C Errore caricamento order items:",e),this.errorSubject.next(e.message),this.dataSubject.next([])}finally{this.loadingSubject.next(!1)}})}loadOrderItemsByOrderId(e){return i(this,null,function*(){try{this.loadingSubject.next(!0);let{data:r,error:t}=yield this.supabaseService.getSupabaseClient().from("order_items").select(`
          *,
          dishes!inner (name, base_price, category_id)
        `).eq("order_id",e).order("created_at",{ascending:!0});if(t)throw t;return(r||[]).map(s=>O(w({},s),{dish_name:s.dishes?.name||"Piatto",dishes:{name:s.dishes?.name||"Piatto",base_price:s.dishes?.base_price||0,category_id:s.dishes?.category_id||""}}))}catch(r){return console.error("\u274C Errore caricamento order items:",r),this.errorSubject.next(r.message),[]}finally{this.loadingSubject.next(!1)}})}addOrderItem(e,r,t,a,s){return i(this,null,function*(){try{let{data:n,error:d}=yield this.supabaseService.getSupabaseClient().from("orders").select("*").eq("id",e).single();if(d||!n)return console.error("\u274C Ordine non trovato:",d),null;let{data:u,error:f}=yield this.supabaseService.getSupabaseClient().from("dishes").select("*").eq("id",r).single();if(f||!u)return console.error("\u274C Piatto non trovato:",f),null;let{data:C,error:b}=yield this.supabaseService.getSupabaseClient().from("order_items").select("id").eq("order_id",e);b&&console.error("\u274C Errore verifica piatti esistenti:",b);let l="ordered",p=a||u.base_price,c={order_id:e,dish_id:r,quantity:t,unit_price:p,item_notes:s||"",status:l,created_at:new Date().toISOString(),updated_at:new Date().toISOString()};console.log(`\u{1F4DD} Inserimento order item (stato: ${l}):`,c);let{data:g,error:v}=yield this.supabaseService.getSupabaseClient().from("order_items").insert(c).select(`
        *,
        dishes!inner (name, base_price, category_id)
      `).single();if(v)throw console.error("\u274C Errore inserimento order item:",v),v;return console.log(`\u2705 Order item inserito con stato ${l}:`,g),g}catch(n){return console.error("\u274C Errore aggiunta piatto:",n),this.errorSubject.next(n.message),null}})}removeOrderItem(e){return i(this,null,function*(){try{let{error:r}=yield this.supabaseService.getSupabaseClient().from("order_items").delete().eq("id",e);if(r)throw r;return!0}catch(r){return console.error("\u274C Errore rimozione:",r),!1}})}updateOrderItemQuantity(e,r){return i(this,null,function*(){try{if(r<=0)return yield this.removeOrderItem(e);let{data:t}=yield this.supabaseService.getSupabaseClient().from("order_items").select("unit_price").eq("id",e).single();if(!t)return!1;let{error:a}=yield this.supabaseService.getSupabaseClient().from("order_items").update({quantity:r,updated_at:new Date().toISOString()}).eq("id",e);if(a)throw a;return!0}catch(t){return console.error("\u274C Errore aggiornamento quantit\xE0:",t),!1}})}updateOrderItemStatus(e,r){return i(this,null,function*(){if(console.log(`\u{1F504} OrderItemService.updateOrderItemStatus: ${e} -> ${r}`),!["ordered","waiting","preparing","ready","served","cancelled","out_of_stock"].includes(r))return this.errorSubject.next(`Stato non valido: ${r}`),console.error(`\u274C OrderItemService: Stato non valido: ${r}`),!1;try{let{data:a}=yield this.supabaseService.getSupabaseClient().from("order_items").select("order_id, status").eq("id",e).single();if(!a)throw new Error("Item non trovato");let s=a.order_id,n=a.status,d={status:r,updated_at:new Date().toISOString()},{error:u}=yield this.supabaseService.getSupabaseClient().from("order_items").update(d).eq("id",e);if(u)throw console.error("\u274C OrderItemService: Errore Supabase:",u),u;return console.log(`\u2705 OrderItemService: Item ${e} aggiornato da ${n} a ${r}`),this.itemStatusChanged.next({orderId:s,itemId:e,newStatus:r}),!0}catch(a){return console.error("\u274C OrderItemService: Errore nell'aggiornamento:",a),this.errorSubject.next(a.message),!1}})}forceRefresh(){return i(this,null,function*(){console.log("\u{1F504} OrderItemService: force refresh"),yield this.loadData()})}static \u0275fac=(()=>{let e;return function(t){return(e||(e=T(o)))(t||o)}})();static \u0275prov=m({token:o,factory:o.\u0275fac,providedIn:"root"})};var D=class o extends S{orderStatusService=I(_);orderItemService=I(y);hasRestaurantId(){return!0}orderItemsUpdated=new h;orderItemsUpdated$=this.orderItemsUpdated.asObservable();orderChanged=new h;orderChanged$=this.orderChanged.asObservable();constructor(){super(),this.orderItemsUpdated$.subscribe(e=>{this.updateOrderStatusFromItems(e).catch(console.error)})}getTableName(){return"orders"}createOrderInTavolata(e,r){return i(this,null,function*(){try{let{data:t,error:a}=yield this.supabaseService.getSupabaseClient().from("order_headers").select("*").eq("tavolata_id",e).single();if(a||!t)return this.errorSubject.next("Tavolata non trovata"),null;let{data:s}=yield this.supabaseService.getSupabaseClient().from("orders").select("comanda_number").eq("tavolata_id",e).order("comanda_number",{ascending:!1}),n=1;if(s&&s.length>0){let p=s.filter(c=>c.comanda_number&&c.comanda_number>0).map(c=>c.comanda_number);if(p.length>0){let c=Math.max(...p);for(let g=1;g<=c+1;g++)if(!p.includes(g)){n=g;break}}}console.log(`\u{1F4CA} Prossimo numero comanda per tavolata ${e}: ${n}`);let f=(yield this.isFirstOrderHeaderForTable(t.table_id))&&n===1?"waiting":"ordered",C={restaurant_id:t.restaurant_id,tavolata_id:e,table_id:t.table_id,order_header_id:t.id,order_number:`${t.order_number}-C${n}`,order_type:"dine_in",status:f,comanda_number:n,subtotal:0,tax_amount:0,discount_amount:0,total_amount:0,customer_name:t.customer_name,customer_phone:t.customer_phone,customer_notes:null,customer_id:null,created_at:new Date().toISOString(),updated_at:new Date().toISOString()},{data:b,error:l}=yield this.supabaseService.getSupabaseClient().from("orders").insert(C).select().single();return l?(console.error("\u274C Errore creazione comanda:",l),this.errorSubject.next(l.message),null):b}catch(t){return console.error("\u274C Errore:",t),this.errorSubject.next(t.message),null}})}getOrderById(e){return i(this,null,function*(){try{let t=(yield this.loadData$().toPromise())?.find(a=>a.id===e);return t&&(!t.order_items||t.order_items.length===0)&&(t.order_items=yield this.orderItemService.loadOrderItemsByOrderId(e)),t||null}catch(r){return console.error("\u274C Errore recupero ordine:",r),null}})}updateOrderTotal(e){return i(this,null,function*(){let t=(yield this.orderItemService.loadOrderItemsByOrderId(e)).reduce((a,s)=>a+(s.total_price||0),0);return yield this.update(e,{subtotal:t,total_amount:t,updated_at:new Date().toISOString()})})}deleteEmptyOrdersInTavolata(e){return i(this,null,function*(){try{let{data:r}=yield this.supabaseService.getSupabaseClient().from("orders").select("id").eq("tavolata_id",e),t=0;for(let a of r||[]){let{data:s}=yield this.supabaseService.getSupabaseClient().from("order_items").select("id").eq("order_id",a.id).limit(1);(!s||s.length===0)&&(yield this.delete(a.id),t++)}return console.log(`\u{1F5D1}\uFE0F Eliminate ${t} comande vuote`),t}catch(r){return console.error("\u274C Errore:",r),0}})}changeOrderStatus(e,r){return i(this,null,function*(){try{let t=yield this.getOrderById(e);if(!t)return console.error("\u274C Ordine non trovato:",e),!1;if(!this.orderStatusService.canTransition(t.status,r))return console.error(`\u274C Transizione non consentita: ${t.status} \u2192 ${r}`),!1;let{error:a}=yield this.supabaseService.getSupabaseClient().from("orders").update({status:r,updated_at:new Date().toISOString()}).eq("id",e);return a?(console.error("\u274C Errore aggiornamento stato:",a),!1):(yield this.propagateOrderStatusToAllItems(t,r,t.status),setTimeout(()=>this.loadData(),100),setTimeout(()=>this.notifyOrderItemsUpdated(e),100),this.orderChanged.next(e),!0)}catch(t){return console.error("\u274C Errore cambio stato:",t),!1}})}propagateOrderStatusToAllItems(e,r,t){return i(this,null,function*(){if(console.log(`\u{1F504} Propagazione STATO COMANDA a piatti: ${t} \u2192 ${r}`),!e.order_items||e.order_items.length===0){console.log("\u26A0\uFE0F Nessun piatto da aggiornare");return}let a="ordered";switch(r){case"ordered":a="ordered";break;case"waiting":a="waiting";break;case"preparing":a="preparing";break;case"ready":a="ready";break;case"served":a="served";break;case"cancelled":a="cancelled";break;default:console.warn(`\u26A0\uFE0F Stato comanda non riconosciuto: ${r}`);return}console.log(`\u{1F3AF} Tutti i piatti diventano: ${a}`);for(let s of e.order_items)try{if(s.status==="out_of_stock"){console.log(`\u23ED\uFE0F Salto piatto ${s.id} (gi\xE0 out_of_stock)`);continue}s.status!==a&&(console.log(`\u2705 Piatto ${s.id}: ${s.status} \u2192 ${a}`),yield this.orderItemService.updateOrderItemStatus(s.id,a))}catch(n){console.error(`\u274C Errore aggiornamento piatto ${s.id}:`,n)}})}getTodayOrders(){return i(this,null,function*(){let e=yield this.getCurrentRestaurantId();if(!e)return{count:0,revenue:0};let r=new Date().toISOString().split("T")[0],{data:t}=yield this.supabaseService.getSupabaseClient().from("orders").select("total_amount, status").eq("restaurant_id",e).gte("created_at",`${r}T00:00:00`).lte("created_at",`${r}T23:59:59`),a=(t||[]).filter(n=>n.status==="completed"),s=a.reduce((n,d)=>n+(d.total_amount||0),0);return{count:a.length,revenue:s}})}getLast7DaysSales(){return i(this,null,function*(){let e=yield this.getCurrentRestaurantId();if(!e)return this.getEmptySalesData();let r=new Date,t=new Date;t.setDate(t.getDate()-6);let{data:a}=yield this.supabaseService.getSupabaseClient().from("orders").select("created_at, total_amount").eq("restaurant_id",e).eq("status","completed").gte("created_at",t.toISOString()).lte("created_at",r.toISOString());return this.groupSalesByDay(a||[],t,r)})}getTopDishes(e=5){return i(this,null,function*(){let r=yield this.getCurrentRestaurantId();if(!r)return[];let{data:t}=yield this.supabaseService.getSupabaseClient().rpc("get_top_dishes",{p_restaurant_id:r,p_limit:e});return t||[]})}getActiveOrders(){return i(this,null,function*(){let e=yield this.getCurrentRestaurantId();if(!e)return[];let{data:r}=yield this.supabaseService.getSupabaseClient().from("orders").select("*").eq("restaurant_id",e).in("status",["waiting","ordered","preparing","ready"]).order("created_at",{ascending:!1}).limit(10);return r||[]})}getOrderItemsCount(e){return i(this,null,function*(){let{count:r}=yield this.supabaseService.getSupabaseClient().from("order_items").select("*",{count:"exact",head:!0}).eq("order_id",e);return r||0})}getEmptySalesData(){let e=[];for(let r=6;r>=0;r--){let t=new Date;t.setDate(t.getDate()-r),e.push({day:t.toLocaleDateString("it-IT",{weekday:"short"}),amount:0})}return e}groupSalesByDay(e,r,t){let a=new Map;for(let s=new Date(r);s<=t;s.setDate(s.getDate()+1)){let n=s.toISOString().split("T")[0];a.set(n,0)}return e.forEach(s=>{let n=s.created_at.split("T")[0];a.has(n)&&a.set(n,a.get(n)+(s.total_amount||0))}),Array.from(a.entries()).map(([s,n])=>({day:new Date(s).toLocaleDateString("it-IT",{weekday:"short"}),amount:n}))}calculateOverallOrderStatus(e){if(!e||e.length===0)return"ordered";let r={waiting:0,preparing:0,ready:0,served:0,cancelled:0,out_of_stock:0,ordered:0};return e.forEach(t=>{r.hasOwnProperty(t.status)&&r[t.status]++}),r.served>0&&r.served===e.length?"served":r.cancelled>0&&r.cancelled===e.length?"cancelled":r.ready>0&&r.preparing===0&&r.waiting===0?"ready":r.preparing>0?"preparing":r.waiting>0?"waiting":r.ordered>0&&r.ordered===e.length?"ordered":r.ready>0?"ready":r.preparing>0?"preparing":r.waiting>0?"waiting":"ordered"}getActiveOrderHeadersForKitchen(){return i(this,null,function*(){try{let e=yield this.getCurrentRestaurantId();if(!e)return[];let{data:r,error:t}=yield this.supabaseService.getSupabaseClient().from("order_headers").select(`
        *,
        table:table_id (table_number, table_name),
        orders:orders!order_header_id (
          *,
          order_items (
            *,
            dish:dish_id (name, base_price, category_id)
          )
        )
      `).eq("restaurant_id",e).eq("status","active").order("created_at",{ascending:!0});if(t)throw t;return(r||[]).filter(s=>s.orders?.some(n=>["waiting","preparing","ready"].includes(n.status)&&n.order_items?.some(d=>!["served","cancelled"].includes(d.status))))}catch(e){return console.error("\u274C Errore caricamento order header per cucina:",e),[]}})}getNextWaiterStatus(e){return this.orderStatusService.getNextWaiterStatus(e)}isWaiterModifiable(e){return this.orderStatusService.isWaiterModifiable(e)}getWaiterModifiableStatuses(){return this.orderStatusService.waiterClickableStatuses}changeOrderStatusForWaiter(e){return i(this,null,function*(){let r=yield this.getOrderById(e);if(!r)return!1;let t=this.orderStatusService.getNextWaiterStatus(r.status);return t?this.changeOrderStatus(e,t):(console.error("\u274C Nessun stato successivo valido per la sala"),!1)})}loadOrdersForKitchen(){return i(this,null,function*(){try{let e=yield this.getCurrentRestaurantId();if(!e)return console.log("\u274C loadOrdersForKitchen: restaurantId non trovato"),[];console.log("\u{1F50D} Caricamento ordini per cucina, restaurant:",e);let{data:r,error:t}=yield this.supabaseService.getSupabaseClient().from("orders").select(`
        *,
        table:table_id (table_number, table_name),
        order_items (
          *,
          dish:dish_id (
            id,
            name,
            base_price,
            preparation_time,
            category_id
          )
        )
      `).eq("restaurant_id",e).in("status",["ordered","waiting","preparing","ready"]).order("created_at",{ascending:!0});if(t)throw console.error("\u274C Errore query ordini cucina:",t),t;return console.log("\u2705 Ordini caricati per cucina:",r?.length||0),r&&r.length>0?(console.log("\u{1F4CA} DETTAGLIO ORDINI DAL DB:"),r.forEach((a,s)=>{console.log(`  ${s+1}. Ordine ${a.id}:`,{numero:a.order_number,stato:a.status,comanda:a.comanda_number,tavolo:a.table?.table_number,piatti:a.order_items?.length||0})})):console.log("\u26A0\uFE0F loadOrdersForKitchen: Nessun ordine trovato"),r||[]}catch(e){return console.error("\u274C Errore caricamento ordini per cucina:",e),[]}})}isFirstComandaInTavolata(e){return i(this,null,function*(){try{let{count:r,error:t}=yield this.supabaseService.getSupabaseClient().from("orders").select("*",{count:"exact",head:!0}).eq("tavolata_id",e);return t?(console.error("\u274C Errore verifica prima comanda:",t),!0):r===0}catch(r){return console.error("\u274C Errore:",r),!0}})}updateOrderStatusFromItems(e){return i(this,null,function*(){try{let r=yield this.getOrderById(e);if(!r||!r.order_items)return;let t=this.calculateOverallOrderStatus(r.order_items);if(t!==r.status){console.log(`\u{1F504} Stato comanda ${e} aggiornato da items: ${r.status} \u2192 ${t}`);let{error:a}=yield this.supabaseService.getSupabaseClient().from("orders").update({status:t,updated_at:new Date().toISOString()}).eq("id",e);a&&console.error("\u274C Errore aggiornamento stato comanda:",a)}}catch(r){console.error("\u274C Errore aggiornamento stato da items:",r)}})}notifyOrderItemsUpdated(e){this.orderItemsUpdated.next(e)}createSimpleOrder(e){return i(this,null,function*(){try{let{data:r,error:t}=yield this.supabaseService.getSupabaseClient().from("orders").insert(e).select().single();if(t)throw t;return r}catch(r){return console.error("\u274C Errore creazione ordine:",r),this.errorSubject.next(r.message),null}})}isFirstOrderHeaderForTable(e){return i(this,null,function*(){try{let{count:r,error:t}=yield this.supabaseService.getSupabaseClient().from("order_headers").select("*",{count:"exact",head:!0}).eq("table_id",e);return t?(console.error("\u274C Errore verifica primo order header per tavolo:",t),!1):r===0}catch(r){return console.error("\u274C Errore:",r),!1}})}forceRefresh(){return i(this,null,function*(){console.log("\u{1F504} OrderService: force refresh"),yield this.loadData()})}calculateOrderTotal(e){return e?e.order_items&&e.order_items.length>0?e.order_items.reduce((r,t)=>r+this.calculateItemTotal(t),0):e.total_amount!==void 0&&e.total_amount!==null&&Number(e.total_amount)||0:0}calculateItemTotal(e){if(e.total_price!==void 0&&e.total_price!==null)return Number(e.total_price)||0;let r=Number(e.unit_price)||0,t=Number(e.quantity)||1;return r*t}static \u0275fac=function(r){return new(r||o)};static \u0275prov=m({token:o,factory:o.\u0275fac,providedIn:"root"})};export{y as a,_ as b,D as c};
