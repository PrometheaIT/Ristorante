import{a as v}from"./chunk-GS53O7WG.js";import{B as u,M as l,R as d,g as a,ga as m,n as c}from"./chunk-HCHBVVTJ.js";var g=class n extends v{restaurantReservationsSubject=new c([]);restaurantReservations$=this.restaurantReservationsSubject.asObservable();constructor(){super(),this.authService.currentUser$.pipe(l(e=>!!e),d(1)).subscribe(()=>{this.loadCustomerReservations()}),this.loadRestaurantReservations()}getTableName(){return"reservations"}loadCustomerReservations(){return a(this,null,function*(){try{let e=this.authService.currentUserValue;if(!e){console.log("No user found for customer reservations"),this.dataSubject.next([]);return}yield this.loadData({customer_id:e.id}),console.log("Customer reservations loaded via BaseService")}catch(e){console.error("Error in loadCustomerReservations:",e),this.handleError("loadCustomerReservations",e)}})}loadRestaurantReservations(){return a(this,null,function*(){try{this.loadingSubject.next(!0);let e=yield this.getCurrentRestaurantId();if(!e){console.log("No restaurant ID available for staff"),this.restaurantReservationsSubject.next([]),this.loadingSubject.next(!1);return}console.log("\u{1F50D} Querying reservations for restaurant:",e);let{data:t,error:r}=yield this.supabaseService.getSupabaseClient().from(this.getTableName()).select(`
          *,
          users (first_name, last_name, email, phone),
          tables (table_name, table_number, capacity)
        `).eq("restaurant_id",e).order("reservation_date",{ascending:!0}).order("reservation_time",{ascending:!0});if(r)throw r;console.log("\u2705 Restaurant reservations loaded:",t?.length),this.restaurantReservationsSubject.next(t||[]),this.dataSubject.next(t||[])}catch(e){console.error("Error loading restaurant reservations:",e),this.handleError("loadRestaurantReservations",e)}finally{this.loadingSubject.next(!1)}})}createCustomerReservation(e){return a(this,null,function*(){try{let t=this.authService.currentUserValue;if(!t)throw new Error("User not authenticated");let r={restaurant_id:e.restaurant_id,customer_id:t.id,table_id:e.table_id,reservation_date:e.reservation_date,reservation_time:e.reservation_time,party_size:e.party_size,special_requests:e.special_requests,status:"pending"},s=yield this.create(r);return s&&(yield this.loadCustomerReservations(),yield this.loadRestaurantReservations()),s}catch(t){return console.error("\u274C Error creating customer reservation:",t),this.handleError("createCustomerReservation",t),null}})}createRestaurantReservation(e){return a(this,null,function*(){try{let t=yield this.getCurrentRestaurantId();if(!t)throw new Error("No restaurant ID available for staff");let r={restaurant_id:t,customer_name:e.customer_name,customer_phone:e.customer_phone,customer_email:e.customer_email,table_id:e.table_id,reservation_date:e.reservation_date,reservation_time:e.reservation_time,party_size:e.party_size,special_requests:e.special_requests,status:e.status||"confirmed"},s=yield this.create(r);return s&&(yield this.loadRestaurantReservations()),s}catch(t){return console.error("\u274C Error creating restaurant reservation:",t),this.handleError("createRestaurantReservation",t),null}})}updateReservationStatus(e,t){return a(this,null,function*(){return yield this.update(e,{status:t})})}assignTableToReservation(e,t){return a(this,null,function*(){return yield this.update(e,{table_id:t})})}removeTableFromReservation(e){return a(this,null,function*(){return yield this.update(e,{table_id:null})})}deleteReservation(e){return a(this,null,function*(){return yield this.delete(e)})}getFutureReservations(e){let t=new Date().toISOString().split("T")[0];return e.filter(r=>r.reservation_date>=t&&["pending","confirmed"].includes(r.status))}getReservationsByDate(e,t){return e.filter(r=>r.reservation_date===t)}getActiveReservations(e){let t=new Date().toISOString().split("T")[0];return e.filter(r=>r.reservation_date===t&&["pending","confirmed"].includes(r.status))}getCustomerName(e){return e.users?`${e.users.first_name||""} ${e.users.last_name||""}`.trim():e.customer_name||"Cliente"}getCustomerContact(e){return e.users?e.users.phone||e.users.email||"":e.customer_phone||e.customer_email||""}getTableInfo(e){return e.tables?`${e.tables.table_name} (${e.tables.table_number})`:"Non assegnato"}getRestaurantFutureReservations$(){return this.restaurantReservations$.pipe(u(e=>this.getFutureReservations(e)))}getRestaurantTodayReservations$(){return this.restaurantReservations$.pipe(u(e=>this.getActiveReservations(e)))}clearCache(){super.clearCache(),this.restaurantReservationsSubject.next([])}checkTableAvailability(e,t,r){return a(this,null,function*(){try{let{data:s,error:i}=yield this.supabaseService.getSupabaseClient().from("reservations").select("id").eq("table_id",e).eq("reservation_date",t).eq("reservation_time",r).in("status",["pending","confirmed"]).limit(1);if(i)throw i;return!s||s.length===0}catch(s){return console.error("\u274C Error checking table availability:",s),!1}})}getAvailableTimes(e,t){return a(this,null,function*(){try{let r=["12:00","12:30","13:00","13:30","14:00","19:00","19:30","20:00","20:30","21:00","21:30"],{data:s,error:i}=yield this.supabaseService.getSupabaseClient().from("reservations").select("reservation_time").eq("table_id",e).eq("reservation_date",t).in("status",["pending","confirmed"]);if(i)throw i;let _=s?.map(o=>o.reservation_time)||[];return r.filter(o=>!_.includes(o))}catch(r){return console.error("\u274C Error getting available times:",r),[]}})}static \u0275fac=function(t){return new(t||n)};static \u0275prov=m({token:n,factory:n.\u0275fac,providedIn:"root"})};export{g as a};
