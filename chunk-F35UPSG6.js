import{b}from"./chunk-4GBXVLF4.js";import{e as w}from"./chunk-37GYPR4T.js";import{S as R,Y as d,ba as p,c as v,g as u,o as S}from"./chunk-DU5L5MFQ.js";import{a as h,b as m,j as i}from"./chunk-4ZZIO3ZI.js";var g=class c{supabaseService=p(b);userPermissionsSubject=new u([]);userPermissions$=this.userPermissionsSubject.asObservable();allPermissions=[{key:"view_dashboard",label:"Visualizza Dashboard",description:"Accesso alla dashboard principale"},{key:"manage_menu",label:"Gestione Men\xF9",description:"Aggiungere, modificare e eliminare piatti e categorie"},{key:"manage_orders",label:"Gestione Ordini",description:"Visualizzare e gestire gli ordini dei clienti"},{key:"manage_reservations",label:"Gestione Prenotazioni",description:"Gestire le prenotazioni dei tavoli"},{key:"view_reports",label:"Visualizza Report",description:"Accesso ai report finanziari e statistiche"},{key:"view_kitchen_display",label:"Pannello Cucina",description:"Visualizzare gli ordini in cucina"},{key:"manage_inventory",label:"Gestione Inventario",description:"Gestire ingredienti e scorte"},{key:"view_expenses",label:"Visualizza Spese",description:"Visualizzare e gestire le spese"},{key:"view_table_map",label:"Mappa Tavoli",description:"Visualizzare la mappa dei tavoli"},{key:"take_orders",label:"Prendere Ordini",description:"Registrare nuovi ordini"},{key:"manage_restaurant_settings",label:"Impostazioni Ristorante",description:"Modificare le impostazioni del ristorante"},{key:"manage_staff",label:"Gestione Staff",description:"Aggiungere e gestire il personale"},{key:"view_ingredients",label:"Visualizza Ingredienti",description:"Accesso alla gestione ingredienti e ricette"}];loadUserPermissions(e,t,s,r,n){return i(this,null,function*(){if(console.log("\u{1F504} PermissionService - Caricamento permessi:",{userId:e,restaurantId:t,isOwner:s,staffRole:r,isSupplier:n}),n){let a=["view_supplier_dashboard","manage_supplier_products","view_supplier_restaurants","manage_supplier_orders","manage_supplier_profile"];this.userPermissionsSubject.next(a),console.log("\u2705 Permessi fornitore caricati");return}if(s){let a=this.allPermissions.filter(o=>!o.key.includes("supplier")).map(o=>o.key);this.userPermissionsSubject.next(a),console.log("\u2705 Permessi proprietario caricati:",a);return}if(r&&t){let a=yield this.getPermissionsForRole(t,r);this.userPermissionsSubject.next(a),console.log("\u2705 Permessi staff caricati:",a);return}this.userPermissionsSubject.next([]),console.log("\u26A0\uFE0F Nessun permesso caricato")})}getPermissionsForRole(e,t){return i(this,null,function*(){try{console.log("\u{1F50D} Loading permissions for role:",{restaurantId:e,role:t});let{data:s,error:r}=yield this.supabaseService.getSupabaseClient().from("restaurant_staff").select("permissions").eq("restaurant_id",e).eq("role",t).eq("invitation_status","accepted").maybeSingle();if(!r&&s?.permissions&&s.permissions.length>0)return console.log("\u2705 Permissions loaded from staff table:",s.permissions),s.permissions;let{data:n,error:a}=yield this.supabaseService.getSupabaseClient().from("restaurant_role_permissions").select("permissions").eq("restaurant_id",e).eq("role",t).maybeSingle();return!a&&n?.permissions&&n.permissions.length>0?(console.log("\u2705 Permissions loaded from role_permissions table:",n.permissions),n.permissions):(console.log("\u{1F4ED} No custom permissions found, using defaults for role:",t),this.getDefaultPermissionsForRole(t))}catch(s){return console.error("\u274C Error in getPermissionsForRole:",s),this.getDefaultPermissionsForRole(t)}})}getDefaultPermissionsForRole(e){return{manager:["view_dashboard","manage_menu","manage_orders","manage_reservations","view_reports","view_kitchen_display","manage_inventory","view_expenses","view_table_map","take_orders","manage_restaurant_settings","manage_staff"],chef:["view_dashboard","view_kitchen_display","manage_inventory","view_expenses"],waiter:["view_dashboard","manage_reservations","take_orders"],kitchen_staff:["view_kitchen_display"]}[e]||[]}hasPermission(e){return this.userPermissionsSubject.getValue().includes(e)}hasAnyPermission(e){let t=this.userPermissionsSubject.getValue();return e.some(s=>t.includes(s))}hasAllPermissions(e){let t=this.userPermissionsSubject.getValue();return e.every(s=>t.includes(s))}getCurrentPermissions(){return this.userPermissionsSubject.getValue()}setPermissions(e){this.userPermissionsSubject.next(e)}canAccessRoute(e){return!e||e.length===0?!0:this.hasAnyPermission(e)}reloadPermissions(e,t,s,r,n){return i(this,null,function*(){yield this.loadUserPermissions(e,t,s,r,n)})}isOwner(){return!1}static \u0275fac=function(t){return new(t||c)};static \u0275prov=d({token:c,factory:c.\u0275fac,providedIn:"root"})};var P=class c{supabaseService=p(b);router=p(w);permissionService=p(g);userSubject=new u(null);staffRecordsSubject=new u([]);restaurantsSubject=new u([]);supplierSubject=new u(null);activeRestaurantIdSubject=new u(null);activeStaffRecordSubject=new u(null);contextSubject=new u("customer");authInitialized=!1;currentUser$=this.userSubject.asObservable();currentStaff$=this.activeStaffRecordSubject.asObservable();currentRestaurant$=this.activeRestaurantIdSubject.pipe(R(e=>e?this.getRestaurantById$(e):S(null)));currentContext$=this.contextSubject.asObservable();allStaffRecords$=this.staffRecordsSubject.asObservable();availableRestaurants$=this.restaurantsSubject.asObservable();supplier$=this.supplierSubject.asObservable();activeRestaurantId$=this.activeRestaurantIdSubject.asObservable();get currentUserValue(){return this.userSubject.value}get currentUserSubject(){return this.userSubject}constructor(){this.initializeAuth()}initializeAuth(){return i(this,null,function*(){try{let{data:{session:e}}=yield this.supabaseService.getSession();if(e?.user){let t=yield this.supabaseService.getUserProfileWithFallback(e.user.id,e.user);this.userSubject.next(t),yield this.loadUserData(e.user.id)}else this.userSubject.next(null),this.setContext("customer")}catch(e){console.warn("\u26A0\uFE0F Auth init had issues:",e),this.userSubject.next(null),this.setContext("customer")}finally{this.authInitialized=!0}})}loadUserData(e){return i(this,null,function*(){try{console.log("\u{1F50D} AUTH LOAD USER DATA START",{userId:e});let t=yield this.getUserProfile(e);console.log("\u{1F50D} User profile loaded:",t);let s=yield this.findOwnedRestaurants(e);console.log("\u{1F50D} Owned restaurants:",s);let r=yield this.findAllStaffRecords(e,t?.email);console.log("\u{1F50D} Staff records:",r),this.staffRecordsSubject.next(r);let n=(yield Promise.all(r.map(f=>this.getRestaurantById(f.restaurant_id)))).filter(f=>f!==null);console.log("\u{1F50D} Staff restaurants:",n);let a=[...s,...n];console.log("\u{1F50D} All restaurants:",a),this.restaurantsSubject.next(a);let o=yield this.findSupplierMembership(e);console.log("\u{1F50D} Supplier:",o),this.supplierSubject.next(o);let l=this.getStoredActiveRestaurantId();console.log("\u{1F50D} Stored active restaurant ID:",l),(!l||!a.some(f=>f.id===l))&&(l=a[0]?.id||null,console.log("\u{1F50D} No valid stored ID, using first restaurant:",l)),yield this.setActiveRestaurant(l),console.log("\u{1F50D} After setActiveRestaurant, active ID:",this.activeRestaurantIdSubject.value),a.length>0?this.setContext("staff"):o?this.setContext("supplier"):this.setContext("customer"),console.log("\u{1F50D} Context set to:",this.contextSubject.value),yield this.loadPermissions(),console.log("\u{1F50D} Permissions loaded")}catch(t){console.error("\u274C Error loading user data:",t),this.setContext("customer")}})}getUserProfile(e){return i(this,null,function*(){try{let{data:t,error:s}=yield this.supabaseService.getSupabaseClient().from("users").select("*").eq("id",e).single();if(s)throw s;return t}catch(t){return console.error("Error loading user profile:",t),null}})}findOwnedRestaurants(e){return i(this,null,function*(){try{let{data:t,error:s}=yield this.supabaseService.getSupabaseClient().from("restaurants").select("*").eq("owner_id",e);if(s)throw s;return t||[]}catch(t){return console.error("Error finding owned restaurants:",t),[]}})}findAllStaffRecords(e,t){return i(this,null,function*(){if(!t)return[];try{let{data:s,error:r}=yield this.supabaseService.getSupabaseClient().from("restaurant_staff").select("*").or(`user_id.eq.${e},email.eq.${t.toLowerCase()}`).in("invitation_status",["pending","accepted"]);if(r)throw r;return yield Promise.all((s||[]).map(a=>i(this,null,function*(){if(a.invitation_status==="pending"&&!a.user_id){let{error:o}=yield this.supabaseService.getSupabaseClient().from("restaurant_staff").update({user_id:e,invitation_status:"accepted"}).eq("id",a.id);if(!o)return m(h({},a),{user_id:e,invitation_status:"accepted"})}return a})))}catch(s){return console.error("Error finding staff records:",s),[]}})}getRestaurantById(e){return i(this,null,function*(){try{let{data:t,error:s}=yield this.supabaseService.getSupabaseClient().from("restaurants").select("*").eq("id",e).single();if(s)throw s;return t}catch(t){return console.error("Error loading restaurant:",t),null}})}getRestaurantById$(e){return new v(t=>{this.getRestaurantById(e).then(s=>{t.next(s),t.complete()}).catch(s=>t.error(s))})}findSupplierMembership(e){return i(this,null,function*(){try{let{data:t,error:s}=yield this.supabaseService.getSupabaseClient().from("suppliers").select("*").eq("user_id",e).maybeSingle();if(s)throw s;return t}catch(t){return console.error("Error finding supplier:",t),null}})}getStoredActiveRestaurantId(){return localStorage.getItem("activeRestaurantId")}setActiveRestaurant(e){return i(this,null,function*(){if(this.activeRestaurantIdSubject.next(e),e){let t=this.staffRecordsSubject.value.find(s=>s.restaurant_id===e)||null;this.activeStaffRecordSubject.next(t),localStorage.setItem("activeRestaurantId",e)}else this.activeStaffRecordSubject.next(null),localStorage.removeItem("activeRestaurantId")})}login(e,t,s=!1){return i(this,null,function*(){try{let{data:r,error:n}=yield this.supabaseService.signIn(e,t);if(n)return{data:null,error:n};if(r.user){let a=yield this.getUserProfile(r.user.id);this.userSubject.next(a),yield this.loadUserData(r.user.id),yield this.loadPermissions(),s&&localStorage.setItem("rememberMe","true");let o=this.getCurrentContext(),l=o==="staff"?"/restaurant/dashboard":o==="supplier"?"/supplier/dashboard":"/customer";this.router.navigate([l])}return{data:r,error:null}}catch(r){return console.error("\u274C Login exception:",r),{data:null,error:r}}})}register(e){return i(this,null,function*(){try{let t=yield this.supabaseService.signUp(e);if(t.user&&!t.error){this.userSubject.next(t.user),yield this.loadUserData(t.user.id),yield this.loadPermissions();let r=this.getCurrentContext()==="staff"?"/restaurant/dashboard":"/customer";this.router.navigate([r])}return t}catch(t){return console.error("\u274C Register exception:",t),{user:null,error:t,restaurant:null,supplier:null}}})}logout(){return i(this,null,function*(){try{yield this.supabaseService.signOut()}catch(e){console.warn("Logout error",e)}this.userSubject.next(null),this.staffRecordsSubject.next([]),this.restaurantsSubject.next([]),this.supplierSubject.next(null),this.activeRestaurantIdSubject.next(null),this.activeStaffRecordSubject.next(null),this.setContext("customer"),localStorage.removeItem("activeRestaurantId"),this.router.navigate(["/login"])})}refreshUserData(){return i(this,null,function*(){let e=this.userSubject.value;e&&(yield this.loadUserData(e.id))})}getCurrentContext(){return this.contextSubject.value}setContext(e){this.contextSubject.next(e)}getAvailableContexts(){let e=["customer"];return this.restaurantsSubject.value.length>0&&e.push("staff"),this.supplierSubject.value&&e.push("supplier"),e}switchContext(e){return i(this,null,function*(){return this.getAvailableContexts().includes(e)?(this.setContext(e),yield this.loadPermissions(),!0):!1})}switchRestaurant(e){return i(this,null,function*(){return this.restaurantsSubject.value.some(s=>s.id===e)?(yield this.setActiveRestaurant(e),yield this.loadPermissions(),!0):!1})}getCurrentRestaurantId(){return this.activeRestaurantIdSubject.value}getCurrentStaffRestaurantId(){return this.activeRestaurantIdSubject.value}getCurrentStaff(){return this.activeStaffRecordSubject.value}getStaffRole(){return this.activeStaffRecordSubject.value?.role||null}isOwner(){let e=this.userSubject.value,t=this.activeRestaurantIdSubject.value;return!e||!t?!1:this.restaurantsSubject.value.find(r=>r.id===t)?.owner_id===e.id}isStaff(){return!!this.activeStaffRecordSubject.value}isSupplierUser(){return this.contextSubject.value==="supplier"}isCustomerUser(){return this.contextSubject.value==="customer"}isRestaurantUser(){return this.contextSubject.value==="staff"}canBeStaff(){return this.restaurantsSubject.value.length>0}canBeSupplier(){return!!this.supplierSubject.value}getUserRole(){if(!this.userSubject.value)return null;switch(this.contextSubject.value){case"staff":return this.isOwner()?"restaurant_owner":this.getStaffRole();case"supplier":return"supplier";default:return"customer"}}loadPermissions(){return i(this,null,function*(){let e=this.userSubject.value,t=this.activeRestaurantIdSubject.value,s=this.isOwner(),r=this.getStaffRole(),n=this.isSupplierUser();yield this.permissionService.loadUserPermissions(e?.id||null,t,s,r,n)})}hasPermission(e){return this.permissionService.hasPermission(e)}hasAnyPermission(e){return this.permissionService.hasAnyPermission(e)}hasAnyPermissions(){return this.permissionService.getCurrentPermissions().length>0}getCurrentPermissions(){return this.permissionService.getCurrentPermissions()}refreshPermissions(){return i(this,null,function*(){yield this.loadPermissions()})}reloadCurrentUserPermissions(){return i(this,null,function*(){yield this.refreshUserData()})}isAuthenticated(){return this.authInitialized&&!!this.userSubject.value}waitForAuthInit(){return i(this,null,function*(){return this.authInitialized?!0:new Promise(e=>{let t=()=>{this.authInitialized?e(!0):setTimeout(t,100)};t()})})}printStaffDebugInfo(){console.log("\u{1F50D} AuthService Debug:",{user:this.userSubject.value?.id,activeRestaurantId:this.activeRestaurantIdSubject.value,activeStaff:this.activeStaffRecordSubject.value,allStaffRecords:this.staffRecordsSubject.value,restaurants:this.restaurantsSubject.value,supplier:this.supplierSubject.value,context:this.contextSubject.value,isOwner:this.isOwner(),permissions:this.getCurrentPermissions()})}getAllStaffRecords(){return this.staffRecordsSubject.value}isManager(){return this.getStaffRole()==="manager"}isChef(){return this.getStaffRole()==="chef"}isWaiter(){return this.getStaffRole()==="waiter"}isKitchenStaff(){return this.getStaffRole()==="kitchen_staff"}static \u0275fac=function(t){return new(t||c)};static \u0275prov=d({token:c,factory:c.\u0275fac,providedIn:"root"})};export{g as a,P as b};
