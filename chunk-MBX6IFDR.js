import{b as _}from"./chunk-IHSWM4ZR.js";import{b as v}from"./chunk-FBJM6ARG.js";import{I as g,M as p,_ as w,a as d,b as h,da as m,g as u,n as S}from"./chunk-3SWAHN2Y.js";var b=class l{supabaseService=m(v);authService=m(_);shiftsSubject=new S([]);shifts$=this.shiftsSubject.asObservable();constructor(){this.authService.currentUser$.pipe(g(t=>!!t),p(1)).subscribe(()=>{this.loadShifts()})}loadShifts(){return u(this,null,function*(){try{let t=yield this.getCurrentRestaurantId();if(!t){console.error("\u274C No restaurant found");return}let{data:e,error:r}=yield this.supabaseService.getSupabaseClient().from("shifts").select("*").eq("restaurant_id",t).order("start_time");if(r){console.error("Error loading shifts:",r);return}if(!e||e.length===0){yield this.createDefaultShifts(t),yield this.loadShifts();return}this.shiftsSubject.next(e)}catch(t){console.error("Error in loadShifts:",t)}})}createDefaultShifts(t){return u(this,null,function*(){let e=[{restaurant_id:t,name:"Pranzo",start_time:"12:00:00",end_time:"15:00:00",days_of_week:[1,2,3,4,5,6,7],is_active:!0},{restaurant_id:t,name:"Cena",start_time:"19:00:00",end_time:"23:00:00",days_of_week:[1,2,3,4,5,6,7],is_active:!0}];try{let{error:r}=yield this.supabaseService.getSupabaseClient().from("shifts").insert(e);if(r)throw r;console.log("\u2705 Default shifts created")}catch(r){console.error("\u274C Error creating default shifts:",r)}})}getShifts(){return this.shiftsSubject.value}getCurrentShift(){let t=new Date,e=t.toTimeString().split(" ")[0],r=t.getDay(),o=r===0?7:r,a=this.getShifts().filter(s=>s.is_active);for(let s of a)if(s.days_of_week.includes(o)&&e>=s.start_time&&e<=s.end_time)return s;return null}createShift(t){return u(this,null,function*(){try{let e=yield this.getCurrentRestaurantId();if(!e)return console.error("\u274C No restaurant found"),null;let{data:r,error:o}=yield this.supabaseService.getSupabaseClient().from("shifts").insert(h(d({},t),{restaurant_id:e})).select().single();if(o)throw o;return yield this.loadShifts(),r}catch(e){return console.error("Error creating shift:",e),null}})}updateShift(t,e){return u(this,null,function*(){try{let{error:r}=yield this.supabaseService.getSupabaseClient().from("shifts").update(h(d({},e),{updated_at:new Date().toISOString()})).eq("id",t);if(r)throw r;return yield this.loadShifts(),!0}catch(r){return console.error("Error updating shift:",r),!1}})}getCurrentRestaurantId(){return u(this,null,function*(){let t=this.authService.getCurrentStaffRestaurantId();if(t)return t;let e=this.authService.currentUserValue;if(!e)return null;let{data:r}=yield this.supabaseService.getSupabaseClient().from("restaurants").select("id").eq("owner_id",e.id).limit(1).single();return r?.id||null})}deleteShift(t){return u(this,null,function*(){try{let{error:e}=yield this.supabaseService.getSupabaseClient().from("shifts").delete().eq("id",t);if(e)throw e;return yield this.loadShifts(),!0}catch(e){return console.error("Error deleting shift:",e),!1}})}isWithinShiftWithBuffer(){let t=new Date,e=t.toTimeString().split(" ")[0],r=t.getDay(),o=r===0?7:r,a=t.toISOString().split("T")[0],s=this.getShifts().filter(i=>i.is_active);if(!s.some(i=>i.days_of_week.includes(o)))return{allowed:!1,reason:"Nessun turno attivo oggi"};for(let i of s)if(i.days_of_week.includes(o)){let c=this.subtractHour(i.start_time,1),f=this.addHour(i.end_time,1);if(e>=c&&e<=f)return{allowed:!0,reason:`Turno: ${i.name}`}}return{allowed:!1,reason:"Fuori orario dei turni"}}getOrderingStatus(){let t=new Date,e=t.getDay(),r=e===0?7:e,o=this.getShifts().filter(n=>n.is_active&&n.days_of_week.includes(r));if(o.length===0)return Promise.resolve({allowed:!1,reason:"Nessun turno attivo oggi",currentShift:null});let a=this.getCurrentShift(),s=t.toTimeString().split(" ")[0];if(a){let n=this.subtractHour(a.start_time,1),i=this.addHour(a.end_time,1);if(s>=n&&s<=i)return Promise.resolve({allowed:!0,reason:`Turno attivo: ${a.name}`,currentShift:a})}for(let n of o){let i=this.subtractHour(n.start_time,1),c=this.addHour(n.end_time,1);if(s>=i&&s<=c)return Promise.resolve({allowed:!0,reason:`Buffer turno: ${n.name}`,currentShift:n})}return Promise.resolve({allowed:!1,reason:"Fuori orario dei turni",currentShift:null})}subtractHour(t,e){let[r,o,a]=t.split(":").map(Number),s=new Date;return s.setHours(r,o,a),s.setHours(s.getHours()-e),s.toTimeString().split(" ")[0]}addHour(t,e){let[r,o,a]=t.split(":").map(Number),s=new Date;return s.setHours(r,o,a),s.setHours(s.getHours()+e),s.toTimeString().split(" ")[0]}loadClosures(){return u(this,null,function*(){try{let t=yield this.getCurrentRestaurantId();if(!t)return console.error("\u274C No restaurant found"),[];let{data:e,error:r}=yield this.supabaseService.getSupabaseClient().from("restaurant_closures").select("*").eq("restaurant_id",t);return r?(console.error("Error loading closures:",r),[]):e||[]}catch(t){return console.error("Error in loadClosures:",t),[]}})}isRestaurantClosedToday(){let e=new Date().toISOString().split("T")[0];return!1}debugShiftStatus(){return u(this,null,function*(){let t=new Date,e=t.toTimeString().split(" ")[0],r=t.getDay(),o=r===0?7:r;console.log("\u{1F50D} ===== DEBUG TURNI ====="),console.log("Ora attuale:",e),console.log("Giorno (0=domenica, 1=luned\xEC...):",r),console.log("Giorno (1=luned\xEC, 7=domenica):",o);let a=this.getShifts();console.log("Tutti i turni:",a);let s=a.filter(i=>i.is_active&&i.days_of_week.includes(o));console.log("Turni attivi oggi:",s);for(let i of s){let c=this.subtractHour(i.start_time,1),f=this.addHour(i.end_time,1);console.log(`Turno ${i.name}:`,{start:i.start_time,end:i.end_time,startWithBuffer:c,endWithBuffer:f,siamoDentro:e>=c&&e<=f})}let n=yield this.getOrderingStatus();console.log("Risultato getOrderingStatus():",n),console.log("===== FINE DEBUG ===== \u{1F50D}")})}static \u0275fac=function(e){return new(e||l)};static \u0275prov=w({token:l,factory:l.\u0275fac,providedIn:"root"})};export{b as a};
