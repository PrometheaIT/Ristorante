import{a as v}from"./chunk-SY2ZWW6D.js";import{b as y,d as j}from"./chunk-TB7INTC7.js";import{P as g,S as b,T as f,Y as m,ca as o,f as p,g as s,l as h,s as S}from"./chunk-5BU4UD4M.js";import{a as l,b as d,g as a}from"./chunk-RA2WU32H.js";var w=class u{supabaseService=o(y);authService=o(j);loadingService=o(v);destroy$=new p;dataSubject=new s([]);data$=this.dataSubject.asObservable().pipe(g(1));loadingSubject=new s(!1);loading$=this.loadingSubject.asObservable();errorSubject=new s(null);error$=this.errorSubject.asObservable();constructor(){this.authService.activeRestaurantId$.pipe(f(this.destroy$),b(()=>h(this.loadData()))).subscribe()}ngOnDestroy(){this.destroy$.next(),this.destroy$.complete(),this.dataSubject.complete(),this.loadingSubject.complete(),this.errorSubject.complete()}run(e){return a(this,null,function*(){this.loadingService.start();try{return yield e}finally{this.loadingService.stop()}})}loadData(e){return a(this,null,function*(){try{this.loadingSubject.next(!0),this.errorSubject.next(null);let t=yield this.getCurrentRestaurantId();if(!t){this.dataSubject.next([]);return}let r=this.supabaseService.getSupabaseClient().from(this.getTableName()).select("*").eq("restaurant_id",t);e&&Object.entries(e).forEach(([x,c])=>{c!=null&&(r=r.eq(x,c))});let{data:n,error:i}=yield this.run(r);if(i)throw i;this.dataSubject.next(n??[])}catch(t){this.handleError("loadData",t),this.dataSubject.next([])}finally{this.loadingSubject.next(!1)}})}create(e){return a(this,null,function*(){try{this.loadingSubject.next(!0),this.errorSubject.next(null);let t=yield this.getCurrentRestaurantId();if(!t)return null;let r=d(l({},e),{restaurant_id:t,created_at:new Date().toISOString(),updated_at:new Date().toISOString()}),{data:n,error:i}=yield this.run(this.supabaseService.getSupabaseClient().from(this.getTableName()).insert(r).select().single());if(i)throw i;return yield this.loadData(),n}catch(t){return this.handleError("create",t),null}finally{this.loadingSubject.next(!1)}})}update(e,t){return a(this,null,function*(){try{this.loadingSubject.next(!0),this.errorSubject.next(null);let r=yield this.getCurrentRestaurantId();if(!r)return!1;let{error:n}=yield this.run(this.supabaseService.getSupabaseClient().from(this.getTableName()).update(d(l({},t),{updated_at:new Date().toISOString()})).eq("id",e).eq("restaurant_id",r));if(n)throw n;return yield this.loadData(),!0}catch(r){return this.handleError("update",r),!1}finally{this.loadingSubject.next(!1)}})}delete(e){return a(this,null,function*(){try{this.loadingSubject.next(!0),this.errorSubject.next(null);let t=yield this.getCurrentRestaurantId();if(!t)return!1;let{error:r}=yield this.run(this.supabaseService.getSupabaseClient().from(this.getTableName()).delete().eq("id",e).eq("restaurant_id",t));if(r)throw r;return yield this.loadData(),!0}catch(t){return this.handleError("delete",t),!1}finally{this.loadingSubject.next(!1)}})}getCurrentRestaurantId(){return a(this,null,function*(){return this.authService.getCurrentStaffRestaurantId()})}getCurrentRestaurantId$(){return this.authService.currentContext$.pipe(b(()=>h(this.getCurrentRestaurantId())))}clearCache(){this.dataSubject.next([]),this.errorSubject.next(null)}getById(e){return this.data$.pipe(S(t=>t.find(r=>r.id===e)||null))}clearError(){this.errorSubject.next(null)}handleError(e,t){console.error(`Error in ${e}:`,t);let r=this.mapErrorMessage(t);this.errorSubject.next(r)}mapErrorMessage(e){return e?.code==="23505"?"Elemento gi\xE0 esistente":e?.code==="23503"?"Riferimento non valido":e?.message?.includes("network")?"Errore di connessione":e?.message||"Errore sconosciuto"}get data(){return this.dataSubject.value}getSupabaseClientPublic(){return this.supabaseService.getSupabaseClient()}static \u0275fac=function(t){return new(t||u)};static \u0275prov=m({token:u,factory:u.\u0275fac,providedIn:"root"})};export{w as a};
