import{a as w}from"./chunk-QMR2VPJU.js";import{b as y}from"./chunk-TAPIY3IR.js";import{b as x}from"./chunk-HZAFCD3S.js";import{A as f,J as S,S as p,U as m,W as j,_ as v,a as d,b,da as c,g as s,j as g,n as u,u as o}from"./chunk-3SWAHN2Y.js";var I=class l{supabaseService=c(x);authService=c(y);loadingService=c(w);dataSubject=new u([]);data$=this.dataSubject.asObservable().pipe(p(1));loadingSubject=new u(!1);loading$=this.loadingSubject.asObservable();errorSubject=new u(null);error$=this.errorSubject.asObservable();restaurantIdCache=null;constructor(){this.authService.currentUser$.subscribe(t=>{t||this.clearCache()})}ngOnDestroy(){this.dataSubject.complete(),this.loadingSubject.complete(),this.errorSubject.complete()}run(t){return s(this,null,function*(){this.loadingService.start();try{return yield t}finally{this.loadingService.stop()}})}loadData(t){return s(this,null,function*(){try{this.loadingSubject.next(!0),this.errorSubject.next(null);let e=yield this.getCurrentRestaurantId();if(!e){this.dataSubject.next([]);return}let r=this.supabaseService.getSupabaseClient().from(this.getTableName()).select("*").eq("restaurant_id",e);t&&Object.keys(t).forEach(i=>{let h=t[i];h!=null&&(r=r.eq(i,h))});let{data:a,error:n}=yield this.run(r);if(n)throw n;this.dataSubject.next(a??[])}catch(e){console.error(`Error loading ${this.getTableName()}:`,e),this.errorSubject.next(e.message??"Errore sconosciuto"),this.dataSubject.next([])}finally{this.loadingSubject.next(!1)}})}create(t){return s(this,null,function*(){this.loadingSubject.next(!0),this.errorSubject.next(null);try{let e=yield this.getCurrentRestaurantId();if(!e)return null;let r=b(d({},t),{restaurant_id:e,created_at:new Date().toISOString(),updated_at:new Date().toISOString()}),{data:a,error:n}=yield this.run(this.supabaseService.getSupabaseClient().from(this.getTableName()).insert(r).select().single());if(n)throw n;return yield this.loadData(),a}catch(e){return this.errorSubject.next(e.message??"Errore creazione"),null}finally{this.loadingSubject.next(!1)}})}update(t,e){return s(this,null,function*(){this.loadingSubject.next(!0),this.errorSubject.next(null);try{let r=yield this.getCurrentRestaurantId();if(!r)return!1;let{error:a}=yield this.run(this.supabaseService.getSupabaseClient().from(this.getTableName()).update(b(d({},e),{updated_at:new Date().toISOString()})).eq("id",t).eq("restaurant_id",r));if(a)throw a;return yield this.loadData(),!0}catch(r){return this.errorSubject.next(r.message??"Errore aggiornamento"),!1}finally{this.loadingSubject.next(!1)}})}delete(t){return s(this,null,function*(){this.loadingSubject.next(!0),this.errorSubject.next(null);try{let e=yield this.getCurrentRestaurantId();if(!e)return!1;let{error:r}=yield this.run(this.supabaseService.getSupabaseClient().from(this.getTableName()).delete().eq("id",t).eq("restaurant_id",e));if(r)throw r;return yield this.loadData(),!0}catch(e){return this.errorSubject.next(e.message??"Errore eliminazione"),!1}finally{this.loadingSubject.next(!1)}})}loadData$(t){return this.loadingSubject.next(!0),this.errorSubject.next(null),this.getCurrentRestaurantId$().pipe(m(e=>{if(!e)return this.dataSubject.next([]),this.loadingSubject.next(!1),o([]);let r=this.supabaseService.getSupabaseClient().from(this.getTableName()).select("*").eq("restaurant_id",e);return t&&Object.keys(t).forEach(a=>{t[a]!==null&&t[a]!==void 0&&(r=r.eq(a,t[a]))}),new g(a=>{r.then(({data:n,error:i})=>{i?a.error(i):(a.next(n),a.complete())})}).pipe(j(a=>{this.dataSubject.next(a||[]),this.loadingSubject.next(!1)}),S(a=>(console.error(`Error loading ${this.getTableName()}:`,a),this.errorSubject.next(a.message),this.loadingSubject.next(!1),this.dataSubject.next([]),o([]))))}),S(e=>(console.error(`Error in loadData$ for ${this.getTableName()}:`,e),this.errorSubject.next(e.message),this.loadingSubject.next(!1),o([]))))}getCurrentRestaurantId$(){return new g(t=>{this.getCurrentRestaurantId().then(e=>{t.next(e),t.complete()}).catch(e=>t.error(e))})}getCurrentRestaurantId(){return s(this,null,function*(){if(this.restaurantIdCache)return this.restaurantIdCache;let t=this.authService.getCurrentStaffRestaurantId();if(t)return this.restaurantIdCache=t;let e=this.authService.currentUserValue;if(!e)return null;try{let{data:r,error:a}=yield this.supabaseService.getSupabaseClient().from("restaurants").select("id").eq("owner_id",e.id).limit(1).single();if(a)throw a;return this.restaurantIdCache=r?.id||null}catch{return null}})}clearCache(){this.restaurantIdCache=null,this.dataSubject.next([]),this.errorSubject.next(null)}getById(t){return this.data$.pipe(f(e=>e.find(r=>r.id===t)||null))}clearError(){this.errorSubject.next(null)}handleError(t,e){console.error(`Error in ${t}:`,e);let r=this.mapErrorMessage(e);this.errorSubject.next(r),this.loadingSubject.next(!1)}mapErrorMessage(t){return t?.code==="23505"?"Elemento gi\xE0 esistente":t?.code==="23503"?"Riferimento non valido":t?.message?.includes("network")?"Errore di connessione":t?.message||"Errore sconosciuto"}get data(){return this.dataSubject.value}static \u0275fac=function(e){return new(e||l)};static \u0275prov=v({token:l,factory:l.\u0275fac,providedIn:"root"})};export{I as a};
