import{b as v}from"./chunk-L36FCDRV.js";import{b as w}from"./chunk-JJFJLBC4.js";import{I as m,M as g,_ as p,a as l,b as h,da as d,g as u,n as S}from"./chunk-PX5DELEN.js";var b=class c{supabaseService=d(w);authService=d(v);shiftsSubject=new S([]);shifts$=this.shiftsSubject.asObservable();constructor(){this.authService.currentUser$.pipe(m(t=>!!t),g(1)).subscribe(()=>{this.loadShifts()})}loadShifts(){return u(this,null,function*(){try{let t=yield this.getCurrentRestaurantId();if(!t){console.error("\u274C No restaurant found");return}let{data:e,error:r}=yield this.supabaseService.getSupabaseClient().from("shifts").select("*").eq("restaurant_id",t).order("start_time");if(r){console.error("Error loading shifts:",r);return}if(!e||e.length===0){yield this.createDefaultShifts(t),yield this.loadShifts();return}this.shiftsSubject.next(e)}catch(t){console.error("Error in loadShifts:",t)}})}createDefaultShifts(t){return u(this,null,function*(){let e=[{restaurant_id:t,name:"Pranzo",start_time:"12:00:00",end_time:"15:00:00",days_of_week:[1,2,3,4,5,6,7],is_active:!0},{restaurant_id:t,name:"Cena",start_time:"19:00:00",end_time:"23:00:00",days_of_week:[1,2,3,4,5,6,7],is_active:!0}];try{let{error:r}=yield this.supabaseService.getSupabaseClient().from("shifts").insert(e);if(r)throw r;console.log("\u2705 Default shifts created")}catch(r){console.error("\u274C Error creating default shifts:",r)}})}getShifts(){return this.shiftsSubject.value}getCurrentShift(){let t=new Date,e=t.toTimeString().split(" ")[0],r=t.getDay(),i=r===0?7:r,a=this.getShifts().filter(s=>s.is_active);for(let s of a)if(s.days_of_week.includes(i)&&e>=s.start_time&&e<=s.end_time)return s;return null}createShift(t){return u(this,null,function*(){try{let e=yield this.getCurrentRestaurantId();if(!e)return console.error("\u274C No restaurant found"),null;let{data:r,error:i}=yield this.supabaseService.getSupabaseClient().from("shifts").insert(h(l({},t),{restaurant_id:e})).select().single();if(i)throw i;return yield this.loadShifts(),r}catch(e){return console.error("Error creating shift:",e),null}})}updateShift(t,e){return u(this,null,function*(){try{let{error:r}=yield this.supabaseService.getSupabaseClient().from("shifts").update(h(l({},e),{updated_at:new Date().toISOString()})).eq("id",t);if(r)throw r;return yield this.loadShifts(),!0}catch(r){return console.error("Error updating shift:",r),!1}})}getCurrentRestaurantId(){return u(this,null,function*(){let t=this.authService.getCurrentStaffRestaurantId();if(t)return t;let e=this.authService.currentUserValue;if(!e)return null;let{data:r}=yield this.supabaseService.getSupabaseClient().from("restaurants").select("id").eq("owner_id",e.id).limit(1).single();return r?.id||null})}deleteShift(t){return u(this,null,function*(){try{let{error:e}=yield this.supabaseService.getSupabaseClient().from("shifts").delete().eq("id",t);if(e)throw e;return yield this.loadShifts(),!0}catch(e){return console.error("Error deleting shift:",e),!1}})}isWithinShiftWithBuffer(){let t=new Date,e=t.toTimeString().split(" ")[0],r=t.getDay(),i=r===0?7:r,a=t.toISOString().split("T")[0],s=this.getShifts().filter(o=>o.is_active);if(!s.some(o=>o.days_of_week.includes(i)))return{allowed:!1,reason:"Nessun turno attivo oggi"};for(let o of s)if(o.days_of_week.includes(i)){let f=this.subtractHour(o.start_time,1),_=this.addHour(o.end_time,1);if(e>=f&&e<=_)return{allowed:!0,reason:`Turno: ${o.name}`}}return{allowed:!1,reason:"Fuori orario dei turni"}}getOrderingStatus(){let t=new Date,e=t.getDay(),r=e===0?7:e,i=this.getShifts().filter(n=>n.is_active&&n.days_of_week.includes(r));if(i.length===0)return Promise.resolve({allowed:!1,reason:"Nessun turno attivo oggi",currentShift:null});let a=this.getCurrentShift(),s=t.toTimeString().split(" ")[0];if(a){let n=this.subtractHour(a.start_time,1),o=this.addHour(a.end_time,1);if(s>=n&&s<=o)return Promise.resolve({allowed:!0,reason:`Turno attivo: ${a.name}`,currentShift:a})}for(let n of i){let o=this.subtractHour(n.start_time,1),f=this.addHour(n.end_time,1);if(s>=o&&s<=f)return Promise.resolve({allowed:!0,reason:`Buffer turno: ${n.name}`,currentShift:n})}return Promise.resolve({allowed:!1,reason:"Fuori orario dei turni",currentShift:null})}subtractHour(t,e){let[r,i,a]=t.split(":").map(Number),s=new Date;return s.setHours(r,i,a),s.setHours(s.getHours()-e),s.toTimeString().split(" ")[0]}addHour(t,e){let[r,i,a]=t.split(":").map(Number),s=new Date;return s.setHours(r,i,a),s.setHours(s.getHours()+e),s.toTimeString().split(" ")[0]}loadClosures(){return u(this,null,function*(){try{let t=yield this.getCurrentRestaurantId();if(!t)return console.error("\u274C No restaurant found"),[];let{data:e,error:r}=yield this.supabaseService.getSupabaseClient().from("restaurant_closures").select("*").eq("restaurant_id",t);return r?(console.error("Error loading closures:",r),[]):e||[]}catch(t){return console.error("Error in loadClosures:",t),[]}})}isRestaurantClosedToday(){let e=new Date().toISOString().split("T")[0];return!1}static \u0275fac=function(e){return new(e||c)};static \u0275prov=p({token:c,factory:c.\u0275fac,providedIn:"root"})};export{b as a};
