import{a as b}from"./chunk-D2EHDSLL.js";import{b as g}from"./chunk-M5ABBUWH.js";import{Z as m,ca as p,u as c,ua as _}from"./chunk-QIXMMTC2.js";import{j as s}from"./chunk-4ZZIO3ZI.js";var f=class u extends b{supabase=p(g);getTableName(){return"menu_dishes"}getDishesByMenu$(e){return this.data$.pipe(c(t=>t.filter(r=>r.menu_id===e&&r.is_active)))}addDishToMenu(e,t,r,i=0){return s(this,null,function*(){if(this.data.find(o=>o.menu_id===e&&o.dish_id===t&&o.is_active))throw new Error("Il piatto \xE8 gi\xE0 presente in questo menu");let n=this.data.filter(o=>o.menu_id===e),l=(n.length?Math.max(...n.map(o=>o.order_index??0)):-1)+1,d={menu_id:e,dish_id:t,display_order:i,order_index:l,is_active:!0};return r&&r.trim()&&(d.category_id=r),this.create(d)})}removeDishFromMenu(e){return s(this,null,function*(){return this.update(e,{is_active:!1})})}updateDishOrder(e,t){return s(this,null,function*(){return this.update(e,{display_order:t})})}loadDishesForMenu(e){return s(this,null,function*(){return this.loadData({menu_id:e})})}getDishesWithDetailsByMenu(e){return s(this,null,function*(){let t=yield this.getCurrentRestaurantId();if(!t)return[];let{data:r,error:i}=yield this.supabase.getSupabaseClient().from("menu_dishes").select(`
          *,
          dish:dishes!dish_id (
            id,
            name,
            description,
            base_price,
            image_url,
            status,
            category_id,
            preparation_time,
            deleted_at
          ),
          category:categories!category_id (
            id,
            name
          )
        `).eq("menu_id",e).eq("is_active",!0).eq("dishes.restaurant_id",t).order("order_index",{ascending:!0});return i?(console.error("Errore recupero piatti dettagliati:",i),[]):(r||[]).filter(a=>a.dish&&!a.dish.deleted_at)})}removeAllDishesFromMenu(e){return s(this,null,function*(){try{let{error:t}=yield this.supabase.getSupabaseClient().from(this.getTableName()).update({is_active:!1,updated_at:new Date().toISOString()}).eq("menu_id",e).eq("is_active",!0);if(t)throw t;return yield this.loadData(),!0}catch(t){return this.handleError("removeAllDishesFromMenu",t),!1}})}initializeOrderIndexes(e){return s(this,null,function*(){try{let{data:t,error:r}=yield this.supabase.getSupabaseClient().from(this.getTableName()).select("*").eq("menu_id",e).eq("is_active",!0).order("created_at");if(r)throw r;let i=t.map((a,n)=>this.supabase.getSupabaseClient().from(this.getTableName()).update({order_index:n}).eq("id",a.id));return yield Promise.all(i),yield this.loadData(),!0}catch(t){return this.handleError("initializeOrderIndexes",t),!1}})}moveDishInMenu(e,t,r){return s(this,null,function*(){try{let{data:i,error:a}=yield this.supabase.getSupabaseClient().from(this.getTableName()).select("*").eq("menu_id",e).eq("is_active",!0).order("order_index");if(a)throw a;let n=i.findIndex(o=>o.dish_id===t);if(n===-1)return!1;let h=r==="up"?n-1:n+1;if(h<0||h>=i.length)return!1;let l=i[n],d=i[h];return yield this.supabase.getSupabaseClient().from(this.getTableName()).update({order_index:d.order_index}).eq("id",l.id),yield this.supabase.getSupabaseClient().from(this.getTableName()).update({order_index:l.order_index}).eq("id",d.id),yield this.loadData(),!0}catch(i){return this.handleError("moveDishInMenu",i),!1}})}reorderDishes(e,t){return s(this,null,function*(){try{let r=t.map((i,a)=>this.supabase.getSupabaseClient().from(this.getTableName()).update({order_index:a}).eq("menu_id",e).eq("dish_id",i));return yield Promise.all(r),yield this.loadData(),!0}catch(r){return this.handleError("reorderDishes",r),!1}})}getDishesByMenuOrdered$(e){return this.data$.pipe(c(t=>t.filter(r=>r.menu_id===e&&r.is_active).sort((r,i)=>(r.order_index??0)-(i.order_index??0))))}static \u0275fac=(()=>{let e;return function(r){return(e||(e=_(u)))(r||u)}})();static \u0275prov=m({token:u,factory:u.\u0275fac,providedIn:"root"})};export{f as a};
