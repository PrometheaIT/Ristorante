import{a as g}from"./chunk-KNL3CWA3.js";import{A as b}from"./chunk-DCWKKS33.js";import{$ as S,G as f,M as h,a as i,b as u,ea as c,f as o,m as p}from"./chunk-K5RDB55Y.js";var P=class l{supabaseService=c(b);authService=c(g);floorPlansSubject=new p([]);floorPlans$=this.floorPlansSubject.asObservable();tableShapes=[{id:"rect",name:"Rettangolare",type:"rectangle",default_width:120,default_height:80,icon:"rectangle"},{id:"circle",name:"Rotondo",type:"circle",default_width:100,default_height:100,icon:"circle"},{id:"square",name:"Quadrato",type:"square",default_width:100,default_height:100,icon:"square"}];constructor(){this.authService.currentUser$.pipe(f(r=>!!r),h(1)).subscribe(()=>{this.loadFloorPlans()})}loadFloorPlans(){return o(this,null,function*(){try{let r=this.authService.currentUserValue;if(!r)return;let{data:e,error:t}=yield this.supabaseService.getSupabaseClient().from("restaurants").select("id").eq("owner_id",r.id).limit(1);if(t||!e?.length){console.error("\u274C No restaurant found for user:",r.id);return}let a=e[0].id,{data:s,error:n}=yield this.supabaseService.getSupabaseClient().from("restaurant_floor_plans").select("*").eq("restaurant_id",a).order("created_at",{ascending:!1});if(n){console.error("\u274C Error loading floor plans:",n),n.code==="42P01"&&(yield this.createDefaultFloorPlanForRestaurant(a));return}this.floorPlansSubject.next(s||[])}catch(r){console.error("\u{1F4A5} Error in loadFloorPlans:",r)}})}createDefaultFloorPlanForRestaurant(r){return o(this,null,function*(){try{let e={restaurant_id:r,name:"Mappa Principale",width:1e3,height:800,is_active:!0,created_at:new Date().toISOString(),updated_at:new Date().toISOString()},{data:t,error:a}=yield this.supabaseService.getSupabaseClient().from("restaurant_floor_plans").insert(e).select().single();if(a)throw a;this.floorPlansSubject.next([t])}catch(e){console.error("\u{1F4A5} Error creating default floor plan:",e)}})}getTableShapes(){return this.tableShapes}getTableShapeById(r){return this.tableShapes.find(e=>e.id===r)}createFloorPlan(r){return o(this,null,function*(){try{let e=this.authService.currentUserValue;if(!e)return null;let{data:t,error:a}=yield this.supabaseService.getSupabaseClient().from("restaurants").select("id").eq("owner_id",e.id).limit(1);if(a||!t?.length)return null;let s=t[0].id,n=u(i({},r),{restaurant_id:s,created_at:new Date().toISOString(),updated_at:new Date().toISOString()}),{data:m,error:d}=yield this.supabaseService.getSupabaseClient().from("restaurant_floor_plans").insert(n).select().single();if(d)throw d;return yield this.loadFloorPlans(),m}catch(e){return console.error("\u{1F4A5} Error in createFloorPlan:",e),null}})}updateFloorPlan(r,e){return o(this,null,function*(){try{let t=u(i({},e),{updated_at:new Date().toISOString()}),{error:a}=yield this.supabaseService.getSupabaseClient().from("restaurant_floor_plans").update(t).eq("id",r);if(a)throw a;return yield this.loadFloorPlans(),!0}catch(t){return console.error("\u274C Error updating floor plan:",t),!1}})}deleteFloorPlan(r){return o(this,null,function*(){try{yield this.supabaseService.getSupabaseClient().from("tables").update({floor_plan_id:null}).eq("floor_plan_id",r);let{error:e}=yield this.supabaseService.getSupabaseClient().from("restaurant_floor_plans").delete().eq("id",r);if(e)throw e;return yield this.loadFloorPlans(),!0}catch(e){return console.error("\u274C Error deleting floor plan:",e),!1}})}getFloorPlans(){return this.floorPlansSubject.value}static \u0275fac=function(e){return new(e||l)};static \u0275prov=S({token:l,factory:l.\u0275fac,providedIn:"root"})};export{P as a};
