import{a as ee}from"./chunk-XL7SSZPR.js";import{a as te}from"./chunk-MQHGUKSF.js";import{a as K}from"./chunk-D53LAZTC.js";import{b as Q,d as B,h as $,q as H,r as Y,s as X,v as G,x as J}from"./chunk-7VSFVQGQ.js";import{a as ae}from"./chunk-SSJAIGRQ.js";import"./chunk-VOCUDH6H.js";import"./chunk-QMR2VPJU.js";import{b as j}from"./chunk-TAPIY3IR.js";import"./chunk-HZAFCD3S.js";import{c as A,d as W,m as N,p as U,r as Z}from"./chunk-VYE6ILYG.js";import{$a as _,Ab as C,Bb as z,Cb as O,Da as T,Db as F,Eb as r,Fb as M,Ga as l,Gb as g,Hb as V,Ib as L,Jb as x,Kb as w,Lb as R,Ob as q,Wa as E,da as b,g as h,h as P,hb as d,ia as u,ib as a,ja as p,jb as i,kb as y,pb as f,sb as v,ub as c,wb as k,xb as D,yb as I}from"./chunk-3SWAHN2Y.js";var ne=["floorPlanCanvas"],re=()=>[1,2,3,4,5,6,7,8];function oe(s,t){if(s&1&&(a(0,"div",47),y(1,"img",48),i()),s&2){let e=c(2);l(),d("src",e.restaurant.cover_image_url,T)("alt",e.restaurant.name)}}function se(s,t){if(s&1&&(a(0,"div",49),y(1,"img",48),i()),s&2){let e=c(2);l(),d("src",e.restaurant.logo_url,T)("alt",e.restaurant.name)}}function le(s,t){if(s&1&&(a(0,"p",50),r(1),i()),s&2){let e=c(2);l(),g(" ",e.restaurant.cuisine_type," ")}}function ce(s,t){if(s&1&&(a(0,"p",51),r(1),i()),s&2){let e=c(2);l(),g(" ",e.restaurant.description," ")}}function de(s,t){if(s&1&&(a(0,"span",52)(1,"span",32),r(2,"place"),i(),r(3),i()),s&2){let e=c(2);l(3),g(" ",e.restaurant.address," ")}}function me(s,t){if(s&1&&(a(0,"span",52)(1,"span",32),r(2,"phone"),i(),r(3),i()),s&2){let e=c(2);l(3),g(" ",e.restaurant.phone," ")}}function ue(s,t){if(s&1&&(a(0,"div",36)(1,"div",37),_(2,oe,2,2,"div",38),a(3,"div",39),_(4,se,2,2,"div",40),a(5,"div",41)(6,"h1",42),r(7),i(),_(8,le,2,1,"p",43)(9,ce,2,1,"p",44),a(10,"div",45),_(11,de,4,1,"span",46)(12,me,4,1,"span",46),i()()()()()),s&2){let e=c();l(2),d("ngIf",e.restaurant.cover_image_url),l(2),d("ngIf",e.restaurant.logo_url),l(3),M(e.restaurant.name),l(),d("ngIf",e.restaurant.cuisine_type),l(),d("ngIf",e.restaurant.description),l(2),d("ngIf",e.restaurant.address),l(),d("ngIf",e.restaurant.phone)}}function pe(s,t){if(s&1&&(a(0,"span",63),r(1),i()),s&2){let e=c(3);l(),g(" (",e.tables.length," tavoli) ")}}function ve(s,t){if(s&1&&(a(0,"span",63),r(1),i()),s&2){let e=c().$implicit;l(),g(" (",e.name==="Sala Grande"?"7":e.name==="Sala Piccola"?"5":"6"," tavoli) ")}}function _e(s,t){if(s&1){let e=f();a(0,"div",60),v("click",function(){let n=u(e).$implicit,m=c(2);return p(m.selectFloorPlan(n))}),a(1,"span",12),r(2,"location_on"),i(),a(3,"span",61),r(4),i(),_(5,pe,2,1,"span",62)(6,ve,2,1,"span",62),i()}if(s&2){let e=t.$implicit,o=c(2);z("selected",(o.currentFloorPlan==null?null:o.currentFloorPlan.id)===e.id),l(4),M(e.name),l(),d("ngIf",e.id===(o.currentFloorPlan==null?null:o.currentFloorPlan.id)),l(),d("ngIf",e.id!==(o.currentFloorPlan==null?null:o.currentFloorPlan.id))}}function ge(s,t){if(s&1&&(a(0,"div",53)(1,"div",54)(2,"div",55)(3,"span",56),r(4,"map"),i(),a(5,"h3",57),r(6,"Seleziona Area"),i()(),a(7,"div",58),_(8,_e,7,5,"div",59),i()()()),s&2){let e=c();l(8),d("ngForOf",e.floorPlans)}}function he(s,t){s&1&&(a(0,"div",69)(1,"span",12),r(2,"event_busy"),i()())}function be(s,t){if(s&1){let e=f();a(0,"div",64),v("click",function(){let n=u(e).$implicit,m=c();return p(m.onTableClick(n))}),a(1,"div",65)(2,"div",66),r(3),i(),a(4,"div",67),r(5),i(),_(6,he,3,0,"div",68),i()()}if(s&2){let e=t.$implicit,o=c();O(o.getTableStyle(e)),F(o.getTableClass(e)),d("title",o.getTableTooltip(e)),l(3),M(e.table_number),l(2),g("",e.capacity," p"),l(),d("ngIf",o.isTableReserved(e))}}function fe(s,t){s&1&&(a(0,"div",70)(1,"div",71)(2,"span",12),r(3,"table_restaurant"),i(),a(4,"h4",72),r(5,"Nessun tavolo configurato"),i(),a(6,"p",73),r(7,"Il ristorante non ha ancora configurato i tavoli per questa area"),i()()())}function xe(s,t){s&1&&(a(0,"div",91)(1,"span",12),r(2,"event_busy"),i(),a(3,"div",92)(4,"span",15),r(5,"Tavolo Prenotato"),i(),a(6,"span",33),r(7," Questo tavolo \xE8 gi\xE0 prenotato per l'orario selezionato "),i()()())}function we(s,t){s&1&&(a(0,"div",91)(1,"span",12),r(2,"event_available"),i(),a(3,"div",92)(4,"span",15),r(5,"Disponibile"),i(),a(6,"span",33),r(7," Tavolo disponibile per la prenotazione "),i()()())}function Re(s,t){s&1&&(a(0,"div",91)(1,"span",12),r(2,"block"),i(),a(3,"div",92)(4,"span",15),r(5,"Non prenotabile online"),i(),a(6,"span",33),r(7," Questo tavolo non \xE8 prenotabile online "),i()()())}function ye(s,t){if(s&1){let e=f();a(0,"div",74),v("click",function(){u(e);let n=c();return p(n.deselectTable())}),a(1,"div",75),v("click",function(n){return u(e),p(n.stopPropagation())}),a(2,"div",76)(3,"div",9)(4,"span",12),r(5,"table_restaurant"),i(),a(6,"h3",77),r(7),i()(),a(8,"button",78),v("click",function(){u(e);let n=c();return p(n.deselectTable())}),a(9,"span",12),r(10,"close"),i()()(),a(11,"div",79)(12,"div",80)(13,"div",81)(14,"label",82),r(15,"Capacit\xE0"),i(),a(16,"div",83)(17,"span",84),r(18),i(),a(19,"span",63),r(20,"persone"),i()()(),a(21,"div",81)(22,"label",82),r(23,"Nome Tavolo"),i(),a(24,"div",85),r(25),i()(),a(26,"div",81)(27,"label",82),r(28,"Forma"),i(),a(29,"div",86),r(30),i()()(),_(31,xe,8,0,"div",87)(32,we,8,0,"div",87)(33,Re,8,0,"div",87),i(),a(34,"div",88)(35,"button",89),v("click",function(){u(e);let n=c();return p(n.deselectTable())}),a(36,"span",12),r(37,"close"),i(),a(38,"span"),r(39,"Chiudi"),i()(),a(40,"button",90),v("click",function(){u(e);let n=c();return p(n.openReservationModal())}),a(41,"span",12),r(42,"event_available"),i(),a(43,"span"),r(44,"Prenota Questo Tavolo"),i()()()()()}if(s&2){let e=c();l(7),g("Tavolo ",e.selectedTable.table_number),l(11),M(e.selectedTable.capacity),l(7),g(" ",e.selectedTable.table_name||"N/D"," "),l(5),g(" ",e.selectedTable.shape," "),l(),d("ngIf",e.isTableReserved(e.selectedTable)),l(),d("ngIf",!e.isTableReserved(e.selectedTable)&&e.selectedTable.is_online_bookable),l(),d("ngIf",!e.selectedTable.is_online_bookable),l(7),d("disabled",e.isTableReserved(e.selectedTable)||!e.selectedTable.is_online_bookable)}}function Me(s,t){if(s&1&&(a(0,"div",91)(1,"span",12),r(2,"table_restaurant"),i(),a(3,"span"),r(4,"Stai prenotando: "),a(5,"strong"),r(6),i(),r(7),i()()),s&2){let e=c(2);l(6),g("Tavolo ",e.selectedTable.table_number),l(),g(" (",e.selectedTable.capacity," persone)")}}function Se(s,t){if(s&1&&(a(0,"option",110),r(1),i()),s&2){let e=t.$implicit;d("value",e),l(),g(" ",e," ")}}function Te(s,t){if(s&1&&(a(0,"option",111),r(1),i()),s&2){let e=t.$implicit,o=c(2);d("value",e)("disabled",o.selectedTable?e>o.selectedTable.capacity:!1),l(),V(" ",e," ",e===1?"persona":"persone"," ")}}function Ce(s,t){s&1&&(a(0,"div",114)(1,"span",12),r(2,"check_circle"),i(),a(3,"span"),r(4,"Tavolo disponibile per la data e ora selezionate"),i()())}function Ve(s,t){s&1&&(a(0,"div",115)(1,"span",12),r(2,"error"),i(),a(3,"span"),r(4,"Tavolo non disponibile per la data e ora selezionate"),i()())}function Pe(s,t){if(s&1&&(a(0,"div",112),_(1,Ce,5,0,"div",105)(2,Ve,5,0,"div",113),i()),s&2){let e=c(2);l(),d("ngIf",e.isTableAvailable),l(),d("ngIf",!e.isTableAvailable)}}function Ee(s,t){if(s&1){let e=f();a(0,"div",116)(1,"h3",117),r(2,"Dati Cliente"),i(),a(3,"div",97)(4,"div",81)(5,"label",82),r(6,"Nome *"),i(),a(7,"input",118),R("ngModelChange",function(n){u(e);let m=c(2);return w(m.restaurantReservationData.customer_name,n)||(m.restaurantReservationData.customer_name=n),p(n)}),i()(),a(8,"div",81)(9,"label",82),r(10,"Telefono *"),i(),a(11,"input",119),R("ngModelChange",function(n){u(e);let m=c(2);return w(m.restaurantReservationData.customer_phone,n)||(m.restaurantReservationData.customer_phone=n),p(n)}),i()()(),a(12,"div",81)(13,"label",82),r(14,"Email (opzionale)"),i(),a(15,"input",120),R("ngModelChange",function(n){u(e);let m=c(2);return w(m.restaurantReservationData.customer_email,n)||(m.restaurantReservationData.customer_email=n),p(n)}),i()()()}if(s&2){let e=c(2);l(7),x("ngModel",e.restaurantReservationData.customer_name),l(4),x("ngModel",e.restaurantReservationData.customer_phone),l(4),x("ngModel",e.restaurantReservationData.customer_email)}}function ke(s,t){if(s&1&&(a(0,"div",114)(1,"span",12),r(2,"person"),i(),a(3,"span"),r(4,"Prenotazione a nome di: "),a(5,"strong"),r(6),i()()()),s&2){let e=c(2);l(6),V("",e.currentUser.user_metadata==null?null:e.currentUser.user_metadata.first_name," ",e.currentUser.user_metadata==null?null:e.currentUser.user_metadata.last_name)}}function De(s,t){s&1&&(a(0,"span",12),r(1,"refresh"),i())}function Ie(s,t){if(s&1){let e=f();a(0,"div",93)(1,"div",94)(2,"div",76)(3,"h2",57)(4,"span",12),r(5,"event_available"),i(),r(6," Prenota Tavolo "),i(),a(7,"button",95),v("click",function(){u(e);let n=c();return p(n.closeReservationModal())}),a(8,"span",12),r(9,"close"),i()()(),a(10,"div",96),_(11,Me,8,2,"div",87),a(12,"div",97)(13,"div",81)(14,"label",82),r(15,"Data *"),i(),a(16,"input",98),R("ngModelChange",function(n){u(e);let m=c();return w(m.customerReservationData.reservation_date,n)||(m.customerReservationData.reservation_date=n),p(n)}),v("change",function(){u(e);let n=c();return n.syncReservationData(),p(n.onDateChange())}),i()(),a(17,"div",81)(18,"label",82),r(19,"Ora *"),i(),a(20,"select",99),R("ngModelChange",function(n){u(e);let m=c();return w(m.customerReservationData.reservation_time,n)||(m.customerReservationData.reservation_time=n),p(n)}),v("change",function(){u(e);let n=c();return n.syncReservationData(),p(n.onTimeChange())}),a(21,"option",100),r(22,"Seleziona orario"),i(),_(23,Se,2,2,"option",101),i()()(),a(24,"div",97)(25,"div",81)(26,"label",82),r(27,"Numero Persone *"),i(),a(28,"select",99),R("ngModelChange",function(n){u(e);let m=c();return w(m.customerReservationData.party_size,n)||(m.customerReservationData.party_size=n),p(n)}),v("change",function(){u(e);let n=c();return p(n.syncReservationData())}),_(29,Te,2,4,"option",102),i()()(),_(30,Pe,3,2,"div",103)(31,Ee,16,3,"div",104)(32,ke,7,2,"div",105),a(33,"div",106)(34,"label",82),r(35,"Richieste Speciali"),i(),a(36,"textarea",107),R("ngModelChange",function(n){u(e);let m=c();return w(m.customerReservationData.special_requests,n)||(m.customerReservationData.special_requests=n),p(n)}),v("input",function(){u(e);let n=c();return p(n.syncReservationData())}),i()()(),a(37,"div",88)(38,"button",89),v("click",function(){u(e);let n=c();return p(n.closeReservationModal())}),r(39," Annulla "),i(),a(40,"button",108),v("click",function(){u(e);let n=c();return p(n.createReservation())}),_(41,De,2,0,"span",109),r(42," Conferma Prenotazione "),i()()()()}if(s&2){let e=c();l(11),d("ngIf",e.selectedTable),l(5),x("ngModel",e.customerReservationData.reservation_date),d("min",e.minDate),l(4),x("ngModel",e.customerReservationData.reservation_time),l(3),d("ngForOf",e.availableTimes),l(5),x("ngModel",e.customerReservationData.party_size),l(),d("ngForOf",q(13,re)),l(),d("ngIf",e.availabilityChecked),l(),d("ngIf",!e.currentUser),l(),d("ngIf",e.currentUser),l(4),x("ngModel",e.customerReservationData.special_requests),l(4),d("disabled",!e.isTableAvailable||e.creatingReservation||!e.customerReservationData.reservation_date||!e.customerReservationData.reservation_time),l(),d("ngIf",e.creatingReservation)}}function ze(s,t){if(s&1){let e=f();a(0,"div",74),v("click",function(){u(e);let n=c();return p(n.closeConfirmationModal())}),a(1,"div",75),v("click",function(n){return u(e),p(n.stopPropagation())}),a(2,"div",121)(3,"div",122)(4,"span",123),r(5,"check_circle"),i()(),a(6,"h3",124),r(7,"Prenotazione Confermata!"),i(),a(8,"p",125),r(9),i(),a(10,"div",126)(11,"div",127)(12,"strong"),r(13,"Numero prenotazione:"),i(),r(14),i(),a(15,"div",128)(16,"strong"),r(17,"Stato:"),i(),a(18,"span",129),r(19),i()()()(),a(20,"div",88)(21,"button",130),v("click",function(){u(e);let n=c();return p(n.closeConfirmationModal())}),a(22,"span",12),r(23,"done"),i(),r(24," Ok, Grazie "),i()()()()}if(s&2){let e=c();l(9),L(" La tua prenotazione per il tavolo ",e.lastReservation==null||e.lastReservation.tables==null?null:e.lastReservation.tables.table_number," \xE8 stata confermata per il ",e.formatDate(e.lastReservation==null?null:e.lastReservation.reservation_date)," alle ",e.lastReservation==null?null:e.lastReservation.reservation_time,". "),l(5),g(" ",e.lastReservation==null?null:e.lastReservation.id.slice(-8).toUpperCase()," "),l(5),M(e.lastReservation==null?null:e.lastReservation.status)}}var ie=class s{route=b(U);router=b(Z);floorPlanService=b(ee);tableService=b(te);reservationService=b(ae);restaurantPublicService=b(K);authService=b(j);canvasRef;restaurant=null;floorPlans=[];currentFloorPlan=null;tables=[];reservations=[];selectedTable=null;showReservationModal=!1;showConfirmationModal=!1;creatingReservation=!1;customerReservationData={restaurant_id:"",table_id:"",reservation_date:"",reservation_time:"",party_size:2,special_requests:""};restaurantReservationData={restaurant_id:"",customer_name:"",customer_phone:"",reservation_date:"",reservation_time:"",party_size:2,special_requests:"",table_id:void 0,status:"pending"};zoomLevel=1;minZoom=.5;maxZoom=3;isDragging=!1;dragStart={x:0,y:0};canvasPosition={x:0,y:0};availableTimes=[];isTableAvailable=!1;availabilityChecked=!1;currentUser=null;lastReservation=null;minDate;today;subscriptions=new P;restaurantId="";constructor(){let t=new Date;this.minDate=t.toISOString().split("T")[0],this.today=this.minDate,this.customerReservationData.reservation_date=this.minDate,this.restaurantReservationData.reservation_date=this.minDate}ngOnInit(){return h(this,null,function*(){console.log("\u{1F504} RestaurantMapViewer initialized"),this.route.params.subscribe(t=>{this.restaurantId=t.restaurantId,console.log("\u{1F3EA} Restaurant ID from route:",this.restaurantId),this.restaurantId?this.loadRestaurantData():console.error("\u274C No restaurantId found in route params")}),this.subscriptions.add(this.authService.currentUser$.subscribe(t=>{this.currentUser=t,t&&(this.restaurantReservationData.customer_name=`${t.user_metadata?.first_name||""} ${t.user_metadata?.last_name||""}`.trim(),this.restaurantReservationData.customer_phone=t.user_metadata?.phone||"")}))})}ngOnDestroy(){this.subscriptions.unsubscribe()}loadRestaurantData(){return h(this,null,function*(){if(console.log("\u{1F4E5} Loading restaurant data for ID:",this.restaurantId),this.restaurant=yield this.restaurantPublicService.loadRestaurant(this.restaurantId),!this.restaurant){console.error("\u274C Restaurant not found");return}this.customerReservationData.restaurant_id=this.restaurantId,this.restaurantReservationData.restaurant_id=this.restaurantId,yield this.loadFloorPlans(),yield this.loadReservationsForToday()})}loadFloorPlans(){return h(this,null,function*(){try{let{data:t,error:e}=yield this.floorPlanService.supabaseService.getSupabaseClient().from("restaurant_floor_plans").select("*").eq("restaurant_id",this.restaurantId).eq("is_active",!0).order("created_at",{ascending:!0});if(e)throw e;this.floorPlans=t||[],this.floorPlans.length>0&&(this.currentFloorPlan=this.floorPlans[0],yield this.loadTablesForCurrentFloorPlan())}catch(t){console.error("\u274C Error loading floor plans:",t)}})}loadTablesForCurrentFloorPlan(){return h(this,null,function*(){if(this.currentFloorPlan){console.log("\u{1F50D} Loading tables for floor plan:",{floorPlanId:this.currentFloorPlan.id,floorPlanName:this.currentFloorPlan.name});try{let{data:t,error:e}=yield this.tableService.supabaseService.getSupabaseClient().from("tables").select("*").eq("floor_plan_id",this.currentFloorPlan.id).eq("is_active",!0).order("table_number",{ascending:!0});if(e){console.error("\u274C Errore query tavoli:",e),this.tables=[];return}let o=(t||[]).filter(n=>n.parent_table_id===null&&!n.is_merged);console.log("\u{1F4CA} RISULTATI TAVOLI:",{tavoliTotaliNelDB:t?.length||0,tavoliVisibili:o.length,floorPlan:this.currentFloorPlan.name,tavoliVisibiliLista:o.map(n=>({id:n.id,numero:n.table_number,nome:n.table_name,position:`(${n.position_x}, ${n.position_y})`,dimensioni:`${n.width}x${n.height}`,shape:n.shape,is_online_bookable:n.is_online_bookable,capacity:n.capacity}))}),o.length===0&&t&&t.length>0&&console.warn("\u26A0\uFE0F Tavoli esclusi dal rendering:",{motivo:"Sono tavoli figli (parent_table_id != null) o uniti (is_merged = true)",tavoliEsclusi:t.map(n=>({numero:n.table_number,parent_table_id:n.parent_table_id,is_merged:n.is_merged,is_online_bookable:n.is_online_bookable}))}),this.tables=o}catch(t){console.error("\u{1F4A5} Errore nel caricamento tavoli:",t),this.tables=[]}}})}loadReservationsForToday(){return h(this,null,function*(){try{let{data:t,error:e}=yield this.reservationService.supabaseService.getSupabaseClient().from("reservations").select("*").eq("restaurant_id",this.restaurantId).eq("reservation_date",this.today).in("status",["pending","confirmed"]);if(e)throw e;this.reservations=t||[],console.log("\u{1F4C5} Prenotazioni per oggi:",this.reservations.length)}catch(t){console.error("\u274C Error loading reservations:",t)}})}selectFloorPlan(t){return h(this,null,function*(){console.log("\u{1F4CD} Selezionato floor plan:",t.name),this.currentFloorPlan=t,yield this.loadTablesForCurrentFloorPlan(),this.deselectTable(),this.resetZoom()})}onTableClick(t){if(!t.is_online_bookable){console.log("\u274C Table not available for online booking:",t.table_number),alert("Questo tavolo non \xE8 prenotabile online");return}if(this.isTableReserved(t)){console.log("\u274C Table already reserved:",t.table_number),alert("Questo tavolo \xE8 gi\xE0 prenotato per la data e ora selezionate");return}this.selectedTable=t,this.customerReservationData.table_id=t.id,this.restaurantReservationData.table_id=t.id,this.customerReservationData.party_size=Math.min(2,t.capacity),this.restaurantReservationData.party_size=Math.min(2,t.capacity),this.loadAvailableTimes()}deselectTable(){this.selectedTable=null,this.customerReservationData.table_id="",this.restaurantReservationData.table_id=void 0,this.availabilityChecked=!1,this.isTableAvailable=!1}isTableReserved(t){return!this.customerReservationData.reservation_date||!this.customerReservationData.reservation_time?!1:this.reservations.some(e=>e.table_id===t.id&&e.reservation_date===this.customerReservationData.reservation_date&&e.reservation_time===this.customerReservationData.reservation_time&&["pending","confirmed"].includes(e.status))}getTableClass(t){let e=["table-element",`shape-${t.shape}`];return this.selectedTable?.id===t.id?e.push("selected"):t.is_online_bookable?this.isTableReserved(t)?e.push("reserved"):e.push("available"):e.push("unavailable"),e.join(" ")}getTableStyle(t){let o=Math.max(t.width||60,60),n=Math.max(t.height||60,60),m="8px";return t.shape==="circle"?m="50%":t.shape==="square"&&(m="8px"),{left:t.position_x+"px",top:t.position_y+"px",width:o+"px",height:n+"px","border-radius":m,transform:`rotate(${t.rotation||0}deg)`}}getTableTooltip(t){let e=`Tavolo ${t.table_number} - ${t.capacity} persone`;return t.is_online_bookable?this.isTableReserved(t)?e+=" (Prenotato)":e+=" (Disponibile)":e+=" (Non prenotabile online)",e}openReservationModal(){if(!this.selectedTable||!this.selectedTable.is_online_bookable){console.log("\u274C Cannot open reservation modal - table not available");return}this.showReservationModal=!0,this.loadAvailableTimes()}closeReservationModal(){this.showReservationModal=!1,this.availabilityChecked=!1}onDateChange(){return h(this,null,function*(){this.availabilityChecked=!1,yield this.loadAvailableTimes()})}onTimeChange(){return h(this,null,function*(){this.customerReservationData.reservation_time&&(yield this.checkAvailability())})}loadAvailableTimes(){return h(this,null,function*(){!this.selectedTable||!this.customerReservationData.reservation_date||(this.availableTimes=yield this.reservationService.getAvailableTimes(this.selectedTable.id,this.customerReservationData.reservation_date),this.customerReservationData.reservation_time&&(yield this.checkAvailability()))})}checkAvailability(){return h(this,null,function*(){!this.selectedTable||!this.customerReservationData.reservation_date||!this.customerReservationData.reservation_time||(this.isTableAvailable=yield this.reservationService.checkTableAvailability(this.selectedTable.id,this.customerReservationData.reservation_date,this.customerReservationData.reservation_time),this.availabilityChecked=!0)})}createReservation(){return h(this,null,function*(){if(!(!this.selectedTable||!this.isTableAvailable||this.creatingReservation)){this.creatingReservation=!0;try{let t;if(this.currentUser)this.customerReservationData.table_id=this.selectedTable.id,t=yield this.reservationService.createCustomerReservation(this.customerReservationData);else{if(!this.restaurantReservationData.customer_name||!this.restaurantReservationData.customer_phone){alert("Per favore compila nome e telefono per la prenotazione"),this.creatingReservation=!1;return}this.restaurantReservationData.table_id=this.selectedTable.id,t=yield this.reservationService.createRestaurantReservation(this.restaurantReservationData)}t?(this.lastReservation=t,this.showReservationModal=!1,this.showConfirmationModal=!0,yield this.loadReservationsForToday(),this.deselectTable()):alert("Errore durante la creazione della prenotazione. Riprova.")}catch(t){console.error("\u274C Error creating reservation:",t),alert("Errore durante la creazione della prenotazione.")}finally{this.creatingReservation=!1}}})}closeConfirmationModal(){this.showConfirmationModal=!1,this.resetReservationData()}resetReservationData(){this.customerReservationData={restaurant_id:this.restaurantId,table_id:"",reservation_date:this.minDate,reservation_time:"",party_size:2,special_requests:""},this.restaurantReservationData={restaurant_id:this.restaurantId,customer_name:this.currentUser?.user_metadata?.first_name||"",customer_phone:this.currentUser?.user_metadata?.phone||"",customer_email:"",reservation_date:this.minDate,reservation_time:"",party_size:2,special_requests:"",table_id:void 0,status:"pending"}}formatDate(t){return t?new Date(t).toLocaleDateString("it-IT",{weekday:"long",year:"numeric",month:"long",day:"numeric"}):""}goToRestaurantList(){this.router.navigate(["/restaurants"])}syncReservationData(){this.restaurantReservationData.reservation_date=this.customerReservationData.reservation_date,this.restaurantReservationData.reservation_time=this.customerReservationData.reservation_time,this.restaurantReservationData.party_size=this.customerReservationData.party_size,this.restaurantReservationData.special_requests=this.customerReservationData.special_requests}getTablesCountForPlan(t){return this.currentFloorPlan?.id===t?this.tables.length:0}loadTableCountsForAllFloorPlans(){return h(this,null,function*(){try{let{data:t,error:e}=yield this.tableService.supabaseService.getSupabaseClient().from("tables").select("*").eq("restaurant_id",this.restaurantId).eq("is_active",!0);if(e)throw e;let o=new Map;return this.floorPlans.forEach(n=>{o.set(n.id,0)}),t?.forEach(n=>{n.floor_plan_id&&o.has(n.floor_plan_id)&&n.parent_table_id===null&&!n.is_merged&&o.set(n.floor_plan_id,o.get(n.floor_plan_id)+1)}),o}catch(t){return console.error("\u274C Error loading table counts:",t),new Map}})}zoomIn(){this.zoomLevel=Math.min(this.zoomLevel*1.25,this.maxZoom),this.updateCanvasTransform()}zoomOut(){this.zoomLevel=Math.max(this.zoomLevel/1.25,this.minZoom),this.updateCanvasTransform()}resetZoom(){this.zoomLevel=1,this.canvasPosition={x:0,y:0},this.updateCanvasTransform()}getScaledWidth(){return(this.currentFloorPlan?.width||1e3)*this.zoomLevel}getScaledHeight(){return(this.currentFloorPlan?.height||800)*this.zoomLevel}updateCanvasTransform(){if(this.canvasRef&&this.canvasRef.nativeElement){let t=this.canvasRef.nativeElement;t.style.transform=`translate3d(${this.canvasPosition.x}px, ${this.canvasPosition.y}px, 0) scale3d(${this.zoomLevel}, ${this.zoomLevel}, 1)`,t.style.transformOrigin="0 0"}}zoomTo(t){this.zoomLevel=Math.max(this.minZoom,Math.min(this.maxZoom,t)),this.updateCanvasTransform()}zoomToFit(){if(!this.canvasRef||!this.canvasRef.nativeElement||!this.currentFloorPlan)return;let t=this.canvasRef.nativeElement.parentElement;if(!t)return;let e=t.clientWidth-40,o=t.clientHeight-40,n=e/this.currentFloorPlan.width,m=o/this.currentFloorPlan.height;this.zoomLevel=Math.min(n,m,1),this.canvasPosition={x:0,y:0},this.updateCanvasTransform()}onCanvasMouseDown(t){t.preventDefault(),this.isDragging=!0,this.dragStart={x:t.clientX-this.canvasPosition.x,y:t.clientY-this.canvasPosition.y}}onCanvasMouseMove(t){this.isDragging&&(t.preventDefault(),this.canvasPosition.x=t.clientX-this.dragStart.x,this.canvasPosition.y=t.clientY-this.dragStart.y,this.updateCanvasTransform())}onCanvasMouseUp(t){this.isDragging=!1}static \u0275fac=function(e){return new(e||s)};static \u0275cmp=E({type:s,selectors:[["app-restaurant-map-viewer"]],viewQuery:function(e,o){if(e&1&&k(ne,5),e&2){let n;D(n=I())&&(o.canvasRef=n.first)}},decls:61,vars:22,consts:[["floorPlanCanvas",""],[1,"restaurant-map-viewer"],["class","restaurant-header",4,"ngIf"],["class","map-selector-section p-md",4,"ngIf"],[1,"map-section","p-md"],[1,"border","rounded-lg","p-md"],[1,"flex","gap-sm","mb-md"],[1,"material-icons","text-md"],[1,"text-md","font-bold","m-0"],[1,"flex","items-center","gap-md"],[1,"flex","items-center","gap-sm","rounded-lg","p-sm"],["title","Zoom Out (Ctrl -)",1,"icon-button",3,"click","disabled"],[1,"material-icons"],[1,"flex","items-center","gap-sm","p-sm","justify-center","bg-body","rounded"],[1,"material-icons","text-sm"],[1,"font-semibold"],["title","Zoom In (Ctrl +)",1,"icon-button",3,"click","disabled"],["title","Reset Zoom (0)",1,"icon-button",3,"click"],["title","Adatta allo schermo",1,"icon-button",3,"click"],[1,"map-legend"],[1,"legend-item"],[1,"legend-color","available"],[1,"text-mini","font-semibold"],[1,"legend-color","reserved"],[1,"legend-color","selected"],[1,"canvas-container"],[1,"floor-plan-canvas",3,"mousedown","mousemove","mouseup","mouseleave"],[1,"grid-overlay"],["class","table-element",3,"class","style","title","click",4,"ngFor","ngForOf"],["class","canvas-instructions",4,"ngIf"],[1,"flex","flex-wrap","items-center","justify-between","gap-sm","mt-sm","p-sm","bg-smoke","rounded"],[1,"text-mini","text-muted","flex","items-center","gap-sm"],[1,"material-icons","text-mini"],[1,"text-mini","text-muted"],["class","modal-overlay",3,"click",4,"ngIf"],["class","modal-overlay",4,"ngIf"],[1,"restaurant-header"],[1,"restaurant-hero"],["class","restaurant-cover",4,"ngIf"],[1,"restaurant-info"],["class","restaurant-logo",4,"ngIf"],[1,"restaurant-details"],[1,"restaurant-name","text-lg","font-bold"],["class","restaurant-cuisine text-md text-muted mt-sm",4,"ngIf"],["class","restaurant-description mt-sm",4,"ngIf"],[1,"restaurant-meta","flex","flex-wrap","gap-md","mt-sm"],["class","chip flex items-center gap-sm",4,"ngIf"],[1,"restaurant-cover"],[3,"src","alt"],[1,"restaurant-logo"],[1,"restaurant-cuisine","text-md","text-muted","mt-sm"],[1,"restaurant-description","mt-sm"],[1,"chip","flex","items-center","gap-sm"],[1,"map-selector-section","p-md"],[1,"form-card",2,"margin","0"],[1,"flex","gap-sm","p-sm"],[1,"material-icons","text-lg"],[1,"section-title"],[1,"floor-plan-selector"],["class","floor-plan-option",3,"selected","click",4,"ngFor","ngForOf"],[1,"floor-plan-option",3,"click"],[1,"plan-name","font-semibold"],["class","text-mini",4,"ngIf"],[1,"text-mini"],[1,"table-element",3,"click","title"],[1,"table-content"],[1,"table-number"],[1,"table-capacity"],["class","table-status",4,"ngIf"],[1,"table-status"],[1,"canvas-instructions"],[1,"instruction-card"],[1,"font-bold","mb-sm"],[1,"text-muted"],[1,"modal-overlay",3,"click"],[1,"modal-container","modal-sm",3,"click"],[1,"modal-header"],[1,"section-title","m-0"],["title","Chiudi",1,"icon-button",3,"click"],[1,"p-lg"],[1,"grid-form","mb-lg"],[1,"form-group"],[1,"standard-label"],[1,"flex","items-center","gap-sm"],[1,"chip","active"],[1,"p-sm","bg-smoke","rounded","text-md"],[1,"p-sm","bg-smoke","rounded","text-md","text-capitalize"],["class","info-message mb-lg",4,"ngIf"],[1,"modal-footer"],[1,"promethea-button","ghost",3,"click"],[1,"promethea-button","primary",3,"click","disabled"],[1,"info-message","mb-lg"],[1,"flex","flex-col"],[1,"modal-overlay"],[1,"modal-container","modal-md"],[1,"icon-button",3,"click"],[1,"form-card"],[1,"form-row"],["type","date","required","",1,"p-sm",3,"ngModelChange","change","ngModel","min"],["required","",1,"p-sm",3,"ngModelChange","change","ngModel"],["value",""],[3,"value",4,"ngFor","ngForOf"],[3,"value","disabled",4,"ngFor","ngForOf"],["class","mb-lg",4,"ngIf"],["class","form-section",4,"ngIf"],["class","info-message",4,"ngIf"],[1,"form-group","m-sm02"],["placeholder","Note o richieste speciali...","rows","3",1,"p-sm",3,"ngModelChange","input","ngModel"],[1,"promethea-button",3,"click","disabled"],["class","material-icons",4,"ngIf"],[3,"value"],[3,"value","disabled"],[1,"mb-lg"],["class","info-message","style","border-left-color: var(--primary);",4,"ngIf"],[1,"info-message"],[1,"info-message",2,"border-left-color","var(--primary)"],[1,"form-section"],[1,"text-md","mb-md"],["type","text","placeholder","Il tuo nome","required","",1,"p-sm",3,"ngModelChange","ngModel"],["type","tel","placeholder","Il tuo telefono","required","",1,"p-sm",3,"ngModelChange","ngModel"],["type","email","placeholder","La tua email",1,"p-sm",3,"ngModelChange","ngModel"],[1,"p-lg","flex-1","overflow-y-auto","text-center"],[1,"confirmation-icon"],[1,"material-icons","success",2,"font-size","48px","color","#10b981"],[1,"confirmation-title",2,"margin-bottom","var(--gap-sm)","color","var(--text-color)"],[1,"confirmation-message",2,"margin-bottom","var(--gap-md)","color","var(--text-color)","opacity","0.8"],[1,"confirmation-details",2,"text-align","left","background","color-mix(in srgb, var(--background) 95%, transparent)","padding","var(--gap-md)","border-radius","12px","margin-bottom","var(--gap-lg)"],[1,"detail-item",2,"margin-bottom","var(--gap-sm)"],[1,"detail-item"],[1,"chip","active",2,"margin-left","var(--gap-sm)"],[1,"promethea-button","primary",3,"click"]],template:function(e,o){if(e&1){let n=f();a(0,"div",1),_(1,ue,13,7,"div",2)(2,ge,9,1,"div",3),a(3,"div",4)(4,"div",5)(5,"div",6)(6,"span",7),r(7,"table_restaurant"),i(),a(8,"h2",8),r(9,"Seleziona un Tavolo"),i()(),a(10,"div",9)(11,"div",10)(12,"button",11),v("click",function(){return u(n),p(o.zoomOut())}),a(13,"span",12),r(14,"zoom_out"),i()(),a(15,"div",13)(16,"span",14),r(17,"search"),i(),a(18,"span",15),r(19),i()(),a(20,"button",16),v("click",function(){return u(n),p(o.zoomIn())}),a(21,"span",12),r(22,"zoom_in"),i()(),a(23,"button",17),v("click",function(){return u(n),p(o.resetZoom())}),a(24,"span",12),r(25,"refresh"),i()(),a(26,"button",18),v("click",function(){return u(n),p(o.zoomToFit())}),a(27,"span",12),r(28,"fit_screen"),i()()(),a(29,"div",19)(30,"div",20),y(31,"div",21),a(32,"span",22),r(33,"Disponibile"),i()(),a(34,"div",20),y(35,"div",23),a(36,"span",22),r(37,"Prenotato"),i()(),a(38,"div",20),y(39,"div",24),a(40,"span",22),r(41,"Selezionato"),i()()()(),a(42,"div",25)(43,"div",26,0),v("mousedown",function(S){return u(n),p(o.onCanvasMouseDown(S))})("mousemove",function(S){return u(n),p(o.onCanvasMouseMove(S))})("mouseup",function(S){return u(n),p(o.onCanvasMouseUp(S))})("mouseleave",function(){return u(n),p(o.isDragging=!1)}),y(45,"div",27),_(46,be,7,8,"div",28)(47,fe,8,0,"div",29),i()(),a(48,"div",30)(49,"div",31)(50,"span",32),r(51,"touch_app"),i(),r(52," Trascina per muoverti \u2022 Usa i pulsanti per zoommare "),i(),a(53,"div",9)(54,"div",22),r(55),i(),a(56,"div",33),r(57),i()()()()(),_(58,ye,45,8,"div",34)(59,Ie,43,14,"div",35)(60,ze,25,5,"div",34),i()}e&2&&(l(),d("ngIf",o.restaurant),l(),d("ngIf",o.floorPlans.length>1),l(10),d("disabled",o.zoomLevel<=o.minZoom),l(7),g("",(o.zoomLevel*100).toFixed(0),"%"),l(),d("disabled",o.zoomLevel>=o.maxZoom),l(23),C("min-width",o.getScaledWidth(),"px")("min-height",o.getScaledHeight(),"px")("cursor",o.isDragging?"grabbing":"grab"),l(2),C("width",(o.currentFloorPlan==null?null:o.currentFloorPlan.width)||1e3,"px")("height",(o.currentFloorPlan==null?null:o.currentFloorPlan.height)||600,"px"),l(),d("ngForOf",o.tables),l(),d("ngIf",o.tables.length===0),l(8),g(" ",o.tables.length," tavoli disponibili "),l(2),g(" ",(o.currentFloorPlan==null?null:o.currentFloorPlan.name)||""," "),l(),d("ngIf",o.selectedTable),l(),d("ngIf",o.showReservationModal),l(),d("ngIf",o.showConfirmationModal))},dependencies:[N,A,W,J,Y,X,Q,H,B,G,$],styles:[".restaurant-map-viewer[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:var(--gap-sm);min-height:100vh;background:var(--background)}.restaurant-hero[_ngcontent-%COMP%]{position:relative;border-radius:0 0 24px 24px;overflow:hidden;margin-bottom:var(--gap-lg);background:var(--gradiente)}.restaurant-cover[_ngcontent-%COMP%]{height:300px;overflow:hidden}.restaurant-cover[_ngcontent-%COMP%]   img[_ngcontent-%COMP%]{width:100%;height:100%;object-fit:cover;opacity:.9}.restaurant-info[_ngcontent-%COMP%]{padding:var(--gap-lg);background:linear-gradient(to top,var(--background) 20%,transparent);position:relative}.restaurant-logo[_ngcontent-%COMP%]{position:absolute;top:-60px;left:var(--gap-lg);width:120px;height:120px;border-radius:50%;border:4px solid var(--background);background:var(--background);box-shadow:0 8px 24px var(--shadow-2);overflow:hidden}.restaurant-logo[_ngcontent-%COMP%]   img[_ngcontent-%COMP%]{width:100%;height:100%;object-fit:cover}.map-section[_ngcontent-%COMP%]{flex:1;display:flex;flex-direction:column}.canvas-container[_ngcontent-%COMP%]{position:relative;width:100%;height:600px;border:2px solid var(--smoke-1);border-radius:16px;background:var(--background);overflow:auto;box-shadow:inset 0 2px 8px var(--smoke-1)}.floor-plan-canvas[_ngcontent-%COMP%]{position:relative;min-width:100%;min-height:100%;background:color-mix(in srgb,var(--background) 95%,transparent)}.table-element[_ngcontent-%COMP%]{position:absolute;border:2px solid;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .3s cubic-bezier(.2,.9,.2,1);-webkit-user-select:none;user-select:none;z-index:10;box-shadow:0 4px 12px #0000001a}.table-element[_ngcontent-%COMP%]:hover{transform:scale(1.05);z-index:20;box-shadow:0 8px 24px #0003}.table-element.selected[_ngcontent-%COMP%]{z-index:30;border-width:3px;animation:_ngcontent-%COMP%_pulse 2s infinite}.table-element.available[_ngcontent-%COMP%]{border-color:#10b981;background:#10b98126}.table-element.available[_ngcontent-%COMP%]:hover{background:#10b98140}.table-element.reserved[_ngcontent-%COMP%]{border-color:#f59e0b;background:#f59e0b26}.table-element.unavailable[_ngcontent-%COMP%]{border-color:#ef4444;background:#ef44441a;cursor:not-allowed;opacity:.7}.table-content[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;padding:8px;width:100%}.table-number[_ngcontent-%COMP%]{font-weight:800;font-size:clamp(1rem,1.5vw,1.25rem);color:var(--text-color);text-shadow:0 1px 2px rgba(0,0,0,.1)}.table-capacity[_ngcontent-%COMP%]{font-size:clamp(.75rem,1vw,.9rem);color:var(--text-muted);font-weight:600}.map-legend[_ngcontent-%COMP%]{display:flex;gap:var(--gap-md);align-items:center;flex-wrap:wrap;padding:var(--gap-sm);background:var(--smoke-1);border-radius:12px;margin-left:auto}.legend-item[_ngcontent-%COMP%]{display:flex;align-items:center;gap:var(--gap-sm)}.legend-color[_ngcontent-%COMP%]{width:20px;height:20px;border-radius:4px;border:2px solid}.legend-color.available[_ngcontent-%COMP%]{background:#10b98133;border-color:#10b981}.legend-color.reserved[_ngcontent-%COMP%]{background:#f59e0b33;border-color:#f59e0b}.legend-color.unavailable[_ngcontent-%COMP%]{background:#ef444433;border-color:#ef4444}.legend-color.selected[_ngcontent-%COMP%]{background:var(--gradiente);border-color:var(--primary)}.floor-plan-selector[_ngcontent-%COMP%]{display:flex;gap:var(--gap-sm);flex-wrap:wrap}.floor-plan-option[_ngcontent-%COMP%]{display:flex;align-items:center;gap:var(--gap-sm);padding:var(--gap-sm) var(--gap-md);background:var(--smoke-1);border:2px solid transparent;border-radius:12px;cursor:pointer;transition:all .2s ease}.floor-plan-option[_ngcontent-%COMP%]:hover{background:var(--smoke-2);transform:translateY(-2px)}.floor-plan-option.selected[_ngcontent-%COMP%]{background:var(--gradiente);color:#fff;border-color:var(--primary)}.canvas-instructions[_ngcontent-%COMP%]{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;z-index:5}.instruction-card[_ngcontent-%COMP%]{background:var(--vetro);padding:var(--gap-lg);border-radius:16px;border:1px solid var(--smoke-1);box-shadow:0 8px 32px var(--shadow-2);max-width:400px}.instruction-card[_ngcontent-%COMP%]   .material-icons[_ngcontent-%COMP%]{font-size:48px;color:var(--text-muted);margin-bottom:var(--gap-md)}.canvas-container[_ngcontent-%COMP%]::-webkit-scrollbar{width:12px;height:12px}.canvas-container[_ngcontent-%COMP%]::-webkit-scrollbar-track{background:var(--smoke-1);border-radius:6px}.canvas-container[_ngcontent-%COMP%]::-webkit-scrollbar-thumb{background:var(--gradiente);border-radius:6px;border:3px solid var(--background)}@media (max-width: 768px){.restaurant-logo[_ngcontent-%COMP%]{width:80px;height:80px;top:-40px}.restaurant-details[_ngcontent-%COMP%]{margin-left:100px}.restaurant-cover[_ngcontent-%COMP%]{height:200px}.canvas-container[_ngcontent-%COMP%]{height:400px}.map-legend[_ngcontent-%COMP%]{margin-left:0;justify-content:center}}@keyframes _ngcontent-%COMP%_pulse{0%{box-shadow:0 0 #e03e3eb3}70%{box-shadow:0 0 0 10px #e03e3e00}to{box-shadow:0 0 #e03e3e00}}"]})};export{ie as RestaurantMapViewer};
