import{a as S}from"./chunk-FYDQVOFN.js";import{b as h}from"./chunk-L36FCDRV.js";import{b as m}from"./chunk-JJFJLBC4.js";import{_ as y,da as v,g as l,n as p}from"./chunk-PX5DELEN.js";var _=class f{supabaseService=v(m);authService=v(h);reservationService=v(S);todaysReservationsSubject=new p([]);todaysReservations$=this.todaysReservationsSubject.asObservable();loadTodaysReservations(){return l(this,null,function*(){try{let e=yield this.getCurrentRestaurantId();if(!e)return;let r=new Date().toISOString().split("T")[0],{data:t,error:a}=yield this.supabaseService.getSupabaseClient().from("reservations").select(`
          *,
          tables:tables!table_id (
            id,
            table_number,
            table_name,
            capacity,
            floor_plan_id
          )
        `).eq("restaurant_id",e).eq("reservation_date",r).in("status",["confirmed","pending"]).order("reservation_time",{ascending:!0});if(a)throw a;this.todaysReservationsSubject.next(t||[])}catch(e){console.error("\u274C Error loading today's reservations:",e),this.todaysReservationsSubject.next([])}})}assignTableToReservation(e,r){return l(this,null,function*(){try{let t=yield this.reservationService.assignTableToReservation(e,r);return t&&(yield this.loadTodaysReservations()),t}catch(t){return console.error("\u274C Error assigning table to reservation:",t),!1}})}removeTableAssignment(e){return l(this,null,function*(){try{let r=yield this.reservationService.removeTableFromReservation(e);return r&&(yield this.loadTodaysReservations()),r}catch(r){return console.error("\u274C Error removing table assignment:",r),!1}})}getReservationsWithoutTable(){return this.todaysReservationsSubject.value.filter(e=>!e.table_id)}getReservationsWithTable(){return this.todaysReservationsSubject.value.filter(e=>e.table_id)}getCurrentReservations(){return this.todaysReservationsSubject.value}suggestTablesForReservation(e,r){return l(this,null,function*(){try{let t=yield this.getCurrentRestaurantId();if(!t)return[];let a=this.getCurrentReservations(),u=a.find(s=>s.id===e);if(!u)return[];let{data:n,error:i}=yield this.supabaseService.getSupabaseClient().from("tables").select("*").eq("restaurant_id",t).eq("is_active",!0).gte("capacity",r).order("capacity",{ascending:!0});if(i)throw i;let c=new Date().toISOString().split("T")[0],g=a.filter(s=>s.reservation_date===c&&["confirmed","pending"].includes(s.status)).map(s=>s.table_id).filter(s=>s!==null&&s!==u.table_id);return n?.filter(s=>!g.includes(s.id))||[]}catch(t){return console.error("\u274C Error suggesting tables:",t),[]}})}debugReservations(){return l(this,null,function*(){let e=new Date().toISOString().split("T")[0];console.log("\u{1F50D} DEBUG - Data di oggi:",e),console.log("\u{1F50D} DEBUG - Prenotazioni caricate:",this.todaysReservationsSubject.value),console.log("\u{1F50D} DEBUG - Prenotazioni senza tavolo:",this.getReservationsWithoutTable())})}getCurrentRestaurantId(){return l(this,null,function*(){try{let e=this.authService.currentUserValue;if(!e)return null;let r=this.authService.getCurrentStaffRestaurantId();if(r)return r;let{data:t,error:a}=yield this.supabaseService.getSupabaseClient().from("restaurants").select("id").eq("owner_id",e.id).limit(1).single();return a?(console.error("Error getting restaurant by owner:",a),null):t?.id||null}catch(e){return console.error("Exception getting restaurant:",e),null}})}suggestTablesGroupedByFloorPlan(e,r){return l(this,null,function*(){try{let t=yield this.getCurrentRestaurantId();if(!t)return[];let a=this.getCurrentReservations(),u=a.find(o=>o.id===e);if(!u)return[];let{data:n,error:i}=yield this.supabaseService.getSupabaseClient().from("tables").select(`
        *,
        floor_plans!inner (
          id,
          name
        )
      `).eq("restaurant_id",t).eq("is_active",!0).gte("capacity",r).order("capacity",{ascending:!0});if(i)throw i;let c=new Date().toISOString().split("T")[0],g=a.filter(o=>o.reservation_date===c&&["confirmed","pending"].includes(o.status)).map(o=>o.table_id).filter(o=>o!==null&&o!==u.table_id),b=n?.filter(o=>!g.includes(o.id))||[],s={};return b.forEach(o=>{let d=o.floor_plan_id||"no-floor-plan",T=o.floor_plans?.name||"Senza mappa";s[d]||(s[d]={floorPlan:{id:d,name:T},tables:[]}),s[d].tables.push(o)}),Object.values(s)}catch(t){return console.error("\u274C Error suggesting grouped tables:",t),[]}})}getAllTablesGroupedByFloorPlan(){return l(this,null,function*(){try{let e=yield this.getCurrentRestaurantId();if(!e)return[];let{data:r,error:t}=yield this.supabaseService.getSupabaseClient().from("tables").select(`
        *,
        restaurant_floor_plans (
          id,
          name
        )
      `).eq("restaurant_id",e).eq("is_active",!0).order("table_number",{ascending:!0});if(t)throw t;console.log("\u{1F50D} Struttura dati:",r?.slice(0,1));let a={};r?.forEach(n=>{let i=n.floor_plan_id||"no-floor-plan",c="Senza mappa";n.restaurant_floor_plans&&(Array.isArray(n.restaurant_floor_plans)&&n.restaurant_floor_plans.length>0?c=n.restaurant_floor_plans[0].name:n.restaurant_floor_plans.name&&(c=n.restaurant_floor_plans.name)),a[i]||(a[i]={floorPlan:{id:i,name:c},tables:[]}),a[i].tables.push(n)});let u=Object.values(a);return u.sort((n,i)=>n.floorPlan.id==="no-floor-plan"?1:i.floorPlan.id==="no-floor-plan"?-1:n.floorPlan.name.localeCompare(i.floorPlan.name)),console.log("\u2705 Tavoli raggruppati:",u),u}catch(e){return console.error("\u274C Error getting all tables grouped by floor plan:",e),[]}})}getAvailableTablesGroupedByFloorPlan(e){return l(this,null,function*(){try{if(!(yield this.getCurrentRestaurantId()))return[];yield this.loadTodaysReservations();let t=this.getCurrentReservations();return yield this.getAllTablesGroupedByFloorPlan()}catch(r){return console.error("\u274C Error getting available tables grouped by floor plan:",r),[]}})}static \u0275fac=function(r){return new(r||f)};static \u0275prov=y({token:f,factory:f.\u0275fac,providedIn:"root"})};export{_ as a};
