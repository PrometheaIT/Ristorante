import{a as g}from"./chunk-CXV4BLDF.js";import{w as v}from"./chunk-L5SOXNIK.js";import{F as u,L as m,_ as d,da as c,f as a,m as l}from"./chunk-KZSY5CHT.js";var _=class n{supabaseService=c(v);authService=c(g);reservationsSubject=new l([]);reservations$=this.reservationsSubject.asObservable();constructor(){this.authService.currentUser$.pipe(u(e=>!!e),m(1)).subscribe(()=>{this.loadReservations()})}loadReservations(){return a(this,null,function*(){try{let e=this.authService.currentUserValue;if(!e){console.log("No user found");return}let{data:r,error:t}=yield this.supabaseService.getSupabaseClient().from("reservations").select(`
          *,
          users (first_name, last_name, email, phone),
          tables (table_name, table_number, capacity)
        `).eq("customer_id",e.id).order("reservation_date",{ascending:!0}).order("reservation_time",{ascending:!0});if(t){console.error("Error loading reservations:",t);return}console.log("Reservations loaded:",r?.length),this.reservationsSubject.next(r||[])}catch(e){console.error("Error in loadReservations:",e)}})}createReservation(e){return a(this,null,function*(){try{let r=this.authService.currentUserValue;if(!r)throw new Error("User not authenticated");let t={restaurant_id:e.restaurant_id,customer_id:r.id,table_id:e.table_id,reservation_date:e.reservation_date,reservation_time:e.reservation_time,party_size:e.party_size,special_requests:e.special_requests,status:"pending"},{data:s,error:i}=yield this.supabaseService.getSupabaseClient().from("reservations").insert(t).select(`
          *,
          users (first_name, last_name, email, phone),
          tables (table_name, table_number, capacity)
        `).single();if(i)throw i;return yield this.loadReservations(),s}catch(r){return console.error("\u274C Error creating reservation:",r),null}})}checkTableAvailability(e,r,t){return a(this,null,function*(){try{let{data:s,error:i}=yield this.supabaseService.getSupabaseClient().from("reservations").select("id").eq("table_id",e).eq("reservation_date",r).eq("reservation_time",t).in("status",["pending","confirmed"]).limit(1);if(i)throw i;return!s||s.length===0}catch(s){return console.error("\u274C Error checking table availability:",s),!1}})}getAvailableTimes(e,r){return a(this,null,function*(){try{let t=["12:00","12:30","13:00","13:30","14:00","19:00","19:30","20:00","20:30","21:00","21:30"],{data:s,error:i}=yield this.supabaseService.getSupabaseClient().from("reservations").select("reservation_time").eq("table_id",e).eq("reservation_date",r).in("status",["pending","confirmed"]);if(i)throw i;let p=s?.map(o=>o.reservation_time)||[];return t.filter(o=>!p.includes(o))}catch(t){return console.error("\u274C Error getting available times:",t),[]}})}getTodayReservations(){let e=this.reservationsSubject.value,r=new Date().toISOString().split("T")[0];return e.filter(t=>t.reservation_date===r&&["pending","confirmed"].includes(t.status))}getUpcomingReservations(){let e=this.reservationsSubject.value,r=new Date().toISOString().split("T")[0];return e.filter(t=>t.reservation_date>=r&&["pending","confirmed"].includes(t.status))}getUpcomingReservationsForDashboard(e=4){return this.getUpcomingReservations().slice(0,e).map(t=>({time:t.reservation_time.substring(0,5),customer_name:`${t.users?.first_name||""} ${t.users?.last_name||""}`.trim()||"Cliente",party_size:t.party_size,table:t.tables?.table_name||"Da assegnare",status:t.status}))}static \u0275fac=function(r){return new(r||n)};static \u0275prov=d({token:n,factory:n.\u0275fac,providedIn:"root"})};export{_ as a};
