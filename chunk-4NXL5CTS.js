import{a as p}from"./chunk-D2EHDSLL.js";import{D as l,J as c,Z as g}from"./chunk-QIXMMTC2.js";import{a as o,b as u,j as a}from"./chunk-4ZZIO3ZI.js";var _=class d extends p{constructor(){super(),this.authService.currentUser$.pipe(l(e=>!!e),c(1)).subscribe(()=>{this.loadData()})}getTableName(){return"ingredients"}loadData(e){return a(this,null,function*(){try{this.loadingSubject.next(!0);let t=yield this.getCurrentRestaurantId();if(!t){this.dataSubject.next([]),this.loadingSubject.next(!1);return}let{data:r,error:n}=yield this.supabaseService.getSupabaseClient().from("ingredients").select(`
          *,
          units (*),
          suppliers (company_name, contact_name),
          ingredient_types (id, name, description),
          ingredient_groups (id, name, description, color)
        `).eq("restaurant_id",t).eq("is_active",!0).order("name");if(n)throw n;console.log("Ingredients loaded with details:",r?.length);let i=(r||[]).map(s=>u(o({},s),{to_buy:s.to_buy||!1,to_buy_quantity:s.to_buy_quantity||null,ingredient_types:s.ingredient_types||void 0,ingredient_groups:s.ingredient_groups||void 0}));this.dataSubject.next(i)}catch(t){console.error("Error loading ingredients:",t),this.handleError("loadData",t)}finally{this.loadingSubject.next(!1)}})}loadIngredients(){return a(this,null,function*(){return this.loadData()})}createIngredient(e){return a(this,null,function*(){try{let t=yield this.getCurrentRestaurantId();if(!t)return console.error("No restaurant found"),null;let r=u(o({},e),{to_buy:e.to_buy||!1,to_buy_quantity:e.to_buy_quantity||null,expiry_date:e.expiry_date===""?null:e.expiry_date,supplier_id:e.supplier_id===""?null:e.supplier_id,type_id:e.type_id===""?null:e.type_id,group_id:e.group_id===""?null:e.group_id,restaurant_id:t});console.log("\u{1F4DD} Creating ingredient:",r);let{data:n,error:i}=yield this.supabaseService.getSupabaseClient().from(this.getTableName()).insert(r).select(`
          *,
          units (*),
          suppliers (company_name, contact_name),
          ingredient_types (id, name, description),
          ingredient_groups (id, name, description, color)
        `).single();if(i)throw console.error("\u274C Error creating ingredient:",i),i;return console.log("\u2705 Ingredient created successfully"),yield this.loadData(),n}catch(t){return console.error("\u{1F4A5} Error in createIngredient:",t),null}})}updateIngredient(e,t){return a(this,null,function*(){try{let r=u(o({},t),{expiry_date:t.expiry_date===""?null:t.expiry_date,type_id:t.type_id===""?null:t.type_id,group_id:t.group_id===""?null:t.group_id}),{error:n}=yield this.supabaseService.getSupabaseClient().from(this.getTableName()).update(r).eq("id",e);if(n)throw n;return yield this.loadData(),!0}catch(r){return console.error("Error updating ingredient:",r),!1}})}deleteIngredient(e){return a(this,null,function*(){try{let{error:t}=yield this.supabaseService.getSupabaseClient().from(this.getTableName()).update({is_active:!1}).eq("id",e);if(t)throw t;return yield this.loadData(),!0}catch(t){return console.error("Error deleting ingredient:",t),!1}})}getIngredients(){return this.dataSubject.value}getIngredientById(e){return this.dataSubject.value.find(t=>t.id===e)}getLowStockIngredients(){return this.dataSubject.value.filter(e=>e.alert_enabled&&e.current_stock<=e.minimum_stock)}searchIngredients(e){return e?this.dataSubject.value.filter(t=>t.name.toLowerCase().includes(e.toLowerCase())||t.description?.toLowerCase().includes(e.toLowerCase())):this.dataSubject.value}calculateIngredientCost(e,t){if(!e.unit_id||!e.units)return e.cost_per_unit*t;let r=e.units,n=t;switch(r.symbol){case"kg":n=t/1e3;break;case"L":n=t/1e3;break;case"g":case"mL":case"pz":n=t;break;default:n=t}return e.cost_per_unit*n}getIngredientsByType(e){return this.dataSubject.value.filter(t=>t.type_id===e)}getIngredientsByGroup(e){return this.dataSubject.value.filter(t=>t.group_id===e)}getIngredientsGroupedByType(){let e=new Map;return this.dataSubject.value.forEach(t=>{let r=t.type_id||"senza-tipologia";e.has(r)||e.set(r,[]),e.get(r).push(t)}),e}getIngredientsGroupedByGroup(){let e=new Map;return this.dataSubject.value.forEach(t=>{let r=t.group_id||"senza-gruppo";e.has(r)||e.set(r,[]),e.get(r).push(t)}),e}static \u0275fac=function(t){return new(t||d)};static \u0275prov=g({token:d,factory:d.\u0275fac,providedIn:"root"})};export{_ as a};
