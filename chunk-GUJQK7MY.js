import{b as p}from"./chunk-CXUZBBYL.js";import{b as c}from"./chunk-QGVET3VN.js";import{Y as u,ba as o}from"./chunk-25TB2OJR.js";import{j as s}from"./chunk-4ZZIO3ZI.js";var l=class n{supabase=o(c).getSupabaseClient();authService=o(p);kitchenTransitions={ordered:["waiting","out_of_stock"],waiting:["preparing","ready","out_of_stock"],preparing:["ready","out_of_stock"],ready:["out_of_stock"],out_of_stock:[]};waiterTransitions={ordered:["waiting","cancelled"],waiting:["preparing","cancelled"],preparing:["ready","cancelled"],ready:["served","cancelled"],served:[],cancelled:["ordered"]};canTransitionItem(e,r,t){return console.log(`\u{1F50D} Verifica transizione: ${e} \u2192 ${r} (${t})`),e===r?!1:r==="out_of_stock"?!0:((t==="kitchen"?this.kitchenTransitions:this.waiterTransitions)[e]||[]).includes(r)}updateItemStatus(e,r,t){return s(this,null,function*(){try{if(!(yield this.authService.getCurrentRestaurantId()))return!1;let{error:i}=yield this.supabase.from("order_items").update({status:r,updated_at:new Date().toISOString()}).eq("id",e);return!i&&t&&(yield this.syncComandaStatus(t)),!i}catch{return!1}})}updateComandaStatus(e,r){return s(this,null,function*(){try{if(!(yield this.authService.getCurrentRestaurantId()))return!1;let{error:a}=yield this.supabase.from("comande").update({status:r,updated_at:new Date().toISOString()}).eq("id",e);if(a)return!1;let{error:i}=yield this.supabase.from("order_items").update({status:r,updated_at:new Date().toISOString()}).eq("order_id",e);return!i}catch{return!1}})}updateAllItemsInComanda(e,r){return s(this,null,function*(){try{let t=yield this.authService.getCurrentRestaurantId();if(!t)return!1;let{error:a}=yield this.supabase.from("order_items").update({status:r,updated_at:new Date().toISOString()}).eq("order_id",e).eq("restaurant_id",t);return!a}catch(t){return console.error("\u274C Errore updateAllItemsInComanda:",t),!1}})}syncComandaStatus(e){return s(this,null,function*(){let r=yield this.authService.getCurrentRestaurantId(),{data:t,error:a}=yield this.supabase.from("order_items").select("status").eq("order_id",e).eq("restaurant_id",r);if(a||!t||t.length===0)return;let i=t[0].status;t.every(d=>d.status===i)?yield this.supabase.from("comande").update({status:i,updated_at:new Date().toISOString()}).eq("id",e):t.some(f=>f.status==="preparing")&&(yield this.supabase.from("comande").update({status:"preparing",updated_at:new Date().toISOString()}).eq("id",e))})}static \u0275fac=function(r){return new(r||n)};static \u0275prov=u({token:n,factory:n.\u0275fac,providedIn:"root"})};export{l as a};
