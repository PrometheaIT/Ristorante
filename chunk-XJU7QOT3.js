import{B as x,D as I}from"./chunk-KBL2L3GY.js";import{J as d,U as f,X as p,Z as j,a as c,b as h,ba as m,f as i,ga as g,i as b,m as u,t as o,y as S}from"./chunk-UE7YVF6I.js";var w=class l{supabaseService=g(x);authService=g(I);dataSubject=new u([]);data$=this.dataSubject.asObservable().pipe(f(1));loadingSubject=new u(!1);loading$=this.loadingSubject.asObservable();errorSubject=new u(null);error$=this.errorSubject.asObservable();restaurantIdCache=null;ngOnDestroy(){this.dataSubject.complete(),this.loadingSubject.complete(),this.errorSubject.complete()}loadData$(t){return this.loadingSubject.next(!0),this.errorSubject.next(null),this.getCurrentRestaurantId$().pipe(p(e=>{if(!e)return this.dataSubject.next([]),this.loadingSubject.next(!1),o([]);let r=this.supabaseService.getSupabaseClient().from(this.getTableName()).select("*").eq("restaurant_id",e);return t&&Object.keys(t).forEach(a=>{t[a]!==null&&t[a]!==void 0&&(r=r.eq(a,t[a]))}),new b(a=>{r.then(({data:n,error:s})=>{s?a.error(s):(a.next(n),a.complete())})}).pipe(j(a=>{this.dataSubject.next(a||[]),this.loadingSubject.next(!1)}),d(a=>(console.error(`Error loading ${this.getTableName()}:`,a),this.errorSubject.next(a.message),this.loadingSubject.next(!1),this.dataSubject.next([]),o([]))))}),d(e=>(console.error(`Error in loadData$ for ${this.getTableName()}:`,e),this.errorSubject.next(e.message),this.loadingSubject.next(!1),o([]))))}loadData(t){return i(this,null,function*(){try{this.loadingSubject.next(!0),this.errorSubject.next(null);let e=yield this.getCurrentRestaurantId();if(!e){this.dataSubject.next([]),this.loadingSubject.next(!1);return}let r=this.supabaseService.getSupabaseClient().from(this.getTableName()).select("*").eq("restaurant_id",e);t&&Object.keys(t).forEach(s=>{t[s]!==null&&t[s]!==void 0&&(r=r.eq(s,t[s]))});let{data:a,error:n}=yield r;if(n)throw n;this.dataSubject.next(a||[]),this.loadingSubject.next(!1)}catch(e){console.error(`Error loading ${this.getTableName()}:`,e),this.errorSubject.next(e.message),this.loadingSubject.next(!1),this.dataSubject.next([])}})}getCurrentRestaurantId$(){return new b(t=>{this.getCurrentRestaurantId().then(e=>{t.next(e),t.complete()}).catch(e=>{t.error(e)})})}getCurrentRestaurantId(){return i(this,null,function*(){if(this.restaurantIdCache)return this.restaurantIdCache;let t=this.authService.getCurrentStaffRestaurantId();if(t)return this.restaurantIdCache=t,t;let e=this.authService.currentUserValue;if(!e)return this.restaurantIdCache=null,null;try{let{data:r,error:a}=yield this.supabaseService.getSupabaseClient().from("restaurants").select("id").eq("owner_id",e.id).limit(1).single();if(a)throw a;return this.restaurantIdCache=r?.id||null,this.restaurantIdCache}catch(r){return console.error("Error fetching restaurant ID:",r),this.restaurantIdCache=null,null}})}clearCache(){this.restaurantIdCache=null,this.dataSubject.next([]),this.errorSubject.next(null)}create(t){return i(this,null,function*(){this.loadingSubject.next(!0),this.errorSubject.next(null);try{let e=yield this.getCurrentRestaurantId();if(!e)return this.errorSubject.next("No restaurant ID available"),this.loadingSubject.next(!1),null;let r=h(c({},t),{restaurant_id:e,created_at:new Date().toISOString(),updated_at:new Date().toISOString()}),{data:a,error:n}=yield this.supabaseService.getSupabaseClient().from(this.getTableName()).insert(r).select().single();if(n)throw n;return yield this.loadData(),a}catch(e){return console.error(`Error creating ${this.getTableName()}:`,e),this.errorSubject.next(e.message),this.loadingSubject.next(!1),null}})}update(t,e){return i(this,null,function*(){this.loadingSubject.next(!0),this.errorSubject.next(null);try{let r=yield this.getCurrentRestaurantId();if(!r)return this.errorSubject.next("No restaurant ID available"),this.loadingSubject.next(!1),!1;let{error:a}=yield this.supabaseService.getSupabaseClient().from(this.getTableName()).update(h(c({},e),{updated_at:new Date().toISOString()})).eq("id",t).eq("restaurant_id",r);if(a)throw a;return yield this.loadData(),!0}catch(r){return console.error(`Error updating ${this.getTableName()}:`,r),this.errorSubject.next(r.message),this.loadingSubject.next(!1),!1}})}delete(t){return i(this,null,function*(){this.loadingSubject.next(!0),this.errorSubject.next(null);try{let e=yield this.getCurrentRestaurantId();if(!e)return this.errorSubject.next("No restaurant ID available"),this.loadingSubject.next(!1),!1;let{error:r}=yield this.supabaseService.getSupabaseClient().from(this.getTableName()).delete().eq("id",t).eq("restaurant_id",e);if(r)throw r;return yield this.loadData(),!0}catch(e){return console.error(`Error deleting ${this.getTableName()}:`,e),this.errorSubject.next(e.message),this.loadingSubject.next(!1),!1}})}getById(t){return this.data$.pipe(S(e=>e.find(r=>r.id===t)||null))}clearError(){this.errorSubject.next(null)}static \u0275fac=function(e){return new(e||l)};static \u0275prov=m({token:l,factory:l.\u0275fac,providedIn:"root"})};export{w as a};
