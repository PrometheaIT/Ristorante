import{a as g}from"./chunk-KNL3CWA3.js";import{A as v}from"./chunk-DCWKKS33.js";import{$ as m,G as u,M as d,ea as c,f as i,m as l}from"./chunk-K5RDB55Y.js";var p=class n{supabaseService=c(v);authService=c(g);reservationsSubject=new l([]);reservations$=this.reservationsSubject.asObservable();constructor(){this.authService.currentUser$.pipe(u(e=>!!e),d(1)).subscribe(()=>{this.loadReservations()})}loadReservations(){return i(this,null,function*(){try{let e=this.authService.currentUserValue;if(!e){console.log("No user found");return}let{data:t,error:r}=yield this.supabaseService.getSupabaseClient().from("reservations").select(`
          *,
          users (first_name, last_name, email, phone),
          tables (table_name, table_number, capacity)
        `).eq("customer_id",e.id).order("reservation_date",{ascending:!0}).order("reservation_time",{ascending:!0});if(r){console.error("Error loading reservations:",r);return}console.log("Reservations loaded:",t?.length),this.reservationsSubject.next(t||[])}catch(e){console.error("Error in loadReservations:",e)}})}createReservation(e){return i(this,null,function*(){try{let t=this.authService.currentUserValue;if(!t)throw new Error("User not authenticated");let r={restaurant_id:e.restaurant_id,customer_id:t.id,table_id:e.table_id,reservation_date:e.reservation_date,reservation_time:e.reservation_time,party_size:e.party_size,special_requests:e.special_requests,status:"pending"},{data:s,error:a}=yield this.supabaseService.getSupabaseClient().from("reservations").insert(r).select(`
          *,
          users (first_name, last_name, email, phone),
          tables (table_name, table_number, capacity)
        `).single();if(a)throw a;return yield this.loadReservations(),s}catch(t){return console.error("\u274C Error creating reservation:",t),null}})}checkTableAvailability(e,t,r){return i(this,null,function*(){try{let{data:s,error:a}=yield this.supabaseService.getSupabaseClient().from("reservations").select("id").eq("table_id",e).eq("reservation_date",t).eq("reservation_time",r).in("status",["pending","confirmed"]).limit(1);if(a)throw a;return!s||s.length===0}catch(s){return console.error("\u274C Error checking table availability:",s),!1}})}getAvailableTimes(e,t){return i(this,null,function*(){try{let r=["12:00","12:30","13:00","13:30","14:00","19:00","19:30","20:00","20:30","21:00","21:30"],{data:s,error:a}=yield this.supabaseService.getSupabaseClient().from("reservations").select("reservation_time").eq("table_id",e).eq("reservation_date",t).in("status",["pending","confirmed"]);if(a)throw a;let b=s?.map(o=>o.reservation_time)||[];return r.filter(o=>!b.includes(o))}catch(r){return console.error("\u274C Error getting available times:",r),[]}})}getTodayReservations(){let e=this.reservationsSubject.value,t=new Date().toISOString().split("T")[0];return e.filter(r=>r.reservation_date===t&&["pending","confirmed"].includes(r.status))}getUpcomingReservations(){let e=this.reservationsSubject.value,t=new Date().toISOString().split("T")[0];return e.filter(r=>r.reservation_date>=t&&["pending","confirmed"].includes(r.status))}getUpcomingReservationsForDashboard(e=4){return this.getUpcomingReservations().slice(0,e).map(r=>({time:r.reservation_time.substring(0,5),customer_name:`${r.users?.first_name||""} ${r.users?.last_name||""}`.trim()||"Cliente",party_size:r.party_size,table:r.tables?.table_name||"Da assegnare",status:r.status}))}deleteReservation(e){return i(this,null,function*(){try{let{error:t}=yield this.supabaseService.getSupabaseClient().from("reservations").delete().eq("id",e);if(t)throw t;return console.log("\u2705 Reservation deleted successfully"),!0}catch(t){return console.error("\u274C Error deleting reservation:",t),!1}})}updateReservation(e,t){return i(this,null,function*(){try{let{error:r}=yield this.supabaseService.getSupabaseClient().from("reservations").update(t).eq("id",e);if(r)throw r;return!0}catch(r){return console.error("Error updating reservation:",r),!1}})}static \u0275fac=function(t){return new(t||n)};static \u0275prov=m({token:n,factory:n.\u0275fac,providedIn:"root"})};export{p as a};
